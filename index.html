<!DOCTYPE html>
<html lang="en, zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bi-an.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="江南人物的博客">
<meta property="og:url" content="https://bi-an.github.io/blog/index.html">
<meta property="og:site_name" content="江南人物的博客">
<meta property="og:locale">
<meta property="article:author" content="bi-an">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bi-an.github.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en, zh_CN'
  };
</script>

  <title>江南人物的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">江南人物的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/blog/resources/" rel="section"><i class="fa fa-paperclip fa-fw"></i>Resource</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/16/os/%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/16/os/%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81/" class="post-title-link" itemprop="url">用户态和内核态</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-08-16 13:31:26 / Modified: 05:56:33" itemprop="dateCreated datePublished" datetime="2025-08-16T13:31:26+00:00">2025-08-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="用户空间和内核空间是隔离的"><a href="#用户空间和内核空间是隔离的" class="headerlink" title="用户空间和内核空间是隔离的"></a>用户空间和内核空间是隔离的</h2><p>切换内核态和用户态为什么要内存复制？</p>
<table>
<thead>
<tr>
<th>问题</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>安全性</td>
<td>用户程序可能传入非法地址，导致内核崩溃或被利用攻击</td>
</tr>
<tr>
<td>稳定性</td>
<td>用户程序可能在 <code>poll()</code> 返回前修改数组，导致内核读取不一致</td>
</tr>
<tr>
<td>内存管理</td>
<td>用户空间内存可能被 swap 出或者释放，内核无法保证访问有效</td>
</tr>
</tbody></table>
<h2 id="内核态"><a href="#内核态" class="headerlink" title="内核态"></a>内核态</h2><p>我们在说“切换到内核态”时，其实指的是 CPU 特权级别从用户态（ring3）切换到内核态（ring0） 的过程。</p>
<p>用户态 vs 内核态</p>
<p>用户态（user mode）</p>
<p>应用程序（比如你写的 C++ 程序）运行的环境。</p>
<p>权限受限，不能直接操作硬件（如磁盘、网卡），也不能随便访问内核内存。</p>
<p>只能通过 系统调用 (syscall) 向内核请求服务。</p>
<p>内核态（kernel mode）</p>
<p>操作系统内核运行的环境。</p>
<p>拥有最高权限（ring0），可以操作 CPU 指令集、内存管理、驱动、硬件寄存器。</p>
<p>系统调用的实现代码就在内核态里。</p>
<p>“切换到内核态”的过程</p>
<p>当你调用一个系统调用，比如：</p>
<p>read(fd, buf, size);</p>
<p>你的程序在 用户态，调用 read()。</p>
<p>实际上 read() 会触发一条特殊指令（例如 Linux x86-64 用 syscall 指令）。</p>
<p>CPU 捕捉到这个指令，自动：</p>
<p>从用户态切换到内核态。</p>
<p>切换到内核栈。</p>
<p>保存用户态寄存器上下文。</p>
<p>跳到系统调用处理函数（比如 sys_read）。</p>
<p>内核态代码执行 sys_read，比如访问文件系统、检查 socket buffer。</p>
<p>处理完后返回，CPU 再切回用户态，恢复上下文，继续执行应用代码。</p>
<p>🔹 为什么要区分用户态&#x2F;内核态？</p>
<p>安全：用户程序不能直接操作硬件。</p>
<p>稳定性：即使用户程序崩溃，内核和其他进程不会受影响。</p>
<p>性能隔离：内核提供抽象（系统调用接口），避免应用直接干扰底层资源。</p>
<p>✅ 所以，总结一句：<br>“切换到内核态”就是 CPU 从运行普通用户代码（权限受限）切换到执行内核代码（最高权限）的过程，常常发生在系统调用、异常、硬件中断时。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/16/cpp/C++%E5%8F%B3%E5%80%BC%E5%BC%95%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/16/cpp/C++%E5%8F%B3%E5%80%BC%E5%BC%95%E7%94%A8/" class="post-title-link" itemprop="url">C++右值引用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-08-16 10:54:08 / Modified: 05:56:33" itemprop="dateCreated datePublished" datetime="2025-08-16T10:54:08+00:00">2025-08-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-左值、将亡值、纯右值"><a href="#1-左值、将亡值、纯右值" class="headerlink" title="1. 左值、将亡值、纯右值"></a>1. 左值、将亡值、纯右值</h2><p>C++11的值必定属于：左值、右值（将亡值、纯右值）三者之一。不是左值就是右值。详见值类别。</p>
<ul>
<li><strong>左值</strong>的特点：“有名字、可以取址”。没有名字或者不能取址，则必定是右值。</li>
<li><strong>右值</strong>的特点：即将消亡，也就是说“会被析构”。<ul>
<li><strong>纯右值</strong>：一定没有名字。比如除去<code>string</code>之外字面值常量、函数返回值、运算表达式。</li>
<li><strong>将亡值</strong>：即将消亡的值：比如临时变量，一旦离开作用域就会被销毁；可能没有名字，例如函数的返回值（非引用）。</li>
</ul>
</li>
</ul>
<p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">A</span>(); <span class="comment">// 匿名对象的作用域仅限于语句中，一旦离开当前语句，就会析构。</span></span><br><span class="line">    <span class="built_in">getchar</span>(); <span class="comment">// 暂停</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-引用、右值引用"><a href="#2-引用、右值引用" class="headerlink" title="2. 引用、右值引用"></a>2. 引用、右值引用</h2><p>右值引用涉及“右值”和“引用”两个概念。</p>
<ul>
<li><strong>引用</strong>不是对象，所以定义一个“右值引用”不会调用构造函数，避免了多余的构造过程。</li>
<li><strong>右值</strong>是即将析构的值，把右值绑定到右值引用上，延长了右值的生命期，所以右值对象没有析构。</li>
</ul>
<h3 id="右值引用规则："><a href="#右值引用规则：" class="headerlink" title="右值引用规则："></a>右值引用规则：</h3><ul>
<li>可以把左值绑定到左值引用。</li>
<li>可以把右值绑定到右值引用。</li>
<li>不允许把左值绑定到右值引用。</li>
<li>不允许把右值绑定到左值引用。</li>
<li><code>const</code>左值引用可以接受左值或右值。</li>
</ul>
<p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a1 = <span class="number">10</span>; <span class="comment">// 10是纯右值</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; aa = <span class="number">10</span>; <span class="comment">// 常量引用可以接受右值</span></span><br><span class="line"><span class="type">int</span>&amp;&amp; aaa = <span class="number">10</span>; <span class="comment">// 右值引用接受右值</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-引用和右值引用是左值"><a href="#3-引用和右值引用是左值" class="headerlink" title="3. 引用和右值引用是左值"></a>3. 引用和右值引用是左值</h2><p>引用（包括右值引用）本身是左值，可以取址，但不能对右值取址。</p>
<p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun1</span><span class="params">(<span class="type">int</span>&amp; t)</span> </span>&#123; <span class="comment">// 接受一个左值参数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun2</span><span class="params">(<span class="type">int</span>&amp;&amp; t)</span> </span>&#123; <span class="comment">// 接受一个右值参数，但t本身是左值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="type">int</span>&amp;&amp; ra = <span class="built_in">move</span>(a); <span class="comment">// move(a)返回一个右值，ra却是一个左值</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fun1</span>(ra); <span class="comment">// 正确：ra是左值，可以绑定到左值引用</span></span><br><span class="line">    <span class="built_in">fun2</span>(<span class="built_in">move</span>(a)); <span class="comment">// 正确：move(a)返回一个右值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-复制构造函数和移动构造函数"><a href="#4-复制构造函数和移动构造函数" class="headerlink" title="4. 复制构造函数和移动构造函数"></a>4. 复制构造函数和移动构造函数</h2><h3 id="为什么右值引用的构造函数被视为“移动”语义？"><a href="#为什么右值引用的构造函数被视为“移动”语义？" class="headerlink" title="为什么右值引用的构造函数被视为“移动”语义？"></a>为什么右值引用的构造函数被视为“移动”语义？</h3><p>因为输入参数是一个引用（右值引用也是引用），可以直接访问所引对象的资源并接管它，同时将源对象的资源置空。</p>
<p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> A&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(const A&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(A&amp;&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(A&amp;&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    <span class="function">A <span class="title">b</span><span class="params">(std::move(a))</span></span>; <span class="comment">// 调用移动构造函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-完美转发"><a href="#5-完美转发" class="headerlink" title="5. 完美转发"></a>5. 完美转发</h2><p>完美转发是指对模板参数实现完美转发：即输入什么类型（左值、右值）的参数，就是什么类型的参数。</p>
<h3 id="引用折叠规则："><a href="#引用折叠规则：" class="headerlink" title="引用折叠规则："></a>引用折叠规则：</h3><ul>
<li>如果有左值引用，优先折叠成左值引用。</li>
<li>如果只有右值引用，参数推导成右值引用。</li>
</ul>
<p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RunCode</span><span class="params">(<span class="type">int</span>&amp; m)</span> </span>&#123; cout &lt;&lt; <span class="string">&quot;lvalue ref&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RunCode</span><span class="params">(<span class="type">int</span>&amp;&amp; m)</span> </span>&#123; cout &lt;&lt; <span class="string">&quot;rvalue ref&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PerfectForward</span><span class="params">(T&amp;&amp; t)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">RunCode</span>(<span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(t)); <span class="comment">// 保证完美转发</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">PerfectForward</span>(a); <span class="comment">// lvalue ref</span></span><br><span class="line">    <span class="built_in">PerfectForward</span>(<span class="built_in">move</span>(a)); <span class="comment">// rvalue ref</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-移动构造函数、移动赋值函数、复制构造函数、复制赋值函数"><a href="#6-移动构造函数、移动赋值函数、复制构造函数、复制赋值函数" class="headerlink" title="6. 移动构造函数、移动赋值函数、复制构造函数、复制赋值函数"></a>6. 移动构造函数、移动赋值函数、复制构造函数、复制赋值函数</h2><h3 id="移动构造函数的注意事项："><a href="#移动构造函数的注意事项：" class="headerlink" title="移动构造函数的注意事项："></a>移动构造函数的注意事项：</h3><ul>
<li>移动构造函数不允许抛出异常，建议添加<code>noexcept</code>关键字。</li>
<li>使用<code>std::move_if_noexcept</code>可以在移动构造函数抛出异常时回退到复制构造函数。</li>
</ul>
<p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> A&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(const A&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(A&amp;&amp;) <span class="keyword">noexcept</span> &#123; cout &lt;&lt; <span class="string">&quot;A(A&amp;&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    <span class="function">A <span class="title">b</span><span class="params">(std::move(a))</span></span>; <span class="comment">// 调用移动构造函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-编译器优化"><a href="#7-编译器优化" class="headerlink" title="7. 编译器优化"></a>7. 编译器优化</h2><p>编译器默认会采用“返回值优化”（RVO或NRVO）。要观察移动语义与复制语义的不同，应该关闭编译器优化。</p>
<p>关闭优化命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -o <span class="built_in">test</span> main.cc -fno-elide-constructors</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-合成的移动操作"><a href="#8-合成的移动操作" class="headerlink" title="8. 合成的移动操作"></a>8. 合成的移动操作</h2><p>如果没有定义复制构造&#x2F;赋值函数，编译器会为我们合成（浅复制）。但如果自定义了复制构造函数、复制赋值运算符或析构函数，编译器将不会合成移动构造&#x2F;赋值函数。</p>
<p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> A&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(const A&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(A&amp;&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(A&amp;&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    <span class="function">A <span class="title">b</span><span class="params">(std::move(a))</span></span>; <span class="comment">// 调用移动构造函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-std-move的实现"><a href="#9-std-move的实现" class="headerlink" title="9. std::move的实现"></a>9. <code>std::move</code>的实现</h2><p><code>std::move</code>是一个类型转换，没有完成其他工作。</p>
<p>实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">typename</span> std::remove_reference&lt;T&gt;::<span class="function">type&amp;&amp; <span class="title">move</span><span class="params">(T&amp;&amp; t)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> std::remove_reference&lt;T&gt;::type&amp;&amp;&gt;(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-unique-ptr与std-move"><a href="#10-unique-ptr与std-move" class="headerlink" title="10. unique_ptr与std::move"></a>10. <code>unique_ptr</code>与<code>std::move</code></h2><p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">up</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">    unique_ptr&lt;<span class="type">int</span>&gt; p = std::<span class="built_in">move</span>(up); <span class="comment">// 现在up为空</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释：<code>std::move</code>调用<code>unique_ptr</code>的移动构造函数，转移<code>up</code>所拥有的资源，并将<code>up</code>置为空。</p>
<hr>
<h2 id="11-右值与sizeof"><a href="#11-右值与sizeof" class="headerlink" title="11. 右值与sizeof"></a>11. 右值与<code>sizeof</code></h2><p>示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="type">int</span> x, y;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(<span class="built_in">int</span>()) &lt;&lt; endl; <span class="comment">// 1</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(<span class="number">10</span>) &lt;&lt; endl; <span class="comment">// 4</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(A) &lt;&lt; endl; <span class="comment">// 8</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(<span class="built_in">A</span>()) &lt;&lt; endl; <span class="comment">// 1</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(<span class="built_in">f</span>()) &lt;&lt; endl; <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>《深入理解C++11: C++新特性解析与应用》</li>
<li>《C++ Primer 第五版》</li>
<li>C++中文 - API参考文档</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/15/CUDA%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/15/CUDA%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">CUDA实战</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-15 22:21:16" itemprop="dateCreated datePublished" datetime="2025-08-15T22:21:16+00:00">2025-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>直接将以前的文档搬过来：</p>
<p><a href="https://bi-an.github.io/CUDA/">https://bi-an.github.io/CUDA/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/12/Bazel%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/12/Bazel%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">Bazel入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-12 20:21:42" itemprop="dateCreated datePublished" datetime="2025-08-12T20:21:42+00:00">2025-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Bazel简介"><a href="#Bazel简介" class="headerlink" title="Bazel简介"></a>Bazel简介</h2><p>Bazel 是 Google 开发并开源的一款构建工具（build system），主要用来自动化编译、测试和打包大型软件项目。</p>
<ul>
<li>高速构建：相当于智能化的Make</li>
<li>可复现构建：通过严格的声明式 BUILD 文件，确保每次构建结果一致。</li>
<li>跨平台：支持 Linux、macOS、Windows 等多个操作系统。</li>
<li>支持多语言：不只支持 C++，还支持 Java、Python、Go、Shell 等多种语言的项目构建。</li>
</ul>
<h2 id="安装Bazel"><a href="#安装Bazel" class="headerlink" title="安装Bazel"></a>安装Bazel</h2><h3 id="方法1：apt-镜像源"><a href="#方法1：apt-镜像源" class="headerlink" title="方法1：apt 镜像源"></a>方法1：apt 镜像源</h3><p>清华 apt 镜像源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/bazel.list &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/bazel-apt stable jdk1.8</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<p>注：<code>jdk1.8</code>是<code>https://mirrors.tuna.tsinghua.edu.cn/bazel-apt/dists/stable/</code>下的一个目录。<br>如果提示找不到对应的路径，就去查看该目录是否存在。</p>
<p>导入清华镜像的 GPG key：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor | sudo <span class="built_in">tee</span> /etc/apt/trusted.gpg.d/bazel.gpg &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>更新并安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install bazel</span><br><span class="line">bazel --version</span><br></pre></td></tr></table></figure>

<h3 id="方法-2：直接下载二进制（绕过-apt）"><a href="#方法-2：直接下载二进制（绕过-apt）" class="headerlink" title="方法 2：直接下载二进制（绕过 apt）"></a>方法 2：直接下载二进制（绕过 apt）</h3><p>从 GitHub Release 下载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/bazelbuild/bazel/releases/download/6.5.0/bazel-6.5.0-linux-x86_64</span><br><span class="line"><span class="built_in">chmod</span> +x bazel-6.5.0-linux-x86_64</span><br><span class="line">sudo <span class="built_in">mv</span> bazel-6.5.0-linux-x86_64 /usr/local/bin/bazel</span><br><span class="line">bazel --version</span><br></pre></td></tr></table></figure>

<h3 id="方法-3：用-Bazelisk-自动下载版本"><a href="#方法-3：用-Bazelisk-自动下载版本" class="headerlink" title="方法 3：用 Bazelisk 自动下载版本"></a>方法 3：用 Bazelisk 自动下载版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/bazelbuild/bazelisk/releases/download/v1.21.0/bazelisk-linux-amd64</span><br><span class="line"><span class="built_in">chmod</span> +x bazelisk-linux-amd64</span><br><span class="line">sudo <span class="built_in">mv</span> bazelisk-linux-amd64 /usr/local/bin/bazel</span><br><span class="line">bazel --version</span><br></pre></td></tr></table></figure>

<p>第一次运行时会自动拉取所需版本。</p>
<h2 id="使用Bazel"><a href="#使用Bazel" class="headerlink" title="使用Bazel"></a>使用Bazel</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>bazel build //target</code></td>
<td>构建指定目标</td>
</tr>
<tr>
<td><code>bazel test //target</code></td>
<td>运行指定测试</td>
</tr>
<tr>
<td><code>bazel run //target</code></td>
<td>构建并运行可执行文件</td>
</tr>
<tr>
<td><code>bazel clean</code></td>
<td>清理构建缓存</td>
</tr>
</tbody></table>
<h3 id="项目结构示例"><a href="#项目结构示例" class="headerlink" title="项目结构示例"></a>项目结构示例</h3><p>假设你有一个 C++ 项目，目录结构：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WORKSPACE</span><br><span class="line">BUILD</span><br><span class="line"><span class="selector-tag">main</span><span class="selector-class">.cpp</span></span><br><span class="line">hello<span class="selector-class">.h</span></span><br><span class="line">hello<span class="selector-class">.cpp</span></span><br><span class="line">hello_test<span class="selector-class">.cpp</span></span><br></pre></td></tr></table></figure>

<ul>
<li>WORKSPACE 文件：标记项目根目录，Bazel 必需。内容可以为空。</li>
<li>BUILD 文件：描述如何构建项目。</li>
</ul>
<h3 id="写一个简单-BUILD-文件"><a href="#写一个简单-BUILD-文件" class="headerlink" title="写一个简单 BUILD 文件"></a>写一个简单 BUILD 文件</h3><figure class="highlight plaintext"><figcaption><span>BUILD</span><a href="/blog/downloads/code/bazel_hello/BUILD">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cc_library(</span><br><span class="line">    name = &quot;hello_lib&quot;,</span><br><span class="line">    srcs = [&quot;hello.cpp&quot;],</span><br><span class="line">    hdrs = [&quot;hello.h&quot;],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cc_binary(</span><br><span class="line">    name = &quot;hello_bin&quot;,</span><br><span class="line">    srcs = [&quot;main.cpp&quot;],</span><br><span class="line">    deps = [&quot;:hello_lib&quot;],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cc_test(</span><br><span class="line">    name = &quot;hello_test&quot;,</span><br><span class="line">    srcs = [&quot;hello_test.cpp&quot;],</span><br><span class="line">    deps = [&quot;:hello_lib&quot;, &quot;@googletest//:gtest_main&quot;],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="简单源码示例"><a href="#简单源码示例" class="headerlink" title="简单源码示例"></a>简单源码示例</h3><figure class="highlight cpp"><figcaption><span>hello.h</span><a href="/blog/downloads/code/bazel_hello/hello.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">say_hello</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>hello.cpp</span><a href="/blog/downloads/code/bazel_hello/hello.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">say_hello</span><span class="params">()</span> </span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello, Bazel!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>hello_test.cpp</span><a href="/blog/downloads/code/bazel_hello/hello_test.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gtest/gtest.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">TEST</span>(HelloTest, Basic) {</span><br><span class="line">    <span class="built_in">EXPECT_NO_THROW</span>(<span class="built_in">say_hello</span>());</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>{</span><br><span class="line">    testing::<span class="built_in">InitGoogleTest</span>(&amp;argc, argv);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RUN_ALL_TESTS</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>main.cpp</span><a href="/blog/downloads/code/bazel_hello/main.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">say_hello</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="构建和测试"><a href="#构建和测试" class="headerlink" title="构建和测试"></a>构建和测试</h3><ul>
<li><p>编译可执行文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bazel build //:hello_bin</span><br></pre></td></tr></table></figure>
<p>其中，冒号用于分隔路径和目标。</p>
</li>
<li><p>运行可执行文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bazel run //:hello_bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bazel <span class="built_in">test</span> //:hello_test</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/12/cpp/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/12/cpp/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/" class="post-title-link" itemprop="url">智能指针</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-12 10:16:44" itemprop="dateCreated datePublished" datetime="2025-08-12T10:16:44+00:00">2025-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="shared-ptr是线程安全的吗？"><a href="#shared-ptr是线程安全的吗？" class="headerlink" title="shared_ptr是线程安全的吗？"></a>shared_ptr是线程安全的吗？</h2><p><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/1_82_0/libs/smart_ptr/doc/html/smart_ptr.html#shared_ptr_thread_safety">Boost官网：shared_ptr_thread_safety</a></p>
<p>shared_ptr与内建类型（比如int, char；std::string不是内建类型）具有相同的线程安全等级：</p>
<ul>
<li>同一个shared_ptr可以被并发读；</li>
<li>不同的shared_ptr可以被并发写（析构也是写）。</li>
<li>其他并发访问是未定义的。</li>
</ul>
<p>Examples:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">42</span>))</span></span>;</span><br></pre></td></tr></table></figure>

<p>Code Example 4. Reading a shared_ptr from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p2</span><span class="params">(p)</span></span>; <span class="comment">// reads p</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p3</span><span class="params">(p)</span></span>; <span class="comment">// OK, multiple reads are safe</span></span><br></pre></td></tr></table></figure>
<p>读取同一个shared_ptr是线程安全的。<br>同时增加引用计数，安全。</p>
<p>Code Example 5. Writing different shared_ptr instances from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line">p.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">1912</span>)); <span class="comment">// writes p</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line">p2.<span class="built_in">reset</span>(); <span class="comment">// OK, writes p2</span></span><br></pre></td></tr></table></figure>
<p>写不同的shared_ptr实例是线程安全的。<br>不同的实例各自更新自己的引用计数控制块指针，安全。<br>对共同掌管的资源的引用计数原子减1，安全。</p>
<p>Code Example 6. Reading and writing a shared_ptr from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line">p = p3; <span class="comment">// reads p3, writes p</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line">p3.<span class="built_in">reset</span>(); <span class="comment">// writes p3; undefined, simultaneous read/write</span></span><br></pre></td></tr></table></figure>
<p>同时读写同一个shared_ptr实例，是线程不安全的。<br>同时对引用计数进行增减，如果先看到减到0，那么可能资源已经被释放。</p>
<p>Code Example 7. Reading and destroying a shared_ptr from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line">p3 = p2; <span class="comment">// reads p2, writes p3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line"><span class="comment">// p2 goes out of scope: undefined, the destructor is considered a &quot;write access&quot;</span></span><br></pre></td></tr></table></figure>
<p>同时读写（析构也是写）同一个shared_ptr实例，是线程不安全的。</p>
<p>Code Example 8. Writing a shared_ptr from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line">p3.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line">p3.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">2</span>)); <span class="comment">// undefined, multiple writes</span></span><br></pre></td></tr></table></figure>
<p>同时写同一个shared_ptr，可能对引用计数操作多次（应该只能操作一次），线程不安全。</p>
<p><strong>测试：模拟潜在竞态条件：</strong></p>
<p>最后一个引用即将销毁时，另一个线程试图复制</p>
<details>
<summary>示例1：复制构造和reset()竞争</summary>

<figure class="highlight cpp"><figcaption><span>race1.cpp</span><a href="/blog/downloads/code/shared_ptr/race1.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="built_in">Test</span>() { std::cout &lt;&lt; <span class="string">&quot;Test constructed\n&quot;</span>; }</span><br><span class="line">    ~<span class="built_in">Test</span>() { std::cout &lt;&lt; <span class="string">&quot;Test destroyed\n&quot;</span>; }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread_copy</span><span class="params">(std::shared_ptr&lt;Test&gt;&amp; ptr)</span> </span>{</span><br><span class="line">    <span class="comment">// 模拟延迟，试图在主线程销毁后复制</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread attempting to copy shared_ptr\n&quot;</span>;</span><br><span class="line">    std::shared_ptr&lt;Test&gt; local_copy = ptr;  <span class="comment">// 资源可能已经释放</span></span><br><span class="line">    <span class="keyword">if</span> (local_copy) {      <span class="comment">// shared_ptr 还存在，所以可以用来检查资源是否有效</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread copied shared_ptr\n&quot;</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread failed to copy shared_ptr\n&quot;</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    std::shared_ptr&lt;Test&gt; ptr = std::<span class="built_in">make_shared</span>&lt;Test&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(thread_copy, std::ref(ptr))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主线程销毁 shared_ptr</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">50</span>));</span><br><span class="line">    ptr.<span class="built_in">reset</span>();  <span class="comment">// 引用计数降为 0，销毁对象</span></span><br><span class="line"></span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

</details>

<p>总结： <code>reset()</code> 与复制构造需要加锁保护。</p>
<details>
<summary>示例2：复制构造和析构竞争</summary>

<figure class="highlight cpp"><figcaption><span>race2.cpp</span><a href="/blog/downloads/code/shared_ptr/race2.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="built_in">Test</span>() { std::cout &lt;&lt; <span class="string">&quot;Test constructed\n&quot;</span>; }</span><br><span class="line">    ~<span class="built_in">Test</span>() { std::cout &lt;&lt; <span class="string">&quot;Test destroyed\n&quot;</span>; }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread_copy</span><span class="params">(std::shared_ptr&lt;Test&gt;&amp; ptr)</span> </span>{</span><br><span class="line">    <span class="comment">// 模拟延迟，试图在主线程销毁后复制</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread attempting to copy shared_ptr\n&quot;</span>;</span><br><span class="line">    std::shared_ptr&lt;Test&gt; local_copy = ptr;  <span class="comment">// 如果 ptr 已经销毁，这里是未定义行为</span></span><br><span class="line">    <span class="keyword">if</span> (local_copy) {                        <span class="comment">// 可能“成功”复制一个已经销毁的 shared_ptr</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread copied shared_ptr\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Use count in thread: &quot;</span></span><br><span class="line">                  &lt;&lt; local_copy.<span class="built_in">use_count</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;  <span class="comment">// 引用计数控制块是一个野指针</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread failed to copy shared_ptr\n&quot;</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    std::thread t;</span><br><span class="line"></span><br><span class="line">    {</span><br><span class="line">        std::shared_ptr&lt;Test&gt; ptr = std::<span class="built_in">make_shared</span>&lt;Test&gt;();</span><br><span class="line"></span><br><span class="line">        t = std::<span class="built_in">thread</span>(thread_copy, std::<span class="built_in">ref</span>(ptr));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 主线程销毁 shared_ptr</span></span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">50</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 析构，引用计数降为 0，销毁对象</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

</details>


<p><strong>总结：</strong></p>
<ul>
<li>不能以左值引用来复制构造shared_ptr，否则会存在竞争。</li>
<li>可以使用const引用，因为可以延续shared_ptr的生命期，析构被推迟，间接消除了竞态。</li>
<li>程序中shared_ptr读写操作同时存在时，需要加锁。</li>
<li>要防止shared_ptr析构：在shared_ptr副本的整个作用域内加锁同样可以保护这种情况。</li>
<li>C++20 开始支持 <code>atomic&lt;shared_ptr&lt;T&gt;&gt;</code>，可以安全地在多个线程之间共享和更新 shared_ptr。</li>
<li>如果 thread A 只是想观察 p2 是否还存在，可以使用 std::weak_ptr 来观察。</li>
</ul>
<h2 id="shared-ptr为什么要隐式自持一个weak-count？"><a href="#shared-ptr为什么要隐式自持一个weak-count？" class="headerlink" title="shared_ptr为什么要隐式自持一个weak count？"></a>shared_ptr为什么要隐式自持一个weak count？</h2><p>每个 shared_ptr 和 weak_ptr 都指向一个 控制块（control block），这个控制块通常包含：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>strong count</td>
<td>当前活跃的 shared_ptr 数量</td>
</tr>
<tr>
<td>weak count</td>
<td>当前活跃的 weak_ptr 数量 + 当前活跃的 shared_ptr 数量</td>
</tr>
<tr>
<td>指向对象的指针</td>
<td>被管理的资源</td>
</tr>
</tbody></table>
<p>控制块的生命周期由 weak count 决定，只要还有 weak_ptr 或 shared_ptr 存在，控制块就不能被销毁。</p>
<ul>
<li>weak_ptr和shared_ptr可能存在只有两者之一的情况，所以他们都必须要维护控制块的生命周期。</li>
<li>如果只有weak_ptr对weak count进行计数，那么可能出现shared_ptr和weak_ptr共同看到weak count为0的情况：<ul>
<li>weak_ptr析构将weak count降低为0，准备释放控制块；</li>
<li>shared_ptr析构或reset，检测到weak count为0，准备释放控制块；</li>
<li>这样就释放了两次，因为他们都持有指针，且没有设置相互通知的机制。</li>
</ul>
</li>
<li>但是，如果weak_ptr和shared_ptr都对weak count进行计数，那么就不可能同时观察到weak count为0的情况。</li>
</ul>
<h2 id="动手实现一个shared-ptr"><a href="#动手实现一个shared-ptr" class="headerlink" title="动手实现一个shared_ptr"></a>动手实现一个shared_ptr</h2><details>
<summary>SimpleSharedPtr</summary>

<figure class="highlight cpp"><figcaption><span>SimpleSharedPtr.cpp</span><a href="/blog/downloads/code/shared_ptr/SimpleSharedPtr.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleSharedPtr</span>;  <span class="comment">// 先声明</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleWeakPtr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ControlBlock</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::atomic&lt;<span class="type">int</span>&gt; shared_count;</span><br><span class="line">    std::atomic&lt;<span class="type">int</span>&gt; weak_count;</span><br><span class="line">    T* ptr;</span><br><span class="line">    std::function&lt;<span class="type">void</span>(T*)&gt; deleter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每个shared_ptr自持一个weak count</span></span><br><span class="line">    <span class="built_in">ControlBlock</span>(T* p, std::function&lt;<span class="built_in">void</span>(T*)&gt; d)</span><br><span class="line">        : <span class="built_in">shared_count</span>(<span class="number">1</span>), <span class="built_in">weak_count</span>(<span class="number">1</span>), <span class="built_in">ptr</span>(p), <span class="built_in">deleter</span>(d ? d : [](T* p){ <span class="keyword">delete</span> p; }) {}</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ControlBlock</span>() = <span class="keyword">default</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleSharedPtr</span> {</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ControlBlock&lt;T&gt;* ctrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            <span class="comment">// 减shared_count</span></span><br><span class="line">            <span class="keyword">if</span> (ctrl-&gt;shared_count.<span class="built_in">fetch_sub</span>(<span class="number">1</span>, std::memory_order_acq_rel) == <span class="number">1</span>) {</span><br><span class="line">                <span class="comment">// 最后一个shared_ptr，释放资源</span></span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    ctrl-&gt;<span class="built_in">deleter</span>(ctrl-&gt;ptr);</span><br><span class="line">                } <span class="built_in">catch</span> (...) {</span><br><span class="line">                    std::cerr &lt;&lt; <span class="string">&quot;Exception in deleter\n&quot;</span>;</span><br><span class="line">                }</span><br><span class="line">                ctrl-&gt;ptr = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 再减少weak_count，自己占有一个weak计数，减少它</span></span><br><span class="line">                <span class="keyword">if</span> (ctrl-&gt;weak_count.<span class="built_in">fetch_sub</span>(<span class="number">1</span>, std::memory_order_acq_rel) == <span class="number">1</span>) {</span><br><span class="line">                    <span class="keyword">delete</span> ctrl;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">SimpleSharedPtr</span><span class="params">(T* p = <span class="literal">nullptr</span>, std::function&lt;<span class="type">void</span>(T*)&gt; d = <span class="literal">nullptr</span>)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (p) {</span><br><span class="line">            ctrl = <span class="keyword">new</span> <span class="built_in">ControlBlock</span>&lt;T&gt;(p, d);</span><br><span class="line">            <span class="comment">// shared_count=1, weak_count=0</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拷贝构造</span></span><br><span class="line">    <span class="built_in">SimpleSharedPtr</span>(<span class="type">const</span> SimpleSharedPtr&amp; other) : <span class="built_in">ctrl</span>(other.ctrl) {</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            ctrl-&gt;shared_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移动构造</span></span><br><span class="line">    <span class="built_in">SimpleSharedPtr</span>(SimpleSharedPtr&amp;&amp; other) <span class="keyword">noexcept</span> : <span class="built_in">ctrl</span>(other.ctrl) {</span><br><span class="line">        other.ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 析构</span></span><br><span class="line">    ~<span class="built_in">SimpleSharedPtr</span>() {</span><br><span class="line">        <span class="built_in">release</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拷贝赋值</span></span><br><span class="line">    SimpleSharedPtr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> SimpleSharedPtr&amp; other) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) {</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ctrl = other.ctrl;</span><br><span class="line">            <span class="keyword">if</span> (ctrl) {</span><br><span class="line">                ctrl-&gt;shared_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移动赋值</span></span><br><span class="line">    SimpleSharedPtr&amp; <span class="keyword">operator</span>=(SimpleSharedPtr&amp;&amp; other) <span class="keyword">noexcept</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) {</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ctrl = other.ctrl;</span><br><span class="line">            other.ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function">T* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ctrl ? ctrl-&gt;ptr : <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="type">const</span> {</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">get</span>()) <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Dereferencing null pointer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> *(ctrl-&gt;ptr);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="type">const</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ctrl ? ctrl-&gt;shared_count.<span class="built_in">load</span>(std::memory_order_relaxed) : <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">unique</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">use_count</span>() == <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get</span>() != <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">(T* p = <span class="literal">nullptr</span>, std::function&lt;<span class="type">void</span>(T*)&gt; d = <span class="literal">nullptr</span>)</span> </span>{</span><br><span class="line">        <span class="built_in">release</span>();</span><br><span class="line">        <span class="keyword">if</span> (p) {</span><br><span class="line">            ctrl = <span class="keyword">new</span> <span class="built_in">ControlBlock</span>&lt;T&gt;(p, d);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给 SimpleWeakPtr 访问 ControlBlock 指针权限</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">SimpleWeakPtr</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// SimpleSharedPtr增加一个私有构造，能从控制块构造shared_ptr（配合weak_ptr的lock）</span></span><br><span class="line">    <span class="built_in">SimpleSharedPtr</span>(ControlBlock&lt;T&gt;* c) : <span class="built_in">ctrl</span>(c) {}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleWeakPtr</span> {</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ControlBlock&lt;T&gt;* ctrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            <span class="keyword">if</span> (ctrl-&gt;weak_count.<span class="built_in">fetch_sub</span>(<span class="number">1</span>, std::memory_order_acq_rel) == <span class="number">1</span>) {</span><br><span class="line">                <span class="comment">// 只有弱引用且没有shared_ptr存在时，销毁控制块</span></span><br><span class="line">                <span class="keyword">if</span> (ctrl-&gt;shared_count.<span class="built_in">load</span>(std::memory_order_acquire) == <span class="number">0</span>) {</span><br><span class="line">                    <span class="keyword">delete</span> ctrl;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SimpleWeakPtr</span>() : <span class="built_in">ctrl</span>(<span class="literal">nullptr</span>) {}</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 shared_ptr 构造 weak_ptr</span></span><br><span class="line">    <span class="built_in">SimpleWeakPtr</span>(<span class="type">const</span> SimpleSharedPtr&lt;T&gt;&amp; shared) : <span class="built_in">ctrl</span>(shared.ctrl) {</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            ctrl-&gt;weak_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拷贝构造</span></span><br><span class="line">    <span class="built_in">SimpleWeakPtr</span>(<span class="type">const</span> SimpleWeakPtr&amp; other) : <span class="built_in">ctrl</span>(other.ctrl) {</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            ctrl-&gt;weak_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移动构造</span></span><br><span class="line">    <span class="built_in">SimpleWeakPtr</span>(SimpleWeakPtr&amp;&amp; other) <span class="keyword">noexcept</span> : <span class="built_in">ctrl</span>(other.ctrl) {</span><br><span class="line">        other.ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">SimpleWeakPtr</span>() {</span><br><span class="line">        <span class="built_in">release</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拷贝赋值</span></span><br><span class="line">    SimpleWeakPtr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> SimpleWeakPtr&amp; other) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) {</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ctrl = other.ctrl;</span><br><span class="line">            <span class="keyword">if</span> (ctrl) {</span><br><span class="line">                ctrl-&gt;weak_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移动赋值</span></span><br><span class="line">    SimpleWeakPtr&amp; <span class="keyword">operator</span>=(SimpleWeakPtr&amp;&amp; other) <span class="keyword">noexcept</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) {</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ctrl = other.ctrl;</span><br><span class="line">            other.ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ctrl ? ctrl-&gt;shared_count.<span class="built_in">load</span>(std::memory_order_relaxed) : <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">expired</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">use_count</span>() == <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试获取shared_ptr，资源已被销毁则返回空shared_ptr</span></span><br><span class="line">    <span class="function">SimpleSharedPtr&lt;T&gt; <span class="title">lock</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">expired</span>()) {</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SimpleSharedPtr</span>&lt;T&gt;();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 尝试增加shared_count</span></span><br><span class="line">            <span class="type">int</span> old_count = ctrl-&gt;shared_count.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">            <span class="keyword">while</span> (old_count != <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">if</span> (ctrl-&gt;shared_count.<span class="built_in">compare_exchange_weak</span>(old_count, old_count + <span class="number">1</span>,</span><br><span class="line">                    std::memory_order_acq_rel, std::memory_order_relaxed)) {</span><br><span class="line">                    <span class="comment">// 成功增加shared_count</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">SimpleSharedPtr</span>&lt;T&gt;(ctrl);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// old_count 已被更新，继续循环</span></span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SimpleSharedPtr</span>&lt;T&gt;();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 让 SimpleSharedPtr 可以通过控制块构造 shared_ptr</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">SimpleSharedPtr</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">SimpleWeakPtr</span><span class="params">(ControlBlock&lt;T&gt;* c)</span> : ctrl(c) {</span>}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">SimpleSharedPtr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">42</span>))</span></span>;</span><br><span class="line">    SimpleWeakPtr&lt;<span class="type">int</span>&gt; wp1 = sp1;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;use_count: &quot;</span> &lt;&lt; sp1.<span class="built_in">use_count</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>; <span class="comment">// 1</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;expired: &quot;</span> &lt;&lt; wp1.<span class="built_in">expired</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;    <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> sp2 = wp1.<span class="built_in">lock</span>()) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;locked value: &quot;</span> &lt;&lt; *sp2 &lt;&lt; <span class="string">&quot;\n&quot;</span>;    <span class="comment">// 42</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;use_count after lock: &quot;</span> &lt;&lt; sp2.<span class="built_in">use_count</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>; <span class="comment">// 2</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    sp1.<span class="built_in">reset</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;expired after reset: &quot;</span> &lt;&lt; wp1.<span class="built_in">expired</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>; <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> sp3 = wp1.<span class="built_in">lock</span>()) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Should not print\n&quot;</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;lock failed, resource expired\n&quot;</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

</details>

<h2 id="附录：shared-ptr源码"><a href="#附录：shared-ptr源码" class="headerlink" title="附录：shared_ptr源码"></a>附录：shared_ptr源码</h2><ul>
<li><code>/usr/include/c++/11/bits/shared_ptr.h</code></li>
<li><code>/usr/include/c++/11/bits/shared_ptr_base.h</code></li>
<li><code>/usr/include/c++/11/bits/shared_ptr_atomic.h</code></li>
</ul>
<details>
<summary>shared_ptr.h</summary>
<figure class="highlight cpp"><figcaption><span>shared_ptr.h</span><a href="/blog/downloads/code/shared_ptr/shared_ptr.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr and weak_ptr implementation -*- C++ -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Copyright (C) 2007-2021 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file is part of the GNU ISO C++ Library.  This library is free</span></span><br><span class="line"><span class="comment">// software; you can redistribute it and/or modify it under the</span></span><br><span class="line"><span class="comment">// terms of the GNU General Public License as published by the</span></span><br><span class="line"><span class="comment">// Free Software Foundation; either version 3, or (at your option)</span></span><br><span class="line"><span class="comment">// any later version.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This library is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">// GNU General Public License for more details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Under Section 7 of GPL version 3, you are granted additional</span></span><br><span class="line"><span class="comment">// permissions described in the GCC Runtime Library Exception, version</span></span><br><span class="line"><span class="comment">// 3.1, as published by the Free Software Foundation.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You should have received a copy of the GNU General Public License and</span></span><br><span class="line"><span class="comment">// a copy of the GCC Runtime Library Exception along with this program;</span></span><br><span class="line"><span class="comment">// see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see</span></span><br><span class="line"><span class="comment">// &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// GCC Note: Based on files from version 1.32.0 of the Boost library.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  shared_count.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (c) 2001, 2002, 2003 Peter Dimov and Multi Media Ltd.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  shared_ptr.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 1998, 1999 Greg Colvin and Beman Dawes.</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2001, 2002, 2003 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  weak_ptr.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2001, 2002, 2003 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  enable_shared_from_this.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2002 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Distributed under the Boost Software License, Version 1.0. (See</span></span><br><span class="line"><span class="comment">// accompanying file LICENSE_1_0.txt or copy at</span></span><br><span class="line"><span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** @file</span></span><br><span class="line"><span class="comment"> *  This is an internal header file, included by other library headers.</span></span><br><span class="line"><span class="comment"> *  Do not attempt to use it directly. @headername{memory}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SHARED_PTR_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SHARED_PTR_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iosfwd&gt;</span>           	  <span class="comment">// std::basic_ostream</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/shared_ptr_base.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> std _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">{</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @addtogroup pointer_abstractions</span></span><br><span class="line"><span class="comment">   * @{</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.11 shared_ptr I/O</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Write the stored pointer to an ostream.</span></span><br><span class="line">  <span class="comment">/// @relates shared_ptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ch, <span class="keyword">typename</span> _Tr, <span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> std::basic_ostream&lt;_Ch, _Tr&gt;&amp;</span><br><span class="line">    <span class="keyword">operator</span>&lt;&lt;(std::basic_ostream&lt;_Ch, _Tr&gt;&amp; __os,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __p)</span><br><span class="line">    {</span><br><span class="line">      __os &lt;&lt; __p.<span class="built_in">get</span>();</span><br><span class="line">      <span class="keyword">return</span> __os;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> _Del*</span></span><br><span class="line"><span class="function">    <span class="title">get_deleter</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __p)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_rtti</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;_Del*&gt;(__p._M_get_deleter(<span class="built_in">typeid</span>(_Del)));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 20.7.2.2.10 shared_ptr get_deleter</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// If `__p` has a deleter of type `_Del`, return a pointer to it.</span></span><br><span class="line">  <span class="comment">/// @relates shared_ptr</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> _Del*</span></span><br><span class="line"><span class="function">    <span class="title">get_deleter</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __p)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_rtti</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;_Del*&gt;(__p._M_get_deleter(<span class="built_in">typeid</span>(_Del)));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  A smart pointer with reference-counted copy semantics.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * A `shared_ptr` object is either empty or _owns_ a pointer passed</span></span><br><span class="line"><span class="comment">   * to the constructor. Copies of a `shared_ptr` share ownership of</span></span><br><span class="line"><span class="comment">   * the same pointer. When the last `shared_ptr` that owns the pointer</span></span><br><span class="line"><span class="comment">   * is destroyed or reset, the owned pointer is freed (either by `delete`</span></span><br><span class="line"><span class="comment">   * or by invoking a custom deleter that was passed to the constructor).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * A `shared_ptr` also stores another pointer, which is usually</span></span><br><span class="line"><span class="comment">   * (but not always) the same pointer as it owns. The stored pointer</span></span><br><span class="line"><span class="comment">   * can be retrieved by calling the `get()` member function.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * The equality and relational operators for `shared_ptr` only compare</span></span><br><span class="line"><span class="comment">   * the stored pointer returned by `get()`, not the owned pointer.</span></span><br><span class="line"><span class="comment">   * To test whether two `shared_ptr` objects share ownership of the same</span></span><br><span class="line"><span class="comment">   * pointer see `std::shared_ptr::owner_before` and `std::owner_less`.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">shared_ptr</span> : <span class="keyword">public</span> __shared_ptr&lt;_Tp&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	<span class="keyword">using</span> _Constructible = <span class="keyword">typename</span> enable_if&lt;</span><br><span class="line">	  is_constructible&lt;__shared_ptr&lt;_Tp&gt;, _Args...&gt;::value</span><br><span class="line">	&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Arg&gt;</span><br><span class="line">	<span class="keyword">using</span> _Assignable = <span class="keyword">typename</span> enable_if&lt;</span><br><span class="line">	  is_assignable&lt;__shared_ptr&lt;_Tp&gt;&amp;, _Arg&gt;::value, shared_ptr&amp;</span><br><span class="line">	&gt;::type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// The type pointed to by the stored pointer, remove_extent_t&lt;_Tp&gt;</span></span><br><span class="line">      <span class="keyword">using</span> element_type = <span class="keyword">typename</span> __shared_ptr&lt;_Tp&gt;::element_type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt;= 201703L</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __cpp_lib_shared_ptr_weak_type 201606</span></span><br><span class="line">      <span class="comment">/// The corresponding weak_ptr type for this shared_ptr</span></span><br><span class="line">      <span class="keyword">using</span> weak_type = weak_ptr&lt;_Tp&gt;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct an empty %shared_ptr.</span></span><br><span class="line"><span class="comment">       *  @post   use_count()==0 &amp;&amp; get()==0</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">constexpr</span> <span class="title">shared_ptr</span><span class="params">()</span> <span class="keyword">noexcept</span> : __shared_ptr&lt;_Tp&gt;() {</span> }</span><br><span class="line"></span><br><span class="line">      <span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>; <span class="comment">///&lt; Copy constructor</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns the pointer @a __p.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer that is convertible to element_type*.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @c delete @a __p is called.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;_Yp*&gt;&gt;</span><br><span class="line">	<span class="keyword">explicit</span></span><br><span class="line">	<span class="built_in">shared_ptr</span>(_Yp* __p) : __shared_ptr&lt;_Tp&gt;(__p) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns the pointer @a __p</span></span><br><span class="line"><span class="comment">       *          and the deleter @a __d.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer.</span></span><br><span class="line"><span class="comment">       *  @param  __d  A deleter.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @a __d(__p) is called.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Requirements: _Deleter&#x27;s copy constructor and destructor must</span></span><br><span class="line"><span class="comment">       *  not throw</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  __shared_ptr will release __p by calling __d(__p)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;_Yp*, _Deleter&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(_Yp* __p, _Deleter __d)</span><br><span class="line">        : __shared_ptr&lt;_Tp&gt;(__p, std::<span class="built_in">move</span>(__d)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns a null pointer</span></span><br><span class="line"><span class="comment">       *          and the deleter @a __d.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A null pointer constant.</span></span><br><span class="line"><span class="comment">       *  @param  __d  A deleter.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @a __d(__p) is called.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Requirements: _Deleter&#x27;s copy constructor and destructor must</span></span><br><span class="line"><span class="comment">       *  not throw</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  The last owner will call __d(__p)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Deleter&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(<span class="type">nullptr_t</span> __p, _Deleter __d)</span><br><span class="line">        : __shared_ptr&lt;_Tp&gt;(__p, std::<span class="built_in">move</span>(__d)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns the pointer @a __p</span></span><br><span class="line"><span class="comment">       *          and the deleter @a __d.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer.</span></span><br><span class="line"><span class="comment">       *  @param  __d  A deleter.</span></span><br><span class="line"><span class="comment">       *  @param  __a  An allocator.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @a __d(__p) is called.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Requirements: _Deleter&#x27;s copy constructor and destructor must</span></span><br><span class="line"><span class="comment">       *  not throw _Alloc&#x27;s copy constructor and destructor must not</span></span><br><span class="line"><span class="comment">       *  throw.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  __shared_ptr will release __p by calling __d(__p)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;_Yp*, _Deleter, _Alloc&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(_Yp* __p, _Deleter __d, _Alloc __a)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns a null pointer</span></span><br><span class="line"><span class="comment">       *          and the deleter @a __d.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A null pointer constant.</span></span><br><span class="line"><span class="comment">       *  @param  __d  A deleter.</span></span><br><span class="line"><span class="comment">       *  @param  __a  An allocator.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @a __d(__p) is called.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Requirements: _Deleter&#x27;s copy constructor and destructor must</span></span><br><span class="line"><span class="comment">       *  not throw _Alloc&#x27;s copy constructor and destructor must not</span></span><br><span class="line"><span class="comment">       *  throw.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  The last owner will call __d(__p)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(<span class="type">nullptr_t</span> __p, _Deleter __d, _Alloc __a)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Aliasing constructor</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Constructs a `shared_ptr` instance that stores `__p`</span></span><br><span class="line"><span class="comment">       *          and shares ownership with `__r`.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A `shared_ptr`.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer that will remain valid while `*__r` is valid.</span></span><br><span class="line"><span class="comment">       *  @post   `get() == __p &amp;&amp; use_count() == __r.use_count()`</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  This can be used to construct a `shared_ptr` to a sub-object</span></span><br><span class="line"><span class="comment">       *  of an object managed by an existing `shared_ptr`. The complete</span></span><br><span class="line"><span class="comment">       *  object will remain valid while any `shared_ptr` owns it, even</span></span><br><span class="line"><span class="comment">       *  if they don&#x27;t store a pointer to the complete object.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * @code</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;pair&lt;int,int&gt;&gt; pii(new pair&lt;int,int&gt;());</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;int&gt; pi(pii, &amp;pii-&gt;first);</span></span><br><span class="line"><span class="comment">       * assert(pii.use_count() == 2);</span></span><br><span class="line"><span class="comment">       * @endcode</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r, element_type* __p) <span class="keyword">noexcept</span></span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(__r, __p) { }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201703L</span></span><br><span class="line">      <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">      <span class="comment">// 2996. Missing rvalue overloads for shared_ptr operations</span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Constructs a `shared_ptr` instance that stores `__p`</span></span><br><span class="line"><span class="comment">       *          and shares ownership with `__r`.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A `shared_ptr`.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer that will remain valid while `*__r` is valid.</span></span><br><span class="line"><span class="comment">       *  @post   `get() == __p &amp;&amp; !__r.use_count() &amp;&amp; !__r.get()`</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  This can be used to construct a `shared_ptr` to a sub-object</span></span><br><span class="line"><span class="comment">       *  of an object managed by an existing `shared_ptr`. The complete</span></span><br><span class="line"><span class="comment">       *  object will remain valid while any `shared_ptr` owns it, even</span></span><br><span class="line"><span class="comment">       *  if they don&#x27;t store a pointer to the complete object.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * @code</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;pair&lt;int,int&gt;&gt; pii(new pair&lt;int,int&gt;());</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;int&gt; pi1(pii, &amp;pii-&gt;first);</span></span><br><span class="line"><span class="comment">       * assert(pii.use_count() == 2);</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;int&gt; pi2(std::move(pii), &amp;pii-&gt;second);</span></span><br><span class="line"><span class="comment">       * assert(pii.use_count() == 0);</span></span><br><span class="line"><span class="comment">       * @endcode</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(shared_ptr&lt;_Yp&gt;&amp;&amp; __r, element_type* __p) <span class="keyword">noexcept</span></span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r), __p) { }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  If @a __r is empty, constructs an empty %shared_ptr;</span></span><br><span class="line"><span class="comment">       *          otherwise construct a %shared_ptr that shares ownership</span></span><br><span class="line"><span class="comment">       *          with @a __r.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A %shared_ptr.</span></span><br><span class="line"><span class="comment">       *  @post   get() == __r.get() &amp;&amp; use_count() == __r.use_count()</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp;&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">        : __shared_ptr&lt;_Tp&gt;(__r) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Move-constructs a %shared_ptr instance from @a __r.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A %shared_ptr rvalue.</span></span><br><span class="line"><span class="comment">       *  @post   *this contains the old value of @a __r, @a __r is empty.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="built_in">shared_ptr</span>(shared_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Move-constructs a %shared_ptr instance from @a __r.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A %shared_ptr rvalue.</span></span><br><span class="line"><span class="comment">       *  @post   *this contains the old value of @a __r, @a __r is empty.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;shared_ptr&lt;_Yp&gt;&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(shared_ptr&lt;_Yp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Constructs a %shared_ptr that shares ownership with @a __r</span></span><br><span class="line"><span class="comment">       *          and stores a copy of the pointer stored in @a __r.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A weak_ptr.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == __r.use_count()</span></span><br><span class="line"><span class="comment">       *  @throw  bad_weak_ptr when __r.expired(),</span></span><br><span class="line"><span class="comment">       *          in which case the constructor has no effect.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp;&gt;&gt;</span><br><span class="line">	<span class="keyword">explicit</span> <span class="built_in">shared_ptr</span>(<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp; __r)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(__r) { }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;auto_ptr&lt;_Yp&gt;&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(auto_ptr&lt;_Yp&gt;&amp;&amp; __r);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">      <span class="comment">// 2399. shared_ptr&#x27;s constructor from unique_ptr should be constrained</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;unique_ptr&lt;_Yp, _Del&gt;&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r)) { }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &lt;= 201402L &amp;&amp; _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line">      <span class="comment">// This non-standard constructor exists to support conversions that</span></span><br><span class="line">      <span class="comment">// were possible in C++11 and C++14 but are ill-formed in C++17.</span></span><br><span class="line">      <span class="comment">// If an exception is thrown this constructor has no effect.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del,</span><br><span class="line">		_Constructible&lt;unique_ptr&lt;_Yp, _Del&gt;, __sp_array_delete&gt;* = <span class="number">0</span>&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r), __sp_array_delete()) { }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct an empty %shared_ptr.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 0 &amp;&amp; get() == nullptr</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">constexpr</span> <span class="built_in">shared_ptr</span>(<span class="type">nullptr_t</span>) <span class="keyword">noexcept</span> : <span class="built_in">shared_ptr</span>() { }</span><br><span class="line"></span><br><span class="line">      shared_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(__r);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;auto_ptr&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(auto_ptr&lt;_Yp&gt;&amp;&amp; __r)</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      shared_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(shared_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">_Yp</span>&gt;</span><br><span class="line">	_Assignable&lt;shared_ptr&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(shared_ptr&lt;_Yp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del&gt;</span><br><span class="line">	_Assignable&lt;unique_ptr&lt;_Yp, _Del&gt;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="comment">// This constructor is non-standard, it is used by allocate_shared.</span></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function">	<span class="title">shared_ptr</span><span class="params">(_Sp_alloc_shared_tag&lt;_Alloc&gt; __tag, _Args&amp;&amp;... __args)</span></span></span><br><span class="line"><span class="function">	: __shared_ptr&lt;_Tp&gt;(__tag, std::forward&lt;_Args&gt;(__args)...)</span></span><br><span class="line"><span class="function">	{</span> }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">friend</span> shared_ptr&lt;_Yp&gt;</span></span><br><span class="line"><span class="function">	<span class="title">allocate_shared</span><span class="params">(<span class="type">const</span> _Alloc&amp; __a, _Args&amp;&amp;... __args)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This constructor is non-standard, it is used by weak_ptr::lock().</span></span><br><span class="line">      <span class="built_in">shared_ptr</span>(<span class="type">const</span> weak_ptr&lt;_Tp&gt;&amp; __r, std::<span class="type">nothrow_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">      : __shared_ptr&lt;_Tp&gt;(__r, std::nothrow) { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">weak_ptr</span>&lt;_Tp&gt;;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_deduction_guides &gt;= 201606</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">shared_ptr</span><span class="params">(weak_ptr&lt;_Tp&gt;)</span> -&gt;  shared_ptr&lt;_Tp&gt;</span>;</span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Del&gt;</span></span><br><span class="line"><span class="function">    <span class="title">shared_ptr</span><span class="params">(unique_ptr&lt;_Tp, _Del&gt;)</span> -&gt;  shared_ptr&lt;_Tp&gt;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.7 shared_ptr comparisons</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @relates shared_ptr @{</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Equality operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a.<span class="built_in">get</span>() == __b.<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !__a; }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cpp_lib_three_way_comparison</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    <span class="keyword">inline</span> strong_ordering</span><br><span class="line">    <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a,</span><br><span class="line">		<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> <span class="built_in">compare_three_way</span>()(__a.<span class="built_in">get</span>(), __b.<span class="built_in">get</span>()); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">inline</span> strong_ordering</span><br><span class="line">    <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> pointer = <span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type*;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">compare_three_way</span>()(__a.<span class="built_in">get</span>(), <span class="built_in">static_cast</span>&lt;pointer&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !__a; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Inequality operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a.<span class="built_in">get</span>() != __b.<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="built_in">return</span> (<span class="type">bool</span>)__a; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="built_in">return</span> (<span class="type">bool</span>)__a; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Relational operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type;</span><br><span class="line">      <span class="keyword">using</span> _Up_elt = <span class="keyword">typename</span> shared_ptr&lt;_Up&gt;::element_type;</span><br><span class="line">      <span class="keyword">using</span> _Vp = <span class="keyword">typename</span> common_type&lt;_Tp_elt*, _Up_elt*&gt;::type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Vp&gt;()(__a.<span class="built_in">get</span>(), __b.<span class="built_in">get</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Tp_elt*&gt;()(__a.<span class="built_in">get</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Tp_elt*&gt;()(<span class="literal">nullptr</span>, __a.<span class="built_in">get</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Relational operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__b &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(<span class="literal">nullptr</span> &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; <span class="literal">nullptr</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Relational operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> (__b &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> <span class="literal">nullptr</span> &lt; __a; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a &lt; <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Relational operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; __b); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; <span class="literal">nullptr</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(<span class="literal">nullptr</span> &lt; __a); }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.8 shared_ptr specialized algorithms.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Swap overload for shared_ptr</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">swap</span><span class="params">(shared_ptr&lt;_Tp&gt;&amp; __a, shared_ptr&lt;_Tp&gt;&amp; __b)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{ __a.<span class="built_in">swap</span>(__b); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.9 shared_ptr casts.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr`, via `static_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">static_pointer_cast</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">static_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr`, via `const_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">const_pointer_cast</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">const_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr`, via `dynamic_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">dynamic_pointer_cast</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span>* __p = <span class="built_in">dynamic_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()))</span><br><span class="line">	<span class="keyword">return</span> _Sp(__r, __p);</span><br><span class="line">      <span class="keyword">return</span> _Sp();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt;= 201703L</span></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr`, via `reinterpret_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">reinterpret_pointer_cast</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201703L</span></span><br><span class="line">  <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">  <span class="comment">// 2996. Missing rvalue overloads for shared_ptr operations</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr` rvalue, via `static_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">static_pointer_cast</span><span class="params">(shared_ptr&lt;_Up&gt;&amp;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(std::<span class="built_in">move</span>(__r),</span><br><span class="line">		 <span class="built_in">static_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr` rvalue, via `const_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">const_pointer_cast</span><span class="params">(shared_ptr&lt;_Up&gt;&amp;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(std::<span class="built_in">move</span>(__r),</span><br><span class="line">		 <span class="built_in">const_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr` rvalue, via `dynamic_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">dynamic_pointer_cast</span><span class="params">(shared_ptr&lt;_Up&gt;&amp;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span>* __p = <span class="built_in">dynamic_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()))</span><br><span class="line">	<span class="keyword">return</span> _Sp(std::<span class="built_in">move</span>(__r), __p);</span><br><span class="line">      <span class="keyword">return</span> _Sp();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr` rvalue, via `reinterpret_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">reinterpret_pointer_cast</span><span class="params">(shared_ptr&lt;_Up&gt;&amp;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(std::<span class="built_in">move</span>(__r),</span><br><span class="line">		 <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// C++20</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// C++17</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @brief  A non-owning observer for a pointer owned by a shared_ptr</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * A weak_ptr provides a safe alternative to a raw pointer when you want</span></span><br><span class="line"><span class="comment">   * a non-owning reference to an object that is managed by a shared_ptr.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Unlike a raw pointer, a weak_ptr can be converted to a new shared_ptr</span></span><br><span class="line"><span class="comment">   * that shares ownership with every other shared_ptr that already owns</span></span><br><span class="line"><span class="comment">   * the pointer. In other words you can upgrade from a non-owning &quot;weak&quot;</span></span><br><span class="line"><span class="comment">   * reference to an owning shared_ptr, without having access to any of</span></span><br><span class="line"><span class="comment">   * the existing shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Also unlike a raw pointer, a weak_ptr does not become &quot;dangling&quot; after</span></span><br><span class="line"><span class="comment">   * the object it points to has been destroyed. Instead, a weak_ptr</span></span><br><span class="line"><span class="comment">   * becomes _expired_ and can no longer be converted to a shared_ptr that</span></span><br><span class="line"><span class="comment">   * owns the freed pointer, so you cannot accidentally access the pointed-to</span></span><br><span class="line"><span class="comment">   * object after it has been destroyed.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">weak_ptr</span> : <span class="keyword">public</span> __weak_ptr&lt;_Tp&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Arg&gt;</span><br><span class="line">	<span class="keyword">using</span> _Constructible = <span class="keyword">typename</span> enable_if&lt;</span><br><span class="line">	  is_constructible&lt;__weak_ptr&lt;_Tp&gt;, _Arg&gt;::value</span><br><span class="line">	&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Arg&gt;</span><br><span class="line">	<span class="keyword">using</span> _Assignable = <span class="keyword">typename</span> enable_if&lt;</span><br><span class="line">	  is_assignable&lt;__weak_ptr&lt;_Tp&gt;&amp;, _Arg&gt;::value, weak_ptr&amp;</span><br><span class="line">	&gt;::type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="function"><span class="keyword">constexpr</span> <span class="title">weak_ptr</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>= <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp;&gt;&gt;</span><br><span class="line">	<span class="built_in">weak_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: __weak_ptr&lt;_Tp&gt;(__r) { }</span><br><span class="line"></span><br><span class="line">      <span class="built_in">weak_ptr</span>(<span class="type">const</span> weak_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp;&gt;&gt;</span><br><span class="line">	<span class="built_in">weak_ptr</span>(<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: __weak_ptr&lt;_Tp&gt;(__r) { }</span><br><span class="line"></span><br><span class="line">      <span class="built_in">weak_ptr</span>(weak_ptr&amp;&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;weak_ptr&lt;_Yp&gt;&gt;&gt;</span><br><span class="line">	<span class="built_in">weak_ptr</span>(weak_ptr&lt;_Yp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: __weak_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r)) { }</span><br><span class="line"></span><br><span class="line">      weak_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> weak_ptr&amp; __r) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__weak_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(__r);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__weak_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(__r);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      weak_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(weak_ptr&amp;&amp; __r) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;weak_ptr&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(weak_ptr&lt;_Yp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__weak_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="function">shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">lock</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;_Tp&gt;(*<span class="keyword">this</span>, std::nothrow); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_deduction_guides &gt;= 201606</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">weak_ptr</span><span class="params">(shared_ptr&lt;_Tp&gt;)</span> -&gt;  weak_ptr&lt;_Tp&gt;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.3.6 weak_ptr specialized algorithms.</span></span><br><span class="line">  <span class="comment">/// Swap overload for weak_ptr</span></span><br><span class="line">  <span class="comment">/// @relates weak_ptr</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">swap</span><span class="params">(weak_ptr&lt;_Tp&gt;&amp; __a, weak_ptr&lt;_Tp&gt;&amp; __b)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{ __a.<span class="built_in">swap</span>(__b); }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Primary template owner_less</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp = <span class="type">void</span>&gt;</span><br><span class="line">    <span class="keyword">struct</span> owner_less;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Void specialization of owner_less compares either shared_ptr or weak_ptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;<span class="type">void</span>&gt; : _Sp_owner_less&lt;<span class="type">void</span>, <span class="type">void</span>&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Partial specialization of owner_less for shared_ptr.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> _Sp_owner_less&lt;shared_ptr&lt;_Tp&gt;, weak_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Partial specialization of owner_less for weak_ptr.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;weak_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> _Sp_owner_less&lt;weak_ptr&lt;_Tp&gt;, shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief Base class allowing use of member function shared_from_this.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">enable_shared_from_this</span></span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="function"><span class="keyword">constexpr</span> <span class="title">enable_shared_from_this</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>{ }</span><br><span class="line"></span><br><span class="line">      <span class="built_in">enable_shared_from_this</span>(<span class="type">const</span> enable_shared_from_this&amp;) <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      enable_shared_from_this&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> enable_shared_from_this&amp;) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> *<span class="keyword">this</span>; }</span><br><span class="line"></span><br><span class="line">      ~<span class="built_in">enable_shared_from_this</span>() { }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="function">shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">shared_from_this</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;_Tp&gt;(<span class="keyword">this</span>-&gt;_M_weak_this); }</span><br><span class="line"></span><br><span class="line">      <span class="function">shared_ptr&lt;<span class="type">const</span> _Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">shared_from_this</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;<span class="type">const</span> _Tp&gt;(<span class="keyword">this</span>-&gt;_M_weak_this); }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201402L || !defined(__STRICT_ANSI__) <span class="comment">// c++1z or gnu++11</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __cpp_lib_enable_shared_from_this 201603</span></span><br><span class="line">      <span class="function">weak_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">weak_from_this</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_weak_this; }</span><br><span class="line"></span><br><span class="line">      <span class="function">weak_ptr&lt;<span class="type">const</span> _Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">weak_from_this</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_weak_this; }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span><br><span class="line">	<span class="type">void</span></span><br><span class="line">	_M_weak_assign(_Tp1* __p, <span class="type">const</span> __shared_count&lt;&gt;&amp; __n) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">	{ _M_weak_this._M_assign(__p, __n); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Found by ADL when this is an associated class.</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="type">const</span> enable_shared_from_this*</span><br><span class="line">      __enable_shared_from_this_base(<span class="type">const</span> __shared_count&lt;&gt;&amp;,</span><br><span class="line">				     <span class="type">const</span> enable_shared_from_this* __p)</span><br><span class="line">      { <span class="keyword">return</span> __p; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span>, _Lock_policy&gt;</span><br><span class="line">	<span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_ptr</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">mutable</span> weak_ptr&lt;_Tp&gt;  _M_weak_this;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @relates shared_ptr @{</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Create an object that is owned by a shared_ptr.</span></span><br><span class="line"><span class="comment">   *  @param  __a     An allocator.</span></span><br><span class="line"><span class="comment">   *  @param  __args  Arguments for the @a _Tp object&#x27;s constructor.</span></span><br><span class="line"><span class="comment">   *  @return A shared_ptr that owns the newly created object.</span></span><br><span class="line"><span class="comment">   *  @throw  An exception thrown from @a _Alloc::allocate or from the</span></span><br><span class="line"><span class="comment">   *          constructor of @a _Tp.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  A copy of @a __a will be used to allocate memory for the shared_ptr</span></span><br><span class="line"><span class="comment">   *  and the new object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">allocate_shared</span><span class="params">(<span class="type">const</span> _Alloc&amp; __a, _Args&amp;&amp;... __args)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="built_in">static_assert</span>(!is_array&lt;_Tp&gt;::value, <span class="string">&quot;make_shared&lt;T[]&gt; not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;_Tp&gt;(_Sp_alloc_shared_tag&lt;_Alloc&gt;{__a},</span><br><span class="line">			     std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Create an object that is owned by a shared_ptr.</span></span><br><span class="line"><span class="comment">   *  @param  __args  Arguments for the @a _Tp object&#x27;s constructor.</span></span><br><span class="line"><span class="comment">   *  @return A shared_ptr that owns the newly created object.</span></span><br><span class="line"><span class="comment">   *  @throw  std::bad_alloc, or an exception thrown from the</span></span><br><span class="line"><span class="comment">   *          constructor of @a _Tp.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">make_shared</span><span class="params">(_Args&amp;&amp;... __args)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> std::remove_cv&lt;_Tp&gt;::type _Tp_nc;</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">allocate_shared</span>&lt;_Tp&gt;(std::<span class="built_in">allocator</span>&lt;_Tp_nc&gt;(),</span><br><span class="line">				       std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// std::hash specialization for shared_ptr.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">hash</span>&lt;shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> __hash_base&lt;<span class="type">size_t</span>, shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="function"><span class="type">size_t</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __s)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">	<span class="keyword">return</span> std::hash&lt;<span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type*&gt;()(__s.<span class="built_in">get</span>());</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @} relates shared_ptr</span></span><br><span class="line">  <span class="comment">/// @} group pointer_abstractions</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt;= 201703L</span></span><br><span class="line">  <span class="keyword">namespace</span> __detail::__variant</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span>&gt; <span class="keyword">struct</span> <span class="title class_">_Never_valueless_alt</span>; <span class="comment">// see &lt;variant&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Provide the strong exception-safety guarantee when emplacing a</span></span><br><span class="line">    <span class="comment">// shared_ptr into a variant.</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">_Never_valueless_alt</span>&lt;std::shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">      : std::true_type</span><br><span class="line">      { };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Provide the strong exception-safety guarantee when emplacing a</span></span><br><span class="line">    <span class="comment">// weak_ptr into a variant.</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">_Never_valueless_alt</span>&lt;std::weak_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">      : std::true_type</span><br><span class="line">      { };</span><br><span class="line">  }  <span class="comment">// namespace __detail::__variant</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// C++17</span></span></span><br><span class="line"></span><br><span class="line">_GLIBCXX_END_NAMESPACE_VERSION</span><br><span class="line">} <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _SHARED_PTR_H</span></span></span><br></pre></td></tr></table></figure>
</details>

<details>
<summary>shared_ptr_base.h</summary>
<figure class="highlight cpp"><figcaption><span>shared_ptr_base.h</span><a href="/blog/downloads/code/shared_ptr/shared_ptr_base.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr and weak_ptr implementation details -*- C++ -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Copyright (C) 2007-2021 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file is part of the GNU ISO C++ Library.  This library is free</span></span><br><span class="line"><span class="comment">// software; you can redistribute it and/or modify it under the</span></span><br><span class="line"><span class="comment">// terms of the GNU General Public License as published by the</span></span><br><span class="line"><span class="comment">// Free Software Foundation; either version 3, or (at your option)</span></span><br><span class="line"><span class="comment">// any later version.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This library is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">// GNU General Public License for more details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Under Section 7 of GPL version 3, you are granted additional</span></span><br><span class="line"><span class="comment">// permissions described in the GCC Runtime Library Exception, version</span></span><br><span class="line"><span class="comment">// 3.1, as published by the Free Software Foundation.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You should have received a copy of the GNU General Public License and</span></span><br><span class="line"><span class="comment">// a copy of the GCC Runtime Library Exception along with this program;</span></span><br><span class="line"><span class="comment">// see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see</span></span><br><span class="line"><span class="comment">// &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// GCC Note: Based on files from version 1.32.0 of the Boost library.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  shared_count.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (c) 2001, 2002, 2003 Peter Dimov and Multi Media Ltd.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  shared_ptr.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 1998, 1999 Greg Colvin and Beman Dawes.</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2001, 2002, 2003 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  weak_ptr.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2001, 2002, 2003 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  enable_shared_from_this.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2002 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Distributed under the Boost Software License, Version 1.0. (See</span></span><br><span class="line"><span class="comment">// accompanying file LICENSE_1_0.txt or copy at</span></span><br><span class="line"><span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** @file bits/shared_ptr_base.h</span></span><br><span class="line"><span class="comment"> *  This is an internal header file, included by other library headers.</span></span><br><span class="line"><span class="comment"> *  Do not attempt to use it directly. @headername{memory}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SHARED_PTR_BASE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SHARED_PTR_BASE_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/allocated_ptr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/allocator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/exception_defines.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/functional_hash.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/refwrap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stl_function.h&gt;</span>  <span class="comment">// std::less</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/unique_ptr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ext/aligned_buffer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ext/atomicity.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ext/concurrence.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201703L</span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;compare&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> std _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">{</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span>&gt; <span class="keyword">class</span> <span class="title class_">auto_ptr</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Exception possibly thrown by @c shared_ptr.</span></span><br><span class="line"><span class="comment">   *  @ingroup exceptions</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">bad_weak_ptr</span> : <span class="keyword">public</span> std::exception</span><br><span class="line">  {</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">char</span> <span class="type">const</span>* <span class="title">what</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">bad_weak_ptr</span>() <span class="keyword">noexcept</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Substitute for bad_weak_ptr object in the case of -fno-exceptions.</span></span><br><span class="line">  <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">  __throw_bad_weak_ptr()</span><br><span class="line">  { _GLIBCXX_THROW_OR_ABORT(<span class="built_in">bad_weak_ptr</span>()); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::_Lock_policy;</span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::__default_lock_policy;</span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::_S_single;</span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::_S_mutex;</span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::_S_atomic;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Empty helper class except when the template argument is _S_mutex.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Mutex_base</span></span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="comment">// The atomic policy uses fully-fenced builtins, single doesn&#x27;t care.</span></span><br><span class="line">      <span class="keyword">enum</span> { _S_need_barriers = <span class="number">0</span> };</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Mutex_base</span>&lt;_S_mutex&gt;</span><br><span class="line">    : <span class="keyword">public</span> __gnu_cxx::__mutex</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="comment">// This policy is used when atomic builtins are not available.</span></span><br><span class="line">      <span class="comment">// The replacement atomic operations might not have the necessary</span></span><br><span class="line">      <span class="comment">// memory barriers.</span></span><br><span class="line">      <span class="keyword">enum</span> { _S_need_barriers = <span class="number">1</span> };</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> _Sp_counted_base</span><br><span class="line">    : <span class="keyword">public</span> _Mutex_base&lt;_Lp&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      _Sp_counted_base() <span class="keyword">noexcept</span></span><br><span class="line">      : _M_use_count(<span class="number">1</span>), _M_weak_count(<span class="number">1</span>) { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span></span><br><span class="line">      ~_Sp_counted_base() <span class="keyword">noexcept</span></span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Called when _M_use_count drops to zero, to release the resources</span></span><br><span class="line">      <span class="comment">// managed by *this.</span></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_dispose() <span class="keyword">noexcept</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Called when _M_weak_count drops to zero.</span></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_destroy() <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">delete</span> <span class="keyword">this</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp;) <span class="keyword">noexcept</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_add_ref_copy()</span><br><span class="line">      { __gnu_cxx::__atomic_add_dispatch(&amp;_M_use_count, <span class="number">1</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_add_ref_lock()</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (!_M_add_ref_lock_nothrow())</span><br><span class="line">	  __throw_bad_weak_ptr();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_add_ref_lock_nothrow() <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_release() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">        <span class="comment">// Be race-detector-friendly.  For more info see bits/c++config.</span></span><br><span class="line">        _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_use_count);</span><br><span class="line">	<span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_use_count, <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">	  {</span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_use_count);</span><br><span class="line">	    _M_dispose();</span><br><span class="line">	    <span class="comment">// There must be a memory barrier between dispose() and destroy()</span></span><br><span class="line">	    <span class="comment">// to ensure that the effects of dispose() are observed in the</span></span><br><span class="line">	    <span class="comment">// thread that runs destroy().</span></span><br><span class="line">	    <span class="comment">// See http://gcc.gnu.org/ml/libstdc++/2005-11/msg00136.html</span></span><br><span class="line">	    <span class="keyword">if</span> (_Mutex_base&lt;_Lp&gt;::_S_need_barriers)</span><br><span class="line">	      {</span><br><span class="line">		__atomic_thread_fence (__ATOMIC_ACQ_REL);</span><br><span class="line">	      }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Be race-detector-friendly.  For more info see bits/c++config.</span></span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_weak_count);</span><br><span class="line">	    <span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_weak_count,</span><br><span class="line">						       <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">              {</span><br><span class="line">                _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_weak_count);</span><br><span class="line">	        _M_destroy();</span><br><span class="line">              }</span><br><span class="line">	  }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_weak_add_ref() <span class="keyword">noexcept</span></span><br><span class="line">      { __gnu_cxx::__atomic_add_dispatch(&amp;_M_weak_count, <span class="number">1</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_weak_release() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">        <span class="comment">// Be race-detector-friendly. For more info see bits/c++config.</span></span><br><span class="line">        _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_weak_count);</span><br><span class="line">	<span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_weak_count, <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">	  {</span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_weak_count);</span><br><span class="line">	    <span class="keyword">if</span> (_Mutex_base&lt;_Lp&gt;::_S_need_barriers)</span><br><span class="line">	      {</span><br><span class="line">	        <span class="comment">// See _M_release(),</span></span><br><span class="line">	        <span class="comment">// destroy() must observe results of dispose()</span></span><br><span class="line">		__atomic_thread_fence (__ATOMIC_ACQ_REL);</span><br><span class="line">	      }</span><br><span class="line">	    _M_destroy();</span><br><span class="line">	  }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span></span><br><span class="line">      _M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">        <span class="comment">// No memory barrier is used here so there is no synchronization</span></span><br><span class="line">        <span class="comment">// with other threads.</span></span><br><span class="line">        <span class="keyword">return</span> __atomic_load_n(&amp;_M_use_count, __ATOMIC_RELAXED);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Sp_counted_base(_Sp_counted_base <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">      _Sp_counted_base&amp; <span class="keyword">operator</span>=(_Sp_counted_base <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">      _Atomic_word  _M_use_count;     <span class="comment">// #shared</span></span><br><span class="line">      _Atomic_word  _M_weak_count;    <span class="comment">// #weak + (#shared != 0)</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::</span><br><span class="line">    _M_add_ref_lock_nothrow() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (_M_use_count == <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      ++_M_use_count;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    _Sp_counted_base&lt;_S_mutex&gt;::</span><br><span class="line">    _M_add_ref_lock_nothrow() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="function">__gnu_cxx::__scoped_lock <span class="title">sentry</span><span class="params">(*<span class="keyword">this</span>)</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_use_count, <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">	  _M_use_count = <span class="number">0</span>;</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    _Sp_counted_base&lt;_S_atomic&gt;::</span><br><span class="line">    _M_add_ref_lock_nothrow() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="comment">// Perform lock-free add-if-not-zero operation.</span></span><br><span class="line">      _Atomic_word __count = _M_get_use_count();</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">if</span> (__count == <span class="number">0</span>)</span><br><span class="line">	    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	  <span class="comment">// Replace the current counter value with the old value + 1, as</span></span><br><span class="line">	  <span class="comment">// long as it&#x27;s not changed meanwhile.</span></span><br><span class="line">	}</span><br><span class="line">      <span class="keyword">while</span> (!__atomic_compare_exchange_n(&amp;_M_use_count, &amp;__count, __count + <span class="number">1</span>,</span><br><span class="line">					  <span class="literal">true</span>, __ATOMIC_ACQ_REL,</span><br><span class="line">					  __ATOMIC_RELAXED));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_add_ref_copy()</span><br><span class="line">    { ++_M_use_count; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_release() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (--_M_use_count == <span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">          _M_dispose();</span><br><span class="line">          <span class="keyword">if</span> (--_M_weak_count == <span class="number">0</span>)</span><br><span class="line">            _M_destroy();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_weak_add_ref() <span class="keyword">noexcept</span></span><br><span class="line">    { ++_M_weak_count; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_weak_release() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (--_M_weak_count == <span class="number">0</span>)</span><br><span class="line">        _M_destroy();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">long</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> _M_use_count; }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Forward declarations.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __shared_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __weak_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __enable_shared_from_this;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">shared_ptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">weak_ptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">enable_shared_from_this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __weak_count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __shared_count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Counted ptr with no deleter or allocator support</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Sp_counted_ptr</span> <span class="keyword">final</span> : <span class="keyword">public</span> _Sp_counted_base&lt;_Lp&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">explicit</span></span><br><span class="line">      _Sp_counted_ptr(_Ptr __p) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(__p) { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_dispose() <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">delete</span> _M_ptr; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_destroy() <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">delete</span> <span class="keyword">this</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp;) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      _Sp_counted_ptr(<span class="type">const</span> _Sp_counted_ptr&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">      _Sp_counted_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> _Sp_counted_ptr&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Ptr             _M_ptr;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_ptr&lt;<span class="type">nullptr_t</span>, _S_single&gt;::_M_dispose() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_ptr&lt;<span class="type">nullptr_t</span>, _S_mutex&gt;::_M_dispose() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_ptr&lt;<span class="type">nullptr_t</span>, _S_atomic&gt;::_M_dispose() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="type">int</span> _Nm, <span class="keyword">typename</span> _Tp,</span><br><span class="line">	   <span class="type">bool</span> __use_ebo = !__is_final(_Tp) &amp;&amp; __is_empty(_Tp)&gt;</span><br><span class="line">    <span class="keyword">struct</span> _Sp_ebo_helper;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Specialization using EBO.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="type">int</span> _Nm, <span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_ebo_helper</span>&lt;_Nm, _Tp, <span class="literal">true</span>&gt; : <span class="keyword">private</span> _Tp</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">explicit</span> _Sp_ebo_helper(<span class="type">const</span> _Tp&amp; __tp) : _Tp(__tp) { }</span><br><span class="line">      <span class="keyword">explicit</span> _Sp_ebo_helper(_Tp&amp;&amp; __tp) : _Tp(std::<span class="built_in">move</span>(__tp)) { }</span><br><span class="line"></span><br><span class="line">      <span class="type">static</span> _Tp&amp;</span><br><span class="line">      _S_get(_Sp_ebo_helper&amp; __eboh) { <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;_Tp&amp;&gt;(__eboh); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Specialization not using EBO.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="type">int</span> _Nm, <span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_ebo_helper</span>&lt;_Nm, _Tp, <span class="literal">false</span>&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">explicit</span> _Sp_ebo_helper(<span class="type">const</span> _Tp&amp; __tp) : _M_tp(__tp) { }</span><br><span class="line">      <span class="keyword">explicit</span> _Sp_ebo_helper(_Tp&amp;&amp; __tp) : _M_tp(std::<span class="built_in">move</span>(__tp)) { }</span><br><span class="line"></span><br><span class="line">      <span class="type">static</span> _Tp&amp;</span><br><span class="line">      _S_get(_Sp_ebo_helper&amp; __eboh)</span><br><span class="line">      { <span class="keyword">return</span> __eboh._M_tp; }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Tp _M_tp;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Support for custom deleter and/or allocator</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Sp_counted_deleter</span> <span class="keyword">final</span> : <span class="keyword">public</span> _Sp_counted_base&lt;_Lp&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">class</span> <span class="title class_">_Impl</span> : _Sp_ebo_helper&lt;<span class="number">0</span>, _Deleter&gt;, _Sp_ebo_helper&lt;<span class="number">1</span>, _Alloc&gt;</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">typedef</span> _Sp_ebo_helper&lt;<span class="number">0</span>, _Deleter&gt;	_Del_base;</span><br><span class="line">	<span class="keyword">typedef</span> _Sp_ebo_helper&lt;<span class="number">1</span>, _Alloc&gt;	_Alloc_base;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span>:</span><br><span class="line">	_Impl(_Ptr __p, _Deleter __d, <span class="type">const</span> _Alloc&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">	: _Del_base(std::<span class="built_in">move</span>(__d)), _Alloc_base(__a), _M_ptr(__p)</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">	_Deleter&amp; _M_del() <span class="keyword">noexcept</span> { <span class="keyword">return</span> _Del_base::_S_get(*<span class="keyword">this</span>); }</span><br><span class="line">	_Alloc&amp; _M_alloc() <span class="keyword">noexcept</span> { <span class="keyword">return</span> _Alloc_base::_S_get(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">	_Ptr _M_ptr;</span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> __allocator_type = __alloc_rebind&lt;_Alloc, _Sp_counted_deleter&gt;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// __d(__p) must not throw.</span></span><br><span class="line">      _Sp_counted_deleter(_Ptr __p, _Deleter __d) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_impl(__p, std::<span class="built_in">move</span>(__d), _Alloc()) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// __d(__p) must not throw.</span></span><br><span class="line">      _Sp_counted_deleter(_Ptr __p, _Deleter __d, <span class="type">const</span> _Alloc&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_impl(__p, std::<span class="built_in">move</span>(__d), __a) { }</span><br><span class="line"></span><br><span class="line">      ~_Sp_counted_deleter() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_dispose() <span class="keyword">noexcept</span></span><br><span class="line">      { _M_impl._M_del()(_M_impl._M_ptr); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_destroy() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__allocator_type __a(_M_impl._M_alloc());</span><br><span class="line">	__allocated_ptr&lt;__allocator_type&gt; __guard_ptr{ __a, <span class="keyword">this</span> };</span><br><span class="line">	<span class="keyword">this</span>-&gt;~_Sp_counted_deleter();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> type_info&amp; __ti [[__gnu__::__unused__]]) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_rtti</span></span><br><span class="line">	<span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">	<span class="comment">// 2400. shared_ptr&#x27;s get_deleter() should use addressof()</span></span><br><span class="line">        <span class="keyword">return</span> __ti == <span class="built_in">typeid</span>(_Deleter)</span><br><span class="line">	  ? std::__addressof(_M_impl._M_del())</span><br><span class="line">	  : <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Impl _M_impl;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// helpers for make_shared / allocate_shared</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_Sp_make_shared_tag</span></span><br><span class="line">  {</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, _Lock_policy _Lp&gt;</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">_Sp_counted_ptr_inplace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> type_info&amp;</span><br><span class="line">    _S_ti() <span class="keyword">noexcept</span> _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">alignas</span>(type_info) <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">char</span> __tag[<span class="built_in">sizeof</span>(type_info)] = { };</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> type_info&amp;&gt;(__tag);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> _S_eq(<span class="type">const</span> type_info&amp;) <span class="keyword">noexcept</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_alloc_shared_tag</span></span><br><span class="line">    {</span><br><span class="line">      <span class="type">const</span> _Alloc&amp; _M_a;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Sp_counted_ptr_inplace</span> <span class="keyword">final</span> : <span class="keyword">public</span> _Sp_counted_base&lt;_Lp&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">class</span> <span class="title class_">_Impl</span> : _Sp_ebo_helper&lt;<span class="number">0</span>, _Alloc&gt;</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">typedef</span> _Sp_ebo_helper&lt;<span class="number">0</span>, _Alloc&gt;	_A_base;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">explicit</span> _Impl(_Alloc __a) <span class="keyword">noexcept</span> : _A_base(__a) { }</span><br><span class="line"></span><br><span class="line">	_Alloc&amp; _M_alloc() <span class="keyword">noexcept</span> { <span class="keyword">return</span> _A_base::_S_get(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">	__gnu_cxx::__aligned_buffer&lt;_Tp&gt; _M_storage;</span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> __allocator_type = __alloc_rebind&lt;_Alloc, _Sp_counted_ptr_inplace&gt;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Alloc parameter is not a reference so doesn&#x27;t alias anything in __args</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	_Sp_counted_ptr_inplace(_Alloc __a, _Args&amp;&amp;... __args)</span><br><span class="line">	: _M_impl(__a)</span><br><span class="line">	{</span><br><span class="line">	  <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">	  <span class="comment">// 2070.  allocate_shared should use allocator_traits&lt;A&gt;::construct</span></span><br><span class="line">	  allocator_traits&lt;_Alloc&gt;::<span class="built_in">construct</span>(__a, _M_ptr(),</span><br><span class="line">	      std::forward&lt;_Args&gt;(__args)...); <span class="comment">// might throw</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      ~_Sp_counted_ptr_inplace() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_dispose() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	allocator_traits&lt;_Alloc&gt;::<span class="built_in">destroy</span>(_M_impl._M_alloc(), _M_ptr());</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Override because the allocator needs to know the dynamic type</span></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_destroy() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__allocator_type __a(_M_impl._M_alloc());</span><br><span class="line">	__allocated_ptr&lt;__allocator_type&gt; __guard_ptr{ __a, <span class="keyword">this</span> };</span><br><span class="line">	<span class="keyword">this</span>-&gt;~_Sp_counted_ptr_inplace();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_count</span>&lt;_Lp&gt;; <span class="comment">// To be able to call _M_ptr().</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// No longer used, but code compiled against old libstdc++ headers</span></span><br><span class="line">      <span class="comment">// might still call it from __shared_ptr ctor to get the pointer out.</span></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp; __ti) <span class="keyword">noexcept</span> <span class="keyword">override</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">auto</span> __ptr = <span class="keyword">const_cast</span>&lt;<span class="keyword">typename</span> remove_cv&lt;_Tp&gt;::type*&gt;(_M_ptr());</span><br><span class="line">	<span class="comment">// Check for the fake type_info first, so we don&#x27;t try to access it</span></span><br><span class="line">	<span class="comment">// as a real type_info object. Otherwise, check if it&#x27;s the real</span></span><br><span class="line">	<span class="comment">// type_info for this class. With RTTI enabled we can check directly,</span></span><br><span class="line">	<span class="comment">// or call a library function to do it.</span></span><br><span class="line">	<span class="keyword">if</span> (&amp;__ti == &amp;_Sp_make_shared_tag::_S_ti()</span><br><span class="line">	    ||</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_rtti</span></span><br><span class="line">	    __ti == <span class="built_in">typeid</span>(_Sp_make_shared_tag)</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	    _Sp_make_shared_tag::_S_eq(__ti)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	   )</span><br><span class="line">	  <span class="keyword">return</span> __ptr;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      _Tp* _M_ptr() <span class="keyword">noexcept</span> { <span class="keyword">return</span> _M_impl._M_storage._M_ptr(); }</span><br><span class="line"></span><br><span class="line">      _Impl _M_impl;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The default deleter for shared_ptr&lt;T[]&gt; and shared_ptr&lt;T[N]&gt;.</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">__sp_array_delete</span></span><br><span class="line">  {</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span></span><br><span class="line"><span class="function">      <span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(_Yp* __p)</span> <span class="type">const</span> </span>{ <span class="keyword">delete</span>[] __p; }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__shared_count</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">__not_alloc_shared_tag</span> { <span class="keyword">using</span> type = <span class="type">void</span>; };</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">__not_alloc_shared_tag</span>&lt;_Sp_alloc_shared_tag&lt;_Tp&gt;&gt; { };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">constexpr</span> __shared_count() <span class="keyword">noexcept</span> : _M_pi(<span class="number">0</span>)</span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr&gt;</span><br><span class="line">        <span class="keyword">explicit</span></span><br><span class="line">	__shared_count(_Ptr __p) : _M_pi(<span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">	  __try</span><br><span class="line">	    {</span><br><span class="line">	      _M_pi = <span class="keyword">new</span> _Sp_counted_ptr&lt;_Ptr, _Lp&gt;(__p);</span><br><span class="line">	    }</span><br><span class="line">	  __catch(...)</span><br><span class="line">	    {</span><br><span class="line">	      <span class="keyword">delete</span> __p;</span><br><span class="line">	      __throw_exception_again;</span><br><span class="line">	    }</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr&gt;</span><br><span class="line">	__shared_count(_Ptr __p, <span class="comment">/* is_array = */</span> false_type)</span><br><span class="line">	: __shared_count(__p)</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr&gt;</span><br><span class="line">	__shared_count(_Ptr __p, <span class="comment">/* is_array = */</span> true_type)</span><br><span class="line">	: __shared_count(__p, __sp_array_delete{}, <span class="built_in">allocator</span>&lt;<span class="type">void</span>&gt;())</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr, <span class="keyword">typename</span> _Deleter,</span><br><span class="line">	       <span class="keyword">typename</span> = <span class="keyword">typename</span> __not_alloc_shared_tag&lt;_Deleter&gt;::type&gt;</span><br><span class="line">	__shared_count(_Ptr __p, _Deleter __d)</span><br><span class="line">	: __shared_count(__p, std::<span class="built_in">move</span>(__d), <span class="built_in">allocator</span>&lt;<span class="type">void</span>&gt;())</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc,</span><br><span class="line">	       <span class="keyword">typename</span> = <span class="keyword">typename</span> __not_alloc_shared_tag&lt;_Deleter&gt;::type&gt;</span><br><span class="line">	__shared_count(_Ptr __p, _Deleter __d, _Alloc __a) : _M_pi(<span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">typedef</span> _Sp_counted_deleter&lt;_Ptr, _Deleter, _Alloc, _Lp&gt; _Sp_cd_type;</span><br><span class="line">	  __try</span><br><span class="line">	    {</span><br><span class="line">	      <span class="keyword">typename</span> _Sp_cd_type::__allocator_type __a2(__a);</span><br><span class="line">	      <span class="keyword">auto</span> __guard = std::__allocate_guarded(__a2);</span><br><span class="line">	      _Sp_cd_type* __mem = __guard.<span class="built_in">get</span>();</span><br><span class="line">	      ::<span class="keyword">new</span> (__mem) _Sp_cd_type(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a));</span><br><span class="line">	      _M_pi = __mem;</span><br><span class="line">	      __guard = <span class="literal">nullptr</span>;</span><br><span class="line">	    }</span><br><span class="line">	  __catch(...)</span><br><span class="line">	    {</span><br><span class="line">	      __d(__p); <span class="comment">// Call _Deleter on __p.</span></span><br><span class="line">	      __throw_exception_again;</span><br><span class="line">	    }</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	__shared_count(_Tp*&amp; __p, _Sp_alloc_shared_tag&lt;_Alloc&gt; __a,</span><br><span class="line">		       _Args&amp;&amp;... __args)</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">typedef</span> _Sp_counted_ptr_inplace&lt;_Tp, _Alloc, _Lp&gt; _Sp_cp_type;</span><br><span class="line">	  <span class="keyword">typename</span> _Sp_cp_type::__allocator_type __a2(__a._M_a);</span><br><span class="line">	  <span class="keyword">auto</span> __guard = std::__allocate_guarded(__a2);</span><br><span class="line">	  _Sp_cp_type* __mem = __guard.<span class="built_in">get</span>();</span><br><span class="line">	  <span class="keyword">auto</span> __pi = ::<span class="built_in">new</span> (__mem)</span><br><span class="line">	    _Sp_cp_type(__a._M_a, std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">	  __guard = <span class="literal">nullptr</span>;</span><br><span class="line">	  _M_pi = __pi;</span><br><span class="line">	  __p = __pi-&gt;_M_ptr();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="comment">// Special case for auto_ptr&lt;_Tp&gt; to provide the strong guarantee.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">        <span class="keyword">explicit</span></span><br><span class="line">	__shared_count(std::auto_ptr&lt;_Tp&gt;&amp;&amp; __r);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Special case for unique_ptr&lt;_Tp,_Del&gt; to provide the strong guarantee.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Del&gt;</span><br><span class="line">        <span class="keyword">explicit</span></span><br><span class="line">	__shared_count(std::unique_ptr&lt;_Tp, _Del&gt;&amp;&amp; __r) : _M_pi(<span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">	  <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">	  <span class="comment">// 2415. Inconsistency between unique_ptr and shared_ptr</span></span><br><span class="line">	  <span class="keyword">if</span> (__r.<span class="built_in">get</span>() == <span class="literal">nullptr</span>)</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">using</span> _Ptr = <span class="keyword">typename</span> unique_ptr&lt;_Tp, _Del&gt;::pointer;</span><br><span class="line">	  <span class="keyword">using</span> _Del2 = <span class="keyword">typename</span> conditional&lt;is_reference&lt;_Del&gt;::value,</span><br><span class="line">	      reference_wrapper&lt;<span class="keyword">typename</span> remove_reference&lt;_Del&gt;::type&gt;,</span><br><span class="line">	      _Del&gt;::type;</span><br><span class="line">	  <span class="keyword">using</span> _Sp_cd_type</span><br><span class="line">	    = _Sp_counted_deleter&lt;_Ptr, _Del2, allocator&lt;<span class="type">void</span>&gt;, _Lp&gt;;</span><br><span class="line">	  <span class="keyword">using</span> _Alloc = allocator&lt;_Sp_cd_type&gt;;</span><br><span class="line">	  <span class="keyword">using</span> _Alloc_traits = allocator_traits&lt;_Alloc&gt;;</span><br><span class="line">	  _Alloc __a;</span><br><span class="line">	  _Sp_cd_type* __mem = _Alloc_traits::<span class="built_in">allocate</span>(__a, <span class="number">1</span>);</span><br><span class="line">	  <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">	  <span class="comment">// 3548. shared_ptr construction from unique_ptr should move</span></span><br><span class="line">	  <span class="comment">// (not copy) the deleter</span></span><br><span class="line">	  _Alloc_traits::<span class="built_in">construct</span>(__a, __mem, __r.<span class="built_in">release</span>(),</span><br><span class="line">				   std::forward&lt;_Del&gt;(__r.<span class="built_in">get_deleter</span>()));</span><br><span class="line">	  _M_pi = __mem;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Throw bad_weak_ptr when __r._M_get_use_count() == 0.</span></span><br><span class="line">      <span class="keyword">explicit</span> __shared_count(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __r);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Does not throw if __r._M_get_use_count() == 0, caller must check.</span></span><br><span class="line">      <span class="keyword">explicit</span></span><br><span class="line">      __shared_count(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __r, std::<span class="type">nothrow_t</span>) <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line">      ~__shared_count() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_release();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __shared_count(<span class="type">const</span> __shared_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_pi(__r._M_pi)</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_add_ref_copy();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __shared_count&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __shared_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	<span class="keyword">if</span> (__tmp != _M_pi)</span><br><span class="line">	  {</span><br><span class="line">	    <span class="keyword">if</span> (__tmp != <span class="literal">nullptr</span>)</span><br><span class="line">	      __tmp-&gt;_M_add_ref_copy();</span><br><span class="line">	    <span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	      _M_pi-&gt;_M_release();</span><br><span class="line">	    _M_pi = __tmp;</span><br><span class="line">	  }</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_swap(__shared_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	__r._M_pi = _M_pi;</span><br><span class="line">	_M_pi = __tmp;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span></span><br><span class="line">      _M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> _M_pi ? _M_pi-&gt;_M_get_use_count() : <span class="number">0</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_unique() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_get_use_count() == <span class="number">1</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp; __ti) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> _M_pi ? _M_pi-&gt;_M_get_deleter(__ti) : <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_less(<span class="type">const</span> __shared_count&amp; __rhs) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> std::less&lt;_Sp_counted_base&lt;_Lp&gt;*&gt;()(<span class="keyword">this</span>-&gt;_M_pi, __rhs._M_pi); }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_less(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __rhs) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> std::less&lt;_Sp_counted_base&lt;_Lp&gt;*&gt;()(<span class="keyword">this</span>-&gt;_M_pi, __rhs._M_pi); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Friend function injected into enclosing namespace and found by ADL</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">      <span class="keyword">operator</span>==(<span class="type">const</span> __shared_count&amp; __a, <span class="type">const</span> __shared_count&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> __a._M_pi == __b._M_pi; }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__weak_count</span>&lt;_Lp&gt;;</span><br><span class="line"></span><br><span class="line">      _Sp_counted_base&lt;_Lp&gt;*  _M_pi;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__weak_count</span></span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">constexpr</span> __weak_count() <span class="keyword">noexcept</span> : _M_pi(<span class="literal">nullptr</span>)</span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      __weak_count(<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_pi(__r._M_pi)</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_add_ref();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count(<span class="type">const</span> __weak_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_pi(__r._M_pi)</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_add_ref();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count(__weak_count&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_pi(__r._M_pi)</span><br><span class="line">      { __r._M_pi = <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      ~__weak_count() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_release();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	<span class="keyword">if</span> (__tmp != <span class="literal">nullptr</span>)</span><br><span class="line">	  __tmp-&gt;_M_weak_add_ref();</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_release();</span><br><span class="line">	_M_pi = __tmp;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __weak_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	<span class="keyword">if</span> (__tmp != <span class="literal">nullptr</span>)</span><br><span class="line">	  __tmp-&gt;_M_weak_add_ref();</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_release();</span><br><span class="line">	_M_pi = __tmp;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(__weak_count&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_release();</span><br><span class="line">	_M_pi = __r._M_pi;</span><br><span class="line">        __r._M_pi = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_swap(__weak_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	__r._M_pi = _M_pi;</span><br><span class="line">	_M_pi = __tmp;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span></span><br><span class="line">      _M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> _M_pi != <span class="literal">nullptr</span> ? _M_pi-&gt;_M_get_use_count() : <span class="number">0</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_less(<span class="type">const</span> __weak_count&amp; __rhs) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> std::less&lt;_Sp_counted_base&lt;_Lp&gt;*&gt;()(<span class="keyword">this</span>-&gt;_M_pi, __rhs._M_pi); }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_less(<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __rhs) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> std::less&lt;_Sp_counted_base&lt;_Lp&gt;*&gt;()(<span class="keyword">this</span>-&gt;_M_pi, __rhs._M_pi); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Friend function injected into enclosing namespace and found by ADL</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">      <span class="keyword">operator</span>==(<span class="type">const</span> __weak_count&amp; __a, <span class="type">const</span> __weak_count&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> __a._M_pi == __b._M_pi; }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_count</span>&lt;_Lp&gt;;</span><br><span class="line"></span><br><span class="line">      _Sp_counted_base&lt;_Lp&gt;*  _M_pi;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now that __weak_count is defined we can define this constructor:</span></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span></span><br><span class="line">    __shared_count&lt;_Lp&gt;::__shared_count(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __r)</span><br><span class="line">    : _M_pi(__r._M_pi)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (_M_pi == <span class="literal">nullptr</span> || !_M_pi-&gt;_M_add_ref_lock_nothrow())</span><br><span class="line">	__throw_bad_weak_ptr();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now that __weak_count is defined we can define this constructor:</span></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span></span><br><span class="line">    __shared_count&lt;_Lp&gt;::</span><br><span class="line">    __shared_count(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __r, std::<span class="type">nothrow_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    : _M_pi(__r._M_pi)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (_M_pi &amp;&amp; !_M_pi-&gt;_M_add_ref_lock_nothrow())</span><br><span class="line">	_M_pi = <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __cpp_lib_shared_ptr_arrays 201611L</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Helper traits for shared_ptr of array:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// A pointer type Y* is said to be compatible with a pointer type T* when</span></span><br><span class="line">  <span class="comment">// either Y* is convertible to T* or Y is U[N] and T is U cv [].</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp_ptr, <span class="keyword">typename</span> _Tp_ptr&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span></span><br><span class="line">    : false_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Yp*, _Tp*&gt;</span><br><span class="line">    : is_convertible&lt;_Yp*, _Tp*&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Up(*)[_Nm], _Up(*)[]&gt;</span><br><span class="line">    : true_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Up(*)[_Nm], <span class="type">const</span> _Up(*)[]&gt;</span><br><span class="line">    : true_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Up(*)[_Nm], <span class="keyword">volatile</span> _Up(*)[]&gt;</span><br><span class="line">    : true_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Up(*)[_Nm], <span class="type">const</span> <span class="keyword">volatile</span> _Up(*)[]&gt;</span><br><span class="line">    : true_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Test conversion from Y(*)[N] to U(*)[N] without forming invalid type Y[N].</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm, <span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = <span class="type">void</span>&gt;</span><br><span class="line">    <span class="keyword">struct</span> __sp_is_constructible_arrN</span><br><span class="line">    : false_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible_arrN</span>&lt;_Up, _Nm, _Yp, <span class="type">__void_t</span>&lt;_Yp[_Nm]&gt;&gt;</span><br><span class="line">    : is_convertible&lt;_Yp(*)[_Nm], _Up(*)[_Nm]&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Test conversion from Y(*)[] to U(*)[] without forming invalid type Y[].</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = <span class="type">void</span>&gt;</span><br><span class="line">    <span class="keyword">struct</span> __sp_is_constructible_arr</span><br><span class="line">    : false_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible_arr</span>&lt;_Up, _Yp, <span class="type">__void_t</span>&lt;_Yp[]&gt;&gt;</span><br><span class="line">    : is_convertible&lt;_Yp(*)[], _Up(*)[]&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Trait to check if shared_ptr&lt;T&gt; can be constructed from Y*.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When T is U[N], Y(*)[N] shall be convertible to T*;</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible</span>&lt;_Up[_Nm], _Yp&gt;</span><br><span class="line">    : __sp_is_constructible_arrN&lt;_Up, _Nm, _Yp&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// when T is U[], Y(*)[] shall be convertible to T*;</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible</span>&lt;_Up[], _Yp&gt;</span><br><span class="line">    : __sp_is_constructible_arr&lt;_Up, _Yp&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// otherwise, Y* shall be convertible to T*.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible</span></span><br><span class="line">    : is_convertible&lt;_Yp*, _Tp*&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define operator* and operator-&gt; for shared_ptr&lt;T&gt;.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp,</span><br><span class="line">	   <span class="type">bool</span> = is_array&lt;_Tp&gt;::value, <span class="type">bool</span> = is_void&lt;_Tp&gt;::value&gt;</span><br><span class="line">    <span class="keyword">class</span> __shared_ptr_access</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = _Tp;</span><br><span class="line"></span><br><span class="line">      element_type&amp;</span><br><span class="line">      <span class="keyword">operator</span>*() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__glibcxx_assert(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> *_M_get();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      element_type*</span><br><span class="line">      <span class="keyword">operator</span>-&gt;() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_GLIBCXX_DEBUG_PEDASSERT(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> _M_get();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      element_type*</span><br><span class="line">      _M_get() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;*&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">get</span>(); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define operator-&gt; for shared_ptr&lt;cv void&gt;.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__shared_ptr_access</span>&lt;_Tp, _Lp, <span class="literal">false</span>, <span class="literal">true</span>&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = _Tp;</span><br><span class="line"></span><br><span class="line">      element_type*</span><br><span class="line">      <span class="keyword">operator</span>-&gt;() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">auto</span> __ptr = <span class="keyword">static_cast</span>&lt;<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;*&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">get</span>();</span><br><span class="line">	_GLIBCXX_DEBUG_PEDASSERT(__ptr != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> __ptr;</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define operator[] for shared_ptr&lt;T[]&gt; and shared_ptr&lt;T[N]&gt;.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__shared_ptr_access</span>&lt;_Tp, _Lp, <span class="literal">true</span>, <span class="literal">false</span>&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = <span class="keyword">typename</span> remove_extent&lt;_Tp&gt;::type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &lt;= 201402L</span></span><br><span class="line">      [[__deprecated__(<span class="string">&quot;shared_ptr&lt;T[]&gt;::operator* is absent from C++17&quot;</span>)]]</span><br><span class="line">      element_type&amp;</span><br><span class="line">      <span class="keyword">operator</span>*() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__glibcxx_assert(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> *_M_get();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      [[__deprecated__(<span class="string">&quot;shared_ptr&lt;T[]&gt;::operator-&gt; is absent from C++17&quot;</span>)]]</span><br><span class="line">      element_type*</span><br><span class="line">      <span class="keyword">operator</span>-&gt;() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_GLIBCXX_DEBUG_PEDASSERT(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> _M_get();</span><br><span class="line">      }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      element_type&amp;</span><br><span class="line">      <span class="keyword">operator</span>[](<span class="type">ptrdiff_t</span> __i) <span class="type">const</span></span><br><span class="line">      {</span><br><span class="line">	__glibcxx_assert(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	__glibcxx_assert(!extent&lt;_Tp&gt;::value || __i &lt; extent&lt;_Tp&gt;::value);</span><br><span class="line">	<span class="keyword">return</span> _M_get()[__i];</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      element_type*</span><br><span class="line">      _M_get() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;*&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">get</span>(); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__shared_ptr</span></span><br><span class="line">    : <span class="keyword">public</span> __shared_ptr_access&lt;_Tp, _Lp&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = <span class="keyword">typename</span> remove_extent&lt;_Tp&gt;::type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="comment">// Constraint for taking ownership of a pointer of type _Yp*:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">using</span> _SafeConv</span><br><span class="line">	  = <span class="keyword">typename</span> enable_if&lt;__sp_is_constructible&lt;_Tp, _Yp&gt;::value&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for construction from shared_ptr and weak_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Res = <span class="type">void</span>&gt;</span><br><span class="line">	<span class="keyword">using</span> _Compatible = <span class="keyword">typename</span></span><br><span class="line">	  enable_if&lt;__sp_compatible_with&lt;_Yp*, _Tp*&gt;::value, _Res&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for assignment from shared_ptr and weak_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">using</span> _Assignable = _Compatible&lt;_Yp, __shared_ptr&amp;&gt;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for construction from unique_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Res = <span class="type">void</span>,</span><br><span class="line">	       <span class="keyword">typename</span> _Ptr = <span class="keyword">typename</span> unique_ptr&lt;_Yp, _Del&gt;::pointer&gt;</span><br><span class="line">	<span class="keyword">using</span> _UniqCompatible = <span class="type">__enable_if_t</span>&lt;__and_&lt;</span><br><span class="line">	  __sp_compatible_with&lt;_Yp*, _Tp*&gt;,</span><br><span class="line">	  is_convertible&lt;_Ptr, element_type*&gt;,</span><br><span class="line">	  is_move_constructible&lt;_Del&gt;</span><br><span class="line">	  &gt;::value, _Res&gt;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for assignment from unique_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del&gt;</span><br><span class="line">	<span class="keyword">using</span> _UniqAssignable = _UniqCompatible&lt;_Yp, _Del, __shared_ptr&amp;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201402L</span></span><br><span class="line">      <span class="keyword">using</span> weak_type = __weak_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">constexpr</span> __shared_ptr() <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(<span class="number">0</span>), _M_refcount()</span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _SafeConv&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">explicit</span></span><br><span class="line">	__shared_ptr(_Yp* __p)</span><br><span class="line">	: _M_ptr(__p), _M_refcount(__p, <span class="keyword">typename</span> is_array&lt;_Tp&gt;::<span class="built_in">type</span>())</span><br><span class="line">	{</span><br><span class="line">	  <span class="built_in">static_assert</span>( !is_void&lt;_Yp&gt;::value, <span class="string">&quot;incomplete type&quot;</span> );</span><br><span class="line">	  <span class="built_in">static_assert</span>( <span class="built_in">sizeof</span>(_Yp) &gt; <span class="number">0</span>, <span class="string">&quot;incomplete type&quot;</span> );</span><br><span class="line">	  _M_enable_shared_from_this_with(__p);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> = _SafeConv&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(_Yp* __p, _Deleter __d)</span><br><span class="line">	: _M_ptr(__p), _M_refcount(__p, std::<span class="built_in">move</span>(__d))</span><br><span class="line">	{</span><br><span class="line">	  <span class="built_in">static_assert</span>(__is_invocable&lt;_Deleter&amp;, _Yp*&amp;&gt;::value,</span><br><span class="line">	      <span class="string">&quot;deleter expression d(p) is well-formed&quot;</span>);</span><br><span class="line">	  _M_enable_shared_from_this_with(__p);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc,</span><br><span class="line">	       <span class="keyword">typename</span> = _SafeConv&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(_Yp* __p, _Deleter __d, _Alloc __a)</span><br><span class="line">	: _M_ptr(__p), _M_refcount(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a))</span><br><span class="line">	{</span><br><span class="line">	  <span class="built_in">static_assert</span>(__is_invocable&lt;_Deleter&amp;, _Yp*&amp;&gt;::value,</span><br><span class="line">	      <span class="string">&quot;deleter expression d(p) is well-formed&quot;</span>);</span><br><span class="line">	  _M_enable_shared_from_this_with(__p);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Deleter&gt;</span><br><span class="line">	__shared_ptr(<span class="type">nullptr_t</span> __p, _Deleter __d)</span><br><span class="line">	: _M_ptr(<span class="number">0</span>), _M_refcount(__p, std::<span class="built_in">move</span>(__d))</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">        __shared_ptr(<span class="type">nullptr_t</span> __p, _Deleter __d, _Alloc __a)</span><br><span class="line">	: _M_ptr(<span class="number">0</span>), _M_refcount(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a))</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Aliasing constructor</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	__shared_ptr(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r,</span><br><span class="line">		     element_type* __p) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__p), _M_refcount(__r._M_refcount) <span class="comment">// never throws</span></span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Aliasing constructor</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	__shared_ptr(__shared_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r,</span><br><span class="line">		     element_type* __p) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__p), _M_refcount()</span><br><span class="line">	{</span><br><span class="line">	  _M_refcount._M_swap(__r._M_refcount);</span><br><span class="line">	  __r._M_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      __shared_ptr(<span class="type">const</span> __shared_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line">      __shared_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> __shared_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line">      ~__shared_ptr() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__r._M_ptr), _M_refcount(__r._M_refcount)</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      __shared_ptr(__shared_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(__r._M_ptr), _M_refcount()</span><br><span class="line">      {</span><br><span class="line">	_M_refcount._M_swap(__r._M_refcount);</span><br><span class="line">	__r._M_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(__shared_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__r._M_ptr), _M_refcount()</span><br><span class="line">	{</span><br><span class="line">	  _M_refcount._M_swap(__r._M_refcount);</span><br><span class="line">	  __r._M_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">explicit</span> __shared_ptr(<span class="type">const</span> __weak_ptr&lt;_Yp, _Lp&gt;&amp; __r)</span><br><span class="line">	: _M_refcount(__r._M_refcount) <span class="comment">// may throw</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="comment">// It is now safe to copy __r._M_ptr, as</span></span><br><span class="line">	  <span class="comment">// _M_refcount(__r._M_refcount) did not throw.</span></span><br><span class="line">	  _M_ptr = __r._M_ptr;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If an exception is thrown this constructor has no effect.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del,</span><br><span class="line">	       <span class="keyword">typename</span> = _UniqCompatible&lt;_Yp, _Del&gt;&gt;</span><br><span class="line">	__shared_ptr(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	: _M_ptr(__r.<span class="built_in">get</span>()), _M_refcount()</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">auto</span> __raw = __to_address(__r.<span class="built_in">get</span>());</span><br><span class="line">	  _M_refcount = __shared_count&lt;_Lp&gt;(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  _M_enable_shared_from_this_with(__raw);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &lt;= 201402L &amp;&amp; _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="comment">// If an exception is thrown this constructor has no effect.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Del,</span><br><span class="line">	       <span class="keyword">typename</span> enable_if&lt;__and_&lt;</span><br><span class="line">		 __not_&lt;is_array&lt;_Tp&gt;&gt;, is_array&lt;_Tp1&gt;,</span><br><span class="line">	         is_convertible&lt;<span class="keyword">typename</span> unique_ptr&lt;_Tp1, _Del&gt;::pointer, _Tp*&gt;</span><br><span class="line">	       &gt;::value, <span class="type">bool</span>&gt;::type = <span class="literal">true</span>&gt;</span><br><span class="line">	__shared_ptr(unique_ptr&lt;_Tp1, _Del&gt;&amp;&amp; __r, __sp_array_delete)</span><br><span class="line">	: _M_ptr(__r.<span class="built_in">get</span>()), _M_refcount()</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">auto</span> __raw = __to_address(__r.<span class="built_in">get</span>());</span><br><span class="line">	  _M_refcount = __shared_count&lt;_Lp&gt;(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  _M_enable_shared_from_this_with(__raw);</span><br><span class="line">	}</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="comment">// Postcondition: use_count() == 1 and __r.get() == 0</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(auto_ptr&lt;_Yp&gt;&amp;&amp; __r);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">constexpr</span> __shared_ptr(<span class="type">nullptr_t</span>) <span class="keyword">noexcept</span> : __shared_ptr() { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  _M_ptr = __r._M_ptr;</span><br><span class="line">	  _M_refcount = __r._M_refcount; <span class="comment">// __shared_count::op= doesn&#x27;t throw</span></span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(auto_ptr&lt;_Yp&gt;&amp;&amp; __r)</span><br><span class="line">	{</span><br><span class="line">	  __shared_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      __shared_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(__shared_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__shared_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">_Yp</span>&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(__shared_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  __shared_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del&gt;</span><br><span class="line">	_UniqAssignable&lt;_Yp, _Del&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	{</span><br><span class="line">	  __shared_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function">      <span class="title">reset</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ __shared_ptr().<span class="built_in">swap</span>(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span></span><br><span class="line"><span class="function">	_SafeConv&lt;_Yp&gt;</span></span><br><span class="line"><span class="function">	<span class="title">reset</span><span class="params">(_Yp* __p)</span> <span class="comment">// _Yp must be complete.</span></span></span><br><span class="line"><span class="function">	</span>{</span><br><span class="line">	  <span class="comment">// Catch self-reset errors.</span></span><br><span class="line">	  __glibcxx_assert(__p == <span class="literal">nullptr</span> || __p != _M_ptr);</span><br><span class="line">	  __shared_ptr(__p).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter&gt;</span></span><br><span class="line"><span class="function">	_SafeConv&lt;_Yp&gt;</span></span><br><span class="line"><span class="function">	<span class="title">reset</span><span class="params">(_Yp* __p, _Deleter __d)</span></span></span><br><span class="line"><span class="function">	</span>{ __shared_ptr(__p, std::<span class="built_in">move</span>(__d)).<span class="built_in">swap</span>(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc&gt;</span></span><br><span class="line"><span class="function">	_SafeConv&lt;_Yp&gt;</span></span><br><span class="line"><span class="function">	<span class="title">reset</span><span class="params">(_Yp* __p, _Deleter __d, _Alloc __a)</span></span></span><br><span class="line"><span class="function">        </span>{ __shared_ptr(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a)).<span class="built_in">swap</span>(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return the stored pointer.</span></span><br><span class="line">      <span class="function">element_type*</span></span><br><span class="line"><span class="function">      <span class="title">get</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_ptr; }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return true if the stored pointer is not null.</span></span><br><span class="line">      <span class="function"><span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_ptr != <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return true if use_count() == 1.</span></span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">unique</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_refcount._M_unique(); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// If *this owns a pointer, return the number of owners, otherwise zero.</span></span><br><span class="line">      <span class="function"><span class="type">long</span></span></span><br><span class="line"><span class="function">      <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_refcount._M_get_use_count(); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Exchange both the owned pointer and the stored pointer.</span></span><br><span class="line">      <span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function">      <span class="title">swap</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;&amp; __other)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">	std::<span class="built_in">swap</span>(_M_ptr, __other._M_ptr);</span><br><span class="line">	_M_refcount._M_swap(__other._M_refcount);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/** @brief Define an ordering based on ownership.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * This function defines a strict weak ordering between two shared_ptr</span></span><br><span class="line"><span class="comment">       * or weak_ptr objects, such that one object is less than the other</span></span><br><span class="line"><span class="comment">       * unless they share ownership of the same pointer, or are both empty.</span></span><br><span class="line"><span class="comment">       * @{</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="type">bool</span></span></span><br><span class="line"><span class="function">	<span class="title">owner_before</span><span class="params">(__shared_ptr&lt;_Tp1, _Lp&gt; <span class="type">const</span>&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> _M_refcount._M_less(__rhs._M_refcount); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="type">bool</span></span></span><br><span class="line"><span class="function">	<span class="title">owner_before</span><span class="params">(__weak_ptr&lt;_Tp1, _Lp&gt; <span class="type">const</span>&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> _M_refcount._M_less(__rhs._M_refcount); }</span><br><span class="line">      <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="comment">// This constructor is non-standard, it is used by allocate_shared.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	__shared_ptr(_Sp_alloc_shared_tag&lt;_Alloc&gt; __tag, _Args&amp;&amp;... __args)</span><br><span class="line">	: _M_ptr(), _M_refcount(_M_ptr, __tag, std::forward&lt;_Args&gt;(__args)...)</span><br><span class="line">	{ _M_enable_shared_from_this_with(_M_ptr); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1, <span class="keyword">typename</span> _Alloc,</span><br><span class="line">	       <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	<span class="keyword">friend</span> __shared_ptr&lt;_Tp1, _Lp1&gt;</span><br><span class="line">	__allocate_shared(<span class="type">const</span> _Alloc&amp; __a, _Args&amp;&amp;... __args);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This constructor is used by __weak_ptr::lock() and</span></span><br><span class="line">      <span class="comment">// shared_ptr::shared_ptr(const weak_ptr&amp;, std::nothrow_t).</span></span><br><span class="line">      __shared_ptr(<span class="type">const</span> __weak_ptr&lt;_Tp, _Lp&gt;&amp; __r, std::<span class="type">nothrow_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_refcount(__r._M_refcount, std::nothrow)</span><br><span class="line">      {</span><br><span class="line">	_M_ptr = _M_refcount._M_get_use_count() ? __r._M_ptr : <span class="literal">nullptr</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__weak_ptr</span>&lt;_Tp, _Lp&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">using</span> <span class="type">__esft_base_t</span> = <span class="keyword">decltype</span>(__enable_shared_from_this_base(</span><br><span class="line">	      std::declval&lt;<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp;&gt;(),</span><br><span class="line">	      std::<span class="built_in">declval</span>&lt;_Yp*&gt;()));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Detect an accessible and unambiguous enable_shared_from_this base.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = <span class="type">void</span>&gt;</span><br><span class="line">	<span class="keyword">struct</span> __has_esft_base</span><br><span class="line">	: false_type { };</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">__has_esft_base</span>&lt;_Yp, <span class="type">__void_t</span>&lt;<span class="type">__esft_base_t</span>&lt;_Yp&gt;&gt;&gt;</span><br><span class="line">	: __not_&lt;is_array&lt;_Tp&gt;&gt; { }; <span class="comment">// No enable shared_from_this for arrays</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Yp2 = <span class="keyword">typename</span> remove_cv&lt;_Yp&gt;::type&gt;</span><br><span class="line">	<span class="keyword">typename</span> enable_if&lt;__has_esft_base&lt;_Yp2&gt;::value&gt;::type</span><br><span class="line">	_M_enable_shared_from_this_with(_Yp* __p) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">if</span> (<span class="keyword">auto</span> __base = __enable_shared_from_this_base(_M_refcount, __p))</span><br><span class="line">	    __base-&gt;_M_weak_assign(<span class="built_in">const_cast</span>&lt;_Yp2*&gt;(__p), _M_refcount);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Yp2 = <span class="keyword">typename</span> remove_cv&lt;_Yp&gt;::type&gt;</span><br><span class="line">	<span class="keyword">typename</span> enable_if&lt;!__has_esft_base&lt;_Yp2&gt;::value&gt;::type</span><br><span class="line">	_M_enable_shared_from_this_with(_Yp*) <span class="keyword">noexcept</span></span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp; __ti) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> _M_refcount._M_get_deleter(__ti); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_ptr</span>;</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__weak_ptr</span>;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">friend</span> _Del* <span class="title">get_deleter</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp1&gt;&amp;)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">friend</span> _Del* <span class="title">get_deleter</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp1&gt;&amp;)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">      element_type*	   _M_ptr;         <span class="comment">// Contained pointer.</span></span><br><span class="line">      __shared_count&lt;_Lp&gt;  _M_refcount;    <span class="comment">// Reference counter.</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.7 shared_ptr comparisons</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a.<span class="built_in">get</span>() == __b.<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !__a; }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cpp_lib_three_way_comparison</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> strong_ordering</span><br><span class="line">    <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a,</span><br><span class="line">		<span class="type">const</span> __shared_ptr&lt;_Up, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> <span class="built_in">compare_three_way</span>()(__a.<span class="built_in">get</span>(), __b.<span class="built_in">get</span>()); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> strong_ordering</span><br><span class="line">    <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> pointer = <span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type*;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">compare_three_way</span>()(__a.<span class="built_in">get</span>(), <span class="built_in">static_cast</span>&lt;pointer&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !__a; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a.<span class="built_in">get</span>() != __b.<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="built_in">return</span> (<span class="type">bool</span>)__a; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="built_in">return</span> (<span class="type">bool</span>)__a; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a,</span><br><span class="line">	      <span class="type">const</span> __shared_ptr&lt;_Up, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type;</span><br><span class="line">      <span class="keyword">using</span> _Up_elt = <span class="keyword">typename</span> __shared_ptr&lt;_Up, _Lp&gt;::element_type;</span><br><span class="line">      <span class="keyword">using</span> _Vp = <span class="keyword">typename</span> common_type&lt;_Tp_elt*, _Up_elt*&gt;::type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Vp&gt;()(__a.<span class="built_in">get</span>(), __b.<span class="built_in">get</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Tp_elt*&gt;()(__a.<span class="built_in">get</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Tp_elt*&gt;()(<span class="literal">nullptr</span>, __a.<span class="built_in">get</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__b &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(<span class="literal">nullptr</span> &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; <span class="literal">nullptr</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	      <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> (__b &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> <span class="literal">nullptr</span> &lt; __a; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a &lt; <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; __b); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; <span class="literal">nullptr</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(<span class="literal">nullptr</span> &lt; __a); }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// three-way comparison</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.8 shared_ptr specialized algorithms.</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">swap</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, __shared_ptr&lt;_Tp, _Lp&gt;&amp; __b)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{ __a.<span class="built_in">swap</span>(__b); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.9 shared_ptr casts</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The seemingly equivalent code:</span></span><br><span class="line">  <span class="comment">// shared_ptr&lt;_Tp, _Lp&gt;(static_cast&lt;_Tp*&gt;(__r.get()))</span></span><br><span class="line">  <span class="comment">// will eventually result in undefined behaviour, attempting to</span></span><br><span class="line">  <span class="comment">// delete the same object twice.</span></span><br><span class="line">  <span class="comment">/// static_pointer_cast</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">static_pointer_cast</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = __shared_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">static_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The seemingly equivalent code:</span></span><br><span class="line">  <span class="comment">// shared_ptr&lt;_Tp, _Lp&gt;(const_cast&lt;_Tp*&gt;(__r.get()))</span></span><br><span class="line">  <span class="comment">// will eventually result in undefined behaviour, attempting to</span></span><br><span class="line">  <span class="comment">// delete the same object twice.</span></span><br><span class="line">  <span class="comment">/// const_pointer_cast</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">const_pointer_cast</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = __shared_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">const_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The seemingly equivalent code:</span></span><br><span class="line">  <span class="comment">// shared_ptr&lt;_Tp, _Lp&gt;(dynamic_cast&lt;_Tp*&gt;(__r.get()))</span></span><br><span class="line">  <span class="comment">// will eventually result in undefined behaviour, attempting to</span></span><br><span class="line">  <span class="comment">// delete the same object twice.</span></span><br><span class="line">  <span class="comment">/// dynamic_pointer_cast</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">dynamic_pointer_cast</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = __shared_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span>* __p = <span class="built_in">dynamic_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()))</span><br><span class="line">	<span class="keyword">return</span> _Sp(__r, __p);</span><br><span class="line">      <span class="keyword">return</span> _Sp();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201402L</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">reinterpret_pointer_cast</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = __shared_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__weak_ptr</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Res = <span class="type">void</span>&gt;</span><br><span class="line">	<span class="keyword">using</span> _Compatible = <span class="keyword">typename</span></span><br><span class="line">	  enable_if&lt;__sp_compatible_with&lt;_Yp*, _Tp*&gt;::value, _Res&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for assignment from shared_ptr and weak_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">using</span> _Assignable = _Compatible&lt;_Yp, __weak_ptr&amp;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = <span class="keyword">typename</span> remove_extent&lt;_Tp&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">constexpr</span> __weak_ptr() <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(<span class="literal">nullptr</span>), _M_refcount()</span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      __weak_ptr(<span class="type">const</span> __weak_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      ~__weak_ptr() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The &quot;obvious&quot; converting constructor implementation:</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">//  template&lt;typename _Tp1&gt;</span></span><br><span class="line">      <span class="comment">//    __weak_ptr(const __weak_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span></span><br><span class="line">      <span class="comment">//    : _M_ptr(__r._M_ptr), _M_refcount(__r._M_refcount) // never throws</span></span><br><span class="line">      <span class="comment">//    { }</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// has a serious problem.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">//  __r._M_ptr may already have been invalidated. The _M_ptr(__r._M_ptr)</span></span><br><span class="line">      <span class="comment">//  conversion may require access to *__r._M_ptr (virtual inheritance).</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// It is not possible to avoid spurious access violations since</span></span><br><span class="line">      <span class="comment">// in multithreaded programs __r._M_ptr may be invalidated at any point.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__weak_ptr(<span class="type">const</span> __weak_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_refcount(__r._M_refcount)</span><br><span class="line">        { _M_ptr = __r.<span class="built_in">lock</span>().<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__weak_ptr(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__r._M_ptr), _M_refcount(__r._M_refcount)</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      __weak_ptr(__weak_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(__r._M_ptr), _M_refcount(std::<span class="built_in">move</span>(__r._M_refcount))</span><br><span class="line">      { __r._M_ptr = <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__weak_ptr(__weak_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__r.<span class="built_in">lock</span>().<span class="built_in">get</span>()), _M_refcount(std::<span class="built_in">move</span>(__r._M_refcount))</span><br><span class="line">        { __r._M_ptr = <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      __weak_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __weak_ptr&amp; __r) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> __weak_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  _M_ptr = __r.<span class="built_in">lock</span>().<span class="built_in">get</span>();</span><br><span class="line">	  _M_refcount = __r._M_refcount;</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  _M_ptr = __r._M_ptr;</span><br><span class="line">	  _M_refcount = __r._M_refcount;</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      __weak_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(__weak_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__weak_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(__weak_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  _M_ptr = __r.<span class="built_in">lock</span>().<span class="built_in">get</span>();</span><br><span class="line">	  _M_refcount = std::<span class="built_in">move</span>(__r._M_refcount);</span><br><span class="line">	  __r._M_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="function">__shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">lock</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __shared_ptr&lt;element_type, _Lp&gt;(*<span class="keyword">this</span>, std::nothrow); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">long</span></span></span><br><span class="line"><span class="function">      <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_refcount._M_get_use_count(); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">expired</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_refcount._M_get_use_count() == <span class="number">0</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="type">bool</span></span></span><br><span class="line"><span class="function">	<span class="title">owner_before</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> _M_refcount._M_less(__rhs._M_refcount); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="type">bool</span></span></span><br><span class="line"><span class="function">	<span class="title">owner_before</span><span class="params">(<span class="type">const</span> __weak_ptr&lt;_Tp1, _Lp&gt;&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> _M_refcount._M_less(__rhs._M_refcount); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function">      <span class="title">reset</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ __weak_ptr().<span class="built_in">swap</span>(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function">      <span class="title">swap</span><span class="params">(__weak_ptr&amp; __s)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">	std::<span class="built_in">swap</span>(_M_ptr, __s._M_ptr);</span><br><span class="line">	_M_refcount._M_swap(__s._M_refcount);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="comment">// Used by __enable_shared_from_this.</span></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_assign(_Tp* __ptr, <span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __refcount) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">use_count</span>() == <span class="number">0</span>)</span><br><span class="line">	  {</span><br><span class="line">	    _M_ptr = __ptr;</span><br><span class="line">	    _M_refcount = __refcount;</span><br><span class="line">	  }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_ptr</span>;</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__weak_ptr</span>;</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__enable_shared_from_this</span>&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">enable_shared_from_this</span>&lt;_Tp&gt;;</span><br><span class="line"></span><br><span class="line">      element_type*	 _M_ptr;         <span class="comment">// Contained pointer.</span></span><br><span class="line">      __weak_count&lt;_Lp&gt;  _M_refcount;    <span class="comment">// Reference counter.</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.3.6 weak_ptr specialized algorithms.</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">swap</span><span class="params">(__weak_ptr&lt;_Tp, _Lp&gt;&amp; __a, __weak_ptr&lt;_Tp, _Lp&gt;&amp; __b)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{ __a.<span class="built_in">swap</span>(__b); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_owner_less</span> : <span class="keyword">public</span> binary_function&lt;_Tp, _Tp, <span class="type">bool</span>&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> _Tp&amp; __lhs, <span class="type">const</span> _Tp&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __lhs.<span class="built_in">owner_before</span>(__rhs); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> _Tp&amp; __lhs, <span class="type">const</span> _Tp1&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __lhs.<span class="built_in">owner_before</span>(__rhs); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> _Tp1&amp; __lhs, <span class="type">const</span> _Tp&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __lhs.<span class="built_in">owner_before</span>(__rhs); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_owner_less</span>&lt;<span class="type">void</span>, <span class="type">void</span>&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">auto</span></span></span><br><span class="line"><span class="function">	<span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> _Tp&amp; __lhs, <span class="type">const</span> _Up&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	-&gt; <span class="title">decltype</span><span class="params">(__lhs.owner_before(__rhs))</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> __lhs.<span class="built_in">owner_before</span>(__rhs); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">using</span> is_transparent = <span class="type">void</span>;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;__shared_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> _Sp_owner_less&lt;__shared_ptr&lt;_Tp, _Lp&gt;, __weak_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;__weak_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> _Sp_owner_less&lt;__weak_ptr&lt;_Tp, _Lp&gt;, __shared_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__enable_shared_from_this</span></span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="keyword">constexpr</span> __enable_shared_from_this() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      __enable_shared_from_this(<span class="type">const</span> __enable_shared_from_this&amp;) <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      __enable_shared_from_this&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __enable_shared_from_this&amp;) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> *<span class="keyword">this</span>; }</span><br><span class="line"></span><br><span class="line">      ~__enable_shared_from_this() { }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="function">__shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">shared_from_this</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __shared_ptr&lt;_Tp, _Lp&gt;(<span class="keyword">this</span>-&gt;_M_weak_this); }</span><br><span class="line"></span><br><span class="line">      <span class="function">__shared_ptr&lt;<span class="type">const</span> _Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">shared_from_this</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __shared_ptr&lt;<span class="type">const</span> _Tp, _Lp&gt;(<span class="keyword">this</span>-&gt;_M_weak_this); }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201402L || !defined(__STRICT_ANSI__) <span class="comment">// c++1z or gnu++11</span></span></span><br><span class="line">      <span class="function">__weak_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">weak_from_this</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_weak_this; }</span><br><span class="line"></span><br><span class="line">      <span class="function">__weak_ptr&lt;<span class="type">const</span> _Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">weak_from_this</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_weak_this; }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span><br><span class="line">	<span class="type">void</span></span><br><span class="line">	_M_weak_assign(_Tp1* __p, <span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __n) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">	{ _M_weak_this._M_assign(__p, __n); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">friend</span> <span class="type">const</span> __enable_shared_from_this*</span><br><span class="line">      __enable_shared_from_this_base(<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp;,</span><br><span class="line">				     <span class="type">const</span> __enable_shared_from_this* __p)</span><br><span class="line">      { <span class="keyword">return</span> __p; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span>, _Lock_policy&gt;</span><br><span class="line">	<span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_ptr</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">mutable</span> __weak_ptr&lt;_Tp, _Lp&gt;  _M_weak_this;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy,</span><br><span class="line">	   <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span><br><span class="line">    __allocate_shared(<span class="type">const</span> _Alloc&amp; __a, _Args&amp;&amp;... __args)</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">static_assert</span>(!is_array&lt;_Tp&gt;::value, <span class="string">&quot;make_shared&lt;T[]&gt; not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> __shared_ptr&lt;_Tp, _Lp&gt;(_Sp_alloc_shared_tag&lt;_Alloc&gt;{__a},</span><br><span class="line">				    std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy,</span><br><span class="line">	   <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span><br><span class="line">    __make_shared(_Args&amp;&amp;... __args)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> std::remove_const&lt;_Tp&gt;::type _Tp_nc;</span><br><span class="line">      <span class="keyword">return</span> std::__allocate_shared&lt;_Tp, _Lp&gt;(std::<span class="built_in">allocator</span>&lt;_Tp_nc&gt;(),</span><br><span class="line">					      std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// std::hash specialization for __shared_ptr.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">hash</span>&lt;__shared_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> __hash_base&lt;<span class="type">size_t</span>, __shared_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="function"><span class="type">size_t</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __s)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">	<span class="keyword">return</span> hash&lt;<span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type*&gt;()(</span><br><span class="line">	    __s.<span class="built_in">get</span>());</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">_GLIBCXX_END_NAMESPACE_VERSION</span><br><span class="line">} <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _SHARED_PTR_BASE_H</span></span></span><br></pre></td></tr></table></figure>
</details>

<details>
<summary>shared_ptr_atomic.h</summary>
<figure class="highlight cpp"><figcaption><span>shared_ptr_atomic.h</span><a href="/blog/downloads/code/shared_ptr/shared_ptr_atomic.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr atomic access -*- C++ -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Copyright (C) 2014-2021 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file is part of the GNU ISO C++ Library.  This library is free</span></span><br><span class="line"><span class="comment">// software; you can redistribute it and/or modify it under the</span></span><br><span class="line"><span class="comment">// terms of the GNU General Public License as published by the</span></span><br><span class="line"><span class="comment">// Free Software Foundation; either version 3, or (at your option)</span></span><br><span class="line"><span class="comment">// any later version.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This library is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">// GNU General Public License for more details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Under Section 7 of GPL version 3, you are granted additional</span></span><br><span class="line"><span class="comment">// permissions described in the GCC Runtime Library Exception, version</span></span><br><span class="line"><span class="comment">// 3.1, as published by the Free Software Foundation.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You should have received a copy of the GNU General Public License and</span></span><br><span class="line"><span class="comment">// a copy of the GCC Runtime Library Exception along with this program;</span></span><br><span class="line"><span class="comment">// see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see</span></span><br><span class="line"><span class="comment">// &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** @file bits/shared_ptr_atomic.h</span></span><br><span class="line"><span class="comment"> *  This is an internal header file, included by other library headers.</span></span><br><span class="line"><span class="comment"> *  Do not attempt to use it directly. @headername{memory}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SHARED_PTR_ATOMIC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SHARED_PTR_ATOMIC_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/atomic_base.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> std _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">{</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @addtogroup pointer_abstractions</span></span><br><span class="line"><span class="comment">   * @{</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">/// @relates shared_ptr @{</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @cond undocumented</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_Sp_locker</span></span><br><span class="line">  {</span><br><span class="line">    _Sp_locker(<span class="type">const</span> _Sp_locker&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    _Sp_locker&amp; <span class="keyword">operator</span>=(<span class="type">const</span> _Sp_locker&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __GTHREADS</span></span><br><span class="line">    <span class="keyword">explicit</span></span><br><span class="line">    _Sp_locker(<span class="type">const</span> <span class="type">void</span>*) <span class="keyword">noexcept</span>;</span><br><span class="line">    _Sp_locker(<span class="type">const</span> <span class="type">void</span>*, <span class="type">const</span> <span class="type">void</span>*) <span class="keyword">noexcept</span>;</span><br><span class="line">    ~_Sp_locker();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _M_key1;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _M_key2;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">explicit</span> _Sp_locker(<span class="type">const</span> <span class="type">void</span>*, <span class="type">const</span> <span class="type">void</span>* = <span class="literal">nullptr</span>) { }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @endcond</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Report whether shared_ptr atomic operations are lock-free.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @return True if atomic access to @c *__p is lock-free, false otherwise.</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_is_lock_free</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;* __p)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __GTHREADS</span></span><br><span class="line">      <span class="keyword">return</span> __gthread_active_p() == <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_is_lock_free</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;* __p)</span></span></span><br><span class="line"><span class="function">    </span>{ <span class="keyword">return</span> std::<span class="built_in">atomic_is_lock_free</span>&lt;_Tp, __default_lock_policy&gt;(__p); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Atomic load for shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @return @c *__p</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  The memory order shall not be @c memory_order_release or</span></span><br><span class="line"><span class="comment">   *  @c memory_order_acq_rel.</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_load_explicit</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;* __p, memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      <span class="keyword">return</span> *__p;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_load</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;* __p)</span></span></span><br><span class="line"><span class="function">    </span>{ <span class="keyword">return</span> std::<span class="built_in">atomic_load_explicit</span>(__p, memory_order_seq_cst); }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_load_explicit</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;* __p, memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      <span class="keyword">return</span> *__p;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_load</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;* __p)</span></span></span><br><span class="line"><span class="function">    </span>{ <span class="keyword">return</span> std::<span class="built_in">atomic_load_explicit</span>(__p, memory_order_seq_cst); }</span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Atomic store for shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @param  __r The value to store.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  The memory order shall not be @c memory_order_acquire or</span></span><br><span class="line"><span class="comment">   *  @c memory_order_acq_rel.</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_store_explicit</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt; __r,</span></span></span><br><span class="line"><span class="params"><span class="function">			  memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      __p-&gt;<span class="built_in">swap</span>(__r); <span class="comment">// use swap so that **__p not destroyed while lock held</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_store</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt; __r)</span></span></span><br><span class="line"><span class="function">    </span>{ std::<span class="built_in">atomic_store_explicit</span>(__p, std::<span class="built_in">move</span>(__r), memory_order_seq_cst); }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_store_explicit</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">			  __shared_ptr&lt;_Tp, _Lp&gt; __r,</span></span></span><br><span class="line"><span class="params"><span class="function">			  memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      __p-&gt;<span class="built_in">swap</span>(__r); <span class="comment">// use swap so that **__p not destroyed while lock held</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_store</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p, __shared_ptr&lt;_Tp, _Lp&gt; __r)</span></span></span><br><span class="line"><span class="function">    </span>{ std::<span class="built_in">atomic_store_explicit</span>(__p, std::<span class="built_in">move</span>(__r), memory_order_seq_cst); }</span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Atomic exchange for shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @param  __r New value to store in @c *__p.</span></span><br><span class="line"><span class="comment">   *  @return The original value of @c *__p</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_exchange_explicit</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt; __r,</span></span></span><br><span class="line"><span class="params"><span class="function">			     memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      __p-&gt;<span class="built_in">swap</span>(__r);</span><br><span class="line">      <span class="keyword">return</span> __r;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_exchange</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt; __r)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_exchange_explicit</span>(__p, std::<span class="built_in">move</span>(__r),</span><br><span class="line">					   memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_exchange_explicit</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">			     __shared_ptr&lt;_Tp, _Lp&gt; __r,</span></span></span><br><span class="line"><span class="params"><span class="function">			     memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      __p-&gt;<span class="built_in">swap</span>(__r);</span><br><span class="line">      <span class="keyword">return</span> __r;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_exchange</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p, __shared_ptr&lt;_Tp, _Lp&gt; __r)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_exchange_explicit</span>(__p, std::<span class="built_in">move</span>(__r),</span><br><span class="line">					   memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Atomic compare-and-swap for shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @param  __v A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @param  __w A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @return True if @c *__p was equivalent to @c *__v, false otherwise.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  The memory order for failure shall not be @c memory_order_release or</span></span><br><span class="line"><span class="comment">   *  @c memory_order_acq_rel, or stronger than the memory order for success.</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_strong_explicit</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">					    shared_ptr&lt;_Tp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">					    shared_ptr&lt;_Tp&gt; __w,</span></span></span><br><span class="line"><span class="params"><span class="function">					    memory_order,</span></span></span><br><span class="line"><span class="params"><span class="function">					    memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      shared_ptr&lt;_Tp&gt; __x; <span class="comment">// goes out of scope after __lock</span></span><br><span class="line">      _Sp_locker __lock{__p, __v};</span><br><span class="line">      owner_less&lt;shared_ptr&lt;_Tp&gt;&gt; __less;</span><br><span class="line">      <span class="keyword">if</span> (*__p == *__v &amp;&amp; !__less(*__p, *__v) &amp;&amp; !__less(*__v, *__p))</span><br><span class="line">	{</span><br><span class="line">	  __x = std::<span class="built_in">move</span>(*__p);</span><br><span class="line">	  *__p = std::<span class="built_in">move</span>(__w);</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	}</span><br><span class="line">      __x = std::<span class="built_in">move</span>(*__v);</span><br><span class="line">      *__v = *__p;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_strong</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">				 shared_ptr&lt;_Tp&gt; __w)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_strong_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), memory_order_seq_cst, memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_weak_explicit</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">					  shared_ptr&lt;_Tp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">					  shared_ptr&lt;_Tp&gt; __w,</span></span></span><br><span class="line"><span class="params"><span class="function">					  memory_order __success,</span></span></span><br><span class="line"><span class="params"><span class="function">					  memory_order __failure)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_strong_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), __success, __failure);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_weak</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">				 shared_ptr&lt;_Tp&gt; __w)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_weak_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), memory_order_seq_cst, memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_strong_explicit</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">					    __shared_ptr&lt;_Tp, _Lp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">					    __shared_ptr&lt;_Tp, _Lp&gt; __w,</span></span></span><br><span class="line"><span class="params"><span class="function">					    memory_order,</span></span></span><br><span class="line"><span class="params"><span class="function">					    memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      __shared_ptr&lt;_Tp, _Lp&gt; __x; <span class="comment">// goes out of scope after __lock</span></span><br><span class="line">      _Sp_locker __lock{__p, __v};</span><br><span class="line">      owner_less&lt;__shared_ptr&lt;_Tp, _Lp&gt;&gt; __less;</span><br><span class="line">      <span class="keyword">if</span> (*__p == *__v &amp;&amp; !__less(*__p, *__v) &amp;&amp; !__less(*__v, *__p))</span><br><span class="line">	{</span><br><span class="line">	  __x = std::<span class="built_in">move</span>(*__p);</span><br><span class="line">	  *__p = std::<span class="built_in">move</span>(__w);</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	}</span><br><span class="line">      __x = std::<span class="built_in">move</span>(*__v);</span><br><span class="line">      *__v = *__p;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_strong</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">				   __shared_ptr&lt;_Tp, _Lp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">				   __shared_ptr&lt;_Tp, _Lp&gt; __w)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_strong_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), memory_order_seq_cst, memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_weak_explicit</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">					  __shared_ptr&lt;_Tp, _Lp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">					  __shared_ptr&lt;_Tp, _Lp&gt; __w,</span></span></span><br><span class="line"><span class="params"><span class="function">					  memory_order __success,</span></span></span><br><span class="line"><span class="params"><span class="function">					  memory_order __failure)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_strong_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), __success, __failure);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_weak</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">				 __shared_ptr&lt;_Tp, _Lp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">				 __shared_ptr&lt;_Tp, _Lp&gt; __w)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_weak_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), memory_order_seq_cst, memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @} relates shared_ptr</span></span><br><span class="line">  <span class="comment">/// @} group pointer_abstractions</span></span><br><span class="line"></span><br><span class="line">_GLIBCXX_END_NAMESPACE_VERSION</span><br><span class="line">} <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _SHARED_PTR_ATOMIC_H</span></span></span><br></pre></td></tr></table></figure>
</details>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/01/concurrency/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/01/concurrency/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">内存模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-01 19:30:53" itemprop="dateCreated datePublished" datetime="2025-08-01T19:30:53+00:00">2025-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="内存模型的定义"><a href="#内存模型的定义" class="headerlink" title="内存模型的定义"></a>内存模型的定义</h2><p>内存模型（Memory Model）是定义<strong>数据一致性</strong>与<strong>执行顺序</strong>规则的一组规范。</p>
<h2 id="备忘录"><a href="#备忘录" class="headerlink" title="备忘录"></a>备忘录</h2><ul>
<li>编程语言保证单线程的“程序顺序一致性”，比如为了防止CPU乱序执行，甚至主动对有依赖关系的变量插入内存屏障。</li>
<li></li>
</ul>
<h2 id="多核缓存"><a href="#多核缓存" class="headerlink" title="多核缓存"></a>多核缓存</h2><p>分层：</p>
<ul>
<li>寄存器：最快，由重命名机制管理</li>
<li>L1&#x2F;L2&#x2F;L3 Cache：核心本地缓存，按缓存行一致性（MESI）维护共享状态</li>
<li>主内存（DRAM）：CPU访问需经总线或内存控制器</li>
</ul>
<table>
<thead>
<tr>
<th>缓存级别</th>
<th>位置</th>
<th>速度（快）</th>
<th>容量（小）</th>
<th>每核私有&#x2F;共享</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>L1 Cache</td>
<td>CPU核心内部</td>
<td>✅最快</td>
<td>❌最小</td>
<td>每核私有</td>
<td>通常分为指令缓存（L1I）和数据缓存（L1D）</td>
</tr>
<tr>
<td>L2 Cache</td>
<td>核心内部或旁边</td>
<td>较快</td>
<td>较小</td>
<td>每核私有或共享</td>
<td>有助于减缓L1未命中后的访问压力</td>
</tr>
<tr>
<td>L3 Cache</td>
<td>核心集群共享</td>
<td>慢一些</td>
<td>更大</td>
<td>多核共享</td>
<td>减少跨核访问主存的延迟，常位于芯片中心</td>
</tr>
<tr>
<td>L4 Cache</td>
<td>一些高端CPU或封装外DRAM</td>
<td>最慢</td>
<td>最大</td>
<td>多芯片共享</td>
<td>非常少见（例如Intel的eDRAM）</td>
</tr>
</tbody></table>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[CPU Core] </span><br><span class="line">   ├── [Load Buffer]  ← 处理 load 指令</span><br><span class="line">   ├── [Store Buffer] ← 处理 store 指令</span><br><span class="line">   ├── [L1 Cache]</span><br><span class="line">   └── [Execution Unit]</span><br><span class="line"></span><br><span class="line">⬇️</span><br><span class="line"></span><br><span class="line">[Shared L2 Cache] / [L3 Cache]</span><br><span class="line"></span><br><span class="line">⬇️</span><br><span class="line"></span><br><span class="line">[Memory Bus] ↔ [Main Memory (DRAM)]</span><br><span class="line"></span><br><span class="line">⬌</span><br><span class="line"></span><br><span class="line">[Other CPU Cores]</span><br></pre></td></tr></table></figure>

<h3 id="Store-Load-Buffer"><a href="#Store-Load-Buffer" class="headerlink" title="Store&#x2F;Load Buffer"></a>Store&#x2F;Load Buffer</h3><ul>
<li><p>Load Buffer：</p>
<ul>
<li>位置：在 CPU 核心内部，靠近 Load&#x2F;Store Unit。</li>
<li>功能：暂存“load”（读取）指令的结果，等待内存或缓存返回数据。</li>
<li>使用场景：比如你访问一个变量 x，如果还没拿到内存值，它就被放在 load buffer 等待。</li>
</ul>
</li>
<li><p>Store Buffer：保存尚未提交的 store 写操作（延迟写回），可被后续 load 查询（store-to-load forwarding）。内存屏障（memory fence）可强制“写入完成后再继续”。</p>
<ul>
<li>位置：同样在 CPU 核心内部，紧挨 Load Buffer。</li>
<li>功能：当执行 x &#x3D; 5 这样的写操作时，并不会立刻写入内存，而是先写入 store buffer。</li>
<li>延迟写回：写操作会被延后，在合适时机批量提交到缓存或主存中。</li>
<li>注意：这就是为什么需要内存屏障（memory fence）来强制“写入完成后再继续”。</li>
</ul>
</li>
</ul>
<p>Store&#x2F;Load Buffer是一个具备调度逻辑的指令队列，不是为了“缓存数据”。<br>之所以叫”Buffer”而不是”Queue”，是强调其“乱序 + 并发调度能力”。</p>
<p>与普通队列的对比：</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>普通队列</th>
<th>Load Buffer</th>
</tr>
</thead>
<tbody><tr>
<td>数据结构</td>
<td>FIFO 队列</td>
<td>类似 CAM（Content Addressable Memory）或乱序数组</td>
</tr>
<tr>
<td>访问方式</td>
<td>一次 pop 一个</td>
<td>任意条目都能被访问、发射、取消</td>
</tr>
<tr>
<td>顺序</td>
<td>严格顺序</td>
<td>支持乱序发射、乱序完成、乱序提交</td>
</tr>
<tr>
<td>功能</td>
<td>暂存数据</td>
<td>追踪地址、状态、与 Store Buffer 比较、rollback 等</td>
</tr>
</tbody></table>
<p>Intel 和 ARM 的实际叫法</p>
<ul>
<li><p>Intel 官方架构手册：</p>
<ul>
<li>用词是 Load Buffer &#x2F; Store Buffer</li>
<li>有时叫 “Memory Ordering Buffer”</li>
</ul>
</li>
<li><p>ARM 架构（如 Cortex-A76）</p>
<ul>
<li>常叫：Load-Store Queue（LSQ）</li>
<li>还会细分为：<ul>
<li>Load Queue（LQ）</li>
<li>Store Queue（SQ）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>但即使叫“Queue”，也不一定是严格的队列行为，而是调度窗口结构。</p>
<h3 id="缓存行（Cache-Line）"><a href="#缓存行（Cache-Line）" class="headerlink" title="缓存行（Cache Line）"></a>缓存行（Cache Line）</h3><ul>
<li>位置：在 CPU 的缓存（L1&#x2F;L2&#x2F;L3）中，缓存是以<strong>行（line）</strong>为单位存储的。</li>
<li>功能：每行通常是 64 字节，它是 CPU 和内存之间最小的同步单位。</li>
<li>状态（MESI 协议）：<ul>
<li>M（Modified）: 修改过，主存未同步</li>
<li>E（Exclusive）: 独占但未修改</li>
<li>S（Shared）: 可共享读取</li>
<li>I（Invalid）: 已失效</li>
</ul>
</li>
</ul>
<h3 id="总线（Memory-Bus-Interconnect）"><a href="#总线（Memory-Bus-Interconnect）" class="headerlink" title="总线（Memory Bus &#x2F; Interconnect）"></a>总线（Memory Bus &#x2F; Interconnect）</h3><ul>
<li>位置：连接多个 CPU 核心、缓存、主存的通信通道。</li>
<li>功能：<ul>
<li>数据在 CPU 和内存之间传输</li>
<li>执行原子操作时用于发送 <code>LOCK#</code> 或缓存一致性请求</li>
</ul>
</li>
</ul>
<p>🔗 示例：Intel 使用 Ring Bus、AMD 使用 Infinity Fabric。</p>
<h3 id="主内存（Main-Memory-DRAM）"><a href="#主内存（Main-Memory-DRAM）" class="headerlink" title="主内存（Main Memory &#x2F; DRAM）"></a>主内存（Main Memory &#x2F; DRAM）</h3><ul>
<li>位置：通常是系统主板上的 DRAM 芯片。</li>
<li>功能：存储所有不在 cache 中的数据，访问速度比 cache 慢很多。</li>
</ul>
<p>🕓 延迟：访问主存通常需要 100ns ~ 几百ns，而访问 L1 Cache 只需几个 cycle。</p>
<h3 id="内存控制器通道与总线的区别"><a href="#内存控制器通道与总线的区别" class="headerlink" title="内存控制器通道与总线的区别"></a>内存控制器通道与总线的区别</h3><table>
<thead>
<tr>
<th>维度</th>
<th>总线（Bus）</th>
<th>内存控制器通道（Memory Channel）</th>
</tr>
</thead>
<tbody><tr>
<td>硬件层级</td>
<td>CPU、缓存、内存之间的共享通信总线</td>
<td>内存控制器内部的通路，直接连接 DRAM 芯片</td>
</tr>
<tr>
<td>作用范围</td>
<td>跨多核、跨缓存，整个系统范围</td>
<td>只负责访问主内存的某一部分，细粒度数据路径</td>
</tr>
<tr>
<td>连接对象</td>
<td>CPU核心、缓存、内存控制器等</td>
<td>内存控制器与物理内存条之间的接口</td>
</tr>
<tr>
<td>作用</td>
<td>传递内存访问请求，实现缓存一致性协议</td>
<td>调度内存读写，执行具体内存命令</td>
</tr>
<tr>
<td>原子操作锁定对象</td>
<td>锁定总线，阻止其他核访问内存</td>
<td>锁定内存通道，防止同通道冲突访问</td>
</tr>
</tbody></table>
<h2 id="乱序执行"><a href="#乱序执行" class="headerlink" title="乱序执行"></a>乱序执行</h2><p>现代 CPU 采用乱序执行（Out-of-Order Execution, OoO）优化性能：</p>
<ul>
<li>发射顺序有序（程序顺序）</li>
<li>执行顺序无序（根据数据&#x2F;资源依赖动态调度）</li>
<li>提交顺序有序（借助 ROB 保证提交的程序语义）</li>
</ul>
<p>核心机制：</p>
<ul>
<li>指令乱序执行：由调度器和执行单元动态决定执行顺序。</li>
<li>寄存器重命名：使用临时物理寄存器消除写后写、写后读冲突。</li>
<li>Load&#x2F;Store Buffer：用于暂存尚未提交的读写操作。</li>
<li>ROB（Reorder Buffer）：按程序顺序提交指令（写入寄存器&#x2F;内存），确保最终结果可预测。</li>
</ul>
<p>程序顺序一致性（program-order consistency）：</p>
<ul>
<li>在本线程中观察到的顺序要“看起来像顺序执行”。</li>
<li><strong>注意：</strong>多线程中可能出现乱序提交。</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">Fetch</span>         &lt;<span class="comment">-- ✅ 顺序取指，从指令缓存中取出下一条指令</span></span><br><span class="line"><span class="number">2.</span> Decode        &lt;<span class="comment">-- 顺序解码，分析操作数和目的寄存器</span></span><br><span class="line"><span class="number">3.</span> <span class="keyword">Rename</span>        &lt;<span class="comment">-- 寄存器重命名</span></span><br><span class="line"><span class="number">4.</span> Dispatch      &lt;<span class="comment">-- 投递到调度窗口，等待执行条件满足</span></span><br><span class="line"><span class="number">5.</span> <span class="keyword">Execute</span>       &lt;<span class="comment">-- ✅ 乱序执行（由调度器决定），实际在执行单元上运行指令</span></span><br><span class="line"><span class="number">6.</span> Writeback     &lt;<span class="comment">-- 写结果到 ROB</span></span><br><span class="line"><span class="number">7.</span> <span class="keyword">Commit</span>        &lt;<span class="comment">-- ✅ 按程序顺序提交（retire），更新寄存器状态或进行内存写入</span></span><br></pre></td></tr></table></figure>

<p>TODO: <strong>内存控制器</strong></p>
<p><strong>扩展：寄存器重命名（Register Renaming）</strong></p>
<p>现代 CPU 为了支持乱序执行（Out-of-Order Execution）和指令级并行（ILP），会引入比架构寄存器更多的物理寄存器，来存储中间值。</p>
<p>寄存器重命名：CPU 用一张 寄存器映射表（Register Alias Table, RAT） 来将架构寄存器映射到物理寄存器。</p>
<ul>
<li>架构寄存器：由 ISA 定义，固定不变。x86-64 是 16 个通用寄存器。</li>
<li>物理寄存器：由具体 CPU 实现，通常远多于架构寄存器。例如：<ul>
<li>Intel 的 Skylake 有 180 个左右物理寄存器（整数+浮点）</li>
<li>ARM 的 Cortex-A 系列也有几百个物理寄存器（实际数量通常保密）</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>物理寄存器</strong>（Physical Register）</td>
<td>CPU 内部实际使用的、很多个</td>
</tr>
<tr>
<td><strong>架构寄存器</strong>（Architectural Register）</td>
<td>程序看到的，例如 RAX、RBX 等，一般只有 16~32 个</td>
</tr>
</tbody></table>
<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MOV RAX, 1</span><br><span class="line">MOV RAX, 2</span><br><span class="line">ADD RAX, 3</span><br></pre></td></tr></table></figure>

<p>执行流程：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>分配的物理寄存器</th>
<th>对应动作</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>RAX → P1</td>
<td>P1 ← 1</td>
</tr>
<tr>
<td>2</td>
<td>RAX → P2</td>
<td>P2 ← 2（与1可并行执行）</td>
</tr>
<tr>
<td>3</td>
<td>用 P2 + 3</td>
<td>写入 P3，RAX → P3</td>
</tr>
</tbody></table>
<p>注意：</p>
<ul>
<li>三条指令都写的是 RAX，但实际上写的是 不同的物理寄存器（P1、P2、P3）</li>
<li>只有最后提交阶段才把 RAX 映射为最终结果的寄存器（P3）</li>
</ul>
<h2 id="内存屏障"><a href="#内存屏障" class="headerlink" title="内存屏障"></a>内存屏障</h2><table>
<thead>
<tr>
<th>屏障类型</th>
<th>会阻止</th>
<th>作用说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>SFENCE</code></td>
<td>Store → Store 重排序</td>
<td>前面的写必须完成再执行后面的写</td>
</tr>
<tr>
<td><code>LFENCE</code></td>
<td>Load → Load 重排序</td>
<td>后面的读必须等前面的读完成</td>
</tr>
<tr>
<td><code>MFENCE</code></td>
<td>所有内存访问</td>
<td>保证前面的 load&#x2F;store 全部完成</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>问题</th>
<th>答案</th>
</tr>
</thead>
<tbody><tr>
<td>内存屏障是运行时插入的吗？</td>
<td>❌ 插入时机是编译期，但运行时会执行它</td>
</tr>
<tr>
<td>屏障如何阻止后面指令提前？</td>
<td>✅ 屏障执行时会强制刷新缓冲区、阻止乱序执行</td>
</tr>
</tbody></table>
<h2 id="缓存一致性协议（MESI）"><a href="#缓存一致性协议（MESI）" class="headerlink" title="缓存一致性协议（MESI）"></a>缓存一致性协议（MESI）</h2><p>MESI 协议的核心操作：</p>
<ul>
<li>读（load）：如果某核 cache 没有，就从主内存或其他核拉一份。</li>
<li>写（store）：必须先让其他核的对应 cache line 失效（invalidate），否则就可能出现数据竞争。</li>
</ul>
<p><strong>atomic（哪怕是 relaxed）为什么会触发 invalidate？</strong></p>
<p>当你写入一个 std::atomic<int>（哪怕是 relaxed）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x.<span class="built_in">store</span>(<span class="number">123</span>, std::memory_order_relaxed);</span><br></pre></td></tr></table></figure>

<ul>
<li>这个 store 会编译为一条特殊的汇编指令（如 MOV 带 lock 前缀，或 STLR, STR 等）</li>
<li>CPU 会发出总线事务（bus transaction）或利用缓存一致性协议 广播这个写入：<ul>
<li>让其他核心中缓存这个变量所在 cache line 的副本 全部失效（Invalidate）</li>
</ul>
</li>
<li>所有核心必须从这个核心或主内存读取最新的值（下一次 load）</li>
</ul>
<h2 id="内存序"><a href="#内存序" class="headerlink" title="内存序"></a>内存序</h2><p>内存序 &#x3D; 程序中读写内存操作的可见顺序。</p>
<p>在理想世界（顺序一致的架构）中，你写的代码顺序就是 CPU 执行和其他线程观察到的顺序。但现实中：</p>
<ul>
<li>CPU 会乱序执行（out-of-order）</li>
<li>编译器会重排指令</li>
<li>缓存系统和 store&#x2F;load buffer 会拖延内存访问</li>
<li>多核之间访问的是缓存，而不是主内存</li>
</ul>
<p>👉 所以，需要有一套规则来定义：“内存操作到底是何时、如何被其他线程看见的”，这就是内存序的目标。</p>
<p>概念 <a target="_blank" rel="noopener" href="https://cppreference.cn/w/cpp/atomic/memory_order">^1</a> <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/atomic/memory_order.html">^2</a>：</p>
<ul>
<li><p><code>load</code>: 从内存<strong>读</strong>变量的值到CPU：内存 ➝ CPU。</p>
</li>
<li><p><code>store</code>: 把一个值从 CPU 的寄存器或处理单元中，<strong>写</strong>到内存中的某个地址（变量）：CPU ➝ 内存。</p>
</li>
<li><p><code>relaxed</code>: 对其他线程的读写没有同步或顺序约束，仅仅保证本操作的原子性。</p>
</li>
<li><p><code>acquire</code>: 对 <code>load</code> 操作的内存序语义约束。</p>
<ul>
<li>当前线程中的任何读写都不能重排序到此 <code>load</code> 之前；</li>
<li>在其他线程中 <code>release</code> 同一原子变量的所有写入在当前线程中可见。</li>
</ul>
</li>
<li><p><code>release</code>: 对 <code>store</code> 操作的内存序语义约束。</p>
<ul>
<li>当前线程中的任何读写都不能重排序到此 <code>store</code> 之后；</li>
<li>当前线程的写入对 <code>acquire</code> 同一原子变量的其他线程可见。</li>
</ul>
</li>
<li><p><code>acquire-release</code>: 对 <code>read-modify-write</code> 操作的内存序语义约束。</p>
<ul>
<li>当前线程中的任何读写不能重排序到此 <code>load</code> 之前，也不能重排序到此 <code>store</code> 之后。</li>
<li>其他线程 <code>release</code> 同一原子变量的写操作，对该 <code>modification</code> 可见；</li>
<li>该 <code>modification</code> 对 <code>acquire</code> 同一原子变量的其他线程可见。</li>
</ul>
</li>
<li><p><code>sequentially-consistent</code>: </p>
<ul>
<li><code>load</code> 操作遵循 <code>acquire</code> 语义；</li>
<li><code>store</code> 操作遵循 <code>release</code> 语义；</li>
<li><code>read-modify-write</code> 操作同时遵循 <code>acquire</code> 和 <code>release</code> 语义；</li>
<li>存在一个全序，其中所有线程都以相同的顺序观察所有修改。</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>内存序</th>
<th>插入屏障</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>relaxed</td>
<td>❌ 无</td>
<td>只保证原子性，不保证顺序</td>
</tr>
<tr>
<td>acquire</td>
<td>✅ 读屏障</td>
<td>阻止后续操作提前</td>
</tr>
<tr>
<td>release</td>
<td>✅ 写屏障</td>
<td>阻止前面操作延后</td>
</tr>
<tr>
<td>acquire-release</td>
<td>✅ 两者都有</td>
<td>双向有序</td>
</tr>
<tr>
<td>seq_cst</td>
<td>✅ 全屏障</td>
<td>全局顺序一致性</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>步骤</th>
<th>普通变量</th>
<th>atomic（relaxed）</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>编译器可优化</td>
<td>编译器必须保留这个操作</td>
</tr>
<tr>
<td>2</td>
<td>CPU 可能重排</td>
<td>CPU 仍可能重排（因为是 relaxed）</td>
</tr>
<tr>
<td>3</td>
<td>缓存写入</td>
<td>可能停在本核 cache 中，不通知他人</td>
</tr>
<tr>
<td>4</td>
<td>不触发 invalidate</td>
<td>✅ 会触发 cache line invalidate</td>
</tr>
<tr>
<td>5</td>
<td>其他线程可见性低</td>
<td>✅ 其他线程可读取到最新的值（但时序不保证）</td>
</tr>
</tbody></table>
<p><strong>私注：</strong> </p>
<ul>
<li><code>acquire</code>: 当本线程读取后，本线程之后的操作都可以依赖这次读取（“后面的读写不得提前”）；</li>
<li><code>release</code>: 当本线程允许写后，本线程之前的读写都完成了，即之后的操作都可以依赖此前的写入（“前面的读写不得滞后”）。</li>
</ul>
<p><strong>和普通变量相比，atomic<T>（即使是 relaxed）做了哪些额外工作？</strong></p>
<p>atomic<T>（即使使用 memory_order_relaxed）和普通变量相比，最核心的区别是：原子变量保证原子性（atomicity）和可见性，而普通变量不能。</p>
<ul>
<li><p>保证操作的原子性</p>
<blockquote>
<p>所谓“原子性”，是指某个操作（如 load、store、CAS）要么全部完成、要么完全不做，不会出现中间状态。</p>
</blockquote>
<ul>
<li><p>atomic<int> x;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x.<span class="built_in">store</span>(<span class="number">42</span>, std::memory_order_relaxed);</span><br></pre></td></tr></table></figure>

<p>这个 store 是原子的：不会被打断、不会被分拆。</p>
</li>
<li><p>普通变量可能被编译器或 CPU 拆成多条指令（比如低 4 字节和高 4 字节分开发），多线程下可能看到“半成品”状态。</p>
</li>
</ul>
</li>
<li><p>触发 CPU 的 cache coherence 协议（MESI等）</p>
<blockquote>
<p>原子变量的访问会参与硬件层的缓存一致性协议，以保证多核 CPU 看到一致的值。</p>
</blockquote>
<ul>
<li>即使是 relaxed，store 也会触发对应 cache line 的写入通知（invalidate）；</li>
<li>普通变量（非 volatile、非 atomic）的访问，编译器会缓存到寄存器中，不一定会回写。</li>
</ul>
</li>
<li><p>禁止编译器优化（只针对原子变量本身）</p>
<blockquote>
<p>编译器不能将多个 atomic store 合并，也不能删去它（不会当作“死代码”）。</p>
</blockquote>
<ul>
<li><p>x.store(42, relaxed) 每次都必须发出一条指令；</p>
</li>
<li><p>对普通变量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">42</span>;</span><br><span class="line">x = <span class="number">43</span>;</span><br></pre></td></tr></table></figure>

<p>可能直接编译为 <code>x = 43;</code>，前一条被优化掉。</p>
</li>
</ul>
</li>
</ul>
<p><strong>atomic&lt;T, relaxed&gt; 不做的事：</strong></p>
<table>
<thead>
<tr>
<th>功能</th>
<th>atomic(relaxed)</th>
<th>普通变量</th>
</tr>
</thead>
<tbody><tr>
<td>保证<strong>原子性</strong></td>
<td>✅ 是</td>
<td>❌ 否</td>
</tr>
<tr>
<td>保证<strong>可见性（跨线程）</strong></td>
<td>✅ 是（通过 cache 协议）</td>
<td>❌ 否</td>
</tr>
<tr>
<td>禁止<strong>指令重排</strong>（保证顺序）</td>
<td>❌ 否（只 relaxed）</td>
<td>❌ 否</td>
</tr>
</tbody></table>
<h3 id="屏障为什么要设置两种？"><a href="#屏障为什么要设置两种？" class="headerlink" title="屏障为什么要设置两种？"></a>屏障为什么要设置两种？</h3><p>性能优化 + 最小化开销 + 精确控制重排序方向。</p>
<p>屏障的本质是“控制指令重排序”<br>但它并不一刀切地“全部阻止”，而是：</p>
<table>
<thead>
<tr>
<th>屏障类型</th>
<th>阻止的方向（简化理解）</th>
</tr>
</thead>
<tbody><tr>
<td><strong>读屏障</strong></td>
<td>阻止 <strong>读-after-读</strong> 重排序（即前面的读取不能晚于后面的读取）</td>
</tr>
<tr>
<td><strong>写屏障</strong></td>
<td>阻止 <strong>写-after-写</strong> 重排序（即前面的写不能晚于后面的写）</td>
</tr>
<tr>
<td><strong>全屏障</strong></td>
<td>阻止 <strong>读&#x2F;写 与 所有后续指令的重排序</strong></td>
</tr>
</tbody></table>
<p>为什么分开这么细？（硬件视角）</p>
<p>现代 CPU 架构（如 x86, ARM）中：</p>
<ul>
<li><p>读和写通路是分离的</p>
<ul>
<li>读用 load buffer</li>
<li>写用 store buffer</li>
</ul>
</li>
<li><p>两者乱序的模式、处理机制、性能代价都不同！</p>
</li>
</ul>
<p>所以，硬件支持你只加读屏障（LFENCE）或写屏障（SFENCE），能以更小代价完成你想要的顺序语义。</p>
<p>举例：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>屏障类型</th>
<th>效果</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>等 <code>flag==1</code> 后再读取 data</td>
<td><strong>读屏障</strong></td>
<td>禁止 <code>data = ?</code> 提前执行</td>
<td>load-acquire fence</td>
</tr>
<tr>
<td><code>data=42</code> 后，才写 <code>flag=1</code></td>
<td><strong>写屏障</strong></td>
<td>禁止 <code>flag=1</code> 提前写出</td>
<td>store-release fence</td>
</tr>
<tr>
<td>多线程通信中，强一致顺序</td>
<td><strong>全屏障</strong></td>
<td>所有读写顺序完全禁止重排</td>
<td>x86 <code>MFENCE</code></td>
</tr>
</tbody></table>
<ul>
<li>你可以只阻止读乱序 → 读屏障</li>
<li>你可以只阻止写乱序 → 写屏障</li>
<li>你可以全部阻止 → 全屏障</li>
</ul>
<h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><table>
<thead>
<tr>
<th>层次</th>
<th>机制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>指令层</td>
<td>原子指令（如 <code>lock cmpxchg</code>、<code>xadd</code>、<code>ldrex/strex</code>）</td>
<td>提供不可中断的执行</td>
</tr>
<tr>
<td>缓存层</td>
<td>MESI 协议</td>
<td>保证多个CPU缓存数据一致</td>
</tr>
<tr>
<td>总线层</td>
<td>总线锁定（旧方式）</td>
<td>强制所有核等待该操作完成</td>
</tr>
<tr>
<td>内存层</td>
<td>内存屏障</td>
<td>保证内存操作顺序正确可见</td>
</tr>
</tbody></table>
<h3 id="CPU的原子指令如何实现的？"><a href="#CPU的原子指令如何实现的？" class="headerlink" title="CPU的原子指令如何实现的？"></a>CPU的原子指令如何实现的？</h3><p>CPU 的原子指令是在硬件微架构层面通过微操作（micro-ops）调度、缓存控制、总线协议协调等机制联合实现的。我们可以从以下几个层面来详细剖析：</p>
<h4 id="微架构层面：锁住特定资源"><a href="#微架构层面：锁住特定资源" class="headerlink" title="微架构层面：锁住特定资源"></a>微架构层面：锁住特定资源</h4><p>当执行原子指令时，CPU 内部会采取 锁定机制，确保该操作的所有子步骤在执行时不会被打断。</p>
<ul>
<li>对于访问内存的原子操作，CPU 会尝试锁定：<ul>
<li>缓存行（现代 CPU）</li>
<li>或内存总线（旧 CPU）</li>
</ul>
</li>
</ul>
<p>以 x86 的 LOCK CMPXCHG 为例，它内部其实是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mem == eax) &#123;</span><br><span class="line">    mem = reg;</span><br><span class="line">    ZF = <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    eax = mem;</span><br><span class="line">    ZF = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个流程在硬件中不是三条指令，而是一个专门的微操作指令组合包，称为“fused micro-op”，由 CPU 保证“执行期间中断关闭、禁止抢占”。</p>
<h4 id="缓存一致性协议（MESI）保障原子性"><a href="#缓存一致性协议（MESI）保障原子性" class="headerlink" title="缓存一致性协议（MESI）保障原子性"></a>缓存一致性协议（MESI）保障原子性</h4><p>原子指令通常访问共享变量，这就需要解决缓存一致性问题。</p>
<p>举例：两个 CPU 都缓存了某个共享变量的值<br>当 CPU1 执行原子写入（例如 lock xadd）时：</p>
<p>CPU1 会尝试将该缓存行从 Shared → Modified 状态</p>
<p>MESI 协议要求其他 CPU（如 CPU2）将该缓存行标记为 Invalid</p>
<p>一旦独占，CPU1 就能安全完成读-改-写过程</p>
<p>这种方式实现了 原子访问缓存行。</p>
<h4 id="总线或互联互锁（bus-lock-interconnect-lock）"><a href="#总线或互联互锁（bus-lock-interconnect-lock）" class="headerlink" title="总线或互联互锁（bus lock &#x2F; interconnect lock）"></a>总线或互联互锁（bus lock &#x2F; interconnect lock）</h4><p>对于不在缓存中的内存地址（如非一致内存访问 NUMA、I&#x2F;O 内存等），现代 CPU 仍可能退回到：</p>
<ul>
<li>总线锁定（Bus Lock）</li>
<li>内存控制器互锁（memory interconnect lock）</li>
</ul>
<p>比如 x86 的 lock 前缀会让 CPU 发出 LOCK# 信号，告诉其他核暂时禁止访问这段地址。</p>
<p>这是一种慢但可靠的 fallback 机制，避免跨节点访问带来的竞态。</p>
<h4 id="禁止乱序与流水线干预"><a href="#禁止乱序与流水线干预" class="headerlink" title="禁止乱序与流水线干预"></a>禁止乱序与流水线干预</h4><p>现代 CPU 为了性能采用乱序执行（Out-of-Order Execution）和流水线（Pipelining）机制。但原子操作必须：</p>
<ul>
<li>执行期间不得乱序</li>
<li>禁止乱序缓存访问（如 Store Buffer 提前写入）</li>
<li>强制所有早于它的读写完成，之后的读写等待</li>
</ul>
<p>这依赖于：</p>
<ul>
<li>微指令插入内存屏障（memory fence）</li>
<li>暂停 load&#x2F;store buffer 的重排</li>
<li>Flush pipeline &#x2F; reorder buffer</li>
</ul>
<p>这就是为什么原子操作通常比普通操作要慢的原因之一。</p>
<h4 id="例子：lock-cmpxchg-的硬件执行流程"><a href="#例子：lock-cmpxchg-的硬件执行流程" class="headerlink" title="例子：lock cmpxchg 的硬件执行流程"></a>例子：lock cmpxchg 的硬件执行流程</h4><p>假设 CPU1 执行 lock cmpxchg [X], eax，大致流程如下：</p>
<ul>
<li>CPU1 发出 LOCK# 信号或锁住缓存行 X（取决于地址是否在 cache）</li>
<li>向 MESI 控制器发请求，抢占地址 X 的 cache line 独占权限</li>
<li>在其他核心收到 invalidation 后，CPU1 获得修改权限</li>
<li>CPU1 比较 X 与 eax 的值，如果相等则更新为新值</li>
<li>完成后通知 MESI controller，X 的状态设为 Modified</li>
<li>操作结束，缓存一致性仍然维护</li>
</ul>
<p>整个过程是由硬件控制单元（Load&#x2F;Store Queue、Execution Unit、Bus Interface Unit）协调完成的。</p>
<h4 id="小结：CPU-实现原子操作的关键机制"><a href="#小结：CPU-实现原子操作的关键机制" class="headerlink" title="小结：CPU 实现原子操作的关键机制"></a>小结：CPU 实现原子操作的关键机制</h4><table>
<thead>
<tr>
<th>机制</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>原子指令（如 <code>lock cmpxchg</code>, <code>ldrex/strex</code>）</td>
<td>提供原子读-改-写</td>
</tr>
<tr>
<td>微操作调度锁定资源</td>
<td>保证在流水线中不可拆分</td>
</tr>
<tr>
<td>MESI 协议</td>
<td>多核共享缓存一致性</td>
</tr>
<tr>
<td>总线锁或互联锁</td>
<td>防止跨核心或I&#x2F;O地址出现竞态</td>
</tr>
<tr>
<td>内存屏障 &amp; 禁止乱序</td>
<td>防止指令与缓存失序访问</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/01/concurrency/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/01/concurrency/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2/" class="post-title-link" itemprop="url">线程状态转换</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-01 12:18:07" itemprop="dateCreated datePublished" datetime="2025-08-01T12:18:07+00:00">2025-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h2><ul>
<li>New（新建）：线程对象刚创建，还未开始执行。</li>
<li>Ready（就绪）：线程准备好运行，等待调度器分配 CPU。</li>
<li>Running（运行）：线程正在使用 CPU 执行指令。</li>
<li>Blocked（阻塞）：线程在等待某个事件（如 I&#x2F;O、锁、条件变量等），不能运行。</li>
<li>Terminated（终止）：线程执行完毕或被强制结束。</li>
<li>Sleeping（休眠）：线程主动暂停一段时间（如 sleep()），不能被调度。</li>
</ul>
<h2 id="线程状态转换图"><a href="#线程状态转换图" class="headerlink" title="线程状态转换图"></a>线程状态转换图</h2><table>
<thead>
<tr>
<th>当前状态</th>
<th>触发条件</th>
<th>转换后状态</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>New</td>
<td>调用 start() 或 std::thread 构造函数</td>
<td>Ready</td>
<td>线程被创建，等待调度</td>
</tr>
<tr>
<td>Ready</td>
<td>被调度器选中</td>
<td>Running</td>
<td>获得 CPU，开始执行</td>
</tr>
<tr>
<td>Running</td>
<td>时间片耗尽 &#x2F; yield()</td>
<td>Ready</td>
<td>主动或被动让出 CPU，重新排队</td>
</tr>
<tr>
<td>Running</td>
<td>调用 sleep() &#x2F; wait() &#x2F; 等待锁</td>
<td>Blocked &#x2F; Sleeping</td>
<td>线程不能继续执行，等待事件或时间</td>
</tr>
<tr>
<td>Blocked &#x2F; Sleeping</td>
<td>条件满足 &#x2F; 时间到</td>
<td>Ready</td>
<td>线程重新具备运行条件，等待调度</td>
</tr>
<tr>
<td>Running</td>
<td>执行结束或异常</td>
<td>Terminated</td>
<td>线程生命周期结束</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">性能分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 15:43:15" itemprop="dateCreated datePublished" datetime="2025-07-31T15:43:15+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h2><h3 id="CPU时间"><a href="#CPU时间" class="headerlink" title="CPU时间"></a>CPU时间</h3><p><strong>函数调用的 CPU 时间:</strong></p>
<ul>
<li><code>Inclusive time</code>: total cpu time, include all functions it calls.</li>
<li><code>Exclusive time</code>: only the time used by the function itself, exclusive all its children.</li>
</ul>
<p>Refer to <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15760447/what-is-the-meaning-of-incl-cpu-time-excl-cpu-time-incl-real-cpu-time-excl-re/74426370">here</a>.</p>
<ol>
<li><p>Wall time: total time the process used, containing IO time.</p>
</li>
<li><p>CPU usage (CPU利用率) &#x3D; CPU time &#x2F; Wall time.</p>
</li>
<li><p>real&#x2F;user&#x2F;system time</p>
<ul>
<li><strong>Real</strong> is wall clock time - time from start to finish of the call. This is all elapsed time including time slices used by other processes and time the process spends blocked (for example if it is waiting for I&#x2F;O to complete).</li>
<li><strong>User</strong> is the amount of CPU time spent in user-mode code (outside the kernel) within the process. This is only actual CPU time used in executing the process. Other processes and time the process spends blocked do not count towards this figure.</li>
<li><strong>Sys</strong> is the amount of CPU time spent in the kernel within the process. This means executing CPU time spent in system calls within the kernel, as opposed to library code, which is still running in user-space. Like ‘user’, this is only CPU time used by the process. See below for a brief description of kernel mode (also known as ‘supervisor’ mode) and the system call mechanism.</li>
</ul>
<p> Refer to <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/556405/what-do-real-user-and-sys-mean-in-the-output-of-time1">here</a>.</p>
</li>
<li><p>CPU 时间可能大于墙上时间：</p>
<p>这是因为 CPU 时间是所有 CPU 核的运行时间的累加和，墙上时间则是实际的时间。此时 CPU 利用率大于 100%. （这是自己的理解）</p>
</li>
<li><p>TODO: Is CPU time in <em>flame graph</em> sum of all the CPU time? Or is it the wall time when CPU works?</p>
</li>
</ol>
<h3 id="计时工具：timer"><a href="#计时工具：timer" class="headerlink" title="计时工具：timer"></a>计时工具：<code>timer</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/time -p <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>Or,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ time <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>其中（参考<a target="_blank" rel="noopener" href="https://ostechnix.com/how-to-find-the-execution-time-of-a-command-or-process-in-linux/">链接</a>），</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">type</span> -a time</span><br><span class="line">time is a shell keyword</span><br><span class="line">time is /usr/bin/time</span><br></pre></td></tr></table></figure>


<h2 id="分析工具"><a href="#分析工具" class="headerlink" title="分析工具"></a>分析工具</h2><ul>
<li>Performance Analyzer</li>
<li>Thread Analyzer</li>
<li>gprof</li>
<li>DDT&#x2F;gdb</li>
</ul>
<h3 id="Performance-Analyzer"><a href="#Performance-Analyzer" class="headerlink" title="Performance Analyzer"></a>Performance Analyzer</h3><p>Oracle Developer Studio 提供了多种工具：Performance Analyzer、Thread Analyzer。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afagg.html#OSSPAgrkam">Performance Analyzer 官方文档</a></p>
</blockquote>
<p><strong>1. 收集数据</strong></p>
<p>使用 <code>collect</code> 命令收集数据（<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afadn.html#scrolltoc">官方文档</a>）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collect collect-options program program-arguments</span><br></pre></td></tr></table></figure>

<p><strong>2. 开始性能分析</strong></p>
<p>使用 <code>analyzer</code> 命令进行性能分析（<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afafs.html#scrolltoc">官方文档</a>）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">analyzer [control-options] [experiment | experiment-list]</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">analyzer -c test.1.er test.4.er</span><br></pre></td></tr></table></figure>

<h3 id="Thread-Analyzer"><a href="#Thread-Analyzer" class="headerlink" title="Thread Analyzer"></a>Thread Analyzer</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/application-development/technologies/developerstudio-features.html#thread-analyzer-tab">Thread Analyzer 官方文档</a></p>
</blockquote>
<h3 id="gprof"><a href="#gprof" class="headerlink" title="gprof"></a>gprof</h3><p>gprof(GNU profiler)是GNU binutils工具集中的一个工具，linux系统当中会自带这个工具。它可以分析程序的性能，能给出函数调用时间、调用次数和调用关系，找出程序的瓶颈所在。在编译和链接选项中都加入-pg之后，gcc会在每个函数中插入代码片段，用于记录函数间的调用关系和调用次数，并采集函数的调用时间。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ftp.gnu.org/old-gnu/Manuals/gprof-2.9.1/html_mono/gprof.html">gprof官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/luronggui/article/-details/118141262">使用方法</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385842627">博客</a></li>
</ul>
<h3 id="DDT"><a href="#DDT" class="headerlink" title="DDT"></a>DDT</h3><p><a target="_blank" rel="noopener" href="https://www.linaroforge.com/linaroDdt">DDT</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E6%B7%B7%E5%90%88%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E6%B7%B7%E5%90%88%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">混合编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 15:29:32" itemprop="dateCreated datePublished" datetime="2025-07-31T15:29:32+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>“Hybrid Build”（混合构建）是指一种 兼顾调试能力与运行性能 的构建方式，常用于需要在 Release 环境中进行问题分析，但又不能完全使用 Debug 构建的场景。</p>
<h3 id="🧩-Hybrid-Build-的核心特征"><a href="#🧩-Hybrid-Build-的核心特征" class="headerlink" title="🧩 Hybrid Build 的核心特征"></a>🧩 Hybrid Build 的核心特征</h3><table>
<thead>
<tr>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>优化等级</td>
<td>使用 -O2 或 -O3，保持接近 Release 的性能</td>
</tr>
<tr>
<td>调试信息</td>
<td>保留 -g，生成 DWARF 调试符号，便于分析 core dump 或使用 gdb</td>
</tr>
<tr>
<td>符号表</td>
<td>可选开启 -fno-omit-frame-pointer，便于栈回溯</td>
</tr>
<tr>
<td>日志&#x2F;保护机制</td>
<td>可嵌入轻量级日志、ASAN-lite、canary 等机制，增强可观测性</td>
</tr>
<tr>
<td>部署策略</td>
<td>仅在内部或特定客户环境中使用，避免暴露完整源码结构或调试符号</td>
</tr>
</tbody></table>
<p>✅ 编译示例（GCC&#x2F;Clang）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -O2 -g -fno-omit-frame-pointer -DNDEBUG -o your_program main.cpp</span><br></pre></td></tr></table></figure>

<ul>
<li>-O2：优化代码，接近 Release 性能</li>
<li>-g：保留调试信息</li>
<li>-fno-omit-frame-pointer：保留帧指针，便于栈追踪</li>
<li>-DNDEBUG：关闭断言（assert）</li>
</ul>
<h3 id="🎯-使用场景"><a href="#🎯-使用场景" class="headerlink" title="🎯 使用场景"></a>🎯 使用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>是否推荐使用 Hybrid Build</th>
<th>原因说明</th>
</tr>
</thead>
<tbody><tr>
<td>客户现场复现崩溃</td>
<td>✅</td>
<td>可通过 core dump + 符号表快速定位问题</td>
</tr>
<tr>
<td>内部性能测试</td>
<td>✅</td>
<td>保持优化效果，同时可调试</td>
</tr>
<tr>
<td>正式发布给客户（大规模部署）</td>
<td>❌</td>
<td>不建议，可能暴露符号信息，体积较大</td>
</tr>
<tr>
<td>与 ASAN&#x2F;TSAN 联合使用</td>
<td>⚠️（需关闭优化）</td>
<td>ASAN&#x2F;TSAN 更适合 Debug 构建，Hybrid 会影响检测精度</td>
</tr>
</tbody></table>
<h3 id="🛠️-实践建议"><a href="#🛠️-实践建议" class="headerlink" title="🛠️ 实践建议"></a>🛠️ 实践建议</h3><ul>
<li>符号分离：使用 <code>objcopy --only-keep-debug</code> 分离调试符号，避免暴露给客户。</li>
<li>符号服务器：内部维护符号服务器，支持通过 core 文件自动符号化。</li>
<li>结合日志框架：Hybrid Build 可与轻量级日志框架结合，增强问题定位能力。</li>
</ul>
<h2 id="符号分离（Split-Debug-Info）"><a href="#符号分离（Split-Debug-Info）" class="headerlink" title="符号分离（Split Debug Info）"></a>符号分离（Split Debug Info）</h2><p><strong>✅ 为什么要分离？</strong></p>
<ul>
<li>Release 版本：体积小，性能高，但缺少调试信息</li>
<li>调试符号文件：保留完整符号信息，用于内部分析 core dump</li>
</ul>
<p><strong>🛠️ 分离流程（以 GCC&#x2F;Clang 为例）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译时保留调试信息</span></span><br><span class="line">g++ -O2 -g -o your_program main.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分离调试符号</span></span><br><span class="line">objcopy --only-keep-debug your_program your_program.debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除主程序中的调试信息</span></span><br><span class="line">strip --strip-debug --strip-unneeded your_program</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加调试符号关联信息</span></span><br><span class="line">objcopy --add-gnu-debuglink=your_program.debug your_program</span><br></pre></td></tr></table></figure>

<p><strong>✅ 最终产物：</strong></p>
<ul>
<li>your_program：可交付给客户的 Release 可执行文件</li>
<li>your_program.debug：内部使用的调试符号文件</li>
</ul>
<h2 id="core-dump-分析"><a href="#core-dump-分析" class="headerlink" title="core dump 分析"></a>core dump 分析</h2><p><strong>1. 客户侧设置 core dump</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br></pre></td></tr></table></figure>

<p><strong>2. 客户运行程序并生成 core 文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./your_program crash_input.txt</span><br><span class="line"><span class="comment"># 程序崩溃后生成 core 文件，如 core.12345</span></span><br></pre></td></tr></table></figure>

<p><strong>3. 客户提供 core 文件 + 可执行文件</strong></p>
<ul>
<li>core.12345</li>
<li>your_program（Release 版本）</li>
</ul>
<p><strong>4. 你在内部分析 core 文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb your_program core.12345</span><br><span class="line"><span class="comment"># 加载调试符号</span></span><br><span class="line">(gdb) symbol-file your_program.debug</span><br><span class="line">(gdb) bt  <span class="comment"># 查看调用栈</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">内存分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 14:53:40" itemprop="dateCreated datePublished" datetime="2025-07-31T14:53:40+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>valgrind 是一个强大的内存调试和性能分析工具，它的不同子工具用于不同的分析目的。<code>--memcheck</code> 和 <code>--massif</code> 是其中两个常用的工具。</p>
<p>ASAN（AddressSanitizer） 和 TSAN（ThreadSanitizer） 都是由现代编译器（如 Clang 和 GCC）提供的 运行时检测工具，用于帮助开发者在开发阶段发现内存错误和线程问题。</p>
<ul>
<li>Clang：全面支持 ASAN 和 TSAN</li>
<li>GCC：也支持，但 TSAN 的支持略逊于 Clang</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://jvns.ca/blog/2018/04/28/debugging-a-segfault-on-linux/">博客：How to get a core dump for a segfault on Linux</a></p>
<h3 id="Memcheck：内存错误检查工具"><a href="#Memcheck：内存错误检查工具" class="headerlink" title="Memcheck：内存错误检查工具"></a>Memcheck：内存错误检查工具</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://valgrind.org/docs/manual/mc-manual.html">4. Memcheck: a memory error detector</a></p>
<ul>
<li>用途：检测内存相关的错误，如内存泄漏、越界访问、未初始化内存读取等。</li>
<li>适用场景：调试程序中的内存错误，确保程序的内存使用是安全的。</li>
<li>输出内容：<ul>
<li>哪些内存没有释放（内存泄漏）</li>
<li>哪些内存被非法访问（越界、未初始化等）</li>
<li>哪些内存访问是未定义行为</li>
</ul>
</li>
<li>常用命令：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valgrind --tool=memcheck ./your_program</span><br></pre></td></tr></table></figure>

<h3 id="Massif：堆内存使用分析工具"><a href="#Massif：堆内存使用分析工具" class="headerlink" title="Massif：堆内存使用分析工具"></a>Massif：堆内存使用分析工具</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://valgrind.org/docs/manual/ms-manual.html">9. Massif: a heap profiler</a></p>
<ul>
<li>用途：分析程序在运行过程中堆内存的使用情况，帮助优化内存占用。</li>
<li>适用场景：性能分析，找出内存占用高的代码路径或数据结构。</li>
<li>输出内容：<ul>
<li>堆内存使用随时间的变化（快照）：需用 <code>ms_print</code> 或 <a target="_blank" rel="noopener" href="https://courses.cs.washington.edu/courses/cse326/05wi/valgrind-doc/ms_main.html">PostScript Viewer</a> 查看</li>
<li>哪些函数或调用路径分配了最多的内存</li>
<li>常用命令：</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">valgrind --tool=massif ./your_program</span><br><span class="line">ms_print massif.out.&lt;pid&gt;</span><br></pre></td></tr></table></figure>

<p><strong>🆚 Memcheck vs Massif 对比总结</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th><code>--memcheck</code></th>
<th><code>--massif</code></th>
</tr>
</thead>
<tbody><tr>
<td>工具类型</td>
<td>内存错误检查工具</td>
<td>堆内存使用分析工具</td>
</tr>
<tr>
<td>主要用途</td>
<td>检查内存泄漏、越界访问、未初始化读取等</td>
<td>分析堆内存使用趋势和峰值</td>
</tr>
<tr>
<td>检测内存泄漏</td>
<td>✅</td>
<td>❌（不直接检测）</td>
</tr>
<tr>
<td>分析内存增长趋势</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td>输出格式</td>
<td>错误报告（文本）</td>
<td>内存快照（需用 <code>ms_print</code> 查看）</td>
</tr>
<tr>
<td>性能开销</td>
<td>高（运行速度变慢）</td>
<td>中等</td>
</tr>
</tbody></table>
<h3 id="ThreadSanitizer（TSAN）"><a href="#ThreadSanitizer（TSAN）" class="headerlink" title="ThreadSanitizer（TSAN）"></a>ThreadSanitizer（TSAN）</h3><ul>
<li>用途：检测多线程程序中的 数据竞争（data race） 和其他线程同步问题。</li>
<li>适用场景：并发程序调试，尤其是当多个线程访问共享变量时。</li>
<li>检测内容：<ul>
<li>数据竞争（两个线程同时访问同一变量，且至少一个是写操作）</li>
<li>锁使用错误（死锁、双重解锁等）</li>
</ul>
</li>
<li>启用方式（Clang&#x2F;GCC）：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fsanitize=thread -g your_program.c -o your_program</span><br></pre></td></tr></table></figure>

<h3 id="AddressSanitizer（ASAN）"><a href="#AddressSanitizer（ASAN）" class="headerlink" title="AddressSanitizer（ASAN）"></a>AddressSanitizer（ASAN）</h3><p><a target="_blank" rel="noopener" href="https://github.com/google/sanitizers/wiki/AddressSanitizer">AddressSanitizer 文档</a></p>
<ul>
<li>用途：检测内存访问错误。</li>
<li>适用场景：单线程或多线程程序中调试内存问题。</li>
<li>检测内容：<ul>
<li>越界访问（stack&#x2F;heap&#x2F;global）</li>
<li>use-after-free（释放后使用）</li>
<li>内存泄漏（可选）</li>
<li>use-after-scope（作用域结束后使用局部变量）</li>
</ul>
</li>
<li>启用方式：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fsanitize=address -g your_program.c -o your_program</span><br></pre></td></tr></table></figure>

<p><strong>🆚 TSAN vs ASAN 对比总结</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>TSAN（ThreadSanitizer）</th>
<th>ASAN（AddressSanitizer）</th>
</tr>
</thead>
<tbody><tr>
<td>检测目标</td>
<td>多线程数据竞争</td>
<td>内存访问错误</td>
</tr>
<tr>
<td>是否支持多线程</td>
<td>✅（专为多线程设计）</td>
<td>✅（支持，但不检测数据竞争）</td>
</tr>
<tr>
<td>性能开销</td>
<td>较高（10x~40x）</td>
<td>中等（2x~3x）</td>
</tr>
<tr>
<td>内存开销</td>
<td>中等</td>
<td>较高（增加约2倍内存使用）</td>
</tr>
<tr>
<td>是否检测内存泄漏</td>
<td>❌（不检测）</td>
<td>✅（可选开启）</td>
</tr>
<tr>
<td>是否检测数据竞争</td>
<td>✅</td>
<td>❌</td>
</tr>
</tbody></table>
<p><strong>🆚 Memcheck vs Massif vs TSAN vs ASAN 对比总结</strong></p>
<table>
<thead>
<tr>
<th>工具名称</th>
<th>类型</th>
<th>主要用途</th>
<th>检测内容</th>
<th>是否支持多线程</th>
<th>性能开销</th>
<th>内存开销</th>
<th>是否检测内存泄漏</th>
<th>是否检测数据竞争</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Memcheck</strong></td>
<td>Valgrind 工具</td>
<td>内存错误检测</td>
<td>内存泄漏、越界访问、未初始化读取、非法释放等</td>
<td>✅（有限支持）</td>
<td>高（10x+）</td>
<td>高</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td><strong>Massif</strong></td>
<td>Valgrind 工具</td>
<td>堆内存使用分析</td>
<td>堆内存分配趋势、内存峰值、调用路径分析</td>
<td>✅</td>
<td>中等</td>
<td>中等</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td><strong>ASAN</strong></td>
<td>编译器工具</td>
<td>内存访问错误检测</td>
<td>越界访问、use-after-free、use-after-scope、内存泄漏（可选）</td>
<td>✅</td>
<td>中等（2x~3x）</td>
<td>高（约2倍）</td>
<td>✅（可选）</td>
<td>❌</td>
</tr>
<tr>
<td><strong>TSAN</strong></td>
<td>编译器工具</td>
<td>多线程数据竞争检测</td>
<td>数据竞争、死锁、错误的锁使用等</td>
<td>✅（强支持）</td>
<td>高（5x~40x）</td>
<td>中等</td>
<td>❌</td>
<td>✅</td>
</tr>
</tbody></table>
<h2 id="UBSan-Unifined-Behavior-Sanitizer"><a href="#UBSan-Unifined-Behavior-Sanitizer" class="headerlink" title="UBSan (Unifined Behavior Sanitizer)"></a>UBSan (Unifined Behavior Sanitizer)</h2><table>
<thead>
<tr>
<th>Sanitizer</th>
<th>检测内容</th>
<th>Google 贡献</th>
</tr>
</thead>
<tbody><tr>
<td>ASAN</td>
<td>内存访问错误</td>
<td>✅ 是</td>
</tr>
<tr>
<td>UBSan</td>
<td>未定义行为</td>
<td>✅ 是</td>
</tr>
<tr>
<td>TSAN</td>
<td>数据竞争</td>
<td>✅ 是</td>
</tr>
<tr>
<td>MSAN</td>
<td>未初始化内存使用</td>
<td>✅ 是</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/9/">9</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bi-an"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">bi-an</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bi-an" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;bi-an" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ah_zzg@126.com" title="E-Mail → mailto:ah_zzg@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://bi-an.github.io/" title="http:&#x2F;&#x2F;bi-an.github.io">bi-an's Page</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bi-an</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

</body>
</html>
