<!DOCTYPE html>
<html lang="en, zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bi-an.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:url" content="https://bi-an.github.io/blog/index.html">
<meta property="og:site_name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:locale">
<meta property="article:author" content="bi-an">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bi-an.github.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en, zh_CN'
  };
</script>

  <title>æ±Ÿå—äººç‰©çš„åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æ±Ÿå—äººç‰©çš„åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/blog/resources/" rel="section"><i class="fa fa-paperclip fa-fw"></i>Resource</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/18/cpp/%E7%BC%96%E8%AF%91%E6%97%B6%E9%93%BE%E6%8E%A5%E5%92%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E9%93%BE%E6%8E%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/18/cpp/%E7%BC%96%E8%AF%91%E6%97%B6%E9%93%BE%E6%8E%A5%E5%92%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E9%93%BE%E6%8E%A5/" class="post-title-link" itemprop="url">ç¼–è¯‘æ—¶é“¾æ¥å’Œè¿è¡Œæ—¶é“¾æ¥</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-09-18 18:57:08 / Modified: 13:06:21" itemprop="dateCreated datePublished" datetime="2025-09-18T18:57:08+00:00">2025-09-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="è¿è¡Œæ—¶-so-çš„åŠ è½½é¡ºåº"><a href="#è¿è¡Œæ—¶-so-çš„åŠ è½½é¡ºåº" class="headerlink" title="è¿è¡Œæ—¶ so çš„åŠ è½½é¡ºåº"></a>è¿è¡Œæ—¶ so çš„åŠ è½½é¡ºåº</h2><table>
<thead>
<tr>
<th align="center">ä¼˜å…ˆçº§</th>
<th align="center">æ¥æº</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ğŸ”º 1</td>
<td align="center">LD_PRELOAD ç¯å¢ƒå˜é‡</td>
<td align="center">å¼ºåˆ¶ä¼˜å…ˆåŠ è½½æŒ‡å®šåº“ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼Œå¯ç”¨äºå‡½æ•°æ›¿æ¢</td>
</tr>
<tr>
<td align="center">ğŸ”º 2</td>
<td align="center">rpathï¼ˆç¼–è¯‘æ—¶æŒ‡å®šï¼‰</td>
<td align="center">ä½¿ç”¨ -Wl,-rpath&#x3D;â€¦ ç¼–è¯‘æ—¶åµŒå…¥çš„è·¯å¾„ï¼Œä»…ä½œç”¨äºå½“å‰ç¨‹åºï¼ˆå·²åºŸå¼ƒï¼šå› ä¸ºä¼˜å…ˆçº§è¿‡é«˜ï¼Œä¸”å½±å“é—´æ¥ä¾èµ–é¡¹ã€‚æ¨èä½¿ç”¨ runpathï¼Œæ²¡æœ‰è¿™ä¸¤ä¸ªç¼ºç‚¹ã€‚ï¼‰</td>
</tr>
<tr>
<td align="center">ğŸ”º 3</td>
<td align="center">LD_LIBRARY_PATH ç¯å¢ƒå˜é‡</td>
<td align="center">è¿è¡Œæ—¶è®¾ç½®çš„åº“æœç´¢è·¯å¾„ï¼Œå½±å“å½“å‰ shell ä¼šè¯</td>
</tr>
<tr>
<td align="center">ğŸ”º 4</td>
<td align="center">runpathï¼ˆç¼–è¯‘æ—¶æŒ‡å®šï¼‰</td>
<td align="center">ä½¿ç”¨ -Wl,-rpath è®¾ç½®çš„è·¯å¾„ï¼Œä½†ä¼˜å…ˆçº§ä½äº LD_LIBRARY_PATH</td>
</tr>
<tr>
<td align="center">ğŸ”º 5</td>
<td align="center">&#x2F;etc&#x2F;ld.so.cache</td>
<td align="center">ç”± ldconfig ç”Ÿæˆçš„ç¼“å­˜ï¼ŒåŒ…å« &#x2F;etc&#x2F;ld.so.conf ä¸­çš„è·¯å¾„</td>
</tr>
<tr>
<td align="center">ğŸ”º 6</td>
<td align="center">é»˜è®¤ç³»ç»Ÿè·¯å¾„</td>
<td align="center">&#x2F;lib, &#x2F;usr&#x2F;lib, &#x2F;lib64, &#x2F;usr&#x2F;lib64 ç­‰æ ‡å‡†ç›®å½•</td>
</tr>
</tbody></table>
<h3 id="åŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic-Linkerï¼‰"><a href="#åŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic-Linkerï¼‰" class="headerlink" title="åŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic Linkerï¼‰"></a>åŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic Linkerï¼‰</h3><p>ä»¥ä¸Šçš„ so çš„åŠ è½½é¡ºåºï¼Œæ˜¯ç”± <strong>åŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic Linkerï¼‰</strong> å®Œæˆçš„ã€‚</p>
<p>æ¯ä¸ª ELF å¯æ‰§è¡Œæ–‡ä»¶åœ¨å¤´éƒ¨æŒ‡å®šäº†å®ƒçš„åŠ¨æ€é“¾æ¥å™¨è·¯å¾„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -l your_program | grep interpreter</span><br><span class="line">[Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªé“¾æ¥å™¨è´Ÿè´£åœ¨ç¨‹åºå¯åŠ¨æ—¶åŠ è½½æ‰€éœ€çš„åŠ¨æ€åº“ï¼ŒåŒ…æ‹¬ libc.so.6ï¼ˆglibc çš„ä¸»åº“ï¼‰ã€‚</p>
<p>æ³¨æ„ï¼š<code>ld.so</code>ï¼ˆè¿™æ˜¯ä¸€ä¸ªç®€ç§°ï¼‰å’Œ <code>ld</code> å®Œå…¨ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œ<code>ld</code> æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œåœ¨ç¼–è¯‘æœŸä½¿ç”¨ï¼Œè§ä¸‹<br>æ–‡<a href="#%E7%BC%96%E8%AF%91%E6%97%B6%E9%93%BE%E6%8E%A5%E5%99%A8%EF%BC%88ld%EF%BC%89">ç¼–è¯‘æ—¶é“¾æ¥å™¨ï¼ˆldï¼‰</a>ã€‚</p>
<ul>
<li><code>ld.so</code> æ—¢æ˜¯ so ä¹Ÿæ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file /lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, BuildID[sha1]=e4de036b19e4768e7591b596c4be9f9015f2d28a, stripped</span><br></pre></td></tr></table></figure>

<p>æ™®é€šç¨‹åºçš„ ELF æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ª PT_INTERP æ®µï¼ŒæŒ‡å®šäº†è¿™ä¸ªé“¾æ¥å™¨çš„è·¯å¾„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ file /usr/bin/ls</span><br><span class="line">/usr/bin/ls: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=36b86f957a1be53733633d184c3a3354f3fc7b12, <span class="keyword">for</span> GNU/Linux 3.2.0, stripped</span><br><span class="line"></span><br><span class="line">$ file /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=cd410b710f0f094c6832edd95931006d883af48e, <span class="keyword">for</span> GNU/Linux 3.2.0, stripped</span><br></pre></td></tr></table></figure>

<ul>
<li>åŠ¨æ€é“¾æ¥å™¨ ld.so æœ¬èº«ä¹Ÿä¾èµ–å…±äº«åº“ï¼ˆå¦‚ libc.so.6ï¼‰ï¼Œä½†å®ƒåˆæ˜¯è´Ÿè´£åŠ è½½å…±äº«åº“çš„å·¥å…·</li>
</ul>
<p>åŠ¨æ€é“¾æ¥å™¨æ˜¯ä¸€ä¸ªâ€œè‡ªä¸¾â€ç¨‹åºï¼š</p>
<ul>
<li>å®ƒæ˜¯ç”± Linux å†…æ ¸ç›´æ¥åŠ è½½å¹¶æ‰§è¡Œï¼Œä¸ä¾èµ–å…¶ä»–åº“æ¥å¯åŠ¨ã€‚</li>
<li>å®ƒçš„å¯åŠ¨ä»£ç æ˜¯ é™æ€ç¼–è¯‘çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒçš„æœ€å°å¯åŠ¨é€»è¾‘ä¸ä¾èµ– libc.so.6ã€‚</li>
<li>åœ¨å¯åŠ¨åï¼Œå®ƒæ‰ä¼šå»åŠ è½½ libc.so.6 å’Œå…¶ä»– .so æ–‡ä»¶ï¼Œå®Œæˆç¬¦å·è§£æå’Œåˆå§‹åŒ–ã€‚</li>
<li>æœ‰è¶£çš„æ˜¯ï¼Œlibc.so.6 åˆä¾èµ– ld.so æ¥åŠ è½½ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ä½ è¿è¡Œ ./myapp</span><br><span class="line">â†“</span><br><span class="line">å†…æ ¸è¯»å– ELF â†’ æ‰¾åˆ° PT_INTERP æ®µ â†’ åŠ è½½ ld.so</span><br><span class="line">â†“</span><br><span class="line">ld.so å¯åŠ¨ï¼ˆé è‡ªèº«é™æ€ä»£ç ï¼‰</span><br><span class="line">â†“</span><br><span class="line">ld.so åŠ è½½ libc.so.6ã€libstdc++.so.6 ç­‰å…±äº«åº“</span><br><span class="line">â†“</span><br><span class="line">ld.so è·³è½¬åˆ° myapp çš„å…¥å£åœ°å€ï¼ˆmainï¼‰</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ libc.so.6 ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ</p>
<p>æœ‰å¼€å‘è€…åˆ†äº«è¿‡çœŸå®æ¡ˆä¾‹ï¼Œå½“ç³»ç»Ÿè¯¯åˆ äº† libc.so.6 ï¼Œå‡ ä¹æ‰€æœ‰å‘½ä»¤éƒ½æ— æ³•è¿è¡Œã€‚ä½†ä½ ä»ç„¶å¯ä»¥ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/lib64/ld-linux-x86-64.so.2 /bin/ln -s /lib64/libc-2.33.so /lib64/libc.so.6</span><br></pre></td></tr></table></figure>

<p>è¿™åˆ©ç”¨äº† ld.so çš„è‡ªä¸¾èƒ½åŠ›ï¼Œæ‰‹åŠ¨åŠ è½½ libc å¹¶æ‰§è¡Œå‘½ä»¤ï¼Œä»è€Œæ¢å¤ç³»ç»Ÿã€‚</p>
<h3 id="ldd-æ£€æŸ¥"><a href="#ldd-æ£€æŸ¥" class="headerlink" title="ldd æ£€æŸ¥"></a>ldd æ£€æŸ¥</h3><p><code>ldd</code> (List Dynamic Dependencies) æ˜¯ä¸€ä¸ª shell è„šæœ¬ï¼Œç”¨äºæŸ¥çœ‹ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“æ‰€ä¾èµ–çš„åŠ¨æ€é“¾æ¥<br>åº“çš„å‘½ä»¤ã€‚</p>
<p>å®ƒçš„æ€è·¯æ˜¯ï¼šæ¨¡æ‹Ÿ è¿è¡Œæ—¶é“¾æ¥å™¨ çš„è¡Œä¸ºã€‚</p>
<ol>
<li><p>è®¾ç½®ç¯å¢ƒå˜é‡æ¥è§¦å‘åŠ¨æ€é“¾æ¥å™¨ (ld-linux.so) è¾“å‡ºä¾èµ–ä¿¡æ¯ï¼Œä½†æ˜¯ä¸çœŸæ­£æ‰§è¡Œç¨‹åºã€‚å¦‚ï¼š</p>
<ul>
<li><code>LD_TRACE_LOADED_OBJECTS=1</code></li>
<li><code>LD_WARN</code>, <code>LD_BIND_NOW</code>, <code>LD_VERBOSE</code> ç­‰</li>
</ul>
</li>
<li><p>è°ƒç”¨åŠ¨æ€é“¾æ¥å™¨æŸ¥æ‰¾ so .</p>
</li>
</ol>
<p>å±€é™æ€§ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>dlopen()</code> åŠ¨æ€åŠ è½½åº“ï¼Œ<code>ldd</code> æ˜¯æ— æ³•æ£€æµ‹åˆ°çš„</li>
</ul>
<h3 id="è¡¥å……å·¥å…·"><a href="#è¡¥å……å·¥å…·" class="headerlink" title="è¡¥å……å·¥å…·"></a>è¡¥å……å·¥å…·</h3><ul>
<li><code>readelf -d binary | grep -i rpath</code>ï¼šæŸ¥çœ‹ ELF æ–‡ä»¶ä¸­çš„ RPATH æˆ– RUNPATH</li>
<li><code>ldconfig -p</code>ï¼šæŸ¥çœ‹ç³»ç»Ÿç¼“å­˜ä¸­æœ‰å“ªäº›åº“</li>
<li><code>strace -e openat ./your_program</code>ï¼šæŸ¥çœ‹è¿è¡Œæ—¶å®é™…æ‰“å¼€äº†å“ªäº›åº“æ–‡ä»¶</li>
<li><code>LD_DEBUG=libs ./your_program</code>ï¼šè°ƒè¯•åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹</li>
</ul>
<h2 id="ç¼–è¯‘æ—¶-so-çš„æŸ¥æ‰¾é¡ºåº"><a href="#ç¼–è¯‘æ—¶-so-çš„æŸ¥æ‰¾é¡ºåº" class="headerlink" title="ç¼–è¯‘æ—¶ so çš„æŸ¥æ‰¾é¡ºåº"></a>ç¼–è¯‘æ—¶ so çš„æŸ¥æ‰¾é¡ºåº</h2><p>GCC æŸ¥æ‰¾ glibc çš„è·¯å¾„é¡ºåºï¼š</p>
<p>ğŸ§  ç¼–è¯‘é˜¶æ®µï¼ˆæŸ¥æ‰¾å¤´æ–‡ä»¶ï¼‰</p>
<table>
<thead>
<tr>
<th align="center">ä¼˜å…ˆçº§</th>
<th align="center">è·¯å¾„æ¥æº</th>
<th align="center">ç¤ºä¾‹è·¯å¾„</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1ï¸âƒ£</td>
<td align="center">æ˜¾å¼æŒ‡å®š -I å‚æ•°</td>
<td align="center">gcc -I&#x2F;custom&#x2F;include</td>
<td align="center">ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®šï¼Œä¼˜å…ˆçº§æœ€é«˜</td>
</tr>
<tr>
<td align="center">2ï¸âƒ£</td>
<td align="center">-isystem æŒ‡å®šç³»ç»Ÿå¤´æ–‡ä»¶è·¯å¾„</td>
<td align="center">gcc -isystem &#x2F;custom&#x2F;sysinclude</td>
<td align="center">ä¼˜å…ˆçº§é«˜äºé»˜è®¤è·¯å¾„ä½†ä½äº -I</td>
</tr>
<tr>
<td align="center">3ï¸âƒ£</td>
<td align="center">ç¯å¢ƒå˜é‡ CPATH</td>
<td align="center">&#x2F;opt&#x2F;common&#x2F;include</td>
<td align="center">é€‚ç”¨äºæ‰€æœ‰è¯­è¨€ï¼Œä¼˜å…ˆäºé»˜è®¤è·¯å¾„</td>
</tr>
<tr>
<td align="center">4ï¸âƒ£</td>
<td align="center">ç¯å¢ƒå˜é‡ C_INCLUDE_PATH</td>
<td align="center">&#x2F;opt&#x2F;glibc-2.28&#x2F;include</td>
<td align="center">ä»…å¯¹ C æ–‡ä»¶æœ‰æ•ˆï¼Œä¼˜å…ˆäºé»˜è®¤è·¯å¾„</td>
</tr>
<tr>
<td align="center">5ï¸âƒ£</td>
<td align="center">ç¯å¢ƒå˜é‡ CPLUS_INCLUDE_PATH</td>
<td align="center">&#x2F;opt&#x2F;cpp&#x2F;include</td>
<td align="center">ä»…å¯¹ C++ æ–‡ä»¶æœ‰æ•ˆï¼Œä¼˜å…ˆäºé»˜è®¤è·¯å¾„</td>
</tr>
<tr>
<td align="center">6ï¸âƒ£</td>
<td align="center">GCC é»˜è®¤ç³»ç»Ÿè·¯å¾„</td>
<td align="center">&#x2F;usr&#x2F;include</td>
<td align="center">æœ€åå…œåº•è·¯å¾„</td>
</tr>
<tr>
<td align="center">7ï¸âƒ£</td>
<td align="center">å†…æ ¸å¤´æ–‡ä»¶è·¯å¾„ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰</td>
<td align="center">&#x2F;usr&#x2F;src&#x2F;linux&#x2F;include</td>
<td align="center">ç¼–è¯‘å†…æ ¸æ¨¡å—æˆ–é©±åŠ¨æ—¶ä½¿ç”¨</td>
</tr>
</tbody></table>
<ul>
<li><code>-I</code> å’Œ <code>-isystem</code> éƒ½æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œä½† <code>-isystem</code> ä¼šå°†è·¯å¾„æ ‡è®°ä¸ºâ€œç³»ç»Ÿè·¯å¾„â€ï¼Œé¿å…æŸäº›è­¦å‘Šã€‚</li>
<li>ç¯å¢ƒå˜é‡å¦‚ <code>CPATH</code> å’Œ <code>C_INCLUDE_PATH</code> æ˜¯åœ¨æ²¡æœ‰æ˜¾å¼å‚æ•°æ—¶çš„è¡¥å……æ‰‹æ®µã€‚</li>
<li>é»˜è®¤è·¯å¾„ <code>/usr/include</code> æ˜¯ GCC å®‰è£…æ—¶é…ç½®çš„ï¼Œå¯ä»¥é€šè¿‡ <code>gcc -xc -E -v -</code> æŸ¥çœ‹å®Œæ•´æœç´¢è·¯å¾„ã€‚</li>
</ul>
<p>ğŸ”— é“¾æ¥é˜¶æ®µï¼ˆæŸ¥æ‰¾åº“æ–‡ä»¶ï¼‰</p>
<table>
<thead>
<tr>
<th align="center">ä¼˜å…ˆçº§</th>
<th align="center">æ¥æºç±»å‹</th>
<th align="center">æ˜¯å¦å¯è¦†ç›–</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1ï¸âƒ£</td>
<td align="center">æ˜¾å¼å‘½ä»¤è¡Œå‚æ•° -L</td>
<td align="center">âœ…</td>
<td align="center">ç”¨æˆ·æŒ‡å®šçš„åº“è·¯å¾„ï¼Œæœ€é«˜ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td align="center">2ï¸âƒ£</td>
<td align="center">é“¾æ¥å™¨å‚æ•° -rpath-link</td>
<td align="center">âœ…</td>
<td align="center">é“¾æ¥å™¨æŸ¥æ‰¾é—´æ¥ä¾èµ–åº“æ—¶ä½¿ç”¨</td>
</tr>
<tr>
<td align="center">3ï¸âƒ£</td>
<td align="center">ç¯å¢ƒå˜é‡ LIBRARY_PATH</td>
<td align="center">âœ…</td>
<td align="center">ç¼–è¯‘å™¨æŸ¥æ‰¾åº“æ—¶ä½¿ç”¨ï¼Œä¼˜å…ˆäºé»˜è®¤è·¯å¾„</td>
</tr>
<tr>
<td align="center">4ï¸âƒ£</td>
<td align="center">â€“sysroot æŒ‡å®šæ ¹è·¯å¾„</td>
<td align="center">âœ…</td>
<td align="center">ç”¨äºäº¤å‰ç¼–è¯‘ï¼Œå½±å“æ‰€æœ‰è·¯å¾„è§£æ</td>
</tr>
<tr>
<td align="center">5ï¸âƒ£</td>
<td align="center">GCC å®‰è£…è·¯å¾„é»˜è®¤æœç´¢ç›®å½•</td>
<td align="center">âœ…</td>
<td align="center">æ¥è‡ª â€“prefix å’Œ â€“libdir é…ç½®</td>
</tr>
<tr>
<td align="center">6ï¸âƒ£</td>
<td align="center">specs æ–‡ä»¶é…ç½®</td>
<td align="center">âœ…</td>
<td align="center">GCC å†…éƒ¨é…ç½®ï¼Œå¯è‡ªå®šä¹‰è¡Œä¸º</td>
</tr>
<tr>
<td align="center">7ï¸âƒ£</td>
<td align="center">é»˜è®¤ç³»ç»Ÿè·¯å¾„ &#x2F;lib, &#x2F;usr&#x2F;lib, &#x2F;lib64</td>
<td align="center">âŒ</td>
<td align="center">æœ€åå…œåº•è·¯å¾„ï¼Œç³»ç»Ÿç¯å¢ƒæä¾›çš„åº“</td>
</tr>
</tbody></table>
<p>è¯´æ˜ï¼š</p>
<p>åœ¨ç¼–è¯‘å®‰è£… GCC æ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨ configure è„šæœ¬æ¥æŒ‡å®šå®‰è£…è·¯å¾„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/custom/gcc --libdir=/custom/gcc/lib64</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">å‚æ•°</th>
<th align="center">ä½œç”¨è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">â€“prefix</td>
<td align="center">æŒ‡å®š GCC çš„å®‰è£…æ ¹ç›®å½•ã€‚GCC çš„å¯æ‰§è¡Œæ–‡ä»¶ã€å¤´æ–‡ä»¶ã€åº“æ–‡ä»¶ç­‰éƒ½ä¼šå®‰è£…åˆ°è¿™ä¸ªç›®å½•ä¸‹çš„å­ç›®å½•ä¸­ã€‚</td>
</tr>
<tr>
<td align="center">â€“libdir</td>
<td align="center">æŒ‡å®šåº“æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼Œé€šå¸¸æ˜¯ lib æˆ– lib64ï¼Œç”¨äºæ”¾ç½® .so æˆ– .a æ–‡ä»¶ã€‚</td>
</tr>
</tbody></table>
<p>å½“ä½ ä½¿ç”¨è¿™ä¸ª GCC ç¼–è¯‘å™¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä½¿ç”¨è¿™äº›è·¯å¾„æ¥æŸ¥æ‰¾å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>æŸ¥æ‰¾å¤´æ–‡ä»¶æ—¶ï¼Œä¼šä¼˜å…ˆä½¿ç”¨ &#x2F;custom&#x2F;gcc&#x2F;include</li>
<li>æŸ¥æ‰¾åº“æ–‡ä»¶æ—¶ï¼Œä¼šä¼˜å…ˆä½¿ç”¨ &#x2F;custom&#x2F;gcc&#x2F;lib64</li>
<li>é“¾æ¥å™¨ï¼ˆå¦‚ ldï¼‰ä¹Ÿä¼šè¢« GCC å‘ŠçŸ¥å»è¿™äº›è·¯å¾„æ‰¾åº“</li>
</ul>
<p>è¿™äº›è·¯å¾„æ˜¯ ç¼–è¯‘å™¨å†…éƒ¨å†™æ­»çš„é»˜è®¤å€¼ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -print-search-dirs</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">install: /custom/gcc/lib/gcc/x86_64-linux-gnu/12.2.0/</span><br><span class="line">programs: /custom/gcc/libexec/gcc/x86_64-linux-gnu/12.2.0/:...</span><br><span class="line">libraries: /custom/gcc/lib/gcc/x86_64-linux-gnu/12.2.0/:/custom/gcc/lib64/:..</span><br></pre></td></tr></table></figure>

<h3 id="ç¼–è¯‘æ—¶é“¾æ¥å™¨ï¼ˆldï¼‰"><a href="#ç¼–è¯‘æ—¶é“¾æ¥å™¨ï¼ˆldï¼‰" class="headerlink" title="ç¼–è¯‘æ—¶é“¾æ¥å™¨ï¼ˆldï¼‰"></a>ç¼–è¯‘æ—¶é“¾æ¥å™¨ï¼ˆldï¼‰</h3><p>ç¼–è¯‘æ—¶é“¾æ¥å™¨ï¼ˆldï¼‰ å’Œ è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥å™¨ ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼š</p>
<table>
<thead>
<tr>
<th align="center">ç‰¹æ€§</th>
<th align="center">ç¼–è¯‘æ—¶é“¾æ¥å™¨ (<code>ld</code>)</th>
<th align="center">è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥å™¨ (<code>ld-linux.so</code>)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">æ‰§è¡Œæ—¶æœº</td>
<td align="center">ç¼–è¯‘é˜¶æ®µ</td>
<td align="center">ç¨‹åºå¯åŠ¨æ—¶</td>
</tr>
<tr>
<td align="center">ä½œç”¨</td>
<td align="center">ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</td>
<td align="center">åŠ è½½ .so åº“å¹¶ç»‘å®šç¬¦å·</td>
</tr>
<tr>
<td align="center">ç”±è°è°ƒç”¨</td>
<td align="center">ç¼–è¯‘å™¨ï¼ˆå¦‚ gccï¼‰</td>
<td align="center">æ“ä½œç³»ç»ŸåŠ è½½å™¨</td>
</tr>
<tr>
<td align="center">æ˜¯å¦å‚ä¸è¿è¡Œè¿‡ç¨‹</td>
<td align="center">âŒ ä¸å‚ä¸</td>
<td align="center">âœ… å‚ä¸</td>
</tr>
</tbody></table>
<h2 id="glibc"><a href="#glibc" class="headerlink" title="glibc"></a>glibc</h2><p>glibc æ˜¯ç‰¹æ®Šçš„ so ï¼Œå®ƒå°è£…äº†ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥ Linux ç³»ç»Ÿæœ¬èº«ä¹Ÿä¾èµ–å®ƒã€‚</p>
<p>C è¯­è¨€å…è®¸ç¼–è¯‘æ—¶é“¾æ¥å’Œè¿è¡Œæ—¶é“¾æ¥åˆ†å¼€ï¼Œæ‰€ä»¥å¸¸å¸¸é‡åˆ°è¿™æ ·å¥‡æ€ªçš„é—®é¢˜ï¼š</p>
<ul>
<li>åœ¨æœ¬æœºç¼–è¯‘ã€é“¾æ¥ï¼Œåœ¨æœ¬æœºä¸èƒ½è¿è¡Œï¼š</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./myapp: /lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_2.33&#x27; not found (required by ./myapp)</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯å› ä¸º gcc åœ¨ç¼–è¯‘æ—¶æŒ‡å®šçš„ glibc å’Œç³»ç»Ÿè¿è¡Œæ—¶çš„ glibc ä¸ä¸€æ ·ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ strings /lib/x86_64-linux-gnu/libc.so.6 | grep GLIBC_</span><br><span class="line">GLIBC_2.2.5</span><br><span class="line">...</span><br><span class="line">GLIBC_2.31</span><br><span class="line"></span><br><span class="line">$ strings ./myapp | grep GLIBCXX_</span><br><span class="line">GLIBC_2.3</span><br><span class="line">...</span><br><span class="line">GLIBCXX_2.33</span><br></pre></td></tr></table></figure>

<p><code>/lib/x86_64-linux-gnu/libc.so.6</code> ä¸­ç¡®å®æ²¡æœ‰ <code>GLIBC_2.33</code> çš„ç¬¦å·ã€‚</p>
<p>å¦‚æœä½ çš„ç³»ç»Ÿä¸­æœ‰å¤šä¸ª glibc ï¼Œé‚£ä¹ˆè¿™ç§é—®é¢˜å¯ä»¥é€šè¿‡ä¸Šé¢â€œè¿è¡Œæ—¶ so çš„åŠ è½½é¡ºåºâ€ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡è°ƒæ•´ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™ç§å¯¹ glibc çš„ä¾èµ–å¯èƒ½æ˜¯é—´æ¥çš„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /path/to/gcc/v14.2.0/lib64 | grep libstdc++.so</span><br><span class="line">libstdc++.so</span><br><span class="line">libstdc++.so.6</span><br><span class="line"></span><br><span class="line">$ ldd /path/to/gcc/v14.2.0/lib64/libstdc++.so.6</span><br><span class="line">        linux-vdso.so.1 (0x00007ffd965f4000)</span><br><span class="line">        libm.so.6 =&gt; /usr/lib64/libm.so.6 (0x0000147a213a9000)</span><br><span class="line">        libc.so.6 =&gt; /usr/lib64/libc.so.6 (0x0000147a20fe4000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x0000147a219ea000)</span><br><span class="line">        libgcc_s.so.1 =&gt; /path/to/gcc/v14.2.0/lib64/libgcc_s.so.1 (0x0000147a21be4000)</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ï¼Œå¦‚æœä½ çš„ç¼–è¯‘å’Œè¿è¡Œçš„æœºå™¨ä¸æ˜¯åŒä¸€å°ï¼ˆæ„å‘³ç€è¿è¡Œæ—¶ &#x2F;usr&#x2F;lib64&#x2F;libc.so.6 çš„æ–‡ä»¶å’Œç¼–è¯‘æœŸä¸ä¸€è‡´ï¼‰ï¼Œ<br>è¿™æ—¶å€™å°±åŸºæœ¬æ²¡æœ‰æ²¡æœ‰åŠæ³•äº†ã€‚ç†è®ºä¸Šï¼Œä½ å¯ä»¥ä¸‹è½½ä¸€ä¸ªä¸ç¼–è¯‘æœŸç›¸åŒçš„ libc.so.6 ï¼Œä½†æ˜¯ä½ æ— æ³•ä¿è¯ç³»ç»Ÿçš„åŠ¨<br>æ€é“¾æ¥å™¨ <code>/lib64/ld-linux-x86-64.so.2</code> ä¸æ‰€ä¸‹è½½çš„ libc.so.6 å…¼å®¹ã€‚è€Œ <code>/lib64/ld-linux-x86-64.so.2</code><br>è·¯å¾„æ˜¯æ— æ³•é€šè¿‡ç¯å¢ƒå˜é‡ä¿®æ”¹çš„ï¼Œå› ä¸ºå®ƒæ˜¯å†…æ ¸åœ¨ç¨‹åºå¯åŠ¨æ—¶ç›´æ¥åŠ è½½çš„ï¼Œå®ƒçš„è·¯å¾„æ˜¯ç¡¬ç¼–ç åœ¨ ELF å¯æ‰§è¡Œæ–‡ä»¶<br>ä¸­çš„ã€‚</p>
<p>æ‰€ä»¥æœ€å¥½çš„æ–¹å¼ï¼Œæ˜¯åœ¨ç¼–è¯‘æ—¶å°±ç¡®è®¤ GCC çš„ glibc å’Œç³»ç»Ÿè¿è¡Œæ—¶ä¸€è‡´ã€‚</p>
<h3 id="æ£€æŸ¥å½“å‰-GCC-ä½¿ç”¨çš„-glibc-è·¯å¾„"><a href="#æ£€æŸ¥å½“å‰-GCC-ä½¿ç”¨çš„-glibc-è·¯å¾„" class="headerlink" title="æ£€æŸ¥å½“å‰ GCC ä½¿ç”¨çš„ glibc è·¯å¾„"></a>æ£€æŸ¥å½“å‰ GCC ä½¿ç”¨çš„ glibc è·¯å¾„</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -print-file-name=libc.so</span><br><span class="line">g++ -print-file-name=libstdc++.so</span><br><span class="line">gcc -print-search-dirs</span><br></pre></td></tr></table></figure>

<h3 id="ç¡®è®¤å½“å‰ç³»ç»Ÿçš„-glibc-å’Œ-libstdc-ç‰ˆæœ¬"><a href="#ç¡®è®¤å½“å‰ç³»ç»Ÿçš„-glibc-å’Œ-libstdc-ç‰ˆæœ¬" class="headerlink" title="ç¡®è®¤å½“å‰ç³»ç»Ÿçš„ glibc å’Œ libstdc++ ç‰ˆæœ¬"></a>ç¡®è®¤å½“å‰ç³»ç»Ÿçš„ glibc å’Œ libstdc++ ç‰ˆæœ¬</h3><p>âœ… æŸ¥çœ‹ glibc ç‰ˆæœ¬ï¼ˆå³ libc.soï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ldd --version</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">getconf GNU_LIBC_VERSION</span><br></pre></td></tr></table></figure>

<p>âœ… æŸ¥çœ‹ libstdc++ ç‰ˆæœ¬ï¼ˆC++ æ ‡å‡†åº“ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strings /usr/lib*/libstdc++.so.6 | grep GLIBCXX</span><br></pre></td></tr></table></figure>

<p>ä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GLIBCXX_3.4.21</span><br><span class="line">GLIBCXX_3.4.26</span><br></pre></td></tr></table></figure>

<p>è¿™äº›æ˜¯ä½ ç³»ç»Ÿæ”¯æŒçš„ C++ ABI ç‰ˆæœ¬ã€‚</p>
<h3 id="ç³»ç»Ÿé»˜è®¤è·¯å¾„"><a href="#ç³»ç»Ÿé»˜è®¤è·¯å¾„" class="headerlink" title="ç³»ç»Ÿé»˜è®¤è·¯å¾„"></a>ç³»ç»Ÿé»˜è®¤è·¯å¾„</h3><p>ç”± &#x2F;etc&#x2F;ld.so.conf å’Œ ldconfig å†³å®š</p>
<p>é€šå¸¸åŒ…æ‹¬ï¼š</p>
<ul>
<li>&#x2F;lib64&#x2F;</li>
<li>&#x2F;usr&#x2F;lib64&#x2F;</li>
<li>&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ï¼ˆDebian&#x2F;Ubuntuï¼‰</li>
</ul>
<p>ä½ å¯ä»¥è¿è¡Œï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldconfig -p | grep libc.so.6</span><br></pre></td></tr></table></figure>

<p>æ¥æŸ¥çœ‹ç³»ç»Ÿå½“å‰å¯ç”¨çš„ libc.so.6 ç‰ˆæœ¬å’Œè·¯å¾„ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/16/concurrency/%E5%B9%B6%E5%8F%91%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/16/concurrency/%E5%B9%B6%E5%8F%91%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/" class="post-title-link" itemprop="url">å¹¶å‘ä¸­çš„å†…å­˜å›æ”¶</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-16 23:04:01" itemprop="dateCreated datePublished" datetime="2025-09-16T23:04:01+00:00">2025-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">å¹¶å‘ç¼–ç¨‹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Hazard-Pointersï¼ˆå±é™©æŒ‡é’ˆï¼‰"><a href="#Hazard-Pointersï¼ˆå±é™©æŒ‡é’ˆï¼‰" class="headerlink" title="Hazard Pointersï¼ˆå±é™©æŒ‡é’ˆï¼‰"></a>Hazard Pointersï¼ˆå±é™©æŒ‡é’ˆï¼‰</h2><p>âœ… ä½œç”¨ï¼šä¿æŠ¤æ­£åœ¨è®¿é—®çš„æŒ‡é’ˆï¼Œé˜²æ­¢å®ƒè¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾ã€‚</p>
<p>æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ç»„â€œhazard slotsâ€ï¼Œç”¨äºå£°æ˜å½“å‰æ­£åœ¨ä½¿ç”¨çš„èŠ‚ç‚¹ã€‚</p>
<p>åœ¨é‡Šæ”¾èŠ‚ç‚¹å‰ï¼Œå¿…é¡»æ£€æŸ¥æ˜¯å¦æœ‰çº¿ç¨‹å°†å…¶æ ‡è®°ä¸º hazardã€‚å¦‚æœæœ‰ï¼Œå°±å»¶è¿Ÿé‡Šæ”¾ã€‚</p>
<p>ğŸ“Œ ä¼˜ç‚¹ï¼šç²¾ç»†æ§åˆ¶ï¼šæ¯ä¸ªæŒ‡é’ˆéƒ½å¯ä»¥ç‹¬ç«‹ä¿æŠ¤ã€‚</p>
<p>å¿«é€Ÿé‡Šæ”¾ï¼šä¸€æ—¦æ²¡æœ‰çº¿ç¨‹æ ‡è®°è¯¥èŠ‚ç‚¹ï¼Œå°±å¯ä»¥ç«‹å³é‡Šæ”¾ã€‚</p>
<p>âš ï¸ ç¼ºç‚¹ï¼šæ¯ä¸ªçº¿ç¨‹éœ€è¦ç»´æŠ¤é¢å¤–çš„æŒ‡é’ˆé›†åˆã€‚</p>
<p>å®ç°å¤æ‚åº¦è¾ƒé«˜ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ã€‚</p>
<h2 id="Epoch-Based-Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼‰"><a href="#Epoch-Based-Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼‰" class="headerlink" title="Epoch-Based Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼‰"></a>Epoch-Based Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼‰</h2><p>âœ… ä½œç”¨ï¼šå°†æ‰€æœ‰çº¿ç¨‹çš„æ“ä½œåˆ’åˆ†åˆ°ä¸€ä¸ªâ€œepochâ€ï¼ˆæ—¶é—´æ®µï¼‰ä¸­ã€‚</p>
<p>æ¯ä¸ªçº¿ç¨‹åœ¨è¿›å…¥ä¸´ç•ŒåŒºæ—¶è®°å½•å½“å‰ epochï¼Œé€€å‡ºæ—¶æ¸…é™¤ã€‚</p>
<p>è¢«åˆ é™¤çš„èŠ‚ç‚¹ä¼šæŒ‚åˆ°å½“å‰ epoch çš„åƒåœ¾åˆ—è¡¨ä¸­ï¼Œåªæœ‰å½“æ‰€æœ‰çº¿ç¨‹éƒ½ç¦»å¼€è¯¥ epochï¼Œæ‰å®‰å…¨é‡Šæ”¾è¿™äº›èŠ‚ç‚¹ã€‚</p>
<p>ğŸ“Œ ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œæ€§èƒ½å¥½ï¼Œé€‚åˆé«˜ååé‡åœºæ™¯ã€‚</p>
<p>ä¸éœ€è¦æ¯ä¸ªæŒ‡é’ˆéƒ½å•ç‹¬ä¿æŠ¤ã€‚</p>
<p>âš ï¸ ç¼ºç‚¹ï¼šå›æ”¶å»¶è¿Ÿï¼šå¿…é¡»ç­‰å¾…æ‰€æœ‰çº¿ç¨‹é€€å‡ºå½“å‰ epochã€‚</p>
<p>å¯¹é•¿æ—¶é—´è¿è¡Œçš„çº¿ç¨‹æ•æ„Ÿï¼Œå¯èƒ½é˜»æ­¢åƒåœ¾å›æ”¶ã€‚</p>
<p>ğŸ§  ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬ï¼Ÿ</p>
<p>åœ¨ lock-free æ•°æ®ç»“æ„ä¸­ï¼ŒèŠ‚ç‚¹å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æˆ–ä¿®æ”¹ã€‚æ²¡æœ‰äº’æ–¥é”ä¿æŠ¤æ—¶ï¼Œç›´æ¥é‡Šæ”¾å†…å­˜å¯èƒ½å¯¼è‡´ï¼š</p>
<ul>
<li>æ‚¬æŒ‚æŒ‡é’ˆï¼šå…¶ä»–çº¿ç¨‹è¿˜åœ¨è®¿é—®è¢«é‡Šæ”¾çš„èŠ‚ç‚¹ã€‚</li>
<li>ABA é—®é¢˜ï¼šèŠ‚ç‚¹è¢«é‡Šæ”¾ååœ°å€å¤ç”¨ï¼Œå¯¼è‡´é€»è¾‘é”™è¯¯ã€‚</li>
</ul>
<figure class="highlight cpp"><figcaption><span>ebr.cpp</span><a href="/blog/downloads/code/concurrency/ebr.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EBR: Epoch-Based Reclamation</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MAX_THREADS = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; global_epoch{<span class="number">0</span>};</span><br><span class="line">std::atomic&lt;<span class="type">bool</span>&gt; active[MAX_THREADS];</span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; local_epoch[MAX_THREADS];</span><br><span class="line"></span><br><span class="line">std::mutex retire_mutex;</span><br><span class="line">std::unordered_map&lt;<span class="type">int</span>, std::vector&lt;<span class="type">int</span>*&gt;&gt; retire_list[<span class="number">3</span>];  <span class="comment">// æ¯ä¸ª epoch çš„åƒåœ¾åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">enter_critical</span><span class="params">(<span class="type">int</span> tid)</span> </span>{</span><br><span class="line">    active[tid].<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_relaxed);</span><br><span class="line">    local_epoch[tid].<span class="built_in">store</span>(global_epoch.<span class="built_in">load</span>(std::memory_order_relaxed),</span><br><span class="line">                           std::memory_order_relaxed);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">exit_critical</span><span class="params">(<span class="type">int</span> tid)</span> </span>{</span><br><span class="line">    active[tid].<span class="built_in">store</span>(<span class="literal">false</span>, std::memory_order_relaxed);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">retire_node</span><span class="params">(<span class="type">int</span> tid, <span class="type">int</span>* node)</span> </span>{</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(retire_mutex)</span></span>;</span><br><span class="line">    <span class="type">int</span> epoch = global_epoch.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">    retire_list[epoch][tid].<span class="built_in">push_back</span>(node);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">try_advance_epoch</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="type">int</span> current = global_epoch.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_THREADS; ++i) {</span><br><span class="line">        <span class="keyword">if</span> (active[i].<span class="built_in">load</span>(std::memory_order_relaxed) &amp;&amp;</span><br><span class="line">            local_epoch[i].<span class="built_in">load</span>(std::memory_order_relaxed) != current) {</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// æœ‰çº¿ç¨‹è¿˜åœ¨æ—§ epochï¼Œä¸èƒ½æ¨è¿›</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> next_epoch = (current + <span class="number">1</span>) % <span class="number">3</span>;</span><br><span class="line">    global_epoch.<span class="built_in">store</span>(next_epoch, std::memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›æ”¶ä¸¤ä»£å‰çš„åƒåœ¾</span></span><br><span class="line">    <span class="type">int</span> reclaim_epoch = (next_epoch + <span class="number">1</span>) % <span class="number">3</span>;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(retire_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; [tid, nodes] : retire_list[reclaim_epoch]) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> node : nodes) {</span><br><span class="line">            <span class="keyword">delete</span> node;</span><br><span class="line">        }</span><br><span class="line">        nodes.<span class="built_in">clear</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/15/concurrency/%E5%9F%BA%E4%BA%8E%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%9A%84ABA%E6%B6%88%E9%99%A4%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/15/concurrency/%E5%9F%BA%E4%BA%8E%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%9A%84ABA%E6%B6%88%E9%99%A4%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">åŸºäºå¼•ç”¨è®¡æ•°çš„ ABA æ¶ˆé™¤æœºåˆ¶</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-15 20:23:48" itemprop="dateCreated datePublished" datetime="2025-09-15T20:23:48+00:00">2025-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">å¹¶å‘ç¼–ç¨‹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æºç ï¼š<a target="_blank" rel="noopener" href="https://github.com/cameron314/concurrentqueue">https://github.com/cameron314/concurrentqueue</a></p>
<p>åŸæ–‡<br>ï¼š<a target="_blank" rel="noopener" href="https://moodycamel.com/blog/2014/solving-the-aba-problem-for-lock-free-free-lists">Solving the ABA Problem for Lock-Free Free Lists</a></p>
<h2 id="å…±è¯†"><a href="#å…±è¯†" class="headerlink" title="å…±è¯†"></a>å…±è¯†</h2><ul>
<li>CAS è¶³ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼›</li>
<li>æˆ‘ä»¬è¦åšçš„æ˜¯æ¶ˆé™¤ CAS çš„ ABA é—®é¢˜ã€‚</li>
</ul>
<h2 id="å¸¸è§çš„è§£å†³æ–¹æ¡ˆ"><a href="#å¸¸è§çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§çš„è§£å†³æ–¹æ¡ˆ"></a>å¸¸è§çš„è§£å†³æ–¹æ¡ˆ</h2><h3 id="Tagged-versioned-æŒ‡é’ˆ"><a href="#Tagged-versioned-æŒ‡é’ˆ" class="headerlink" title="Tagged &#x2F; versioned æŒ‡é’ˆ"></a>Tagged &#x2F; versioned æŒ‡é’ˆ</h3><p>æ¯æ¬¡ä¿®æ”¹ head çš„åŒæ—¶ä¹Ÿå˜æ›´ä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆtag&#x2F;versionï¼‰ï¼ŒæŠŠ (pointer, version) å½“ä½œ CAS çš„å¯¹è±¡ã€‚å³ä½¿æŒ‡é’ˆ<br>å›åˆ°åŒä¸€ä¸ª Aï¼Œåªè¦ç‰ˆæœ¬å·ä¸åŒï¼ŒCAS å°±ä¼šå¤±è´¥ï¼Œé˜²æ­¢ ABAã€‚</p>
<p>ç¼ºç‚¹åŒ…æ‹¬ï¼šåœ¨æŸäº›æœºå™¨ä¸Šéœ€è¦åŒå­—å®½åº¦ï¼ˆä¸¤ä¸ª wordï¼‰CASï¼Œå¦‚æœ ç¡¬ä»¶ &#x2F; ç¼–è¯‘å™¨ &#x2F; å¹³å° ä¸æ”¯æŒå°±åªèƒ½ æ¨¡æ‹Ÿ &#x2F; é”<br>ä½ï¼›æˆ–è€…è¦å‹ç¼© pointer æˆ– tag å¤§å°ï¼Œå¯èƒ½é™åˆ¶å¯ç®¡ç†çš„èŠ‚ç‚¹æ•°é‡ &#x2F; åœ°å€ç©ºé—´ã€‚</p>
<h3 id="LL-SCï¼ˆLoad-Linked-Store-Conditionalï¼‰åŸè¯­"><a href="#LL-SCï¼ˆLoad-Linked-Store-Conditionalï¼‰åŸè¯­" class="headerlink" title="LL&#x2F;SCï¼ˆLoad-Linked &#x2F; Store-Conditionalï¼‰åŸè¯­"></a>LL&#x2F;SCï¼ˆLoad-Linked &#x2F; Store-Conditionalï¼‰åŸè¯­</h3><p>åœ¨æ”¯æŒ LL&#x2F;SC çš„æ¶æ„ä¸Šï¼Œå®ƒè‡ªç„¶å°±å¯ä»¥é˜»æ­¢ ABAï¼šå› ä¸º store-conditional ä¼šæ£€æµ‹åœ¨ load å’Œ store ä¹‹é—´åœ°å€<br>æ˜¯å¦è¢«â€œå†™è¿‡â€ï¼Œå“ªæ€•å†™äº†åæ¥æ”¹å›åŸæ¥çš„å€¼ä¹Ÿä¸è¡Œã€‚ç¼ºç‚¹æ˜¯å¾ˆå¤šä¸»æµæ¶æ„ï¼ˆå°¤å…¶ x86ï¼‰ä¸æ”¯æŒæˆ–è€…æ”¯æŒæœ‰é™ã€‚</p>
<h2 id="ä½œè€…çš„æ–¹æ³•ï¼šä»¥å¼•ç”¨è®¡æ•°ï¼‹â€œshould-be-on-freelistâ€æ ‡å¿—ï¼ˆæ ‡å¿—-å¼•ç”¨è®¡æ•°ï¼‰"><a href="#ä½œè€…çš„æ–¹æ³•ï¼šä»¥å¼•ç”¨è®¡æ•°ï¼‹â€œshould-be-on-freelistâ€æ ‡å¿—ï¼ˆæ ‡å¿—-å¼•ç”¨è®¡æ•°ï¼‰" class="headerlink" title="ä½œè€…çš„æ–¹æ³•ï¼šä»¥å¼•ç”¨è®¡æ•°ï¼‹â€œshould be on freelistâ€æ ‡å¿—ï¼ˆæ ‡å¿— + å¼•ç”¨è®¡æ•°ï¼‰"></a>ä½œè€…çš„æ–¹æ³•ï¼šä»¥å¼•ç”¨è®¡æ•°ï¼‹â€œshould be on freelistâ€æ ‡å¿—ï¼ˆæ ‡å¿— + å¼•ç”¨è®¡æ•°ï¼‰</h2><p>ä½œè€…æå‡ºäº†ä¸€ä¸ªé€‚ç”¨äº free list çš„é€šç”¨æ–¹æ³•æ¥é¿å… ABAï¼Œä¸”ä¿æŒ lockâ€free ç‰¹æ€§ã€‚</p>
<p>æç¤ºï¼šè¯¥ä»£ç åº”è¯¥ä» <code>try_get()</code> å¼€å§‹é˜…è¯»ï¼Œç„¶åå›åˆ° <code>add()</code> ï¼Œè¿™æ ·æ‰èƒ½ç†è§£è®¾è®¡å¼•ç”¨è®¡æ•°çš„æ„å›¾ï¼Œå¦åˆ™å¾ˆå®¹<br>æ˜“è¿·æƒ‘ã€‚</p>
<ul>
<li>å¼•ç”¨è®¡æ•°æ˜¯çŠ¶æ€æ ‡å¿—ï¼š<ul>
<li>è¡¨ç¤ºå½“å‰æœ‰å¤šå°‘çº¿ç¨‹æ­£åœ¨æ“ä½œèŠ‚ç‚¹ï¼›</li>
<li><strong>ç©ºé—²é“¾è¡¨æœ¬èº«ä¹ŸæŒæœ‰ä¸€ä¸ªå¯¹èŠ‚ç‚¹çš„å¼•ç”¨è®¡æ•°</strong>ã€‚</li>
</ul>
</li>
<li>ä»»ä½•çº¿ç¨‹å°è¯•æ‘˜å–ç©ºé—²é“¾è¡¨çš„èŠ‚ç‚¹ï¼ˆæ€»æ˜¯ä»å¤´éƒ¨å¼€å§‹ï¼‰æ—¶ï¼ˆ<code>try_get()</code>ï¼‰ï¼š<ul>
<li>å¿…é¡»å…ˆå¢åŠ  head çš„å¼•ç”¨è®¡æ•°ï¼ˆä¸åŒçº¿ç¨‹å¯èƒ½å¹¶å‘åœ°å°†èŠ‚ç‚¹çš„å¼•ç”¨è®¡æ•°å¢åŠ åˆ°æŸä¸ªå€¼ï¼‰ï¼›â†’ <code>(3)</code></li>
<li>next &#x3D; head-&gt;nextï¼›</li>
<li>ç„¶å CAS ç«äº‰ï¼Œå°è¯•å°† freeListHead è°ƒæ•´ä¸º nextï¼›<ul>
<li>å¦‚æœ CAS ç«äº‰æˆåŠŸï¼Œåˆ™æˆåŠŸå°† freeListHead è°ƒæ•´ä¸º nextï¼Œè¯¥èŠ‚ç‚¹è¢«æ‘˜ä¸‹ï¼›å¼•ç”¨è®¡æ•°å‡ 2ï¼ˆè‡ªå·±å¢åŠ  çš„<br>å¼•ç”¨è®¡æ•° + é“¾è¡¨æœ¬èº«æŒæœ‰çš„å¼•ç”¨è®¡æ•°ï¼‰ï¼Œæˆ‘ä»¬ç§°è¯¥çº¿ç¨‹ä¸º<code>çº¿ç¨‹ 1</code>ã€‚â†’ <code>(1)</code></li>
<li>å¦‚æœ CAS ç«äº‰å¤±è´¥ï¼Œåˆ™å›é€€ï¼šå°†è‡ªå·±æ‰€å¢åŠ çš„å¼•ç”¨è®¡æ•°å‡å»ï¼›ç”¨ CAS è¿”å›çš„æ–°çš„ head é‡è¯•ï¼ˆä¸‹ä¸€æ¬¡è·å–<br>æ–°çš„ head èŠ‚ç‚¹ï¼‰ï¼Œè¿™æ˜¯<code>çº¿ç¨‹ 2</code>ï¼›â†’ <code>(2)</code></li>
<li>æ³¨æ„ï¼šè¿™ä¸¤æ­¥ä¹‹é—´ä»¥åŠæ¯ä¸€æ­¥è‡ªèº«å†…ï¼Œå¯¹å¼•ç”¨è®¡æ•°çš„æ“ä½œéƒ½æœ‰ä¸­é—´çŠ¶æ€ï¼Œä½†æ˜¯æ­¤æ—¶å¼•ç”¨è®¡æ•°å¿…ç„¶å¤§äº 0 ï¼ˆ<br><strong>é‡ç‚¹ï¼</strong> ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>ABA é—®é¢˜</strong>ï¼šå¦‚æœæˆåŠŸæ‘˜å–èŠ‚ç‚¹çš„<code>çº¿ç¨‹ 1</code>å®ŒæˆèŠ‚ç‚¹çš„ä½¿ç”¨ï¼Œå°†èŠ‚ç‚¹åˆæ·»åŠ å›ç©ºé—²é“¾è¡¨ï¼ˆ<code>add()</code>ï¼‰ï¼š<ul>
<li>å®ƒä¼šå‘ç°æŸä¸ªçº¿ç¨‹æ­£åœ¨ç¬¬ <code>(2)</code> æ­¥çš„å›é€€è¿‡ç¨‹ä¸­ï¼ˆè¿˜æ²¡æœ‰å°†è‡ªèº«å¢åŠ çš„å¼•ç”¨è®¡æ•°å‡å›å»ï¼‰ï¼Œæ‰€ä»¥æ­¤æ—¶å¼•ç”¨è®¡<br>æ•°è¿˜æ˜¯å¤§äº 0ï¼ˆä¹Ÿå°±æ˜¯è¯´<code>çº¿ç¨‹ 1</code>ä½¿ç”¨è¯¥èŠ‚ç‚¹çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œè¯¥èŠ‚ç‚¹çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯å¤§äº 0 çš„ï¼Œä½†æ˜¯ä¸å½±å“ï¼‰<br>ã€‚</li>
<li>æ­¤æ—¶å®ƒå¯ä»¥é€‰æ‹©è‡ªæ—‹åœ°ç­‰å¾…å¼•ç”¨è®¡æ•°é™ä¸º 0 ï¼ˆå³æ‰€æœ‰ä¹‹å‰åœ¨ <code>try_get()</code> ä¸­ CAS ç«äº‰å¤±è´¥çš„çº¿ç¨‹ï¼ˆ<br>å¦‚<code>çº¿ç¨‹ 2</code>ï¼‰å›é€€æˆåŠŸï¼‰ã€‚å› ä¸ºåªæœ‰å¼•ç”¨è®¡æ•°é™ä¸º 0 äº†ï¼Œæ‰èƒ½è¯´æ˜è‡ªå·±æ˜¯å”¯ä¸€ä¸€ä¸ªå°è¯•åœ¨é“¾è¡¨ä¸Šæ“ä½œè¯¥èŠ‚ç‚¹<br>çš„çº¿ç¨‹ã€‚ä½†æ˜¯è¿™ä»æŠ€æœ¯ä¸Šè¯´ï¼Œå°±æ˜¯ä¸€ä¸ª lockã€‚</li>
<li>ä½œè€…è®¾è®¡äº†ä¸€ä¸ªæ›´èªæ˜çš„åŠæ³•ï¼š<code>add()</code> è®¾ç½®ä¸€ä¸ª <code>SHOULD_BE_ON_FREELIST</code> æ ‡å¿—ï¼Œç„¶åç›´æ¥æ”¾å¼ƒ<br>ï¼ˆ<code>add()</code>çš„ä»»åŠ¡å·²ç»å®Œæˆäº†ï¼‰ã€‚</li>
<li>è®©å¤„äºå›é€€ä¸­çš„ <code>çº¿ç¨‹ 2</code>ï¼Œåœ¨å›é€€ç»“æŸçš„æ—¶å€™ï¼Œæ£€æŸ¥ <code>SHOULD_BE_ON_FREELIST</code> æ ‡å¿—ï¼Œå¦‚æœæœ‰è¯¥æ ‡å¿—ï¼Œå¹¶ä¸”<br>è‡ªå·±å°±æ˜¯æœ€åä¸€ä¸ªæ“ä½œè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹çš„è¯ï¼ˆå³æ­¤æ—¶çš„å¼•ç”¨è®¡æ•°å·²ç»é™ä¸º 0 äº†ï¼‰ï¼Œå°±å¸®åŠ© <code>add()</code> æŠŠè¯¥èŠ‚ç‚¹æ·»<br>åŠ åˆ° free listã€‚</li>
</ul>
</li>
</ul>
<h3 id="å¼•ç”¨è®¡æ•°"><a href="#å¼•ç”¨è®¡æ•°" class="headerlink" title="å¼•ç”¨è®¡æ•°"></a>å¼•ç”¨è®¡æ•°</h3><p>ç°åœ¨æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹å¼•ç”¨è®¡æ•°çš„ä½œç”¨ï¼š</p>
<ul>
<li><p>å¦‚æœ <code>refs &gt; 0</code>ï¼š</p>
<ul>
<li>(1) è¦ä¹ˆè¯¥èŠ‚ç‚¹åœ¨é“¾è¡¨ä¸Šï¼›</li>
<li>(2) è¦ä¹ˆæœ‰çº¿ç¨‹æ­£åœ¨æ“ä½œè¯¥èŠ‚ç‚¹ï¼ˆå‡†ç¡®æ¥è®²ï¼Œæ˜¯åœ¨ <code>try_get()</code>ï¼‰ï¼›</li>
<li>(3) è¦ä¹ˆä»¥ä¸Šä¸¤ç§æƒ…å†µåŒæ—¶å­˜åœ¨ã€‚</li>
<li>æ³¨ï¼š(1)(2) å¯ä»¥åªå­˜åœ¨ä¸€ç§ï¼Œè§ä¸Šé¢çš„ ABA é—®é¢˜çš„æè¿°ã€‚</li>
</ul>
</li>
<li><p>å¦‚æœ <code>refs == 0</code>ï¼š</p>
<ul>
<li>èŠ‚ç‚¹å·²ç»è¢«ä»ç©ºé—²é“¾è¡¨ä¸Šå–ä¸‹ï¼›</li>
<li>å¹¶ä¸”å…¶ä»–çº¿ç¨‹éƒ½å·²ç»ä» <code>try_get()</code> æˆåŠŸå›é€€äº†ã€‚</li>
</ul>
</li>
</ul>
<p>å¦‚æœç¬¬ä¸‰ä¸ªçº¿ç¨‹ï¼Œä¸<code>çº¿ç¨‹ 1</code>ã€<code>çº¿ç¨‹ 2</code>ä¸€èµ·è¿›å…¥ä¸Šé¢çš„ <code>try_get()</code> ç«äº‰ï¼Œä½†æ˜¯å½“<code>çº¿ç¨‹ 3</code>å³å°†æ‰§è¡Œæ­¥<br>éª¤<code>(3)</code>æ—¶ï¼Œå‘ç° <code>refs == 0</code>ï¼Œå®ƒå°±ä¸èƒ½å¤Ÿå†å¢åŠ  head çš„å¼•ç”¨è®¡æ•°äº†ï¼Œå› ä¸ºèŠ‚ç‚¹å·²ç»è¢«æˆåŠŸå–ä¸‹ã€‚å¦åˆ™å½“å®ƒæˆ<br>åŠŸå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå†å»æ‹¿å– head-&gt;next çš„æ—¶å€™ï¼Œæ˜¯æœªå®šä¹‰è¡Œä¸ºã€‚</p>
<p>æ­£æ˜¯åŸºäºæ­¤ï¼Œåœ¨æ­¥éª¤<code>(3)</code>å¢åŠ å¼•ç”¨è®¡æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ <code>refs == 0 ?</code> å’Œä½¿ç”¨ CAS å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœ<br>ä¸ç¬¦åˆé¢„æœŸï¼Œåˆ™æ”¾å¼ƒå¢åŠ ï¼Œè¿›å…¥ä¸‹ä¸€è½®é‡è¯•ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((refs &amp; REFS_MASK) == <span class="number">0</span> || !head-&gt;freeListRefs.<span class="built_in">compare_exchange_strong</span>(refs, refs + <span class="number">1</span>, std::memory_order_acquire)) &#123;</span><br><span class="line">	head = freeListHead.<span class="built_in">load</span>(std::memory_order_acquire);</span><br><span class="line">	<span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/15/concurrency/ABA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/15/concurrency/ABA/" class="post-title-link" itemprop="url">CAS çš„ ABAé—®é¢˜</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-15 19:48:58" itemprop="dateCreated datePublished" datetime="2025-09-15T19:48:58+00:00">2025-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">å¹¶å‘ç¼–ç¨‹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ABA-é—®é¢˜"><a href="#ABA-é—®é¢˜" class="headerlink" title="ABA é—®é¢˜"></a>ABA é—®é¢˜</h2><p>åœ¨å…¸å‹çš„æ— é”æ ˆ&#x2F;é˜Ÿåˆ—é‡Œï¼ŒæŒ‡é’ˆä¼šè¢«åå¤å¤ç”¨ï¼ˆæ¯”å¦‚ pop å‡ºå† push å›å»ï¼‰ã€‚å¦‚æœåªç”¨ compare_exchange æ¯”è¾ƒæŒ‡<br>é’ˆï¼Œé‚£ä¹ˆï¼š</p>
<ul>
<li>T1 è¯»åˆ° A</li>
<li>T2 æŠŠ A â†’ B â†’ A æ”¹ä¸€åœˆ</li>
<li>T1 CAS æ—¶çœ‹åˆ°è¿˜æ˜¯ Aï¼Œä»¥ä¸ºç»“æ„æ²¡å˜ï¼Œä½†å…¶å®å·²ç»å‘ç”Ÿå˜åŒ–</li>
</ul>
<p>è¿™å°±æ˜¯ ABA é—®é¢˜ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><h3 id="ç‰ˆæœ¬æ ‡è®°æŒ‡é’ˆæ–¹æ¡ˆ"><a href="#ç‰ˆæœ¬æ ‡è®°æŒ‡é’ˆæ–¹æ¡ˆ" class="headerlink" title="ç‰ˆæœ¬æ ‡è®°æŒ‡é’ˆæ–¹æ¡ˆ"></a>ç‰ˆæœ¬æ ‡è®°æŒ‡é’ˆæ–¹æ¡ˆ</h3><p>â€Œ æ ¸å¿ƒæ€æƒ³ â€Œï¼šä¸ºæ¯ä¸ªæŒ‡é’ˆé™„åŠ ä¸€ä¸ªç‰ˆæœ¬å·æ ‡è®°ï¼Œæ¯æ¬¡ä¿®æ”¹æ—¶é€’å¢ç‰ˆæœ¬å·ã€‚</p>
<p>â€Œ å®ç°è¦ç‚¹ â€Œï¼š</p>
<ul>
<li>éœ€è¦åŒå­— CAS(DCAS)ç¡¬ä»¶æ”¯æŒ</li>
<li>æ¯æ¬¡ä¿®æ”¹å¤´æŒ‡é’ˆæ—¶é€’å¢æ ‡è®°å€¼</li>
<li>å³ä½¿æŒ‡é’ˆåœ°å€ç›¸åŒï¼Œæ ‡è®°å€¼ä¸åŒä¹Ÿä¼šä½¿ CAS å¤±è´¥</li>
<li>é€‚ç”¨äºæ”¯æŒ DCAS çš„å¹³å°(å¦‚æŸäº› ARM æ¶æ„)</li>
<li>åœ¨é DCAS å¹³å°ä¹Ÿå¯ç”¨ï¼Œå‰ææ˜¯å°† data + version æ”¾å…¥ä¸€ä¸ªæœºå™¨å­—ä¸­ï¼Œä»¥ç»´æŒæ“ä½œçš„åŸå­æ€§</li>
</ul>
<p>â€Œ é™åˆ¶ â€Œï¼š</p>
<ul>
<li>åœ¨æŸäº›æœºå™¨ä¸Šéœ€è¦åŒå­—å®½åº¦ï¼ˆä¸¤ä¸ª wordï¼‰CASï¼›</li>
<li>å¦‚æœç¡¬ä»¶ï¼ç¼–è¯‘å™¨ï¼å¹³å°ä¸æ”¯æŒå°±åªèƒ½æ¨¡æ‹Ÿï¼é”ä½ï¼›æˆ–è€…è¦å‹ç¼© pointer æˆ– tag å¤§å°ï¼Œå¯èƒ½é™åˆ¶å¯ç®¡ç†çš„èŠ‚ç‚¹æ•°é‡ï¼åœ°å€ç©ºé—´ã€‚</li>
</ul>
<h3 id="å¼•ç”¨è®¡æ•°æ–¹æ¡ˆ"><a href="#å¼•ç”¨è®¡æ•°æ–¹æ¡ˆ" class="headerlink" title="å¼•ç”¨è®¡æ•°æ–¹æ¡ˆ"></a>å¼•ç”¨è®¡æ•°æ–¹æ¡ˆ</h3><p>â€Œ æ ¸å¿ƒæ€æƒ³ â€Œï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤å¼•ç”¨è®¡æ•°ï¼Œé˜²æ­¢èŠ‚ç‚¹åœ¨è¢«ä½¿ç”¨æ—¶è¢«é‡æ–°æ·»åŠ åˆ°åˆ—è¡¨ã€‚</p>
<p>â€Œ å…³é”®å®ç°ç»†èŠ‚ â€Œï¼š</p>
<p>æ¯ä¸ªèŠ‚ç‚¹åŒ…å« freeListRefs(å¼•ç”¨è®¡æ•°)å’Œ freeListNext(ä¸‹ä¸€èŠ‚ç‚¹æŒ‡é’ˆ) å¼•ç”¨è®¡æ•°é«˜ä½ç”¨ä½œ â€œåº”è¿”å›è‡ªç”±åˆ—è¡¨â€<br>æ ‡å¿—ä½ try_get()æ“ä½œå‰ç¡®ä¿å¼•ç”¨è®¡æ•°ä¸ä¸ºé›¶ add()æ“ä½œä½¿ç”¨åŸå­æ“ä½œç®¡ç†å¼•ç”¨è®¡æ•°å’Œæ ‡å¿—ä½ â€Œ ä¼˜åŠ¿ â€Œï¼š</p>
<p>å®Œå…¨é€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œä¸ä¾èµ–ç‰¹å®šç¡¬ä»¶ç‰¹æ€§ä¿æŒçœŸæ­£çš„é”æ— å…³æ€§è´¨æ­£ç¡®å¤„ç†å¹¶å‘åœºæ™¯ä¸‹çš„å„ç§ç«äº‰æ¡ä»¶</p>
<h3 id="Hazard-Pointerï¼ˆå±é™©æŒ‡é’ˆï¼‰"><a href="#Hazard-Pointerï¼ˆå±é™©æŒ‡é’ˆï¼‰" class="headerlink" title="Hazard Pointerï¼ˆå±é™©æŒ‡é’ˆï¼‰"></a>Hazard Pointerï¼ˆå±é™©æŒ‡é’ˆï¼‰</h3><p>æ€è·¯ï¼šæ¯ä¸ªçº¿ç¨‹åœ¨è®¿é—®å…±äº«æŒ‡é’ˆä¹‹å‰ï¼ŒæŠŠè‡ªå·±æ­£åœ¨è®¿é—®çš„æŒ‡é’ˆå†™åˆ°ä¸€ä¸ªå…¨å±€å¯è§çš„â€œhazard pointerâ€é‡Œã€‚</p>
<p>ä½œç”¨ï¼šå…¶ä»–çº¿ç¨‹åœ¨æƒ³è¦å›æ”¶è¿™ä¸ªèŠ‚ç‚¹å†…å­˜æ—¶ï¼Œå¿…é¡»æ£€æŸ¥æ‰€æœ‰çº¿ç¨‹çš„ hazard pointersï¼Œå¦‚æœå‘ç°æœ‰äººè¿˜åœ¨ç”¨è¿™ä¸ªèŠ‚<br>ç‚¹ï¼Œå°±ä¸èƒ½é‡Šæ”¾ã€‚</p>
<p>ä¼˜ç‚¹ï¼šç®€å•ç›´æ¥ï¼Œå†…å­˜å¯ä»¥å®‰å…¨å›æ”¶ã€‚</p>
<p>ç¼ºç‚¹ï¼šç»´æŠ¤ hazard pointers æœ‰ä¸€å®šå¼€é”€ï¼Œæ¯æ¬¡å›æ”¶éƒ½è¦æ£€æŸ¥æ‰€æœ‰çº¿ç¨‹ã€‚</p>
<h3 id="Epoch-Based-Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼Œç®€ç§°-Epoch-GCï¼‰"><a href="#Epoch-Based-Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼Œç®€ç§°-Epoch-GCï¼‰" class="headerlink" title="Epoch-Based Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼Œç®€ç§° Epoch GCï¼‰"></a>Epoch-Based Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼Œç®€ç§° Epoch GCï¼‰</h3><p>æ€è·¯ï¼šæŠŠæ—¶é—´åˆ‡åˆ†æˆ epochï¼ˆä¸–ä»£ï¼‰ã€‚çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºæ—¶å£°æ˜è‡ªå·±åœ¨æŸä¸ª epochã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤åï¼Œå…ˆæ”¾åˆ°ä¸€<br>ä¸ªâ€œå»¶è¿Ÿå›æ”¶é˜Ÿåˆ—â€ï¼Œç­‰åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½ç¦»å¼€è¿™ä¸ª epoch ä¹‹åï¼Œæ‰èƒ½çœŸæ­£é‡Šæ”¾è¿™äº›èŠ‚ç‚¹ã€‚</p>
<p>ä½œç”¨ï¼šä¿è¯æ²¡æœ‰çº¿ç¨‹ä¼šåœ¨æ—§ epoch ä¸­è®¿é—®åˆ°å·²ç»é‡Šæ”¾çš„èŠ‚ç‚¹ã€‚</p>
<p>ä¼˜ç‚¹ï¼šæ¯” hazard pointer æ›´é«˜æ•ˆï¼ˆä¸ç”¨é€ä¸ªæ£€æŸ¥æŒ‡é’ˆï¼‰ã€‚</p>
<p>ç¼ºç‚¹ï¼šéœ€è¦æ‰€æœ‰çº¿ç¨‹éƒ½å‘¨æœŸæ€§åœ°æŠ¥å‘Šè‡ªå·±æ´»è·ƒçš„ epochï¼Œå¦åˆ™å†…å­˜å¯èƒ½è¿Ÿè¿Ÿå›æ”¶ä¸äº†ã€‚</p>
<p>ğŸš© ä¸ºä»€ä¹ˆä¼šå’Œ ABA æœ‰å…³ï¼Ÿ</p>
<p>åƒ Michael-Scott é˜Ÿåˆ—è¿™ç§é“¾è¡¨ç»“æ„ï¼ŒèŠ‚ç‚¹è¢« pop å‡ºé˜Ÿååœ°å€å¯èƒ½è¢«é‡ç”¨ã€‚å¦‚æœæ²¡æœ‰å®‰å…¨çš„å†…å­˜å›æ”¶ï¼Œå¦ä¸€ä¸ªçº¿<br>ç¨‹å¯èƒ½ CAS æˆåŠŸæŒ‡å‘äº†ä¸€ä¸ªâ€œå·²ç»è¢«é‡Šæ”¾å¹¶é‡ç”¨çš„åœ°å€â€ï¼Œè¿™å°±æ˜¯ ABA çš„æ ¹æºã€‚æ‰€ä»¥ hazard pointer æˆ– epoch<br>GC æ˜¯åœ¨é“¾è¡¨é˜Ÿåˆ—é‡Œç”¨æ¥é¿å…è¿™ç§ æ‚¬ç©ºå¼•ç”¨ + ABA çš„ã€‚</p>
<p>è€Œ moodycamel:: ConcurrentQueue å› ä¸ºç”¨çš„æ˜¯ ç¯å½¢ buffer + sequence numberï¼ŒèŠ‚ç‚¹ä¸ä¼šåå¤ malloc&#x2F;freeï¼Œ<br>æ‰€ä»¥æ ¹æœ¬å°±ä¸éœ€è¦ hazard pointer æˆ– epoch GCã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/14/concurrency/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%B3%95%E5%88%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/14/concurrency/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%B3%95%E5%88%99/" class="post-title-link" itemprop="url">å¹¶å‘ç¼–ç¨‹æ³•åˆ™</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-14 16:10:01" itemprop="dateCreated datePublished" datetime="2025-09-14T16:10:01+00:00">2025-09-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TBB-çš„ç‰¹æ®Šæ€§"><a href="#TBB-çš„ç‰¹æ®Šæ€§" class="headerlink" title="TBB çš„ç‰¹æ®Šæ€§"></a>TBB çš„ç‰¹æ®Šæ€§</h1><p><strong>æœ¬æ–‡çš„æ³•åˆ™æ˜¯ä»¥çº¿ç¨‹ä¸ºè°ƒåº¦å•ä½çš„ã€‚</strong></p>
<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ TBB ï¼Œé‚£ä¹ˆè¯·å°† â€œçº¿ç¨‹â€ å¯¹åº”ä¸º â€œä»»åŠ¡â€ï¼Œè€Œå°†æœ¬æ–‡çš„â€œä»»åŠ¡â€ å¯¹åº”ä¸ºâ€œè½½è·â€ï¼ˆ payloadsï¼‰ã€‚</p>
<p>å› ä¸º TBB æ˜¯ä»¥ä»»åŠ¡ä¸ºè°ƒåº¦å•ä½çš„ï¼š</p>
<ul>
<li>æ¯ä¸ª â€œä»»åŠ¡â€ æ˜¯å¹¶å‘è¿è¡Œçš„æœ€å°å•ä½ï¼Œå¿…é¡»ä¿è¯æ•°æ®ç‹¬ç«‹æˆ–çº¿ç¨‹å®‰å…¨ã€‚</li>
<li>TBB é‡‡ç”¨ â€œä»»åŠ¡çªƒå–â€ ç®—æ³•æ¥ä¿è¯çº¿ç¨‹çš„å¤æ‚å‡è¡¡ï¼Œæ‰€ä»¥è‹¥å¹²ä»»åŠ¡å¯èƒ½è¢«åŒä¸€çº¿ç¨‹æˆ–ä¸åŒçº¿ç¨‹è¿è¡Œã€‚</li>
</ul>
<h1 id="ç»éªŒæ³•åˆ™"><a href="#ç»éªŒæ³•åˆ™" class="headerlink" title="ç»éªŒæ³•åˆ™"></a>ç»éªŒæ³•åˆ™</h1><h2 id="ä»¥-tasksPerThread-æŒ‰éœ€åˆ†é…çº¿ç¨‹"><a href="#ä»¥-tasksPerThread-æŒ‰éœ€åˆ†é…çº¿ç¨‹" class="headerlink" title="ä»¥ tasksPerThread æŒ‰éœ€åˆ†é…çº¿ç¨‹"></a>ä»¥ tasksPerThread æŒ‰éœ€åˆ†é…çº¿ç¨‹</h2><ul>
<li>tasksPerThreadï¼šå‡åŒ€æ€§ã€‚å¦‚æœæ¯ä¸ªçº¿ç¨‹åˆ†é…çš„ä»»åŠ¡æ•°ä¸å‡åŒ€ï¼Œé‚£ä¹ˆä»»åŠ¡æ•°æœ€å¤šçš„çº¿ç¨‹å°±ä¼šæˆä¸ºç“¶é¢ˆã€‚</li>
<li>æŒ‰éœ€åˆ†é…çº¿ç¨‹ï¼šå¦‚æœä»»åŠ¡å¯ä»¥å¾ˆå¿«å®Œæˆï¼Œé‚£ä¹ˆæ²¡æœ‰å¿…è¦å¼€å¯è¿‡å¤šçš„çº¿ç¨‹ï¼Œå¦åˆ™è°ƒåº¦å¼€é”€ä¹Ÿä¸å¯å°è§‘ã€‚</li>
</ul>
<h2 id="ä»¥ç©ºé—´æ¢æ—¶é—´"><a href="#ä»¥ç©ºé—´æ¢æ—¶é—´" class="headerlink" title="ä»¥ç©ºé—´æ¢æ—¶é—´"></a>ä»¥ç©ºé—´æ¢æ—¶é—´</h2><p>ä¸ºäº†ä»»åŠ¡èƒ½å¹¶å‘è¿è¡Œï¼Œè¿›è¡Œä»»åŠ¡åˆ†éš”æ—¶ï¼Œå¿…é¡»å°½å¯èƒ½å‡å°‘æ•°æ®å…±äº«ã€‚<br>æ‰€ä»¥ä¸è¦åæƒœç©ºé—´ï¼Œä¸ºæ¯ä¸ªä»»åŠ¡å•ç‹¬å¼€è¾Ÿå†…å­˜ï¼ˆä¸è®ºæ˜¯ä¸ºè¾“å…¥è¿˜æ˜¯è¾“å‡ºç›®çš„ï¼‰éƒ½æ˜¯å€¼å¾—ä¸”å¿…è¦çš„ã€‚</p>
<h2 id="é•¿ä¸´ç•ŒåŒºä½¿ç”¨-lock-æ¡ä»¶å˜é‡"><a href="#é•¿ä¸´ç•ŒåŒºä½¿ç”¨-lock-æ¡ä»¶å˜é‡" class="headerlink" title="é•¿ä¸´ç•ŒåŒºä½¿ç”¨ lock + æ¡ä»¶å˜é‡"></a>é•¿ä¸´ç•ŒåŒºä½¿ç”¨ lock + æ¡ä»¶å˜é‡</h2><p>å¦‚æœä¸€ä¸ªä»»åŠ¡çš„ä¸´ç•ŒåŒºæ¯”è¾ƒå¤§ï¼Œæ„å‘³ç€è¯¥ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹åœ¨çŸ­æ—¶é—´å†…æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºã€‚<br>ä¸å…¶è®©è¿™äº›çº¿ç¨‹å¿™ç­‰ï¼Œä¸å¦‚é‡Šæ”¾ CPU è¿›å…¥é˜»å¡ &#x2F; ä¼‘çœ ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/14/concurrency/MPMC-Lock-free-Queue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/14/concurrency/MPMC-Lock-free-Queue/" class="post-title-link" itemprop="url">å¤šç”Ÿäº§è€… - å¤šæ¶ˆè´¹è€… æ— é”é˜Ÿåˆ—</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-14 15:05:08" itemprop="dateCreated datePublished" datetime="2025-09-14T15:05:08+00:00">2025-09-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/concurrency/" itemprop="url" rel="index"><span itemprop="name">concurrency</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ˜¯é˜…è¯» Cameron Desrochers çš„<br><a target="_blank" rel="noopener" href="https://moodycamel.com/blog/2014/a-fast-general-purpose-lock-free-queue-for-c++">A Fast General Purpose Lock-Free Queue for C++</a><br>æºç çš„ç¬”è®°ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://moodycamel.com/blog/2014/detailed-design-of-a-lock-free-queue">Detailed Design of a Lock-Free Queue</a></li>
<li><a target="_blank" rel="noopener" href="https://moodycamel.com/blog/2014/solving-the-aba-problem-for-lock-free-free-lists">Solving the ABA Problem for Lock-Free Free Lists</a></li>
</ul>
<h2 id="ç³»ç»Ÿæ¦‚è§ˆ"><a href="#ç³»ç»Ÿæ¦‚è§ˆ" class="headerlink" title="ç³»ç»Ÿæ¦‚è§ˆ"></a>ç³»ç»Ÿæ¦‚è§ˆ</h2><p>MPMC é˜Ÿåˆ—ç”±ä¸€ç³»åˆ— SPMC é˜Ÿåˆ—ç»„æˆã€‚æ¶ˆè´¹è€…ä½¿ç”¨å¯å‘å¼ (heuristic) æ¥å†³å®šæ¶ˆè´¹å“ªä¸ª SPMC é˜Ÿåˆ—ã€‚å…è®¸æ‰¹é‡å…¥åˆ—<br>å’Œå‡ºåˆ—ï¼Œåªéœ€è¦å¾ˆå°çš„é¢å¤–å¼€é”€ã€‚</p>
<p>producer éœ€è¦ä¸€äº› thread-local æ•°æ®ï¼› consumer ä¹Ÿå¯ä»¥ç”¨ä¸€äº›å¯é€‰çš„ thread-local æ•°æ®æ¥åŠ é€Ÿï¼›è¿™äº›<br>thread-local æ•°æ®å¯ä»¥ä¸ç”¨æˆ·åˆ†é…çš„ tokens å…³è”ï¼›å¦‚æœç”¨æˆ·æ²¡æœ‰ä¸ºç”Ÿäº§è€…æä¾› tokens ï¼Œåˆ™ä½¿ç”¨æ— é”å“ˆå¸Œè¡¨ï¼ˆ<br>ä»¥å½“å‰çº¿ç¨‹ ID ä¸ºé”®ï¼‰æ¥æŸ¥æ‰¾çº¿ç¨‹æœ¬åœ°ç”Ÿäº§è€…é˜Ÿåˆ—ï¼šæ¯ä¸ª SPMC é˜Ÿåˆ—éƒ½ä½¿ç”¨ä¸€ä¸ªé¢„åˆ†é…çš„ token ï¼ˆæˆ–éšå¼åˆ†é…çš„<br>tokenï¼Œå¦‚æœæ²¡æœ‰æä¾›çš„è¯ï¼‰æ¥åˆ›å»ºã€‚ç”±äº token åŒ…å«ç›¸å½“äºçº¿ç¨‹ç‰¹å®šçš„æ•°æ®ï¼Œå› æ­¤å®ƒä»¬ä¸åº”è¯¥åŒæ—¶åœ¨å¤šä¸ªçº¿ç¨‹ä¸­<br>ä½¿ç”¨ï¼ˆå°½ç®¡å¯ä»¥å°† token çš„æ‰€æœ‰æƒè½¬ç§»ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼›ç‰¹åˆ«æ˜¯ï¼Œè¿™å…è®¸åœ¨çº¿ç¨‹æ± ä»»åŠ¡ä¸­ä½¿ç”¨ä»¤ç‰Œï¼Œå³ä½¿è¿è¡Œä»»åŠ¡<br>çš„çº¿ç¨‹åœ¨ä¸­é€”å‘ç”Ÿå˜åŒ–ï¼‰ã€‚</p>
<p>æ‰€æœ‰ç”Ÿäº§è€…é˜Ÿåˆ—éƒ½ä»¥æ— é”é“¾è¡¨çš„å½¢å¼è¿æ¥åœ¨ä¸€èµ·ã€‚å½“æ˜¾å¼ç”Ÿäº§è€…ä¸å†æœ‰å…ƒç´ è¢«æ·»åŠ æ—¶ï¼ˆå³å…¶ä»¤ç‰Œè¢«é”€æ¯ï¼‰ï¼Œå®ƒä¼šè¢«<br>æ ‡è®°ä¸ºä¸ä»»ä½•ç”Ÿäº§è€…éƒ½æ— å…³è”ï¼Œä½†å®ƒä¼šä¿ç•™åœ¨é“¾è¡¨ä¸­ï¼Œä¸”å…¶å†…å­˜ä¸ä¼šè¢«é‡Šæ”¾ï¼›ä¸‹ä¸€ä¸ªæ–°ç”Ÿäº§è€…ä¼šé‡ç”¨æ—§ç”Ÿäº§è€…çš„å†…<br>å­˜ï¼ˆè¿™æ ·ï¼Œæ— é”ç”Ÿäº§è€…åˆ—è¡¨å°±åªèƒ½æ·»åŠ ï¼‰ã€‚éšå¼ç”Ÿäº§è€…æ°¸è¿œä¸ä¼šè¢«é”€æ¯ï¼ˆç›´åˆ°é«˜å±‚é˜Ÿåˆ—æœ¬èº«è¢«é”€æ¯ï¼‰ï¼Œå› ä¸ºæ— æ³•çŸ¥<br>é“ç»™å®šçº¿ç¨‹æ˜¯å¦å·²å®Œæˆå¯¹æ•°æ®ç»“æ„çš„ä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ€åæƒ…å†µä¸‹çš„å‡ºé˜Ÿé€Ÿåº¦å–å†³äºç”Ÿäº§è€…é˜Ÿåˆ—çš„æ•°é‡ï¼Œå³ä½¿<br>å®ƒä»¬éƒ½ä¸ºç©ºã€‚</p>
<p>æ˜¾å¼ç”Ÿäº§è€…é˜Ÿåˆ—å’Œéšå¼ç”Ÿäº§è€…é˜Ÿåˆ—çš„ç”Ÿå‘½å‘¨æœŸå­˜åœ¨æ ¹æœ¬åŒºåˆ«ï¼šæ˜¾å¼ç”Ÿäº§è€…é˜Ÿåˆ—çš„ç”Ÿäº§ç”Ÿå‘½å‘¨æœŸæœ‰é™ï¼Œä¸ä»¤ç‰Œçš„ç”Ÿå‘½<br>å‘¨æœŸç»‘å®šï¼›è€Œéšå¼ç”Ÿäº§è€…é˜Ÿåˆ—çš„ç”Ÿäº§ç”Ÿå‘½å‘¨æœŸä¸å—é™åˆ¶ï¼Œä¸”ä¸é«˜çº§é˜Ÿåˆ—æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸç›¸åŒã€‚å› æ­¤ï¼Œä¸ºäº†æœ€å¤§åŒ–é€Ÿ<br>åº¦å’Œå†…å­˜åˆ©ç”¨ç‡ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ç§ç•¥æœ‰ä¸åŒçš„ SPMC ç®—æ³•ã€‚é€šå¸¸ï¼Œæ˜¾å¼ç”Ÿäº§è€…é˜Ÿåˆ—è®¾è®¡å¾—æ›´å¿«ï¼Œå ç”¨çš„å†…å­˜ä¹Ÿæ›´å¤š<br>ï¼›è€Œéšå¼ç”Ÿäº§è€…é˜Ÿåˆ—è®¾è®¡å¾—æ›´æ…¢ï¼Œä½†ä¼šå°†æ›´å¤šå†…å­˜å›æ”¶åˆ°é«˜çº§é˜Ÿåˆ—çš„å…¨å±€æ± ä¸­ã€‚ä¸ºäº†è·å¾—æœ€ä½³é€Ÿåº¦ï¼Œè¯·å§‹ç»ˆä½¿ç”¨æ˜¾<br>å¼ä»¤ç‰Œï¼ˆé™¤éæ‚¨è§‰å¾—å®ƒå¤ªä¸æ–¹ä¾¿ï¼‰ã€‚</p>
<p>ä»»ä½•åˆ†é…çš„å†…å­˜åªæœ‰åœ¨é«˜çº§é˜Ÿåˆ—è¢«é”€æ¯æ—¶æ‰ä¼šé‡Šæ”¾ï¼ˆå°½ç®¡å­˜åœ¨ä¸€äº›é‡ç”¨æœºåˆ¶ï¼‰ã€‚å†…å­˜åˆ†é…å¯ä»¥é¢„å…ˆå®Œæˆï¼Œå¦‚æœå†…å­˜<br>ä¸è¶³ï¼Œæ“ä½œå°±ä¼šå¤±è´¥ï¼ˆè€Œä¸æ˜¯åˆ†é…æ›´å¤šå†…å­˜ï¼‰ã€‚å¦‚æœéœ€è¦ï¼Œç”¨æˆ·å¯ä»¥è¦†ç›–å„ç§é»˜è®¤å¤§å°å‚æ•°ï¼ˆä»¥åŠé˜Ÿåˆ—ä½¿ç”¨çš„å†…å­˜<br>åˆ†é…å‡½æ•°ï¼‰ã€‚</p>
<h2 id="Full-API-pseudocode"><a href="#Full-API-pseudocode" class="headerlink" title="Full API (pseudocode)"></a>Full API (pseudocode)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Allocates more memory if necessary</span></span><br><span class="line">enqueue(item) : bool</span><br><span class="line">enqueue(prod_token, item) : bool</span><br><span class="line">enqueue_bulk(item_first, count) : bool</span><br><span class="line">enqueue_bulk(prod_token, item_first, count) : bool</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fails if not enough memory to enqueue</span></span><br><span class="line">try_enqueue(item) : bool</span><br><span class="line">try_enqueue(prod_token, item) : bool</span><br><span class="line">try_enqueue_bulk(item_first, count) : bool</span><br><span class="line">try_enqueue_bulk(prod_token, item_first, count) : bool</span><br><span class="line"></span><br><span class="line"><span class="comment"># Attempts to dequeue from the queue (never allocates)</span></span><br><span class="line">try_dequeue(item&amp;) : bool</span><br><span class="line">try_dequeue(cons_token, item&amp;) : bool</span><br><span class="line">try_dequeue_bulk(item_first, max) : size_t</span><br><span class="line">try_dequeue_bulk(cons_token, item_first, max) : size_t</span><br><span class="line"></span><br><span class="line"><span class="comment"># If you happen to know which producer you want to dequeue from</span></span><br><span class="line">try_dequeue_from_producer(prod_token, item&amp;) : bool</span><br><span class="line">try_dequeue_bulk_from_producer(prod_token, item_first, max) : size_t</span><br><span class="line"></span><br><span class="line"><span class="comment"># A not-necessarily-accurate count of the total number of elements</span></span><br><span class="line">size_approx() : size_t</span><br></pre></td></tr></table></figure>

<h2 id="Producer-Queue-SPMC-Design"><a href="#Producer-Queue-SPMC-Design" class="headerlink" title="Producer Queue (SPMC) Design"></a>Producer Queue (SPMC) Design</h2><h3 id="éšå¼å’Œæ˜¾å¼ç‰ˆæœ¬çš„å…±äº«è®¾è®¡"><a href="#éšå¼å’Œæ˜¾å¼ç‰ˆæœ¬çš„å…±äº«è®¾è®¡" class="headerlink" title="éšå¼å’Œæ˜¾å¼ç‰ˆæœ¬çš„å…±äº«è®¾è®¡"></a>éšå¼å’Œæ˜¾å¼ç‰ˆæœ¬çš„å…±äº«è®¾è®¡</h3><p>ç”Ÿäº§è€…é˜Ÿåˆ—ç”±å—ç»„æˆï¼ˆæ˜¾å¼å’Œéšå¼ç”Ÿäº§è€…é˜Ÿåˆ—ä½¿ç”¨ç›¸åŒçš„å—å¯¹è±¡ï¼Œä»¥å®ç°æ›´å¥½çš„å†…å­˜å…±äº«ï¼‰ã€‚åˆå§‹çŠ¶æ€ä¸‹ï¼Œå®ƒæ²¡æœ‰<br>å—ã€‚æ¯ä¸ªå—å¯ä»¥å®¹çº³å›ºå®šæ•°é‡çš„å…ƒç´ ï¼ˆæ‰€æœ‰å—çš„å®¹é‡ç›¸åŒï¼Œå‡ä¸º 2 çš„å¹‚ï¼‰ã€‚æ­¤å¤–ï¼Œå—åŒ…å«ä¸€ä¸ªæ ‡å¿—ï¼ŒæŒ‡ç¤ºå·²å¡«å……<br>çš„æ§½ä½æ˜¯å¦å·²è¢«å®Œå…¨æ¶ˆè€—ï¼ˆæ˜¾å¼ç‰ˆæœ¬ä½¿ç”¨æ­¤æ ‡å¿—æ¥åˆ¤æ–­å—ä½•æ—¶ä¸ºç©ºï¼‰ï¼Œä»¥åŠä¸€ä¸ªåŸå­è®¡æ•°å™¨ï¼Œç”¨äºè®¡æ•°å·²å®Œå…¨å‡ºé˜Ÿ<br>çš„å…ƒç´ æ•°é‡ï¼ˆéšå¼ç‰ˆæœ¬ä½¿ç”¨æ­¤æ ‡å¿—æ¥åˆ¤æ–­å—ä½•æ—¶ä¸ºç©ºï¼‰ã€‚</p>
<p>ä¸ºäº†å®ç°æ— é”æ“ä½œï¼Œç”Ÿäº§è€…é˜Ÿåˆ—å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ— é™æ•°ç»„ã€‚å°¾éƒ¨ç´¢å¼•æŒ‡ç¤ºç”Ÿäº§è€…ä¸‹ä¸€ä¸ªå¯ç”¨çš„æ§½ä½ï¼›å®ƒåŒ<br>æ—¶ä¹Ÿæ˜¯å·²å…¥é˜Ÿå…ƒç´ æ•°é‡çš„ä¸¤å€ï¼ˆ <strong>å…¥é˜Ÿè®¡æ•° (enqueue count)</strong> ï¼‰ã€‚å°¾éƒ¨ç´¢å¼•ä»…ç”±ç”Ÿäº§è€…å†™å…¥ï¼Œå¹¶ä¸”å§‹ç»ˆé€’å¢ï¼ˆé™¤<br>éæº¢å‡ºå¹¶å›ç»•ï¼Œä½†å°±æˆ‘ä»¬çš„ç›®çš„è€Œè¨€ï¼Œè¿™ç§æƒ…å†µä»è¢«è§†ä¸ºâ€œé€’å¢â€ï¼‰ã€‚ç”±äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ›´æ–°ç›¸å…³å˜é‡ï¼Œå› æ­¤ç”Ÿäº§<br>ä¸€ä¸ªå…ƒç´ çš„è¿‡ç¨‹éå¸¸ç®€å•ã€‚å¤´ç´¢å¼•æŒ‡ç¤ºä¸‹ä¸€ä¸ªå¯ä»¥è¢«æ¶ˆè´¹çš„å…ƒç´ ã€‚å¤´ç´¢å¼•ç”±æ¶ˆè´¹è€…åŸå­åœ°é€’å¢ï¼Œå¯èƒ½å¹¶å‘è¿›è¡Œã€‚ä¸º<br>äº†é˜²æ­¢å¤´ç´¢å¼•è¾¾åˆ°&#x2F;è¶…è¿‡æ„ŸçŸ¥åˆ°çš„å°¾éƒ¨ç´¢å¼•ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªé¢å¤–çš„åŸå­è®¡æ•°å™¨ï¼š <strong>å‡ºé˜Ÿè®¡æ•° (dequeue count)</strong><br>ã€‚å‡ºé˜Ÿè®¡æ•°æ˜¯ä¹è§‚çš„ï¼Œå³å½“æ¶ˆè´¹è€…æ¨æµ‹æœ‰å…ƒç´ éœ€è¦å‡ºé˜Ÿæ—¶ï¼Œå®ƒä¼šé€’å¢ã€‚å¦‚æœå‡ºé˜Ÿè®¡æ•°åœ¨é€’å¢åçš„å€¼å°äºå…¥é˜Ÿè®¡æ•°ï¼ˆ<br>å°¾éƒ¨ï¼‰ï¼Œåˆ™ä¿è¯è‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ è¦å‡ºé˜Ÿï¼ˆå³ä½¿è€ƒè™‘åˆ°å¹¶å‘æ€§ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥å®‰å…¨åœ°é€’å¢å¤´éƒ¨ç´¢å¼•ï¼Œå› ä¸ºçŸ¥é“ä¹‹åå®ƒä¼š<br>å°äºå°¾éƒ¨ç´¢å¼•ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœå‡ºé˜Ÿè®¡æ•°åœ¨é€’å¢åè¶…è¿‡ï¼ˆæˆ–ç­‰äºï¼‰å°¾éƒ¨ï¼Œåˆ™å‡ºé˜Ÿæ“ä½œå¤±è´¥ï¼Œå¹¶ä¸”å‡ºé˜Ÿè®¡æ•°åœ¨é€»è¾‘ä¸Š<br>ä¼šé€’å‡ï¼ˆä»¥ä½¿å…¶æœ€ç»ˆä¸å…¥é˜Ÿè®¡æ•°ä¿æŒä¸€è‡´ï¼‰ï¼šè¿™å¯ä»¥é€šè¿‡ç›´æ¥é€’å‡å‡ºé˜Ÿè®¡æ•°æ¥å®ç°ï¼Œä½†æ˜¯ï¼ˆä¸ºäº†å¢åŠ å¹¶è¡Œæ€§å¹¶ä½¿æ‰€<br>æœ‰ç›¸å…³å˜é‡å•è°ƒé€’å¢ï¼‰ï¼Œæ”¹ä¸ºé€’å¢**å‡ºé˜Ÿè¿‡é‡æäº¤è®¡æ•°å™¨ (dequeue overcommit counter)**ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å‡ºé˜Ÿè®¡æ•°çš„é€»è¾‘å€¼ = å‡ºé˜Ÿè®¡æ•°å˜é‡ - å‡ºé˜Ÿè¿‡é‡æäº¤å€¼</span><br></pre></td></tr></table></figure>

<p>åœ¨æ¶ˆè´¹æ—¶ï¼Œä¸€æ—¦å¦‚ä¸Šæ‰€è¿°ç¡®å®šäº†æœ‰æ•ˆç´¢å¼•ï¼Œä»ç„¶éœ€è¦å°†å…¶æ˜ å°„åˆ°ä¸€ä¸ªå—ä»¥åŠè¯¥å—ä¸­çš„åç§»é‡ï¼›ä¸ºæ­¤ä¼šä½¿ç”¨æŸç§ç´¢å¼•<br>æ•°æ®ç»“æ„ï¼ˆå…·ä½“ä½¿ç”¨å“ªç§ç»“æ„å–å†³äºå®ƒæ˜¯éšå¼é˜Ÿåˆ—è¿˜æ˜¯æ˜¾å¼é˜Ÿåˆ—ï¼‰ã€‚æœ€åï¼Œå¯ä»¥å°†å…ƒç´ ç§»å‡ºï¼Œå¹¶æ›´æ–°æŸç§çŠ¶æ€ï¼Œä»¥<br>ä¾¿æœ€ç»ˆçŸ¥é“è¯¥å—ä½•æ—¶å®Œå…¨æ¶ˆè´¹ã€‚ä¸‹æ–‡å°†åˆ†åˆ«åœ¨éšå¼å’Œæ˜¾å¼é˜Ÿåˆ—çš„å„ä¸ªéƒ¨åˆ†ä¸­å¯¹è¿™äº›æœºåˆ¶è¿›è¡Œå®Œæ•´æè¿°ã€‚</p>
<p>å¦‚å‰æ‰€è¿°ï¼Œå°¾éƒ¨å’Œå¤´éƒ¨çš„ç´¢å¼•&#x2F;è®¡æ•°æœ€ç»ˆä¼šæº¢å‡ºã€‚è¿™æ˜¯é¢„æ–™ä¹‹ä¸­çš„ï¼Œå¹¶ä¸”å·²è¢«è€ƒè™‘åœ¨å†…ã€‚å› æ­¤ï¼Œç´¢å¼•&#x2F;è®¡æ•°è¢«è§†ä¸ºå­˜<br>åœ¨äºä¸€ä¸ªä¸æœ€å¤§æ•´æ•°å€¼å¤§å°ç›¸åŒçš„åœ†ä¸Šï¼ˆç±»ä¼¼äº 360 åº¦çš„åœ†ï¼Œå…¶ä¸­ 359 åœ¨ 1 ä¹‹å‰ï¼‰ã€‚ä¸ºäº†æ£€æŸ¥ä¸€ä¸ªç´¢å¼•&#x2F;è®¡æ•°ï¼ˆ<br>ä¾‹å¦‚ aï¼‰æ˜¯å¦ä½äºå¦ä¸€ä¸ªç´¢å¼•&#x2F;è®¡æ•°ï¼ˆä¾‹å¦‚ bï¼‰ä¹‹å‰ï¼ˆå³é€»è¾‘å°äºï¼‰ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®å®š a æ˜¯å¦æ²¿ç€åœ†ä¸Šçš„é¡ºæ—¶é’ˆåœ†å¼§<br>æ›´æ¥è¿‘ bã€‚ä½¿ç”¨ä»¥ä¸‹â€ç¯å½¢å°äºâ€ç®—æ³•ï¼ˆ32 ä½ç‰ˆæœ¬ï¼‰ï¼š<code>a &lt; b</code> å˜ä¸º <code>a - b &gt; (1U &lt;&lt; 31U)</code>ã€‚<code>a &lt;= b</code> å˜ä¸º<br><code>a - b - 1ULL &gt; (1ULL &lt;&lt; 31ULL)</code>ã€‚è¯·æ³¨æ„ï¼Œç¯å½¢å‡æ³•â€œä»…é€‚ç”¨äºâ€æ™®é€šæ— ç¬¦å·æ•´æ•°ï¼ˆå‡è®¾ä¸ºäºŒè¿›åˆ¶è¡¥ç ï¼‰ã€‚éœ€è¦<br>æ³¨æ„çš„æ˜¯ï¼Œå°¾éƒ¨ç´¢å¼•çš„å¢é‡ä¸ä¼šè¶…è¿‡å¤´éƒ¨ç´¢å¼•ï¼ˆè¿™ä¼šç ´åé˜Ÿåˆ—ï¼‰ã€‚è¯·æ³¨æ„ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œä»æŠ€æœ¯ä¸Šè®²ä»ç„¶å­˜åœ¨ç«äº‰æ¡<br>ä»¶ï¼Œå³æ¶ˆè´¹è€…ï¼ˆæˆ–ç”Ÿäº§è€…ï¼‰çœ‹åˆ°çš„ç´¢å¼•å€¼è¿‡äºé™ˆæ—§ï¼Œå‡ ä¹æ¯”å½“å‰å€¼è½åä¸€æ•´åœˆï¼ˆç”šè‡³æ›´å¤šï¼ï¼‰ï¼Œä»è€Œå¯¼è‡´é˜Ÿåˆ—çš„å†…<br>éƒ¨çŠ¶æ€æŸåã€‚ä½†åœ¨å®è·µä¸­ï¼Œè¿™ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºéå† 2^31 ä¸ªå€¼ï¼ˆå¯¹äº 32 ä½ç´¢å¼•ç±»å‹ï¼‰éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œè€Œå…¶ä»–æ ¸å¿ƒ<br>åˆ°é‚£æ—¶ä¼šçœ‹åˆ°æ›´æ–°çš„å€¼ã€‚å®é™…ä¸Šï¼Œè®¸å¤šæ— é”ç®—æ³•éƒ½åŸºäºç›¸å…³çš„æ ‡ç­¾æŒ‡é’ˆä¹ è¯­ï¼ˆtag-pointer idiomï¼‰ï¼Œå…¶ä¸­å‰ 16<br>ä½ç”¨äºé‡å¤é€’å¢çš„æ ‡ç­¾ï¼Œå 16 ä½ç”¨äºæŒ‡é’ˆå€¼ï¼›è¿™ä¾èµ–äºç±»ä¼¼çš„å‡è®¾ï¼Œå³ä¸€ä¸ªæ ¸å¿ƒä¸èƒ½å°†æ ‡ç­¾é€’å¢è¶…è¿‡ 2^15 æ¬¡ï¼Œ<br>è€Œå…¶ä»–æ ¸å¿ƒå´ä¸çŸ¥é“ã€‚å°½ç®¡å¦‚æ­¤ï¼Œé˜Ÿåˆ—çš„é»˜è®¤ç´¢å¼•ç±»å‹æ˜¯ 64 ä½å®½ï¼ˆå¦‚æœ 16 ä½çœ‹èµ·æ¥å°±è¶³å¤Ÿäº†ï¼Œé‚£ä¹ˆç†è®ºä¸Šåº”è¯¥<br>å¯ä»¥é¿å…ä»»ä½•æ½œåœ¨çš„ç«äº‰ï¼‰ã€‚</p>
<p>å†…å­˜åˆ†é…å¤±è´¥ä¹Ÿä¼šå¾—åˆ°å¦¥å–„å¤„ç†ï¼Œä¸ä¼šæŸåé˜Ÿåˆ—ï¼ˆåªä¼šæŠ¥å‘Šå¤±è´¥ï¼‰ã€‚æ­¤å¤–ï¼Œé˜Ÿåˆ—å…ƒç´ æœ¬èº«åœ¨æ“ä½œæ—¶ä¹Ÿåº”ç¡®ä¿ä¸ä¼šæŠ›<br>å‡ºå¼‚å¸¸ã€‚</p>
<h3 id="Block-Pools"><a href="#Block-Pools" class="headerlink" title="Block Pools"></a>Block Pools</h3><p>æœ‰ä¸¤ç§ä¸åŒçš„å—æ± å¯ä¾›ä½¿ç”¨ï¼šé¦–å…ˆï¼Œæœ‰ä¸€ä¸ªåˆå§‹çš„é¢„åˆ†é…å—æ•°ç»„ã€‚ä¸€æ—¦ä½¿ç”¨å®Œæ¯•ï¼Œè¯¥æ± å°†æ°¸è¿œä¿æŒä¸ºç©ºã€‚è¿™ç®€åŒ–äº†<br>å…¶æ— ç­‰å¾…ï¼ˆwait-freeï¼‰å®ç°ï¼Œåªéœ€ä¸€æ¡ fetch-and-add åŸå­æŒ‡ä»¤ï¼ˆç”¨äºè·å–ç©ºé—²å—çš„ä¸‹ä¸€ä¸ªç´¢å¼•ï¼‰å¹¶è¿›è¡Œæ£€æŸ¥ï¼ˆ<br>ä»¥ç¡®ä¿è¯¥ç´¢å¼•åœ¨èŒƒå›´å†…ï¼‰ã€‚å…¶æ¬¡ï¼Œæœ‰ä¸€ä¸ªæ— é”ï¼ˆä½†éæ— ç­‰å¾…ï¼‰çš„å…¨å±€ç©ºé—²åˆ—è¡¨ï¼ˆâ€œå…¨å±€â€æ˜¯æŒ‡å¯¹é«˜çº§é˜Ÿåˆ—è€Œè¨€æ˜¯å…¨å±€<br>çš„ï¼‰ï¼Œå…¶ä¸­åŒ…å«å·²ç”¨å®Œä¸”å¯é‡å¤ä½¿ç”¨çš„å—ï¼Œè¯¥åˆ—è¡¨å®ç°ä¸ºä¸€ä¸ªæ— é”å•é“¾è¡¨ï¼šå¤´æŒ‡é’ˆæœ€åˆæŒ‡å‘ç©ºï¼ˆnullï¼‰ã€‚è¦å°†å—æ·»<br>åŠ åˆ°ç©ºé—²åˆ—è¡¨ï¼Œéœ€è¦å°†å—çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆè®¾ç½®ä¸ºå¤´æŒ‡é’ˆï¼Œç„¶åä½¿ç”¨æ¯”è¾ƒå¹¶äº¤æ¢ (CAS) æ›´æ–°å¤´æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘è¯¥å—ï¼Œ<br>å‰ææ˜¯å¤´æŒ‡é’ˆæœªå‘ç”Ÿæ›´æ”¹ï¼›å¦‚æœå‘ç”Ÿæ›´æ”¹ï¼Œåˆ™é‡å¤è¯¥è¿‡ç¨‹ï¼ˆè¿™æ˜¯ä¸€ä¸ªç»å…¸çš„æ— é” CAS å¾ªç¯è®¾è®¡æ¨¡å¼ï¼‰ã€‚è¦ä»ç©ºé—²<br>åˆ—è¡¨ä¸­ç§»é™¤ä¸€ä¸ªå—ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„ç®—æ³•ï¼šè¯»å–å¤´éƒ¨å—çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼Œç„¶åå°†å¤´éƒ¨è®¾ç½®ä¸ºè¯¥ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼ˆä½¿ç”¨<br>CASï¼‰ï¼Œå‰ææ˜¯åœ¨æ­¤æœŸé—´å¤´éƒ¨å—æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚ä¸ºäº†é¿å… ABA é—®é¢˜ï¼Œæ¯ä¸ªå—éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œåœ¨æ‰§è¡Œ CAS ç§»é™¤<br>å—ä¹‹å‰ä¼šé€’å¢ï¼Œä¹‹åä¼šé€’å‡ï¼›å¦‚æœåœ¨å—çš„å¼•ç”¨è®¡æ•°å¤§äº 0 çš„æƒ…å†µä¸‹å°è¯•å°†å…¶é‡æ–°æ·»åŠ åˆ°ç©ºé—²åˆ—è¡¨ä¸­ï¼Œåˆ™ä¼šè®¾ç½®ä¸€<br>ä¸ªæ ‡å¿—ï¼ŒæŒ‡ç¤ºè¯¥å—åº”è¯¥åœ¨ç©ºé—²åˆ—è¡¨ä¸­ï¼Œå¹¶ä¸”ä¸‹ä¸€ä¸ªçº¿ç¨‹åœ¨å®Œæˆæœ€åä¸€ä¸ªå¼•ç”¨çš„æŒæœ‰åä¼šæ£€æŸ¥æ­¤æ ‡å¿—ï¼Œå¹¶å°†è¯¥å—æ·»åŠ <br>åˆ°åˆ—è¡¨ä¸­ï¼ˆè¿™ç§æ–¹æ³•æœ‰æ•ˆï¼Œå› ä¸ºæˆ‘ä»¬ä¸å…³å¿ƒé¡ºåºï¼‰ã€‚æˆ‘<br>åœ¨<a target="_blank" rel="noopener" href="http://moodycamel.com/blog/2014/solving-the-aba-problem-for-lock-free-free-lists">å¦ä¸€ç¯‡åšæ–‡</a>ä¸­æ›´<br>è¯¦ç»†åœ°æè¿°äº†è¿™ä¸ªæ— é”ç©ºé—²åˆ—è¡¨çš„å…·ä½“è®¾è®¡å’Œå®ç°ã€‚å½“ç”Ÿäº§è€…é˜Ÿåˆ—éœ€è¦æ–°å—æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥åˆå§‹å—æ± ï¼Œç„¶åæ£€æŸ¥å…¨<br>å±€ç©ºé—²åˆ—è¡¨ï¼Œåªæœ‰å½“å®ƒåœ¨é‚£é‡Œæ‰¾ä¸åˆ°ç©ºé—²å—æ—¶ï¼Œå®ƒæ‰ä¼šåœ¨å †ä¸Šåˆ†é…ä¸€ä¸ªæ–°å—ï¼ˆå¦‚æœä¸å…è®¸å†…å­˜åˆ†é…ï¼Œåˆ™å¤±è´¥ï¼‰ã€‚</p>
<h2 id="åŸºå‡†æµ‹è¯•"><a href="#åŸºå‡†æµ‹è¯•" class="headerlink" title="åŸºå‡†æµ‹è¯•"></a>åŸºå‡†æµ‹è¯•</h2><h3 id="Ticket-System"><a href="#Ticket-System" class="headerlink" title="Ticket System"></a>Ticket System</h3><p>BlockQueueï¼ˆåªç”¨åˆ†å—ï¼‰ï¼šä½¿ç”¨åˆ†å—å†…å­˜å¸ƒå±€ï¼Œä½†ä¸ä½¿ç”¨ ticket åˆ†å‘æœºåˆ¶ã€‚</p>
<figure class="highlight cpp"><figcaption><span>TicketQueue_benchmark.cpp</span><a href="/blog/downloads/code/camel_mpmc/TicketQueue/TicketQueue_benchmark.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span> BLOCK_SIZE = <span class="number">64</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> N = <span class="number">1&#x27;000&#x27;000</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> NUM_PRODUCERS = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> NUM_CONSUMERS = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> ITEMS_PER_PRODUCER = N / NUM_PRODUCERS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Slot</span> {</span><br><span class="line">    std::atomic&lt;<span class="type">bool</span>&gt; ready;</span><br><span class="line">    <span class="type">int</span> data;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Block</span> {</span><br><span class="line">    Slot slots[BLOCK_SIZE];</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// BlockQueue: åˆ†å—ä½†æ—  ticket</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlockQueue</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BlockQueue</span>() : <span class="built_in">head</span>(<span class="number">0</span>), <span class="built_in">tail</span>(<span class="number">0</span>) {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">enqueue</span><span class="params">(<span class="type">int</span> value)</span> </span>{</span><br><span class="line">        <span class="type">size_t</span> index = head.<span class="built_in">fetch_add</span>(<span class="number">1</span>) % BLOCK_SIZE;</span><br><span class="line">        block.slots[index].data = value;</span><br><span class="line">        block.slots[index].ready.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_release);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">try_dequeue</span><span class="params">(<span class="type">int</span>&amp; value)</span> </span>{</span><br><span class="line">        <span class="type">size_t</span> index = tail.<span class="built_in">fetch_add</span>(<span class="number">1</span>) % BLOCK_SIZE;</span><br><span class="line">        <span class="keyword">if</span> (!block.slots[index].ready.<span class="built_in">load</span>(std::memory_order_acquire))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        value = block.slots[index].data;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::atomic&lt;<span class="type">size_t</span>&gt; head;</span><br><span class="line">    std::atomic&lt;<span class="type">size_t</span>&gt; tail;</span><br><span class="line">    Block block;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>TicketQueueï¼ˆåˆ†å— + ticketï¼‰ï¼šæ¨¡æ‹Ÿ moodycamel çš„ ticket åˆ†å‘æ–¹å¼ã€‚</p>
<figure class="highlight cpp"><figcaption><span>TicketQueue_benchmark.cpp</span><a href="/blog/downloads/code/camel_mpmc/TicketQueue/TicketQueue_benchmark.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TicketQueue: åˆ†å— + ticket</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TicketQueue</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TicketQueue</span>() : <span class="built_in">head</span>(<span class="number">0</span>), <span class="built_in">tail</span>(<span class="number">0</span>) {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">enqueue</span><span class="params">(<span class="type">int</span> value)</span> </span>{</span><br><span class="line">        <span class="type">size_t</span> ticket = head.<span class="built_in">fetch_add</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">size_t</span> index = ticket % BLOCK_SIZE;</span><br><span class="line">        block.slots[index].data = value;</span><br><span class="line">        block.slots[index].ready.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_release);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">try_dequeue</span><span class="params">(<span class="type">int</span>&amp; value)</span> </span>{</span><br><span class="line">        <span class="type">size_t</span> ticket = tail.<span class="built_in">fetch_add</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">size_t</span> index = ticket % BLOCK_SIZE;</span><br><span class="line">        <span class="keyword">while</span> (!block.slots[index].ready.<span class="built_in">load</span>(std::memory_order_acquire)) {</span><br><span class="line">            <span class="comment">// è‡ªæ—‹ç­‰å¾…</span></span><br><span class="line">        }</span><br><span class="line">        value = block.slots[index].data;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::atomic&lt;<span class="type">size_t</span>&gt; head;</span><br><span class="line">    std::atomic&lt;<span class="type">size_t</span>&gt; tail;</span><br><span class="line">    Block block;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>Benchmark ä»£ç ï¼š</p>
<figure class="highlight cpp"><figcaption><span>TicketQueue_benchmark.cpp</span><a href="/blog/downloads/code/camel_mpmc/TicketQueue/TicketQueue_benchmark.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºå‡†æµ‹è¯•å‡½æ•°</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> QueueType&gt;</span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">benchmark</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">double</span>&amp; opsPerSec)</span> </span>{</span><br><span class="line">    QueueType queue;</span><br><span class="line">    std::atomic&lt;<span class="type">int</span>&gt; totalConsumed{<span class="number">0</span>};</span><br><span class="line">    std::map&lt;<span class="type">int</span>, <span class="type">double</span>&gt; threadWaitTimes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> start = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹</span></span><br><span class="line">    std::vector&lt;std::thread&gt; producers;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> p = <span class="number">0</span>; p &lt; NUM_PRODUCERS; ++p) {</span><br><span class="line">        producers.<span class="built_in">emplace_back</span>([&amp;queue, p]() {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ITEMS_PER_PRODUCER; ++i) {</span><br><span class="line">                queue.<span class="built_in">enqueue</span>(i + p * ITEMS_PER_PRODUCER);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨æ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line">    std::vector&lt;std::thread&gt; consumers;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> c = <span class="number">0</span>; c &lt; NUM_CONSUMERS; ++c) {</span><br><span class="line">        consumers.<span class="built_in">emplace_back</span>([&amp;queue, &amp;totalConsumed, c, &amp;threadWaitTimes]() {</span><br><span class="line">            <span class="type">int</span> item;</span><br><span class="line">            <span class="keyword">auto</span> localStart = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                <span class="keyword">auto</span> t0 = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">                <span class="keyword">while</span> (!queue.<span class="built_in">try_dequeue</span>(item)) {</span><br><span class="line">                    <span class="comment">// busy wait</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">auto</span> t1 = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">                threadWaitTimes[c] +=</span><br><span class="line">                    std::chrono::<span class="built_in">duration</span>&lt;<span class="type">double</span>&gt;(t1 - t0).<span class="built_in">count</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (++totalConsumed &gt;= N)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">auto</span> localEnd = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">            <span class="type">double</span> threadTime =</span><br><span class="line">                std::chrono::<span class="built_in">duration</span>&lt;<span class="type">double</span>&gt;(localEnd - localStart).<span class="built_in">count</span>();</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Consumer &quot;</span> &lt;&lt; c &lt;&lt; <span class="string">&quot; finished in &quot;</span> &lt;&lt; threadTime</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;s, wait time: &quot;</span> &lt;&lt; threadWaitTimes[c] &lt;&lt; <span class="string">&quot;s\n&quot;</span>;</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : producers)</span><br><span class="line">        t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : consumers)</span><br><span class="line">        t.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> end = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    std::chrono::duration&lt;<span class="type">double</span>&gt; elapsed = end - start;</span><br><span class="line">    opsPerSec = N / elapsed.<span class="built_in">count</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\n&quot;</span></span><br><span class="line">              &lt;&lt; name &lt;&lt; <span class="string">&quot; completed in &quot;</span> &lt;&lt; elapsed.<span class="built_in">count</span>()</span><br><span class="line">              &lt;&lt; <span class="string">&quot;s, throughput: &quot;</span> &lt;&lt; opsPerSec &lt;&lt; <span class="string">&quot; ops/sec\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> elapsed.<span class="built_in">count</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="type">double</span> opsBlock = <span class="number">0.0</span>, opsTicket = <span class="number">0.0</span>;</span><br><span class="line">    <span class="type">double</span> timeBlock = <span class="built_in">benchmark</span>&lt;BlockQueue&gt;(<span class="string">&quot;BlockQueue&quot;</span>, opsBlock);</span><br><span class="line">    <span class="type">double</span> timeTicket = <span class="built_in">benchmark</span>&lt;TicketQueue&gt;(<span class="string">&quot;TicketQueue&quot;</span>, opsTicket);</span><br><span class="line">    <span class="type">double</span> speedup = opsTicket / opsBlock;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; std::left &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">14</span>) &lt;&lt; <span class="string">&quot;Queue Type&quot;</span></span><br><span class="line">              &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">12</span>) &lt;&lt; <span class="string">&quot;Time (s)&quot;</span></span><br><span class="line">              &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">20</span>) &lt;&lt; <span class="string">&quot;Throughput (ops/s)&quot;</span></span><br><span class="line">              &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">10</span>) &lt;&lt; <span class="string">&quot;Speedup&quot;</span></span><br><span class="line">              &lt;&lt; <span class="string">&quot;|\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; std::<span class="built_in">string</span>(<span class="number">70</span>, <span class="string">&#x27;-&#x27;</span>) &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BlockQueue row</span></span><br><span class="line">    std::cout &lt;&lt; std::left &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">14</span>) &lt;&lt; <span class="string">&quot;BlockQueue&quot;</span></span><br><span class="line">              &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">12</span>) &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">6</span>)</span><br><span class="line">              &lt;&lt; timeBlock &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">20</span>) &lt;&lt; std::fixed</span><br><span class="line">              &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">0</span>) &lt;&lt; opsBlock &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">10</span>)</span><br><span class="line">              &lt;&lt; <span class="string">&quot;1.00Ã—&quot;</span></span><br><span class="line">              &lt;&lt; <span class="string">&quot;|\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TicketQueue row</span></span><br><span class="line">    std::ostringstream speedupStream;</span><br><span class="line">    speedupStream &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; speedup &lt;&lt; <span class="string">&quot;Ã—&quot;</span>;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; std::left &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">14</span>) &lt;&lt; <span class="string">&quot;TicketQueue&quot;</span></span><br><span class="line">              &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">12</span>) &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">6</span>)</span><br><span class="line">              &lt;&lt; timeTicket &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">20</span>) &lt;&lt; std::fixed</span><br><span class="line">              &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">0</span>) &lt;&lt; opsTicket &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">10</span>)</span><br><span class="line">              &lt;&lt; speedupStream.<span class="built_in">str</span>() &lt;&lt; <span class="string">&quot;|\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/13/concurrency/SPSC-lock-free-queue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/13/concurrency/SPSC-lock-free-queue/" class="post-title-link" itemprop="url">å•ç”Ÿäº§è€… - å•æ¶ˆè´¹è€… æ— é”é˜Ÿåˆ—</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-13 17:09:37" itemprop="dateCreated datePublished" datetime="2025-09-13T17:09:37+00:00">2025-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/concurrency/" itemprop="url" rel="index"><span itemprop="name">concurrency</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ˜¯é˜…è¯» Cameron Desrochers çš„ <a target="_blank" rel="noopener" href="https://moodycamel.com/blog/2013/a-fast-lock-free-queue-for-c++">A Fast Lock-Free Queue for C++</a> æºç çš„ç¬”è®°ã€‚</p>
<p>ä»“åº“åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/cameron314/readerwriterqueue">https://github.com/cameron314/readerwriterqueue</a></p>
<p>å…¶ä»–å‚è€ƒæ–‡çŒ®ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://preshing.com/20120612/an-introduction-to-lock-free-programming/">An Introduction to Lock-Free Programming</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=A8eCGOqgvH4&list=PLjwoip0ltHwHCe0Nw7PDPtzlJP7rUouRL">C++ and Beyond 2012: Herb Sutter - atomic Weapons 1 of 2</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=KeLBd2EJLOU">C++ and Beyond 2012: Herb Sutter - atomic Weapons 2 of 2</a></p>
<h2 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h2><p>çº¦æŸ memory loads&#x2F;stores çš„é¡ºåºã€‚</p>
<ul>
<li>releaase å†…å­˜å±éšœï¼šå‘Šè¯‰ CPUï¼Œå¦‚æœå±éšœä¹‹åçš„ä»»ä½•å†™å…¥å˜å¾—å¯è§ï¼Œé‚£ä¹ˆå±éšœä¹‹å‰çš„ä»»ä½•å†™å…¥éƒ½åº”è¯¥åœ¨å…¶ä»–æ ¸å¿ƒä¸­å¯è§ï¼Œå‰ææ˜¯å…¶ä»–æ ¸å¿ƒåœ¨è¯»å– å†™å±éšœä¹‹åå†™å…¥çš„æ•°æ® åæ‰§è¡Œè¯»å±éšœã€‚<br>æ¢å¥è¯è¯´ï¼Œå¦‚æœçº¿ç¨‹ B å¯ä»¥çœ‹åˆ°åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ A ä¸Šçš„å†™å±éšœä¹‹åå†™å…¥çš„æ–°å€¼ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè¯»å±éšœï¼ˆåœ¨çº¿ç¨‹ B ä¸Šï¼‰ä¹‹åï¼Œå¯ä»¥ä¿è¯åœ¨çº¿ç¨‹ A ä¸Šçš„å†™å±éšœä¹‹å‰å‘ç”Ÿçš„æ‰€æœ‰å†™å…¥åœ¨çº¿ç¨‹ B ä¸Šå¯è§ã€‚</li>
</ul>
<h2 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2><ol>
<li>block: ä¸€ä¸ªè¿ç»­çš„ç¯å½¢ç¼“å†²åŒºï¼Œç”¨æ¥å­˜å‚¨å…ƒç´ ã€‚è¿™æ ·å¯ä»¥é¢„åˆ†é…å†…å­˜ã€‚</li>
<li>å—è¿‡å°ï¼ˆè¿™ä¸åˆ©äºæ— é”ï¼‰æ—¶ï¼Œæ— éœ€å°†æ‰€æœ‰ç°æœ‰å…ƒç´ å¤åˆ¶åˆ°æ–°çš„å—ä¸­ï¼›å¤šä¸ªå—ï¼ˆå¤§å°ç‹¬ç«‹ï¼‰ä»¥å¾ªç¯é“¾è¡¨çš„å½¢å¼é“¾æ¥åœ¨ä¸€èµ·ã€‚</li>
<li>å½“å‰æ’å…¥çš„å—ç§°ä¸º â€œå°¾å—â€ï¼Œå½“å‰æ¶ˆè´¹çš„å—ç§°ä¸º â€œå¤´å—â€ã€‚</li>
<li>å¤´ç´¢å¼•æŒ‡å‘ä¸‹ä¸€ä¸ªè¦è¯»å–çš„æ»¡æ§½ï¼›å°¾ç´¢å¼•æŒ‡å‘ä¸‹ä¸€ä¸ªè¦æ’å…¥çš„ç©ºæ§½ã€‚å¦‚æœä¸¤ä¸ªç´¢å¼•ç›¸ç­‰ï¼Œåˆ™å—ä¸ºç©ºï¼ˆç¡®åˆ‡åœ°è¯´ï¼Œå½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œæ°å¥½æœ‰ä¸€ä¸ªæ’æ§½ä¸ºç©ºï¼Œä»¥é¿å…åœ¨å…·æœ‰ç›¸åŒå¤´å’Œå°¾ç´¢å¼•çš„æ»¡å—å’Œç©ºå—ä¹‹é—´äº§ç”Ÿæ­§ä¹‰ï¼‰ã€‚</li>
<li>ä¸ºäº†å…è®¸é˜Ÿåˆ—å¯¹ä»»æ„çº¿ç¨‹åˆ›å»º &#x2F; ææ„ï¼ˆç‹¬ç«‹äºç”Ÿäº§ &#x2F; æ¶ˆè´¹çº¿ç¨‹ï¼‰ï¼Œå…¨å†…å­˜å±éšœï¼ˆmemory_order_acq_cstï¼‰è¢«ç”¨åœ¨ææ„å‡½æ•°åœ°æœ€åã€ææ„å‡½æ•°çš„å¼€å¤´ï¼ˆè¿™ä¼šå¼ºåˆ¶æ‰€æœ‰çš„ CPU cores åŒæ­¥ outstanding changesï¼‰ã€‚æ˜¾ç„¶ï¼Œåœ¨ææ„å‡½æ•°å¯ä»¥è¢«å®‰å…¨åœ°è°ƒç”¨ä¹‹å‰ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¿…é¡»å·²ç»åœæ­¢ä½¿ç”¨è¯¥é˜Ÿåˆ—ã€‚</li>
</ol>
<h2 id="Give-me-the-codes"><a href="#Give-me-the-codes" class="headerlink" title="Give me the codes"></a>Give me the codes</h2><ol>
<li>ç”¨æˆ·ä¸éœ€è¦ç®¡ç†å†…å­˜ã€‚</li>
<li>é¢„åˆ†é…å†…å­˜ï¼Œåœ¨è¿ç»­çš„å—ä¸­ã€‚</li>
<li><code>try_enqueue</code>: ä¿è¯ä¸ä¼šåˆ†é…å†…å­˜ï¼ˆé˜Ÿåˆ—æœ‰åˆå§‹å®¹é‡ï¼‰ï¼›</li>
<li><code>enqueue</code>: ä¼šæ ¹æ®éœ€è¦åŠ¨æ€æ‰©å®¹ã€‚</li>
<li>æ²¡æœ‰ä½¿ç”¨ CAS loopï¼›è¿™æ„å‘³è€… enqueue å’Œ dequeue æ˜¯ O(1) çš„ï¼ˆæ²¡æœ‰è®¡å…¥å†…å­˜åˆ†é…çš„æ—¶é—´ï¼‰ã€‚</li>
<li>å› ä¸ºåœ¨ x86 å¹³å°ï¼Œå†…å­˜å±éšœæ˜¯ç©ºæ“ä½œï¼Œæ‰€ä»¥ enqueue å’Œ dequeue æ˜¯ä¸€ç³»åˆ—ç®€å•çš„ loads å’Œ stores (and branches) ã€‚</li>
</ol>
<p>æ­¤ä»£ç ä»…ä»…é€‚ç”¨äºä»¥åŸå­æ–¹å¼å¤„ç† è‡ªç„¶å¯¹é½çš„æ•´å‹ï¼ˆaligned integerï¼‰ å’Œ åŸç”ŸæŒ‡é’ˆå¤§å°ï¼ˆnative-pointer-sizeï¼‰ çš„ loads&#x2F;stores çš„ CPU ä¸Šï¼›<br>å¹¸è¿çš„æ˜¯ï¼Œè¿™åŒ…æ‹¬äº†æ‰€æœ‰çš„ç°ä»£å¤„ç†å™¨ï¼ˆåŒ…æ‹¬ ARM, x86&#x2F;x86_64 å’Œ PowerPCï¼‰ã€‚<br>å®ƒä¸æ˜¯ä¸ºåœ¨ DEC Alpha ä¸Šè¿è¡Œè€Œè®¾è®¡çš„ï¼ˆDEC Alpha ä¼¼ä¹å…·æœ‰æœ‰å²ä»¥æ¥æœ€å¼±çš„å†…å­˜æ’åºä¿è¯ï¼‰ã€‚</p>
<p>æ³¨ï¼šåœ¨ x86 ä¸Šï¼Œmemory_order_acquire&#x2F;release é€šå¸¸ä¸éœ€è¦é¢å¤–æŒ‡ä»¤å°±èƒ½å®ç°è¯­ä¹‰ï¼Œä½†ä»ç„¶èƒ½é™åˆ¶ç¼–è¯‘å™¨çš„é‡æ’ã€‚<br>fetch_add ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œè€Œæ˜¯ä¸‰ä¸ªï¼šload, add, store. æ‰€ä»¥ä¸é€‚ç”¨ä¸Šè¿°è¯´çš„ â€œè‡ªç„¶å¯¹é½çš„æ•´å‹â€ æˆ–â€œåŸç”ŸæŒ‡é’ˆå¤§å°â€çš„ load&#x2F;store.</p>
<h2 id="æ€§èƒ½ä¼˜åŒ–ç‚¹"><a href="#æ€§èƒ½ä¼˜åŒ–ç‚¹" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–ç‚¹"></a>æ€§èƒ½ä¼˜åŒ–ç‚¹</h2><ol>
<li>å¹³å‡¡ææ„ï¼šè·³è¿‡ææ„ï¼Œç›´æ¥é‡Šæ”¾å†…å­˜ã€‚</li>
<li><a target="_blank" rel="noopener" href="http://www.cse.cuhk.edu.hk/~pclee/www/pubs/ancs09poster.pdf">MCRingBuffer paper</a><ol>
<li>cache line padding</li>
<li>local control variables<ol>
<li>å‡å°‘å¯¹å…¨å±€ read&#x2F;write æŒ‡é’ˆçš„è¯»å–</li>
</ol>
</li>
<li>local block</li>
</ol>
</li>
</ol>
<h2 id="æ­£ç¡®æ€§æµ‹è¯•"><a href="#æ­£ç¡®æ€§æµ‹è¯•" class="headerlink" title="æ­£ç¡®æ€§æµ‹è¯•"></a>æ­£ç¡®æ€§æµ‹è¯•</h2><ol>
<li>å®šä¹‰ä¸å¯é¢„æµ‹æ€§å»¶æ—¶å‡½æ•°ï¼Œç”¨äºæ¨¡æ‹Ÿçº¿ç¨‹è°ƒåº¦ã€‚</li>
<li>å†™çº¿ç¨‹å¡å…¥ 32 M ä¸ªæ•°æ®ï¼›è¯»çº¿ç¨‹è¯»å– 32 M æ¬¡ã€‚è¯»å†™çº¿ç¨‹ä¸­ä½¿ç”¨ unpredDelay() æ¨¡æ‹Ÿè°ƒåº¦å»¶è¿Ÿã€‚</li>
<li>æµ‹è¯•èƒ½å¦é¡ºåºè¯»å–ï¼Œå¤±è´¥åˆ™æ‰“å°æ—¥å¿—ï¼Œä¸é€€å‡ºã€‚</li>
<li>æµ‹è¯•ç¨‹åºæ— é™è¿è¡Œï¼Œæ¯æ¬¡ä½¿ç”¨ä¸€ä¸ªå†™çº¿ç¨‹å’Œè¯»çº¿ç¨‹ã€‚ç›´è‡³æ‰‹åŠ¨ Ctrl C å…³é—­ã€‚</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/08/%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/08/%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD/" class="post-title-link" itemprop="url">æµ‹è¯•ç£ç›˜æ€§èƒ½</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-08 11:27:57" itemprop="dateCreated datePublished" datetime="2025-09-08T11:27:57+00:00">2025-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æŸ¥çœ‹ç£ç›˜ç±»å‹"><a href="#æŸ¥çœ‹ç£ç›˜ç±»å‹" class="headerlink" title="æŸ¥çœ‹ç£ç›˜ç±»å‹"></a>æŸ¥çœ‹ç£ç›˜ç±»å‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lsblk -d -o name,rota,<span class="built_in">type</span>,size,model</span><br><span class="line">NAME ROTA TYPE  SIZE MODEL</span><br><span class="line">sda     1 disk  1.8T PERC H740P Mini</span><br></pre></td></tr></table></figure>

<p><code>ROTA=1</code>ï¼šè¿™æ˜¯æ—‹è½¬ç£ç›˜ã€‚</p>
<h2 id="æµ‹è¯•æ–¹æ³•"><a href="#æµ‹è¯•æ–¹æ³•" class="headerlink" title="æµ‹è¯•æ–¹æ³•"></a>æµ‹è¯•æ–¹æ³•</h2><p>é¡ºåºå†™ååæµ‹è¯•ï¼ˆé€¼è¿‘æœ€å¤§å†™å…¥é€Ÿåº¦ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=seqwrite --rw=write --bs=1M --size=5G --numjobs=4 --iodepth=32 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>

<p>éšæœºè¯» IOPS æµ‹è¯•ï¼ˆé€¼è¿‘æœ€å¤§å¹¶å‘å¤„ç†èƒ½åŠ›ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=randread --rw=randread --bs=4k --size=5G --numjobs=4 --iodepth=64 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>

<p>æ··åˆè¯»å†™æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿæ•°æ®åº“è´Ÿè½½ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=mixrw --rw=randrw --rwmixread=70 --bs=4k --size=5G --numjobs=4 --iodepth=32 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>


<h2 id="ç£ç›˜çš„æµ‹è¯•ç»“æœ"><a href="#ç£ç›˜çš„æµ‹è¯•ç»“æœ" class="headerlink" title="ç£ç›˜çš„æµ‹è¯•ç»“æœ"></a>ç£ç›˜çš„æµ‹è¯•ç»“æœ</h2><p>ç”±äºæ˜¯æ—‹è½¬ç£ç›˜ï¼Œiodepth æ€»æ˜¯ 1ï¼ˆè®¾æˆå…¶ä»–å€¼ä¸ä¼šç”Ÿæ•ˆï¼‰</p>
<p><strong>å•çº¿ç¨‹è¯»å†™æ–‡ä»¶ï¼š</strong></p>
<details>
  <summary>ç‚¹å‡»å±•å¼€ä»£ç </summary>
  <pre>
    <figure class="highlight bash"><figcaption><span>fio_bs_test.sh</span><a href="/blog/downloads/code/fio_bs_test.sh">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•å‚æ•°</span></span><br><span class="line">DEVICE=<span class="string">&quot;./testfile&quot;</span>   <span class="comment"># ä¿®æ”¹ä¸ºä½ è¦æµ‹è¯•çš„æ–‡ä»¶æˆ–è®¾å¤‡è·¯å¾„</span></span><br><span class="line">RUNTIME=30                       <span class="comment"># æ¯ä¸ªæµ‹è¯•è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line"><span class="comment"># BLOCK_SIZES=(&quot;4k&quot; &quot;16k&quot; &quot;64k&quot; &quot;256k&quot; &quot;1M&quot; &quot;4M&quot; &quot;16M&quot; &quot;32M&quot; &quot;64M&quot; &quot;128M&quot;)  # æµ‹è¯•å—å¤§å°åˆ—è¡¨</span></span><br><span class="line">BLOCK_SIZES=(<span class="string">&quot;128M&quot;</span> <span class="string">&quot;64M&quot;</span> <span class="string">&quot;32M&quot;</span> <span class="string">&quot;16M&quot;</span> <span class="string">&quot;4M&quot;</span> <span class="string">&quot;1M&quot;</span> <span class="string">&quot;256k&quot;</span> <span class="string">&quot;64k&quot;</span> <span class="string">&quot;16k&quot;</span> <span class="string">&quot;4k&quot;</span>)  <span class="comment"># æµ‹è¯•å—å¤§å°åˆ—è¡¨</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;fio_bs_output.log&quot;</span>        <span class="comment"># åŸå§‹è¾“å‡ºæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line">PERFORMANCE_LOG=<span class="string">&quot;fio_bs_performance.log&quot;</span>  <span class="comment"># æ€§èƒ½ç»“æœæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºè¡¨å¤´</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s | %-10s | %-8s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;RW&quot;</span> <span class="string">&quot;BlockSize&quot;</span> <span class="string">&quot;IOPS&quot;</span> <span class="string">&quot;BW(MiB/s)&quot;</span> <span class="string">&quot;AvgLat(ms)&quot;</span> | <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------------------------------------------------------&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>  <span class="comment"># æ¸…ç©ºæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¾ªç¯æµ‹è¯•ä¸åŒå—å¤§å°</span></span><br><span class="line"><span class="keyword">for</span> RW <span class="keyword">in</span> <span class="built_in">read</span> write; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> BS <span class="keyword">in</span> <span class="string">&quot;<span class="variable">${BLOCK_SIZES[@]}</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    OUTPUT=$(fio --name=bs_test \</span><br><span class="line">                 --filename=<span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span> \</span><br><span class="line">                 --rw=<span class="variable">$RW</span> \</span><br><span class="line">                 --bs=<span class="variable">$BS</span> \</span><br><span class="line">                 --size=1G \</span><br><span class="line">                 --time_based \</span><br><span class="line">                 --runtime=<span class="variable">$RUNTIME</span> \</span><br><span class="line">                 --numjobs=1 \</span><br><span class="line">                 --direct=1 \</span><br><span class="line">                 --ioengine=psync \</span><br><span class="line">                 --group_reporting)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;----------------------------------------------&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–å…³é”®æŒ‡æ ‡</span></span><br><span class="line">    <span class="built_in">read</span> IOPS BW BWUNIT LAT LAT_UNIT &lt;&lt;&lt; $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> | awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        /IOPS=/ {match($0, /IOPS= *([0-9.]+)/, iops)}</span></span><br><span class="line"><span class="string">        /BW=/ {</span></span><br><span class="line"><span class="string">            match($0, /BW= *([0-9.]+)([KMG]iB)\/s/, bwinfo)</span></span><br><span class="line"><span class="string">            bwval=bwinfo[1]; bwunit=bwinfo[2]</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">        /clat \(/ {match($0, /avg= *([0-9.]+),/, lat); match($0, /\(([^)]+)\)/, lat_unit)}</span></span><br><span class="line"><span class="string">        END {print iops[1], bwval, bwunit, lat[1], lat_unit[1]}</span></span><br><span class="line"><span class="string">    &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å»¶è¿Ÿå•ä½æ¢ç®—</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;usec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$LAT</span>/1000}&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;msec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=<span class="variable">$LAT</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        LAT_MS=<span class="string">&quot;Unknown&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¸¦å®½å•ä½æ¢ç®—ä¸º MiB/s</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$BWUNIT</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;KiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>/1024}&quot;</span>) ;;</span><br><span class="line">        <span class="string">&quot;MiB&quot;</span>) BW_MIB=<span class="variable">$BW</span> ;;</span><br><span class="line">        <span class="string">&quot;GiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>*1024}&quot;</span>) ;;</span><br><span class="line">        *) BW_MIB=<span class="string">&quot;Unknown&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¾“å‡ºç»“æœè¡Œ</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;%-8s | %-10s | %-8s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;<span class="variable">$RW</span>&quot;</span> <span class="string">&quot;<span class="variable">$BS</span>&quot;</span> <span class="string">&quot;<span class="variable">$IOPS</span>&quot;</span> <span class="string">&quot;<span class="variable">$BW_MIB</span>&quot;</span> <span class="string">&quot;<span class="variable">$LAT_MS</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ fio åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æµ‹è¯•å®Œæˆï¼Œç»“æœå·²ä¿å­˜åˆ° <span class="variable">$LOG_FILE</span> å’Œ <span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br></pre></td></tr></table></figure>
  </pre>
</details>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RW       | BlockSize  | IOPS     | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">read     | 4k         | 194      | 0.76       | 5.14</span><br><span class="line">read     | 16k        | 239      | 3.74       | 4.17</span><br><span class="line">read     | 64k        | 347      | 21.7       | 2.88</span><br><span class="line">read     | 256k       | 271      | 67.9       | 3.68</span><br><span class="line">read     | 1M         | 94       | 94.9       | 10.53</span><br><span class="line">read     | 4M         | 14       | 57.2       | 69.74</span><br><span class="line">read     | 16M        | 6        | 97.6       | 163.96</span><br><span class="line">read     | 32M        | 3        | 111        | 288.99</span><br><span class="line">read     | 64M        | 1        | 112        | 573.70</span><br><span class="line">read     | 128M       | 0        | 112        | 1147.00</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RW       | BlockSize  | IOPS     | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">write    | 4k         | 1884     | 7.36       | 0.53</span><br><span class="line">write    | 16k        | 1452     | 22.7       | 0.69</span><br><span class="line">write    | 64k        | 793      | 49.6       | 1.26</span><br><span class="line">write    | 256k       | 307      | 76.8       | 3.24</span><br><span class="line">write    | 1M         | 100      | 100        | 9.96</span><br><span class="line">write    | 4M         | 18       | 73.7       | 53.99</span><br><span class="line">write    | 16M        | 5        | 93.8       | 169.43</span><br><span class="line">write    | 32M        | 3        | 101        | 313.24</span><br><span class="line">write    | 64M        | 1        | 107        | 594.46</span><br><span class="line">write    | 128M       | 0        | 102        | 1249.35</span><br></pre></td></tr></table></figure>


<p>å½“ BlockSize&#x3D;32M ä»¥åï¼Œå†™å…¥æ€§èƒ½åŸºæœ¬è¾¾åˆ°é¡¶å³°ï¼ˆ110 MiB&#x2F;sï¼‰ï¼Œå’Œæ—‹è½¬ç£ç›˜çš„å‚æ•°åŸºæœ¬ä¸€è‡´ã€‚</p>
<p><strong>å¤šçº¿ç¨‹è¯»å†™åŒä¸€ä¸ªæ–‡ä»¶ï¼ŒBS&#x3D;64KiBï¼š</strong></p>
<details>
  <summary>ç‚¹å‡»å±•å¼€ä»£ç </summary>
  <pre>
    <figure class="highlight bash"><figcaption><span>fio_mt_test.sh</span><a href="/blog/downloads/code/fio_mt_test.sh">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">DEVICE=<span class="string">&quot;./mt_testfile&quot;</span>   <span class="comment"># æµ‹è¯•æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">RUNTIME=30            <span class="comment"># æ¯ä¸ªæµ‹è¯•è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">THREADS=(1 2 4 8 16 32 64 72 120)  <span class="comment"># æµ‹è¯•çº¿ç¨‹æ•°åˆ—è¡¨</span></span><br><span class="line">BLOCK_SIZE=<span class="string">&quot;64k&quot;</span>      <span class="comment"># å—å¤§å°ï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;fio_thread_output.log&quot;</span></span><br><span class="line">PERFORMANCE_LOG=<span class="string">&quot;fio_thread_performance.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºè¡¨å¤´</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s | %-8s | %-10s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;RW&quot;</span> <span class="string">&quot;Threads&quot;</span> <span class="string">&quot;IOPS&quot;</span> <span class="string">&quot;BW(MiB/s)&quot;</span> <span class="string">&quot;AvgLat(ms)&quot;</span> | <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---------------------------------------------------------------&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>  <span class="comment"># æ¸…ç©ºæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> RW <span class="keyword">in</span> <span class="built_in">read</span> write; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> THREAD <span class="keyword">in</span> <span class="string">&quot;<span class="variable">${THREADS[@]}</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    OUTPUT=$(fio --name=thread_test \</span><br><span class="line">                 --filename=<span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span> \</span><br><span class="line">                 --rw=<span class="variable">$RW</span> \</span><br><span class="line">                 --bs=<span class="variable">$BLOCK_SIZE</span> \</span><br><span class="line">                 --size=5G \</span><br><span class="line">                 --time_based \</span><br><span class="line">                 --runtime=<span class="variable">$RUNTIME</span> \</span><br><span class="line">                 --numjobs=<span class="variable">$THREAD</span> \</span><br><span class="line">                 --direct=1 \</span><br><span class="line">                 --ioengine=psync \</span><br><span class="line">                 --group_reporting)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;---------------------------------------------------------------&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–å…³é”®æŒ‡æ ‡</span></span><br><span class="line">    <span class="built_in">read</span> IOPS BW BWUNIT LAT LAT_UNIT &lt;&lt;&lt; $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> | awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        /IOPS=/ {match($0, /IOPS= *([0-9.]+)/, iops)}</span></span><br><span class="line"><span class="string">        /BW=/ {</span></span><br><span class="line"><span class="string">            match($0, /BW= *([0-9.]+)([KMG]iB)\/s/, bwinfo)</span></span><br><span class="line"><span class="string">            bwval=bwinfo[1]; bwunit=bwinfo[2]</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">        /clat \(/ {match($0, /avg= *([0-9.]+),/, lat); match($0, /\(([^)]+)\)/, lat_unit)}</span></span><br><span class="line"><span class="string">        END {print iops[1], bwval, bwunit, lat[1], lat_unit[1]}</span></span><br><span class="line"><span class="string">    &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å»¶è¿Ÿå•ä½æ¢ç®—</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;usec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$LAT</span>/1000}&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;msec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=<span class="variable">$LAT</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        LAT_MS=<span class="string">&quot;Unknown&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¸¦å®½å•ä½æ¢ç®—ä¸º MiB/s</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$BWUNIT</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;KiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>/1024}&quot;</span>) ;;</span><br><span class="line">        <span class="string">&quot;MiB&quot;</span>) BW_MIB=<span class="variable">$BW</span> ;;</span><br><span class="line">        <span class="string">&quot;GiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>*1024}&quot;</span>) ;;</span><br><span class="line">        *) BW_MIB=<span class="string">&quot;Unknown&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¾“å‡ºç»“æœè¡Œ</span></span><br><span class="line">  <span class="built_in">printf</span> <span class="string">&quot;%-8s | %-8s | %-10s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;<span class="variable">$RW</span>&quot;</span> <span class="string">&quot;<span class="variable">$THREAD</span>&quot;</span> <span class="string">&quot;<span class="variable">$IOPS</span>&quot;</span> <span class="string">&quot;<span class="variable">$BW_MIB</span>&quot;</span> <span class="string">&quot;<span class="variable">$LAT_MS</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æµ‹è¯•å®Œæˆï¼Œç»“æœå·²ä¿å­˜åˆ° <span class="variable">$LOG_FILE</span> å’Œ <span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br></pre></td></tr></table></figure>
  </pre>
</details>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RW       | Threads  | IOPS       | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">read     | 1        | 826        | 51.6       | 1.21</span><br><span class="line">read     | 2        | 1300       | 81.3       | 1.54</span><br><span class="line">read     | 4        | 1681       | 105        | 2.38</span><br><span class="line">read     | 8        | 1778       | 111        | 4.49</span><br><span class="line">read     | 16       | 1789       | 112        | 8.93</span><br><span class="line">read     | 32       | 1790       | 112        | 17.86</span><br><span class="line">read     | 64       | 1789       | 112        | 35.73</span><br><span class="line">read     | 72       | 1790       | 112        | 40.18</span><br><span class="line">read     | 120      | 1789       | 112        | 66.98</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RW       | Threads  | IOPS       | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">write    | 1        | 847        | 52.9       | 1.18</span><br><span class="line">write    | 2        | 1367       | 85.5       | 1.46</span><br><span class="line">write    | 4        | 1757       | 110        | 2.27</span><br><span class="line">write    | 8        | 1786       | 112        | 4.47</span><br><span class="line">write    | 16       | 1788       | 112        | 8.92</span><br><span class="line">write    | 32       | 1788       | 112        | 17.79</span><br><span class="line">write    | 64       | 1788       | 112        | 35.09</span><br><span class="line">write    | 72       | 1788       | 112        | 39.54</span><br><span class="line">write    | 120      | 1784       | 112        | 64.50</span><br></pre></td></tr></table></figure>

<p>å½“çº¿ç¨‹æ•°å¢åŠ ï¼ŒIO æ€§èƒ½éšä¹‹æé«˜ï¼Œå¯èƒ½åŸå› æ˜¯ 64KiB å°å—æ•°æ®å¤§é‡æäº¤åˆ° I&#x2F;O é˜Ÿåˆ—ï¼Œæ“ä½œç³»ç»Ÿèƒ½æ›´å¥½åœ°å®Œæˆè¯»å†™è·¯å¾„ä¼˜åŒ–ã€‚<br>ä½†è¾¾åˆ°8çº¿ç¨‹çš„æ—¶å€™ï¼Œå°±åŸºæœ¬åˆ°è¾¾æ€§èƒ½é¡¶å³°äº†ã€‚</p>
<p>æ³¨æ„ï¼šfio å¤šçº¿ç¨‹å†™å…¥åŒä¸€ä¸ªæ–‡ä»¶æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œå¦‚æœè¶…è¿‡ page cache (ä¸€èˆ¬æ˜¯ 4 KB)ï¼Œé‚£ä¹ˆå¯èƒ½ä¹±åºå†™å…¥ã€‚</p>
<h2 id="æ¦‚å¿µï¼ˆä»¥-fio-ä¸ºä¾‹ï¼‰"><a href="#æ¦‚å¿µï¼ˆä»¥-fio-ä¸ºä¾‹ï¼‰" class="headerlink" title="æ¦‚å¿µï¼ˆä»¥ fio ä¸ºä¾‹ï¼‰"></a>æ¦‚å¿µï¼ˆä»¥ fio ä¸ºä¾‹ï¼‰</h2><h3 id="ioengine"><a href="#ioengine" class="headerlink" title="ioengine"></a>ioengine</h3><p>ioengineï¼ˆI&#x2F;O å¼•æ“ï¼‰æ˜¯ fio æä¾›ä»¥æ‰§è¡Œè¯»å†™ä»»åŠ¡çš„åº•å±‚æ¥å£ã€‚ä¸åŒçš„å¼•æ“ä»£è¡¨ä¸åŒçš„ I&#x2F;O æ¨¡å‹ï¼Œæ¯”å¦‚åŒæ­¥ã€å¼‚æ­¥ã€å†…å­˜æ˜ å°„ã€é›¶æ‹·è´ç­‰ã€‚</p>
<table>
<thead>
<tr>
<th align="center">å¼•æ“åç§°</th>
<th align="center">ç±»å‹</th>
<th align="center">ç‰¹ç‚¹ä¸ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync</td>
<td align="center">åŒæ­¥</td>
<td align="center">é»˜è®¤æ–¹å¼ï¼Œæ¯æ¬¡ I&#x2F;O éƒ½ç­‰å¾…å®Œæˆï¼Œé€‚åˆç®€å•æµ‹è¯•</td>
</tr>
<tr>
<td align="center">psync</td>
<td align="center">åŒæ­¥</td>
<td align="center">ä½¿ç”¨ pread&#x2F;pwriteï¼Œå¯æŒ‡å®šåç§»ï¼Œç•¥å¿«</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">å¼‚æ­¥</td>
<td align="center">Linux å¼‚æ­¥ I&#x2F;Oï¼Œé€‚åˆé«˜æ€§èƒ½ SSD&#x2F;NVMe</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">å¼‚æ­¥</td>
<td align="center">æ–°ä¸€ä»£ Linux å¼‚æ­¥æ¥å£ï¼Œä½å»¶è¿Ÿã€é«˜å¹¶å‘</td>
</tr>
<tr>
<td align="center">mmap</td>
<td align="center">å†…å­˜æ˜ å°„</td>
<td align="center">å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œé€‚åˆå¤§æ–‡ä»¶é¡ºåºè®¿é—®</td>
</tr>
<tr>
<td align="center">splice</td>
<td align="center">é›¶æ‹·è´</td>
<td align="center">ç”¨äºé«˜æ•ˆæ•°æ®ä¼ è¾“ï¼Œå‡å°‘ CPU å’Œå†…å­˜å¼€é”€</td>
</tr>
<tr>
<td align="center">windowsaio</td>
<td align="center">å¼‚æ­¥</td>
<td align="center">Windows åŸç”Ÿå¼‚æ­¥ I&#x2F;Oï¼Œé€‚åˆå¤šçº¿ç¨‹å†™å…¥</td>
</tr>
<tr>
<td align="center">net</td>
<td align="center">ç½‘ç»œ</td>
<td align="center">ç”¨äºç½‘ç»œ I&#x2F;O æµ‹è¯•ï¼Œå¦‚ socket ä¼ è¾“</td>
</tr>
<tr>
<td align="center">sg</td>
<td align="center">SCSI</td>
<td align="center">ç”¨äºç›´æ¥è®¿é—® SCSI è®¾å¤‡</td>
</tr>
</tbody></table>
<p>æ¯ç§ ioengine éƒ½ä¾èµ–æ“ä½œç³»ç»Ÿæä¾›çš„åº•å±‚ I&#x2F;O æ¥å£ã€‚ä¾‹å¦‚ï¼š</p>
<table>
<thead>
<tr>
<th align="center">ioengine ç±»å‹</th>
<th align="center">æ“ä½œç³»ç»Ÿè¦æ±‚</th>
<th align="center">æ˜¯å¦å¼‚æ­¥</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync &#x2F; psync</td>
<td align="center">æ‰€æœ‰ç³»ç»Ÿ</td>
<td align="center">âŒ</td>
<td align="center">ä½¿ç”¨æ ‡å‡†é˜»å¡ I&#x2F;Oï¼Œå‡ ä¹æ€»æ˜¯å¯ç”¨</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">Linuxï¼Œéœ€å®‰è£… libaio åº“</td>
<td align="center">âœ…</td>
<td align="center">ä¾èµ– Linux çš„å¼‚æ­¥ I&#x2F;O æ¥å£</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">Linux â‰¥ 5.1ï¼Œæ¨è â‰¥ 5.4</td>
<td align="center">âœ…</td>
<td align="center">ä¾èµ–æ–°å†…æ ¸ç‰¹æ€§å’Œ liburing åº“</td>
</tr>
<tr>
<td align="center">windowsaio</td>
<td align="center">Windows</td>
<td align="center">âœ…</td>
<td align="center">ä½¿ç”¨ Windows åŸç”Ÿå¼‚æ­¥ I&#x2F;O</td>
</tr>
<tr>
<td align="center">mmap</td>
<td align="center">æ‰€æœ‰ä¸»æµç³»ç»Ÿ</td>
<td align="center">âŒ</td>
<td align="center">ä½¿ç”¨å†…å­˜æ˜ å°„ï¼Œé€‚åˆé¡ºåºè¯»å†™</td>
</tr>
<tr>
<td align="center">posixaio</td>
<td align="center">POSIX å…¼å®¹ç³»ç»Ÿ</td>
<td align="center">âœ…</td>
<td align="center">ä½¿ç”¨ aio_read &#x2F; aio_write æ¥å£</td>
</tr>
</tbody></table>
<p>ä½ å¯ä»¥æŒ‡å®šä»»æ„ ioengine ï¼ˆé»˜è®¤å€¼æ˜¯ sync &#x2F; psyncï¼‰ï¼Œä½†å®ƒæ˜¯å¦èƒ½è¿è¡Œï¼Œå¿…é¡»å¾—åˆ°æ“ä½œç³»ç»Ÿçš„æ”¯æŒã€‚è¿™åŒ…æ‹¬å†…æ ¸ç‰ˆæœ¬ã€ç³»ç»Ÿæ¥å£ã€åº“æ–‡ä»¶ç­‰ã€‚å¦‚æœç³»ç»Ÿä¸æ”¯æŒï¼Œfio ä¼šæŠ¥é”™æˆ–è‡ªåŠ¨å›é€€ã€‚</p>
<p>æŸ¥çœ‹æ”¯æŒåˆ—è¡¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --enghelp</span><br></pre></td></tr></table></figure>

<p>è¿™ä¼šåˆ—å‡ºå½“å‰ç³»ç»Ÿä¸Šå¯ç”¨çš„ ioengineï¼Œä½†æ³¨æ„ï¼šåˆ—å‡ºæ¥ â‰  èƒ½ç”¨ï¼Œè¿˜è¦çœ‹è¿è¡Œæ—¶æ˜¯å¦æŠ¥é”™ã€‚</p>
<p>å®é™…æµ‹è¯•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=<span class="built_in">test</span> --ioengine=io_uring --rw=write --size=1G --bs=1M</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸æ”¯æŒï¼Œä¼šæŠ¥é”™ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio: pid=132756, err=38/file:engines/io_uring.c:1351, func=io_queue_init, error=Function not implemented</span><br></pre></td></tr></table></figure>

<h3 id="iodepth"><a href="#iodepth" class="headerlink" title="iodepth"></a>iodepth</h3><p><code>--iodepth</code> æ˜¯ä¼ é€’ç»™å†…æ ¸çš„å‚æ•°ã€‚</p>
<p>å¦‚æœä½ ä¸æ˜¾å¼è®¾ç½® <code>--iodepth</code>ï¼Œé‚£ä¹ˆ fio ä¼šæ ¹æ®æ‰€é€‰çš„ I&#x2F;O å¼•æ“ï¼ˆ<code>--ioengine</code>ï¼‰ æ¥å†³å®šé»˜è®¤å€¼</p>
<table>
<thead>
<tr>
<th align="center">I&#x2F;O å¼•æ“</th>
<th align="center">é»˜è®¤ iodepth</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync &#x2F; psync &#x2F; vsync</td>
<td align="center">1ï¼ˆåŒæ­¥ I&#x2F;Oï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªå¤„ç†ï¼‰</td>
</tr>
<tr>
<td align="center">libaio &#x2F; io_uring</td>
<td align="center">1ï¼Œä½†å¯ä»¥è®¾ç½®æ›´é«˜ä»¥å¯ç”¨å¼‚æ­¥å¹¶å‘</td>
</tr>
<tr>
<td align="center">mmap &#x2F; pread &#x2F; pwrite</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">windowsaioï¼ˆWindowsï¼‰</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">sgï¼ˆSCSI genericï¼‰</td>
<td align="center">1</td>
</tr>
</tbody></table>
<p>fio å¹¶ä¸ä¼šä¸»åŠ¨ç»´æŠ¤é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ˜¯å†…æ ¸çš„ç‰¹æ€§ã€‚</p>
<table>
<thead>
<tr>
<th align="center">I&#x2F;O å¼•æ“</th>
<th align="center">é˜Ÿåˆ—ä½ç½®</th>
<th align="center">æ˜¯å¦å¼‚æ­¥</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">psync &#x2F; sync</td>
<td align="center">æ— é˜Ÿåˆ—ï¼ˆç›´æ¥è°ƒç”¨ï¼‰</td>
<td align="center">å¦</td>
<td align="center">æ¯æ¬¡å†™å…¥è°ƒç”¨ write()ï¼Œæ— æ’é˜Ÿæœºåˆ¶</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">å†…æ ¸ç©ºé—´</td>
<td align="center">âœ… æ˜¯</td>
<td align="center">ä½¿ç”¨ Linux AIOï¼Œé˜Ÿåˆ—åœ¨å†…æ ¸ä¸­ï¼Œç”± io_submit() æäº¤</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">ç”¨æˆ· + å†…æ ¸å…±äº«</td>
<td align="center">âœ… æ˜¯</td>
<td align="center">ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºï¼Œç”¨æˆ·ç©ºé—´æäº¤ï¼Œå†…æ ¸ç©ºé—´å¤„ç†</td>
</tr>
<tr>
<td align="center">mmap &#x2F; null</td>
<td align="center">ç”¨æˆ·ç©ºé—´</td>
<td align="center">âŒ å¦</td>
<td align="center">æ¨¡æ‹Ÿæˆ–è·³è¿‡å®é™… I&#x2F;Oï¼Œä¸æ¶‰åŠå†…æ ¸é˜Ÿåˆ—</td>
</tr>
</tbody></table>
<ul>
<li>å¯¹äºæ”¯æŒå¼‚æ­¥ I&#x2F;O çš„å¼•æ“ï¼ˆå¦‚ libaio æˆ– io_uringï¼‰ï¼Œä½ å¯ä»¥è®¾ç½®æ›´é«˜çš„ iodepthï¼ˆå¦‚ 32ã€64ã€128ï¼‰æ¥æ¨¡æ‹Ÿé«˜å¹¶å‘è´Ÿè½½ï¼›</li>
<li>å¯¹ SSD æˆ– NVMe è®¾å¤‡ï¼Œé«˜ iodepth èƒ½æ˜¾è‘—æå‡ IOPS å’Œååé‡ï¼›</li>
<li>å¯¹æœºæ¢°ç¡¬ç›˜ï¼Œæå‡æœ‰é™ï¼Œä½†ä»å¯ç”¨äºæµ‹è¯•è°ƒåº¦ç­–ç•¥å’Œé˜Ÿåˆ—è¡Œä¸ºã€‚</li>
</ul>
<p>ä½†å¦‚æœä½ çš„ ioengine æ˜¯ sync æˆ– psyncï¼Œè¿™äº›æ˜¯åŒæ­¥é˜»å¡ I&#x2F;Oï¼Œæ ¹æœ¬ä¸æ”¯æŒé«˜å¹¶å‘ï¼Œæ‰€ä»¥ iodepth å®é™…ä¸Šä¸ä¼šç”Ÿæ•ˆã€‚</p>
<table>
<thead>
<tr>
<th align="center">å‚æ•°</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">â€“name&#x3D;seqwrite</td>
<td align="center">å®šä¹‰æµ‹è¯•ä»»åŠ¡çš„åç§°ä¸º seqwriteï¼Œç”¨äºæ ‡è¯†è¾“å‡ºç»“æœ</td>
</tr>
<tr>
<td align="center">â€“rw&#x3D;write</td>
<td align="center">è®¾ç½®ä¸ºé¡ºåºå†™å…¥æ¨¡å¼ï¼ˆsequential writeï¼‰ï¼Œæ•°æ®æŒ‰é¡ºåºå†™å…¥ç£ç›˜</td>
</tr>
<tr>
<td align="center">â€“bs&#x3D;1M</td>
<td align="center">æ¯æ¬¡ I&#x2F;O æ“ä½œçš„å—å¤§å°ä¸º 1MBï¼Œé€‚åˆæµ‹è¯•ååé‡</td>
</tr>
<tr>
<td align="center">â€“size&#x3D;5G</td>
<td align="center">æ¯ä¸ªçº¿ç¨‹å†™å…¥çš„æ€»æ•°æ®é‡ä¸º 5GBï¼ˆä¸æ˜¯æ€»å…±ï¼Œæ˜¯æ¯ä¸ª jobï¼‰</td>
</tr>
<tr>
<td align="center">â€“numjobs&#x3D;4</td>
<td align="center">å¯åŠ¨ 4 ä¸ªå¹¶å‘çº¿ç¨‹ï¼ˆjobï¼‰ï¼Œæ¨¡æ‹Ÿå¤šçº¿ç¨‹å†™å…¥åœºæ™¯</td>
</tr>
<tr>
<td align="center">â€“iodepth&#x3D;32</td>
<td align="center">æ¯ä¸ªçº¿ç¨‹çš„ I&#x2F;O é˜Ÿåˆ—æ·±åº¦ä¸º 32ï¼Œè¡¨ç¤ºæœ€å¤šå¯åŒæ—¶æŒ‚èµ· 32 ä¸ª I&#x2F;O è¯·æ±‚ <br> æœ¬ä¾‹ä¸­æ¯ä¸ªçº¿ç¨‹ä¼šå‘èµ· 5G&#x2F;1M&#x3D;5120 ä¸ª I&#x2F;O è¯·æ±‚</td>
</tr>
<tr>
<td align="center">â€“direct&#x3D;1</td>
<td align="center">ç»•è¿‡ç³»ç»Ÿç¼“å­˜ï¼Œç›´æ¥å¯¹ç£ç›˜è¿›è¡Œè¯»å†™ï¼Œæ›´çœŸå®åœ°åæ˜ è®¾å¤‡æ€§èƒ½</td>
</tr>
<tr>
<td align="center">â€“runtime&#x3D;60</td>
<td align="center">æµ‹è¯•æŒç»­æ—¶é—´ä¸º 60 ç§’ï¼Œä¼˜å…ˆäº â€“sizeï¼Œ<br>1. å³ä½¿æ•°æ®å†™å®Œä¹Ÿç»§ç»­å†™æ›´å¤šæ•°æ®ç›´åˆ°æ—¶é—´ç»“æŸ &lt; br&gt;2. å¦‚æœæ²¡æœ‰å†™å®Œï¼Œåˆ™æ—¶é—´åˆ°å°±ç»“æŸ</td>
</tr>
<tr>
<td align="center">â€“group_reporting</td>
<td align="center">æ±‡æ€»æ‰€æœ‰çº¿ç¨‹çš„æµ‹è¯•ç»“æœï¼Œè¾“å‡ºæ•´ä½“æ€§èƒ½æŒ‡æ ‡è€Œä¸æ˜¯æ¯ä¸ªçº¿ç¨‹å•ç‹¬æ˜¾ç¤º</td>
</tr>
</tbody></table>
<p>å¯èƒ½çš„ä»£ç å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libaio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_PATH <span class="string">&quot;testfile.bin&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IODEPTH 4  <span class="comment">// æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°é‡</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd = open(FILE_PATH, O_CREAT | O_WRONLY | O_DIRECT, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// io_setup æ˜¯ libaio çš„å‡½æ•°</span></span><br><span class="line">    <span class="type">io_context_t</span> ctx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (io_setup(IODEPTH, &amp;ctx) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;io_setup&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iocb</span> *<span class="title">iocbs</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iocb</span> <span class="title">iocb_array</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    <span class="type">char</span> *buffers[IODEPTH];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; IODEPTH; i++) &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…å¯¹é½å†…å­˜</span></span><br><span class="line">        posix_memalign((<span class="type">void</span>**)&amp;buffers[i], BLOCK_SIZE, BLOCK_SIZE);</span><br><span class="line">        <span class="built_in">memset</span>(buffers[i], <span class="string">&#x27;A&#x27;</span> + i, BLOCK_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– iocb</span></span><br><span class="line">        io_prep_pwrite(&amp;iocb_array[i], fd, buffers[i], BLOCK_SIZE, i * BLOCK_SIZE);</span><br><span class="line">        iocbs[i] = &amp;iocb_array[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æäº¤æ‰€æœ‰è¯·æ±‚</span></span><br><span class="line">    <span class="type">int</span> ret = io_submit(ctx, IODEPTH, iocbs);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;io_submit&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_event</span> <span class="title">events</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    io_getevents(ctx, IODEPTH, IODEPTH, events, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; IODEPTH; i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(buffers[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    io_destroy(ctx);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;All %d I/O requests completed.\n&quot;</span>, IODEPTH);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="å»¶è¿Ÿ"><a href="#å»¶è¿Ÿ" class="headerlink" title="å»¶è¿Ÿ"></a>å»¶è¿Ÿ</h3><table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>å«ä¹‰</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>slat</td>
<td>Submission Latency</td>
<td>ä» fio å‘èµ· I&#x2F;O è¯·æ±‚åˆ°å†…æ ¸æ¥æ”¶è¯¥è¯·æ±‚çš„æ—¶é—´ã€‚é€šå¸¸å¾ˆçŸ­ï¼Œå•ä½æ˜¯å¾®ç§’ï¼ˆusecï¼‰ã€‚</td>
</tr>
<tr>
<td>clat</td>
<td>Completion Latency</td>
<td>ä»å†…æ ¸æ¥æ”¶è¯·æ±‚åˆ° I&#x2F;O æ“ä½œå®Œæˆçš„æ—¶é—´ã€‚è¿™ä¸ªæ˜¯æœ€èƒ½åæ˜ å­˜å‚¨è®¾å¤‡æ€§èƒ½çš„éƒ¨åˆ†ã€‚</td>
</tr>
<tr>
<td>lat</td>
<td>Total Latency</td>
<td>æ€»å»¶è¿Ÿï¼Œå³ slat + clatï¼Œè¡¨ç¤ºä» fio å‘èµ·è¯·æ±‚åˆ° I&#x2F;O å®Œæˆçš„æ•´ä¸ªè¿‡ç¨‹ã€‚</td>
</tr>
</tbody></table>
<h3 id="ç»“æœåˆ†æ"><a href="#ç»“æœåˆ†æ" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ fio --name=seqwrite --rw=write --bs=1M --size=5G --numjobs=2 --direct=1 --runtime=60 --group_reporting</span><br><span class="line">seqwrite: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=psync, iodepth=1</span><br><span class="line">...</span><br><span class="line">fio-3.41</span><br><span class="line">Starting 2 processes</span><br><span class="line">seqwrite: Laying out IO file (1 file / 5120MiB)</span><br><span class="line">seqwrite: Laying out IO file (1 file / 5120MiB)</span><br><span class="line">Jobs: 2 (f=2): [W(2)][100.0%][w=112MiB/s][w=112 IOPS][eta 00m:00s]</span><br><span class="line">seqwrite: (groupid=0, <span class="built_in">jobs</span>=2): err= 0: pid=70688: Sun Sep  7 22:37:47 2025</span><br><span class="line">  write: IOPS=111, BW=111MiB/s (117MB/s)(6685MiB/60016msec); 0 zone resets</span><br><span class="line">    clat (usec): min=9606, max=74763, avg=17922.82, stdev=1446.89</span><br><span class="line">     lat (usec): min=9628, max=74791, avg=17951.49, stdev=1446.80</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[15008],  5.00th=[16319], 10.00th=[16909], 20.00th=[17433],</span><br><span class="line">     | 30.00th=[17695], 40.00th=[17695], 50.00th=[17957], 60.00th=[17957],</span><br><span class="line">     | 70.00th=[18220], 80.00th=[18482], 90.00th=[19006], 95.00th=[19268],</span><br><span class="line">     | 99.00th=[21365], 99.50th=[22414], 99.90th=[32375], 99.95th=[40109],</span><br><span class="line">     | 99.99th=[74974]</span><br><span class="line">   bw (KiB/s): min=96062, max=116736, per=100.00%, avg=114150.20, stdev=1061.35, samples=238</span><br><span class="line">   iops        : min=   92, max=  114, avg=110.77, stdev= 1.18, samples=238</span><br><span class="line">  lat (msec)   : 10=0.03%, 20=97.43%, 50=2.53%, 100=0.01%</span><br><span class="line">  cpu          : usr=0.22%, sys=0.75%, ctx=6717, majf=0, minf=67</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,6685,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">  WRITE: bw=111MiB/s (117MB/s), 111MiB/s-111MiB/s (117MB/s-117MB/s), io=6685MiB (7010MB), run=60016-60016mse</span><br></pre></td></tr></table></figure>

<p>ğŸ§¾ æµ‹è¯•é…ç½®è§£æ<br>bash<br>fio â€“name&#x3D;seqwrite â€“rw&#x3D;write â€“bs&#x3D;1M â€“size&#x3D;10G â€“numjobs&#x3D;1 â€“direct&#x3D;1 â€“runtime&#x3D;60 â€“group_reporting<br>å‚æ•°	å«ä¹‰<br>rw&#x3D;write	é¡ºåºå†™å…¥<br>bs&#x3D;1M	æ¯æ¬¡å†™å…¥å—å¤§å°ä¸º 1MiB<br>numjobs&#x3D;1	å•çº¿ç¨‹å†™å…¥<br>direct&#x3D;1	ä½¿ç”¨ Direct I&#x2F;Oï¼Œç»•è¿‡é¡µç¼“å­˜<br>ioengine&#x3D;psync	ä½¿ç”¨åŒæ­¥ I&#x2F;Oï¼ˆæ¯æ¬¡ pwrite()ï¼‰<br>iodepth&#x3D;1	æ¯æ¬¡åªæŒ‚èµ·ä¸€ä¸ª I&#x2F;O è¯·æ±‚ï¼ˆåŒæ­¥æ¨¡å¼ä¸‹é»˜è®¤å¦‚æ­¤ï¼‰<br>ğŸ“Š æ€§èƒ½ç»“æœæ¦‚è§ˆ<br>æŒ‡æ ‡	æ•°å€¼	è¯´æ˜<br>IOPS	96	æ¯ç§’æ‰§è¡Œ 96 æ¬¡å†™å…¥æ“ä½œ<br>å¸¦å®½	96.2 MiB&#x2F;sï¼ˆ101 MB&#x2F;sï¼‰	æ¯ç§’å†™å…¥çº¦ 96 MiB æ•°æ®<br>æ€»å†™å…¥é‡	5772 MiB	åœ¨ 60 ç§’å†…å®Œæˆçš„å†™å…¥æ€»é‡<br>å»¶è¿Ÿï¼ˆavg clatï¼‰	10.36 ms	æ¯æ¬¡å†™å…¥çš„å¹³å‡å®Œæˆæ—¶é—´<br>CPU ä½¿ç”¨ç‡	usr&#x3D;0.46%, sys&#x3D;1.23%	CPU è´Ÿè½½æä½ï¼Œç“¶é¢ˆä¸åœ¨ CPU<br>â± å»¶è¿Ÿåˆ†å¸ƒåˆ†æ<br>50% çš„å†™å…¥å»¶è¿Ÿä½äº 9.9 ms</p>
<p>95% çš„å†™å…¥ä½äº 12.5 ms</p>
<p>99.95% çš„å†™å…¥å»¶è¿Ÿè¾¾åˆ°äº† 22.9 ms</p>
<p>æœ€æ…¢çš„å†™å…¥é«˜è¾¾ 28.2 ms</p>
<p>å°¾éƒ¨å»¶è¿Ÿç•¥é«˜ï¼Œè¯´æ˜å¶å°”ä¼šæœ‰ç£ç›˜å“åº”å˜æ…¢çš„æƒ…å†µï¼Œå¯èƒ½æ˜¯è®¾å¤‡å†…éƒ¨ç¼“å­˜åˆ·æ–°æˆ–å¯»å€é€ æˆã€‚</p>
<p>ğŸ“ˆ å¸¦å®½æ³¢åŠ¨æƒ…å†µ<br>å¹³å‡å¸¦å®½ï¼šçº¦ 96 MiB&#x2F;s</p>
<p>æœ€å°å¸¦å®½ï¼š60 MiB&#x2F;s</p>
<p>æœ€å¤§å¸¦å®½ï¼š104 MiB&#x2F;s</p>
<p>æ ‡å‡†å·®ï¼š6.2 MiB&#x2F;s â†’ è¡¨æ˜å¸¦å®½ç›¸å¯¹ç¨³å®šï¼Œä½†ä»æœ‰è½»å¾®æ³¢åŠ¨</p>
<p>ğŸ§  æ·±å±‚è§£è¯»<br>âœ… ä¸ºä»€ä¹ˆ IOPS â‰ˆ å¸¦å®½ï¼ˆMiB&#x2F;sï¼‰ï¼Ÿ<br>å› ä¸ºä½ è®¾ç½®äº† bs&#x3D;1Mï¼Œæ¯æ¬¡å†™å…¥ 1MiB æ•°æ®ï¼Œæ‰€ä»¥ï¼š</p>
<p>Code<br>IOPS Ã— Block Size &#x3D; Bandwidth<br>96 IOPS Ã— 1 MiB &#x3D; 96 MiB&#x2F;s<br>âœ… ä¸ºä»€ä¹ˆ Direct I&#x2F;Oï¼Ÿ<br>ç»•è¿‡é¡µç¼“å­˜ï¼Œæµ‹è¯•çš„æ˜¯ç£ç›˜çš„çœŸå®ç‰©ç†æ€§èƒ½ï¼Œé¿å…è¢«å†…å­˜åŠ é€Ÿ â€œæ¬ºéª—â€ã€‚</p>
<p>âœ… ä¸ºä»€ä¹ˆä½¿ç”¨ psyncï¼Ÿ<br>psync æ˜¯åŒæ­¥å†™å…¥ï¼Œæ¯æ¬¡è°ƒç”¨ pwrite()ï¼Œé€‚åˆæ¨¡æ‹Ÿæ•°æ®åº“æˆ–æ—¥å¿—ç³»ç»Ÿçš„å†™å…¥è¡Œä¸ºã€‚ä½†å®ƒæ— æ³•å¹¶å‘æŒ‚èµ·å¤šä¸ªè¯·æ±‚ï¼Œé™åˆ¶äº†ååã€‚</p>
<p>ğŸ“Œ æ€§èƒ½ç“¶é¢ˆåˆ†æ<br>ç£ç›˜ç±»å‹ï¼šå¦‚æœæ˜¯ HDDï¼Œè¿™ä¸ªç»“æœï¼ˆ96 MiB&#x2F;sï¼‰éå¸¸åˆç†ï¼›å¦‚æœæ˜¯ SSDï¼Œåˆ™åä½ï¼Œå¯èƒ½å—é™äºåŒæ­¥ I&#x2F;O æˆ–å•çº¿ç¨‹ã€‚</p>
<p>IO å¼•æ“é™åˆ¶ï¼špsync æ˜¯é˜»å¡å¼ï¼Œæ— æ³•å‘æŒ¥ç£ç›˜çš„å¹¶å‘èƒ½åŠ›ã€‚</p>
<p>çº¿ç¨‹æ•°é™åˆ¶ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œç£ç›˜å¯èƒ½æœªè¢«å……åˆ†åˆ©ç”¨ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/03/cuda/CUDA%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/03/cuda/CUDA%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95/" class="post-title-link" itemprop="url">CUDAçŸ©é˜µä¹˜æ³•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-03 09:23:17" itemprop="dateCreated datePublished" datetime="2025-09-03T09:23:17+00:00">2025-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/CUDA/" itemprop="url" rel="index"><span itemprop="name">CUDA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–"><a href="#ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–" class="headerlink" title="ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–"></a>ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–</h2><p><a href='https://postimg.cc/BjfXcPQ9' target='_blank'><img src='https://i.postimg.cc/dVLrFGb1/matrix-Mul.png' border='0' alt='matrix-Mul'/></a></p>
<figure class="highlight cpp"><figcaption><span>matrixMul.cpp</span><a href="/blog/downloads/code/cuda/matrixMul.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Matrix multiplication (CUDA Kernel) on the device: C = A * B</span></span><br><span class="line"><span class="comment"> * wA is A&#x27;s width and wB is B&#x27;s width</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> BLOCK_SIZE&gt; <span class="function">__global__ <span class="type">void</span> <span class="title">MatrixMulCUDA</span><span class="params">(<span class="type">float</span> *C, <span class="type">float</span> *A, <span class="type">float</span> *B, <span class="type">int</span> wA, <span class="type">int</span> wB)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Block index</span></span><br><span class="line">    <span class="type">int</span> bx = blockIdx.x;</span><br><span class="line">    <span class="type">int</span> by = blockIdx.y;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Thread index</span></span><br><span class="line">    <span class="type">int</span> tx = threadIdx.x;</span><br><span class="line">    <span class="type">int</span> ty = threadIdx.y;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index of the first sub-matrix of A processed by the block</span></span><br><span class="line">    <span class="type">int</span> aBegin = wA * BLOCK_SIZE * by;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index of the last sub-matrix of A processed by the block</span></span><br><span class="line">    <span class="type">int</span> aEnd = aBegin + wA - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step size used to iterate through the sub-matrices of A</span></span><br><span class="line">    <span class="type">int</span> aStep = BLOCK_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index of the first sub-matrix of B processed by the block</span></span><br><span class="line">    <span class="type">int</span> bBegin = BLOCK_SIZE * bx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step size used to iterate through the sub-matrices of B</span></span><br><span class="line">    <span class="type">int</span> bStep = BLOCK_SIZE * wB;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Csub is used to store the element of the block sub-matrix</span></span><br><span class="line">    <span class="comment">// that is computed by the thread</span></span><br><span class="line">    <span class="type">float</span> Csub = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop over all the sub-matrices of A and B</span></span><br><span class="line">    <span class="comment">// required to compute the block sub-matrix</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> a = aBegin, b = bBegin; a &lt;= aEnd; a += aStep, b += bStep) {</span><br><span class="line">        <span class="comment">// Declaration of the shared memory array As used to</span></span><br><span class="line">        <span class="comment">// store the sub-matrix of A</span></span><br><span class="line">        __shared__ <span class="type">float</span> As[BLOCK_SIZE][BLOCK_SIZE];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Declaration of the shared memory array Bs used to</span></span><br><span class="line">        <span class="comment">// store the sub-matrix of B</span></span><br><span class="line">        __shared__ <span class="type">float</span> Bs[BLOCK_SIZE][BLOCK_SIZE];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the matrices from device memory</span></span><br><span class="line">        <span class="comment">// to shared memory; each thread loads</span></span><br><span class="line">        <span class="comment">// one element of each matrix</span></span><br><span class="line">        As[ty][tx] = A[a + wA * ty + tx];</span><br><span class="line">        Bs[ty][tx] = B[b + wB * ty + tx];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Synchronize to make sure the matrices are loaded</span></span><br><span class="line">        __syncthreads();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Multiply the two matrices together;</span></span><br><span class="line">        <span class="comment">// each thread computes one element</span></span><br><span class="line">        <span class="comment">// of the block sub-matrix</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unroll</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; BLOCK_SIZE; ++k) {</span><br><span class="line">            Csub += As[ty][k] * Bs[k][tx];</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Synchronize to make sure that the preceding</span></span><br><span class="line">        <span class="comment">// computation is done before loading two new</span></span><br><span class="line">        <span class="comment">// sub-matrices of A and B in the next iteration</span></span><br><span class="line">        __syncthreads();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write the block sub-matrix to device memory;</span></span><br><span class="line">    <span class="comment">// each thread writes one element</span></span><br><span class="line">    <span class="type">int</span> c               = wB * BLOCK_SIZE * by + BLOCK_SIZE * bx;</span><br><span class="line">    C[c + wB * ty + tx] = Csub;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/02/concurrency/%E4%BA%BA%E4%BA%BA%E9%83%BD%E7%9C%8B%E5%BE%97%E6%87%82%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/02/concurrency/%E4%BA%BA%E4%BA%BA%E9%83%BD%E7%9C%8B%E5%BE%97%E6%87%82%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">äººäººéƒ½çœ‹å¾—æ‡‚çš„å†…å­˜æ¨¡å‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-02 11:10:13" itemprop="dateCreated datePublished" datetime="2025-09-02T11:10:13+00:00">2025-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:06:21" itemprop="dateModified" datetime="2025-09-18T13:06:21+00:00">2025-09-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><p>å†…å­˜æ¨¡å‹ï¼ˆMemory Modelï¼‰æ˜¯å®šä¹‰<strong>æ•°æ®ä¸€è‡´æ€§</strong>ä¸<strong>æ‰§è¡Œé¡ºåº</strong>è§„åˆ™çš„ä¸€ç»„è§„èŒƒã€‚</p>
<p>å…³é”®æ¦‚å¿µï¼š</p>
<ol>
<li>åŸå­æ€§ï¼šæ“ä½œä¸å¯æ‰“æ–­ï¼›å¦‚æœåŒæ—¶ä¿®æ”¹ï¼Œç¡¬ä»¶ä¼šä¸²è¡Œæ’é˜Ÿã€‚</li>
<li>å¯è§æ€§ï¼šå¯¹å…¶ä»–æ ¸å¿ƒï¼ˆå³<strong>å…¶ä»–çº¿ç¨‹</strong>ï¼‰å¯è§ï¼Œä¹Ÿå°±æ˜¯ load æŒ‡ä»¤å¯ä»¥è¯»åˆ°æœ€æ–°å€¼ã€‚</li>
<li>é¡ºåºæ€§ï¼šç¦æ­¢<strong>æœ¬çº¿ç¨‹</strong>å†…çš„æŒ‡ä»¤é‡æ’åºã€‚æ‰€ä»¥å¯ä»¥ç”¨ä½œåŒæ­¥ç‚¹ã€‚</li>
</ol>
<p>æ‰€æœ‰åŸå­å˜é‡éƒ½æ»¡è¶³åŸå­æ€§ã€‚ä½†æ˜¯å…¶ä»–ä¸¤è€…ä¸ä¸€å®šæ»¡è¶³ï¼Œç”±å†…å­˜åºå®šä¹‰ã€‚</p>
<p>æ¯”å¦‚åŸå­è‡ªå¢ fetch_add(relaxed) æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯æ— æ³•ä½¿ç”¨ load æŒ‡ä»¤è¯»åˆ°æœ€æ–°çš„ç»“æœã€‚</p>
<h2 id="ç¼“å­˜ä¸€è‡´æ€§åè®®-MESI"><a href="#ç¼“å­˜ä¸€è‡´æ€§åè®®-MESI" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§åè®® (MESI)"></a>ç¼“å­˜ä¸€è‡´æ€§åè®® (MESI)</h2><table>
<thead>
<tr>
<th align="center">çŠ¶æ€</th>
<th align="center">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="center">M (Modified)</td>
<td align="center">ç¼“å­˜è¡Œå·²è¢«ä¿®æ”¹ï¼Œåªæœ‰å½“å‰ CPU æ‹¥æœ‰ï¼Œä¸»å†…å­˜æœªæ›´æ–°</td>
</tr>
<tr>
<td align="center">E (Exclusive)</td>
<td align="center">ç¼“å­˜è¡Œæœªè¢«ä¿®æ”¹ï¼Œåªæœ‰å½“å‰ CPU æ‹¥æœ‰ï¼Œä¸ä¸»å†…å­˜ä¸€è‡´</td>
</tr>
<tr>
<td align="center">S (Shared)</td>
<td align="center">ç¼“å­˜è¡Œæœªè¢«ä¿®æ”¹ï¼Œå¤šä¸ª CPU æ‹¥æœ‰ï¼Œä¸ä¸»å†…å­˜ä¸€è‡´</td>
</tr>
<tr>
<td align="center">I (Invalid)</td>
<td align="center">ç¼“å­˜è¡Œæ— æ•ˆï¼Œå¿…é¡»é‡æ–°ä»ä¸»å†…å­˜åŠ è½½</td>
</tr>
</tbody></table>
<h2 id="relaxed-å†…å­˜åº"><a href="#relaxed-å†…å­˜åº" class="headerlink" title="relaxed å†…å­˜åº"></a>relaxed å†…å­˜åº</h2><p>æœ¯è¯­ï¼š</p>
<ol>
<li>ä¿è¯åŸå­æ€§ï¼šæ•´ä¸ªæ“ä½œä¸å¯è¢«æ‰“æ–­ï¼›ä¸ä¸€å®šç«‹å³å›å†™ä¸»å†…å­˜ï¼Œå¯èƒ½æš‚æ—¶æŠŠç»“æœæ”¾åœ¨ Store Buffer ä¸­ã€‚</li>
<li>ä¸ä¿è¯é¡ºåºï¼šç¼–è¯‘å™¨å’ŒCPUå¯èƒ½å¯¹æŒ‡ä»¤é‡æ’åºã€‚</li>
<li>ä¸ä¿è¯å¯è§æ€§ï¼šå…¶ä»–æ ¸å¿ƒä¸ä¸€å®šç«‹å³å¯è§ã€‚</li>
</ol>
<p>è¯´äººè¯ï¼š</p>
<ol>
<li>åŸå­æ€§ï¼šåŸå­æ“ä½œæ˜¯ä¸²è¡Œçš„ï¼ˆç”±ç¡¬ä»¶æ’é˜Ÿï¼‰</li>
<li>ä¸ä¿è¯å¯è§æ€§ï¼š<ul>
<li>load æ“ä½œæ˜¯å¹¶è¡Œçš„ï¼Œå¹¶ä¸”ä¸ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ã€‚</li>
<li>â€œå¯è§æ€§â€æ˜¯é’ˆå¯¹ç¨‹åºå‘˜çš„ï¼Œå› ä¸ºå¯¹äº relaxed ï¼Œæ²¡æœ‰ä»»ä½•æŒ‡ä»¤å¯ä»¥ä¿è¯ load æ‹¿åˆ°æœ€æ–°å€¼ã€‚å®ƒå¯èƒ½ç›´æ¥ä»è‡ªå·±çš„ç¼“å­˜è¡Œä¸­æŠŠæ—§å€¼è¿”å›ç»™ä½ ã€‚</li>
<li>ç¡¬ä»¶æœ¬èº«æ˜¯çŸ¥é“æœ€æ–°å€¼çš„ï¼Œå®ƒä¼šæ ¹æ® MESI æ¥ä¿è¯è‡ªå·±å½“æ—¶æ‹¿åˆ°çš„æ˜¯æœ€æ–°å€¼ï¼ˆä½†æ˜¯æ— æ³•é€šè¿‡æŒ‡ä»¤å‘ŠçŸ¥ä½ ï¼‰ã€‚</li>
</ul>
</li>
<li>ä¸ä¿è¯é¡ºåºï¼šä¸æ˜¯åŒæ­¥ç‚¹ï¼Œæ— æ³•ä¿è¯å‰åæŒ‡ä»¤ä¸ç¨‹åºå‘˜çš„ç¼–å†™é¡ºåºä¸€è‡´ã€‚</li>
</ol>
<table>
<thead>
<tr>
<th align="center">å±‚çº§</th>
<th align="center">æœºåˆ¶</th>
<th align="center">ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">æŒ‡ä»¤çº§</td>
<td align="center">åŸå­æŒ‡ä»¤ï¼ˆå¦‚ LOCK XADDï¼‰</td>
<td align="center">ä¿è¯æ“ä½œä¸å¯æ‰“æ–­</td>
</tr>
<tr>
<td align="center">ç¼“å­˜çº§</td>
<td align="center">MESI åè®®</td>
<td align="center">æ§åˆ¶ç¼“å­˜è¡Œè®¿é—®ï¼Œé¿å…å†²çª</td>
</tr>
<tr>
<td align="center">ç¼–è¯‘å™¨çº§</td>
<td align="center">ç¼–è¯‘å™¨å±éšœ</td>
<td align="center">é˜²æ­¢æŒ‡ä»¤é‡æ’</td>
</tr>
<tr>
<td align="center">CPUçº§</td>
<td align="center">å†…å­˜å±éšœ</td>
<td align="center">ä¿è¯æ‰§è¡Œé¡ºåº</td>
</tr>
<tr>
<td align="center">é«˜çº§æœºåˆ¶</td>
<td align="center">äº‹åŠ¡æ€§å†…å­˜</td>
<td align="center">å®ç°å¤æ‚åŸå­é€»è¾‘ï¼ˆå¯é€‰ï¼‰</td>
</tr>
</tbody></table>
<h2 id="release-acquire-è¯­ä¹‰"><a href="#release-acquire-è¯­ä¹‰" class="headerlink" title="release-acquire è¯­ä¹‰"></a>release-acquire è¯­ä¹‰</h2><h2 id="æŒ‡ä»¤é‡æ’åº"><a href="#æŒ‡ä»¤é‡æ’åº" class="headerlink" title="æŒ‡ä»¤é‡æ’åº"></a>æŒ‡ä»¤é‡æ’åº</h2><ol>
<li>ç¼–è¯‘å™¨æŒ‡ä»¤é‡æ’ï¼šç¼–è¯‘å™¨å±éšœé˜²æ­¢æŒ‡ä»¤é‡æ’</li>
<li>CPU ä¹±åºæ‰§è¡Œï¼šå†…å­˜å±éšœä¿è¯æ‰§è¡Œé¡ºåºã€‚</li>
</ol>
<h2 id="åŸå­æŒ‡ä»¤"><a href="#åŸå­æŒ‡ä»¤" class="headerlink" title="åŸå­æŒ‡ä»¤"></a>åŸå­æŒ‡ä»¤</h2><p>åŸå­æŒ‡ä»¤ï¼ˆå¦‚ LOCK XADDï¼‰ï¼šä¿è¯æ“ä½œä¸å¯æ‰“æ–­</p>
<h2 id="Load-Store-Buffer"><a href="#Load-Store-Buffer" class="headerlink" title="Load &#x2F; Store Buffer"></a>Load &#x2F; Store Buffer</h2><h2 id="ç¼“å­˜è¡Œ"><a href="#ç¼“å­˜è¡Œ" class="headerlink" title="ç¼“å­˜è¡Œ"></a>ç¼“å­˜è¡Œ</h2><h2 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/11/">11</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bi-an"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">bi-an</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">105</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bi-an" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;bi-an" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ah_zzg@126.com" title="E-Mail â†’ mailto:ah_zzg@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://cuda-doc.readthedocs.io/" title="https:&#x2F;&#x2F;cuda-doc.readthedocs.io" rel="noopener" target="_blank">CUDAä¸­æ–‡æ‰‹å†Œ</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://infiniband-doc.readthedocs.io/" title="https:&#x2F;&#x2F;infiniband-doc.readthedocs.io&#x2F;" rel="noopener" target="_blank">InfiniBandä¸­æ–‡æ‰‹å†Œ</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bi-an</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

</body>
</html>
