<!DOCTYPE html>
<html lang="en, zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bi-an.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:url" content="https://bi-an.github.io/blog/index.html">
<meta property="og:site_name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:locale">
<meta property="article:author" content="bi-an">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bi-an.github.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en, zh_CN'
  };
</script>

  <title>æ±Ÿå—äººç‰©çš„åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æ±Ÿå—äººç‰©çš„åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/blog/resources/" rel="section"><i class="fa fa-paperclip fa-fw"></i>Resource</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/16/os/%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/16/os/%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81/" class="post-title-link" itemprop="url">ç”¨æˆ·æ€å’Œå†…æ ¸æ€</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-08-16 13:31:26 / Modified: 05:56:33" itemprop="dateCreated datePublished" datetime="2025-08-16T13:31:26+00:00">2025-08-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ˜¯éš”ç¦»çš„"><a href="#ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ˜¯éš”ç¦»çš„" class="headerlink" title="ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ˜¯éš”ç¦»çš„"></a>ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ˜¯éš”ç¦»çš„</h2><p>åˆ‡æ¢å†…æ ¸æ€å’Œç”¨æˆ·æ€ä¸ºä»€ä¹ˆè¦å†…å­˜å¤åˆ¶ï¼Ÿ</p>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>å®‰å…¨æ€§</td>
<td>ç”¨æˆ·ç¨‹åºå¯èƒ½ä¼ å…¥éæ³•åœ°å€ï¼Œå¯¼è‡´å†…æ ¸å´©æºƒæˆ–è¢«åˆ©ç”¨æ”»å‡»</td>
</tr>
<tr>
<td>ç¨³å®šæ€§</td>
<td>ç”¨æˆ·ç¨‹åºå¯èƒ½åœ¨ <code>poll()</code> è¿”å›å‰ä¿®æ”¹æ•°ç»„ï¼Œå¯¼è‡´å†…æ ¸è¯»å–ä¸ä¸€è‡´</td>
</tr>
<tr>
<td>å†…å­˜ç®¡ç†</td>
<td>ç”¨æˆ·ç©ºé—´å†…å­˜å¯èƒ½è¢« swap å‡ºæˆ–è€…é‡Šæ”¾ï¼Œå†…æ ¸æ— æ³•ä¿è¯è®¿é—®æœ‰æ•ˆ</td>
</tr>
</tbody></table>
<h2 id="å†…æ ¸æ€"><a href="#å†…æ ¸æ€" class="headerlink" title="å†…æ ¸æ€"></a>å†…æ ¸æ€</h2><p>æˆ‘ä»¬åœ¨è¯´â€œåˆ‡æ¢åˆ°å†…æ ¸æ€â€æ—¶ï¼Œå…¶å®æŒ‡çš„æ˜¯ CPU ç‰¹æƒçº§åˆ«ä»ç”¨æˆ·æ€ï¼ˆring3ï¼‰åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼ˆring0ï¼‰ çš„è¿‡ç¨‹ã€‚</p>
<p>ç”¨æˆ·æ€ vs å†…æ ¸æ€</p>
<p>ç”¨æˆ·æ€ï¼ˆuser modeï¼‰</p>
<p>åº”ç”¨ç¨‹åºï¼ˆæ¯”å¦‚ä½ å†™çš„ C++ ç¨‹åºï¼‰è¿è¡Œçš„ç¯å¢ƒã€‚</p>
<p>æƒé™å—é™ï¼Œä¸èƒ½ç›´æ¥æ“ä½œç¡¬ä»¶ï¼ˆå¦‚ç£ç›˜ã€ç½‘å¡ï¼‰ï¼Œä¹Ÿä¸èƒ½éšä¾¿è®¿é—®å†…æ ¸å†…å­˜ã€‚</p>
<p>åªèƒ½é€šè¿‡ ç³»ç»Ÿè°ƒç”¨ (syscall) å‘å†…æ ¸è¯·æ±‚æœåŠ¡ã€‚</p>
<p>å†…æ ¸æ€ï¼ˆkernel modeï¼‰</p>
<p>æ“ä½œç³»ç»Ÿå†…æ ¸è¿è¡Œçš„ç¯å¢ƒã€‚</p>
<p>æ‹¥æœ‰æœ€é«˜æƒé™ï¼ˆring0ï¼‰ï¼Œå¯ä»¥æ“ä½œ CPU æŒ‡ä»¤é›†ã€å†…å­˜ç®¡ç†ã€é©±åŠ¨ã€ç¡¬ä»¶å¯„å­˜å™¨ã€‚</p>
<p>ç³»ç»Ÿè°ƒç”¨çš„å®ç°ä»£ç å°±åœ¨å†…æ ¸æ€é‡Œã€‚</p>
<p>â€œåˆ‡æ¢åˆ°å†…æ ¸æ€â€çš„è¿‡ç¨‹</p>
<p>å½“ä½ è°ƒç”¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæ¯”å¦‚ï¼š</p>
<p>read(fd, buf, size);</p>
<p>ä½ çš„ç¨‹åºåœ¨ ç”¨æˆ·æ€ï¼Œè°ƒç”¨ read()ã€‚</p>
<p>å®é™…ä¸Š read() ä¼šè§¦å‘ä¸€æ¡ç‰¹æ®ŠæŒ‡ä»¤ï¼ˆä¾‹å¦‚ Linux x86-64 ç”¨ syscall æŒ‡ä»¤ï¼‰ã€‚</p>
<p>CPU æ•æ‰åˆ°è¿™ä¸ªæŒ‡ä»¤ï¼Œè‡ªåŠ¨ï¼š</p>
<p>ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ã€‚</p>
<p>åˆ‡æ¢åˆ°å†…æ ¸æ ˆã€‚</p>
<p>ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨ä¸Šä¸‹æ–‡ã€‚</p>
<p>è·³åˆ°ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°ï¼ˆæ¯”å¦‚ sys_readï¼‰ã€‚</p>
<p>å†…æ ¸æ€ä»£ç æ‰§è¡Œ sys_readï¼Œæ¯”å¦‚è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€æ£€æŸ¥ socket bufferã€‚</p>
<p>å¤„ç†å®Œåè¿”å›ï¼ŒCPU å†åˆ‡å›ç”¨æˆ·æ€ï¼Œæ¢å¤ä¸Šä¸‹æ–‡ï¼Œç»§ç»­æ‰§è¡Œåº”ç”¨ä»£ç ã€‚</p>
<p>ğŸ”¹ ä¸ºä»€ä¹ˆè¦åŒºåˆ†ç”¨æˆ·æ€&#x2F;å†…æ ¸æ€ï¼Ÿ</p>
<p>å®‰å…¨ï¼šç”¨æˆ·ç¨‹åºä¸èƒ½ç›´æ¥æ“ä½œç¡¬ä»¶ã€‚</p>
<p>ç¨³å®šæ€§ï¼šå³ä½¿ç”¨æˆ·ç¨‹åºå´©æºƒï¼Œå†…æ ¸å’Œå…¶ä»–è¿›ç¨‹ä¸ä¼šå—å½±å“ã€‚</p>
<p>æ€§èƒ½éš”ç¦»ï¼šå†…æ ¸æä¾›æŠ½è±¡ï¼ˆç³»ç»Ÿè°ƒç”¨æ¥å£ï¼‰ï¼Œé¿å…åº”ç”¨ç›´æ¥å¹²æ‰°åº•å±‚èµ„æºã€‚</p>
<p>âœ… æ‰€ä»¥ï¼Œæ€»ç»“ä¸€å¥ï¼š<br>â€œåˆ‡æ¢åˆ°å†…æ ¸æ€â€å°±æ˜¯ CPU ä»è¿è¡Œæ™®é€šç”¨æˆ·ä»£ç ï¼ˆæƒé™å—é™ï¼‰åˆ‡æ¢åˆ°æ‰§è¡Œå†…æ ¸ä»£ç ï¼ˆæœ€é«˜æƒé™ï¼‰çš„è¿‡ç¨‹ï¼Œå¸¸å¸¸å‘ç”Ÿåœ¨ç³»ç»Ÿè°ƒç”¨ã€å¼‚å¸¸ã€ç¡¬ä»¶ä¸­æ–­æ—¶ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/16/cpp/C++%E5%8F%B3%E5%80%BC%E5%BC%95%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/16/cpp/C++%E5%8F%B3%E5%80%BC%E5%BC%95%E7%94%A8/" class="post-title-link" itemprop="url">C++å³å€¼å¼•ç”¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-08-16 10:54:08 / Modified: 05:56:33" itemprop="dateCreated datePublished" datetime="2025-08-16T10:54:08+00:00">2025-08-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-å·¦å€¼ã€å°†äº¡å€¼ã€çº¯å³å€¼"><a href="#1-å·¦å€¼ã€å°†äº¡å€¼ã€çº¯å³å€¼" class="headerlink" title="1. å·¦å€¼ã€å°†äº¡å€¼ã€çº¯å³å€¼"></a>1. å·¦å€¼ã€å°†äº¡å€¼ã€çº¯å³å€¼</h2><p>C++11çš„å€¼å¿…å®šå±äºï¼šå·¦å€¼ã€å³å€¼ï¼ˆå°†äº¡å€¼ã€çº¯å³å€¼ï¼‰ä¸‰è€…ä¹‹ä¸€ã€‚ä¸æ˜¯å·¦å€¼å°±æ˜¯å³å€¼ã€‚è¯¦è§å€¼ç±»åˆ«ã€‚</p>
<ul>
<li><strong>å·¦å€¼</strong>çš„ç‰¹ç‚¹ï¼šâ€œæœ‰åå­—ã€å¯ä»¥å–å€â€ã€‚æ²¡æœ‰åå­—æˆ–è€…ä¸èƒ½å–å€ï¼Œåˆ™å¿…å®šæ˜¯å³å€¼ã€‚</li>
<li><strong>å³å€¼</strong>çš„ç‰¹ç‚¹ï¼šå³å°†æ¶ˆäº¡ï¼Œä¹Ÿå°±æ˜¯è¯´â€œä¼šè¢«ææ„â€ã€‚<ul>
<li><strong>çº¯å³å€¼</strong>ï¼šä¸€å®šæ²¡æœ‰åå­—ã€‚æ¯”å¦‚é™¤å»<code>string</code>ä¹‹å¤–å­—é¢å€¼å¸¸é‡ã€å‡½æ•°è¿”å›å€¼ã€è¿ç®—è¡¨è¾¾å¼ã€‚</li>
<li><strong>å°†äº¡å€¼</strong>ï¼šå³å°†æ¶ˆäº¡çš„å€¼ï¼šæ¯”å¦‚ä¸´æ—¶å˜é‡ï¼Œä¸€æ—¦ç¦»å¼€ä½œç”¨åŸŸå°±ä¼šè¢«é”€æ¯ï¼›å¯èƒ½æ²¡æœ‰åå­—ï¼Œä¾‹å¦‚å‡½æ•°çš„è¿”å›å€¼ï¼ˆéå¼•ç”¨ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">A</span>(); <span class="comment">// åŒ¿åå¯¹è±¡çš„ä½œç”¨åŸŸä»…é™äºè¯­å¥ä¸­ï¼Œä¸€æ—¦ç¦»å¼€å½“å‰è¯­å¥ï¼Œå°±ä¼šææ„ã€‚</span></span><br><span class="line">    <span class="built_in">getchar</span>(); <span class="comment">// æš‚åœ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-å¼•ç”¨ã€å³å€¼å¼•ç”¨"><a href="#2-å¼•ç”¨ã€å³å€¼å¼•ç”¨" class="headerlink" title="2. å¼•ç”¨ã€å³å€¼å¼•ç”¨"></a>2. å¼•ç”¨ã€å³å€¼å¼•ç”¨</h2><p>å³å€¼å¼•ç”¨æ¶‰åŠâ€œå³å€¼â€å’Œâ€œå¼•ç”¨â€ä¸¤ä¸ªæ¦‚å¿µã€‚</p>
<ul>
<li><strong>å¼•ç”¨</strong>ä¸æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥å®šä¹‰ä¸€ä¸ªâ€œå³å€¼å¼•ç”¨â€ä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œé¿å…äº†å¤šä½™çš„æ„é€ è¿‡ç¨‹ã€‚</li>
<li><strong>å³å€¼</strong>æ˜¯å³å°†ææ„çš„å€¼ï¼ŒæŠŠå³å€¼ç»‘å®šåˆ°å³å€¼å¼•ç”¨ä¸Šï¼Œå»¶é•¿äº†å³å€¼çš„ç”Ÿå‘½æœŸï¼Œæ‰€ä»¥å³å€¼å¯¹è±¡æ²¡æœ‰ææ„ã€‚</li>
</ul>
<h3 id="å³å€¼å¼•ç”¨è§„åˆ™ï¼š"><a href="#å³å€¼å¼•ç”¨è§„åˆ™ï¼š" class="headerlink" title="å³å€¼å¼•ç”¨è§„åˆ™ï¼š"></a>å³å€¼å¼•ç”¨è§„åˆ™ï¼š</h3><ul>
<li>å¯ä»¥æŠŠå·¦å€¼ç»‘å®šåˆ°å·¦å€¼å¼•ç”¨ã€‚</li>
<li>å¯ä»¥æŠŠå³å€¼ç»‘å®šåˆ°å³å€¼å¼•ç”¨ã€‚</li>
<li>ä¸å…è®¸æŠŠå·¦å€¼ç»‘å®šåˆ°å³å€¼å¼•ç”¨ã€‚</li>
<li>ä¸å…è®¸æŠŠå³å€¼ç»‘å®šåˆ°å·¦å€¼å¼•ç”¨ã€‚</li>
<li><code>const</code>å·¦å€¼å¼•ç”¨å¯ä»¥æ¥å—å·¦å€¼æˆ–å³å€¼ã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a1 = <span class="number">10</span>; <span class="comment">// 10æ˜¯çº¯å³å€¼</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; aa = <span class="number">10</span>; <span class="comment">// å¸¸é‡å¼•ç”¨å¯ä»¥æ¥å—å³å€¼</span></span><br><span class="line"><span class="type">int</span>&amp;&amp; aaa = <span class="number">10</span>; <span class="comment">// å³å€¼å¼•ç”¨æ¥å—å³å€¼</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-å¼•ç”¨å’Œå³å€¼å¼•ç”¨æ˜¯å·¦å€¼"><a href="#3-å¼•ç”¨å’Œå³å€¼å¼•ç”¨æ˜¯å·¦å€¼" class="headerlink" title="3. å¼•ç”¨å’Œå³å€¼å¼•ç”¨æ˜¯å·¦å€¼"></a>3. å¼•ç”¨å’Œå³å€¼å¼•ç”¨æ˜¯å·¦å€¼</h2><p>å¼•ç”¨ï¼ˆåŒ…æ‹¬å³å€¼å¼•ç”¨ï¼‰æœ¬èº«æ˜¯å·¦å€¼ï¼Œå¯ä»¥å–å€ï¼Œä½†ä¸èƒ½å¯¹å³å€¼å–å€ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun1</span><span class="params">(<span class="type">int</span>&amp; t)</span> </span>&#123; <span class="comment">// æ¥å—ä¸€ä¸ªå·¦å€¼å‚æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun2</span><span class="params">(<span class="type">int</span>&amp;&amp; t)</span> </span>&#123; <span class="comment">// æ¥å—ä¸€ä¸ªå³å€¼å‚æ•°ï¼Œä½†tæœ¬èº«æ˜¯å·¦å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="type">int</span>&amp;&amp; ra = <span class="built_in">move</span>(a); <span class="comment">// move(a)è¿”å›ä¸€ä¸ªå³å€¼ï¼Œraå´æ˜¯ä¸€ä¸ªå·¦å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fun1</span>(ra); <span class="comment">// æ­£ç¡®ï¼šraæ˜¯å·¦å€¼ï¼Œå¯ä»¥ç»‘å®šåˆ°å·¦å€¼å¼•ç”¨</span></span><br><span class="line">    <span class="built_in">fun2</span>(<span class="built_in">move</span>(a)); <span class="comment">// æ­£ç¡®ï¼šmove(a)è¿”å›ä¸€ä¸ªå³å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-å¤åˆ¶æ„é€ å‡½æ•°å’Œç§»åŠ¨æ„é€ å‡½æ•°"><a href="#4-å¤åˆ¶æ„é€ å‡½æ•°å’Œç§»åŠ¨æ„é€ å‡½æ•°" class="headerlink" title="4. å¤åˆ¶æ„é€ å‡½æ•°å’Œç§»åŠ¨æ„é€ å‡½æ•°"></a>4. å¤åˆ¶æ„é€ å‡½æ•°å’Œç§»åŠ¨æ„é€ å‡½æ•°</h2><h3 id="ä¸ºä»€ä¹ˆå³å€¼å¼•ç”¨çš„æ„é€ å‡½æ•°è¢«è§†ä¸ºâ€œç§»åŠ¨â€è¯­ä¹‰ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå³å€¼å¼•ç”¨çš„æ„é€ å‡½æ•°è¢«è§†ä¸ºâ€œç§»åŠ¨â€è¯­ä¹‰ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå³å€¼å¼•ç”¨çš„æ„é€ å‡½æ•°è¢«è§†ä¸ºâ€œç§»åŠ¨â€è¯­ä¹‰ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå³å€¼å¼•ç”¨çš„æ„é€ å‡½æ•°è¢«è§†ä¸ºâ€œç§»åŠ¨â€è¯­ä¹‰ï¼Ÿ</h3><p>å› ä¸ºè¾“å…¥å‚æ•°æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼ˆå³å€¼å¼•ç”¨ä¹Ÿæ˜¯å¼•ç”¨ï¼‰ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æ‰€å¼•å¯¹è±¡çš„èµ„æºå¹¶æ¥ç®¡å®ƒï¼ŒåŒæ—¶å°†æºå¯¹è±¡çš„èµ„æºç½®ç©ºã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> A&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(const A&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(A&amp;&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(A&amp;&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    <span class="function">A <span class="title">b</span><span class="params">(std::move(a))</span></span>; <span class="comment">// è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-å®Œç¾è½¬å‘"><a href="#5-å®Œç¾è½¬å‘" class="headerlink" title="5. å®Œç¾è½¬å‘"></a>5. å®Œç¾è½¬å‘</h2><p>å®Œç¾è½¬å‘æ˜¯æŒ‡å¯¹æ¨¡æ¿å‚æ•°å®ç°å®Œç¾è½¬å‘ï¼šå³è¾“å…¥ä»€ä¹ˆç±»å‹ï¼ˆå·¦å€¼ã€å³å€¼ï¼‰çš„å‚æ•°ï¼Œå°±æ˜¯ä»€ä¹ˆç±»å‹çš„å‚æ•°ã€‚</p>
<h3 id="å¼•ç”¨æŠ˜å è§„åˆ™ï¼š"><a href="#å¼•ç”¨æŠ˜å è§„åˆ™ï¼š" class="headerlink" title="å¼•ç”¨æŠ˜å è§„åˆ™ï¼š"></a>å¼•ç”¨æŠ˜å è§„åˆ™ï¼š</h3><ul>
<li>å¦‚æœæœ‰å·¦å€¼å¼•ç”¨ï¼Œä¼˜å…ˆæŠ˜å æˆå·¦å€¼å¼•ç”¨ã€‚</li>
<li>å¦‚æœåªæœ‰å³å€¼å¼•ç”¨ï¼Œå‚æ•°æ¨å¯¼æˆå³å€¼å¼•ç”¨ã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RunCode</span><span class="params">(<span class="type">int</span>&amp; m)</span> </span>&#123; cout &lt;&lt; <span class="string">&quot;lvalue ref&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RunCode</span><span class="params">(<span class="type">int</span>&amp;&amp; m)</span> </span>&#123; cout &lt;&lt; <span class="string">&quot;rvalue ref&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PerfectForward</span><span class="params">(T&amp;&amp; t)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">RunCode</span>(<span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(t)); <span class="comment">// ä¿è¯å®Œç¾è½¬å‘</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">PerfectForward</span>(a); <span class="comment">// lvalue ref</span></span><br><span class="line">    <span class="built_in">PerfectForward</span>(<span class="built_in">move</span>(a)); <span class="comment">// rvalue ref</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-ç§»åŠ¨æ„é€ å‡½æ•°ã€ç§»åŠ¨èµ‹å€¼å‡½æ•°ã€å¤åˆ¶æ„é€ å‡½æ•°ã€å¤åˆ¶èµ‹å€¼å‡½æ•°"><a href="#6-ç§»åŠ¨æ„é€ å‡½æ•°ã€ç§»åŠ¨èµ‹å€¼å‡½æ•°ã€å¤åˆ¶æ„é€ å‡½æ•°ã€å¤åˆ¶èµ‹å€¼å‡½æ•°" class="headerlink" title="6. ç§»åŠ¨æ„é€ å‡½æ•°ã€ç§»åŠ¨èµ‹å€¼å‡½æ•°ã€å¤åˆ¶æ„é€ å‡½æ•°ã€å¤åˆ¶èµ‹å€¼å‡½æ•°"></a>6. ç§»åŠ¨æ„é€ å‡½æ•°ã€ç§»åŠ¨èµ‹å€¼å‡½æ•°ã€å¤åˆ¶æ„é€ å‡½æ•°ã€å¤åˆ¶èµ‹å€¼å‡½æ•°</h2><h3 id="ç§»åŠ¨æ„é€ å‡½æ•°çš„æ³¨æ„äº‹é¡¹ï¼š"><a href="#ç§»åŠ¨æ„é€ å‡½æ•°çš„æ³¨æ„äº‹é¡¹ï¼š" class="headerlink" title="ç§»åŠ¨æ„é€ å‡½æ•°çš„æ³¨æ„äº‹é¡¹ï¼š"></a>ç§»åŠ¨æ„é€ å‡½æ•°çš„æ³¨æ„äº‹é¡¹ï¼š</h3><ul>
<li>ç§»åŠ¨æ„é€ å‡½æ•°ä¸å…è®¸æŠ›å‡ºå¼‚å¸¸ï¼Œå»ºè®®æ·»åŠ <code>noexcept</code>å…³é”®å­—ã€‚</li>
<li>ä½¿ç”¨<code>std::move_if_noexcept</code>å¯ä»¥åœ¨ç§»åŠ¨æ„é€ å‡½æ•°æŠ›å‡ºå¼‚å¸¸æ—¶å›é€€åˆ°å¤åˆ¶æ„é€ å‡½æ•°ã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> A&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(const A&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(A&amp;&amp;) <span class="keyword">noexcept</span> &#123; cout &lt;&lt; <span class="string">&quot;A(A&amp;&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    <span class="function">A <span class="title">b</span><span class="params">(std::move(a))</span></span>; <span class="comment">// è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-ç¼–è¯‘å™¨ä¼˜åŒ–"><a href="#7-ç¼–è¯‘å™¨ä¼˜åŒ–" class="headerlink" title="7. ç¼–è¯‘å™¨ä¼˜åŒ–"></a>7. ç¼–è¯‘å™¨ä¼˜åŒ–</h2><p>ç¼–è¯‘å™¨é»˜è®¤ä¼šé‡‡ç”¨â€œè¿”å›å€¼ä¼˜åŒ–â€ï¼ˆRVOæˆ–NRVOï¼‰ã€‚è¦è§‚å¯Ÿç§»åŠ¨è¯­ä¹‰ä¸å¤åˆ¶è¯­ä¹‰çš„ä¸åŒï¼Œåº”è¯¥å…³é—­ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚</p>
<p>å…³é—­ä¼˜åŒ–å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -o <span class="built_in">test</span> main.cc -fno-elide-constructors</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-åˆæˆçš„ç§»åŠ¨æ“ä½œ"><a href="#8-åˆæˆçš„ç§»åŠ¨æ“ä½œ" class="headerlink" title="8. åˆæˆçš„ç§»åŠ¨æ“ä½œ"></a>8. åˆæˆçš„ç§»åŠ¨æ“ä½œ</h2><p>å¦‚æœæ²¡æœ‰å®šä¹‰å¤åˆ¶æ„é€ &#x2F;èµ‹å€¼å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šä¸ºæˆ‘ä»¬åˆæˆï¼ˆæµ…å¤åˆ¶ï¼‰ã€‚ä½†å¦‚æœè‡ªå®šä¹‰äº†å¤åˆ¶æ„é€ å‡½æ•°ã€å¤åˆ¶èµ‹å€¼è¿ç®—ç¬¦æˆ–ææ„å‡½æ•°ï¼Œç¼–è¯‘å™¨å°†ä¸ä¼šåˆæˆç§»åŠ¨æ„é€ &#x2F;èµ‹å€¼å‡½æ•°ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123; cout &lt;&lt; <span class="string">&quot;A()&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> A&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(const A&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">    <span class="built_in">A</span>(A&amp;&amp;) &#123; cout &lt;&lt; <span class="string">&quot;A(A&amp;&amp;)&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    <span class="function">A <span class="title">b</span><span class="params">(std::move(a))</span></span>; <span class="comment">// è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-std-moveçš„å®ç°"><a href="#9-std-moveçš„å®ç°" class="headerlink" title="9. std::moveçš„å®ç°"></a>9. <code>std::move</code>çš„å®ç°</h2><p><code>std::move</code>æ˜¯ä¸€ä¸ªç±»å‹è½¬æ¢ï¼Œæ²¡æœ‰å®Œæˆå…¶ä»–å·¥ä½œã€‚</p>
<p>å®ç°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">typename</span> std::remove_reference&lt;T&gt;::<span class="function">type&amp;&amp; <span class="title">move</span><span class="params">(T&amp;&amp; t)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> std::remove_reference&lt;T&gt;::type&amp;&amp;&gt;(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-unique-pträ¸std-move"><a href="#10-unique-pträ¸std-move" class="headerlink" title="10. unique_pträ¸std::move"></a>10. <code>unique_ptr</code>ä¸<code>std::move</code></h2><p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">up</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">    unique_ptr&lt;<span class="type">int</span>&gt; p = std::<span class="built_in">move</span>(up); <span class="comment">// ç°åœ¨upä¸ºç©º</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£é‡Šï¼š<code>std::move</code>è°ƒç”¨<code>unique_ptr</code>çš„ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œè½¬ç§»<code>up</code>æ‰€æ‹¥æœ‰çš„èµ„æºï¼Œå¹¶å°†<code>up</code>ç½®ä¸ºç©ºã€‚</p>
<hr>
<h2 id="11-å³å€¼ä¸sizeof"><a href="#11-å³å€¼ä¸sizeof" class="headerlink" title="11. å³å€¼ä¸sizeof"></a>11. å³å€¼ä¸<code>sizeof</code></h2><p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="type">int</span> x, y;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(<span class="built_in">int</span>()) &lt;&lt; endl; <span class="comment">// 1</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(<span class="number">10</span>) &lt;&lt; endl; <span class="comment">// 4</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(A) &lt;&lt; endl; <span class="comment">// 8</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(<span class="built_in">A</span>()) &lt;&lt; endl; <span class="comment">// 1</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">sizeof</span>(<span class="built_in">f</span>()) &lt;&lt; endl; <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li>ã€Šæ·±å…¥ç†è§£C++11: C++æ–°ç‰¹æ€§è§£æä¸åº”ç”¨ã€‹</li>
<li>ã€ŠC++ Primer ç¬¬äº”ç‰ˆã€‹</li>
<li>C++ä¸­æ–‡ - APIå‚è€ƒæ–‡æ¡£</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/15/CUDA%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/15/CUDA%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">CUDAå®æˆ˜</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-15 22:21:16" itemprop="dateCreated datePublished" datetime="2025-08-15T22:21:16+00:00">2025-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>ç›´æ¥å°†ä»¥å‰çš„æ–‡æ¡£æ¬è¿‡æ¥ï¼š</p>
<p><a href="https://bi-an.github.io/CUDA/">https://bi-an.github.io/CUDA/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/12/Bazel%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/12/Bazel%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">Bazelå…¥é—¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-12 20:21:42" itemprop="dateCreated datePublished" datetime="2025-08-12T20:21:42+00:00">2025-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Bazelç®€ä»‹"><a href="#Bazelç®€ä»‹" class="headerlink" title="Bazelç®€ä»‹"></a>Bazelç®€ä»‹</h2><p>Bazel æ˜¯ Google å¼€å‘å¹¶å¼€æºçš„ä¸€æ¬¾æ„å»ºå·¥å…·ï¼ˆbuild systemï¼‰ï¼Œä¸»è¦ç”¨æ¥è‡ªåŠ¨åŒ–ç¼–è¯‘ã€æµ‹è¯•å’Œæ‰“åŒ…å¤§å‹è½¯ä»¶é¡¹ç›®ã€‚</p>
<ul>
<li>é«˜é€Ÿæ„å»ºï¼šç›¸å½“äºæ™ºèƒ½åŒ–çš„Make</li>
<li>å¯å¤ç°æ„å»ºï¼šé€šè¿‡ä¸¥æ ¼çš„å£°æ˜å¼ BUILD æ–‡ä»¶ï¼Œç¡®ä¿æ¯æ¬¡æ„å»ºç»“æœä¸€è‡´ã€‚</li>
<li>è·¨å¹³å°ï¼šæ”¯æŒ Linuxã€macOSã€Windows ç­‰å¤šä¸ªæ“ä½œç³»ç»Ÿã€‚</li>
<li>æ”¯æŒå¤šè¯­è¨€ï¼šä¸åªæ”¯æŒ C++ï¼Œè¿˜æ”¯æŒ Javaã€Pythonã€Goã€Shell ç­‰å¤šç§è¯­è¨€çš„é¡¹ç›®æ„å»ºã€‚</li>
</ul>
<h2 id="å®‰è£…Bazel"><a href="#å®‰è£…Bazel" class="headerlink" title="å®‰è£…Bazel"></a>å®‰è£…Bazel</h2><h3 id="æ–¹æ³•1ï¼šapt-é•œåƒæº"><a href="#æ–¹æ³•1ï¼šapt-é•œåƒæº" class="headerlink" title="æ–¹æ³•1ï¼šapt é•œåƒæº"></a>æ–¹æ³•1ï¼šapt é•œåƒæº</h3><p>æ¸…å apt é•œåƒæºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/bazel.list &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/bazel-apt stable jdk1.8</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<p>æ³¨ï¼š<code>jdk1.8</code>æ˜¯<code>https://mirrors.tuna.tsinghua.edu.cn/bazel-apt/dists/stable/</code>ä¸‹çš„ä¸€ä¸ªç›®å½•ã€‚<br>å¦‚æœæç¤ºæ‰¾ä¸åˆ°å¯¹åº”çš„è·¯å¾„ï¼Œå°±å»æŸ¥çœ‹è¯¥ç›®å½•æ˜¯å¦å­˜åœ¨ã€‚</p>
<p>å¯¼å…¥æ¸…åé•œåƒçš„ GPG keyï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor | sudo <span class="built_in">tee</span> /etc/apt/trusted.gpg.d/bazel.gpg &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>æ›´æ–°å¹¶å®‰è£…ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install bazel</span><br><span class="line">bazel --version</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹æ³•-2ï¼šç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶ï¼ˆç»•è¿‡-aptï¼‰"><a href="#æ–¹æ³•-2ï¼šç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶ï¼ˆç»•è¿‡-aptï¼‰" class="headerlink" title="æ–¹æ³• 2ï¼šç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶ï¼ˆç»•è¿‡ aptï¼‰"></a>æ–¹æ³• 2ï¼šç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶ï¼ˆç»•è¿‡ aptï¼‰</h3><p>ä» GitHub Release ä¸‹è½½ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/bazelbuild/bazel/releases/download/6.5.0/bazel-6.5.0-linux-x86_64</span><br><span class="line"><span class="built_in">chmod</span> +x bazel-6.5.0-linux-x86_64</span><br><span class="line">sudo <span class="built_in">mv</span> bazel-6.5.0-linux-x86_64 /usr/local/bin/bazel</span><br><span class="line">bazel --version</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹æ³•-3ï¼šç”¨-Bazelisk-è‡ªåŠ¨ä¸‹è½½ç‰ˆæœ¬"><a href="#æ–¹æ³•-3ï¼šç”¨-Bazelisk-è‡ªåŠ¨ä¸‹è½½ç‰ˆæœ¬" class="headerlink" title="æ–¹æ³• 3ï¼šç”¨ Bazelisk è‡ªåŠ¨ä¸‹è½½ç‰ˆæœ¬"></a>æ–¹æ³• 3ï¼šç”¨ Bazelisk è‡ªåŠ¨ä¸‹è½½ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/bazelbuild/bazelisk/releases/download/v1.21.0/bazelisk-linux-amd64</span><br><span class="line"><span class="built_in">chmod</span> +x bazelisk-linux-amd64</span><br><span class="line">sudo <span class="built_in">mv</span> bazelisk-linux-amd64 /usr/local/bin/bazel</span><br><span class="line">bazel --version</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨æ‹‰å–æ‰€éœ€ç‰ˆæœ¬ã€‚</p>
<h2 id="ä½¿ç”¨Bazel"><a href="#ä½¿ç”¨Bazel" class="headerlink" title="ä½¿ç”¨Bazel"></a>ä½¿ç”¨Bazel</h2><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>bazel build //target</code></td>
<td>æ„å»ºæŒ‡å®šç›®æ ‡</td>
</tr>
<tr>
<td><code>bazel test //target</code></td>
<td>è¿è¡ŒæŒ‡å®šæµ‹è¯•</td>
</tr>
<tr>
<td><code>bazel run //target</code></td>
<td>æ„å»ºå¹¶è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶</td>
</tr>
<tr>
<td><code>bazel clean</code></td>
<td>æ¸…ç†æ„å»ºç¼“å­˜</td>
</tr>
</tbody></table>
<h3 id="é¡¹ç›®ç»“æ„ç¤ºä¾‹"><a href="#é¡¹ç›®ç»“æ„ç¤ºä¾‹" class="headerlink" title="é¡¹ç›®ç»“æ„ç¤ºä¾‹"></a>é¡¹ç›®ç»“æ„ç¤ºä¾‹</h3><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª C++ é¡¹ç›®ï¼Œç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WORKSPACE</span><br><span class="line">BUILD</span><br><span class="line"><span class="selector-tag">main</span><span class="selector-class">.cpp</span></span><br><span class="line">hello<span class="selector-class">.h</span></span><br><span class="line">hello<span class="selector-class">.cpp</span></span><br><span class="line">hello_test<span class="selector-class">.cpp</span></span><br></pre></td></tr></table></figure>

<ul>
<li>WORKSPACE æ–‡ä»¶ï¼šæ ‡è®°é¡¹ç›®æ ¹ç›®å½•ï¼ŒBazel å¿…éœ€ã€‚å†…å®¹å¯ä»¥ä¸ºç©ºã€‚</li>
<li>BUILD æ–‡ä»¶ï¼šæè¿°å¦‚ä½•æ„å»ºé¡¹ç›®ã€‚</li>
</ul>
<h3 id="å†™ä¸€ä¸ªç®€å•-BUILD-æ–‡ä»¶"><a href="#å†™ä¸€ä¸ªç®€å•-BUILD-æ–‡ä»¶" class="headerlink" title="å†™ä¸€ä¸ªç®€å• BUILD æ–‡ä»¶"></a>å†™ä¸€ä¸ªç®€å• BUILD æ–‡ä»¶</h3><figure class="highlight plaintext"><figcaption><span>BUILD</span><a href="/blog/downloads/code/bazel_hello/BUILD">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cc_library(</span><br><span class="line">    name = &quot;hello_lib&quot;,</span><br><span class="line">    srcs = [&quot;hello.cpp&quot;],</span><br><span class="line">    hdrs = [&quot;hello.h&quot;],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cc_binary(</span><br><span class="line">    name = &quot;hello_bin&quot;,</span><br><span class="line">    srcs = [&quot;main.cpp&quot;],</span><br><span class="line">    deps = [&quot;:hello_lib&quot;],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cc_test(</span><br><span class="line">    name = &quot;hello_test&quot;,</span><br><span class="line">    srcs = [&quot;hello_test.cpp&quot;],</span><br><span class="line">    deps = [&quot;:hello_lib&quot;, &quot;@googletest//:gtest_main&quot;],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="ç®€å•æºç ç¤ºä¾‹"><a href="#ç®€å•æºç ç¤ºä¾‹" class="headerlink" title="ç®€å•æºç ç¤ºä¾‹"></a>ç®€å•æºç ç¤ºä¾‹</h3><figure class="highlight cpp"><figcaption><span>hello.h</span><a href="/blog/downloads/code/bazel_hello/hello.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">say_hello</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>hello.cpp</span><a href="/blog/downloads/code/bazel_hello/hello.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">say_hello</span><span class="params">()</span> </span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello, Bazel!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>hello_test.cpp</span><a href="/blog/downloads/code/bazel_hello/hello_test.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gtest/gtest.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">TEST</span>(HelloTest, Basic) {</span><br><span class="line">    <span class="built_in">EXPECT_NO_THROW</span>(<span class="built_in">say_hello</span>());</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>{</span><br><span class="line">    testing::<span class="built_in">InitGoogleTest</span>(&amp;argc, argv);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RUN_ALL_TESTS</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>main.cpp</span><a href="/blog/downloads/code/bazel_hello/main.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">say_hello</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="æ„å»ºå’Œæµ‹è¯•"><a href="#æ„å»ºå’Œæµ‹è¯•" class="headerlink" title="æ„å»ºå’Œæµ‹è¯•"></a>æ„å»ºå’Œæµ‹è¯•</h3><ul>
<li><p>ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bazel build //:hello_bin</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œå†’å·ç”¨äºåˆ†éš”è·¯å¾„å’Œç›®æ ‡ã€‚</p>
</li>
<li><p>è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bazel run //:hello_bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿è¡Œæµ‹è¯•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bazel <span class="built_in">test</span> //:hello_test</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/12/cpp/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/12/cpp/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/" class="post-title-link" itemprop="url">æ™ºèƒ½æŒ‡é’ˆ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-12 10:16:44" itemprop="dateCreated datePublished" datetime="2025-08-12T10:16:44+00:00">2025-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="shared-ptræ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ"><a href="#shared-ptræ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ" class="headerlink" title="shared_ptræ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ"></a>shared_ptræ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ</h2><p><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/1_82_0/libs/smart_ptr/doc/html/smart_ptr.html#shared_ptr_thread_safety">Boostå®˜ç½‘ï¼šshared_ptr_thread_safety</a></p>
<p>shared_pträ¸å†…å»ºç±»å‹ï¼ˆæ¯”å¦‚int, charï¼›std::stringä¸æ˜¯å†…å»ºç±»å‹ï¼‰å…·æœ‰ç›¸åŒçš„çº¿ç¨‹å®‰å…¨ç­‰çº§ï¼š</p>
<ul>
<li>åŒä¸€ä¸ªshared_ptrå¯ä»¥è¢«å¹¶å‘è¯»ï¼›</li>
<li>ä¸åŒçš„shared_ptrå¯ä»¥è¢«å¹¶å‘å†™ï¼ˆææ„ä¹Ÿæ˜¯å†™ï¼‰ã€‚</li>
<li>å…¶ä»–å¹¶å‘è®¿é—®æ˜¯æœªå®šä¹‰çš„ã€‚</li>
</ul>
<p>Examples:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">42</span>))</span></span>;</span><br></pre></td></tr></table></figure>

<p>Code Example 4. Reading a shared_ptr from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p2</span><span class="params">(p)</span></span>; <span class="comment">// reads p</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p3</span><span class="params">(p)</span></span>; <span class="comment">// OK, multiple reads are safe</span></span><br></pre></td></tr></table></figure>
<p>è¯»å–åŒä¸€ä¸ªshared_ptræ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚<br>åŒæ—¶å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå®‰å…¨ã€‚</p>
<p>Code Example 5. Writing different shared_ptr instances from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line">p.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">1912</span>)); <span class="comment">// writes p</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line">p2.<span class="built_in">reset</span>(); <span class="comment">// OK, writes p2</span></span><br></pre></td></tr></table></figure>
<p>å†™ä¸åŒçš„shared_ptrå®ä¾‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚<br>ä¸åŒçš„å®ä¾‹å„è‡ªæ›´æ–°è‡ªå·±çš„å¼•ç”¨è®¡æ•°æ§åˆ¶å—æŒ‡é’ˆï¼Œå®‰å…¨ã€‚<br>å¯¹å…±åŒæŒç®¡çš„èµ„æºçš„å¼•ç”¨è®¡æ•°åŸå­å‡1ï¼Œå®‰å…¨ã€‚</p>
<p>Code Example 6. Reading and writing a shared_ptr from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line">p = p3; <span class="comment">// reads p3, writes p</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line">p3.<span class="built_in">reset</span>(); <span class="comment">// writes p3; undefined, simultaneous read/write</span></span><br></pre></td></tr></table></figure>
<p>åŒæ—¶è¯»å†™åŒä¸€ä¸ªshared_ptrå®ä¾‹ï¼Œæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚<br>åŒæ—¶å¯¹å¼•ç”¨è®¡æ•°è¿›è¡Œå¢å‡ï¼Œå¦‚æœå…ˆçœ‹åˆ°å‡åˆ°0ï¼Œé‚£ä¹ˆå¯èƒ½èµ„æºå·²ç»è¢«é‡Šæ”¾ã€‚</p>
<p>Code Example 7. Reading and destroying a shared_ptr from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line">p3 = p2; <span class="comment">// reads p2, writes p3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line"><span class="comment">// p2 goes out of scope: undefined, the destructor is considered a &quot;write access&quot;</span></span><br></pre></td></tr></table></figure>
<p>åŒæ—¶è¯»å†™ï¼ˆææ„ä¹Ÿæ˜¯å†™ï¼‰åŒä¸€ä¸ªshared_ptrå®ä¾‹ï¼Œæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</p>
<p>Code Example 8. Writing a shared_ptr from two threads</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread A</span></span><br><span class="line">p3.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line">p3.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">2</span>)); <span class="comment">// undefined, multiple writes</span></span><br></pre></td></tr></table></figure>
<p>åŒæ—¶å†™åŒä¸€ä¸ªshared_ptrï¼Œå¯èƒ½å¯¹å¼•ç”¨è®¡æ•°æ“ä½œå¤šæ¬¡ï¼ˆåº”è¯¥åªèƒ½æ“ä½œä¸€æ¬¡ï¼‰ï¼Œçº¿ç¨‹ä¸å®‰å…¨ã€‚</p>
<p><strong>æµ‹è¯•ï¼šæ¨¡æ‹Ÿæ½œåœ¨ç«æ€æ¡ä»¶ï¼š</strong></p>
<p>æœ€åä¸€ä¸ªå¼•ç”¨å³å°†é”€æ¯æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯•å›¾å¤åˆ¶</p>
<details>
<summary>ç¤ºä¾‹1ï¼šå¤åˆ¶æ„é€ å’Œreset()ç«äº‰</summary>

<figure class="highlight cpp"><figcaption><span>race1.cpp</span><a href="/blog/downloads/code/shared_ptr/race1.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="built_in">Test</span>() { std::cout &lt;&lt; <span class="string">&quot;Test constructed\n&quot;</span>; }</span><br><span class="line">    ~<span class="built_in">Test</span>() { std::cout &lt;&lt; <span class="string">&quot;Test destroyed\n&quot;</span>; }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread_copy</span><span class="params">(std::shared_ptr&lt;Test&gt;&amp; ptr)</span> </span>{</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿå»¶è¿Ÿï¼Œè¯•å›¾åœ¨ä¸»çº¿ç¨‹é”€æ¯åå¤åˆ¶</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread attempting to copy shared_ptr\n&quot;</span>;</span><br><span class="line">    std::shared_ptr&lt;Test&gt; local_copy = ptr;  <span class="comment">// èµ„æºå¯èƒ½å·²ç»é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">if</span> (local_copy) {      <span class="comment">// shared_ptr è¿˜å­˜åœ¨ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥æ£€æŸ¥èµ„æºæ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread copied shared_ptr\n&quot;</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread failed to copy shared_ptr\n&quot;</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    std::shared_ptr&lt;Test&gt; ptr = std::<span class="built_in">make_shared</span>&lt;Test&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(thread_copy, std::ref(ptr))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸»çº¿ç¨‹é”€æ¯ shared_ptr</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">50</span>));</span><br><span class="line">    ptr.<span class="built_in">reset</span>();  <span class="comment">// å¼•ç”¨è®¡æ•°é™ä¸º 0ï¼Œé”€æ¯å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

</details>

<p>æ€»ç»“ï¼š <code>reset()</code> ä¸å¤åˆ¶æ„é€ éœ€è¦åŠ é”ä¿æŠ¤ã€‚</p>
<details>
<summary>ç¤ºä¾‹2ï¼šå¤åˆ¶æ„é€ å’Œææ„ç«äº‰</summary>

<figure class="highlight cpp"><figcaption><span>race2.cpp</span><a href="/blog/downloads/code/shared_ptr/race2.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="built_in">Test</span>() { std::cout &lt;&lt; <span class="string">&quot;Test constructed\n&quot;</span>; }</span><br><span class="line">    ~<span class="built_in">Test</span>() { std::cout &lt;&lt; <span class="string">&quot;Test destroyed\n&quot;</span>; }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread_copy</span><span class="params">(std::shared_ptr&lt;Test&gt;&amp; ptr)</span> </span>{</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿå»¶è¿Ÿï¼Œè¯•å›¾åœ¨ä¸»çº¿ç¨‹é”€æ¯åå¤åˆ¶</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread attempting to copy shared_ptr\n&quot;</span>;</span><br><span class="line">    std::shared_ptr&lt;Test&gt; local_copy = ptr;  <span class="comment">// å¦‚æœ ptr å·²ç»é”€æ¯ï¼Œè¿™é‡Œæ˜¯æœªå®šä¹‰è¡Œä¸º</span></span><br><span class="line">    <span class="keyword">if</span> (local_copy) {                        <span class="comment">// å¯èƒ½â€œæˆåŠŸâ€å¤åˆ¶ä¸€ä¸ªå·²ç»é”€æ¯çš„ shared_ptr</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread copied shared_ptr\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Use count in thread: &quot;</span></span><br><span class="line">                  &lt;&lt; local_copy.<span class="built_in">use_count</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;  <span class="comment">// å¼•ç”¨è®¡æ•°æ§åˆ¶å—æ˜¯ä¸€ä¸ªé‡æŒ‡é’ˆ</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread failed to copy shared_ptr\n&quot;</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    std::thread t;</span><br><span class="line"></span><br><span class="line">    {</span><br><span class="line">        std::shared_ptr&lt;Test&gt; ptr = std::<span class="built_in">make_shared</span>&lt;Test&gt;();</span><br><span class="line"></span><br><span class="line">        t = std::<span class="built_in">thread</span>(thread_copy, std::<span class="built_in">ref</span>(ptr));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸»çº¿ç¨‹é”€æ¯ shared_ptr</span></span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">50</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ææ„ï¼Œå¼•ç”¨è®¡æ•°é™ä¸º 0ï¼Œé”€æ¯å¯¹è±¡</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

</details>


<p><strong>æ€»ç»“ï¼š</strong></p>
<ul>
<li>ä¸èƒ½ä»¥å·¦å€¼å¼•ç”¨æ¥å¤åˆ¶æ„é€ shared_ptrï¼Œå¦åˆ™ä¼šå­˜åœ¨ç«äº‰ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨constå¼•ç”¨ï¼Œå› ä¸ºå¯ä»¥å»¶ç»­shared_ptrçš„ç”Ÿå‘½æœŸï¼Œææ„è¢«æ¨è¿Ÿï¼Œé—´æ¥æ¶ˆé™¤äº†ç«æ€ã€‚</li>
<li>ç¨‹åºä¸­shared_ptrè¯»å†™æ“ä½œåŒæ—¶å­˜åœ¨æ—¶ï¼Œéœ€è¦åŠ é”ã€‚</li>
<li>è¦é˜²æ­¢shared_ptrææ„ï¼šåœ¨shared_ptrå‰¯æœ¬çš„æ•´ä¸ªä½œç”¨åŸŸå†…åŠ é”åŒæ ·å¯ä»¥ä¿æŠ¤è¿™ç§æƒ…å†µã€‚</li>
<li>C++20 å¼€å§‹æ”¯æŒ <code>atomic&lt;shared_ptr&lt;T&gt;&gt;</code>ï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«å’Œæ›´æ–° shared_ptrã€‚</li>
<li>å¦‚æœ thread A åªæ˜¯æƒ³è§‚å¯Ÿ p2 æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨ std::weak_ptr æ¥è§‚å¯Ÿã€‚</li>
</ul>
<h2 id="shared-pträ¸ºä»€ä¹ˆè¦éšå¼è‡ªæŒä¸€ä¸ªweak-countï¼Ÿ"><a href="#shared-pträ¸ºä»€ä¹ˆè¦éšå¼è‡ªæŒä¸€ä¸ªweak-countï¼Ÿ" class="headerlink" title="shared_pträ¸ºä»€ä¹ˆè¦éšå¼è‡ªæŒä¸€ä¸ªweak countï¼Ÿ"></a>shared_pträ¸ºä»€ä¹ˆè¦éšå¼è‡ªæŒä¸€ä¸ªweak countï¼Ÿ</h2><p>æ¯ä¸ª shared_ptr å’Œ weak_ptr éƒ½æŒ‡å‘ä¸€ä¸ª æ§åˆ¶å—ï¼ˆcontrol blockï¼‰ï¼Œè¿™ä¸ªæ§åˆ¶å—é€šå¸¸åŒ…å«ï¼š</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>strong count</td>
<td>å½“å‰æ´»è·ƒçš„ shared_ptr æ•°é‡</td>
</tr>
<tr>
<td>weak count</td>
<td>å½“å‰æ´»è·ƒçš„ weak_ptr æ•°é‡ + å½“å‰æ´»è·ƒçš„ shared_ptr æ•°é‡</td>
</tr>
<tr>
<td>æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆ</td>
<td>è¢«ç®¡ç†çš„èµ„æº</td>
</tr>
</tbody></table>
<p>æ§åˆ¶å—çš„ç”Ÿå‘½å‘¨æœŸç”± weak count å†³å®šï¼Œåªè¦è¿˜æœ‰ weak_ptr æˆ– shared_ptr å­˜åœ¨ï¼Œæ§åˆ¶å—å°±ä¸èƒ½è¢«é”€æ¯ã€‚</p>
<ul>
<li>weak_ptrå’Œshared_ptrå¯èƒ½å­˜åœ¨åªæœ‰ä¸¤è€…ä¹‹ä¸€çš„æƒ…å†µï¼Œæ‰€ä»¥ä»–ä»¬éƒ½å¿…é¡»è¦ç»´æŠ¤æ§åˆ¶å—çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li>å¦‚æœåªæœ‰weak_ptrå¯¹weak countè¿›è¡Œè®¡æ•°ï¼Œé‚£ä¹ˆå¯èƒ½å‡ºç°shared_ptrå’Œweak_ptrå…±åŒçœ‹åˆ°weak countä¸º0çš„æƒ…å†µï¼š<ul>
<li>weak_ptrææ„å°†weak counté™ä½ä¸º0ï¼Œå‡†å¤‡é‡Šæ”¾æ§åˆ¶å—ï¼›</li>
<li>shared_ptrææ„æˆ–resetï¼Œæ£€æµ‹åˆ°weak countä¸º0ï¼Œå‡†å¤‡é‡Šæ”¾æ§åˆ¶å—ï¼›</li>
<li>è¿™æ ·å°±é‡Šæ”¾äº†ä¸¤æ¬¡ï¼Œå› ä¸ºä»–ä»¬éƒ½æŒæœ‰æŒ‡é’ˆï¼Œä¸”æ²¡æœ‰è®¾ç½®ç›¸äº’é€šçŸ¥çš„æœºåˆ¶ã€‚</li>
</ul>
</li>
<li>ä½†æ˜¯ï¼Œå¦‚æœweak_ptrå’Œshared_ptréƒ½å¯¹weak countè¿›è¡Œè®¡æ•°ï¼Œé‚£ä¹ˆå°±ä¸å¯èƒ½åŒæ—¶è§‚å¯Ÿåˆ°weak countä¸º0çš„æƒ…å†µã€‚</li>
</ul>
<h2 id="åŠ¨æ‰‹å®ç°ä¸€ä¸ªshared-ptr"><a href="#åŠ¨æ‰‹å®ç°ä¸€ä¸ªshared-ptr" class="headerlink" title="åŠ¨æ‰‹å®ç°ä¸€ä¸ªshared_ptr"></a>åŠ¨æ‰‹å®ç°ä¸€ä¸ªshared_ptr</h2><details>
<summary>SimpleSharedPtr</summary>

<figure class="highlight cpp"><figcaption><span>SimpleSharedPtr.cpp</span><a href="/blog/downloads/code/shared_ptr/SimpleSharedPtr.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleSharedPtr</span>;  <span class="comment">// å…ˆå£°æ˜</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleWeakPtr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ControlBlock</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::atomic&lt;<span class="type">int</span>&gt; shared_count;</span><br><span class="line">    std::atomic&lt;<span class="type">int</span>&gt; weak_count;</span><br><span class="line">    T* ptr;</span><br><span class="line">    std::function&lt;<span class="type">void</span>(T*)&gt; deleter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸ªshared_ptrè‡ªæŒä¸€ä¸ªweak count</span></span><br><span class="line">    <span class="built_in">ControlBlock</span>(T* p, std::function&lt;<span class="built_in">void</span>(T*)&gt; d)</span><br><span class="line">        : <span class="built_in">shared_count</span>(<span class="number">1</span>), <span class="built_in">weak_count</span>(<span class="number">1</span>), <span class="built_in">ptr</span>(p), <span class="built_in">deleter</span>(d ? d : [](T* p){ <span class="keyword">delete</span> p; }) {}</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ControlBlock</span>() = <span class="keyword">default</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleSharedPtr</span> {</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ControlBlock&lt;T&gt;* ctrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            <span class="comment">// å‡shared_count</span></span><br><span class="line">            <span class="keyword">if</span> (ctrl-&gt;shared_count.<span class="built_in">fetch_sub</span>(<span class="number">1</span>, std::memory_order_acq_rel) == <span class="number">1</span>) {</span><br><span class="line">                <span class="comment">// æœ€åä¸€ä¸ªshared_ptrï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    ctrl-&gt;<span class="built_in">deleter</span>(ctrl-&gt;ptr);</span><br><span class="line">                } <span class="built_in">catch</span> (...) {</span><br><span class="line">                    std::cerr &lt;&lt; <span class="string">&quot;Exception in deleter\n&quot;</span>;</span><br><span class="line">                }</span><br><span class="line">                ctrl-&gt;ptr = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å†å‡å°‘weak_countï¼Œè‡ªå·±å æœ‰ä¸€ä¸ªweakè®¡æ•°ï¼Œå‡å°‘å®ƒ</span></span><br><span class="line">                <span class="keyword">if</span> (ctrl-&gt;weak_count.<span class="built_in">fetch_sub</span>(<span class="number">1</span>, std::memory_order_acq_rel) == <span class="number">1</span>) {</span><br><span class="line">                    <span class="keyword">delete</span> ctrl;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">SimpleSharedPtr</span><span class="params">(T* p = <span class="literal">nullptr</span>, std::function&lt;<span class="type">void</span>(T*)&gt; d = <span class="literal">nullptr</span>)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (p) {</span><br><span class="line">            ctrl = <span class="keyword">new</span> <span class="built_in">ControlBlock</span>&lt;T&gt;(p, d);</span><br><span class="line">            <span class="comment">// shared_count=1, weak_count=0</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹·è´æ„é€ </span></span><br><span class="line">    <span class="built_in">SimpleSharedPtr</span>(<span class="type">const</span> SimpleSharedPtr&amp; other) : <span class="built_in">ctrl</span>(other.ctrl) {</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            ctrl-&gt;shared_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»åŠ¨æ„é€ </span></span><br><span class="line">    <span class="built_in">SimpleSharedPtr</span>(SimpleSharedPtr&amp;&amp; other) <span class="keyword">noexcept</span> : <span class="built_in">ctrl</span>(other.ctrl) {</span><br><span class="line">        other.ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ææ„</span></span><br><span class="line">    ~<span class="built_in">SimpleSharedPtr</span>() {</span><br><span class="line">        <span class="built_in">release</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹·è´èµ‹å€¼</span></span><br><span class="line">    SimpleSharedPtr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> SimpleSharedPtr&amp; other) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) {</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ctrl = other.ctrl;</span><br><span class="line">            <span class="keyword">if</span> (ctrl) {</span><br><span class="line">                ctrl-&gt;shared_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»åŠ¨èµ‹å€¼</span></span><br><span class="line">    SimpleSharedPtr&amp; <span class="keyword">operator</span>=(SimpleSharedPtr&amp;&amp; other) <span class="keyword">noexcept</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) {</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ctrl = other.ctrl;</span><br><span class="line">            other.ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function">T* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ctrl ? ctrl-&gt;ptr : <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="type">const</span> {</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">get</span>()) <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Dereferencing null pointer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> *(ctrl-&gt;ptr);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="type">const</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ctrl ? ctrl-&gt;shared_count.<span class="built_in">load</span>(std::memory_order_relaxed) : <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">unique</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">use_count</span>() == <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get</span>() != <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">(T* p = <span class="literal">nullptr</span>, std::function&lt;<span class="type">void</span>(T*)&gt; d = <span class="literal">nullptr</span>)</span> </span>{</span><br><span class="line">        <span class="built_in">release</span>();</span><br><span class="line">        <span class="keyword">if</span> (p) {</span><br><span class="line">            ctrl = <span class="keyword">new</span> <span class="built_in">ControlBlock</span>&lt;T&gt;(p, d);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»™ SimpleWeakPtr è®¿é—® ControlBlock æŒ‡é’ˆæƒé™</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">SimpleWeakPtr</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// SimpleSharedPtrå¢åŠ ä¸€ä¸ªç§æœ‰æ„é€ ï¼Œèƒ½ä»æ§åˆ¶å—æ„é€ shared_ptrï¼ˆé…åˆweak_ptrçš„lockï¼‰</span></span><br><span class="line">    <span class="built_in">SimpleSharedPtr</span>(ControlBlock&lt;T&gt;* c) : <span class="built_in">ctrl</span>(c) {}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleWeakPtr</span> {</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ControlBlock&lt;T&gt;* ctrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            <span class="keyword">if</span> (ctrl-&gt;weak_count.<span class="built_in">fetch_sub</span>(<span class="number">1</span>, std::memory_order_acq_rel) == <span class="number">1</span>) {</span><br><span class="line">                <span class="comment">// åªæœ‰å¼±å¼•ç”¨ä¸”æ²¡æœ‰shared_ptrå­˜åœ¨æ—¶ï¼Œé”€æ¯æ§åˆ¶å—</span></span><br><span class="line">                <span class="keyword">if</span> (ctrl-&gt;shared_count.<span class="built_in">load</span>(std::memory_order_acquire) == <span class="number">0</span>) {</span><br><span class="line">                    <span class="keyword">delete</span> ctrl;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SimpleWeakPtr</span>() : <span class="built_in">ctrl</span>(<span class="literal">nullptr</span>) {}</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä» shared_ptr æ„é€  weak_ptr</span></span><br><span class="line">    <span class="built_in">SimpleWeakPtr</span>(<span class="type">const</span> SimpleSharedPtr&lt;T&gt;&amp; shared) : <span class="built_in">ctrl</span>(shared.ctrl) {</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            ctrl-&gt;weak_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹·è´æ„é€ </span></span><br><span class="line">    <span class="built_in">SimpleWeakPtr</span>(<span class="type">const</span> SimpleWeakPtr&amp; other) : <span class="built_in">ctrl</span>(other.ctrl) {</span><br><span class="line">        <span class="keyword">if</span> (ctrl) {</span><br><span class="line">            ctrl-&gt;weak_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»åŠ¨æ„é€ </span></span><br><span class="line">    <span class="built_in">SimpleWeakPtr</span>(SimpleWeakPtr&amp;&amp; other) <span class="keyword">noexcept</span> : <span class="built_in">ctrl</span>(other.ctrl) {</span><br><span class="line">        other.ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">SimpleWeakPtr</span>() {</span><br><span class="line">        <span class="built_in">release</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹·è´èµ‹å€¼</span></span><br><span class="line">    SimpleWeakPtr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> SimpleWeakPtr&amp; other) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) {</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ctrl = other.ctrl;</span><br><span class="line">            <span class="keyword">if</span> (ctrl) {</span><br><span class="line">                ctrl-&gt;weak_count.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»åŠ¨èµ‹å€¼</span></span><br><span class="line">    SimpleWeakPtr&amp; <span class="keyword">operator</span>=(SimpleWeakPtr&amp;&amp; other) <span class="keyword">noexcept</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;other) {</span><br><span class="line">            <span class="built_in">release</span>();</span><br><span class="line">            ctrl = other.ctrl;</span><br><span class="line">            other.ctrl = <span class="literal">nullptr</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ctrl ? ctrl-&gt;shared_count.<span class="built_in">load</span>(std::memory_order_relaxed) : <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">expired</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">use_count</span>() == <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•è·å–shared_ptrï¼Œèµ„æºå·²è¢«é”€æ¯åˆ™è¿”å›ç©ºshared_ptr</span></span><br><span class="line">    <span class="function">SimpleSharedPtr&lt;T&gt; <span class="title">lock</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">expired</span>()) {</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SimpleSharedPtr</span>&lt;T&gt;();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// å°è¯•å¢åŠ shared_count</span></span><br><span class="line">            <span class="type">int</span> old_count = ctrl-&gt;shared_count.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">            <span class="keyword">while</span> (old_count != <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">if</span> (ctrl-&gt;shared_count.<span class="built_in">compare_exchange_weak</span>(old_count, old_count + <span class="number">1</span>,</span><br><span class="line">                    std::memory_order_acq_rel, std::memory_order_relaxed)) {</span><br><span class="line">                    <span class="comment">// æˆåŠŸå¢åŠ shared_count</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">SimpleSharedPtr</span>&lt;T&gt;(ctrl);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// old_count å·²è¢«æ›´æ–°ï¼Œç»§ç»­å¾ªç¯</span></span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">SimpleSharedPtr</span>&lt;T&gt;();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// è®© SimpleSharedPtr å¯ä»¥é€šè¿‡æ§åˆ¶å—æ„é€  shared_ptr</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">SimpleSharedPtr</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">SimpleWeakPtr</span><span class="params">(ControlBlock&lt;T&gt;* c)</span> : ctrl(c) {</span>}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">SimpleSharedPtr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">42</span>))</span></span>;</span><br><span class="line">    SimpleWeakPtr&lt;<span class="type">int</span>&gt; wp1 = sp1;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;use_count: &quot;</span> &lt;&lt; sp1.<span class="built_in">use_count</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>; <span class="comment">// 1</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;expired: &quot;</span> &lt;&lt; wp1.<span class="built_in">expired</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;    <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> sp2 = wp1.<span class="built_in">lock</span>()) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;locked value: &quot;</span> &lt;&lt; *sp2 &lt;&lt; <span class="string">&quot;\n&quot;</span>;    <span class="comment">// 42</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;use_count after lock: &quot;</span> &lt;&lt; sp2.<span class="built_in">use_count</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>; <span class="comment">// 2</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    sp1.<span class="built_in">reset</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;expired after reset: &quot;</span> &lt;&lt; wp1.<span class="built_in">expired</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>; <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> sp3 = wp1.<span class="built_in">lock</span>()) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Should not print\n&quot;</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;lock failed, resource expired\n&quot;</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

</details>

<h2 id="é™„å½•ï¼šshared-ptræºç "><a href="#é™„å½•ï¼šshared-ptræºç " class="headerlink" title="é™„å½•ï¼šshared_ptræºç "></a>é™„å½•ï¼šshared_ptræºç </h2><ul>
<li><code>/usr/include/c++/11/bits/shared_ptr.h</code></li>
<li><code>/usr/include/c++/11/bits/shared_ptr_base.h</code></li>
<li><code>/usr/include/c++/11/bits/shared_ptr_atomic.h</code></li>
</ul>
<details>
<summary>shared_ptr.h</summary>
<figure class="highlight cpp"><figcaption><span>shared_ptr.h</span><a href="/blog/downloads/code/shared_ptr/shared_ptr.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr and weak_ptr implementation -*- C++ -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Copyright (C) 2007-2021 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file is part of the GNU ISO C++ Library.  This library is free</span></span><br><span class="line"><span class="comment">// software; you can redistribute it and/or modify it under the</span></span><br><span class="line"><span class="comment">// terms of the GNU General Public License as published by the</span></span><br><span class="line"><span class="comment">// Free Software Foundation; either version 3, or (at your option)</span></span><br><span class="line"><span class="comment">// any later version.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This library is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">// GNU General Public License for more details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Under Section 7 of GPL version 3, you are granted additional</span></span><br><span class="line"><span class="comment">// permissions described in the GCC Runtime Library Exception, version</span></span><br><span class="line"><span class="comment">// 3.1, as published by the Free Software Foundation.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You should have received a copy of the GNU General Public License and</span></span><br><span class="line"><span class="comment">// a copy of the GCC Runtime Library Exception along with this program;</span></span><br><span class="line"><span class="comment">// see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see</span></span><br><span class="line"><span class="comment">// &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// GCC Note: Based on files from version 1.32.0 of the Boost library.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  shared_count.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (c) 2001, 2002, 2003 Peter Dimov and Multi Media Ltd.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  shared_ptr.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 1998, 1999 Greg Colvin and Beman Dawes.</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2001, 2002, 2003 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  weak_ptr.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2001, 2002, 2003 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  enable_shared_from_this.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2002 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Distributed under the Boost Software License, Version 1.0. (See</span></span><br><span class="line"><span class="comment">// accompanying file LICENSE_1_0.txt or copy at</span></span><br><span class="line"><span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** @file</span></span><br><span class="line"><span class="comment"> *  This is an internal header file, included by other library headers.</span></span><br><span class="line"><span class="comment"> *  Do not attempt to use it directly. @headername{memory}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SHARED_PTR_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SHARED_PTR_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iosfwd&gt;</span>           	  <span class="comment">// std::basic_ostream</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/shared_ptr_base.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> std _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">{</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @addtogroup pointer_abstractions</span></span><br><span class="line"><span class="comment">   * @{</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.11 shared_ptr I/O</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Write the stored pointer to an ostream.</span></span><br><span class="line">  <span class="comment">/// @relates shared_ptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ch, <span class="keyword">typename</span> _Tr, <span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> std::basic_ostream&lt;_Ch, _Tr&gt;&amp;</span><br><span class="line">    <span class="keyword">operator</span>&lt;&lt;(std::basic_ostream&lt;_Ch, _Tr&gt;&amp; __os,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __p)</span><br><span class="line">    {</span><br><span class="line">      __os &lt;&lt; __p.<span class="built_in">get</span>();</span><br><span class="line">      <span class="keyword">return</span> __os;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> _Del*</span></span><br><span class="line"><span class="function">    <span class="title">get_deleter</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __p)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_rtti</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;_Del*&gt;(__p._M_get_deleter(<span class="built_in">typeid</span>(_Del)));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 20.7.2.2.10 shared_ptr get_deleter</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// If `__p` has a deleter of type `_Del`, return a pointer to it.</span></span><br><span class="line">  <span class="comment">/// @relates shared_ptr</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> _Del*</span></span><br><span class="line"><span class="function">    <span class="title">get_deleter</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __p)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_rtti</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;_Del*&gt;(__p._M_get_deleter(<span class="built_in">typeid</span>(_Del)));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  A smart pointer with reference-counted copy semantics.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * A `shared_ptr` object is either empty or _owns_ a pointer passed</span></span><br><span class="line"><span class="comment">   * to the constructor. Copies of a `shared_ptr` share ownership of</span></span><br><span class="line"><span class="comment">   * the same pointer. When the last `shared_ptr` that owns the pointer</span></span><br><span class="line"><span class="comment">   * is destroyed or reset, the owned pointer is freed (either by `delete`</span></span><br><span class="line"><span class="comment">   * or by invoking a custom deleter that was passed to the constructor).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * A `shared_ptr` also stores another pointer, which is usually</span></span><br><span class="line"><span class="comment">   * (but not always) the same pointer as it owns. The stored pointer</span></span><br><span class="line"><span class="comment">   * can be retrieved by calling the `get()` member function.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * The equality and relational operators for `shared_ptr` only compare</span></span><br><span class="line"><span class="comment">   * the stored pointer returned by `get()`, not the owned pointer.</span></span><br><span class="line"><span class="comment">   * To test whether two `shared_ptr` objects share ownership of the same</span></span><br><span class="line"><span class="comment">   * pointer see `std::shared_ptr::owner_before` and `std::owner_less`.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">shared_ptr</span> : <span class="keyword">public</span> __shared_ptr&lt;_Tp&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	<span class="keyword">using</span> _Constructible = <span class="keyword">typename</span> enable_if&lt;</span><br><span class="line">	  is_constructible&lt;__shared_ptr&lt;_Tp&gt;, _Args...&gt;::value</span><br><span class="line">	&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Arg&gt;</span><br><span class="line">	<span class="keyword">using</span> _Assignable = <span class="keyword">typename</span> enable_if&lt;</span><br><span class="line">	  is_assignable&lt;__shared_ptr&lt;_Tp&gt;&amp;, _Arg&gt;::value, shared_ptr&amp;</span><br><span class="line">	&gt;::type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// The type pointed to by the stored pointer, remove_extent_t&lt;_Tp&gt;</span></span><br><span class="line">      <span class="keyword">using</span> element_type = <span class="keyword">typename</span> __shared_ptr&lt;_Tp&gt;::element_type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt;= 201703L</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __cpp_lib_shared_ptr_weak_type 201606</span></span><br><span class="line">      <span class="comment">/// The corresponding weak_ptr type for this shared_ptr</span></span><br><span class="line">      <span class="keyword">using</span> weak_type = weak_ptr&lt;_Tp&gt;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct an empty %shared_ptr.</span></span><br><span class="line"><span class="comment">       *  @post   use_count()==0 &amp;&amp; get()==0</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">constexpr</span> <span class="title">shared_ptr</span><span class="params">()</span> <span class="keyword">noexcept</span> : __shared_ptr&lt;_Tp&gt;() {</span> }</span><br><span class="line"></span><br><span class="line">      <span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>; <span class="comment">///&lt; Copy constructor</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns the pointer @a __p.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer that is convertible to element_type*.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @c delete @a __p is called.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;_Yp*&gt;&gt;</span><br><span class="line">	<span class="keyword">explicit</span></span><br><span class="line">	<span class="built_in">shared_ptr</span>(_Yp* __p) : __shared_ptr&lt;_Tp&gt;(__p) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns the pointer @a __p</span></span><br><span class="line"><span class="comment">       *          and the deleter @a __d.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer.</span></span><br><span class="line"><span class="comment">       *  @param  __d  A deleter.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @a __d(__p) is called.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Requirements: _Deleter&#x27;s copy constructor and destructor must</span></span><br><span class="line"><span class="comment">       *  not throw</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  __shared_ptr will release __p by calling __d(__p)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;_Yp*, _Deleter&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(_Yp* __p, _Deleter __d)</span><br><span class="line">        : __shared_ptr&lt;_Tp&gt;(__p, std::<span class="built_in">move</span>(__d)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns a null pointer</span></span><br><span class="line"><span class="comment">       *          and the deleter @a __d.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A null pointer constant.</span></span><br><span class="line"><span class="comment">       *  @param  __d  A deleter.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @a __d(__p) is called.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Requirements: _Deleter&#x27;s copy constructor and destructor must</span></span><br><span class="line"><span class="comment">       *  not throw</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  The last owner will call __d(__p)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Deleter&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(<span class="type">nullptr_t</span> __p, _Deleter __d)</span><br><span class="line">        : __shared_ptr&lt;_Tp&gt;(__p, std::<span class="built_in">move</span>(__d)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns the pointer @a __p</span></span><br><span class="line"><span class="comment">       *          and the deleter @a __d.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer.</span></span><br><span class="line"><span class="comment">       *  @param  __d  A deleter.</span></span><br><span class="line"><span class="comment">       *  @param  __a  An allocator.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @a __d(__p) is called.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Requirements: _Deleter&#x27;s copy constructor and destructor must</span></span><br><span class="line"><span class="comment">       *  not throw _Alloc&#x27;s copy constructor and destructor must not</span></span><br><span class="line"><span class="comment">       *  throw.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  __shared_ptr will release __p by calling __d(__p)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;_Yp*, _Deleter, _Alloc&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(_Yp* __p, _Deleter __d, _Alloc __a)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct a %shared_ptr that owns a null pointer</span></span><br><span class="line"><span class="comment">       *          and the deleter @a __d.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A null pointer constant.</span></span><br><span class="line"><span class="comment">       *  @param  __d  A deleter.</span></span><br><span class="line"><span class="comment">       *  @param  __a  An allocator.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 1 &amp;&amp; get() == __p</span></span><br><span class="line"><span class="comment">       *  @throw  std::bad_alloc, in which case @a __d(__p) is called.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  Requirements: _Deleter&#x27;s copy constructor and destructor must</span></span><br><span class="line"><span class="comment">       *  not throw _Alloc&#x27;s copy constructor and destructor must not</span></span><br><span class="line"><span class="comment">       *  throw.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  The last owner will call __d(__p)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(<span class="type">nullptr_t</span> __p, _Deleter __d, _Alloc __a)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Aliasing constructor</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Constructs a `shared_ptr` instance that stores `__p`</span></span><br><span class="line"><span class="comment">       *          and shares ownership with `__r`.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A `shared_ptr`.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer that will remain valid while `*__r` is valid.</span></span><br><span class="line"><span class="comment">       *  @post   `get() == __p &amp;&amp; use_count() == __r.use_count()`</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  This can be used to construct a `shared_ptr` to a sub-object</span></span><br><span class="line"><span class="comment">       *  of an object managed by an existing `shared_ptr`. The complete</span></span><br><span class="line"><span class="comment">       *  object will remain valid while any `shared_ptr` owns it, even</span></span><br><span class="line"><span class="comment">       *  if they don&#x27;t store a pointer to the complete object.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * @code</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;pair&lt;int,int&gt;&gt; pii(new pair&lt;int,int&gt;());</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;int&gt; pi(pii, &amp;pii-&gt;first);</span></span><br><span class="line"><span class="comment">       * assert(pii.use_count() == 2);</span></span><br><span class="line"><span class="comment">       * @endcode</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r, element_type* __p) <span class="keyword">noexcept</span></span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(__r, __p) { }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201703L</span></span><br><span class="line">      <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">      <span class="comment">// 2996. Missing rvalue overloads for shared_ptr operations</span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Constructs a `shared_ptr` instance that stores `__p`</span></span><br><span class="line"><span class="comment">       *          and shares ownership with `__r`.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A `shared_ptr`.</span></span><br><span class="line"><span class="comment">       *  @param  __p  A pointer that will remain valid while `*__r` is valid.</span></span><br><span class="line"><span class="comment">       *  @post   `get() == __p &amp;&amp; !__r.use_count() &amp;&amp; !__r.get()`</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       *  This can be used to construct a `shared_ptr` to a sub-object</span></span><br><span class="line"><span class="comment">       *  of an object managed by an existing `shared_ptr`. The complete</span></span><br><span class="line"><span class="comment">       *  object will remain valid while any `shared_ptr` owns it, even</span></span><br><span class="line"><span class="comment">       *  if they don&#x27;t store a pointer to the complete object.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * @code</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;pair&lt;int,int&gt;&gt; pii(new pair&lt;int,int&gt;());</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;int&gt; pi1(pii, &amp;pii-&gt;first);</span></span><br><span class="line"><span class="comment">       * assert(pii.use_count() == 2);</span></span><br><span class="line"><span class="comment">       * shared_ptr&lt;int&gt; pi2(std::move(pii), &amp;pii-&gt;second);</span></span><br><span class="line"><span class="comment">       * assert(pii.use_count() == 0);</span></span><br><span class="line"><span class="comment">       * @endcode</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(shared_ptr&lt;_Yp&gt;&amp;&amp; __r, element_type* __p) <span class="keyword">noexcept</span></span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r), __p) { }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  If @a __r is empty, constructs an empty %shared_ptr;</span></span><br><span class="line"><span class="comment">       *          otherwise construct a %shared_ptr that shares ownership</span></span><br><span class="line"><span class="comment">       *          with @a __r.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A %shared_ptr.</span></span><br><span class="line"><span class="comment">       *  @post   get() == __r.get() &amp;&amp; use_count() == __r.use_count()</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp;&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">        : __shared_ptr&lt;_Tp&gt;(__r) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Move-constructs a %shared_ptr instance from @a __r.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A %shared_ptr rvalue.</span></span><br><span class="line"><span class="comment">       *  @post   *this contains the old value of @a __r, @a __r is empty.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="built_in">shared_ptr</span>(shared_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Move-constructs a %shared_ptr instance from @a __r.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A %shared_ptr rvalue.</span></span><br><span class="line"><span class="comment">       *  @post   *this contains the old value of @a __r, @a __r is empty.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;shared_ptr&lt;_Yp&gt;&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(shared_ptr&lt;_Yp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r)) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Constructs a %shared_ptr that shares ownership with @a __r</span></span><br><span class="line"><span class="comment">       *          and stores a copy of the pointer stored in @a __r.</span></span><br><span class="line"><span class="comment">       *  @param  __r  A weak_ptr.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == __r.use_count()</span></span><br><span class="line"><span class="comment">       *  @throw  bad_weak_ptr when __r.expired(),</span></span><br><span class="line"><span class="comment">       *          in which case the constructor has no effect.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp;&gt;&gt;</span><br><span class="line">	<span class="keyword">explicit</span> <span class="built_in">shared_ptr</span>(<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp; __r)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(__r) { }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;auto_ptr&lt;_Yp&gt;&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(auto_ptr&lt;_Yp&gt;&amp;&amp; __r);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">      <span class="comment">// 2399. shared_ptr&#x27;s constructor from unique_ptr should be constrained</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;unique_ptr&lt;_Yp, _Del&gt;&gt;&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r)) { }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &lt;= 201402L &amp;&amp; _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line">      <span class="comment">// This non-standard constructor exists to support conversions that</span></span><br><span class="line">      <span class="comment">// were possible in C++11 and C++14 but are ill-formed in C++17.</span></span><br><span class="line">      <span class="comment">// If an exception is thrown this constructor has no effect.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del,</span><br><span class="line">		_Constructible&lt;unique_ptr&lt;_Yp, _Del&gt;, __sp_array_delete&gt;* = <span class="number">0</span>&gt;</span><br><span class="line">	<span class="built_in">shared_ptr</span>(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	: __shared_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r), __sp_array_delete()) { }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *  @brief  Construct an empty %shared_ptr.</span></span><br><span class="line"><span class="comment">       *  @post   use_count() == 0 &amp;&amp; get() == nullptr</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">constexpr</span> <span class="built_in">shared_ptr</span>(<span class="type">nullptr_t</span>) <span class="keyword">noexcept</span> : <span class="built_in">shared_ptr</span>() { }</span><br><span class="line"></span><br><span class="line">      shared_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(__r);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;auto_ptr&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(auto_ptr&lt;_Yp&gt;&amp;&amp; __r)</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      shared_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(shared_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">_Yp</span>&gt;</span><br><span class="line">	_Assignable&lt;shared_ptr&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(shared_ptr&lt;_Yp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del&gt;</span><br><span class="line">	_Assignable&lt;unique_ptr&lt;_Yp, _Del&gt;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__shared_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="comment">// This constructor is non-standard, it is used by allocate_shared.</span></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function">	<span class="title">shared_ptr</span><span class="params">(_Sp_alloc_shared_tag&lt;_Alloc&gt; __tag, _Args&amp;&amp;... __args)</span></span></span><br><span class="line"><span class="function">	: __shared_ptr&lt;_Tp&gt;(__tag, std::forward&lt;_Args&gt;(__args)...)</span></span><br><span class="line"><span class="function">	{</span> }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">friend</span> shared_ptr&lt;_Yp&gt;</span></span><br><span class="line"><span class="function">	<span class="title">allocate_shared</span><span class="params">(<span class="type">const</span> _Alloc&amp; __a, _Args&amp;&amp;... __args)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This constructor is non-standard, it is used by weak_ptr::lock().</span></span><br><span class="line">      <span class="built_in">shared_ptr</span>(<span class="type">const</span> weak_ptr&lt;_Tp&gt;&amp; __r, std::<span class="type">nothrow_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">      : __shared_ptr&lt;_Tp&gt;(__r, std::nothrow) { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">weak_ptr</span>&lt;_Tp&gt;;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_deduction_guides &gt;= 201606</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">shared_ptr</span><span class="params">(weak_ptr&lt;_Tp&gt;)</span> -&gt;  shared_ptr&lt;_Tp&gt;</span>;</span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Del&gt;</span></span><br><span class="line"><span class="function">    <span class="title">shared_ptr</span><span class="params">(unique_ptr&lt;_Tp, _Del&gt;)</span> -&gt;  shared_ptr&lt;_Tp&gt;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.7 shared_ptr comparisons</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @relates shared_ptr @{</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Equality operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a.<span class="built_in">get</span>() == __b.<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !__a; }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cpp_lib_three_way_comparison</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    <span class="keyword">inline</span> strong_ordering</span><br><span class="line">    <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a,</span><br><span class="line">		<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> <span class="built_in">compare_three_way</span>()(__a.<span class="built_in">get</span>(), __b.<span class="built_in">get</span>()); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">inline</span> strong_ordering</span><br><span class="line">    <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> pointer = <span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type*;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">compare_three_way</span>()(__a.<span class="built_in">get</span>(), <span class="built_in">static_cast</span>&lt;pointer&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !__a; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Inequality operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a.<span class="built_in">get</span>() != __b.<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="built_in">return</span> (<span class="type">bool</span>)__a; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="built_in">return</span> (<span class="type">bool</span>)__a; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Relational operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type;</span><br><span class="line">      <span class="keyword">using</span> _Up_elt = <span class="keyword">typename</span> shared_ptr&lt;_Up&gt;::element_type;</span><br><span class="line">      <span class="keyword">using</span> _Vp = <span class="keyword">typename</span> common_type&lt;_Tp_elt*, _Up_elt*&gt;::type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Vp&gt;()(__a.<span class="built_in">get</span>(), __b.<span class="built_in">get</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Tp_elt*&gt;()(__a.<span class="built_in">get</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Tp_elt*&gt;()(<span class="literal">nullptr</span>, __a.<span class="built_in">get</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Relational operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__b &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(<span class="literal">nullptr</span> &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; <span class="literal">nullptr</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Relational operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> (__b &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> <span class="literal">nullptr</span> &lt; __a; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a &lt; <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Relational operator for shared_ptr objects, compares the stored pointers</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; __b); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; <span class="literal">nullptr</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// shared_ptr comparison with nullptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    _GLIBCXX_NODISCARD <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">nullptr_t</span>, <span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(<span class="literal">nullptr</span> &lt; __a); }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.8 shared_ptr specialized algorithms.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Swap overload for shared_ptr</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">swap</span><span class="params">(shared_ptr&lt;_Tp&gt;&amp; __a, shared_ptr&lt;_Tp&gt;&amp; __b)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{ __a.<span class="built_in">swap</span>(__b); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.9 shared_ptr casts.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr`, via `static_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">static_pointer_cast</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">static_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr`, via `const_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">const_pointer_cast</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">const_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr`, via `dynamic_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">dynamic_pointer_cast</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span>* __p = <span class="built_in">dynamic_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()))</span><br><span class="line">	<span class="keyword">return</span> _Sp(__r, __p);</span><br><span class="line">      <span class="keyword">return</span> _Sp();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt;= 201703L</span></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr`, via `reinterpret_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">reinterpret_pointer_cast</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Up&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201703L</span></span><br><span class="line">  <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">  <span class="comment">// 2996. Missing rvalue overloads for shared_ptr operations</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr` rvalue, via `static_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">static_pointer_cast</span><span class="params">(shared_ptr&lt;_Up&gt;&amp;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(std::<span class="built_in">move</span>(__r),</span><br><span class="line">		 <span class="built_in">static_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr` rvalue, via `const_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">const_pointer_cast</span><span class="params">(shared_ptr&lt;_Up&gt;&amp;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(std::<span class="built_in">move</span>(__r),</span><br><span class="line">		 <span class="built_in">const_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr` rvalue, via `dynamic_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">dynamic_pointer_cast</span><span class="params">(shared_ptr&lt;_Up&gt;&amp;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span>* __p = <span class="built_in">dynamic_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()))</span><br><span class="line">	<span class="keyword">return</span> _Sp(std::<span class="built_in">move</span>(__r), __p);</span><br><span class="line">      <span class="keyword">return</span> _Sp();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Convert type of `shared_ptr` rvalue, via `reinterpret_cast`</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">reinterpret_pointer_cast</span><span class="params">(shared_ptr&lt;_Up&gt;&amp;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = shared_ptr&lt;_Tp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(std::<span class="built_in">move</span>(__r),</span><br><span class="line">		 <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// C++20</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// C++17</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @brief  A non-owning observer for a pointer owned by a shared_ptr</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * A weak_ptr provides a safe alternative to a raw pointer when you want</span></span><br><span class="line"><span class="comment">   * a non-owning reference to an object that is managed by a shared_ptr.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Unlike a raw pointer, a weak_ptr can be converted to a new shared_ptr</span></span><br><span class="line"><span class="comment">   * that shares ownership with every other shared_ptr that already owns</span></span><br><span class="line"><span class="comment">   * the pointer. In other words you can upgrade from a non-owning &quot;weak&quot;</span></span><br><span class="line"><span class="comment">   * reference to an owning shared_ptr, without having access to any of</span></span><br><span class="line"><span class="comment">   * the existing shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Also unlike a raw pointer, a weak_ptr does not become &quot;dangling&quot; after</span></span><br><span class="line"><span class="comment">   * the object it points to has been destroyed. Instead, a weak_ptr</span></span><br><span class="line"><span class="comment">   * becomes _expired_ and can no longer be converted to a shared_ptr that</span></span><br><span class="line"><span class="comment">   * owns the freed pointer, so you cannot accidentally access the pointed-to</span></span><br><span class="line"><span class="comment">   * object after it has been destroyed.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">weak_ptr</span> : <span class="keyword">public</span> __weak_ptr&lt;_Tp&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Arg&gt;</span><br><span class="line">	<span class="keyword">using</span> _Constructible = <span class="keyword">typename</span> enable_if&lt;</span><br><span class="line">	  is_constructible&lt;__weak_ptr&lt;_Tp&gt;, _Arg&gt;::value</span><br><span class="line">	&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Arg&gt;</span><br><span class="line">	<span class="keyword">using</span> _Assignable = <span class="keyword">typename</span> enable_if&lt;</span><br><span class="line">	  is_assignable&lt;__weak_ptr&lt;_Tp&gt;&amp;, _Arg&gt;::value, weak_ptr&amp;</span><br><span class="line">	&gt;::type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="function"><span class="keyword">constexpr</span> <span class="title">weak_ptr</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>= <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp,</span><br><span class="line">	       <span class="keyword">typename</span> = _Constructible&lt;<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp;&gt;&gt;</span><br><span class="line">	<span class="built_in">weak_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: __weak_ptr&lt;_Tp&gt;(__r) { }</span><br><span class="line"></span><br><span class="line">      <span class="built_in">weak_ptr</span>(<span class="type">const</span> weak_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp;&gt;&gt;</span><br><span class="line">	<span class="built_in">weak_ptr</span>(<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: __weak_ptr&lt;_Tp&gt;(__r) { }</span><br><span class="line"></span><br><span class="line">      <span class="built_in">weak_ptr</span>(weak_ptr&amp;&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Constructible&lt;weak_ptr&lt;_Yp&gt;&gt;&gt;</span><br><span class="line">	<span class="built_in">weak_ptr</span>(weak_ptr&lt;_Yp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: __weak_ptr&lt;_Tp&gt;(std::<span class="built_in">move</span>(__r)) { }</span><br><span class="line"></span><br><span class="line">      weak_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> weak_ptr&amp; __r) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> weak_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__weak_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(__r);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&lt;_Yp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__weak_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(__r);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      weak_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(weak_ptr&amp;&amp; __r) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;weak_ptr&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(weak_ptr&lt;_Yp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">this</span>-&gt;__weak_ptr&lt;_Tp&gt;::<span class="keyword">operator</span>=(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="function">shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">lock</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;_Tp&gt;(*<span class="keyword">this</span>, std::nothrow); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_deduction_guides &gt;= 201606</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">weak_ptr</span><span class="params">(shared_ptr&lt;_Tp&gt;)</span> -&gt;  weak_ptr&lt;_Tp&gt;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.3.6 weak_ptr specialized algorithms.</span></span><br><span class="line">  <span class="comment">/// Swap overload for weak_ptr</span></span><br><span class="line">  <span class="comment">/// @relates weak_ptr</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">swap</span><span class="params">(weak_ptr&lt;_Tp&gt;&amp; __a, weak_ptr&lt;_Tp&gt;&amp; __b)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{ __a.<span class="built_in">swap</span>(__b); }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Primary template owner_less</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp = <span class="type">void</span>&gt;</span><br><span class="line">    <span class="keyword">struct</span> owner_less;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Void specialization of owner_less compares either shared_ptr or weak_ptr</span></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;<span class="type">void</span>&gt; : _Sp_owner_less&lt;<span class="type">void</span>, <span class="type">void</span>&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Partial specialization of owner_less for shared_ptr.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> _Sp_owner_less&lt;shared_ptr&lt;_Tp&gt;, weak_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Partial specialization of owner_less for weak_ptr.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;weak_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> _Sp_owner_less&lt;weak_ptr&lt;_Tp&gt;, shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief Base class allowing use of member function shared_from_this.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">enable_shared_from_this</span></span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="function"><span class="keyword">constexpr</span> <span class="title">enable_shared_from_this</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>{ }</span><br><span class="line"></span><br><span class="line">      <span class="built_in">enable_shared_from_this</span>(<span class="type">const</span> enable_shared_from_this&amp;) <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      enable_shared_from_this&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> enable_shared_from_this&amp;) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> *<span class="keyword">this</span>; }</span><br><span class="line"></span><br><span class="line">      ~<span class="built_in">enable_shared_from_this</span>() { }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="function">shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">shared_from_this</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;_Tp&gt;(<span class="keyword">this</span>-&gt;_M_weak_this); }</span><br><span class="line"></span><br><span class="line">      <span class="function">shared_ptr&lt;<span class="type">const</span> _Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">shared_from_this</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;<span class="type">const</span> _Tp&gt;(<span class="keyword">this</span>-&gt;_M_weak_this); }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201402L || !defined(__STRICT_ANSI__) <span class="comment">// c++1z or gnu++11</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __cpp_lib_enable_shared_from_this 201603</span></span><br><span class="line">      <span class="function">weak_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">weak_from_this</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_weak_this; }</span><br><span class="line"></span><br><span class="line">      <span class="function">weak_ptr&lt;<span class="type">const</span> _Tp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">weak_from_this</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_weak_this; }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span><br><span class="line">	<span class="type">void</span></span><br><span class="line">	_M_weak_assign(_Tp1* __p, <span class="type">const</span> __shared_count&lt;&gt;&amp; __n) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">	{ _M_weak_this._M_assign(__p, __n); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Found by ADL when this is an associated class.</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="type">const</span> enable_shared_from_this*</span><br><span class="line">      __enable_shared_from_this_base(<span class="type">const</span> __shared_count&lt;&gt;&amp;,</span><br><span class="line">				     <span class="type">const</span> enable_shared_from_this* __p)</span><br><span class="line">      { <span class="keyword">return</span> __p; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span>, _Lock_policy&gt;</span><br><span class="line">	<span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_ptr</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">mutable</span> weak_ptr&lt;_Tp&gt;  _M_weak_this;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @relates shared_ptr @{</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Create an object that is owned by a shared_ptr.</span></span><br><span class="line"><span class="comment">   *  @param  __a     An allocator.</span></span><br><span class="line"><span class="comment">   *  @param  __args  Arguments for the @a _Tp object&#x27;s constructor.</span></span><br><span class="line"><span class="comment">   *  @return A shared_ptr that owns the newly created object.</span></span><br><span class="line"><span class="comment">   *  @throw  An exception thrown from @a _Alloc::allocate or from the</span></span><br><span class="line"><span class="comment">   *          constructor of @a _Tp.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  A copy of @a __a will be used to allocate memory for the shared_ptr</span></span><br><span class="line"><span class="comment">   *  and the new object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">allocate_shared</span><span class="params">(<span class="type">const</span> _Alloc&amp; __a, _Args&amp;&amp;... __args)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="built_in">static_assert</span>(!is_array&lt;_Tp&gt;::value, <span class="string">&quot;make_shared&lt;T[]&gt; not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;_Tp&gt;(_Sp_alloc_shared_tag&lt;_Alloc&gt;{__a},</span><br><span class="line">			     std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Create an object that is owned by a shared_ptr.</span></span><br><span class="line"><span class="comment">   *  @param  __args  Arguments for the @a _Tp object&#x27;s constructor.</span></span><br><span class="line"><span class="comment">   *  @return A shared_ptr that owns the newly created object.</span></span><br><span class="line"><span class="comment">   *  @throw  std::bad_alloc, or an exception thrown from the</span></span><br><span class="line"><span class="comment">   *          constructor of @a _Tp.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">make_shared</span><span class="params">(_Args&amp;&amp;... __args)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> std::remove_cv&lt;_Tp&gt;::type _Tp_nc;</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">allocate_shared</span>&lt;_Tp&gt;(std::<span class="built_in">allocator</span>&lt;_Tp_nc&gt;(),</span><br><span class="line">				       std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// std::hash specialization for shared_ptr.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">hash</span>&lt;shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> __hash_base&lt;<span class="type">size_t</span>, shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="function"><span class="type">size_t</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;&amp; __s)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">	<span class="keyword">return</span> std::hash&lt;<span class="keyword">typename</span> shared_ptr&lt;_Tp&gt;::element_type*&gt;()(__s.<span class="built_in">get</span>());</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @} relates shared_ptr</span></span><br><span class="line">  <span class="comment">/// @} group pointer_abstractions</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt;= 201703L</span></span><br><span class="line">  <span class="keyword">namespace</span> __detail::__variant</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span>&gt; <span class="keyword">struct</span> <span class="title class_">_Never_valueless_alt</span>; <span class="comment">// see &lt;variant&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Provide the strong exception-safety guarantee when emplacing a</span></span><br><span class="line">    <span class="comment">// shared_ptr into a variant.</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">_Never_valueless_alt</span>&lt;std::shared_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">      : std::true_type</span><br><span class="line">      { };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Provide the strong exception-safety guarantee when emplacing a</span></span><br><span class="line">    <span class="comment">// weak_ptr into a variant.</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">_Never_valueless_alt</span>&lt;std::weak_ptr&lt;_Tp&gt;&gt;</span><br><span class="line">      : std::true_type</span><br><span class="line">      { };</span><br><span class="line">  }  <span class="comment">// namespace __detail::__variant</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// C++17</span></span></span><br><span class="line"></span><br><span class="line">_GLIBCXX_END_NAMESPACE_VERSION</span><br><span class="line">} <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _SHARED_PTR_H</span></span></span><br></pre></td></tr></table></figure>
</details>

<details>
<summary>shared_ptr_base.h</summary>
<figure class="highlight cpp"><figcaption><span>shared_ptr_base.h</span><a href="/blog/downloads/code/shared_ptr/shared_ptr_base.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr and weak_ptr implementation details -*- C++ -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Copyright (C) 2007-2021 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file is part of the GNU ISO C++ Library.  This library is free</span></span><br><span class="line"><span class="comment">// software; you can redistribute it and/or modify it under the</span></span><br><span class="line"><span class="comment">// terms of the GNU General Public License as published by the</span></span><br><span class="line"><span class="comment">// Free Software Foundation; either version 3, or (at your option)</span></span><br><span class="line"><span class="comment">// any later version.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This library is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">// GNU General Public License for more details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Under Section 7 of GPL version 3, you are granted additional</span></span><br><span class="line"><span class="comment">// permissions described in the GCC Runtime Library Exception, version</span></span><br><span class="line"><span class="comment">// 3.1, as published by the Free Software Foundation.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You should have received a copy of the GNU General Public License and</span></span><br><span class="line"><span class="comment">// a copy of the GCC Runtime Library Exception along with this program;</span></span><br><span class="line"><span class="comment">// see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see</span></span><br><span class="line"><span class="comment">// &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// GCC Note: Based on files from version 1.32.0 of the Boost library.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  shared_count.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (c) 2001, 2002, 2003 Peter Dimov and Multi Media Ltd.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  shared_ptr.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 1998, 1999 Greg Colvin and Beman Dawes.</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2001, 2002, 2003 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  weak_ptr.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2001, 2002, 2003 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  enable_shared_from_this.hpp</span></span><br><span class="line"><span class="comment">//  Copyright (C) 2002 Peter Dimov</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Distributed under the Boost Software License, Version 1.0. (See</span></span><br><span class="line"><span class="comment">// accompanying file LICENSE_1_0.txt or copy at</span></span><br><span class="line"><span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** @file bits/shared_ptr_base.h</span></span><br><span class="line"><span class="comment"> *  This is an internal header file, included by other library headers.</span></span><br><span class="line"><span class="comment"> *  Do not attempt to use it directly. @headername{memory}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SHARED_PTR_BASE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SHARED_PTR_BASE_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/allocated_ptr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/allocator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/exception_defines.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/functional_hash.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/refwrap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stl_function.h&gt;</span>  <span class="comment">// std::less</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/unique_ptr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ext/aligned_buffer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ext/atomicity.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ext/concurrence.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201703L</span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;compare&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> std _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">{</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span>&gt; <span class="keyword">class</span> <span class="title class_">auto_ptr</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Exception possibly thrown by @c shared_ptr.</span></span><br><span class="line"><span class="comment">   *  @ingroup exceptions</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">bad_weak_ptr</span> : <span class="keyword">public</span> std::exception</span><br><span class="line">  {</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">char</span> <span class="type">const</span>* <span class="title">what</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">bad_weak_ptr</span>() <span class="keyword">noexcept</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Substitute for bad_weak_ptr object in the case of -fno-exceptions.</span></span><br><span class="line">  <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">  __throw_bad_weak_ptr()</span><br><span class="line">  { _GLIBCXX_THROW_OR_ABORT(<span class="built_in">bad_weak_ptr</span>()); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::_Lock_policy;</span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::__default_lock_policy;</span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::_S_single;</span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::_S_mutex;</span><br><span class="line">  <span class="keyword">using</span> __gnu_cxx::_S_atomic;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Empty helper class except when the template argument is _S_mutex.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Mutex_base</span></span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="comment">// The atomic policy uses fully-fenced builtins, single doesn&#x27;t care.</span></span><br><span class="line">      <span class="keyword">enum</span> { _S_need_barriers = <span class="number">0</span> };</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Mutex_base</span>&lt;_S_mutex&gt;</span><br><span class="line">    : <span class="keyword">public</span> __gnu_cxx::__mutex</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="comment">// This policy is used when atomic builtins are not available.</span></span><br><span class="line">      <span class="comment">// The replacement atomic operations might not have the necessary</span></span><br><span class="line">      <span class="comment">// memory barriers.</span></span><br><span class="line">      <span class="keyword">enum</span> { _S_need_barriers = <span class="number">1</span> };</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> _Sp_counted_base</span><br><span class="line">    : <span class="keyword">public</span> _Mutex_base&lt;_Lp&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      _Sp_counted_base() <span class="keyword">noexcept</span></span><br><span class="line">      : _M_use_count(<span class="number">1</span>), _M_weak_count(<span class="number">1</span>) { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span></span><br><span class="line">      ~_Sp_counted_base() <span class="keyword">noexcept</span></span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Called when _M_use_count drops to zero, to release the resources</span></span><br><span class="line">      <span class="comment">// managed by *this.</span></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_dispose() <span class="keyword">noexcept</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Called when _M_weak_count drops to zero.</span></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_destroy() <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">delete</span> <span class="keyword">this</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp;) <span class="keyword">noexcept</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_add_ref_copy()</span><br><span class="line">      { __gnu_cxx::__atomic_add_dispatch(&amp;_M_use_count, <span class="number">1</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_add_ref_lock()</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (!_M_add_ref_lock_nothrow())</span><br><span class="line">	  __throw_bad_weak_ptr();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_add_ref_lock_nothrow() <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_release() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">        <span class="comment">// Be race-detector-friendly.  For more info see bits/c++config.</span></span><br><span class="line">        _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_use_count);</span><br><span class="line">	<span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_use_count, <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">	  {</span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_use_count);</span><br><span class="line">	    _M_dispose();</span><br><span class="line">	    <span class="comment">// There must be a memory barrier between dispose() and destroy()</span></span><br><span class="line">	    <span class="comment">// to ensure that the effects of dispose() are observed in the</span></span><br><span class="line">	    <span class="comment">// thread that runs destroy().</span></span><br><span class="line">	    <span class="comment">// See http://gcc.gnu.org/ml/libstdc++/2005-11/msg00136.html</span></span><br><span class="line">	    <span class="keyword">if</span> (_Mutex_base&lt;_Lp&gt;::_S_need_barriers)</span><br><span class="line">	      {</span><br><span class="line">		__atomic_thread_fence (__ATOMIC_ACQ_REL);</span><br><span class="line">	      }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Be race-detector-friendly.  For more info see bits/c++config.</span></span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_weak_count);</span><br><span class="line">	    <span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_weak_count,</span><br><span class="line">						       <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">              {</span><br><span class="line">                _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_weak_count);</span><br><span class="line">	        _M_destroy();</span><br><span class="line">              }</span><br><span class="line">	  }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_weak_add_ref() <span class="keyword">noexcept</span></span><br><span class="line">      { __gnu_cxx::__atomic_add_dispatch(&amp;_M_weak_count, <span class="number">1</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_weak_release() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">        <span class="comment">// Be race-detector-friendly. For more info see bits/c++config.</span></span><br><span class="line">        _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_weak_count);</span><br><span class="line">	<span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_weak_count, <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">	  {</span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_weak_count);</span><br><span class="line">	    <span class="keyword">if</span> (_Mutex_base&lt;_Lp&gt;::_S_need_barriers)</span><br><span class="line">	      {</span><br><span class="line">	        <span class="comment">// See _M_release(),</span></span><br><span class="line">	        <span class="comment">// destroy() must observe results of dispose()</span></span><br><span class="line">		__atomic_thread_fence (__ATOMIC_ACQ_REL);</span><br><span class="line">	      }</span><br><span class="line">	    _M_destroy();</span><br><span class="line">	  }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span></span><br><span class="line">      _M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">        <span class="comment">// No memory barrier is used here so there is no synchronization</span></span><br><span class="line">        <span class="comment">// with other threads.</span></span><br><span class="line">        <span class="keyword">return</span> __atomic_load_n(&amp;_M_use_count, __ATOMIC_RELAXED);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Sp_counted_base(_Sp_counted_base <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">      _Sp_counted_base&amp; <span class="keyword">operator</span>=(_Sp_counted_base <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">      _Atomic_word  _M_use_count;     <span class="comment">// #shared</span></span><br><span class="line">      _Atomic_word  _M_weak_count;    <span class="comment">// #weak + (#shared != 0)</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::</span><br><span class="line">    _M_add_ref_lock_nothrow() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (_M_use_count == <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      ++_M_use_count;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    _Sp_counted_base&lt;_S_mutex&gt;::</span><br><span class="line">    _M_add_ref_lock_nothrow() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="function">__gnu_cxx::__scoped_lock <span class="title">sentry</span><span class="params">(*<span class="keyword">this</span>)</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_use_count, <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">	  _M_use_count = <span class="number">0</span>;</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    _Sp_counted_base&lt;_S_atomic&gt;::</span><br><span class="line">    _M_add_ref_lock_nothrow() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="comment">// Perform lock-free add-if-not-zero operation.</span></span><br><span class="line">      _Atomic_word __count = _M_get_use_count();</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">if</span> (__count == <span class="number">0</span>)</span><br><span class="line">	    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	  <span class="comment">// Replace the current counter value with the old value + 1, as</span></span><br><span class="line">	  <span class="comment">// long as it&#x27;s not changed meanwhile.</span></span><br><span class="line">	}</span><br><span class="line">      <span class="keyword">while</span> (!__atomic_compare_exchange_n(&amp;_M_use_count, &amp;__count, __count + <span class="number">1</span>,</span><br><span class="line">					  <span class="literal">true</span>, __ATOMIC_ACQ_REL,</span><br><span class="line">					  __ATOMIC_RELAXED));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_add_ref_copy()</span><br><span class="line">    { ++_M_use_count; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_release() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (--_M_use_count == <span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">          _M_dispose();</span><br><span class="line">          <span class="keyword">if</span> (--_M_weak_count == <span class="number">0</span>)</span><br><span class="line">            _M_destroy();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_weak_add_ref() <span class="keyword">noexcept</span></span><br><span class="line">    { ++_M_weak_count; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_weak_release() <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (--_M_weak_count == <span class="number">0</span>)</span><br><span class="line">        _M_destroy();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">long</span></span><br><span class="line">    _Sp_counted_base&lt;_S_single&gt;::_M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> _M_use_count; }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Forward declarations.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __shared_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __weak_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __enable_shared_from_this;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">shared_ptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">weak_ptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">enable_shared_from_this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __weak_count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> __shared_count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Counted ptr with no deleter or allocator support</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Sp_counted_ptr</span> <span class="keyword">final</span> : <span class="keyword">public</span> _Sp_counted_base&lt;_Lp&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">explicit</span></span><br><span class="line">      _Sp_counted_ptr(_Ptr __p) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(__p) { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_dispose() <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">delete</span> _M_ptr; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_destroy() <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">delete</span> <span class="keyword">this</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp;) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      _Sp_counted_ptr(<span class="type">const</span> _Sp_counted_ptr&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">      _Sp_counted_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> _Sp_counted_ptr&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Ptr             _M_ptr;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_ptr&lt;<span class="type">nullptr_t</span>, _S_single&gt;::_M_dispose() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_ptr&lt;<span class="type">nullptr_t</span>, _S_mutex&gt;::_M_dispose() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">    _Sp_counted_ptr&lt;<span class="type">nullptr_t</span>, _S_atomic&gt;::_M_dispose() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="type">int</span> _Nm, <span class="keyword">typename</span> _Tp,</span><br><span class="line">	   <span class="type">bool</span> __use_ebo = !__is_final(_Tp) &amp;&amp; __is_empty(_Tp)&gt;</span><br><span class="line">    <span class="keyword">struct</span> _Sp_ebo_helper;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Specialization using EBO.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="type">int</span> _Nm, <span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_ebo_helper</span>&lt;_Nm, _Tp, <span class="literal">true</span>&gt; : <span class="keyword">private</span> _Tp</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">explicit</span> _Sp_ebo_helper(<span class="type">const</span> _Tp&amp; __tp) : _Tp(__tp) { }</span><br><span class="line">      <span class="keyword">explicit</span> _Sp_ebo_helper(_Tp&amp;&amp; __tp) : _Tp(std::<span class="built_in">move</span>(__tp)) { }</span><br><span class="line"></span><br><span class="line">      <span class="type">static</span> _Tp&amp;</span><br><span class="line">      _S_get(_Sp_ebo_helper&amp; __eboh) { <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;_Tp&amp;&gt;(__eboh); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Specialization not using EBO.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="type">int</span> _Nm, <span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_ebo_helper</span>&lt;_Nm, _Tp, <span class="literal">false</span>&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">explicit</span> _Sp_ebo_helper(<span class="type">const</span> _Tp&amp; __tp) : _M_tp(__tp) { }</span><br><span class="line">      <span class="keyword">explicit</span> _Sp_ebo_helper(_Tp&amp;&amp; __tp) : _M_tp(std::<span class="built_in">move</span>(__tp)) { }</span><br><span class="line"></span><br><span class="line">      <span class="type">static</span> _Tp&amp;</span><br><span class="line">      _S_get(_Sp_ebo_helper&amp; __eboh)</span><br><span class="line">      { <span class="keyword">return</span> __eboh._M_tp; }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Tp _M_tp;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Support for custom deleter and/or allocator</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Sp_counted_deleter</span> <span class="keyword">final</span> : <span class="keyword">public</span> _Sp_counted_base&lt;_Lp&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">class</span> <span class="title class_">_Impl</span> : _Sp_ebo_helper&lt;<span class="number">0</span>, _Deleter&gt;, _Sp_ebo_helper&lt;<span class="number">1</span>, _Alloc&gt;</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">typedef</span> _Sp_ebo_helper&lt;<span class="number">0</span>, _Deleter&gt;	_Del_base;</span><br><span class="line">	<span class="keyword">typedef</span> _Sp_ebo_helper&lt;<span class="number">1</span>, _Alloc&gt;	_Alloc_base;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span>:</span><br><span class="line">	_Impl(_Ptr __p, _Deleter __d, <span class="type">const</span> _Alloc&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">	: _Del_base(std::<span class="built_in">move</span>(__d)), _Alloc_base(__a), _M_ptr(__p)</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">	_Deleter&amp; _M_del() <span class="keyword">noexcept</span> { <span class="keyword">return</span> _Del_base::_S_get(*<span class="keyword">this</span>); }</span><br><span class="line">	_Alloc&amp; _M_alloc() <span class="keyword">noexcept</span> { <span class="keyword">return</span> _Alloc_base::_S_get(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">	_Ptr _M_ptr;</span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> __allocator_type = __alloc_rebind&lt;_Alloc, _Sp_counted_deleter&gt;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// __d(__p) must not throw.</span></span><br><span class="line">      _Sp_counted_deleter(_Ptr __p, _Deleter __d) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_impl(__p, std::<span class="built_in">move</span>(__d), _Alloc()) { }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// __d(__p) must not throw.</span></span><br><span class="line">      _Sp_counted_deleter(_Ptr __p, _Deleter __d, <span class="type">const</span> _Alloc&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_impl(__p, std::<span class="built_in">move</span>(__d), __a) { }</span><br><span class="line"></span><br><span class="line">      ~_Sp_counted_deleter() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_dispose() <span class="keyword">noexcept</span></span><br><span class="line">      { _M_impl._M_del()(_M_impl._M_ptr); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_destroy() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__allocator_type __a(_M_impl._M_alloc());</span><br><span class="line">	__allocated_ptr&lt;__allocator_type&gt; __guard_ptr{ __a, <span class="keyword">this</span> };</span><br><span class="line">	<span class="keyword">this</span>-&gt;~_Sp_counted_deleter();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> type_info&amp; __ti [[__gnu__::__unused__]]) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_rtti</span></span><br><span class="line">	<span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">	<span class="comment">// 2400. shared_ptr&#x27;s get_deleter() should use addressof()</span></span><br><span class="line">        <span class="keyword">return</span> __ti == <span class="built_in">typeid</span>(_Deleter)</span><br><span class="line">	  ? std::__addressof(_M_impl._M_del())</span><br><span class="line">	  : <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Impl _M_impl;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// helpers for make_shared / allocate_shared</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_Sp_make_shared_tag</span></span><br><span class="line">  {</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, _Lock_policy _Lp&gt;</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">_Sp_counted_ptr_inplace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> type_info&amp;</span><br><span class="line">    _S_ti() <span class="keyword">noexcept</span> _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">alignas</span>(type_info) <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">char</span> __tag[<span class="built_in">sizeof</span>(type_info)] = { };</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> type_info&amp;&gt;(__tag);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> _S_eq(<span class="type">const</span> type_info&amp;) <span class="keyword">noexcept</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_alloc_shared_tag</span></span><br><span class="line">    {</span><br><span class="line">      <span class="type">const</span> _Alloc&amp; _M_a;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Sp_counted_ptr_inplace</span> <span class="keyword">final</span> : <span class="keyword">public</span> _Sp_counted_base&lt;_Lp&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">class</span> <span class="title class_">_Impl</span> : _Sp_ebo_helper&lt;<span class="number">0</span>, _Alloc&gt;</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">typedef</span> _Sp_ebo_helper&lt;<span class="number">0</span>, _Alloc&gt;	_A_base;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">explicit</span> _Impl(_Alloc __a) <span class="keyword">noexcept</span> : _A_base(__a) { }</span><br><span class="line"></span><br><span class="line">	_Alloc&amp; _M_alloc() <span class="keyword">noexcept</span> { <span class="keyword">return</span> _A_base::_S_get(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">	__gnu_cxx::__aligned_buffer&lt;_Tp&gt; _M_storage;</span><br><span class="line">      };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> __allocator_type = __alloc_rebind&lt;_Alloc, _Sp_counted_ptr_inplace&gt;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Alloc parameter is not a reference so doesn&#x27;t alias anything in __args</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	_Sp_counted_ptr_inplace(_Alloc __a, _Args&amp;&amp;... __args)</span><br><span class="line">	: _M_impl(__a)</span><br><span class="line">	{</span><br><span class="line">	  <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">	  <span class="comment">// 2070.  allocate_shared should use allocator_traits&lt;A&gt;::construct</span></span><br><span class="line">	  allocator_traits&lt;_Alloc&gt;::<span class="built_in">construct</span>(__a, _M_ptr(),</span><br><span class="line">	      std::forward&lt;_Args&gt;(__args)...); <span class="comment">// might throw</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      ~_Sp_counted_ptr_inplace() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_dispose() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	allocator_traits&lt;_Alloc&gt;::<span class="built_in">destroy</span>(_M_impl._M_alloc(), _M_ptr());</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Override because the allocator needs to know the dynamic type</span></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span></span><br><span class="line">      _M_destroy() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__allocator_type __a(_M_impl._M_alloc());</span><br><span class="line">	__allocated_ptr&lt;__allocator_type&gt; __guard_ptr{ __a, <span class="keyword">this</span> };</span><br><span class="line">	<span class="keyword">this</span>-&gt;~_Sp_counted_ptr_inplace();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_count</span>&lt;_Lp&gt;; <span class="comment">// To be able to call _M_ptr().</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// No longer used, but code compiled against old libstdc++ headers</span></span><br><span class="line">      <span class="comment">// might still call it from __shared_ptr ctor to get the pointer out.</span></span><br><span class="line">      <span class="keyword">virtual</span> <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp; __ti) <span class="keyword">noexcept</span> <span class="keyword">override</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">auto</span> __ptr = <span class="keyword">const_cast</span>&lt;<span class="keyword">typename</span> remove_cv&lt;_Tp&gt;::type*&gt;(_M_ptr());</span><br><span class="line">	<span class="comment">// Check for the fake type_info first, so we don&#x27;t try to access it</span></span><br><span class="line">	<span class="comment">// as a real type_info object. Otherwise, check if it&#x27;s the real</span></span><br><span class="line">	<span class="comment">// type_info for this class. With RTTI enabled we can check directly,</span></span><br><span class="line">	<span class="comment">// or call a library function to do it.</span></span><br><span class="line">	<span class="keyword">if</span> (&amp;__ti == &amp;_Sp_make_shared_tag::_S_ti()</span><br><span class="line">	    ||</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cpp_rtti</span></span><br><span class="line">	    __ti == <span class="built_in">typeid</span>(_Sp_make_shared_tag)</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	    _Sp_make_shared_tag::_S_eq(__ti)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	   )</span><br><span class="line">	  <span class="keyword">return</span> __ptr;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      _Tp* _M_ptr() <span class="keyword">noexcept</span> { <span class="keyword">return</span> _M_impl._M_storage._M_ptr(); }</span><br><span class="line"></span><br><span class="line">      _Impl _M_impl;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The default deleter for shared_ptr&lt;T[]&gt; and shared_ptr&lt;T[N]&gt;.</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">__sp_array_delete</span></span><br><span class="line">  {</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span></span><br><span class="line"><span class="function">      <span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(_Yp* __p)</span> <span class="type">const</span> </span>{ <span class="keyword">delete</span>[] __p; }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__shared_count</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">__not_alloc_shared_tag</span> { <span class="keyword">using</span> type = <span class="type">void</span>; };</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">__not_alloc_shared_tag</span>&lt;_Sp_alloc_shared_tag&lt;_Tp&gt;&gt; { };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">constexpr</span> __shared_count() <span class="keyword">noexcept</span> : _M_pi(<span class="number">0</span>)</span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr&gt;</span><br><span class="line">        <span class="keyword">explicit</span></span><br><span class="line">	__shared_count(_Ptr __p) : _M_pi(<span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">	  __try</span><br><span class="line">	    {</span><br><span class="line">	      _M_pi = <span class="keyword">new</span> _Sp_counted_ptr&lt;_Ptr, _Lp&gt;(__p);</span><br><span class="line">	    }</span><br><span class="line">	  __catch(...)</span><br><span class="line">	    {</span><br><span class="line">	      <span class="keyword">delete</span> __p;</span><br><span class="line">	      __throw_exception_again;</span><br><span class="line">	    }</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr&gt;</span><br><span class="line">	__shared_count(_Ptr __p, <span class="comment">/* is_array = */</span> false_type)</span><br><span class="line">	: __shared_count(__p)</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr&gt;</span><br><span class="line">	__shared_count(_Ptr __p, <span class="comment">/* is_array = */</span> true_type)</span><br><span class="line">	: __shared_count(__p, __sp_array_delete{}, <span class="built_in">allocator</span>&lt;<span class="type">void</span>&gt;())</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr, <span class="keyword">typename</span> _Deleter,</span><br><span class="line">	       <span class="keyword">typename</span> = <span class="keyword">typename</span> __not_alloc_shared_tag&lt;_Deleter&gt;::type&gt;</span><br><span class="line">	__shared_count(_Ptr __p, _Deleter __d)</span><br><span class="line">	: __shared_count(__p, std::<span class="built_in">move</span>(__d), <span class="built_in">allocator</span>&lt;<span class="type">void</span>&gt;())</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Ptr, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc,</span><br><span class="line">	       <span class="keyword">typename</span> = <span class="keyword">typename</span> __not_alloc_shared_tag&lt;_Deleter&gt;::type&gt;</span><br><span class="line">	__shared_count(_Ptr __p, _Deleter __d, _Alloc __a) : _M_pi(<span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">typedef</span> _Sp_counted_deleter&lt;_Ptr, _Deleter, _Alloc, _Lp&gt; _Sp_cd_type;</span><br><span class="line">	  __try</span><br><span class="line">	    {</span><br><span class="line">	      <span class="keyword">typename</span> _Sp_cd_type::__allocator_type __a2(__a);</span><br><span class="line">	      <span class="keyword">auto</span> __guard = std::__allocate_guarded(__a2);</span><br><span class="line">	      _Sp_cd_type* __mem = __guard.<span class="built_in">get</span>();</span><br><span class="line">	      ::<span class="keyword">new</span> (__mem) _Sp_cd_type(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a));</span><br><span class="line">	      _M_pi = __mem;</span><br><span class="line">	      __guard = <span class="literal">nullptr</span>;</span><br><span class="line">	    }</span><br><span class="line">	  __catch(...)</span><br><span class="line">	    {</span><br><span class="line">	      __d(__p); <span class="comment">// Call _Deleter on __p.</span></span><br><span class="line">	      __throw_exception_again;</span><br><span class="line">	    }</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	__shared_count(_Tp*&amp; __p, _Sp_alloc_shared_tag&lt;_Alloc&gt; __a,</span><br><span class="line">		       _Args&amp;&amp;... __args)</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">typedef</span> _Sp_counted_ptr_inplace&lt;_Tp, _Alloc, _Lp&gt; _Sp_cp_type;</span><br><span class="line">	  <span class="keyword">typename</span> _Sp_cp_type::__allocator_type __a2(__a._M_a);</span><br><span class="line">	  <span class="keyword">auto</span> __guard = std::__allocate_guarded(__a2);</span><br><span class="line">	  _Sp_cp_type* __mem = __guard.<span class="built_in">get</span>();</span><br><span class="line">	  <span class="keyword">auto</span> __pi = ::<span class="built_in">new</span> (__mem)</span><br><span class="line">	    _Sp_cp_type(__a._M_a, std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">	  __guard = <span class="literal">nullptr</span>;</span><br><span class="line">	  _M_pi = __pi;</span><br><span class="line">	  __p = __pi-&gt;_M_ptr();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="comment">// Special case for auto_ptr&lt;_Tp&gt; to provide the strong guarantee.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">        <span class="keyword">explicit</span></span><br><span class="line">	__shared_count(std::auto_ptr&lt;_Tp&gt;&amp;&amp; __r);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Special case for unique_ptr&lt;_Tp,_Del&gt; to provide the strong guarantee.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Del&gt;</span><br><span class="line">        <span class="keyword">explicit</span></span><br><span class="line">	__shared_count(std::unique_ptr&lt;_Tp, _Del&gt;&amp;&amp; __r) : _M_pi(<span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">	  <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">	  <span class="comment">// 2415. Inconsistency between unique_ptr and shared_ptr</span></span><br><span class="line">	  <span class="keyword">if</span> (__r.<span class="built_in">get</span>() == <span class="literal">nullptr</span>)</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">using</span> _Ptr = <span class="keyword">typename</span> unique_ptr&lt;_Tp, _Del&gt;::pointer;</span><br><span class="line">	  <span class="keyword">using</span> _Del2 = <span class="keyword">typename</span> conditional&lt;is_reference&lt;_Del&gt;::value,</span><br><span class="line">	      reference_wrapper&lt;<span class="keyword">typename</span> remove_reference&lt;_Del&gt;::type&gt;,</span><br><span class="line">	      _Del&gt;::type;</span><br><span class="line">	  <span class="keyword">using</span> _Sp_cd_type</span><br><span class="line">	    = _Sp_counted_deleter&lt;_Ptr, _Del2, allocator&lt;<span class="type">void</span>&gt;, _Lp&gt;;</span><br><span class="line">	  <span class="keyword">using</span> _Alloc = allocator&lt;_Sp_cd_type&gt;;</span><br><span class="line">	  <span class="keyword">using</span> _Alloc_traits = allocator_traits&lt;_Alloc&gt;;</span><br><span class="line">	  _Alloc __a;</span><br><span class="line">	  _Sp_cd_type* __mem = _Alloc_traits::<span class="built_in">allocate</span>(__a, <span class="number">1</span>);</span><br><span class="line">	  <span class="comment">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span></span><br><span class="line">	  <span class="comment">// 3548. shared_ptr construction from unique_ptr should move</span></span><br><span class="line">	  <span class="comment">// (not copy) the deleter</span></span><br><span class="line">	  _Alloc_traits::<span class="built_in">construct</span>(__a, __mem, __r.<span class="built_in">release</span>(),</span><br><span class="line">				   std::forward&lt;_Del&gt;(__r.<span class="built_in">get_deleter</span>()));</span><br><span class="line">	  _M_pi = __mem;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Throw bad_weak_ptr when __r._M_get_use_count() == 0.</span></span><br><span class="line">      <span class="keyword">explicit</span> __shared_count(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __r);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Does not throw if __r._M_get_use_count() == 0, caller must check.</span></span><br><span class="line">      <span class="keyword">explicit</span></span><br><span class="line">      __shared_count(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __r, std::<span class="type">nothrow_t</span>) <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line">      ~__shared_count() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_release();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __shared_count(<span class="type">const</span> __shared_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_pi(__r._M_pi)</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_add_ref_copy();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __shared_count&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __shared_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	<span class="keyword">if</span> (__tmp != _M_pi)</span><br><span class="line">	  {</span><br><span class="line">	    <span class="keyword">if</span> (__tmp != <span class="literal">nullptr</span>)</span><br><span class="line">	      __tmp-&gt;_M_add_ref_copy();</span><br><span class="line">	    <span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	      _M_pi-&gt;_M_release();</span><br><span class="line">	    _M_pi = __tmp;</span><br><span class="line">	  }</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_swap(__shared_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	__r._M_pi = _M_pi;</span><br><span class="line">	_M_pi = __tmp;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span></span><br><span class="line">      _M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> _M_pi ? _M_pi-&gt;_M_get_use_count() : <span class="number">0</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_unique() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_get_use_count() == <span class="number">1</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp; __ti) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> _M_pi ? _M_pi-&gt;_M_get_deleter(__ti) : <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_less(<span class="type">const</span> __shared_count&amp; __rhs) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> std::less&lt;_Sp_counted_base&lt;_Lp&gt;*&gt;()(<span class="keyword">this</span>-&gt;_M_pi, __rhs._M_pi); }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_less(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __rhs) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> std::less&lt;_Sp_counted_base&lt;_Lp&gt;*&gt;()(<span class="keyword">this</span>-&gt;_M_pi, __rhs._M_pi); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Friend function injected into enclosing namespace and found by ADL</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">      <span class="keyword">operator</span>==(<span class="type">const</span> __shared_count&amp; __a, <span class="type">const</span> __shared_count&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> __a._M_pi == __b._M_pi; }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__weak_count</span>&lt;_Lp&gt;;</span><br><span class="line"></span><br><span class="line">      _Sp_counted_base&lt;_Lp&gt;*  _M_pi;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__weak_count</span></span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">constexpr</span> __weak_count() <span class="keyword">noexcept</span> : _M_pi(<span class="literal">nullptr</span>)</span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      __weak_count(<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_pi(__r._M_pi)</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_add_ref();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count(<span class="type">const</span> __weak_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_pi(__r._M_pi)</span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_add_ref();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count(__weak_count&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_pi(__r._M_pi)</span><br><span class="line">      { __r._M_pi = <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      ~__weak_count() <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_release();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	<span class="keyword">if</span> (__tmp != <span class="literal">nullptr</span>)</span><br><span class="line">	  __tmp-&gt;_M_weak_add_ref();</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_release();</span><br><span class="line">	_M_pi = __tmp;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __weak_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	<span class="keyword">if</span> (__tmp != <span class="literal">nullptr</span>)</span><br><span class="line">	  __tmp-&gt;_M_weak_add_ref();</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_release();</span><br><span class="line">	_M_pi = __tmp;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      __weak_count&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(__weak_count&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (_M_pi != <span class="literal">nullptr</span>)</span><br><span class="line">	  _M_pi-&gt;_M_weak_release();</span><br><span class="line">	_M_pi = __r._M_pi;</span><br><span class="line">        __r._M_pi = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_swap(__weak_count&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_Sp_counted_base&lt;_Lp&gt;* __tmp = __r._M_pi;</span><br><span class="line">	__r._M_pi = _M_pi;</span><br><span class="line">	_M_pi = __tmp;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span></span><br><span class="line">      _M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> _M_pi != <span class="literal">nullptr</span> ? _M_pi-&gt;_M_get_use_count() : <span class="number">0</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_less(<span class="type">const</span> __weak_count&amp; __rhs) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> std::less&lt;_Sp_counted_base&lt;_Lp&gt;*&gt;()(<span class="keyword">this</span>-&gt;_M_pi, __rhs._M_pi); }</span><br><span class="line"></span><br><span class="line">      <span class="type">bool</span></span><br><span class="line">      _M_less(<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __rhs) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> std::less&lt;_Sp_counted_base&lt;_Lp&gt;*&gt;()(<span class="keyword">this</span>-&gt;_M_pi, __rhs._M_pi); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Friend function injected into enclosing namespace and found by ADL</span></span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">      <span class="keyword">operator</span>==(<span class="type">const</span> __weak_count&amp; __a, <span class="type">const</span> __weak_count&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> __a._M_pi == __b._M_pi; }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_count</span>&lt;_Lp&gt;;</span><br><span class="line"></span><br><span class="line">      _Sp_counted_base&lt;_Lp&gt;*  _M_pi;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now that __weak_count is defined we can define this constructor:</span></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span></span><br><span class="line">    __shared_count&lt;_Lp&gt;::__shared_count(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __r)</span><br><span class="line">    : _M_pi(__r._M_pi)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (_M_pi == <span class="literal">nullptr</span> || !_M_pi-&gt;_M_add_ref_lock_nothrow())</span><br><span class="line">	__throw_bad_weak_ptr();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now that __weak_count is defined we can define this constructor:</span></span><br><span class="line">  <span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span></span><br><span class="line">    __shared_count&lt;_Lp&gt;::</span><br><span class="line">    __shared_count(<span class="type">const</span> __weak_count&lt;_Lp&gt;&amp; __r, std::<span class="type">nothrow_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    : _M_pi(__r._M_pi)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> (_M_pi &amp;&amp; !_M_pi-&gt;_M_add_ref_lock_nothrow())</span><br><span class="line">	_M_pi = <span class="literal">nullptr</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __cpp_lib_shared_ptr_arrays 201611L</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Helper traits for shared_ptr of array:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// A pointer type Y* is said to be compatible with a pointer type T* when</span></span><br><span class="line">  <span class="comment">// either Y* is convertible to T* or Y is U[N] and T is U cv [].</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp_ptr, <span class="keyword">typename</span> _Tp_ptr&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span></span><br><span class="line">    : false_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Yp*, _Tp*&gt;</span><br><span class="line">    : is_convertible&lt;_Yp*, _Tp*&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Up(*)[_Nm], _Up(*)[]&gt;</span><br><span class="line">    : true_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Up(*)[_Nm], <span class="type">const</span> _Up(*)[]&gt;</span><br><span class="line">    : true_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Up(*)[_Nm], <span class="keyword">volatile</span> _Up(*)[]&gt;</span><br><span class="line">    : true_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_compatible_with</span>&lt;_Up(*)[_Nm], <span class="type">const</span> <span class="keyword">volatile</span> _Up(*)[]&gt;</span><br><span class="line">    : true_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Test conversion from Y(*)[N] to U(*)[N] without forming invalid type Y[N].</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm, <span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = <span class="type">void</span>&gt;</span><br><span class="line">    <span class="keyword">struct</span> __sp_is_constructible_arrN</span><br><span class="line">    : false_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible_arrN</span>&lt;_Up, _Nm, _Yp, <span class="type">__void_t</span>&lt;_Yp[_Nm]&gt;&gt;</span><br><span class="line">    : is_convertible&lt;_Yp(*)[_Nm], _Up(*)[_Nm]&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Test conversion from Y(*)[] to U(*)[] without forming invalid type Y[].</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = <span class="type">void</span>&gt;</span><br><span class="line">    <span class="keyword">struct</span> __sp_is_constructible_arr</span><br><span class="line">    : false_type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible_arr</span>&lt;_Up, _Yp, <span class="type">__void_t</span>&lt;_Yp[]&gt;&gt;</span><br><span class="line">    : is_convertible&lt;_Yp(*)[], _Up(*)[]&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Trait to check if shared_ptr&lt;T&gt; can be constructed from Y*.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When T is U[N], Y(*)[N] shall be convertible to T*;</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="type">size_t</span> _Nm, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible</span>&lt;_Up[_Nm], _Yp&gt;</span><br><span class="line">    : __sp_is_constructible_arrN&lt;_Up, _Nm, _Yp&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// when T is U[], Y(*)[] shall be convertible to T*;</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible</span>&lt;_Up[], _Yp&gt;</span><br><span class="line">    : __sp_is_constructible_arr&lt;_Up, _Yp&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// otherwise, Y* shall be convertible to T*.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__sp_is_constructible</span></span><br><span class="line">    : is_convertible&lt;_Yp*, _Tp*&gt;::type</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define operator* and operator-&gt; for shared_ptr&lt;T&gt;.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp,</span><br><span class="line">	   <span class="type">bool</span> = is_array&lt;_Tp&gt;::value, <span class="type">bool</span> = is_void&lt;_Tp&gt;::value&gt;</span><br><span class="line">    <span class="keyword">class</span> __shared_ptr_access</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = _Tp;</span><br><span class="line"></span><br><span class="line">      element_type&amp;</span><br><span class="line">      <span class="keyword">operator</span>*() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__glibcxx_assert(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> *_M_get();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      element_type*</span><br><span class="line">      <span class="keyword">operator</span>-&gt;() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_GLIBCXX_DEBUG_PEDASSERT(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> _M_get();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      element_type*</span><br><span class="line">      _M_get() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;*&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">get</span>(); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define operator-&gt; for shared_ptr&lt;cv void&gt;.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__shared_ptr_access</span>&lt;_Tp, _Lp, <span class="literal">false</span>, <span class="literal">true</span>&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = _Tp;</span><br><span class="line"></span><br><span class="line">      element_type*</span><br><span class="line">      <span class="keyword">operator</span>-&gt;() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">auto</span> __ptr = <span class="keyword">static_cast</span>&lt;<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;*&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">get</span>();</span><br><span class="line">	_GLIBCXX_DEBUG_PEDASSERT(__ptr != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> __ptr;</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define operator[] for shared_ptr&lt;T[]&gt; and shared_ptr&lt;T[N]&gt;.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__shared_ptr_access</span>&lt;_Tp, _Lp, <span class="literal">true</span>, <span class="literal">false</span>&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = <span class="keyword">typename</span> remove_extent&lt;_Tp&gt;::type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &lt;= 201402L</span></span><br><span class="line">      [[__deprecated__(<span class="string">&quot;shared_ptr&lt;T[]&gt;::operator* is absent from C++17&quot;</span>)]]</span><br><span class="line">      element_type&amp;</span><br><span class="line">      <span class="keyword">operator</span>*() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__glibcxx_assert(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> *_M_get();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      [[__deprecated__(<span class="string">&quot;shared_ptr&lt;T[]&gt;::operator-&gt; is absent from C++17&quot;</span>)]]</span><br><span class="line">      element_type*</span><br><span class="line">      <span class="keyword">operator</span>-&gt;() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	_GLIBCXX_DEBUG_PEDASSERT(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> _M_get();</span><br><span class="line">      }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      element_type&amp;</span><br><span class="line">      <span class="keyword">operator</span>[](<span class="type">ptrdiff_t</span> __i) <span class="type">const</span></span><br><span class="line">      {</span><br><span class="line">	__glibcxx_assert(_M_get() != <span class="literal">nullptr</span>);</span><br><span class="line">	__glibcxx_assert(!extent&lt;_Tp&gt;::value || __i &lt; extent&lt;_Tp&gt;::value);</span><br><span class="line">	<span class="keyword">return</span> _M_get()[__i];</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      element_type*</span><br><span class="line">      _M_get() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;*&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">get</span>(); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__shared_ptr</span></span><br><span class="line">    : <span class="keyword">public</span> __shared_ptr_access&lt;_Tp, _Lp&gt;</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = <span class="keyword">typename</span> remove_extent&lt;_Tp&gt;::type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="comment">// Constraint for taking ownership of a pointer of type _Yp*:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">using</span> _SafeConv</span><br><span class="line">	  = <span class="keyword">typename</span> enable_if&lt;__sp_is_constructible&lt;_Tp, _Yp&gt;::value&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for construction from shared_ptr and weak_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Res = <span class="type">void</span>&gt;</span><br><span class="line">	<span class="keyword">using</span> _Compatible = <span class="keyword">typename</span></span><br><span class="line">	  enable_if&lt;__sp_compatible_with&lt;_Yp*, _Tp*&gt;::value, _Res&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for assignment from shared_ptr and weak_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">using</span> _Assignable = _Compatible&lt;_Yp, __shared_ptr&amp;&gt;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for construction from unique_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Res = <span class="type">void</span>,</span><br><span class="line">	       <span class="keyword">typename</span> _Ptr = <span class="keyword">typename</span> unique_ptr&lt;_Yp, _Del&gt;::pointer&gt;</span><br><span class="line">	<span class="keyword">using</span> _UniqCompatible = <span class="type">__enable_if_t</span>&lt;__and_&lt;</span><br><span class="line">	  __sp_compatible_with&lt;_Yp*, _Tp*&gt;,</span><br><span class="line">	  is_convertible&lt;_Ptr, element_type*&gt;,</span><br><span class="line">	  is_move_constructible&lt;_Del&gt;</span><br><span class="line">	  &gt;::value, _Res&gt;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for assignment from unique_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del&gt;</span><br><span class="line">	<span class="keyword">using</span> _UniqAssignable = _UniqCompatible&lt;_Yp, _Del, __shared_ptr&amp;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201402L</span></span><br><span class="line">      <span class="keyword">using</span> weak_type = __weak_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">constexpr</span> __shared_ptr() <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(<span class="number">0</span>), _M_refcount()</span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _SafeConv&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">explicit</span></span><br><span class="line">	__shared_ptr(_Yp* __p)</span><br><span class="line">	: _M_ptr(__p), _M_refcount(__p, <span class="keyword">typename</span> is_array&lt;_Tp&gt;::<span class="built_in">type</span>())</span><br><span class="line">	{</span><br><span class="line">	  <span class="built_in">static_assert</span>( !is_void&lt;_Yp&gt;::value, <span class="string">&quot;incomplete type&quot;</span> );</span><br><span class="line">	  <span class="built_in">static_assert</span>( <span class="built_in">sizeof</span>(_Yp) &gt; <span class="number">0</span>, <span class="string">&quot;incomplete type&quot;</span> );</span><br><span class="line">	  _M_enable_shared_from_this_with(__p);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> = _SafeConv&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(_Yp* __p, _Deleter __d)</span><br><span class="line">	: _M_ptr(__p), _M_refcount(__p, std::<span class="built_in">move</span>(__d))</span><br><span class="line">	{</span><br><span class="line">	  <span class="built_in">static_assert</span>(__is_invocable&lt;_Deleter&amp;, _Yp*&amp;&gt;::value,</span><br><span class="line">	      <span class="string">&quot;deleter expression d(p) is well-formed&quot;</span>);</span><br><span class="line">	  _M_enable_shared_from_this_with(__p);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc,</span><br><span class="line">	       <span class="keyword">typename</span> = _SafeConv&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(_Yp* __p, _Deleter __d, _Alloc __a)</span><br><span class="line">	: _M_ptr(__p), _M_refcount(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a))</span><br><span class="line">	{</span><br><span class="line">	  <span class="built_in">static_assert</span>(__is_invocable&lt;_Deleter&amp;, _Yp*&amp;&gt;::value,</span><br><span class="line">	      <span class="string">&quot;deleter expression d(p) is well-formed&quot;</span>);</span><br><span class="line">	  _M_enable_shared_from_this_with(__p);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Deleter&gt;</span><br><span class="line">	__shared_ptr(<span class="type">nullptr_t</span> __p, _Deleter __d)</span><br><span class="line">	: _M_ptr(<span class="number">0</span>), _M_refcount(__p, std::<span class="built_in">move</span>(__d))</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">        __shared_ptr(<span class="type">nullptr_t</span> __p, _Deleter __d, _Alloc __a)</span><br><span class="line">	: _M_ptr(<span class="number">0</span>), _M_refcount(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a))</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Aliasing constructor</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	__shared_ptr(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r,</span><br><span class="line">		     element_type* __p) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__p), _M_refcount(__r._M_refcount) <span class="comment">// never throws</span></span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Aliasing constructor</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	__shared_ptr(__shared_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r,</span><br><span class="line">		     element_type* __p) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__p), _M_refcount()</span><br><span class="line">	{</span><br><span class="line">	  _M_refcount._M_swap(__r._M_refcount);</span><br><span class="line">	  __r._M_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      __shared_ptr(<span class="type">const</span> __shared_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line">      __shared_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> __shared_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line">      ~__shared_ptr() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__r._M_ptr), _M_refcount(__r._M_refcount)</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      __shared_ptr(__shared_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(__r._M_ptr), _M_refcount()</span><br><span class="line">      {</span><br><span class="line">	_M_refcount._M_swap(__r._M_refcount);</span><br><span class="line">	__r._M_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(__shared_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__r._M_ptr), _M_refcount()</span><br><span class="line">	{</span><br><span class="line">	  _M_refcount._M_swap(__r._M_refcount);</span><br><span class="line">	  __r._M_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	<span class="keyword">explicit</span> __shared_ptr(<span class="type">const</span> __weak_ptr&lt;_Yp, _Lp&gt;&amp; __r)</span><br><span class="line">	: _M_refcount(__r._M_refcount) <span class="comment">// may throw</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="comment">// It is now safe to copy __r._M_ptr, as</span></span><br><span class="line">	  <span class="comment">// _M_refcount(__r._M_refcount) did not throw.</span></span><br><span class="line">	  _M_ptr = __r._M_ptr;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If an exception is thrown this constructor has no effect.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del,</span><br><span class="line">	       <span class="keyword">typename</span> = _UniqCompatible&lt;_Yp, _Del&gt;&gt;</span><br><span class="line">	__shared_ptr(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	: _M_ptr(__r.<span class="built_in">get</span>()), _M_refcount()</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">auto</span> __raw = __to_address(__r.<span class="built_in">get</span>());</span><br><span class="line">	  _M_refcount = __shared_count&lt;_Lp&gt;(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  _M_enable_shared_from_this_with(__raw);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &lt;= 201402L &amp;&amp; _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="comment">// If an exception is thrown this constructor has no effect.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Del,</span><br><span class="line">	       <span class="keyword">typename</span> enable_if&lt;__and_&lt;</span><br><span class="line">		 __not_&lt;is_array&lt;_Tp&gt;&gt;, is_array&lt;_Tp1&gt;,</span><br><span class="line">	         is_convertible&lt;<span class="keyword">typename</span> unique_ptr&lt;_Tp1, _Del&gt;::pointer, _Tp*&gt;</span><br><span class="line">	       &gt;::value, <span class="type">bool</span>&gt;::type = <span class="literal">true</span>&gt;</span><br><span class="line">	__shared_ptr(unique_ptr&lt;_Tp1, _Del&gt;&amp;&amp; __r, __sp_array_delete)</span><br><span class="line">	: _M_ptr(__r.<span class="built_in">get</span>()), _M_refcount()</span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">auto</span> __raw = __to_address(__r.<span class="built_in">get</span>());</span><br><span class="line">	  _M_refcount = __shared_count&lt;_Lp&gt;(std::<span class="built_in">move</span>(__r));</span><br><span class="line">	  _M_enable_shared_from_this_with(__raw);</span><br><span class="line">	}</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="comment">// Postcondition: use_count() == 1 and __r.get() == 0</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__shared_ptr(auto_ptr&lt;_Yp&gt;&amp;&amp; __r);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">constexpr</span> __shared_ptr(<span class="type">nullptr_t</span>) <span class="keyword">noexcept</span> : __shared_ptr() { }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  _M_ptr = __r._M_ptr;</span><br><span class="line">	  _M_refcount = __r._M_refcount; <span class="comment">// __shared_count::op= doesn&#x27;t throw</span></span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _GLIBCXX_USE_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(auto_ptr&lt;_Yp&gt;&amp;&amp; __r)</span><br><span class="line">	{</span><br><span class="line">	  __shared_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      __shared_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(__shared_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__shared_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">_Yp</span>&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(__shared_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  __shared_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Del&gt;</span><br><span class="line">	_UniqAssignable&lt;_Yp, _Del&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(unique_ptr&lt;_Yp, _Del&gt;&amp;&amp; __r)</span><br><span class="line">	{</span><br><span class="line">	  __shared_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function">      <span class="title">reset</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ __shared_ptr().<span class="built_in">swap</span>(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span></span><br><span class="line"><span class="function">	_SafeConv&lt;_Yp&gt;</span></span><br><span class="line"><span class="function">	<span class="title">reset</span><span class="params">(_Yp* __p)</span> <span class="comment">// _Yp must be complete.</span></span></span><br><span class="line"><span class="function">	</span>{</span><br><span class="line">	  <span class="comment">// Catch self-reset errors.</span></span><br><span class="line">	  __glibcxx_assert(__p == <span class="literal">nullptr</span> || __p != _M_ptr);</span><br><span class="line">	  __shared_ptr(__p).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter&gt;</span></span><br><span class="line"><span class="function">	_SafeConv&lt;_Yp&gt;</span></span><br><span class="line"><span class="function">	<span class="title">reset</span><span class="params">(_Yp* __p, _Deleter __d)</span></span></span><br><span class="line"><span class="function">	</span>{ __shared_ptr(__p, std::<span class="built_in">move</span>(__d)).<span class="built_in">swap</span>(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Deleter, <span class="keyword">typename</span> _Alloc&gt;</span></span><br><span class="line"><span class="function">	_SafeConv&lt;_Yp&gt;</span></span><br><span class="line"><span class="function">	<span class="title">reset</span><span class="params">(_Yp* __p, _Deleter __d, _Alloc __a)</span></span></span><br><span class="line"><span class="function">        </span>{ __shared_ptr(__p, std::<span class="built_in">move</span>(__d), std::<span class="built_in">move</span>(__a)).<span class="built_in">swap</span>(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return the stored pointer.</span></span><br><span class="line">      <span class="function">element_type*</span></span><br><span class="line"><span class="function">      <span class="title">get</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_ptr; }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return true if the stored pointer is not null.</span></span><br><span class="line">      <span class="function"><span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_ptr != <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Return true if use_count() == 1.</span></span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">unique</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_refcount._M_unique(); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// If *this owns a pointer, return the number of owners, otherwise zero.</span></span><br><span class="line">      <span class="function"><span class="type">long</span></span></span><br><span class="line"><span class="function">      <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_refcount._M_get_use_count(); }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// Exchange both the owned pointer and the stored pointer.</span></span><br><span class="line">      <span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function">      <span class="title">swap</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;&amp; __other)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">	std::<span class="built_in">swap</span>(_M_ptr, __other._M_ptr);</span><br><span class="line">	_M_refcount._M_swap(__other._M_refcount);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/** @brief Define an ordering based on ownership.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * This function defines a strict weak ordering between two shared_ptr</span></span><br><span class="line"><span class="comment">       * or weak_ptr objects, such that one object is less than the other</span></span><br><span class="line"><span class="comment">       * unless they share ownership of the same pointer, or are both empty.</span></span><br><span class="line"><span class="comment">       * @{</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="type">bool</span></span></span><br><span class="line"><span class="function">	<span class="title">owner_before</span><span class="params">(__shared_ptr&lt;_Tp1, _Lp&gt; <span class="type">const</span>&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> _M_refcount._M_less(__rhs._M_refcount); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="type">bool</span></span></span><br><span class="line"><span class="function">	<span class="title">owner_before</span><span class="params">(__weak_ptr&lt;_Tp1, _Lp&gt; <span class="type">const</span>&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> _M_refcount._M_less(__rhs._M_refcount); }</span><br><span class="line">      <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="comment">// This constructor is non-standard, it is used by allocate_shared.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	__shared_ptr(_Sp_alloc_shared_tag&lt;_Alloc&gt; __tag, _Args&amp;&amp;... __args)</span><br><span class="line">	: _M_ptr(), _M_refcount(_M_ptr, __tag, std::forward&lt;_Args&gt;(__args)...)</span><br><span class="line">	{ _M_enable_shared_from_this_with(_M_ptr); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1, <span class="keyword">typename</span> _Alloc,</span><br><span class="line">	       <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">	<span class="keyword">friend</span> __shared_ptr&lt;_Tp1, _Lp1&gt;</span><br><span class="line">	__allocate_shared(<span class="type">const</span> _Alloc&amp; __a, _Args&amp;&amp;... __args);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This constructor is used by __weak_ptr::lock() and</span></span><br><span class="line">      <span class="comment">// shared_ptr::shared_ptr(const weak_ptr&amp;, std::nothrow_t).</span></span><br><span class="line">      __shared_ptr(<span class="type">const</span> __weak_ptr&lt;_Tp, _Lp&gt;&amp; __r, std::<span class="type">nothrow_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_refcount(__r._M_refcount, std::nothrow)</span><br><span class="line">      {</span><br><span class="line">	_M_ptr = _M_refcount._M_get_use_count() ? __r._M_ptr : <span class="literal">nullptr</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__weak_ptr</span>&lt;_Tp, _Lp&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">using</span> <span class="type">__esft_base_t</span> = <span class="keyword">decltype</span>(__enable_shared_from_this_base(</span><br><span class="line">	      std::declval&lt;<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp;&gt;(),</span><br><span class="line">	      std::<span class="built_in">declval</span>&lt;_Yp*&gt;()));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Detect an accessible and unambiguous enable_shared_from_this base.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = <span class="type">void</span>&gt;</span><br><span class="line">	<span class="keyword">struct</span> __has_esft_base</span><br><span class="line">	: false_type { };</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">__has_esft_base</span>&lt;_Yp, <span class="type">__void_t</span>&lt;<span class="type">__esft_base_t</span>&lt;_Yp&gt;&gt;&gt;</span><br><span class="line">	: __not_&lt;is_array&lt;_Tp&gt;&gt; { }; <span class="comment">// No enable shared_from_this for arrays</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Yp2 = <span class="keyword">typename</span> remove_cv&lt;_Yp&gt;::type&gt;</span><br><span class="line">	<span class="keyword">typename</span> enable_if&lt;__has_esft_base&lt;_Yp2&gt;::value&gt;::type</span><br><span class="line">	_M_enable_shared_from_this_with(_Yp* __p) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  <span class="keyword">if</span> (<span class="keyword">auto</span> __base = __enable_shared_from_this_base(_M_refcount, __p))</span><br><span class="line">	    __base-&gt;_M_weak_assign(<span class="built_in">const_cast</span>&lt;_Yp2*&gt;(__p), _M_refcount);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Yp2 = <span class="keyword">typename</span> remove_cv&lt;_Yp&gt;::type&gt;</span><br><span class="line">	<span class="keyword">typename</span> enable_if&lt;!__has_esft_base&lt;_Yp2&gt;::value&gt;::type</span><br><span class="line">	_M_enable_shared_from_this_with(_Yp*) <span class="keyword">noexcept</span></span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span>*</span><br><span class="line">      _M_get_deleter(<span class="type">const</span> std::type_info&amp; __ti) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> _M_refcount._M_get_deleter(__ti); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_ptr</span>;</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__weak_ptr</span>;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">friend</span> _Del* <span class="title">get_deleter</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp1&gt;&amp;)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Del, <span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">friend</span> _Del* <span class="title">get_deleter</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp1&gt;&amp;)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">      element_type*	   _M_ptr;         <span class="comment">// Contained pointer.</span></span><br><span class="line">      __shared_count&lt;_Lp&gt;  _M_refcount;    <span class="comment">// Reference counter.</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.7 shared_ptr comparisons</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a.<span class="built_in">get</span>() == __b.<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !__a; }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cpp_lib_three_way_comparison</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> strong_ordering</span><br><span class="line">    <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a,</span><br><span class="line">		<span class="type">const</span> __shared_ptr&lt;_Up, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> <span class="built_in">compare_three_way</span>()(__a.<span class="built_in">get</span>(), __b.<span class="built_in">get</span>()); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> strong_ordering</span><br><span class="line">    <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> pointer = <span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type*;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">compare_three_way</span>()(__a.<span class="built_in">get</span>(), <span class="built_in">static_cast</span>&lt;pointer&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>==(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !__a; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a.<span class="built_in">get</span>() != __b.<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="built_in">return</span> (<span class="type">bool</span>)__a; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>!=(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="built_in">return</span> (<span class="type">bool</span>)__a; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a,</span><br><span class="line">	      <span class="type">const</span> __shared_ptr&lt;_Up, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type;</span><br><span class="line">      <span class="keyword">using</span> _Up_elt = <span class="keyword">typename</span> __shared_ptr&lt;_Up, _Lp&gt;::element_type;</span><br><span class="line">      <span class="keyword">using</span> _Vp = <span class="keyword">typename</span> common_type&lt;_Tp_elt*, _Up_elt*&gt;::type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Vp&gt;()(__a.<span class="built_in">get</span>(), __b.<span class="built_in">get</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Tp_elt*&gt;()(__a.<span class="built_in">get</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">using</span> _Tp_elt = <span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">less</span>&lt;_Tp_elt*&gt;()(<span class="literal">nullptr</span>, __a.<span class="built_in">get</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__b &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(<span class="literal">nullptr</span> &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&lt;=(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; <span class="literal">nullptr</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	      <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> (__b &lt; __a); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> <span class="literal">nullptr</span> &lt; __a; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> __a &lt; <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, <span class="keyword">typename</span> _Tp2, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __a,</span><br><span class="line">	       <span class="type">const</span> __shared_ptr&lt;_Tp2, _Lp&gt;&amp; __b) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; __b); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, <span class="type">nullptr_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(__a &lt; <span class="literal">nullptr</span>); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">operator</span>&gt;=(<span class="type">nullptr_t</span>, <span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __a) <span class="keyword">noexcept</span></span><br><span class="line">    { <span class="keyword">return</span> !(<span class="literal">nullptr</span> &lt; __a); }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// three-way comparison</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.8 shared_ptr specialized algorithms.</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">swap</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;&amp; __a, __shared_ptr&lt;_Tp, _Lp&gt;&amp; __b)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{ __a.<span class="built_in">swap</span>(__b); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.2.9 shared_ptr casts</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The seemingly equivalent code:</span></span><br><span class="line">  <span class="comment">// shared_ptr&lt;_Tp, _Lp&gt;(static_cast&lt;_Tp*&gt;(__r.get()))</span></span><br><span class="line">  <span class="comment">// will eventually result in undefined behaviour, attempting to</span></span><br><span class="line">  <span class="comment">// delete the same object twice.</span></span><br><span class="line">  <span class="comment">/// static_pointer_cast</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">static_pointer_cast</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = __shared_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">static_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The seemingly equivalent code:</span></span><br><span class="line">  <span class="comment">// shared_ptr&lt;_Tp, _Lp&gt;(const_cast&lt;_Tp*&gt;(__r.get()))</span></span><br><span class="line">  <span class="comment">// will eventually result in undefined behaviour, attempting to</span></span><br><span class="line">  <span class="comment">// delete the same object twice.</span></span><br><span class="line">  <span class="comment">/// const_pointer_cast</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">const_pointer_cast</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = __shared_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">const_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The seemingly equivalent code:</span></span><br><span class="line">  <span class="comment">// shared_ptr&lt;_Tp, _Lp&gt;(dynamic_cast&lt;_Tp*&gt;(__r.get()))</span></span><br><span class="line">  <span class="comment">// will eventually result in undefined behaviour, attempting to</span></span><br><span class="line">  <span class="comment">// delete the same object twice.</span></span><br><span class="line">  <span class="comment">/// dynamic_pointer_cast</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">dynamic_pointer_cast</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = __shared_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">auto</span>* __p = <span class="built_in">dynamic_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()))</span><br><span class="line">	<span class="keyword">return</span> _Sp(__r, __p);</span><br><span class="line">      <span class="keyword">return</span> _Sp();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201402L</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">reinterpret_pointer_cast</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">using</span> _Sp = __shared_ptr&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">return</span> _Sp(__r, <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">typename</span> _Sp::element_type*&gt;(__r.<span class="built_in">get</span>()));</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__weak_ptr</span></span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> _Res = <span class="type">void</span>&gt;</span><br><span class="line">	<span class="keyword">using</span> _Compatible = <span class="keyword">typename</span></span><br><span class="line">	  enable_if&lt;__sp_compatible_with&lt;_Yp*, _Tp*&gt;::value, _Res&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Constraint for assignment from shared_ptr and weak_ptr:</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	<span class="keyword">using</span> _Assignable = _Compatible&lt;_Yp, __weak_ptr&amp;&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">using</span> element_type = <span class="keyword">typename</span> remove_extent&lt;_Tp&gt;::type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">constexpr</span> __weak_ptr() <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(<span class="literal">nullptr</span>), _M_refcount()</span><br><span class="line">      { }</span><br><span class="line"></span><br><span class="line">      __weak_ptr(<span class="type">const</span> __weak_ptr&amp;) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      ~__weak_ptr() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The &quot;obvious&quot; converting constructor implementation:</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">//  template&lt;typename _Tp1&gt;</span></span><br><span class="line">      <span class="comment">//    __weak_ptr(const __weak_ptr&lt;_Tp1, _Lp&gt;&amp; __r)</span></span><br><span class="line">      <span class="comment">//    : _M_ptr(__r._M_ptr), _M_refcount(__r._M_refcount) // never throws</span></span><br><span class="line">      <span class="comment">//    { }</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// has a serious problem.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">//  __r._M_ptr may already have been invalidated. The _M_ptr(__r._M_ptr)</span></span><br><span class="line">      <span class="comment">//  conversion may require access to *__r._M_ptr (virtual inheritance).</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// It is not possible to avoid spurious access violations since</span></span><br><span class="line">      <span class="comment">// in multithreaded programs __r._M_ptr may be invalidated at any point.</span></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__weak_ptr(<span class="type">const</span> __weak_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_refcount(__r._M_refcount)</span><br><span class="line">        { _M_ptr = __r.<span class="built_in">lock</span>().<span class="built_in">get</span>(); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__weak_ptr(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__r._M_ptr), _M_refcount(__r._M_refcount)</span><br><span class="line">	{ }</span><br><span class="line"></span><br><span class="line">      __weak_ptr(__weak_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      : _M_ptr(__r._M_ptr), _M_refcount(std::<span class="built_in">move</span>(__r._M_refcount))</span><br><span class="line">      { __r._M_ptr = <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp, <span class="keyword">typename</span> = _Compatible&lt;_Yp&gt;&gt;</span><br><span class="line">	__weak_ptr(__weak_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	: _M_ptr(__r.<span class="built_in">lock</span>().<span class="built_in">get</span>()), _M_refcount(std::<span class="built_in">move</span>(__r._M_refcount))</span><br><span class="line">        { __r._M_ptr = <span class="literal">nullptr</span>; }</span><br><span class="line"></span><br><span class="line">      __weak_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __weak_ptr&amp; __r) <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> __weak_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  _M_ptr = __r.<span class="built_in">lock</span>().<span class="built_in">get</span>();</span><br><span class="line">	  _M_refcount = __r._M_refcount;</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(<span class="type">const</span> __shared_ptr&lt;_Yp, _Lp&gt;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  _M_ptr = __r._M_ptr;</span><br><span class="line">	  _M_refcount = __r._M_refcount;</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      __weak_ptr&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(__weak_ptr&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	__weak_ptr(std::<span class="built_in">move</span>(__r)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Yp&gt;</span><br><span class="line">	_Assignable&lt;_Yp&gt;</span><br><span class="line">	<span class="keyword">operator</span>=(__weak_ptr&lt;_Yp, _Lp&gt;&amp;&amp; __r) <span class="keyword">noexcept</span></span><br><span class="line">	{</span><br><span class="line">	  _M_ptr = __r.<span class="built_in">lock</span>().<span class="built_in">get</span>();</span><br><span class="line">	  _M_refcount = std::<span class="built_in">move</span>(__r._M_refcount);</span><br><span class="line">	  __r._M_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">	  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">      <span class="function">__shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">lock</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __shared_ptr&lt;element_type, _Lp&gt;(*<span class="keyword">this</span>, std::nothrow); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">long</span></span></span><br><span class="line"><span class="function">      <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_refcount._M_get_use_count(); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">expired</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> _M_refcount._M_get_use_count() == <span class="number">0</span>; }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="type">bool</span></span></span><br><span class="line"><span class="function">	<span class="title">owner_before</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp1, _Lp&gt;&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> _M_refcount._M_less(__rhs._M_refcount); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span></span><br><span class="line"><span class="function">	<span class="type">bool</span></span></span><br><span class="line"><span class="function">	<span class="title">owner_before</span><span class="params">(<span class="type">const</span> __weak_ptr&lt;_Tp1, _Lp&gt;&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> _M_refcount._M_less(__rhs._M_refcount); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function">      <span class="title">reset</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ __weak_ptr().<span class="built_in">swap</span>(*<span class="keyword">this</span>); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function">      <span class="title">swap</span><span class="params">(__weak_ptr&amp; __s)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">	std::<span class="built_in">swap</span>(_M_ptr, __s._M_ptr);</span><br><span class="line">	_M_refcount._M_swap(__s._M_refcount);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="comment">// Used by __enable_shared_from_this.</span></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_assign(_Tp* __ptr, <span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __refcount) <span class="keyword">noexcept</span></span><br><span class="line">      {</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">use_count</span>() == <span class="number">0</span>)</span><br><span class="line">	  {</span><br><span class="line">	    _M_ptr = __ptr;</span><br><span class="line">	    _M_refcount = __refcount;</span><br><span class="line">	  }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_ptr</span>;</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1, _Lock_policy _Lp1&gt; <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__weak_ptr</span>;</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__enable_shared_from_this</span>&lt;_Tp, _Lp&gt;;</span><br><span class="line">      <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">enable_shared_from_this</span>&lt;_Tp&gt;;</span><br><span class="line"></span><br><span class="line">      element_type*	 _M_ptr;         <span class="comment">// Contained pointer.</span></span><br><span class="line">      __weak_count&lt;_Lp&gt;  _M_refcount;    <span class="comment">// Reference counter.</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 20.7.2.3.6 weak_ptr specialized algorithms.</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">swap</span><span class="params">(__weak_ptr&lt;_Tp, _Lp&gt;&amp; __a, __weak_ptr&lt;_Tp, _Lp&gt;&amp; __b)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>{ __a.<span class="built_in">swap</span>(__b); }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Tp1&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_owner_less</span> : <span class="keyword">public</span> binary_function&lt;_Tp, _Tp, <span class="type">bool</span>&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> _Tp&amp; __lhs, <span class="type">const</span> _Tp&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __lhs.<span class="built_in">owner_before</span>(__rhs); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> _Tp&amp; __lhs, <span class="type">const</span> _Tp1&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __lhs.<span class="built_in">owner_before</span>(__rhs); }</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="type">bool</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> _Tp1&amp; __lhs, <span class="type">const</span> _Tp&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __lhs.<span class="built_in">owner_before</span>(__rhs); }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Sp_owner_less</span>&lt;<span class="type">void</span>, <span class="type">void</span>&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Up&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">auto</span></span></span><br><span class="line"><span class="function">	<span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> _Tp&amp; __lhs, <span class="type">const</span> _Up&amp; __rhs)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">	-&gt; <span class="title">decltype</span><span class="params">(__lhs.owner_before(__rhs))</span></span></span><br><span class="line"><span class="function">	</span>{ <span class="keyword">return</span> __lhs.<span class="built_in">owner_before</span>(__rhs); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">using</span> is_transparent = <span class="type">void</span>;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;__shared_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> _Sp_owner_less&lt;__shared_ptr&lt;_Tp, _Lp&gt;, __weak_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">owner_less</span>&lt;__weak_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> _Sp_owner_less&lt;__weak_ptr&lt;_Tp, _Lp&gt;, __shared_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    { };</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">__enable_shared_from_this</span></span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">      <span class="keyword">constexpr</span> __enable_shared_from_this() <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      __enable_shared_from_this(<span class="type">const</span> __enable_shared_from_this&amp;) <span class="keyword">noexcept</span> { }</span><br><span class="line"></span><br><span class="line">      __enable_shared_from_this&amp;</span><br><span class="line">      <span class="keyword">operator</span>=(<span class="type">const</span> __enable_shared_from_this&amp;) <span class="keyword">noexcept</span></span><br><span class="line">      { <span class="keyword">return</span> *<span class="keyword">this</span>; }</span><br><span class="line"></span><br><span class="line">      ~__enable_shared_from_this() { }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      <span class="function">__shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">shared_from_this</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __shared_ptr&lt;_Tp, _Lp&gt;(<span class="keyword">this</span>-&gt;_M_weak_this); }</span><br><span class="line"></span><br><span class="line">      <span class="function">__shared_ptr&lt;<span class="type">const</span> _Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">shared_from_this</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> __shared_ptr&lt;<span class="type">const</span> _Tp, _Lp&gt;(<span class="keyword">this</span>-&gt;_M_weak_this); }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt; 201402L || !defined(__STRICT_ANSI__) <span class="comment">// c++1z or gnu++11</span></span></span><br><span class="line">      <span class="function">__weak_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">weak_from_this</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_weak_this; }</span><br><span class="line"></span><br><span class="line">      <span class="function">__weak_ptr&lt;<span class="type">const</span> _Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">      <span class="title">weak_from_this</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{ <span class="keyword">return</span> <span class="keyword">this</span>-&gt;_M_weak_this; }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp1&gt;</span><br><span class="line">	<span class="type">void</span></span><br><span class="line">	_M_weak_assign(_Tp1* __p, <span class="type">const</span> __shared_count&lt;_Lp&gt;&amp; __n) <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">	{ _M_weak_this._M_assign(__p, __n); }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">friend</span> <span class="type">const</span> __enable_shared_from_this*</span><br><span class="line">      __enable_shared_from_this_base(<span class="type">const</span> __shared_count&lt;_Lp&gt;&amp;,</span><br><span class="line">				     <span class="type">const</span> __enable_shared_from_this* __p)</span><br><span class="line">      { <span class="keyword">return</span> __p; }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">template</span>&lt;<span class="keyword">typename</span>, _Lock_policy&gt;</span><br><span class="line">	<span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">__shared_ptr</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">mutable</span> __weak_ptr&lt;_Tp, _Lp&gt;  _M_weak_this;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy,</span><br><span class="line">	   <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span><br><span class="line">    __allocate_shared(<span class="type">const</span> _Alloc&amp; __a, _Args&amp;&amp;... __args)</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">static_assert</span>(!is_array&lt;_Tp&gt;::value, <span class="string">&quot;make_shared&lt;T[]&gt; not supported&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> __shared_ptr&lt;_Tp, _Lp&gt;(_Sp_alloc_shared_tag&lt;_Alloc&gt;{__a},</span><br><span class="line">				    std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp = __default_lock_policy,</span><br><span class="line">	   <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span><br><span class="line">    __make_shared(_Args&amp;&amp;... __args)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">typename</span> std::remove_const&lt;_Tp&gt;::type _Tp_nc;</span><br><span class="line">      <span class="keyword">return</span> std::__allocate_shared&lt;_Tp, _Lp&gt;(std::<span class="built_in">allocator</span>&lt;_Tp_nc&gt;(),</span><br><span class="line">					      std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// std::hash specialization for __shared_ptr.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">hash</span>&lt;__shared_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> __hash_base&lt;<span class="type">size_t</span>, __shared_ptr&lt;_Tp, _Lp&gt;&gt;</span><br><span class="line">    {</span><br><span class="line">      <span class="function"><span class="type">size_t</span></span></span><br><span class="line"><span class="function">      <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;&amp; __s)</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">	<span class="keyword">return</span> hash&lt;<span class="keyword">typename</span> __shared_ptr&lt;_Tp, _Lp&gt;::element_type*&gt;()(</span><br><span class="line">	    __s.<span class="built_in">get</span>());</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">_GLIBCXX_END_NAMESPACE_VERSION</span><br><span class="line">} <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _SHARED_PTR_BASE_H</span></span></span><br></pre></td></tr></table></figure>
</details>

<details>
<summary>shared_ptr_atomic.h</summary>
<figure class="highlight cpp"><figcaption><span>shared_ptr_atomic.h</span><a href="/blog/downloads/code/shared_ptr/shared_ptr_atomic.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr atomic access -*- C++ -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Copyright (C) 2014-2021 Free Software Foundation, Inc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This file is part of the GNU ISO C++ Library.  This library is free</span></span><br><span class="line"><span class="comment">// software; you can redistribute it and/or modify it under the</span></span><br><span class="line"><span class="comment">// terms of the GNU General Public License as published by the</span></span><br><span class="line"><span class="comment">// Free Software Foundation; either version 3, or (at your option)</span></span><br><span class="line"><span class="comment">// any later version.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This library is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">// GNU General Public License for more details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Under Section 7 of GPL version 3, you are granted additional</span></span><br><span class="line"><span class="comment">// permissions described in the GCC Runtime Library Exception, version</span></span><br><span class="line"><span class="comment">// 3.1, as published by the Free Software Foundation.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You should have received a copy of the GNU General Public License and</span></span><br><span class="line"><span class="comment">// a copy of the GCC Runtime Library Exception along with this program;</span></span><br><span class="line"><span class="comment">// see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see</span></span><br><span class="line"><span class="comment">// &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** @file bits/shared_ptr_atomic.h</span></span><br><span class="line"><span class="comment"> *  This is an internal header file, included by other library headers.</span></span><br><span class="line"><span class="comment"> *  Do not attempt to use it directly. @headername{memory}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SHARED_PTR_ATOMIC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SHARED_PTR_ATOMIC_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/atomic_base.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> std _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">{</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @addtogroup pointer_abstractions</span></span><br><span class="line"><span class="comment">   * @{</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">/// @relates shared_ptr @{</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @cond undocumented</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_Sp_locker</span></span><br><span class="line">  {</span><br><span class="line">    _Sp_locker(<span class="type">const</span> _Sp_locker&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    _Sp_locker&amp; <span class="keyword">operator</span>=(<span class="type">const</span> _Sp_locker&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __GTHREADS</span></span><br><span class="line">    <span class="keyword">explicit</span></span><br><span class="line">    _Sp_locker(<span class="type">const</span> <span class="type">void</span>*) <span class="keyword">noexcept</span>;</span><br><span class="line">    _Sp_locker(<span class="type">const</span> <span class="type">void</span>*, <span class="type">const</span> <span class="type">void</span>*) <span class="keyword">noexcept</span>;</span><br><span class="line">    ~_Sp_locker();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _M_key1;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> _M_key2;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">explicit</span> _Sp_locker(<span class="type">const</span> <span class="type">void</span>*, <span class="type">const</span> <span class="type">void</span>* = <span class="literal">nullptr</span>) { }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @endcond</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Report whether shared_ptr atomic operations are lock-free.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @return True if atomic access to @c *__p is lock-free, false otherwise.</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_is_lock_free</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;* __p)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __GTHREADS</span></span><br><span class="line">      <span class="keyword">return</span> __gthread_active_p() == <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_is_lock_free</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;* __p)</span></span></span><br><span class="line"><span class="function">    </span>{ <span class="keyword">return</span> std::<span class="built_in">atomic_is_lock_free</span>&lt;_Tp, __default_lock_policy&gt;(__p); }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Atomic load for shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @return @c *__p</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  The memory order shall not be @c memory_order_release or</span></span><br><span class="line"><span class="comment">   *  @c memory_order_acq_rel.</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_load_explicit</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;* __p, memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      <span class="keyword">return</span> *__p;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_load</span><span class="params">(<span class="type">const</span> shared_ptr&lt;_Tp&gt;* __p)</span></span></span><br><span class="line"><span class="function">    </span>{ <span class="keyword">return</span> std::<span class="built_in">atomic_load_explicit</span>(__p, memory_order_seq_cst); }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_load_explicit</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;* __p, memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      <span class="keyword">return</span> *__p;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_load</span><span class="params">(<span class="type">const</span> __shared_ptr&lt;_Tp, _Lp&gt;* __p)</span></span></span><br><span class="line"><span class="function">    </span>{ <span class="keyword">return</span> std::<span class="built_in">atomic_load_explicit</span>(__p, memory_order_seq_cst); }</span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Atomic store for shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @param  __r The value to store.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  The memory order shall not be @c memory_order_acquire or</span></span><br><span class="line"><span class="comment">   *  @c memory_order_acq_rel.</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_store_explicit</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt; __r,</span></span></span><br><span class="line"><span class="params"><span class="function">			  memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      __p-&gt;<span class="built_in">swap</span>(__r); <span class="comment">// use swap so that **__p not destroyed while lock held</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_store</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt; __r)</span></span></span><br><span class="line"><span class="function">    </span>{ std::<span class="built_in">atomic_store_explicit</span>(__p, std::<span class="built_in">move</span>(__r), memory_order_seq_cst); }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_store_explicit</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">			  __shared_ptr&lt;_Tp, _Lp&gt; __r,</span></span></span><br><span class="line"><span class="params"><span class="function">			  memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      __p-&gt;<span class="built_in">swap</span>(__r); <span class="comment">// use swap so that **__p not destroyed while lock held</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_store</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p, __shared_ptr&lt;_Tp, _Lp&gt; __r)</span></span></span><br><span class="line"><span class="function">    </span>{ std::<span class="built_in">atomic_store_explicit</span>(__p, std::<span class="built_in">move</span>(__r), memory_order_seq_cst); }</span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Atomic exchange for shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @param  __r New value to store in @c *__p.</span></span><br><span class="line"><span class="comment">   *  @return The original value of @c *__p</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_exchange_explicit</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt; __r,</span></span></span><br><span class="line"><span class="params"><span class="function">			     memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      __p-&gt;<span class="built_in">swap</span>(__r);</span><br><span class="line">      <span class="keyword">return</span> __r;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> shared_ptr&lt;_Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_exchange</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt; __r)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_exchange_explicit</span>(__p, std::<span class="built_in">move</span>(__r),</span><br><span class="line">					   memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_exchange_explicit</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">			     __shared_ptr&lt;_Tp, _Lp&gt; __r,</span></span></span><br><span class="line"><span class="params"><span class="function">			     memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      _Sp_locker __lock{__p};</span><br><span class="line">      __p-&gt;<span class="built_in">swap</span>(__r);</span><br><span class="line">      <span class="keyword">return</span> __r;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> __shared_ptr&lt;_Tp, _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="title">atomic_exchange</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p, __shared_ptr&lt;_Tp, _Lp&gt; __r)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_exchange_explicit</span>(__p, std::<span class="built_in">move</span>(__r),</span><br><span class="line">					   memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  @brief  Atomic compare-and-swap for shared_ptr objects.</span></span><br><span class="line"><span class="comment">   *  @param  __p A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @param  __v A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @param  __w A non-null pointer to a shared_ptr object.</span></span><br><span class="line"><span class="comment">   *  @return True if @c *__p was equivalent to @c *__v, false otherwise.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *  The memory order for failure shall not be @c memory_order_release or</span></span><br><span class="line"><span class="comment">   *  @c memory_order_acq_rel, or stronger than the memory order for success.</span></span><br><span class="line"><span class="comment">   *  @{</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_strong_explicit</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">					    shared_ptr&lt;_Tp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">					    shared_ptr&lt;_Tp&gt; __w,</span></span></span><br><span class="line"><span class="params"><span class="function">					    memory_order,</span></span></span><br><span class="line"><span class="params"><span class="function">					    memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      shared_ptr&lt;_Tp&gt; __x; <span class="comment">// goes out of scope after __lock</span></span><br><span class="line">      _Sp_locker __lock{__p, __v};</span><br><span class="line">      owner_less&lt;shared_ptr&lt;_Tp&gt;&gt; __less;</span><br><span class="line">      <span class="keyword">if</span> (*__p == *__v &amp;&amp; !__less(*__p, *__v) &amp;&amp; !__less(*__v, *__p))</span><br><span class="line">	{</span><br><span class="line">	  __x = std::<span class="built_in">move</span>(*__p);</span><br><span class="line">	  *__p = std::<span class="built_in">move</span>(__w);</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	}</span><br><span class="line">      __x = std::<span class="built_in">move</span>(*__v);</span><br><span class="line">      *__v = *__p;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_strong</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">				 shared_ptr&lt;_Tp&gt; __w)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_strong_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), memory_order_seq_cst, memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_weak_explicit</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">					  shared_ptr&lt;_Tp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">					  shared_ptr&lt;_Tp&gt; __w,</span></span></span><br><span class="line"><span class="params"><span class="function">					  memory_order __success,</span></span></span><br><span class="line"><span class="params"><span class="function">					  memory_order __failure)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_strong_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), __success, __failure);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_weak</span><span class="params">(shared_ptr&lt;_Tp&gt;* __p, shared_ptr&lt;_Tp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">				 shared_ptr&lt;_Tp&gt; __w)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_weak_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), memory_order_seq_cst, memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_strong_explicit</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">					    __shared_ptr&lt;_Tp, _Lp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">					    __shared_ptr&lt;_Tp, _Lp&gt; __w,</span></span></span><br><span class="line"><span class="params"><span class="function">					    memory_order,</span></span></span><br><span class="line"><span class="params"><span class="function">					    memory_order)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      __shared_ptr&lt;_Tp, _Lp&gt; __x; <span class="comment">// goes out of scope after __lock</span></span><br><span class="line">      _Sp_locker __lock{__p, __v};</span><br><span class="line">      owner_less&lt;__shared_ptr&lt;_Tp, _Lp&gt;&gt; __less;</span><br><span class="line">      <span class="keyword">if</span> (*__p == *__v &amp;&amp; !__less(*__p, *__v) &amp;&amp; !__less(*__v, *__p))</span><br><span class="line">	{</span><br><span class="line">	  __x = std::<span class="built_in">move</span>(*__p);</span><br><span class="line">	  *__p = std::<span class="built_in">move</span>(__w);</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	}</span><br><span class="line">      __x = std::<span class="built_in">move</span>(*__v);</span><br><span class="line">      *__v = *__p;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_strong</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">				   __shared_ptr&lt;_Tp, _Lp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">				   __shared_ptr&lt;_Tp, _Lp&gt; __w)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_strong_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), memory_order_seq_cst, memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_weak_explicit</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">					  __shared_ptr&lt;_Tp, _Lp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">					  __shared_ptr&lt;_Tp, _Lp&gt; __w,</span></span></span><br><span class="line"><span class="params"><span class="function">					  memory_order __success,</span></span></span><br><span class="line"><span class="params"><span class="function">					  memory_order __failure)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_strong_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), __success, __failure);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">bool</span></span></span><br><span class="line"><span class="function">    <span class="title">atomic_compare_exchange_weak</span><span class="params">(__shared_ptr&lt;_Tp, _Lp&gt;* __p,</span></span></span><br><span class="line"><span class="params"><span class="function">				 __shared_ptr&lt;_Tp, _Lp&gt;* __v,</span></span></span><br><span class="line"><span class="params"><span class="function">				 __shared_ptr&lt;_Tp, _Lp&gt; __w)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">atomic_compare_exchange_weak_explicit</span>(__p, __v,</span><br><span class="line">	  std::<span class="built_in">move</span>(__w), memory_order_seq_cst, memory_order_seq_cst);</span><br><span class="line">    }</span><br><span class="line">  <span class="comment">/// @}</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @} relates shared_ptr</span></span><br><span class="line">  <span class="comment">/// @} group pointer_abstractions</span></span><br><span class="line"></span><br><span class="line">_GLIBCXX_END_NAMESPACE_VERSION</span><br><span class="line">} <span class="comment">// namespace</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _SHARED_PTR_ATOMIC_H</span></span></span><br></pre></td></tr></table></figure>
</details>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/01/concurrency/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/01/concurrency/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">å†…å­˜æ¨¡å‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-01 19:30:53" itemprop="dateCreated datePublished" datetime="2025-08-01T19:30:53+00:00">2025-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å†…å­˜æ¨¡å‹çš„å®šä¹‰"><a href="#å†…å­˜æ¨¡å‹çš„å®šä¹‰" class="headerlink" title="å†…å­˜æ¨¡å‹çš„å®šä¹‰"></a>å†…å­˜æ¨¡å‹çš„å®šä¹‰</h2><p>å†…å­˜æ¨¡å‹ï¼ˆMemory Modelï¼‰æ˜¯å®šä¹‰<strong>æ•°æ®ä¸€è‡´æ€§</strong>ä¸<strong>æ‰§è¡Œé¡ºåº</strong>è§„åˆ™çš„ä¸€ç»„è§„èŒƒã€‚</p>
<h2 id="å¤‡å¿˜å½•"><a href="#å¤‡å¿˜å½•" class="headerlink" title="å¤‡å¿˜å½•"></a>å¤‡å¿˜å½•</h2><ul>
<li>ç¼–ç¨‹è¯­è¨€ä¿è¯å•çº¿ç¨‹çš„â€œç¨‹åºé¡ºåºä¸€è‡´æ€§â€ï¼Œæ¯”å¦‚ä¸ºäº†é˜²æ­¢CPUä¹±åºæ‰§è¡Œï¼Œç”šè‡³ä¸»åŠ¨å¯¹æœ‰ä¾èµ–å…³ç³»çš„å˜é‡æ’å…¥å†…å­˜å±éšœã€‚</li>
<li></li>
</ul>
<h2 id="å¤šæ ¸ç¼“å­˜"><a href="#å¤šæ ¸ç¼“å­˜" class="headerlink" title="å¤šæ ¸ç¼“å­˜"></a>å¤šæ ¸ç¼“å­˜</h2><p>åˆ†å±‚ï¼š</p>
<ul>
<li>å¯„å­˜å™¨ï¼šæœ€å¿«ï¼Œç”±é‡å‘½åæœºåˆ¶ç®¡ç†</li>
<li>L1&#x2F;L2&#x2F;L3 Cacheï¼šæ ¸å¿ƒæœ¬åœ°ç¼“å­˜ï¼ŒæŒ‰ç¼“å­˜è¡Œä¸€è‡´æ€§ï¼ˆMESIï¼‰ç»´æŠ¤å…±äº«çŠ¶æ€</li>
<li>ä¸»å†…å­˜ï¼ˆDRAMï¼‰ï¼šCPUè®¿é—®éœ€ç»æ€»çº¿æˆ–å†…å­˜æ§åˆ¶å™¨</li>
</ul>
<table>
<thead>
<tr>
<th>ç¼“å­˜çº§åˆ«</th>
<th>ä½ç½®</th>
<th>é€Ÿåº¦ï¼ˆå¿«ï¼‰</th>
<th>å®¹é‡ï¼ˆå°ï¼‰</th>
<th>æ¯æ ¸ç§æœ‰&#x2F;å…±äº«</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>L1 Cache</td>
<td>CPUæ ¸å¿ƒå†…éƒ¨</td>
<td>âœ…æœ€å¿«</td>
<td>âŒæœ€å°</td>
<td>æ¯æ ¸ç§æœ‰</td>
<td>é€šå¸¸åˆ†ä¸ºæŒ‡ä»¤ç¼“å­˜ï¼ˆL1Iï¼‰å’Œæ•°æ®ç¼“å­˜ï¼ˆL1Dï¼‰</td>
</tr>
<tr>
<td>L2 Cache</td>
<td>æ ¸å¿ƒå†…éƒ¨æˆ–æ—è¾¹</td>
<td>è¾ƒå¿«</td>
<td>è¾ƒå°</td>
<td>æ¯æ ¸ç§æœ‰æˆ–å…±äº«</td>
<td>æœ‰åŠ©äºå‡ç¼“L1æœªå‘½ä¸­åçš„è®¿é—®å‹åŠ›</td>
</tr>
<tr>
<td>L3 Cache</td>
<td>æ ¸å¿ƒé›†ç¾¤å…±äº«</td>
<td>æ…¢ä¸€äº›</td>
<td>æ›´å¤§</td>
<td>å¤šæ ¸å…±äº«</td>
<td>å‡å°‘è·¨æ ¸è®¿é—®ä¸»å­˜çš„å»¶è¿Ÿï¼Œå¸¸ä½äºèŠ¯ç‰‡ä¸­å¿ƒ</td>
</tr>
<tr>
<td>L4 Cache</td>
<td>ä¸€äº›é«˜ç«¯CPUæˆ–å°è£…å¤–DRAM</td>
<td>æœ€æ…¢</td>
<td>æœ€å¤§</td>
<td>å¤šèŠ¯ç‰‡å…±äº«</td>
<td>éå¸¸å°‘è§ï¼ˆä¾‹å¦‚Intelçš„eDRAMï¼‰</td>
</tr>
</tbody></table>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[CPU Core] </span><br><span class="line">   â”œâ”€â”€ [Load Buffer]  â† å¤„ç† load æŒ‡ä»¤</span><br><span class="line">   â”œâ”€â”€ [Store Buffer] â† å¤„ç† store æŒ‡ä»¤</span><br><span class="line">   â”œâ”€â”€ [L1 Cache]</span><br><span class="line">   â””â”€â”€ [Execution Unit]</span><br><span class="line"></span><br><span class="line">â¬‡ï¸</span><br><span class="line"></span><br><span class="line">[Shared L2 Cache] / [L3 Cache]</span><br><span class="line"></span><br><span class="line">â¬‡ï¸</span><br><span class="line"></span><br><span class="line">[Memory Bus] â†” [Main Memory (DRAM)]</span><br><span class="line"></span><br><span class="line">â¬Œ</span><br><span class="line"></span><br><span class="line">[Other CPU Cores]</span><br></pre></td></tr></table></figure>

<h3 id="Store-Load-Buffer"><a href="#Store-Load-Buffer" class="headerlink" title="Store&#x2F;Load Buffer"></a>Store&#x2F;Load Buffer</h3><ul>
<li><p>Load Bufferï¼š</p>
<ul>
<li>ä½ç½®ï¼šåœ¨ CPU æ ¸å¿ƒå†…éƒ¨ï¼Œé è¿‘ Load&#x2F;Store Unitã€‚</li>
<li>åŠŸèƒ½ï¼šæš‚å­˜â€œloadâ€ï¼ˆè¯»å–ï¼‰æŒ‡ä»¤çš„ç»“æœï¼Œç­‰å¾…å†…å­˜æˆ–ç¼“å­˜è¿”å›æ•°æ®ã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šæ¯”å¦‚ä½ è®¿é—®ä¸€ä¸ªå˜é‡ xï¼Œå¦‚æœè¿˜æ²¡æ‹¿åˆ°å†…å­˜å€¼ï¼Œå®ƒå°±è¢«æ”¾åœ¨ load buffer ç­‰å¾…ã€‚</li>
</ul>
</li>
<li><p>Store Bufferï¼šä¿å­˜å°šæœªæäº¤çš„ store å†™æ“ä½œï¼ˆå»¶è¿Ÿå†™å›ï¼‰ï¼Œå¯è¢«åç»­ load æŸ¥è¯¢ï¼ˆstore-to-load forwardingï¼‰ã€‚å†…å­˜å±éšœï¼ˆmemory fenceï¼‰å¯å¼ºåˆ¶â€œå†™å…¥å®Œæˆåå†ç»§ç»­â€ã€‚</p>
<ul>
<li>ä½ç½®ï¼šåŒæ ·åœ¨ CPU æ ¸å¿ƒå†…éƒ¨ï¼Œç´§æŒ¨ Load Bufferã€‚</li>
<li>åŠŸèƒ½ï¼šå½“æ‰§è¡Œ x &#x3D; 5 è¿™æ ·çš„å†™æ“ä½œæ—¶ï¼Œå¹¶ä¸ä¼šç«‹åˆ»å†™å…¥å†…å­˜ï¼Œè€Œæ˜¯å…ˆå†™å…¥ store bufferã€‚</li>
<li>å»¶è¿Ÿå†™å›ï¼šå†™æ“ä½œä¼šè¢«å»¶åï¼Œåœ¨åˆé€‚æ—¶æœºæ‰¹é‡æäº¤åˆ°ç¼“å­˜æˆ–ä¸»å­˜ä¸­ã€‚</li>
<li>æ³¨æ„ï¼šè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å±éšœï¼ˆmemory fenceï¼‰æ¥å¼ºåˆ¶â€œå†™å…¥å®Œæˆåå†ç»§ç»­â€ã€‚</li>
</ul>
</li>
</ul>
<p>Store&#x2F;Load Bufferæ˜¯ä¸€ä¸ªå…·å¤‡è°ƒåº¦é€»è¾‘çš„æŒ‡ä»¤é˜Ÿåˆ—ï¼Œä¸æ˜¯ä¸ºäº†â€œç¼“å­˜æ•°æ®â€ã€‚<br>ä¹‹æ‰€ä»¥å«â€Bufferâ€è€Œä¸æ˜¯â€Queueâ€ï¼Œæ˜¯å¼ºè°ƒå…¶â€œä¹±åº + å¹¶å‘è°ƒåº¦èƒ½åŠ›â€ã€‚</p>
<p>ä¸æ™®é€šé˜Ÿåˆ—çš„å¯¹æ¯”ï¼š</p>
<table>
<thead>
<tr>
<th>å¯¹æ¯”é¡¹</th>
<th>æ™®é€šé˜Ÿåˆ—</th>
<th>Load Buffer</th>
</tr>
</thead>
<tbody><tr>
<td>æ•°æ®ç»“æ„</td>
<td>FIFO é˜Ÿåˆ—</td>
<td>ç±»ä¼¼ CAMï¼ˆContent Addressable Memoryï¼‰æˆ–ä¹±åºæ•°ç»„</td>
</tr>
<tr>
<td>è®¿é—®æ–¹å¼</td>
<td>ä¸€æ¬¡ pop ä¸€ä¸ª</td>
<td>ä»»æ„æ¡ç›®éƒ½èƒ½è¢«è®¿é—®ã€å‘å°„ã€å–æ¶ˆ</td>
</tr>
<tr>
<td>é¡ºåº</td>
<td>ä¸¥æ ¼é¡ºåº</td>
<td>æ”¯æŒä¹±åºå‘å°„ã€ä¹±åºå®Œæˆã€ä¹±åºæäº¤</td>
</tr>
<tr>
<td>åŠŸèƒ½</td>
<td>æš‚å­˜æ•°æ®</td>
<td>è¿½è¸ªåœ°å€ã€çŠ¶æ€ã€ä¸ Store Buffer æ¯”è¾ƒã€rollback ç­‰</td>
</tr>
</tbody></table>
<p>Intel å’Œ ARM çš„å®é™…å«æ³•</p>
<ul>
<li><p>Intel å®˜æ–¹æ¶æ„æ‰‹å†Œï¼š</p>
<ul>
<li>ç”¨è¯æ˜¯ Load Buffer &#x2F; Store Buffer</li>
<li>æœ‰æ—¶å« â€œMemory Ordering Bufferâ€</li>
</ul>
</li>
<li><p>ARM æ¶æ„ï¼ˆå¦‚ Cortex-A76ï¼‰</p>
<ul>
<li>å¸¸å«ï¼šLoad-Store Queueï¼ˆLSQï¼‰</li>
<li>è¿˜ä¼šç»†åˆ†ä¸ºï¼š<ul>
<li>Load Queueï¼ˆLQï¼‰</li>
<li>Store Queueï¼ˆSQï¼‰</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ä½†å³ä½¿å«â€œQueueâ€ï¼Œä¹Ÿä¸ä¸€å®šæ˜¯ä¸¥æ ¼çš„é˜Ÿåˆ—è¡Œä¸ºï¼Œè€Œæ˜¯è°ƒåº¦çª—å£ç»“æ„ã€‚</p>
<h3 id="ç¼“å­˜è¡Œï¼ˆCache-Lineï¼‰"><a href="#ç¼“å­˜è¡Œï¼ˆCache-Lineï¼‰" class="headerlink" title="ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰"></a>ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰</h3><ul>
<li>ä½ç½®ï¼šåœ¨ CPU çš„ç¼“å­˜ï¼ˆL1&#x2F;L2&#x2F;L3ï¼‰ä¸­ï¼Œç¼“å­˜æ˜¯ä»¥<strong>è¡Œï¼ˆlineï¼‰</strong>ä¸ºå•ä½å­˜å‚¨çš„ã€‚</li>
<li>åŠŸèƒ½ï¼šæ¯è¡Œé€šå¸¸æ˜¯ 64 å­—èŠ‚ï¼Œå®ƒæ˜¯ CPU å’Œå†…å­˜ä¹‹é—´æœ€å°çš„åŒæ­¥å•ä½ã€‚</li>
<li>çŠ¶æ€ï¼ˆMESI åè®®ï¼‰ï¼š<ul>
<li>Mï¼ˆModifiedï¼‰: ä¿®æ”¹è¿‡ï¼Œä¸»å­˜æœªåŒæ­¥</li>
<li>Eï¼ˆExclusiveï¼‰: ç‹¬å ä½†æœªä¿®æ”¹</li>
<li>Sï¼ˆSharedï¼‰: å¯å…±äº«è¯»å–</li>
<li>Iï¼ˆInvalidï¼‰: å·²å¤±æ•ˆ</li>
</ul>
</li>
</ul>
<h3 id="æ€»çº¿ï¼ˆMemory-Bus-Interconnectï¼‰"><a href="#æ€»çº¿ï¼ˆMemory-Bus-Interconnectï¼‰" class="headerlink" title="æ€»çº¿ï¼ˆMemory Bus &#x2F; Interconnectï¼‰"></a>æ€»çº¿ï¼ˆMemory Bus &#x2F; Interconnectï¼‰</h3><ul>
<li>ä½ç½®ï¼šè¿æ¥å¤šä¸ª CPU æ ¸å¿ƒã€ç¼“å­˜ã€ä¸»å­˜çš„é€šä¿¡é€šé“ã€‚</li>
<li>åŠŸèƒ½ï¼š<ul>
<li>æ•°æ®åœ¨ CPU å’Œå†…å­˜ä¹‹é—´ä¼ è¾“</li>
<li>æ‰§è¡ŒåŸå­æ“ä½œæ—¶ç”¨äºå‘é€ <code>LOCK#</code> æˆ–ç¼“å­˜ä¸€è‡´æ€§è¯·æ±‚</li>
</ul>
</li>
</ul>
<p>ğŸ”— ç¤ºä¾‹ï¼šIntel ä½¿ç”¨ Ring Busã€AMD ä½¿ç”¨ Infinity Fabricã€‚</p>
<h3 id="ä¸»å†…å­˜ï¼ˆMain-Memory-DRAMï¼‰"><a href="#ä¸»å†…å­˜ï¼ˆMain-Memory-DRAMï¼‰" class="headerlink" title="ä¸»å†…å­˜ï¼ˆMain Memory &#x2F; DRAMï¼‰"></a>ä¸»å†…å­˜ï¼ˆMain Memory &#x2F; DRAMï¼‰</h3><ul>
<li>ä½ç½®ï¼šé€šå¸¸æ˜¯ç³»ç»Ÿä¸»æ¿ä¸Šçš„ DRAM èŠ¯ç‰‡ã€‚</li>
<li>åŠŸèƒ½ï¼šå­˜å‚¨æ‰€æœ‰ä¸åœ¨ cache ä¸­çš„æ•°æ®ï¼Œè®¿é—®é€Ÿåº¦æ¯” cache æ…¢å¾ˆå¤šã€‚</li>
</ul>
<p>ğŸ•“ å»¶è¿Ÿï¼šè®¿é—®ä¸»å­˜é€šå¸¸éœ€è¦ 100ns ~ å‡ ç™¾nsï¼Œè€Œè®¿é—® L1 Cache åªéœ€å‡ ä¸ª cycleã€‚</p>
<h3 id="å†…å­˜æ§åˆ¶å™¨é€šé“ä¸æ€»çº¿çš„åŒºåˆ«"><a href="#å†…å­˜æ§åˆ¶å™¨é€šé“ä¸æ€»çº¿çš„åŒºåˆ«" class="headerlink" title="å†…å­˜æ§åˆ¶å™¨é€šé“ä¸æ€»çº¿çš„åŒºåˆ«"></a>å†…å­˜æ§åˆ¶å™¨é€šé“ä¸æ€»çº¿çš„åŒºåˆ«</h3><table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>æ€»çº¿ï¼ˆBusï¼‰</th>
<th>å†…å­˜æ§åˆ¶å™¨é€šé“ï¼ˆMemory Channelï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>ç¡¬ä»¶å±‚çº§</td>
<td>CPUã€ç¼“å­˜ã€å†…å­˜ä¹‹é—´çš„å…±äº«é€šä¿¡æ€»çº¿</td>
<td>å†…å­˜æ§åˆ¶å™¨å†…éƒ¨çš„é€šè·¯ï¼Œç›´æ¥è¿æ¥ DRAM èŠ¯ç‰‡</td>
</tr>
<tr>
<td>ä½œç”¨èŒƒå›´</td>
<td>è·¨å¤šæ ¸ã€è·¨ç¼“å­˜ï¼Œæ•´ä¸ªç³»ç»ŸèŒƒå›´</td>
<td>åªè´Ÿè´£è®¿é—®ä¸»å†…å­˜çš„æŸä¸€éƒ¨åˆ†ï¼Œç»†ç²’åº¦æ•°æ®è·¯å¾„</td>
</tr>
<tr>
<td>è¿æ¥å¯¹è±¡</td>
<td>CPUæ ¸å¿ƒã€ç¼“å­˜ã€å†…å­˜æ§åˆ¶å™¨ç­‰</td>
<td>å†…å­˜æ§åˆ¶å™¨ä¸ç‰©ç†å†…å­˜æ¡ä¹‹é—´çš„æ¥å£</td>
</tr>
<tr>
<td>ä½œç”¨</td>
<td>ä¼ é€’å†…å­˜è®¿é—®è¯·æ±‚ï¼Œå®ç°ç¼“å­˜ä¸€è‡´æ€§åè®®</td>
<td>è°ƒåº¦å†…å­˜è¯»å†™ï¼Œæ‰§è¡Œå…·ä½“å†…å­˜å‘½ä»¤</td>
</tr>
<tr>
<td>åŸå­æ“ä½œé”å®šå¯¹è±¡</td>
<td>é”å®šæ€»çº¿ï¼Œé˜»æ­¢å…¶ä»–æ ¸è®¿é—®å†…å­˜</td>
<td>é”å®šå†…å­˜é€šé“ï¼Œé˜²æ­¢åŒé€šé“å†²çªè®¿é—®</td>
</tr>
</tbody></table>
<h2 id="ä¹±åºæ‰§è¡Œ"><a href="#ä¹±åºæ‰§è¡Œ" class="headerlink" title="ä¹±åºæ‰§è¡Œ"></a>ä¹±åºæ‰§è¡Œ</h2><p>ç°ä»£ CPU é‡‡ç”¨ä¹±åºæ‰§è¡Œï¼ˆOut-of-Order Execution, OoOï¼‰ä¼˜åŒ–æ€§èƒ½ï¼š</p>
<ul>
<li>å‘å°„é¡ºåºæœ‰åºï¼ˆç¨‹åºé¡ºåºï¼‰</li>
<li>æ‰§è¡Œé¡ºåºæ— åºï¼ˆæ ¹æ®æ•°æ®&#x2F;èµ„æºä¾èµ–åŠ¨æ€è°ƒåº¦ï¼‰</li>
<li>æäº¤é¡ºåºæœ‰åºï¼ˆå€ŸåŠ© ROB ä¿è¯æäº¤çš„ç¨‹åºè¯­ä¹‰ï¼‰</li>
</ul>
<p>æ ¸å¿ƒæœºåˆ¶ï¼š</p>
<ul>
<li>æŒ‡ä»¤ä¹±åºæ‰§è¡Œï¼šç”±è°ƒåº¦å™¨å’Œæ‰§è¡Œå•å…ƒåŠ¨æ€å†³å®šæ‰§è¡Œé¡ºåºã€‚</li>
<li>å¯„å­˜å™¨é‡å‘½åï¼šä½¿ç”¨ä¸´æ—¶ç‰©ç†å¯„å­˜å™¨æ¶ˆé™¤å†™åå†™ã€å†™åè¯»å†²çªã€‚</li>
<li>Load&#x2F;Store Bufferï¼šç”¨äºæš‚å­˜å°šæœªæäº¤çš„è¯»å†™æ“ä½œã€‚</li>
<li>ROBï¼ˆReorder Bufferï¼‰ï¼šæŒ‰ç¨‹åºé¡ºåºæäº¤æŒ‡ä»¤ï¼ˆå†™å…¥å¯„å­˜å™¨&#x2F;å†…å­˜ï¼‰ï¼Œç¡®ä¿æœ€ç»ˆç»“æœå¯é¢„æµ‹ã€‚</li>
</ul>
<p>ç¨‹åºé¡ºåºä¸€è‡´æ€§ï¼ˆprogram-order consistencyï¼‰ï¼š</p>
<ul>
<li>åœ¨æœ¬çº¿ç¨‹ä¸­è§‚å¯Ÿåˆ°çš„é¡ºåºè¦â€œçœ‹èµ·æ¥åƒé¡ºåºæ‰§è¡Œâ€ã€‚</li>
<li><strong>æ³¨æ„ï¼š</strong>å¤šçº¿ç¨‹ä¸­å¯èƒ½å‡ºç°ä¹±åºæäº¤ã€‚</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">Fetch</span>         &lt;<span class="comment">-- âœ… é¡ºåºå–æŒ‡ï¼Œä»æŒ‡ä»¤ç¼“å­˜ä¸­å–å‡ºä¸‹ä¸€æ¡æŒ‡ä»¤</span></span><br><span class="line"><span class="number">2.</span> Decode        &lt;<span class="comment">-- é¡ºåºè§£ç ï¼Œåˆ†ææ“ä½œæ•°å’Œç›®çš„å¯„å­˜å™¨</span></span><br><span class="line"><span class="number">3.</span> <span class="keyword">Rename</span>        &lt;<span class="comment">-- å¯„å­˜å™¨é‡å‘½å</span></span><br><span class="line"><span class="number">4.</span> Dispatch      &lt;<span class="comment">-- æŠ•é€’åˆ°è°ƒåº¦çª—å£ï¼Œç­‰å¾…æ‰§è¡Œæ¡ä»¶æ»¡è¶³</span></span><br><span class="line"><span class="number">5.</span> <span class="keyword">Execute</span>       &lt;<span class="comment">-- âœ… ä¹±åºæ‰§è¡Œï¼ˆç”±è°ƒåº¦å™¨å†³å®šï¼‰ï¼Œå®é™…åœ¨æ‰§è¡Œå•å…ƒä¸Šè¿è¡ŒæŒ‡ä»¤</span></span><br><span class="line"><span class="number">6.</span> Writeback     &lt;<span class="comment">-- å†™ç»“æœåˆ° ROB</span></span><br><span class="line"><span class="number">7.</span> <span class="keyword">Commit</span>        &lt;<span class="comment">-- âœ… æŒ‰ç¨‹åºé¡ºåºæäº¤ï¼ˆretireï¼‰ï¼Œæ›´æ–°å¯„å­˜å™¨çŠ¶æ€æˆ–è¿›è¡Œå†…å­˜å†™å…¥</span></span><br></pre></td></tr></table></figure>

<p>TODO: <strong>å†…å­˜æ§åˆ¶å™¨</strong></p>
<p><strong>æ‰©å±•ï¼šå¯„å­˜å™¨é‡å‘½åï¼ˆRegister Renamingï¼‰</strong></p>
<p>ç°ä»£ CPU ä¸ºäº†æ”¯æŒä¹±åºæ‰§è¡Œï¼ˆOut-of-Order Executionï¼‰å’ŒæŒ‡ä»¤çº§å¹¶è¡Œï¼ˆILPï¼‰ï¼Œä¼šå¼•å…¥æ¯”æ¶æ„å¯„å­˜å™¨æ›´å¤šçš„ç‰©ç†å¯„å­˜å™¨ï¼Œæ¥å­˜å‚¨ä¸­é—´å€¼ã€‚</p>
<p>å¯„å­˜å™¨é‡å‘½åï¼šCPU ç”¨ä¸€å¼  å¯„å­˜å™¨æ˜ å°„è¡¨ï¼ˆRegister Alias Table, RATï¼‰ æ¥å°†æ¶æ„å¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å¯„å­˜å™¨ã€‚</p>
<ul>
<li>æ¶æ„å¯„å­˜å™¨ï¼šç”± ISA å®šä¹‰ï¼Œå›ºå®šä¸å˜ã€‚x86-64 æ˜¯ 16 ä¸ªé€šç”¨å¯„å­˜å™¨ã€‚</li>
<li>ç‰©ç†å¯„å­˜å™¨ï¼šç”±å…·ä½“ CPU å®ç°ï¼Œé€šå¸¸è¿œå¤šäºæ¶æ„å¯„å­˜å™¨ã€‚ä¾‹å¦‚ï¼š<ul>
<li>Intel çš„ Skylake æœ‰ 180 ä¸ªå·¦å³ç‰©ç†å¯„å­˜å™¨ï¼ˆæ•´æ•°+æµ®ç‚¹ï¼‰</li>
<li>ARM çš„ Cortex-A ç³»åˆ—ä¹Ÿæœ‰å‡ ç™¾ä¸ªç‰©ç†å¯„å­˜å™¨ï¼ˆå®é™…æ•°é‡é€šå¸¸ä¿å¯†ï¼‰</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç‰©ç†å¯„å­˜å™¨</strong>ï¼ˆPhysical Registerï¼‰</td>
<td>CPU å†…éƒ¨å®é™…ä½¿ç”¨çš„ã€å¾ˆå¤šä¸ª</td>
</tr>
<tr>
<td><strong>æ¶æ„å¯„å­˜å™¨</strong>ï¼ˆArchitectural Registerï¼‰</td>
<td>ç¨‹åºçœ‹åˆ°çš„ï¼Œä¾‹å¦‚ RAXã€RBX ç­‰ï¼Œä¸€èˆ¬åªæœ‰ 16~32 ä¸ª</td>
</tr>
</tbody></table>
<p>ä¸¾ä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MOV RAX, 1</span><br><span class="line">MOV RAX, 2</span><br><span class="line">ADD RAX, 3</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œæµç¨‹ï¼š</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>åˆ†é…çš„ç‰©ç†å¯„å­˜å™¨</th>
<th>å¯¹åº”åŠ¨ä½œ</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>RAX â†’ P1</td>
<td>P1 â† 1</td>
</tr>
<tr>
<td>2</td>
<td>RAX â†’ P2</td>
<td>P2 â† 2ï¼ˆä¸1å¯å¹¶è¡Œæ‰§è¡Œï¼‰</td>
</tr>
<tr>
<td>3</td>
<td>ç”¨ P2 + 3</td>
<td>å†™å…¥ P3ï¼ŒRAX â†’ P3</td>
</tr>
</tbody></table>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>ä¸‰æ¡æŒ‡ä»¤éƒ½å†™çš„æ˜¯ RAXï¼Œä½†å®é™…ä¸Šå†™çš„æ˜¯ ä¸åŒçš„ç‰©ç†å¯„å­˜å™¨ï¼ˆP1ã€P2ã€P3ï¼‰</li>
<li>åªæœ‰æœ€åæäº¤é˜¶æ®µæ‰æŠŠ RAX æ˜ å°„ä¸ºæœ€ç»ˆç»“æœçš„å¯„å­˜å™¨ï¼ˆP3ï¼‰</li>
</ul>
<h2 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h2><table>
<thead>
<tr>
<th>å±éšœç±»å‹</th>
<th>ä¼šé˜»æ­¢</th>
<th>ä½œç”¨è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>SFENCE</code></td>
<td>Store â†’ Store é‡æ’åº</td>
<td>å‰é¢çš„å†™å¿…é¡»å®Œæˆå†æ‰§è¡Œåé¢çš„å†™</td>
</tr>
<tr>
<td><code>LFENCE</code></td>
<td>Load â†’ Load é‡æ’åº</td>
<td>åé¢çš„è¯»å¿…é¡»ç­‰å‰é¢çš„è¯»å®Œæˆ</td>
</tr>
<tr>
<td><code>MFENCE</code></td>
<td>æ‰€æœ‰å†…å­˜è®¿é—®</td>
<td>ä¿è¯å‰é¢çš„ load&#x2F;store å…¨éƒ¨å®Œæˆ</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>ç­”æ¡ˆ</th>
</tr>
</thead>
<tbody><tr>
<td>å†…å­˜å±éšœæ˜¯è¿è¡Œæ—¶æ’å…¥çš„å—ï¼Ÿ</td>
<td>âŒ æ’å…¥æ—¶æœºæ˜¯ç¼–è¯‘æœŸï¼Œä½†è¿è¡Œæ—¶ä¼šæ‰§è¡Œå®ƒ</td>
</tr>
<tr>
<td>å±éšœå¦‚ä½•é˜»æ­¢åé¢æŒ‡ä»¤æå‰ï¼Ÿ</td>
<td>âœ… å±éšœæ‰§è¡Œæ—¶ä¼šå¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒºã€é˜»æ­¢ä¹±åºæ‰§è¡Œ</td>
</tr>
</tbody></table>
<h2 id="ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰"><a href="#ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰"></a>ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰</h2><p>MESI åè®®çš„æ ¸å¿ƒæ“ä½œï¼š</p>
<ul>
<li>è¯»ï¼ˆloadï¼‰ï¼šå¦‚æœæŸæ ¸ cache æ²¡æœ‰ï¼Œå°±ä»ä¸»å†…å­˜æˆ–å…¶ä»–æ ¸æ‹‰ä¸€ä»½ã€‚</li>
<li>å†™ï¼ˆstoreï¼‰ï¼šå¿…é¡»å…ˆè®©å…¶ä»–æ ¸çš„å¯¹åº” cache line å¤±æ•ˆï¼ˆinvalidateï¼‰ï¼Œå¦åˆ™å°±å¯èƒ½å‡ºç°æ•°æ®ç«äº‰ã€‚</li>
</ul>
<p><strong>atomicï¼ˆå“ªæ€•æ˜¯ relaxedï¼‰ä¸ºä»€ä¹ˆä¼šè§¦å‘ invalidateï¼Ÿ</strong></p>
<p>å½“ä½ å†™å…¥ä¸€ä¸ª std::atomic<int>ï¼ˆå“ªæ€•æ˜¯ relaxedï¼‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x.<span class="built_in">store</span>(<span class="number">123</span>, std::memory_order_relaxed);</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿™ä¸ª store ä¼šç¼–è¯‘ä¸ºä¸€æ¡ç‰¹æ®Šçš„æ±‡ç¼–æŒ‡ä»¤ï¼ˆå¦‚ MOV å¸¦ lock å‰ç¼€ï¼Œæˆ– STLR, STR ç­‰ï¼‰</li>
<li>CPU ä¼šå‘å‡ºæ€»çº¿äº‹åŠ¡ï¼ˆbus transactionï¼‰æˆ–åˆ©ç”¨ç¼“å­˜ä¸€è‡´æ€§åè®® å¹¿æ’­è¿™ä¸ªå†™å…¥ï¼š<ul>
<li>è®©å…¶ä»–æ ¸å¿ƒä¸­ç¼“å­˜è¿™ä¸ªå˜é‡æ‰€åœ¨ cache line çš„å‰¯æœ¬ å…¨éƒ¨å¤±æ•ˆï¼ˆInvalidateï¼‰</li>
</ul>
</li>
<li>æ‰€æœ‰æ ¸å¿ƒå¿…é¡»ä»è¿™ä¸ªæ ¸å¿ƒæˆ–ä¸»å†…å­˜è¯»å–æœ€æ–°çš„å€¼ï¼ˆä¸‹ä¸€æ¬¡ loadï¼‰</li>
</ul>
<h2 id="å†…å­˜åº"><a href="#å†…å­˜åº" class="headerlink" title="å†…å­˜åº"></a>å†…å­˜åº</h2><p>å†…å­˜åº &#x3D; ç¨‹åºä¸­è¯»å†™å†…å­˜æ“ä½œçš„å¯è§é¡ºåºã€‚</p>
<p>åœ¨ç†æƒ³ä¸–ç•Œï¼ˆé¡ºåºä¸€è‡´çš„æ¶æ„ï¼‰ä¸­ï¼Œä½ å†™çš„ä»£ç é¡ºåºå°±æ˜¯ CPU æ‰§è¡Œå’Œå…¶ä»–çº¿ç¨‹è§‚å¯Ÿåˆ°çš„é¡ºåºã€‚ä½†ç°å®ä¸­ï¼š</p>
<ul>
<li>CPU ä¼šä¹±åºæ‰§è¡Œï¼ˆout-of-orderï¼‰</li>
<li>ç¼–è¯‘å™¨ä¼šé‡æ’æŒ‡ä»¤</li>
<li>ç¼“å­˜ç³»ç»Ÿå’Œ store&#x2F;load buffer ä¼šæ‹–å»¶å†…å­˜è®¿é—®</li>
<li>å¤šæ ¸ä¹‹é—´è®¿é—®çš„æ˜¯ç¼“å­˜ï¼Œè€Œä¸æ˜¯ä¸»å†…å­˜</li>
</ul>
<p>ğŸ‘‰ æ‰€ä»¥ï¼Œéœ€è¦æœ‰ä¸€å¥—è§„åˆ™æ¥å®šä¹‰ï¼šâ€œå†…å­˜æ“ä½œåˆ°åº•æ˜¯ä½•æ—¶ã€å¦‚ä½•è¢«å…¶ä»–çº¿ç¨‹çœ‹è§çš„â€ï¼Œè¿™å°±æ˜¯å†…å­˜åºçš„ç›®æ ‡ã€‚</p>
<p>æ¦‚å¿µ <a target="_blank" rel="noopener" href="https://cppreference.cn/w/cpp/atomic/memory_order">^1</a> <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/atomic/memory_order.html">^2</a>ï¼š</p>
<ul>
<li><p><code>load</code>: ä»å†…å­˜<strong>è¯»</strong>å˜é‡çš„å€¼åˆ°CPUï¼šå†…å­˜ â CPUã€‚</p>
</li>
<li><p><code>store</code>: æŠŠä¸€ä¸ªå€¼ä» CPU çš„å¯„å­˜å™¨æˆ–å¤„ç†å•å…ƒä¸­ï¼Œ<strong>å†™</strong>åˆ°å†…å­˜ä¸­çš„æŸä¸ªåœ°å€ï¼ˆå˜é‡ï¼‰ï¼šCPU â å†…å­˜ã€‚</p>
</li>
<li><p><code>relaxed</code>: å¯¹å…¶ä»–çº¿ç¨‹çš„è¯»å†™æ²¡æœ‰åŒæ­¥æˆ–é¡ºåºçº¦æŸï¼Œä»…ä»…ä¿è¯æœ¬æ“ä½œçš„åŸå­æ€§ã€‚</p>
</li>
<li><p><code>acquire</code>: å¯¹ <code>load</code> æ“ä½œçš„å†…å­˜åºè¯­ä¹‰çº¦æŸã€‚</p>
<ul>
<li>å½“å‰çº¿ç¨‹ä¸­çš„ä»»ä½•è¯»å†™éƒ½ä¸èƒ½é‡æ’åºåˆ°æ­¤ <code>load</code> ä¹‹å‰ï¼›</li>
<li>åœ¨å…¶ä»–çº¿ç¨‹ä¸­ <code>release</code> åŒä¸€åŸå­å˜é‡çš„æ‰€æœ‰å†™å…¥åœ¨å½“å‰çº¿ç¨‹ä¸­å¯è§ã€‚</li>
</ul>
</li>
<li><p><code>release</code>: å¯¹ <code>store</code> æ“ä½œçš„å†…å­˜åºè¯­ä¹‰çº¦æŸã€‚</p>
<ul>
<li>å½“å‰çº¿ç¨‹ä¸­çš„ä»»ä½•è¯»å†™éƒ½ä¸èƒ½é‡æ’åºåˆ°æ­¤ <code>store</code> ä¹‹åï¼›</li>
<li>å½“å‰çº¿ç¨‹çš„å†™å…¥å¯¹ <code>acquire</code> åŒä¸€åŸå­å˜é‡çš„å…¶ä»–çº¿ç¨‹å¯è§ã€‚</li>
</ul>
</li>
<li><p><code>acquire-release</code>: å¯¹ <code>read-modify-write</code> æ“ä½œçš„å†…å­˜åºè¯­ä¹‰çº¦æŸã€‚</p>
<ul>
<li>å½“å‰çº¿ç¨‹ä¸­çš„ä»»ä½•è¯»å†™ä¸èƒ½é‡æ’åºåˆ°æ­¤ <code>load</code> ä¹‹å‰ï¼Œä¹Ÿä¸èƒ½é‡æ’åºåˆ°æ­¤ <code>store</code> ä¹‹åã€‚</li>
<li>å…¶ä»–çº¿ç¨‹ <code>release</code> åŒä¸€åŸå­å˜é‡çš„å†™æ“ä½œï¼Œå¯¹è¯¥ <code>modification</code> å¯è§ï¼›</li>
<li>è¯¥ <code>modification</code> å¯¹ <code>acquire</code> åŒä¸€åŸå­å˜é‡çš„å…¶ä»–çº¿ç¨‹å¯è§ã€‚</li>
</ul>
</li>
<li><p><code>sequentially-consistent</code>: </p>
<ul>
<li><code>load</code> æ“ä½œéµå¾ª <code>acquire</code> è¯­ä¹‰ï¼›</li>
<li><code>store</code> æ“ä½œéµå¾ª <code>release</code> è¯­ä¹‰ï¼›</li>
<li><code>read-modify-write</code> æ“ä½œåŒæ—¶éµå¾ª <code>acquire</code> å’Œ <code>release</code> è¯­ä¹‰ï¼›</li>
<li>å­˜åœ¨ä¸€ä¸ªå…¨åºï¼Œå…¶ä¸­æ‰€æœ‰çº¿ç¨‹éƒ½ä»¥ç›¸åŒçš„é¡ºåºè§‚å¯Ÿæ‰€æœ‰ä¿®æ”¹ã€‚</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>å†…å­˜åº</th>
<th>æ’å…¥å±éšœ</th>
<th>ç‰¹ç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>relaxed</td>
<td>âŒ æ— </td>
<td>åªä¿è¯åŸå­æ€§ï¼Œä¸ä¿è¯é¡ºåº</td>
</tr>
<tr>
<td>acquire</td>
<td>âœ… è¯»å±éšœ</td>
<td>é˜»æ­¢åç»­æ“ä½œæå‰</td>
</tr>
<tr>
<td>release</td>
<td>âœ… å†™å±éšœ</td>
<td>é˜»æ­¢å‰é¢æ“ä½œå»¶å</td>
</tr>
<tr>
<td>acquire-release</td>
<td>âœ… ä¸¤è€…éƒ½æœ‰</td>
<td>åŒå‘æœ‰åº</td>
</tr>
<tr>
<td>seq_cst</td>
<td>âœ… å…¨å±éšœ</td>
<td>å…¨å±€é¡ºåºä¸€è‡´æ€§</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>æ™®é€šå˜é‡</th>
<th>atomicï¼ˆrelaxedï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>ç¼–è¯‘å™¨å¯ä¼˜åŒ–</td>
<td>ç¼–è¯‘å™¨å¿…é¡»ä¿ç•™è¿™ä¸ªæ“ä½œ</td>
</tr>
<tr>
<td>2</td>
<td>CPU å¯èƒ½é‡æ’</td>
<td>CPU ä»å¯èƒ½é‡æ’ï¼ˆå› ä¸ºæ˜¯ relaxedï¼‰</td>
</tr>
<tr>
<td>3</td>
<td>ç¼“å­˜å†™å…¥</td>
<td>å¯èƒ½åœåœ¨æœ¬æ ¸ cache ä¸­ï¼Œä¸é€šçŸ¥ä»–äºº</td>
</tr>
<tr>
<td>4</td>
<td>ä¸è§¦å‘ invalidate</td>
<td>âœ… ä¼šè§¦å‘ cache line invalidate</td>
</tr>
<tr>
<td>5</td>
<td>å…¶ä»–çº¿ç¨‹å¯è§æ€§ä½</td>
<td>âœ… å…¶ä»–çº¿ç¨‹å¯è¯»å–åˆ°æœ€æ–°çš„å€¼ï¼ˆä½†æ—¶åºä¸ä¿è¯ï¼‰</td>
</tr>
</tbody></table>
<p><strong>ç§æ³¨ï¼š</strong> </p>
<ul>
<li><code>acquire</code>: å½“æœ¬çº¿ç¨‹è¯»å–åï¼Œæœ¬çº¿ç¨‹ä¹‹åçš„æ“ä½œéƒ½å¯ä»¥ä¾èµ–è¿™æ¬¡è¯»å–ï¼ˆâ€œåé¢çš„è¯»å†™ä¸å¾—æå‰â€ï¼‰ï¼›</li>
<li><code>release</code>: å½“æœ¬çº¿ç¨‹å…è®¸å†™åï¼Œæœ¬çº¿ç¨‹ä¹‹å‰çš„è¯»å†™éƒ½å®Œæˆäº†ï¼Œå³ä¹‹åçš„æ“ä½œéƒ½å¯ä»¥ä¾èµ–æ­¤å‰çš„å†™å…¥ï¼ˆâ€œå‰é¢çš„è¯»å†™ä¸å¾—æ»åâ€ï¼‰ã€‚</li>
</ul>
<p><strong>å’Œæ™®é€šå˜é‡ç›¸æ¯”ï¼Œatomic<T>ï¼ˆå³ä½¿æ˜¯ relaxedï¼‰åšäº†å“ªäº›é¢å¤–å·¥ä½œï¼Ÿ</strong></p>
<p>atomic<T>ï¼ˆå³ä½¿ä½¿ç”¨ memory_order_relaxedï¼‰å’Œæ™®é€šå˜é‡ç›¸æ¯”ï¼Œæœ€æ ¸å¿ƒçš„åŒºåˆ«æ˜¯ï¼šåŸå­å˜é‡ä¿è¯åŸå­æ€§ï¼ˆatomicityï¼‰å’Œå¯è§æ€§ï¼Œè€Œæ™®é€šå˜é‡ä¸èƒ½ã€‚</p>
<ul>
<li><p>ä¿è¯æ“ä½œçš„åŸå­æ€§</p>
<blockquote>
<p>æ‰€è°“â€œåŸå­æ€§â€ï¼Œæ˜¯æŒ‡æŸä¸ªæ“ä½œï¼ˆå¦‚ loadã€storeã€CASï¼‰è¦ä¹ˆå…¨éƒ¨å®Œæˆã€è¦ä¹ˆå®Œå…¨ä¸åšï¼Œä¸ä¼šå‡ºç°ä¸­é—´çŠ¶æ€ã€‚</p>
</blockquote>
<ul>
<li><p>atomic<int> x;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x.<span class="built_in">store</span>(<span class="number">42</span>, std::memory_order_relaxed);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª store æ˜¯åŸå­çš„ï¼šä¸ä¼šè¢«æ‰“æ–­ã€ä¸ä¼šè¢«åˆ†æ‹†ã€‚</p>
</li>
<li><p>æ™®é€šå˜é‡å¯èƒ½è¢«ç¼–è¯‘å™¨æˆ– CPU æ‹†æˆå¤šæ¡æŒ‡ä»¤ï¼ˆæ¯”å¦‚ä½ 4 å­—èŠ‚å’Œé«˜ 4 å­—èŠ‚åˆ†å¼€å‘ï¼‰ï¼Œå¤šçº¿ç¨‹ä¸‹å¯èƒ½çœ‹åˆ°â€œåŠæˆå“â€çŠ¶æ€ã€‚</p>
</li>
</ul>
</li>
<li><p>è§¦å‘ CPU çš„ cache coherence åè®®ï¼ˆMESIç­‰ï¼‰</p>
<blockquote>
<p>åŸå­å˜é‡çš„è®¿é—®ä¼šå‚ä¸ç¡¬ä»¶å±‚çš„ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œä»¥ä¿è¯å¤šæ ¸ CPU çœ‹åˆ°ä¸€è‡´çš„å€¼ã€‚</p>
</blockquote>
<ul>
<li>å³ä½¿æ˜¯ relaxedï¼Œstore ä¹Ÿä¼šè§¦å‘å¯¹åº” cache line çš„å†™å…¥é€šçŸ¥ï¼ˆinvalidateï¼‰ï¼›</li>
<li>æ™®é€šå˜é‡ï¼ˆé volatileã€é atomicï¼‰çš„è®¿é—®ï¼Œç¼–è¯‘å™¨ä¼šç¼“å­˜åˆ°å¯„å­˜å™¨ä¸­ï¼Œä¸ä¸€å®šä¼šå›å†™ã€‚</li>
</ul>
</li>
<li><p>ç¦æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ï¼ˆåªé’ˆå¯¹åŸå­å˜é‡æœ¬èº«ï¼‰</p>
<blockquote>
<p>ç¼–è¯‘å™¨ä¸èƒ½å°†å¤šä¸ª atomic store åˆå¹¶ï¼Œä¹Ÿä¸èƒ½åˆ å»å®ƒï¼ˆä¸ä¼šå½“ä½œâ€œæ­»ä»£ç â€ï¼‰ã€‚</p>
</blockquote>
<ul>
<li><p>x.store(42, relaxed) æ¯æ¬¡éƒ½å¿…é¡»å‘å‡ºä¸€æ¡æŒ‡ä»¤ï¼›</p>
</li>
<li><p>å¯¹æ™®é€šå˜é‡ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">42</span>;</span><br><span class="line">x = <span class="number">43</span>;</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½ç›´æ¥ç¼–è¯‘ä¸º <code>x = 43;</code>ï¼Œå‰ä¸€æ¡è¢«ä¼˜åŒ–æ‰ã€‚</p>
</li>
</ul>
</li>
</ul>
<p><strong>atomic&lt;T, relaxed&gt; ä¸åšçš„äº‹ï¼š</strong></p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>atomic(relaxed)</th>
<th>æ™®é€šå˜é‡</th>
</tr>
</thead>
<tbody><tr>
<td>ä¿è¯<strong>åŸå­æ€§</strong></td>
<td>âœ… æ˜¯</td>
<td>âŒ å¦</td>
</tr>
<tr>
<td>ä¿è¯<strong>å¯è§æ€§ï¼ˆè·¨çº¿ç¨‹ï¼‰</strong></td>
<td>âœ… æ˜¯ï¼ˆé€šè¿‡ cache åè®®ï¼‰</td>
<td>âŒ å¦</td>
</tr>
<tr>
<td>ç¦æ­¢<strong>æŒ‡ä»¤é‡æ’</strong>ï¼ˆä¿è¯é¡ºåºï¼‰</td>
<td>âŒ å¦ï¼ˆåª relaxedï¼‰</td>
<td>âŒ å¦</td>
</tr>
</tbody></table>
<h3 id="å±éšœä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸¤ç§ï¼Ÿ"><a href="#å±éšœä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸¤ç§ï¼Ÿ" class="headerlink" title="å±éšœä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸¤ç§ï¼Ÿ"></a>å±éšœä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸¤ç§ï¼Ÿ</h3><p>æ€§èƒ½ä¼˜åŒ– + æœ€å°åŒ–å¼€é”€ + ç²¾ç¡®æ§åˆ¶é‡æ’åºæ–¹å‘ã€‚</p>
<p>å±éšœçš„æœ¬è´¨æ˜¯â€œæ§åˆ¶æŒ‡ä»¤é‡æ’åºâ€<br>ä½†å®ƒå¹¶ä¸ä¸€åˆ€åˆ‡åœ°â€œå…¨éƒ¨é˜»æ­¢â€ï¼Œè€Œæ˜¯ï¼š</p>
<table>
<thead>
<tr>
<th>å±éšœç±»å‹</th>
<th>é˜»æ­¢çš„æ–¹å‘ï¼ˆç®€åŒ–ç†è§£ï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td><strong>è¯»å±éšœ</strong></td>
<td>é˜»æ­¢ <strong>è¯»-after-è¯»</strong> é‡æ’åºï¼ˆå³å‰é¢çš„è¯»å–ä¸èƒ½æ™šäºåé¢çš„è¯»å–ï¼‰</td>
</tr>
<tr>
<td><strong>å†™å±éšœ</strong></td>
<td>é˜»æ­¢ <strong>å†™-after-å†™</strong> é‡æ’åºï¼ˆå³å‰é¢çš„å†™ä¸èƒ½æ™šäºåé¢çš„å†™ï¼‰</td>
</tr>
<tr>
<td><strong>å…¨å±éšœ</strong></td>
<td>é˜»æ­¢ <strong>è¯»&#x2F;å†™ ä¸ æ‰€æœ‰åç»­æŒ‡ä»¤çš„é‡æ’åº</strong></td>
</tr>
</tbody></table>
<p>ä¸ºä»€ä¹ˆåˆ†å¼€è¿™ä¹ˆç»†ï¼Ÿï¼ˆç¡¬ä»¶è§†è§’ï¼‰</p>
<p>ç°ä»£ CPU æ¶æ„ï¼ˆå¦‚ x86, ARMï¼‰ä¸­ï¼š</p>
<ul>
<li><p>è¯»å’Œå†™é€šè·¯æ˜¯åˆ†ç¦»çš„</p>
<ul>
<li>è¯»ç”¨ load buffer</li>
<li>å†™ç”¨ store buffer</li>
</ul>
</li>
<li><p>ä¸¤è€…ä¹±åºçš„æ¨¡å¼ã€å¤„ç†æœºåˆ¶ã€æ€§èƒ½ä»£ä»·éƒ½ä¸åŒï¼</p>
</li>
</ul>
<p>æ‰€ä»¥ï¼Œç¡¬ä»¶æ”¯æŒä½ åªåŠ è¯»å±éšœï¼ˆLFENCEï¼‰æˆ–å†™å±éšœï¼ˆSFENCEï¼‰ï¼Œèƒ½ä»¥æ›´å°ä»£ä»·å®Œæˆä½ æƒ³è¦çš„é¡ºåºè¯­ä¹‰ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>å±éšœç±»å‹</th>
<th>æ•ˆæœ</th>
<th>ä¾‹å­</th>
</tr>
</thead>
<tbody><tr>
<td>ç­‰ <code>flag==1</code> åå†è¯»å– data</td>
<td><strong>è¯»å±éšœ</strong></td>
<td>ç¦æ­¢ <code>data = ?</code> æå‰æ‰§è¡Œ</td>
<td>load-acquire fence</td>
</tr>
<tr>
<td><code>data=42</code> åï¼Œæ‰å†™ <code>flag=1</code></td>
<td><strong>å†™å±éšœ</strong></td>
<td>ç¦æ­¢ <code>flag=1</code> æå‰å†™å‡º</td>
<td>store-release fence</td>
</tr>
<tr>
<td>å¤šçº¿ç¨‹é€šä¿¡ä¸­ï¼Œå¼ºä¸€è‡´é¡ºåº</td>
<td><strong>å…¨å±éšœ</strong></td>
<td>æ‰€æœ‰è¯»å†™é¡ºåºå®Œå…¨ç¦æ­¢é‡æ’</td>
<td>x86 <code>MFENCE</code></td>
</tr>
</tbody></table>
<ul>
<li>ä½ å¯ä»¥åªé˜»æ­¢è¯»ä¹±åº â†’ è¯»å±éšœ</li>
<li>ä½ å¯ä»¥åªé˜»æ­¢å†™ä¹±åº â†’ å†™å±éšœ</li>
<li>ä½ å¯ä»¥å…¨éƒ¨é˜»æ­¢ â†’ å…¨å±éšœ</li>
</ul>
<h2 id="åŸå­æ“ä½œ"><a href="#åŸå­æ“ä½œ" class="headerlink" title="åŸå­æ“ä½œ"></a>åŸå­æ“ä½œ</h2><table>
<thead>
<tr>
<th>å±‚æ¬¡</th>
<th>æœºåˆ¶</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>æŒ‡ä»¤å±‚</td>
<td>åŸå­æŒ‡ä»¤ï¼ˆå¦‚ <code>lock cmpxchg</code>ã€<code>xadd</code>ã€<code>ldrex/strex</code>ï¼‰</td>
<td>æä¾›ä¸å¯ä¸­æ–­çš„æ‰§è¡Œ</td>
</tr>
<tr>
<td>ç¼“å­˜å±‚</td>
<td>MESI åè®®</td>
<td>ä¿è¯å¤šä¸ªCPUç¼“å­˜æ•°æ®ä¸€è‡´</td>
</tr>
<tr>
<td>æ€»çº¿å±‚</td>
<td>æ€»çº¿é”å®šï¼ˆæ—§æ–¹å¼ï¼‰</td>
<td>å¼ºåˆ¶æ‰€æœ‰æ ¸ç­‰å¾…è¯¥æ“ä½œå®Œæˆ</td>
</tr>
<tr>
<td>å†…å­˜å±‚</td>
<td>å†…å­˜å±éšœ</td>
<td>ä¿è¯å†…å­˜æ“ä½œé¡ºåºæ­£ç¡®å¯è§</td>
</tr>
</tbody></table>
<h3 id="CPUçš„åŸå­æŒ‡ä»¤å¦‚ä½•å®ç°çš„ï¼Ÿ"><a href="#CPUçš„åŸå­æŒ‡ä»¤å¦‚ä½•å®ç°çš„ï¼Ÿ" class="headerlink" title="CPUçš„åŸå­æŒ‡ä»¤å¦‚ä½•å®ç°çš„ï¼Ÿ"></a>CPUçš„åŸå­æŒ‡ä»¤å¦‚ä½•å®ç°çš„ï¼Ÿ</h3><p>CPU çš„åŸå­æŒ‡ä»¤æ˜¯åœ¨ç¡¬ä»¶å¾®æ¶æ„å±‚é¢é€šè¿‡å¾®æ“ä½œï¼ˆmicro-opsï¼‰è°ƒåº¦ã€ç¼“å­˜æ§åˆ¶ã€æ€»çº¿åè®®åè°ƒç­‰æœºåˆ¶è”åˆå®ç°çš„ã€‚æˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªå±‚é¢æ¥è¯¦ç»†å‰–æï¼š</p>
<h4 id="å¾®æ¶æ„å±‚é¢ï¼šé”ä½ç‰¹å®šèµ„æº"><a href="#å¾®æ¶æ„å±‚é¢ï¼šé”ä½ç‰¹å®šèµ„æº" class="headerlink" title="å¾®æ¶æ„å±‚é¢ï¼šé”ä½ç‰¹å®šèµ„æº"></a>å¾®æ¶æ„å±‚é¢ï¼šé”ä½ç‰¹å®šèµ„æº</h4><p>å½“æ‰§è¡ŒåŸå­æŒ‡ä»¤æ—¶ï¼ŒCPU å†…éƒ¨ä¼šé‡‡å– é”å®šæœºåˆ¶ï¼Œç¡®ä¿è¯¥æ“ä½œçš„æ‰€æœ‰å­æ­¥éª¤åœ¨æ‰§è¡Œæ—¶ä¸ä¼šè¢«æ‰“æ–­ã€‚</p>
<ul>
<li>å¯¹äºè®¿é—®å†…å­˜çš„åŸå­æ“ä½œï¼ŒCPU ä¼šå°è¯•é”å®šï¼š<ul>
<li>ç¼“å­˜è¡Œï¼ˆç°ä»£ CPUï¼‰</li>
<li>æˆ–å†…å­˜æ€»çº¿ï¼ˆæ—§ CPUï¼‰</li>
</ul>
</li>
</ul>
<p>ä»¥ x86 çš„ LOCK CMPXCHG ä¸ºä¾‹ï¼Œå®ƒå†…éƒ¨å…¶å®æ˜¯ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mem == eax) &#123;</span><br><span class="line">    mem = reg;</span><br><span class="line">    ZF = <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    eax = mem;</span><br><span class="line">    ZF = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæµç¨‹åœ¨ç¡¬ä»¶ä¸­ä¸æ˜¯ä¸‰æ¡æŒ‡ä»¤ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“é—¨çš„å¾®æ“ä½œæŒ‡ä»¤ç»„åˆåŒ…ï¼Œç§°ä¸ºâ€œfused micro-opâ€ï¼Œç”± CPU ä¿è¯â€œæ‰§è¡ŒæœŸé—´ä¸­æ–­å…³é—­ã€ç¦æ­¢æŠ¢å â€ã€‚</p>
<h4 id="ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰ä¿éšœåŸå­æ€§"><a href="#ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰ä¿éšœåŸå­æ€§" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰ä¿éšœåŸå­æ€§"></a>ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰ä¿éšœåŸå­æ€§</h4><p>åŸå­æŒ‡ä»¤é€šå¸¸è®¿é—®å…±äº«å˜é‡ï¼Œè¿™å°±éœ€è¦è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<p>ä¸¾ä¾‹ï¼šä¸¤ä¸ª CPU éƒ½ç¼“å­˜äº†æŸä¸ªå…±äº«å˜é‡çš„å€¼<br>å½“ CPU1 æ‰§è¡ŒåŸå­å†™å…¥ï¼ˆä¾‹å¦‚ lock xaddï¼‰æ—¶ï¼š</p>
<p>CPU1 ä¼šå°è¯•å°†è¯¥ç¼“å­˜è¡Œä» Shared â†’ Modified çŠ¶æ€</p>
<p>MESI åè®®è¦æ±‚å…¶ä»– CPUï¼ˆå¦‚ CPU2ï¼‰å°†è¯¥ç¼“å­˜è¡Œæ ‡è®°ä¸º Invalid</p>
<p>ä¸€æ—¦ç‹¬å ï¼ŒCPU1 å°±èƒ½å®‰å…¨å®Œæˆè¯»-æ”¹-å†™è¿‡ç¨‹</p>
<p>è¿™ç§æ–¹å¼å®ç°äº† åŸå­è®¿é—®ç¼“å­˜è¡Œã€‚</p>
<h4 id="æ€»çº¿æˆ–äº’è”äº’é”ï¼ˆbus-lock-interconnect-lockï¼‰"><a href="#æ€»çº¿æˆ–äº’è”äº’é”ï¼ˆbus-lock-interconnect-lockï¼‰" class="headerlink" title="æ€»çº¿æˆ–äº’è”äº’é”ï¼ˆbus lock &#x2F; interconnect lockï¼‰"></a>æ€»çº¿æˆ–äº’è”äº’é”ï¼ˆbus lock &#x2F; interconnect lockï¼‰</h4><p>å¯¹äºä¸åœ¨ç¼“å­˜ä¸­çš„å†…å­˜åœ°å€ï¼ˆå¦‚éä¸€è‡´å†…å­˜è®¿é—® NUMAã€I&#x2F;O å†…å­˜ç­‰ï¼‰ï¼Œç°ä»£ CPU ä»å¯èƒ½é€€å›åˆ°ï¼š</p>
<ul>
<li>æ€»çº¿é”å®šï¼ˆBus Lockï¼‰</li>
<li>å†…å­˜æ§åˆ¶å™¨äº’é”ï¼ˆmemory interconnect lockï¼‰</li>
</ul>
<p>æ¯”å¦‚ x86 çš„ lock å‰ç¼€ä¼šè®© CPU å‘å‡º LOCK# ä¿¡å·ï¼Œå‘Šè¯‰å…¶ä»–æ ¸æš‚æ—¶ç¦æ­¢è®¿é—®è¿™æ®µåœ°å€ã€‚</p>
<p>è¿™æ˜¯ä¸€ç§æ…¢ä½†å¯é çš„ fallback æœºåˆ¶ï¼Œé¿å…è·¨èŠ‚ç‚¹è®¿é—®å¸¦æ¥çš„ç«æ€ã€‚</p>
<h4 id="ç¦æ­¢ä¹±åºä¸æµæ°´çº¿å¹²é¢„"><a href="#ç¦æ­¢ä¹±åºä¸æµæ°´çº¿å¹²é¢„" class="headerlink" title="ç¦æ­¢ä¹±åºä¸æµæ°´çº¿å¹²é¢„"></a>ç¦æ­¢ä¹±åºä¸æµæ°´çº¿å¹²é¢„</h4><p>ç°ä»£ CPU ä¸ºäº†æ€§èƒ½é‡‡ç”¨ä¹±åºæ‰§è¡Œï¼ˆOut-of-Order Executionï¼‰å’Œæµæ°´çº¿ï¼ˆPipeliningï¼‰æœºåˆ¶ã€‚ä½†åŸå­æ“ä½œå¿…é¡»ï¼š</p>
<ul>
<li>æ‰§è¡ŒæœŸé—´ä¸å¾—ä¹±åº</li>
<li>ç¦æ­¢ä¹±åºç¼“å­˜è®¿é—®ï¼ˆå¦‚ Store Buffer æå‰å†™å…¥ï¼‰</li>
<li>å¼ºåˆ¶æ‰€æœ‰æ—©äºå®ƒçš„è¯»å†™å®Œæˆï¼Œä¹‹åçš„è¯»å†™ç­‰å¾…</li>
</ul>
<p>è¿™ä¾èµ–äºï¼š</p>
<ul>
<li>å¾®æŒ‡ä»¤æ’å…¥å†…å­˜å±éšœï¼ˆmemory fenceï¼‰</li>
<li>æš‚åœ load&#x2F;store buffer çš„é‡æ’</li>
<li>Flush pipeline &#x2F; reorder buffer</li>
</ul>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåŸå­æ“ä½œé€šå¸¸æ¯”æ™®é€šæ“ä½œè¦æ…¢çš„åŸå› ä¹‹ä¸€ã€‚</p>
<h4 id="ä¾‹å­ï¼šlock-cmpxchg-çš„ç¡¬ä»¶æ‰§è¡Œæµç¨‹"><a href="#ä¾‹å­ï¼šlock-cmpxchg-çš„ç¡¬ä»¶æ‰§è¡Œæµç¨‹" class="headerlink" title="ä¾‹å­ï¼šlock cmpxchg çš„ç¡¬ä»¶æ‰§è¡Œæµç¨‹"></a>ä¾‹å­ï¼šlock cmpxchg çš„ç¡¬ä»¶æ‰§è¡Œæµç¨‹</h4><p>å‡è®¾ CPU1 æ‰§è¡Œ lock cmpxchg [X], eaxï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>CPU1 å‘å‡º LOCK# ä¿¡å·æˆ–é”ä½ç¼“å­˜è¡Œ Xï¼ˆå–å†³äºåœ°å€æ˜¯å¦åœ¨ cacheï¼‰</li>
<li>å‘ MESI æ§åˆ¶å™¨å‘è¯·æ±‚ï¼ŒæŠ¢å åœ°å€ X çš„ cache line ç‹¬å æƒé™</li>
<li>åœ¨å…¶ä»–æ ¸å¿ƒæ”¶åˆ° invalidation åï¼ŒCPU1 è·å¾—ä¿®æ”¹æƒé™</li>
<li>CPU1 æ¯”è¾ƒ X ä¸ eax çš„å€¼ï¼Œå¦‚æœç›¸ç­‰åˆ™æ›´æ–°ä¸ºæ–°å€¼</li>
<li>å®Œæˆåé€šçŸ¥ MESI controllerï¼ŒX çš„çŠ¶æ€è®¾ä¸º Modified</li>
<li>æ“ä½œç»“æŸï¼Œç¼“å­˜ä¸€è‡´æ€§ä»ç„¶ç»´æŠ¤</li>
</ul>
<p>æ•´ä¸ªè¿‡ç¨‹æ˜¯ç”±ç¡¬ä»¶æ§åˆ¶å•å…ƒï¼ˆLoad&#x2F;Store Queueã€Execution Unitã€Bus Interface Unitï¼‰åè°ƒå®Œæˆçš„ã€‚</p>
<h4 id="å°ç»“ï¼šCPU-å®ç°åŸå­æ“ä½œçš„å…³é”®æœºåˆ¶"><a href="#å°ç»“ï¼šCPU-å®ç°åŸå­æ“ä½œçš„å…³é”®æœºåˆ¶" class="headerlink" title="å°ç»“ï¼šCPU å®ç°åŸå­æ“ä½œçš„å…³é”®æœºåˆ¶"></a>å°ç»“ï¼šCPU å®ç°åŸå­æ“ä½œçš„å…³é”®æœºåˆ¶</h4><table>
<thead>
<tr>
<th>æœºåˆ¶</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>åŸå­æŒ‡ä»¤ï¼ˆå¦‚ <code>lock cmpxchg</code>, <code>ldrex/strex</code>ï¼‰</td>
<td>æä¾›åŸå­è¯»-æ”¹-å†™</td>
</tr>
<tr>
<td>å¾®æ“ä½œè°ƒåº¦é”å®šèµ„æº</td>
<td>ä¿è¯åœ¨æµæ°´çº¿ä¸­ä¸å¯æ‹†åˆ†</td>
</tr>
<tr>
<td>MESI åè®®</td>
<td>å¤šæ ¸å…±äº«ç¼“å­˜ä¸€è‡´æ€§</td>
</tr>
<tr>
<td>æ€»çº¿é”æˆ–äº’è”é”</td>
<td>é˜²æ­¢è·¨æ ¸å¿ƒæˆ–I&#x2F;Oåœ°å€å‡ºç°ç«æ€</td>
</tr>
<tr>
<td>å†…å­˜å±éšœ &amp; ç¦æ­¢ä¹±åº</td>
<td>é˜²æ­¢æŒ‡ä»¤ä¸ç¼“å­˜å¤±åºè®¿é—®</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/01/concurrency/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/01/concurrency/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2/" class="post-title-link" itemprop="url">çº¿ç¨‹çŠ¶æ€è½¬æ¢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-01 12:18:07" itemprop="dateCreated datePublished" datetime="2025-08-01T12:18:07+00:00">2025-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="çº¿ç¨‹çŠ¶æ€"><a href="#çº¿ç¨‹çŠ¶æ€" class="headerlink" title="çº¿ç¨‹çŠ¶æ€"></a>çº¿ç¨‹çŠ¶æ€</h2><ul>
<li>Newï¼ˆæ–°å»ºï¼‰ï¼šçº¿ç¨‹å¯¹è±¡åˆšåˆ›å»ºï¼Œè¿˜æœªå¼€å§‹æ‰§è¡Œã€‚</li>
<li>Readyï¼ˆå°±ç»ªï¼‰ï¼šçº¿ç¨‹å‡†å¤‡å¥½è¿è¡Œï¼Œç­‰å¾…è°ƒåº¦å™¨åˆ†é… CPUã€‚</li>
<li>Runningï¼ˆè¿è¡Œï¼‰ï¼šçº¿ç¨‹æ­£åœ¨ä½¿ç”¨ CPU æ‰§è¡ŒæŒ‡ä»¤ã€‚</li>
<li>Blockedï¼ˆé˜»å¡ï¼‰ï¼šçº¿ç¨‹åœ¨ç­‰å¾…æŸä¸ªäº‹ä»¶ï¼ˆå¦‚ I&#x2F;Oã€é”ã€æ¡ä»¶å˜é‡ç­‰ï¼‰ï¼Œä¸èƒ½è¿è¡Œã€‚</li>
<li>Terminatedï¼ˆç»ˆæ­¢ï¼‰ï¼šçº¿ç¨‹æ‰§è¡Œå®Œæ¯•æˆ–è¢«å¼ºåˆ¶ç»“æŸã€‚</li>
<li>Sleepingï¼ˆä¼‘çœ ï¼‰ï¼šçº¿ç¨‹ä¸»åŠ¨æš‚åœä¸€æ®µæ—¶é—´ï¼ˆå¦‚ sleep()ï¼‰ï¼Œä¸èƒ½è¢«è°ƒåº¦ã€‚</li>
</ul>
<h2 id="çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾"><a href="#çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾" class="headerlink" title="çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾"></a>çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾</h2><table>
<thead>
<tr>
<th>å½“å‰çŠ¶æ€</th>
<th>è§¦å‘æ¡ä»¶</th>
<th>è½¬æ¢åçŠ¶æ€</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>New</td>
<td>è°ƒç”¨ start() æˆ– std::thread æ„é€ å‡½æ•°</td>
<td>Ready</td>
<td>çº¿ç¨‹è¢«åˆ›å»ºï¼Œç­‰å¾…è°ƒåº¦</td>
</tr>
<tr>
<td>Ready</td>
<td>è¢«è°ƒåº¦å™¨é€‰ä¸­</td>
<td>Running</td>
<td>è·å¾— CPUï¼Œå¼€å§‹æ‰§è¡Œ</td>
</tr>
<tr>
<td>Running</td>
<td>æ—¶é—´ç‰‡è€—å°½ &#x2F; yield()</td>
<td>Ready</td>
<td>ä¸»åŠ¨æˆ–è¢«åŠ¨è®©å‡º CPUï¼Œé‡æ–°æ’é˜Ÿ</td>
</tr>
<tr>
<td>Running</td>
<td>è°ƒç”¨ sleep() &#x2F; wait() &#x2F; ç­‰å¾…é”</td>
<td>Blocked &#x2F; Sleeping</td>
<td>çº¿ç¨‹ä¸èƒ½ç»§ç»­æ‰§è¡Œï¼Œç­‰å¾…äº‹ä»¶æˆ–æ—¶é—´</td>
</tr>
<tr>
<td>Blocked &#x2F; Sleeping</td>
<td>æ¡ä»¶æ»¡è¶³ &#x2F; æ—¶é—´åˆ°</td>
<td>Ready</td>
<td>çº¿ç¨‹é‡æ–°å…·å¤‡è¿è¡Œæ¡ä»¶ï¼Œç­‰å¾…è°ƒåº¦</td>
</tr>
<tr>
<td>Running</td>
<td>æ‰§è¡Œç»“æŸæˆ–å¼‚å¸¸</td>
<td>Terminated</td>
<td>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç»“æŸ</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">æ€§èƒ½åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 15:43:15" itemprop="dateCreated datePublished" datetime="2025-07-31T15:43:15+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æ€§èƒ½æŒ‡æ ‡"><a href="#æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡"></a>æ€§èƒ½æŒ‡æ ‡</h2><h3 id="CPUæ—¶é—´"><a href="#CPUæ—¶é—´" class="headerlink" title="CPUæ—¶é—´"></a>CPUæ—¶é—´</h3><p><strong>å‡½æ•°è°ƒç”¨çš„ CPU æ—¶é—´:</strong></p>
<ul>
<li><code>Inclusive time</code>: total cpu time, include all functions it calls.</li>
<li><code>Exclusive time</code>: only the time used by the function itself, exclusive all its children.</li>
</ul>
<p>Refer to <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15760447/what-is-the-meaning-of-incl-cpu-time-excl-cpu-time-incl-real-cpu-time-excl-re/74426370">here</a>.</p>
<ol>
<li><p>Wall time: total time the process used, containing IO time.</p>
</li>
<li><p>CPU usage (CPUåˆ©ç”¨ç‡) &#x3D; CPU time &#x2F; Wall time.</p>
</li>
<li><p>real&#x2F;user&#x2F;system time</p>
<ul>
<li><strong>Real</strong> is wall clock time - time from start to finish of the call. This is all elapsed time including time slices used by other processes and time the process spends blocked (for example if it is waiting for I&#x2F;O to complete).</li>
<li><strong>User</strong> is the amount of CPU time spent in user-mode code (outside the kernel) within the process. This is only actual CPU time used in executing the process. Other processes and time the process spends blocked do not count towards this figure.</li>
<li><strong>Sys</strong> is the amount of CPU time spent in the kernel within the process. This means executing CPU time spent in system calls within the kernel, as opposed to library code, which is still running in user-space. Like â€˜userâ€™, this is only CPU time used by the process. See below for a brief description of kernel mode (also known as â€˜supervisorâ€™ mode) and the system call mechanism.</li>
</ul>
<p> Refer to <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/556405/what-do-real-user-and-sys-mean-in-the-output-of-time1">here</a>.</p>
</li>
<li><p>CPU æ—¶é—´å¯èƒ½å¤§äºå¢™ä¸Šæ—¶é—´ï¼š</p>
<p>è¿™æ˜¯å› ä¸º CPU æ—¶é—´æ˜¯æ‰€æœ‰ CPU æ ¸çš„è¿è¡Œæ—¶é—´çš„ç´¯åŠ å’Œï¼Œå¢™ä¸Šæ—¶é—´åˆ™æ˜¯å®é™…çš„æ—¶é—´ã€‚æ­¤æ—¶ CPU åˆ©ç”¨ç‡å¤§äº 100%. ï¼ˆè¿™æ˜¯è‡ªå·±çš„ç†è§£ï¼‰</p>
</li>
<li><p>TODO: Is CPU time in <em>flame graph</em> sum of all the CPU time? Or is it the wall time when CPU works?</p>
</li>
</ol>
<h3 id="è®¡æ—¶å·¥å…·ï¼štimer"><a href="#è®¡æ—¶å·¥å…·ï¼štimer" class="headerlink" title="è®¡æ—¶å·¥å…·ï¼štimer"></a>è®¡æ—¶å·¥å…·ï¼š<code>timer</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/time -p <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>Or,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ time <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼ˆå‚è€ƒ<a target="_blank" rel="noopener" href="https://ostechnix.com/how-to-find-the-execution-time-of-a-command-or-process-in-linux/">é“¾æ¥</a>ï¼‰ï¼Œ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">type</span> -a time</span><br><span class="line">time is a shell keyword</span><br><span class="line">time is /usr/bin/time</span><br></pre></td></tr></table></figure>


<h2 id="åˆ†æå·¥å…·"><a href="#åˆ†æå·¥å…·" class="headerlink" title="åˆ†æå·¥å…·"></a>åˆ†æå·¥å…·</h2><ul>
<li>Performance Analyzer</li>
<li>Thread Analyzer</li>
<li>gprof</li>
<li>DDT&#x2F;gdb</li>
</ul>
<h3 id="Performance-Analyzer"><a href="#Performance-Analyzer" class="headerlink" title="Performance Analyzer"></a>Performance Analyzer</h3><p>Oracle Developer Studio æä¾›äº†å¤šç§å·¥å…·ï¼šPerformance Analyzerã€Thread Analyzerã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afagg.html#OSSPAgrkam">Performance Analyzer å®˜æ–¹æ–‡æ¡£</a></p>
</blockquote>
<p><strong>1. æ”¶é›†æ•°æ®</strong></p>
<p>ä½¿ç”¨ <code>collect</code> å‘½ä»¤æ”¶é›†æ•°æ®ï¼ˆ<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afadn.html#scrolltoc">å®˜æ–¹æ–‡æ¡£</a>ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collect collect-options program program-arguments</span><br></pre></td></tr></table></figure>

<p><strong>2. å¼€å§‹æ€§èƒ½åˆ†æ</strong></p>
<p>ä½¿ç”¨ <code>analyzer</code> å‘½ä»¤è¿›è¡Œæ€§èƒ½åˆ†æï¼ˆ<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afafs.html#scrolltoc">å®˜æ–¹æ–‡æ¡£</a>ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">analyzer [control-options] [experiment | experiment-list]</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">analyzer -c test.1.er test.4.er</span><br></pre></td></tr></table></figure>

<h3 id="Thread-Analyzer"><a href="#Thread-Analyzer" class="headerlink" title="Thread Analyzer"></a>Thread Analyzer</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/application-development/technologies/developerstudio-features.html#thread-analyzer-tab">Thread Analyzer å®˜æ–¹æ–‡æ¡£</a></p>
</blockquote>
<h3 id="gprof"><a href="#gprof" class="headerlink" title="gprof"></a>gprof</h3><p>gprof(GNU profiler)æ˜¯GNU binutilså·¥å…·é›†ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œlinuxç³»ç»Ÿå½“ä¸­ä¼šè‡ªå¸¦è¿™ä¸ªå·¥å…·ã€‚å®ƒå¯ä»¥åˆ†æç¨‹åºçš„æ€§èƒ½ï¼Œèƒ½ç»™å‡ºå‡½æ•°è°ƒç”¨æ—¶é—´ã€è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨å…³ç³»ï¼Œæ‰¾å‡ºç¨‹åºçš„ç“¶é¢ˆæ‰€åœ¨ã€‚åœ¨ç¼–è¯‘å’Œé“¾æ¥é€‰é¡¹ä¸­éƒ½åŠ å…¥-pgä¹‹åï¼Œgccä¼šåœ¨æ¯ä¸ªå‡½æ•°ä¸­æ’å…¥ä»£ç ç‰‡æ®µï¼Œç”¨äºè®°å½•å‡½æ•°é—´çš„è°ƒç”¨å…³ç³»å’Œè°ƒç”¨æ¬¡æ•°ï¼Œå¹¶é‡‡é›†å‡½æ•°çš„è°ƒç”¨æ—¶é—´ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ftp.gnu.org/old-gnu/Manuals/gprof-2.9.1/html_mono/gprof.html">gprofå®˜æ–¹æ–‡æ¡£</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/luronggui/article/-details/118141262">ä½¿ç”¨æ–¹æ³•</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385842627">åšå®¢</a></li>
</ul>
<h3 id="DDT"><a href="#DDT" class="headerlink" title="DDT"></a>DDT</h3><p><a target="_blank" rel="noopener" href="https://www.linaroforge.com/linaroDdt">DDT</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E6%B7%B7%E5%90%88%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E6%B7%B7%E5%90%88%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">æ··åˆç¼–è¯‘</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 15:29:32" itemprop="dateCreated datePublished" datetime="2025-07-31T15:29:32+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>â€œHybrid Buildâ€ï¼ˆæ··åˆæ„å»ºï¼‰æ˜¯æŒ‡ä¸€ç§ å…¼é¡¾è°ƒè¯•èƒ½åŠ›ä¸è¿è¡Œæ€§èƒ½ çš„æ„å»ºæ–¹å¼ï¼Œå¸¸ç”¨äºéœ€è¦åœ¨ Release ç¯å¢ƒä¸­è¿›è¡Œé—®é¢˜åˆ†æï¼Œä½†åˆä¸èƒ½å®Œå…¨ä½¿ç”¨ Debug æ„å»ºçš„åœºæ™¯ã€‚</p>
<h3 id="ğŸ§©-Hybrid-Build-çš„æ ¸å¿ƒç‰¹å¾"><a href="#ğŸ§©-Hybrid-Build-çš„æ ¸å¿ƒç‰¹å¾" class="headerlink" title="ğŸ§© Hybrid Build çš„æ ¸å¿ƒç‰¹å¾"></a>ğŸ§© Hybrid Build çš„æ ¸å¿ƒç‰¹å¾</h3><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>ä¼˜åŒ–ç­‰çº§</td>
<td>ä½¿ç”¨ -O2 æˆ– -O3ï¼Œä¿æŒæ¥è¿‘ Release çš„æ€§èƒ½</td>
</tr>
<tr>
<td>è°ƒè¯•ä¿¡æ¯</td>
<td>ä¿ç•™ -gï¼Œç”Ÿæˆ DWARF è°ƒè¯•ç¬¦å·ï¼Œä¾¿äºåˆ†æ core dump æˆ–ä½¿ç”¨ gdb</td>
</tr>
<tr>
<td>ç¬¦å·è¡¨</td>
<td>å¯é€‰å¼€å¯ -fno-omit-frame-pointerï¼Œä¾¿äºæ ˆå›æº¯</td>
</tr>
<tr>
<td>æ—¥å¿—&#x2F;ä¿æŠ¤æœºåˆ¶</td>
<td>å¯åµŒå…¥è½»é‡çº§æ—¥å¿—ã€ASAN-liteã€canary ç­‰æœºåˆ¶ï¼Œå¢å¼ºå¯è§‚æµ‹æ€§</td>
</tr>
<tr>
<td>éƒ¨ç½²ç­–ç•¥</td>
<td>ä»…åœ¨å†…éƒ¨æˆ–ç‰¹å®šå®¢æˆ·ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œé¿å…æš´éœ²å®Œæ•´æºç ç»“æ„æˆ–è°ƒè¯•ç¬¦å·</td>
</tr>
</tbody></table>
<p>âœ… ç¼–è¯‘ç¤ºä¾‹ï¼ˆGCC&#x2F;Clangï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -O2 -g -fno-omit-frame-pointer -DNDEBUG -o your_program main.cpp</span><br></pre></td></tr></table></figure>

<ul>
<li>-O2ï¼šä¼˜åŒ–ä»£ç ï¼Œæ¥è¿‘ Release æ€§èƒ½</li>
<li>-gï¼šä¿ç•™è°ƒè¯•ä¿¡æ¯</li>
<li>-fno-omit-frame-pointerï¼šä¿ç•™å¸§æŒ‡é’ˆï¼Œä¾¿äºæ ˆè¿½è¸ª</li>
<li>-DNDEBUGï¼šå…³é—­æ–­è¨€ï¼ˆassertï¼‰</li>
</ul>
<h3 id="ğŸ¯-ä½¿ç”¨åœºæ™¯"><a href="#ğŸ¯-ä½¿ç”¨åœºæ™¯" class="headerlink" title="ğŸ¯ ä½¿ç”¨åœºæ™¯"></a>ğŸ¯ ä½¿ç”¨åœºæ™¯</h3><table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ˜¯å¦æ¨èä½¿ç”¨ Hybrid Build</th>
<th>åŸå› è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>å®¢æˆ·ç°åœºå¤ç°å´©æºƒ</td>
<td>âœ…</td>
<td>å¯é€šè¿‡ core dump + ç¬¦å·è¡¨å¿«é€Ÿå®šä½é—®é¢˜</td>
</tr>
<tr>
<td>å†…éƒ¨æ€§èƒ½æµ‹è¯•</td>
<td>âœ…</td>
<td>ä¿æŒä¼˜åŒ–æ•ˆæœï¼ŒåŒæ—¶å¯è°ƒè¯•</td>
</tr>
<tr>
<td>æ­£å¼å‘å¸ƒç»™å®¢æˆ·ï¼ˆå¤§è§„æ¨¡éƒ¨ç½²ï¼‰</td>
<td>âŒ</td>
<td>ä¸å»ºè®®ï¼Œå¯èƒ½æš´éœ²ç¬¦å·ä¿¡æ¯ï¼Œä½“ç§¯è¾ƒå¤§</td>
</tr>
<tr>
<td>ä¸ ASAN&#x2F;TSAN è”åˆä½¿ç”¨</td>
<td>âš ï¸ï¼ˆéœ€å…³é—­ä¼˜åŒ–ï¼‰</td>
<td>ASAN&#x2F;TSAN æ›´é€‚åˆ Debug æ„å»ºï¼ŒHybrid ä¼šå½±å“æ£€æµ‹ç²¾åº¦</td>
</tr>
</tbody></table>
<h3 id="ğŸ› ï¸-å®è·µå»ºè®®"><a href="#ğŸ› ï¸-å®è·µå»ºè®®" class="headerlink" title="ğŸ› ï¸ å®è·µå»ºè®®"></a>ğŸ› ï¸ å®è·µå»ºè®®</h3><ul>
<li>ç¬¦å·åˆ†ç¦»ï¼šä½¿ç”¨ <code>objcopy --only-keep-debug</code> åˆ†ç¦»è°ƒè¯•ç¬¦å·ï¼Œé¿å…æš´éœ²ç»™å®¢æˆ·ã€‚</li>
<li>ç¬¦å·æœåŠ¡å™¨ï¼šå†…éƒ¨ç»´æŠ¤ç¬¦å·æœåŠ¡å™¨ï¼Œæ”¯æŒé€šè¿‡ core æ–‡ä»¶è‡ªåŠ¨ç¬¦å·åŒ–ã€‚</li>
<li>ç»“åˆæ—¥å¿—æ¡†æ¶ï¼šHybrid Build å¯ä¸è½»é‡çº§æ—¥å¿—æ¡†æ¶ç»“åˆï¼Œå¢å¼ºé—®é¢˜å®šä½èƒ½åŠ›ã€‚</li>
</ul>
<h2 id="ç¬¦å·åˆ†ç¦»ï¼ˆSplit-Debug-Infoï¼‰"><a href="#ç¬¦å·åˆ†ç¦»ï¼ˆSplit-Debug-Infoï¼‰" class="headerlink" title="ç¬¦å·åˆ†ç¦»ï¼ˆSplit Debug Infoï¼‰"></a>ç¬¦å·åˆ†ç¦»ï¼ˆSplit Debug Infoï¼‰</h2><p><strong>âœ… ä¸ºä»€ä¹ˆè¦åˆ†ç¦»ï¼Ÿ</strong></p>
<ul>
<li>Release ç‰ˆæœ¬ï¼šä½“ç§¯å°ï¼Œæ€§èƒ½é«˜ï¼Œä½†ç¼ºå°‘è°ƒè¯•ä¿¡æ¯</li>
<li>è°ƒè¯•ç¬¦å·æ–‡ä»¶ï¼šä¿ç•™å®Œæ•´ç¬¦å·ä¿¡æ¯ï¼Œç”¨äºå†…éƒ¨åˆ†æ core dump</li>
</ul>
<p><strong>ğŸ› ï¸ åˆ†ç¦»æµç¨‹ï¼ˆä»¥ GCC&#x2F;Clang ä¸ºä¾‹ï¼‰</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘æ—¶ä¿ç•™è°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">g++ -O2 -g -o your_program main.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç¦»è°ƒè¯•ç¬¦å·</span></span><br><span class="line">objcopy --only-keep-debug your_program your_program.debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»é™¤ä¸»ç¨‹åºä¸­çš„è°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">strip --strip-debug --strip-unneeded your_program</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è°ƒè¯•ç¬¦å·å…³è”ä¿¡æ¯</span></span><br><span class="line">objcopy --add-gnu-debuglink=your_program.debug your_program</span><br></pre></td></tr></table></figure>

<p><strong>âœ… æœ€ç»ˆäº§ç‰©ï¼š</strong></p>
<ul>
<li>your_programï¼šå¯äº¤ä»˜ç»™å®¢æˆ·çš„ Release å¯æ‰§è¡Œæ–‡ä»¶</li>
<li>your_program.debugï¼šå†…éƒ¨ä½¿ç”¨çš„è°ƒè¯•ç¬¦å·æ–‡ä»¶</li>
</ul>
<h2 id="core-dump-åˆ†æ"><a href="#core-dump-åˆ†æ" class="headerlink" title="core dump åˆ†æ"></a>core dump åˆ†æ</h2><p><strong>1. å®¢æˆ·ä¾§è®¾ç½® core dump</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br></pre></td></tr></table></figure>

<p><strong>2. å®¢æˆ·è¿è¡Œç¨‹åºå¹¶ç”Ÿæˆ core æ–‡ä»¶</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./your_program crash_input.txt</span><br><span class="line"><span class="comment"># ç¨‹åºå´©æºƒåç”Ÿæˆ core æ–‡ä»¶ï¼Œå¦‚ core.12345</span></span><br></pre></td></tr></table></figure>

<p><strong>3. å®¢æˆ·æä¾› core æ–‡ä»¶ + å¯æ‰§è¡Œæ–‡ä»¶</strong></p>
<ul>
<li>core.12345</li>
<li>your_programï¼ˆRelease ç‰ˆæœ¬ï¼‰</li>
</ul>
<p><strong>4. ä½ åœ¨å†…éƒ¨åˆ†æ core æ–‡ä»¶</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb your_program core.12345</span><br><span class="line"><span class="comment"># åŠ è½½è°ƒè¯•ç¬¦å·</span></span><br><span class="line">(gdb) symbol-file your_program.debug</span><br><span class="line">(gdb) bt  <span class="comment"># æŸ¥çœ‹è°ƒç”¨æ ˆ</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">å†…å­˜åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 14:53:40" itemprop="dateCreated datePublished" datetime="2025-07-31T14:53:40+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-16 05:56:33" itemprop="dateModified" datetime="2025-08-16T05:56:33+00:00">2025-08-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><p>valgrind æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å†…å­˜è°ƒè¯•å’Œæ€§èƒ½åˆ†æå·¥å…·ï¼Œå®ƒçš„ä¸åŒå­å·¥å…·ç”¨äºä¸åŒçš„åˆ†æç›®çš„ã€‚<code>--memcheck</code> å’Œ <code>--massif</code> æ˜¯å…¶ä¸­ä¸¤ä¸ªå¸¸ç”¨çš„å·¥å…·ã€‚</p>
<p>ASANï¼ˆAddressSanitizerï¼‰ å’Œ TSANï¼ˆThreadSanitizerï¼‰ éƒ½æ˜¯ç”±ç°ä»£ç¼–è¯‘å™¨ï¼ˆå¦‚ Clang å’Œ GCCï¼‰æä¾›çš„ è¿è¡Œæ—¶æ£€æµ‹å·¥å…·ï¼Œç”¨äºå¸®åŠ©å¼€å‘è€…åœ¨å¼€å‘é˜¶æ®µå‘ç°å†…å­˜é”™è¯¯å’Œçº¿ç¨‹é—®é¢˜ã€‚</p>
<ul>
<li>Clangï¼šå…¨é¢æ”¯æŒ ASAN å’Œ TSAN</li>
<li>GCCï¼šä¹Ÿæ”¯æŒï¼Œä½† TSAN çš„æ”¯æŒç•¥é€Šäº Clang</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://jvns.ca/blog/2018/04/28/debugging-a-segfault-on-linux/">åšå®¢ï¼šHow to get a core dump for a segfault on Linux</a></p>
<h3 id="Memcheckï¼šå†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·"><a href="#Memcheckï¼šå†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·" class="headerlink" title="Memcheckï¼šå†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·"></a>Memcheckï¼šå†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·</h3><p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://valgrind.org/docs/manual/mc-manual.html">4. Memcheck: a memory error detector</a></p>
<ul>
<li>ç”¨é€”ï¼šæ£€æµ‹å†…å­˜ç›¸å…³çš„é”™è¯¯ï¼Œå¦‚å†…å­˜æ³„æ¼ã€è¶Šç•Œè®¿é—®ã€æœªåˆå§‹åŒ–å†…å­˜è¯»å–ç­‰ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šè°ƒè¯•ç¨‹åºä¸­çš„å†…å­˜é”™è¯¯ï¼Œç¡®ä¿ç¨‹åºçš„å†…å­˜ä½¿ç”¨æ˜¯å®‰å…¨çš„ã€‚</li>
<li>è¾“å‡ºå†…å®¹ï¼š<ul>
<li>å“ªäº›å†…å­˜æ²¡æœ‰é‡Šæ”¾ï¼ˆå†…å­˜æ³„æ¼ï¼‰</li>
<li>å“ªäº›å†…å­˜è¢«éæ³•è®¿é—®ï¼ˆè¶Šç•Œã€æœªåˆå§‹åŒ–ç­‰ï¼‰</li>
<li>å“ªäº›å†…å­˜è®¿é—®æ˜¯æœªå®šä¹‰è¡Œä¸º</li>
</ul>
</li>
<li>å¸¸ç”¨å‘½ä»¤ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valgrind --tool=memcheck ./your_program</span><br></pre></td></tr></table></figure>

<h3 id="Massifï¼šå †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·"><a href="#Massifï¼šå †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·" class="headerlink" title="Massifï¼šå †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·"></a>Massifï¼šå †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·</h3><p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://valgrind.org/docs/manual/ms-manual.html">9. Massif: a heap profiler</a></p>
<ul>
<li>ç”¨é€”ï¼šåˆ†æç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¸®åŠ©ä¼˜åŒ–å†…å­˜å ç”¨ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šæ€§èƒ½åˆ†æï¼Œæ‰¾å‡ºå†…å­˜å ç”¨é«˜çš„ä»£ç è·¯å¾„æˆ–æ•°æ®ç»“æ„ã€‚</li>
<li>è¾“å‡ºå†…å®¹ï¼š<ul>
<li>å †å†…å­˜ä½¿ç”¨éšæ—¶é—´çš„å˜åŒ–ï¼ˆå¿«ç…§ï¼‰ï¼šéœ€ç”¨ <code>ms_print</code> æˆ– <a target="_blank" rel="noopener" href="https://courses.cs.washington.edu/courses/cse326/05wi/valgrind-doc/ms_main.html">PostScript Viewer</a> æŸ¥çœ‹</li>
<li>å“ªäº›å‡½æ•°æˆ–è°ƒç”¨è·¯å¾„åˆ†é…äº†æœ€å¤šçš„å†…å­˜</li>
<li>å¸¸ç”¨å‘½ä»¤ï¼š</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">valgrind --tool=massif ./your_program</span><br><span class="line">ms_print massif.out.&lt;pid&gt;</span><br></pre></td></tr></table></figure>

<p><strong>ğŸ†š Memcheck vs Massif å¯¹æ¯”æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th><code>--memcheck</code></th>
<th><code>--massif</code></th>
</tr>
</thead>
<tbody><tr>
<td>å·¥å…·ç±»å‹</td>
<td>å†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·</td>
<td>å †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·</td>
</tr>
<tr>
<td>ä¸»è¦ç”¨é€”</td>
<td>æ£€æŸ¥å†…å­˜æ³„æ¼ã€è¶Šç•Œè®¿é—®ã€æœªåˆå§‹åŒ–è¯»å–ç­‰</td>
<td>åˆ†æå †å†…å­˜ä½¿ç”¨è¶‹åŠ¿å’Œå³°å€¼</td>
</tr>
<tr>
<td>æ£€æµ‹å†…å­˜æ³„æ¼</td>
<td>âœ…</td>
<td>âŒï¼ˆä¸ç›´æ¥æ£€æµ‹ï¼‰</td>
</tr>
<tr>
<td>åˆ†æå†…å­˜å¢é•¿è¶‹åŠ¿</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>è¾“å‡ºæ ¼å¼</td>
<td>é”™è¯¯æŠ¥å‘Šï¼ˆæ–‡æœ¬ï¼‰</td>
<td>å†…å­˜å¿«ç…§ï¼ˆéœ€ç”¨ <code>ms_print</code> æŸ¥çœ‹ï¼‰</td>
</tr>
<tr>
<td>æ€§èƒ½å¼€é”€</td>
<td>é«˜ï¼ˆè¿è¡Œé€Ÿåº¦å˜æ…¢ï¼‰</td>
<td>ä¸­ç­‰</td>
</tr>
</tbody></table>
<h3 id="ThreadSanitizerï¼ˆTSANï¼‰"><a href="#ThreadSanitizerï¼ˆTSANï¼‰" class="headerlink" title="ThreadSanitizerï¼ˆTSANï¼‰"></a>ThreadSanitizerï¼ˆTSANï¼‰</h3><ul>
<li>ç”¨é€”ï¼šæ£€æµ‹å¤šçº¿ç¨‹ç¨‹åºä¸­çš„ æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰ å’Œå…¶ä»–çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šå¹¶å‘ç¨‹åºè°ƒè¯•ï¼Œå°¤å…¶æ˜¯å½“å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«å˜é‡æ—¶ã€‚</li>
<li>æ£€æµ‹å†…å®¹ï¼š<ul>
<li>æ•°æ®ç«äº‰ï¼ˆä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€å˜é‡ï¼Œä¸”è‡³å°‘ä¸€ä¸ªæ˜¯å†™æ“ä½œï¼‰</li>
<li>é”ä½¿ç”¨é”™è¯¯ï¼ˆæ­»é”ã€åŒé‡è§£é”ç­‰ï¼‰</li>
</ul>
</li>
<li>å¯ç”¨æ–¹å¼ï¼ˆClang&#x2F;GCCï¼‰ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fsanitize=thread -g your_program.c -o your_program</span><br></pre></td></tr></table></figure>

<h3 id="AddressSanitizerï¼ˆASANï¼‰"><a href="#AddressSanitizerï¼ˆASANï¼‰" class="headerlink" title="AddressSanitizerï¼ˆASANï¼‰"></a>AddressSanitizerï¼ˆASANï¼‰</h3><p><a target="_blank" rel="noopener" href="https://github.com/google/sanitizers/wiki/AddressSanitizer">AddressSanitizer æ–‡æ¡£</a></p>
<ul>
<li>ç”¨é€”ï¼šæ£€æµ‹å†…å­˜è®¿é—®é”™è¯¯ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šå•çº¿ç¨‹æˆ–å¤šçº¿ç¨‹ç¨‹åºä¸­è°ƒè¯•å†…å­˜é—®é¢˜ã€‚</li>
<li>æ£€æµ‹å†…å®¹ï¼š<ul>
<li>è¶Šç•Œè®¿é—®ï¼ˆstack&#x2F;heap&#x2F;globalï¼‰</li>
<li>use-after-freeï¼ˆé‡Šæ”¾åä½¿ç”¨ï¼‰</li>
<li>å†…å­˜æ³„æ¼ï¼ˆå¯é€‰ï¼‰</li>
<li>use-after-scopeï¼ˆä½œç”¨åŸŸç»“æŸåä½¿ç”¨å±€éƒ¨å˜é‡ï¼‰</li>
</ul>
</li>
<li>å¯ç”¨æ–¹å¼ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fsanitize=address -g your_program.c -o your_program</span><br></pre></td></tr></table></figure>

<p><strong>ğŸ†š TSAN vs ASAN å¯¹æ¯”æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>TSANï¼ˆThreadSanitizerï¼‰</th>
<th>ASANï¼ˆAddressSanitizerï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>æ£€æµ‹ç›®æ ‡</td>
<td>å¤šçº¿ç¨‹æ•°æ®ç«äº‰</td>
<td>å†…å­˜è®¿é—®é”™è¯¯</td>
</tr>
<tr>
<td>æ˜¯å¦æ”¯æŒå¤šçº¿ç¨‹</td>
<td>âœ…ï¼ˆä¸“ä¸ºå¤šçº¿ç¨‹è®¾è®¡ï¼‰</td>
<td>âœ…ï¼ˆæ”¯æŒï¼Œä½†ä¸æ£€æµ‹æ•°æ®ç«äº‰ï¼‰</td>
</tr>
<tr>
<td>æ€§èƒ½å¼€é”€</td>
<td>è¾ƒé«˜ï¼ˆ10x~40xï¼‰</td>
<td>ä¸­ç­‰ï¼ˆ2x~3xï¼‰</td>
</tr>
<tr>
<td>å†…å­˜å¼€é”€</td>
<td>ä¸­ç­‰</td>
<td>è¾ƒé«˜ï¼ˆå¢åŠ çº¦2å€å†…å­˜ä½¿ç”¨ï¼‰</td>
</tr>
<tr>
<td>æ˜¯å¦æ£€æµ‹å†…å­˜æ³„æ¼</td>
<td>âŒï¼ˆä¸æ£€æµ‹ï¼‰</td>
<td>âœ…ï¼ˆå¯é€‰å¼€å¯ï¼‰</td>
</tr>
<tr>
<td>æ˜¯å¦æ£€æµ‹æ•°æ®ç«äº‰</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
</tbody></table>
<p><strong>ğŸ†š Memcheck vs Massif vs TSAN vs ASAN å¯¹æ¯”æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>å·¥å…·åç§°</th>
<th>ç±»å‹</th>
<th>ä¸»è¦ç”¨é€”</th>
<th>æ£€æµ‹å†…å®¹</th>
<th>æ˜¯å¦æ”¯æŒå¤šçº¿ç¨‹</th>
<th>æ€§èƒ½å¼€é”€</th>
<th>å†…å­˜å¼€é”€</th>
<th>æ˜¯å¦æ£€æµ‹å†…å­˜æ³„æ¼</th>
<th>æ˜¯å¦æ£€æµ‹æ•°æ®ç«äº‰</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Memcheck</strong></td>
<td>Valgrind å·¥å…·</td>
<td>å†…å­˜é”™è¯¯æ£€æµ‹</td>
<td>å†…å­˜æ³„æ¼ã€è¶Šç•Œè®¿é—®ã€æœªåˆå§‹åŒ–è¯»å–ã€éæ³•é‡Šæ”¾ç­‰</td>
<td>âœ…ï¼ˆæœ‰é™æ”¯æŒï¼‰</td>
<td>é«˜ï¼ˆ10x+ï¼‰</td>
<td>é«˜</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><strong>Massif</strong></td>
<td>Valgrind å·¥å…·</td>
<td>å †å†…å­˜ä½¿ç”¨åˆ†æ</td>
<td>å †å†…å­˜åˆ†é…è¶‹åŠ¿ã€å†…å­˜å³°å€¼ã€è°ƒç”¨è·¯å¾„åˆ†æ</td>
<td>âœ…</td>
<td>ä¸­ç­‰</td>
<td>ä¸­ç­‰</td>
<td>âŒ</td>
<td>âŒ</td>
</tr>
<tr>
<td><strong>ASAN</strong></td>
<td>ç¼–è¯‘å™¨å·¥å…·</td>
<td>å†…å­˜è®¿é—®é”™è¯¯æ£€æµ‹</td>
<td>è¶Šç•Œè®¿é—®ã€use-after-freeã€use-after-scopeã€å†…å­˜æ³„æ¼ï¼ˆå¯é€‰ï¼‰</td>
<td>âœ…</td>
<td>ä¸­ç­‰ï¼ˆ2x~3xï¼‰</td>
<td>é«˜ï¼ˆçº¦2å€ï¼‰</td>
<td>âœ…ï¼ˆå¯é€‰ï¼‰</td>
<td>âŒ</td>
</tr>
<tr>
<td><strong>TSAN</strong></td>
<td>ç¼–è¯‘å™¨å·¥å…·</td>
<td>å¤šçº¿ç¨‹æ•°æ®ç«äº‰æ£€æµ‹</td>
<td>æ•°æ®ç«äº‰ã€æ­»é”ã€é”™è¯¯çš„é”ä½¿ç”¨ç­‰</td>
<td>âœ…ï¼ˆå¼ºæ”¯æŒï¼‰</td>
<td>é«˜ï¼ˆ5x~40xï¼‰</td>
<td>ä¸­ç­‰</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
</tbody></table>
<h2 id="UBSan-Unifined-Behavior-Sanitizer"><a href="#UBSan-Unifined-Behavior-Sanitizer" class="headerlink" title="UBSan (Unifined Behavior Sanitizer)"></a>UBSan (Unifined Behavior Sanitizer)</h2><table>
<thead>
<tr>
<th>Sanitizer</th>
<th>æ£€æµ‹å†…å®¹</th>
<th>Google è´¡çŒ®</th>
</tr>
</thead>
<tbody><tr>
<td>ASAN</td>
<td>å†…å­˜è®¿é—®é”™è¯¯</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td>UBSan</td>
<td>æœªå®šä¹‰è¡Œä¸º</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td>TSAN</td>
<td>æ•°æ®ç«äº‰</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td>MSAN</td>
<td>æœªåˆå§‹åŒ–å†…å­˜ä½¿ç”¨</td>
<td>âœ… æ˜¯</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/9/">9</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bi-an"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">bi-an</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bi-an" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;bi-an" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ah_zzg@126.com" title="E-Mail â†’ mailto:ah_zzg@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://bi-an.github.io/" title="http:&#x2F;&#x2F;bi-an.github.io">bi-an's Page</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bi-an</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

</body>
</html>
