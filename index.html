<!DOCTYPE html>
<html lang="en, zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bi-an.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:url" content="https://bi-an.github.io/blog/index.html">
<meta property="og:site_name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:locale">
<meta property="article:author" content="bi-an">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bi-an.github.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en, zh_CN'
  };
</script>

  <title>æ±Ÿå—äººç‰©çš„åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æ±Ÿå—äººç‰©çš„åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/blog/resources/" rel="section"><i class="fa fa-paperclip fa-fw"></i>Resource</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/15/concurrency/ABA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/15/concurrency/ABA/" class="post-title-link" itemprop="url">CAS çš„ ABAé—®é¢˜</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-09-15 19:48:58 / Modified: 11:59:20" itemprop="dateCreated datePublished" datetime="2025-09-15T19:48:58+00:00">2025-09-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">å¹¶å‘ç¼–ç¨‹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><h3 id="Hazard-Pointerï¼ˆå±é™©æŒ‡é’ˆï¼‰"><a href="#Hazard-Pointerï¼ˆå±é™©æŒ‡é’ˆï¼‰" class="headerlink" title="Hazard Pointerï¼ˆå±é™©æŒ‡é’ˆï¼‰"></a>Hazard Pointerï¼ˆå±é™©æŒ‡é’ˆï¼‰</h3><p>æ€è·¯ï¼šæ¯ä¸ªçº¿ç¨‹åœ¨è®¿é—®å…±äº«æŒ‡é’ˆä¹‹å‰ï¼ŒæŠŠè‡ªå·±æ­£åœ¨è®¿é—®çš„æŒ‡é’ˆå†™åˆ°ä¸€ä¸ªå…¨å±€å¯è§çš„â€œhazard pointerâ€é‡Œã€‚</p>
<p>ä½œç”¨ï¼šå…¶ä»–çº¿ç¨‹åœ¨æƒ³è¦å›æ”¶è¿™ä¸ªèŠ‚ç‚¹å†…å­˜æ—¶ï¼Œå¿…é¡»æ£€æŸ¥æ‰€æœ‰çº¿ç¨‹çš„ hazard pointersï¼Œå¦‚æœå‘ç°æœ‰äººè¿˜åœ¨ç”¨è¿™ä¸ªèŠ‚<br>ç‚¹ï¼Œå°±ä¸èƒ½é‡Šæ”¾ã€‚</p>
<p>ä¼˜ç‚¹ï¼šç®€å•ç›´æ¥ï¼Œå†…å­˜å¯ä»¥å®‰å…¨å›æ”¶ã€‚</p>
<p>ç¼ºç‚¹ï¼šç»´æŠ¤ hazard pointers æœ‰ä¸€å®šå¼€é”€ï¼Œæ¯æ¬¡å›æ”¶éƒ½è¦æ£€æŸ¥æ‰€æœ‰çº¿ç¨‹ã€‚</p>
<h3 id="Epoch-Based-Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼Œç®€ç§°-Epoch-GCï¼‰"><a href="#Epoch-Based-Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼Œç®€ç§°-Epoch-GCï¼‰" class="headerlink" title="Epoch-Based Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼Œç®€ç§° Epoch GCï¼‰"></a>Epoch-Based Reclamationï¼ˆåŸºäºä¸–ä»£çš„å›æ”¶ï¼Œç®€ç§° Epoch GCï¼‰</h3><p>æ€è·¯ï¼šæŠŠæ—¶é—´åˆ‡åˆ†æˆ epochï¼ˆä¸–ä»£ï¼‰ã€‚çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºæ—¶å£°æ˜è‡ªå·±åœ¨æŸä¸ª epochã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤åï¼Œå…ˆæ”¾åˆ°ä¸€<br>ä¸ªâ€œå»¶è¿Ÿå›æ”¶é˜Ÿåˆ—â€ï¼Œç­‰åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½ç¦»å¼€è¿™ä¸ª epoch ä¹‹åï¼Œæ‰èƒ½çœŸæ­£é‡Šæ”¾è¿™äº›èŠ‚ç‚¹ã€‚</p>
<p>ä½œç”¨ï¼šä¿è¯æ²¡æœ‰çº¿ç¨‹ä¼šåœ¨æ—§ epoch ä¸­è®¿é—®åˆ°å·²ç»é‡Šæ”¾çš„èŠ‚ç‚¹ã€‚</p>
<p>ä¼˜ç‚¹ï¼šæ¯” hazard pointer æ›´é«˜æ•ˆï¼ˆä¸ç”¨é€ä¸ªæ£€æŸ¥æŒ‡é’ˆï¼‰ã€‚</p>
<p>ç¼ºç‚¹ï¼šéœ€è¦æ‰€æœ‰çº¿ç¨‹éƒ½å‘¨æœŸæ€§åœ°æŠ¥å‘Šè‡ªå·±æ´»è·ƒçš„ epochï¼Œå¦åˆ™å†…å­˜å¯èƒ½è¿Ÿè¿Ÿå›æ”¶ä¸äº†ã€‚</p>
<p>ğŸš© ä¸ºä»€ä¹ˆä¼šå’Œ ABA æœ‰å…³ï¼Ÿ</p>
<p>åƒ Michael-Scott é˜Ÿåˆ—è¿™ç§é“¾è¡¨ç»“æ„ï¼ŒèŠ‚ç‚¹è¢« pop å‡ºé˜Ÿååœ°å€å¯èƒ½è¢«é‡ç”¨ã€‚å¦‚æœæ²¡æœ‰å®‰å…¨çš„å†…å­˜å›æ”¶ï¼Œå¦ä¸€ä¸ªçº¿<br>ç¨‹å¯èƒ½ CAS æˆåŠŸæŒ‡å‘äº†ä¸€ä¸ªâ€œå·²ç»è¢«é‡Šæ”¾å¹¶é‡ç”¨çš„åœ°å€â€ï¼Œè¿™å°±æ˜¯ ABA çš„æ ¹æºã€‚æ‰€ä»¥ hazard pointer æˆ– epoch<br>GC æ˜¯åœ¨é“¾è¡¨é˜Ÿåˆ—é‡Œç”¨æ¥é¿å…è¿™ç§ æ‚¬ç©ºå¼•ç”¨ + ABA çš„ã€‚</p>
<p>è€Œ moodycamel::ConcurrentQueue å› ä¸ºç”¨çš„æ˜¯ ç¯å½¢ buffer + sequence numberï¼ŒèŠ‚ç‚¹ä¸ä¼šåå¤ malloc&#x2F;freeï¼Œ<br>æ‰€ä»¥æ ¹æœ¬å°±ä¸éœ€è¦ hazard pointer æˆ– epoch GCã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/13/concurrency/SPSC-lock-free-queue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/13/concurrency/SPSC-lock-free-queue/" class="post-title-link" itemprop="url">å•ç”Ÿäº§è€… - å•æ¶ˆè´¹è€… æ— é”é˜Ÿåˆ—</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-13 17:09:37" itemprop="dateCreated datePublished" datetime="2025-09-13T17:09:37+00:00">2025-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/concurrency/" itemprop="url" rel="index"><span itemprop="name">concurrency</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ˜¯é˜…è¯» Cameron Desrochers çš„ <a target="_blank" rel="noopener" href="https://moodycamel.com/blog/2013/a-fast-lock-free-queue-for-c++">A Fast Lock-Free Queue for C++</a> æºç çš„ç¬”è®°ã€‚</p>
<p>ä»“åº“åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/cameron314/readerwriterqueue">https://github.com/cameron314/readerwriterqueue</a></p>
<p>å…¶ä»–å‚è€ƒæ–‡çŒ®ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://preshing.com/20120612/an-introduction-to-lock-free-programming/">An Introduction to Lock-Free Programming</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=A8eCGOqgvH4&list=PLjwoip0ltHwHCe0Nw7PDPtzlJP7rUouRL">C++ and Beyond 2012: Herb Sutter - atomic Weapons 1 of 2</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=KeLBd2EJLOU">C++ and Beyond 2012: Herb Sutter - atomic Weapons 2 of 2</a></p>
<h2 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h2><p>çº¦æŸ memory loads&#x2F;stores çš„é¡ºåºã€‚</p>
<ul>
<li>releaase å†…å­˜å±éšœï¼šå‘Šè¯‰ CPUï¼Œå¦‚æœå±éšœä¹‹åçš„ä»»ä½•å†™å…¥å˜å¾—å¯è§ï¼Œé‚£ä¹ˆå±éšœä¹‹å‰çš„ä»»ä½•å†™å…¥éƒ½åº”è¯¥åœ¨å…¶ä»–æ ¸å¿ƒä¸­å¯è§ï¼Œå‰ææ˜¯å…¶ä»–æ ¸å¿ƒåœ¨è¯»å– å†™å±éšœä¹‹åå†™å…¥çš„æ•°æ® åæ‰§è¡Œè¯»å±éšœã€‚<br>æ¢å¥è¯è¯´ï¼Œå¦‚æœçº¿ç¨‹ B å¯ä»¥çœ‹åˆ°åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ A ä¸Šçš„å†™å±éšœä¹‹åå†™å…¥çš„æ–°å€¼ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè¯»å±éšœï¼ˆåœ¨çº¿ç¨‹ B ä¸Šï¼‰ä¹‹åï¼Œå¯ä»¥ä¿è¯åœ¨çº¿ç¨‹ A ä¸Šçš„å†™å±éšœä¹‹å‰å‘ç”Ÿçš„æ‰€æœ‰å†™å…¥åœ¨çº¿ç¨‹ B ä¸Šå¯è§ã€‚</li>
</ul>
<h2 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2><ol>
<li>block: ä¸€ä¸ªè¿ç»­çš„ç¯å½¢ç¼“å†²åŒºï¼Œç”¨æ¥å­˜å‚¨å…ƒç´ ã€‚è¿™æ ·å¯ä»¥é¢„åˆ†é…å†…å­˜ã€‚</li>
<li>å—è¿‡å°ï¼ˆè¿™ä¸åˆ©äºæ— é”ï¼‰æ—¶ï¼Œæ— éœ€å°†æ‰€æœ‰ç°æœ‰å…ƒç´ å¤åˆ¶åˆ°æ–°çš„å—ä¸­ï¼›å¤šä¸ªå—ï¼ˆå¤§å°ç‹¬ç«‹ï¼‰ä»¥å¾ªç¯é“¾è¡¨çš„å½¢å¼é“¾æ¥åœ¨ä¸€èµ·ã€‚</li>
<li>å½“å‰æ’å…¥çš„å—ç§°ä¸º â€œå°¾å—â€ï¼Œå½“å‰æ¶ˆè´¹çš„å—ç§°ä¸º â€œå¤´å—â€ã€‚</li>
<li>å¤´ç´¢å¼•æŒ‡å‘ä¸‹ä¸€ä¸ªè¦è¯»å–çš„æ»¡æ§½ï¼›å°¾ç´¢å¼•æŒ‡å‘ä¸‹ä¸€ä¸ªè¦æ’å…¥çš„ç©ºæ§½ã€‚å¦‚æœä¸¤ä¸ªç´¢å¼•ç›¸ç­‰ï¼Œåˆ™å—ä¸ºç©ºï¼ˆç¡®åˆ‡åœ°è¯´ï¼Œå½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œæ°å¥½æœ‰ä¸€ä¸ªæ’æ§½ä¸ºç©ºï¼Œä»¥é¿å…åœ¨å…·æœ‰ç›¸åŒå¤´å’Œå°¾ç´¢å¼•çš„æ»¡å—å’Œç©ºå—ä¹‹é—´äº§ç”Ÿæ­§ä¹‰ï¼‰ã€‚</li>
<li>ä¸ºäº†å…è®¸é˜Ÿåˆ—å¯¹ä»»æ„çº¿ç¨‹åˆ›å»º &#x2F; ææ„ï¼ˆç‹¬ç«‹äºç”Ÿäº§ &#x2F; æ¶ˆè´¹çº¿ç¨‹ï¼‰ï¼Œå…¨å†…å­˜å±éšœï¼ˆmemory_order_acq_cstï¼‰è¢«ç”¨åœ¨ææ„å‡½æ•°åœ°æœ€åã€ææ„å‡½æ•°çš„å¼€å¤´ï¼ˆè¿™ä¼šå¼ºåˆ¶æ‰€æœ‰çš„ CPU cores åŒæ­¥ outstanding changesï¼‰ã€‚æ˜¾ç„¶ï¼Œåœ¨ææ„å‡½æ•°å¯ä»¥è¢«å®‰å…¨åœ°è°ƒç”¨ä¹‹å‰ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¿…é¡»å·²ç»åœæ­¢ä½¿ç”¨è¯¥é˜Ÿåˆ—ã€‚</li>
</ol>
<h2 id="Give-me-the-codes"><a href="#Give-me-the-codes" class="headerlink" title="Give me the codes"></a>Give me the codes</h2><ol>
<li>ç”¨æˆ·ä¸éœ€è¦ç®¡ç†å†…å­˜ã€‚</li>
<li>é¢„åˆ†é…å†…å­˜ï¼Œåœ¨è¿ç»­çš„å—ä¸­ã€‚</li>
<li><code>try_enqueue</code>: ä¿è¯ä¸ä¼šåˆ†é…å†…å­˜ï¼ˆé˜Ÿåˆ—æœ‰åˆå§‹å®¹é‡ï¼‰ï¼›</li>
<li><code>enqueue</code>: ä¼šæ ¹æ®éœ€è¦åŠ¨æ€æ‰©å®¹ã€‚</li>
<li>æ²¡æœ‰ä½¿ç”¨ CAS loopï¼›è¿™æ„å‘³è€… enqueue å’Œ dequeue æ˜¯ O(1) çš„ï¼ˆæ²¡æœ‰è®¡å…¥å†…å­˜åˆ†é…çš„æ—¶é—´ï¼‰ã€‚</li>
<li>å› ä¸ºåœ¨ x86 å¹³å°ï¼Œå†…å­˜å±éšœæ˜¯ç©ºæ“ä½œï¼Œæ‰€ä»¥ enqueue å’Œ dequeue æ˜¯ä¸€ç³»åˆ—ç®€å•çš„ loads å’Œ stores (and branches) ã€‚</li>
</ol>
<p>æ­¤ä»£ç ä»…ä»…é€‚ç”¨äºä»¥åŸå­æ–¹å¼å¤„ç† è‡ªç„¶å¯¹é½çš„æ•´å‹ï¼ˆaligned integerï¼‰ å’Œ åŸç”ŸæŒ‡é’ˆå¤§å°ï¼ˆnative-pointer-sizeï¼‰ çš„ loads&#x2F;stores çš„ CPU ä¸Šï¼›<br>å¹¸è¿çš„æ˜¯ï¼Œè¿™åŒ…æ‹¬äº†æ‰€æœ‰çš„ç°ä»£å¤„ç†å™¨ï¼ˆåŒ…æ‹¬ ARM, x86&#x2F;x86_64 å’Œ PowerPCï¼‰ã€‚<br>å®ƒä¸æ˜¯ä¸ºåœ¨ DEC Alpha ä¸Šè¿è¡Œè€Œè®¾è®¡çš„ï¼ˆDEC Alpha ä¼¼ä¹å…·æœ‰æœ‰å²ä»¥æ¥æœ€å¼±çš„å†…å­˜æ’åºä¿è¯ï¼‰ã€‚</p>
<p>æ³¨ï¼šåœ¨ x86 ä¸Šï¼Œmemory_order_acquire&#x2F;release é€šå¸¸ä¸éœ€è¦é¢å¤–æŒ‡ä»¤å°±èƒ½å®ç°è¯­ä¹‰ï¼Œä½†ä»ç„¶èƒ½é™åˆ¶ç¼–è¯‘å™¨çš„é‡æ’ã€‚<br>fetch_add ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œè€Œæ˜¯ä¸‰ä¸ªï¼šload, add, store. æ‰€ä»¥ä¸é€‚ç”¨ä¸Šè¿°è¯´çš„ â€œè‡ªç„¶å¯¹é½çš„æ•´å‹â€ æˆ–â€œåŸç”ŸæŒ‡é’ˆå¤§å°â€çš„ load&#x2F;store.</p>
<h2 id="æ€§èƒ½ä¼˜åŒ–ç‚¹"><a href="#æ€§èƒ½ä¼˜åŒ–ç‚¹" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–ç‚¹"></a>æ€§èƒ½ä¼˜åŒ–ç‚¹</h2><ol>
<li>å¹³å‡¡ææ„ï¼šè·³è¿‡ææ„ï¼Œç›´æ¥é‡Šæ”¾å†…å­˜ã€‚</li>
<li><a target="_blank" rel="noopener" href="http://www.cse.cuhk.edu.hk/~pclee/www/pubs/ancs09poster.pdf">MCRingBuffer paper</a><ol>
<li>cache line padding</li>
<li>local control variables<ol>
<li>å‡å°‘å¯¹å…¨å±€ read&#x2F;write æŒ‡é’ˆçš„è¯»å–</li>
</ol>
</li>
<li>local block</li>
</ol>
</li>
</ol>
<h2 id="æ­£ç¡®æ€§æµ‹è¯•"><a href="#æ­£ç¡®æ€§æµ‹è¯•" class="headerlink" title="æ­£ç¡®æ€§æµ‹è¯•"></a>æ­£ç¡®æ€§æµ‹è¯•</h2><ol>
<li>å®šä¹‰ä¸å¯é¢„æµ‹æ€§å»¶æ—¶å‡½æ•°ï¼Œç”¨äºæ¨¡æ‹Ÿçº¿ç¨‹è°ƒåº¦ã€‚</li>
<li>å†™çº¿ç¨‹å¡å…¥ 32 M ä¸ªæ•°æ®ï¼›è¯»çº¿ç¨‹è¯»å– 32 M æ¬¡ã€‚è¯»å†™çº¿ç¨‹ä¸­ä½¿ç”¨ unpredDelay() æ¨¡æ‹Ÿè°ƒåº¦å»¶è¿Ÿã€‚</li>
<li>æµ‹è¯•èƒ½å¦é¡ºåºè¯»å–ï¼Œå¤±è´¥åˆ™æ‰“å°æ—¥å¿—ï¼Œä¸é€€å‡ºã€‚</li>
<li>æµ‹è¯•ç¨‹åºæ— é™è¿è¡Œï¼Œæ¯æ¬¡ä½¿ç”¨ä¸€ä¸ªå†™çº¿ç¨‹å’Œè¯»çº¿ç¨‹ã€‚ç›´è‡³æ‰‹åŠ¨ Ctrl C å…³é—­ã€‚</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/08/%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/08/%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD/" class="post-title-link" itemprop="url">æµ‹è¯•ç£ç›˜æ€§èƒ½</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-08 11:27:57" itemprop="dateCreated datePublished" datetime="2025-09-08T11:27:57+00:00">2025-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æŸ¥çœ‹ç£ç›˜ç±»å‹"><a href="#æŸ¥çœ‹ç£ç›˜ç±»å‹" class="headerlink" title="æŸ¥çœ‹ç£ç›˜ç±»å‹"></a>æŸ¥çœ‹ç£ç›˜ç±»å‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lsblk -d -o name,rota,<span class="built_in">type</span>,size,model</span><br><span class="line">NAME ROTA TYPE  SIZE MODEL</span><br><span class="line">sda     1 disk  1.8T PERC H740P Mini</span><br></pre></td></tr></table></figure>

<p><code>ROTA=1</code>ï¼šè¿™æ˜¯æ—‹è½¬ç£ç›˜ã€‚</p>
<h2 id="æµ‹è¯•æ–¹æ³•"><a href="#æµ‹è¯•æ–¹æ³•" class="headerlink" title="æµ‹è¯•æ–¹æ³•"></a>æµ‹è¯•æ–¹æ³•</h2><p>é¡ºåºå†™ååæµ‹è¯•ï¼ˆé€¼è¿‘æœ€å¤§å†™å…¥é€Ÿåº¦ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=seqwrite --rw=write --bs=1M --size=5G --numjobs=4 --iodepth=32 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>

<p>éšæœºè¯» IOPS æµ‹è¯•ï¼ˆé€¼è¿‘æœ€å¤§å¹¶å‘å¤„ç†èƒ½åŠ›ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=randread --rw=randread --bs=4k --size=5G --numjobs=4 --iodepth=64 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>

<p>æ··åˆè¯»å†™æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿæ•°æ®åº“è´Ÿè½½ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=mixrw --rw=randrw --rwmixread=70 --bs=4k --size=5G --numjobs=4 --iodepth=32 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>


<h2 id="ç£ç›˜çš„æµ‹è¯•ç»“æœ"><a href="#ç£ç›˜çš„æµ‹è¯•ç»“æœ" class="headerlink" title="ç£ç›˜çš„æµ‹è¯•ç»“æœ"></a>ç£ç›˜çš„æµ‹è¯•ç»“æœ</h2><p>ç”±äºæ˜¯æ—‹è½¬ç£ç›˜ï¼Œiodepth æ€»æ˜¯ 1ï¼ˆè®¾æˆå…¶ä»–å€¼ä¸ä¼šç”Ÿæ•ˆï¼‰</p>
<p><strong>å•çº¿ç¨‹è¯»å†™æ–‡ä»¶ï¼š</strong></p>
<details>
  <summary>ç‚¹å‡»å±•å¼€ä»£ç </summary>
  <pre>
    <figure class="highlight bash"><figcaption><span>fio_bs_test.sh</span><a href="/blog/downloads/code/fio_bs_test.sh">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•å‚æ•°</span></span><br><span class="line">DEVICE=<span class="string">&quot;./testfile&quot;</span>   <span class="comment"># ä¿®æ”¹ä¸ºä½ è¦æµ‹è¯•çš„æ–‡ä»¶æˆ–è®¾å¤‡è·¯å¾„</span></span><br><span class="line">RUNTIME=30                       <span class="comment"># æ¯ä¸ªæµ‹è¯•è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line"><span class="comment"># BLOCK_SIZES=(&quot;4k&quot; &quot;16k&quot; &quot;64k&quot; &quot;256k&quot; &quot;1M&quot; &quot;4M&quot; &quot;16M&quot; &quot;32M&quot; &quot;64M&quot; &quot;128M&quot;)  # æµ‹è¯•å—å¤§å°åˆ—è¡¨</span></span><br><span class="line">BLOCK_SIZES=(<span class="string">&quot;128M&quot;</span> <span class="string">&quot;64M&quot;</span> <span class="string">&quot;32M&quot;</span> <span class="string">&quot;16M&quot;</span> <span class="string">&quot;4M&quot;</span> <span class="string">&quot;1M&quot;</span> <span class="string">&quot;256k&quot;</span> <span class="string">&quot;64k&quot;</span> <span class="string">&quot;16k&quot;</span> <span class="string">&quot;4k&quot;</span>)  <span class="comment"># æµ‹è¯•å—å¤§å°åˆ—è¡¨</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;fio_bs_output.log&quot;</span>        <span class="comment"># åŸå§‹è¾“å‡ºæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line">PERFORMANCE_LOG=<span class="string">&quot;fio_bs_performance.log&quot;</span>  <span class="comment"># æ€§èƒ½ç»“æœæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºè¡¨å¤´</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s | %-10s | %-8s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;RW&quot;</span> <span class="string">&quot;BlockSize&quot;</span> <span class="string">&quot;IOPS&quot;</span> <span class="string">&quot;BW(MiB/s)&quot;</span> <span class="string">&quot;AvgLat(ms)&quot;</span> | <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------------------------------------------------------&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>  <span class="comment"># æ¸…ç©ºæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¾ªç¯æµ‹è¯•ä¸åŒå—å¤§å°</span></span><br><span class="line"><span class="keyword">for</span> RW <span class="keyword">in</span> <span class="built_in">read</span> write; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> BS <span class="keyword">in</span> <span class="string">&quot;<span class="variable">${BLOCK_SIZES[@]}</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    OUTPUT=$(fio --name=bs_test \</span><br><span class="line">                 --filename=<span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span> \</span><br><span class="line">                 --rw=<span class="variable">$RW</span> \</span><br><span class="line">                 --bs=<span class="variable">$BS</span> \</span><br><span class="line">                 --size=1G \</span><br><span class="line">                 --time_based \</span><br><span class="line">                 --runtime=<span class="variable">$RUNTIME</span> \</span><br><span class="line">                 --numjobs=1 \</span><br><span class="line">                 --direct=1 \</span><br><span class="line">                 --ioengine=psync \</span><br><span class="line">                 --group_reporting)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;----------------------------------------------&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–å…³é”®æŒ‡æ ‡</span></span><br><span class="line">    <span class="built_in">read</span> IOPS BW BWUNIT LAT LAT_UNIT &lt;&lt;&lt; $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> | awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        /IOPS=/ {match($0, /IOPS= *([0-9.]+)/, iops)}</span></span><br><span class="line"><span class="string">        /BW=/ {</span></span><br><span class="line"><span class="string">            match($0, /BW= *([0-9.]+)([KMG]iB)\/s/, bwinfo)</span></span><br><span class="line"><span class="string">            bwval=bwinfo[1]; bwunit=bwinfo[2]</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">        /clat \(/ {match($0, /avg= *([0-9.]+),/, lat); match($0, /\(([^)]+)\)/, lat_unit)}</span></span><br><span class="line"><span class="string">        END {print iops[1], bwval, bwunit, lat[1], lat_unit[1]}</span></span><br><span class="line"><span class="string">    &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å»¶è¿Ÿå•ä½æ¢ç®—</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;usec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$LAT</span>/1000}&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;msec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=<span class="variable">$LAT</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        LAT_MS=<span class="string">&quot;Unknown&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¸¦å®½å•ä½æ¢ç®—ä¸º MiB/s</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$BWUNIT</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;KiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>/1024}&quot;</span>) ;;</span><br><span class="line">        <span class="string">&quot;MiB&quot;</span>) BW_MIB=<span class="variable">$BW</span> ;;</span><br><span class="line">        <span class="string">&quot;GiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>*1024}&quot;</span>) ;;</span><br><span class="line">        *) BW_MIB=<span class="string">&quot;Unknown&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¾“å‡ºç»“æœè¡Œ</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;%-8s | %-10s | %-8s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;<span class="variable">$RW</span>&quot;</span> <span class="string">&quot;<span class="variable">$BS</span>&quot;</span> <span class="string">&quot;<span class="variable">$IOPS</span>&quot;</span> <span class="string">&quot;<span class="variable">$BW_MIB</span>&quot;</span> <span class="string">&quot;<span class="variable">$LAT_MS</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ fio åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æµ‹è¯•å®Œæˆï¼Œç»“æœå·²ä¿å­˜åˆ° <span class="variable">$LOG_FILE</span> å’Œ <span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br></pre></td></tr></table></figure>
  </pre>
</details>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RW       | BlockSize  | IOPS     | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">read     | 4k         | 194      | 0.76       | 5.14</span><br><span class="line">read     | 16k        | 239      | 3.74       | 4.17</span><br><span class="line">read     | 64k        | 347      | 21.7       | 2.88</span><br><span class="line">read     | 256k       | 271      | 67.9       | 3.68</span><br><span class="line">read     | 1M         | 94       | 94.9       | 10.53</span><br><span class="line">read     | 4M         | 14       | 57.2       | 69.74</span><br><span class="line">read     | 16M        | 6        | 97.6       | 163.96</span><br><span class="line">read     | 32M        | 3        | 111        | 288.99</span><br><span class="line">read     | 64M        | 1        | 112        | 573.70</span><br><span class="line">read     | 128M       | 0        | 112        | 1147.00</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RW       | BlockSize  | IOPS     | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">write    | 4k         | 1884     | 7.36       | 0.53</span><br><span class="line">write    | 16k        | 1452     | 22.7       | 0.69</span><br><span class="line">write    | 64k        | 793      | 49.6       | 1.26</span><br><span class="line">write    | 256k       | 307      | 76.8       | 3.24</span><br><span class="line">write    | 1M         | 100      | 100        | 9.96</span><br><span class="line">write    | 4M         | 18       | 73.7       | 53.99</span><br><span class="line">write    | 16M        | 5        | 93.8       | 169.43</span><br><span class="line">write    | 32M        | 3        | 101        | 313.24</span><br><span class="line">write    | 64M        | 1        | 107        | 594.46</span><br><span class="line">write    | 128M       | 0        | 102        | 1249.35</span><br></pre></td></tr></table></figure>


<p>å½“ BlockSize&#x3D;32M ä»¥åï¼Œå†™å…¥æ€§èƒ½åŸºæœ¬è¾¾åˆ°é¡¶å³°ï¼ˆ110 MiB&#x2F;sï¼‰ï¼Œå’Œæ—‹è½¬ç£ç›˜çš„å‚æ•°åŸºæœ¬ä¸€è‡´ã€‚</p>
<p><strong>å¤šçº¿ç¨‹è¯»å†™åŒä¸€ä¸ªæ–‡ä»¶ï¼ŒBS&#x3D;64KiBï¼š</strong></p>
<details>
  <summary>ç‚¹å‡»å±•å¼€ä»£ç </summary>
  <pre>
    <figure class="highlight bash"><figcaption><span>fio_mt_test.sh</span><a href="/blog/downloads/code/fio_mt_test.sh">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">DEVICE=<span class="string">&quot;./mt_testfile&quot;</span>   <span class="comment"># æµ‹è¯•æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">RUNTIME=30            <span class="comment"># æ¯ä¸ªæµ‹è¯•è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">THREADS=(1 2 4 8 16 32 64 72 120)  <span class="comment"># æµ‹è¯•çº¿ç¨‹æ•°åˆ—è¡¨</span></span><br><span class="line">BLOCK_SIZE=<span class="string">&quot;64k&quot;</span>      <span class="comment"># å—å¤§å°ï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;fio_thread_output.log&quot;</span></span><br><span class="line">PERFORMANCE_LOG=<span class="string">&quot;fio_thread_performance.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºè¡¨å¤´</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s | %-8s | %-10s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;RW&quot;</span> <span class="string">&quot;Threads&quot;</span> <span class="string">&quot;IOPS&quot;</span> <span class="string">&quot;BW(MiB/s)&quot;</span> <span class="string">&quot;AvgLat(ms)&quot;</span> | <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---------------------------------------------------------------&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>  <span class="comment"># æ¸…ç©ºæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> RW <span class="keyword">in</span> <span class="built_in">read</span> write; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> THREAD <span class="keyword">in</span> <span class="string">&quot;<span class="variable">${THREADS[@]}</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    OUTPUT=$(fio --name=thread_test \</span><br><span class="line">                 --filename=<span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span> \</span><br><span class="line">                 --rw=<span class="variable">$RW</span> \</span><br><span class="line">                 --bs=<span class="variable">$BLOCK_SIZE</span> \</span><br><span class="line">                 --size=5G \</span><br><span class="line">                 --time_based \</span><br><span class="line">                 --runtime=<span class="variable">$RUNTIME</span> \</span><br><span class="line">                 --numjobs=<span class="variable">$THREAD</span> \</span><br><span class="line">                 --direct=1 \</span><br><span class="line">                 --ioengine=psync \</span><br><span class="line">                 --group_reporting)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;---------------------------------------------------------------&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–å…³é”®æŒ‡æ ‡</span></span><br><span class="line">    <span class="built_in">read</span> IOPS BW BWUNIT LAT LAT_UNIT &lt;&lt;&lt; $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> | awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        /IOPS=/ {match($0, /IOPS= *([0-9.]+)/, iops)}</span></span><br><span class="line"><span class="string">        /BW=/ {</span></span><br><span class="line"><span class="string">            match($0, /BW= *([0-9.]+)([KMG]iB)\/s/, bwinfo)</span></span><br><span class="line"><span class="string">            bwval=bwinfo[1]; bwunit=bwinfo[2]</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">        /clat \(/ {match($0, /avg= *([0-9.]+),/, lat); match($0, /\(([^)]+)\)/, lat_unit)}</span></span><br><span class="line"><span class="string">        END {print iops[1], bwval, bwunit, lat[1], lat_unit[1]}</span></span><br><span class="line"><span class="string">    &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å»¶è¿Ÿå•ä½æ¢ç®—</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;usec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$LAT</span>/1000}&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;msec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=<span class="variable">$LAT</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        LAT_MS=<span class="string">&quot;Unknown&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¸¦å®½å•ä½æ¢ç®—ä¸º MiB/s</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$BWUNIT</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;KiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>/1024}&quot;</span>) ;;</span><br><span class="line">        <span class="string">&quot;MiB&quot;</span>) BW_MIB=<span class="variable">$BW</span> ;;</span><br><span class="line">        <span class="string">&quot;GiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>*1024}&quot;</span>) ;;</span><br><span class="line">        *) BW_MIB=<span class="string">&quot;Unknown&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¾“å‡ºç»“æœè¡Œ</span></span><br><span class="line">  <span class="built_in">printf</span> <span class="string">&quot;%-8s | %-8s | %-10s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;<span class="variable">$RW</span>&quot;</span> <span class="string">&quot;<span class="variable">$THREAD</span>&quot;</span> <span class="string">&quot;<span class="variable">$IOPS</span>&quot;</span> <span class="string">&quot;<span class="variable">$BW_MIB</span>&quot;</span> <span class="string">&quot;<span class="variable">$LAT_MS</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æµ‹è¯•å®Œæˆï¼Œç»“æœå·²ä¿å­˜åˆ° <span class="variable">$LOG_FILE</span> å’Œ <span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br></pre></td></tr></table></figure>
  </pre>
</details>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RW       | Threads  | IOPS       | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">read     | 1        | 826        | 51.6       | 1.21</span><br><span class="line">read     | 2        | 1300       | 81.3       | 1.54</span><br><span class="line">read     | 4        | 1681       | 105        | 2.38</span><br><span class="line">read     | 8        | 1778       | 111        | 4.49</span><br><span class="line">read     | 16       | 1789       | 112        | 8.93</span><br><span class="line">read     | 32       | 1790       | 112        | 17.86</span><br><span class="line">read     | 64       | 1789       | 112        | 35.73</span><br><span class="line">read     | 72       | 1790       | 112        | 40.18</span><br><span class="line">read     | 120      | 1789       | 112        | 66.98</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RW       | Threads  | IOPS       | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">write    | 1        | 847        | 52.9       | 1.18</span><br><span class="line">write    | 2        | 1367       | 85.5       | 1.46</span><br><span class="line">write    | 4        | 1757       | 110        | 2.27</span><br><span class="line">write    | 8        | 1786       | 112        | 4.47</span><br><span class="line">write    | 16       | 1788       | 112        | 8.92</span><br><span class="line">write    | 32       | 1788       | 112        | 17.79</span><br><span class="line">write    | 64       | 1788       | 112        | 35.09</span><br><span class="line">write    | 72       | 1788       | 112        | 39.54</span><br><span class="line">write    | 120      | 1784       | 112        | 64.50</span><br></pre></td></tr></table></figure>

<p>å½“çº¿ç¨‹æ•°å¢åŠ ï¼ŒIO æ€§èƒ½éšä¹‹æé«˜ï¼Œå¯èƒ½åŸå› æ˜¯ 64KiB å°å—æ•°æ®å¤§é‡æäº¤åˆ° I&#x2F;O é˜Ÿåˆ—ï¼Œæ“ä½œç³»ç»Ÿèƒ½æ›´å¥½åœ°å®Œæˆè¯»å†™è·¯å¾„ä¼˜åŒ–ã€‚<br>ä½†è¾¾åˆ°8çº¿ç¨‹çš„æ—¶å€™ï¼Œå°±åŸºæœ¬åˆ°è¾¾æ€§èƒ½é¡¶å³°äº†ã€‚</p>
<p>æ³¨æ„ï¼šfio å¤šçº¿ç¨‹å†™å…¥åŒä¸€ä¸ªæ–‡ä»¶æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œå¦‚æœè¶…è¿‡ page cache (ä¸€èˆ¬æ˜¯ 4 KB)ï¼Œé‚£ä¹ˆå¯èƒ½ä¹±åºå†™å…¥ã€‚</p>
<h2 id="æ¦‚å¿µï¼ˆä»¥-fio-ä¸ºä¾‹ï¼‰"><a href="#æ¦‚å¿µï¼ˆä»¥-fio-ä¸ºä¾‹ï¼‰" class="headerlink" title="æ¦‚å¿µï¼ˆä»¥ fio ä¸ºä¾‹ï¼‰"></a>æ¦‚å¿µï¼ˆä»¥ fio ä¸ºä¾‹ï¼‰</h2><h3 id="ioengine"><a href="#ioengine" class="headerlink" title="ioengine"></a>ioengine</h3><p>ioengineï¼ˆI&#x2F;O å¼•æ“ï¼‰æ˜¯ fio æä¾›ä»¥æ‰§è¡Œè¯»å†™ä»»åŠ¡çš„åº•å±‚æ¥å£ã€‚ä¸åŒçš„å¼•æ“ä»£è¡¨ä¸åŒçš„ I&#x2F;O æ¨¡å‹ï¼Œæ¯”å¦‚åŒæ­¥ã€å¼‚æ­¥ã€å†…å­˜æ˜ å°„ã€é›¶æ‹·è´ç­‰ã€‚</p>
<table>
<thead>
<tr>
<th align="center">å¼•æ“åç§°</th>
<th align="center">ç±»å‹</th>
<th align="center">ç‰¹ç‚¹ä¸ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync</td>
<td align="center">åŒæ­¥</td>
<td align="center">é»˜è®¤æ–¹å¼ï¼Œæ¯æ¬¡ I&#x2F;O éƒ½ç­‰å¾…å®Œæˆï¼Œé€‚åˆç®€å•æµ‹è¯•</td>
</tr>
<tr>
<td align="center">psync</td>
<td align="center">åŒæ­¥</td>
<td align="center">ä½¿ç”¨ pread&#x2F;pwriteï¼Œå¯æŒ‡å®šåç§»ï¼Œç•¥å¿«</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">å¼‚æ­¥</td>
<td align="center">Linux å¼‚æ­¥ I&#x2F;Oï¼Œé€‚åˆé«˜æ€§èƒ½ SSD&#x2F;NVMe</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">å¼‚æ­¥</td>
<td align="center">æ–°ä¸€ä»£ Linux å¼‚æ­¥æ¥å£ï¼Œä½å»¶è¿Ÿã€é«˜å¹¶å‘</td>
</tr>
<tr>
<td align="center">mmap</td>
<td align="center">å†…å­˜æ˜ å°„</td>
<td align="center">å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œé€‚åˆå¤§æ–‡ä»¶é¡ºåºè®¿é—®</td>
</tr>
<tr>
<td align="center">splice</td>
<td align="center">é›¶æ‹·è´</td>
<td align="center">ç”¨äºé«˜æ•ˆæ•°æ®ä¼ è¾“ï¼Œå‡å°‘ CPU å’Œå†…å­˜å¼€é”€</td>
</tr>
<tr>
<td align="center">windowsaio</td>
<td align="center">å¼‚æ­¥</td>
<td align="center">Windows åŸç”Ÿå¼‚æ­¥ I&#x2F;Oï¼Œé€‚åˆå¤šçº¿ç¨‹å†™å…¥</td>
</tr>
<tr>
<td align="center">net</td>
<td align="center">ç½‘ç»œ</td>
<td align="center">ç”¨äºç½‘ç»œ I&#x2F;O æµ‹è¯•ï¼Œå¦‚ socket ä¼ è¾“</td>
</tr>
<tr>
<td align="center">sg</td>
<td align="center">SCSI</td>
<td align="center">ç”¨äºç›´æ¥è®¿é—® SCSI è®¾å¤‡</td>
</tr>
</tbody></table>
<p>æ¯ç§ ioengine éƒ½ä¾èµ–æ“ä½œç³»ç»Ÿæä¾›çš„åº•å±‚ I&#x2F;O æ¥å£ã€‚ä¾‹å¦‚ï¼š</p>
<table>
<thead>
<tr>
<th align="center">ioengine ç±»å‹</th>
<th align="center">æ“ä½œç³»ç»Ÿè¦æ±‚</th>
<th align="center">æ˜¯å¦å¼‚æ­¥</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync &#x2F; psync</td>
<td align="center">æ‰€æœ‰ç³»ç»Ÿ</td>
<td align="center">âŒ</td>
<td align="center">ä½¿ç”¨æ ‡å‡†é˜»å¡ I&#x2F;Oï¼Œå‡ ä¹æ€»æ˜¯å¯ç”¨</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">Linuxï¼Œéœ€å®‰è£… libaio åº“</td>
<td align="center">âœ…</td>
<td align="center">ä¾èµ– Linux çš„å¼‚æ­¥ I&#x2F;O æ¥å£</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">Linux â‰¥ 5.1ï¼Œæ¨è â‰¥ 5.4</td>
<td align="center">âœ…</td>
<td align="center">ä¾èµ–æ–°å†…æ ¸ç‰¹æ€§å’Œ liburing åº“</td>
</tr>
<tr>
<td align="center">windowsaio</td>
<td align="center">Windows</td>
<td align="center">âœ…</td>
<td align="center">ä½¿ç”¨ Windows åŸç”Ÿå¼‚æ­¥ I&#x2F;O</td>
</tr>
<tr>
<td align="center">mmap</td>
<td align="center">æ‰€æœ‰ä¸»æµç³»ç»Ÿ</td>
<td align="center">âŒ</td>
<td align="center">ä½¿ç”¨å†…å­˜æ˜ å°„ï¼Œé€‚åˆé¡ºåºè¯»å†™</td>
</tr>
<tr>
<td align="center">posixaio</td>
<td align="center">POSIX å…¼å®¹ç³»ç»Ÿ</td>
<td align="center">âœ…</td>
<td align="center">ä½¿ç”¨ aio_read &#x2F; aio_write æ¥å£</td>
</tr>
</tbody></table>
<p>ä½ å¯ä»¥æŒ‡å®šä»»æ„ ioengine ï¼ˆé»˜è®¤å€¼æ˜¯ sync &#x2F; psyncï¼‰ï¼Œä½†å®ƒæ˜¯å¦èƒ½è¿è¡Œï¼Œå¿…é¡»å¾—åˆ°æ“ä½œç³»ç»Ÿçš„æ”¯æŒã€‚è¿™åŒ…æ‹¬å†…æ ¸ç‰ˆæœ¬ã€ç³»ç»Ÿæ¥å£ã€åº“æ–‡ä»¶ç­‰ã€‚å¦‚æœç³»ç»Ÿä¸æ”¯æŒï¼Œfio ä¼šæŠ¥é”™æˆ–è‡ªåŠ¨å›é€€ã€‚</p>
<p>æŸ¥çœ‹æ”¯æŒåˆ—è¡¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --enghelp</span><br></pre></td></tr></table></figure>

<p>è¿™ä¼šåˆ—å‡ºå½“å‰ç³»ç»Ÿä¸Šå¯ç”¨çš„ ioengineï¼Œä½†æ³¨æ„ï¼šåˆ—å‡ºæ¥ â‰  èƒ½ç”¨ï¼Œè¿˜è¦çœ‹è¿è¡Œæ—¶æ˜¯å¦æŠ¥é”™ã€‚</p>
<p>å®é™…æµ‹è¯•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=<span class="built_in">test</span> --ioengine=io_uring --rw=write --size=1G --bs=1M</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸æ”¯æŒï¼Œä¼šæŠ¥é”™ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio: pid=132756, err=38/file:engines/io_uring.c:1351, func=io_queue_init, error=Function not implemented</span><br></pre></td></tr></table></figure>

<h3 id="iodepth"><a href="#iodepth" class="headerlink" title="iodepth"></a>iodepth</h3><p><code>--iodepth</code> æ˜¯ä¼ é€’ç»™å†…æ ¸çš„å‚æ•°ã€‚</p>
<p>å¦‚æœä½ ä¸æ˜¾å¼è®¾ç½® <code>--iodepth</code>ï¼Œé‚£ä¹ˆ fio ä¼šæ ¹æ®æ‰€é€‰çš„ I&#x2F;O å¼•æ“ï¼ˆ<code>--ioengine</code>ï¼‰ æ¥å†³å®šé»˜è®¤å€¼</p>
<table>
<thead>
<tr>
<th align="center">I&#x2F;O å¼•æ“</th>
<th align="center">é»˜è®¤ iodepth</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync &#x2F; psync &#x2F; vsync</td>
<td align="center">1ï¼ˆåŒæ­¥ I&#x2F;Oï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªå¤„ç†ï¼‰</td>
</tr>
<tr>
<td align="center">libaio &#x2F; io_uring</td>
<td align="center">1ï¼Œä½†å¯ä»¥è®¾ç½®æ›´é«˜ä»¥å¯ç”¨å¼‚æ­¥å¹¶å‘</td>
</tr>
<tr>
<td align="center">mmap &#x2F; pread &#x2F; pwrite</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">windowsaioï¼ˆWindowsï¼‰</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">sgï¼ˆSCSI genericï¼‰</td>
<td align="center">1</td>
</tr>
</tbody></table>
<p>fio å¹¶ä¸ä¼šä¸»åŠ¨ç»´æŠ¤é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ˜¯å†…æ ¸çš„ç‰¹æ€§ã€‚</p>
<table>
<thead>
<tr>
<th align="center">I&#x2F;O å¼•æ“</th>
<th align="center">é˜Ÿåˆ—ä½ç½®</th>
<th align="center">æ˜¯å¦å¼‚æ­¥</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">psync &#x2F; sync</td>
<td align="center">æ— é˜Ÿåˆ—ï¼ˆç›´æ¥è°ƒç”¨ï¼‰</td>
<td align="center">å¦</td>
<td align="center">æ¯æ¬¡å†™å…¥è°ƒç”¨ write()ï¼Œæ— æ’é˜Ÿæœºåˆ¶</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">å†…æ ¸ç©ºé—´</td>
<td align="center">âœ… æ˜¯</td>
<td align="center">ä½¿ç”¨ Linux AIOï¼Œé˜Ÿåˆ—åœ¨å†…æ ¸ä¸­ï¼Œç”± io_submit() æäº¤</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">ç”¨æˆ· + å†…æ ¸å…±äº«</td>
<td align="center">âœ… æ˜¯</td>
<td align="center">ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºï¼Œç”¨æˆ·ç©ºé—´æäº¤ï¼Œå†…æ ¸ç©ºé—´å¤„ç†</td>
</tr>
<tr>
<td align="center">mmap &#x2F; null</td>
<td align="center">ç”¨æˆ·ç©ºé—´</td>
<td align="center">âŒ å¦</td>
<td align="center">æ¨¡æ‹Ÿæˆ–è·³è¿‡å®é™… I&#x2F;Oï¼Œä¸æ¶‰åŠå†…æ ¸é˜Ÿåˆ—</td>
</tr>
</tbody></table>
<ul>
<li>å¯¹äºæ”¯æŒå¼‚æ­¥ I&#x2F;O çš„å¼•æ“ï¼ˆå¦‚ libaio æˆ– io_uringï¼‰ï¼Œä½ å¯ä»¥è®¾ç½®æ›´é«˜çš„ iodepthï¼ˆå¦‚ 32ã€64ã€128ï¼‰æ¥æ¨¡æ‹Ÿé«˜å¹¶å‘è´Ÿè½½ï¼›</li>
<li>å¯¹ SSD æˆ– NVMe è®¾å¤‡ï¼Œé«˜ iodepth èƒ½æ˜¾è‘—æå‡ IOPS å’Œååé‡ï¼›</li>
<li>å¯¹æœºæ¢°ç¡¬ç›˜ï¼Œæå‡æœ‰é™ï¼Œä½†ä»å¯ç”¨äºæµ‹è¯•è°ƒåº¦ç­–ç•¥å’Œé˜Ÿåˆ—è¡Œä¸ºã€‚</li>
</ul>
<p>ä½†å¦‚æœä½ çš„ ioengine æ˜¯ sync æˆ– psyncï¼Œè¿™äº›æ˜¯åŒæ­¥é˜»å¡ I&#x2F;Oï¼Œæ ¹æœ¬ä¸æ”¯æŒé«˜å¹¶å‘ï¼Œæ‰€ä»¥ iodepth å®é™…ä¸Šä¸ä¼šç”Ÿæ•ˆã€‚</p>
<table>
<thead>
<tr>
<th align="center">å‚æ•°</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">â€“name&#x3D;seqwrite</td>
<td align="center">å®šä¹‰æµ‹è¯•ä»»åŠ¡çš„åç§°ä¸º seqwriteï¼Œç”¨äºæ ‡è¯†è¾“å‡ºç»“æœ</td>
</tr>
<tr>
<td align="center">â€“rw&#x3D;write</td>
<td align="center">è®¾ç½®ä¸ºé¡ºåºå†™å…¥æ¨¡å¼ï¼ˆsequential writeï¼‰ï¼Œæ•°æ®æŒ‰é¡ºåºå†™å…¥ç£ç›˜</td>
</tr>
<tr>
<td align="center">â€“bs&#x3D;1M</td>
<td align="center">æ¯æ¬¡ I&#x2F;O æ“ä½œçš„å—å¤§å°ä¸º 1MBï¼Œé€‚åˆæµ‹è¯•ååé‡</td>
</tr>
<tr>
<td align="center">â€“size&#x3D;5G</td>
<td align="center">æ¯ä¸ªçº¿ç¨‹å†™å…¥çš„æ€»æ•°æ®é‡ä¸º 5GBï¼ˆä¸æ˜¯æ€»å…±ï¼Œæ˜¯æ¯ä¸ª jobï¼‰</td>
</tr>
<tr>
<td align="center">â€“numjobs&#x3D;4</td>
<td align="center">å¯åŠ¨ 4 ä¸ªå¹¶å‘çº¿ç¨‹ï¼ˆjobï¼‰ï¼Œæ¨¡æ‹Ÿå¤šçº¿ç¨‹å†™å…¥åœºæ™¯</td>
</tr>
<tr>
<td align="center">â€“iodepth&#x3D;32</td>
<td align="center">æ¯ä¸ªçº¿ç¨‹çš„ I&#x2F;O é˜Ÿåˆ—æ·±åº¦ä¸º 32ï¼Œè¡¨ç¤ºæœ€å¤šå¯åŒæ—¶æŒ‚èµ· 32 ä¸ª I&#x2F;O è¯·æ±‚ <br> æœ¬ä¾‹ä¸­æ¯ä¸ªçº¿ç¨‹ä¼šå‘èµ· 5G&#x2F;1M&#x3D;5120 ä¸ª I&#x2F;O è¯·æ±‚</td>
</tr>
<tr>
<td align="center">â€“direct&#x3D;1</td>
<td align="center">ç»•è¿‡ç³»ç»Ÿç¼“å­˜ï¼Œç›´æ¥å¯¹ç£ç›˜è¿›è¡Œè¯»å†™ï¼Œæ›´çœŸå®åœ°åæ˜ è®¾å¤‡æ€§èƒ½</td>
</tr>
<tr>
<td align="center">â€“runtime&#x3D;60</td>
<td align="center">æµ‹è¯•æŒç»­æ—¶é—´ä¸º 60 ç§’ï¼Œä¼˜å…ˆäº â€“sizeï¼Œ<br>1. å³ä½¿æ•°æ®å†™å®Œä¹Ÿç»§ç»­å†™æ›´å¤šæ•°æ®ç›´åˆ°æ—¶é—´ç»“æŸ &lt; br&gt;2. å¦‚æœæ²¡æœ‰å†™å®Œï¼Œåˆ™æ—¶é—´åˆ°å°±ç»“æŸ</td>
</tr>
<tr>
<td align="center">â€“group_reporting</td>
<td align="center">æ±‡æ€»æ‰€æœ‰çº¿ç¨‹çš„æµ‹è¯•ç»“æœï¼Œè¾“å‡ºæ•´ä½“æ€§èƒ½æŒ‡æ ‡è€Œä¸æ˜¯æ¯ä¸ªçº¿ç¨‹å•ç‹¬æ˜¾ç¤º</td>
</tr>
</tbody></table>
<p>å¯èƒ½çš„ä»£ç å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libaio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_PATH <span class="string">&quot;testfile.bin&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IODEPTH 4  <span class="comment">// æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°é‡</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd = open(FILE_PATH, O_CREAT | O_WRONLY | O_DIRECT, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// io_setup æ˜¯ libaio çš„å‡½æ•°</span></span><br><span class="line">    <span class="type">io_context_t</span> ctx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (io_setup(IODEPTH, &amp;ctx) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;io_setup&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iocb</span> *<span class="title">iocbs</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iocb</span> <span class="title">iocb_array</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    <span class="type">char</span> *buffers[IODEPTH];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; IODEPTH; i++) &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…å¯¹é½å†…å­˜</span></span><br><span class="line">        posix_memalign((<span class="type">void</span>**)&amp;buffers[i], BLOCK_SIZE, BLOCK_SIZE);</span><br><span class="line">        <span class="built_in">memset</span>(buffers[i], <span class="string">&#x27;A&#x27;</span> + i, BLOCK_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– iocb</span></span><br><span class="line">        io_prep_pwrite(&amp;iocb_array[i], fd, buffers[i], BLOCK_SIZE, i * BLOCK_SIZE);</span><br><span class="line">        iocbs[i] = &amp;iocb_array[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æäº¤æ‰€æœ‰è¯·æ±‚</span></span><br><span class="line">    <span class="type">int</span> ret = io_submit(ctx, IODEPTH, iocbs);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;io_submit&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_event</span> <span class="title">events</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    io_getevents(ctx, IODEPTH, IODEPTH, events, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; IODEPTH; i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(buffers[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    io_destroy(ctx);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;All %d I/O requests completed.\n&quot;</span>, IODEPTH);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="å»¶è¿Ÿ"><a href="#å»¶è¿Ÿ" class="headerlink" title="å»¶è¿Ÿ"></a>å»¶è¿Ÿ</h3><table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>å«ä¹‰</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>slat</td>
<td>Submission Latency</td>
<td>ä» fio å‘èµ· I&#x2F;O è¯·æ±‚åˆ°å†…æ ¸æ¥æ”¶è¯¥è¯·æ±‚çš„æ—¶é—´ã€‚é€šå¸¸å¾ˆçŸ­ï¼Œå•ä½æ˜¯å¾®ç§’ï¼ˆusecï¼‰ã€‚</td>
</tr>
<tr>
<td>clat</td>
<td>Completion Latency</td>
<td>ä»å†…æ ¸æ¥æ”¶è¯·æ±‚åˆ° I&#x2F;O æ“ä½œå®Œæˆçš„æ—¶é—´ã€‚è¿™ä¸ªæ˜¯æœ€èƒ½åæ˜ å­˜å‚¨è®¾å¤‡æ€§èƒ½çš„éƒ¨åˆ†ã€‚</td>
</tr>
<tr>
<td>lat</td>
<td>Total Latency</td>
<td>æ€»å»¶è¿Ÿï¼Œå³ slat + clatï¼Œè¡¨ç¤ºä» fio å‘èµ·è¯·æ±‚åˆ° I&#x2F;O å®Œæˆçš„æ•´ä¸ªè¿‡ç¨‹ã€‚</td>
</tr>
</tbody></table>
<h3 id="ç»“æœåˆ†æ"><a href="#ç»“æœåˆ†æ" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ fio --name=seqwrite --rw=write --bs=1M --size=5G --numjobs=2 --direct=1 --runtime=60 --group_reporting</span><br><span class="line">seqwrite: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=psync, iodepth=1</span><br><span class="line">...</span><br><span class="line">fio-3.41</span><br><span class="line">Starting 2 processes</span><br><span class="line">seqwrite: Laying out IO file (1 file / 5120MiB)</span><br><span class="line">seqwrite: Laying out IO file (1 file / 5120MiB)</span><br><span class="line">Jobs: 2 (f=2): [W(2)][100.0%][w=112MiB/s][w=112 IOPS][eta 00m:00s]</span><br><span class="line">seqwrite: (groupid=0, <span class="built_in">jobs</span>=2): err= 0: pid=70688: Sun Sep  7 22:37:47 2025</span><br><span class="line">  write: IOPS=111, BW=111MiB/s (117MB/s)(6685MiB/60016msec); 0 zone resets</span><br><span class="line">    clat (usec): min=9606, max=74763, avg=17922.82, stdev=1446.89</span><br><span class="line">     lat (usec): min=9628, max=74791, avg=17951.49, stdev=1446.80</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[15008],  5.00th=[16319], 10.00th=[16909], 20.00th=[17433],</span><br><span class="line">     | 30.00th=[17695], 40.00th=[17695], 50.00th=[17957], 60.00th=[17957],</span><br><span class="line">     | 70.00th=[18220], 80.00th=[18482], 90.00th=[19006], 95.00th=[19268],</span><br><span class="line">     | 99.00th=[21365], 99.50th=[22414], 99.90th=[32375], 99.95th=[40109],</span><br><span class="line">     | 99.99th=[74974]</span><br><span class="line">   bw (KiB/s): min=96062, max=116736, per=100.00%, avg=114150.20, stdev=1061.35, samples=238</span><br><span class="line">   iops        : min=   92, max=  114, avg=110.77, stdev= 1.18, samples=238</span><br><span class="line">  lat (msec)   : 10=0.03%, 20=97.43%, 50=2.53%, 100=0.01%</span><br><span class="line">  cpu          : usr=0.22%, sys=0.75%, ctx=6717, majf=0, minf=67</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,6685,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">  WRITE: bw=111MiB/s (117MB/s), 111MiB/s-111MiB/s (117MB/s-117MB/s), io=6685MiB (7010MB), run=60016-60016mse</span><br></pre></td></tr></table></figure>

<p>ğŸ§¾ æµ‹è¯•é…ç½®è§£æ<br>bash<br>fio â€“name&#x3D;seqwrite â€“rw&#x3D;write â€“bs&#x3D;1M â€“size&#x3D;10G â€“numjobs&#x3D;1 â€“direct&#x3D;1 â€“runtime&#x3D;60 â€“group_reporting<br>å‚æ•°	å«ä¹‰<br>rw&#x3D;write	é¡ºåºå†™å…¥<br>bs&#x3D;1M	æ¯æ¬¡å†™å…¥å—å¤§å°ä¸º 1MiB<br>numjobs&#x3D;1	å•çº¿ç¨‹å†™å…¥<br>direct&#x3D;1	ä½¿ç”¨ Direct I&#x2F;Oï¼Œç»•è¿‡é¡µç¼“å­˜<br>ioengine&#x3D;psync	ä½¿ç”¨åŒæ­¥ I&#x2F;Oï¼ˆæ¯æ¬¡ pwrite()ï¼‰<br>iodepth&#x3D;1	æ¯æ¬¡åªæŒ‚èµ·ä¸€ä¸ª I&#x2F;O è¯·æ±‚ï¼ˆåŒæ­¥æ¨¡å¼ä¸‹é»˜è®¤å¦‚æ­¤ï¼‰<br>ğŸ“Š æ€§èƒ½ç»“æœæ¦‚è§ˆ<br>æŒ‡æ ‡	æ•°å€¼	è¯´æ˜<br>IOPS	96	æ¯ç§’æ‰§è¡Œ 96 æ¬¡å†™å…¥æ“ä½œ<br>å¸¦å®½	96.2 MiB&#x2F;sï¼ˆ101 MB&#x2F;sï¼‰	æ¯ç§’å†™å…¥çº¦ 96 MiB æ•°æ®<br>æ€»å†™å…¥é‡	5772 MiB	åœ¨ 60 ç§’å†…å®Œæˆçš„å†™å…¥æ€»é‡<br>å»¶è¿Ÿï¼ˆavg clatï¼‰	10.36 ms	æ¯æ¬¡å†™å…¥çš„å¹³å‡å®Œæˆæ—¶é—´<br>CPU ä½¿ç”¨ç‡	usr&#x3D;0.46%, sys&#x3D;1.23%	CPU è´Ÿè½½æä½ï¼Œç“¶é¢ˆä¸åœ¨ CPU<br>â± å»¶è¿Ÿåˆ†å¸ƒåˆ†æ<br>50% çš„å†™å…¥å»¶è¿Ÿä½äº 9.9 ms</p>
<p>95% çš„å†™å…¥ä½äº 12.5 ms</p>
<p>99.95% çš„å†™å…¥å»¶è¿Ÿè¾¾åˆ°äº† 22.9 ms</p>
<p>æœ€æ…¢çš„å†™å…¥é«˜è¾¾ 28.2 ms</p>
<p>å°¾éƒ¨å»¶è¿Ÿç•¥é«˜ï¼Œè¯´æ˜å¶å°”ä¼šæœ‰ç£ç›˜å“åº”å˜æ…¢çš„æƒ…å†µï¼Œå¯èƒ½æ˜¯è®¾å¤‡å†…éƒ¨ç¼“å­˜åˆ·æ–°æˆ–å¯»å€é€ æˆã€‚</p>
<p>ğŸ“ˆ å¸¦å®½æ³¢åŠ¨æƒ…å†µ<br>å¹³å‡å¸¦å®½ï¼šçº¦ 96 MiB&#x2F;s</p>
<p>æœ€å°å¸¦å®½ï¼š60 MiB&#x2F;s</p>
<p>æœ€å¤§å¸¦å®½ï¼š104 MiB&#x2F;s</p>
<p>æ ‡å‡†å·®ï¼š6.2 MiB&#x2F;s â†’ è¡¨æ˜å¸¦å®½ç›¸å¯¹ç¨³å®šï¼Œä½†ä»æœ‰è½»å¾®æ³¢åŠ¨</p>
<p>ğŸ§  æ·±å±‚è§£è¯»<br>âœ… ä¸ºä»€ä¹ˆ IOPS â‰ˆ å¸¦å®½ï¼ˆMiB&#x2F;sï¼‰ï¼Ÿ<br>å› ä¸ºä½ è®¾ç½®äº† bs&#x3D;1Mï¼Œæ¯æ¬¡å†™å…¥ 1MiB æ•°æ®ï¼Œæ‰€ä»¥ï¼š</p>
<p>Code<br>IOPS Ã— Block Size &#x3D; Bandwidth<br>96 IOPS Ã— 1 MiB &#x3D; 96 MiB&#x2F;s<br>âœ… ä¸ºä»€ä¹ˆ Direct I&#x2F;Oï¼Ÿ<br>ç»•è¿‡é¡µç¼“å­˜ï¼Œæµ‹è¯•çš„æ˜¯ç£ç›˜çš„çœŸå®ç‰©ç†æ€§èƒ½ï¼Œé¿å…è¢«å†…å­˜åŠ é€Ÿ â€œæ¬ºéª—â€ã€‚</p>
<p>âœ… ä¸ºä»€ä¹ˆä½¿ç”¨ psyncï¼Ÿ<br>psync æ˜¯åŒæ­¥å†™å…¥ï¼Œæ¯æ¬¡è°ƒç”¨ pwrite()ï¼Œé€‚åˆæ¨¡æ‹Ÿæ•°æ®åº“æˆ–æ—¥å¿—ç³»ç»Ÿçš„å†™å…¥è¡Œä¸ºã€‚ä½†å®ƒæ— æ³•å¹¶å‘æŒ‚èµ·å¤šä¸ªè¯·æ±‚ï¼Œé™åˆ¶äº†ååã€‚</p>
<p>ğŸ“Œ æ€§èƒ½ç“¶é¢ˆåˆ†æ<br>ç£ç›˜ç±»å‹ï¼šå¦‚æœæ˜¯ HDDï¼Œè¿™ä¸ªç»“æœï¼ˆ96 MiB&#x2F;sï¼‰éå¸¸åˆç†ï¼›å¦‚æœæ˜¯ SSDï¼Œåˆ™åä½ï¼Œå¯èƒ½å—é™äºåŒæ­¥ I&#x2F;O æˆ–å•çº¿ç¨‹ã€‚</p>
<p>IO å¼•æ“é™åˆ¶ï¼špsync æ˜¯é˜»å¡å¼ï¼Œæ— æ³•å‘æŒ¥ç£ç›˜çš„å¹¶å‘èƒ½åŠ›ã€‚</p>
<p>çº¿ç¨‹æ•°é™åˆ¶ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œç£ç›˜å¯èƒ½æœªè¢«å……åˆ†åˆ©ç”¨ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/03/cuda/CUDA%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/03/cuda/CUDA%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95/" class="post-title-link" itemprop="url">CUDAçŸ©é˜µä¹˜æ³•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-03 09:23:17" itemprop="dateCreated datePublished" datetime="2025-09-03T09:23:17+00:00">2025-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/CUDA/" itemprop="url" rel="index"><span itemprop="name">CUDA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–"><a href="#ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–" class="headerlink" title="ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–"></a>ä½¿ç”¨å…±äº«å†…å­˜ä¼˜åŒ–</h2><p><a href='https://postimg.cc/BjfXcPQ9' target='_blank'><img src='https://i.postimg.cc/dVLrFGb1/matrix-Mul.png' border='0' alt='matrix-Mul'/></a></p>
<figure class="highlight cpp"><figcaption><span>matrixMul.cpp</span><a href="/blog/downloads/code/cuda/matrixMul.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Matrix multiplication (CUDA Kernel) on the device: C = A * B</span></span><br><span class="line"><span class="comment"> * wA is A&#x27;s width and wB is B&#x27;s width</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">int</span> BLOCK_SIZE&gt; <span class="function">__global__ <span class="type">void</span> <span class="title">MatrixMulCUDA</span><span class="params">(<span class="type">float</span> *C, <span class="type">float</span> *A, <span class="type">float</span> *B, <span class="type">int</span> wA, <span class="type">int</span> wB)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Block index</span></span><br><span class="line">    <span class="type">int</span> bx = blockIdx.x;</span><br><span class="line">    <span class="type">int</span> by = blockIdx.y;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Thread index</span></span><br><span class="line">    <span class="type">int</span> tx = threadIdx.x;</span><br><span class="line">    <span class="type">int</span> ty = threadIdx.y;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index of the first sub-matrix of A processed by the block</span></span><br><span class="line">    <span class="type">int</span> aBegin = wA * BLOCK_SIZE * by;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index of the last sub-matrix of A processed by the block</span></span><br><span class="line">    <span class="type">int</span> aEnd = aBegin + wA - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step size used to iterate through the sub-matrices of A</span></span><br><span class="line">    <span class="type">int</span> aStep = BLOCK_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Index of the first sub-matrix of B processed by the block</span></span><br><span class="line">    <span class="type">int</span> bBegin = BLOCK_SIZE * bx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step size used to iterate through the sub-matrices of B</span></span><br><span class="line">    <span class="type">int</span> bStep = BLOCK_SIZE * wB;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Csub is used to store the element of the block sub-matrix</span></span><br><span class="line">    <span class="comment">// that is computed by the thread</span></span><br><span class="line">    <span class="type">float</span> Csub = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop over all the sub-matrices of A and B</span></span><br><span class="line">    <span class="comment">// required to compute the block sub-matrix</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> a = aBegin, b = bBegin; a &lt;= aEnd; a += aStep, b += bStep) {</span><br><span class="line">        <span class="comment">// Declaration of the shared memory array As used to</span></span><br><span class="line">        <span class="comment">// store the sub-matrix of A</span></span><br><span class="line">        __shared__ <span class="type">float</span> As[BLOCK_SIZE][BLOCK_SIZE];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Declaration of the shared memory array Bs used to</span></span><br><span class="line">        <span class="comment">// store the sub-matrix of B</span></span><br><span class="line">        __shared__ <span class="type">float</span> Bs[BLOCK_SIZE][BLOCK_SIZE];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the matrices from device memory</span></span><br><span class="line">        <span class="comment">// to shared memory; each thread loads</span></span><br><span class="line">        <span class="comment">// one element of each matrix</span></span><br><span class="line">        As[ty][tx] = A[a + wA * ty + tx];</span><br><span class="line">        Bs[ty][tx] = B[b + wB * ty + tx];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Synchronize to make sure the matrices are loaded</span></span><br><span class="line">        __syncthreads();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Multiply the two matrices together;</span></span><br><span class="line">        <span class="comment">// each thread computes one element</span></span><br><span class="line">        <span class="comment">// of the block sub-matrix</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> unroll</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; BLOCK_SIZE; ++k) {</span><br><span class="line">            Csub += As[ty][k] * Bs[k][tx];</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Synchronize to make sure that the preceding</span></span><br><span class="line">        <span class="comment">// computation is done before loading two new</span></span><br><span class="line">        <span class="comment">// sub-matrices of A and B in the next iteration</span></span><br><span class="line">        __syncthreads();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write the block sub-matrix to device memory;</span></span><br><span class="line">    <span class="comment">// each thread writes one element</span></span><br><span class="line">    <span class="type">int</span> c               = wB * BLOCK_SIZE * by + BLOCK_SIZE * bx;</span><br><span class="line">    C[c + wB * ty + tx] = Csub;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/02/concurrency/%E4%BA%BA%E4%BA%BA%E9%83%BD%E7%9C%8B%E5%BE%97%E6%87%82%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/09/02/concurrency/%E4%BA%BA%E4%BA%BA%E9%83%BD%E7%9C%8B%E5%BE%97%E6%87%82%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">äººäººéƒ½çœ‹å¾—æ‡‚çš„å†…å­˜æ¨¡å‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-02 11:10:13" itemprop="dateCreated datePublished" datetime="2025-09-02T11:10:13+00:00">2025-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><p>å†…å­˜æ¨¡å‹ï¼ˆMemory Modelï¼‰æ˜¯å®šä¹‰<strong>æ•°æ®ä¸€è‡´æ€§</strong>ä¸<strong>æ‰§è¡Œé¡ºåº</strong>è§„åˆ™çš„ä¸€ç»„è§„èŒƒã€‚</p>
<p>å…³é”®æ¦‚å¿µï¼š</p>
<ol>
<li>åŸå­æ€§ï¼šæ“ä½œä¸å¯æ‰“æ–­ï¼›å¦‚æœåŒæ—¶ä¿®æ”¹ï¼Œç¡¬ä»¶ä¼šä¸²è¡Œæ’é˜Ÿã€‚</li>
<li>å¯è§æ€§ï¼šå¯¹å…¶ä»–æ ¸å¿ƒï¼ˆå³<strong>å…¶ä»–çº¿ç¨‹</strong>ï¼‰å¯è§ï¼Œä¹Ÿå°±æ˜¯ load æŒ‡ä»¤å¯ä»¥è¯»åˆ°æœ€æ–°å€¼ã€‚</li>
<li>é¡ºåºæ€§ï¼šç¦æ­¢<strong>æœ¬çº¿ç¨‹</strong>å†…çš„æŒ‡ä»¤é‡æ’åºã€‚æ‰€ä»¥å¯ä»¥ç”¨ä½œåŒæ­¥ç‚¹ã€‚</li>
</ol>
<p>æ‰€æœ‰åŸå­å˜é‡éƒ½æ»¡è¶³åŸå­æ€§ã€‚ä½†æ˜¯å…¶ä»–ä¸¤è€…ä¸ä¸€å®šæ»¡è¶³ï¼Œç”±å†…å­˜åºå®šä¹‰ã€‚</p>
<p>æ¯”å¦‚åŸå­è‡ªå¢ fetch_add(relaxed) æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯æ— æ³•ä½¿ç”¨ load æŒ‡ä»¤è¯»åˆ°æœ€æ–°çš„ç»“æœã€‚</p>
<h2 id="ç¼“å­˜ä¸€è‡´æ€§åè®®-MESI"><a href="#ç¼“å­˜ä¸€è‡´æ€§åè®®-MESI" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§åè®® (MESI)"></a>ç¼“å­˜ä¸€è‡´æ€§åè®® (MESI)</h2><table>
<thead>
<tr>
<th align="center">çŠ¶æ€</th>
<th align="center">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="center">M (Modified)</td>
<td align="center">ç¼“å­˜è¡Œå·²è¢«ä¿®æ”¹ï¼Œåªæœ‰å½“å‰ CPU æ‹¥æœ‰ï¼Œä¸»å†…å­˜æœªæ›´æ–°</td>
</tr>
<tr>
<td align="center">E (Exclusive)</td>
<td align="center">ç¼“å­˜è¡Œæœªè¢«ä¿®æ”¹ï¼Œåªæœ‰å½“å‰ CPU æ‹¥æœ‰ï¼Œä¸ä¸»å†…å­˜ä¸€è‡´</td>
</tr>
<tr>
<td align="center">S (Shared)</td>
<td align="center">ç¼“å­˜è¡Œæœªè¢«ä¿®æ”¹ï¼Œå¤šä¸ª CPU æ‹¥æœ‰ï¼Œä¸ä¸»å†…å­˜ä¸€è‡´</td>
</tr>
<tr>
<td align="center">I (Invalid)</td>
<td align="center">ç¼“å­˜è¡Œæ— æ•ˆï¼Œå¿…é¡»é‡æ–°ä»ä¸»å†…å­˜åŠ è½½</td>
</tr>
</tbody></table>
<h2 id="relaxed-å†…å­˜åº"><a href="#relaxed-å†…å­˜åº" class="headerlink" title="relaxed å†…å­˜åº"></a>relaxed å†…å­˜åº</h2><p>æœ¯è¯­ï¼š</p>
<ol>
<li>ä¿è¯åŸå­æ€§ï¼šæ•´ä¸ªæ“ä½œä¸å¯è¢«æ‰“æ–­ï¼›ä¸ä¸€å®šç«‹å³å›å†™ä¸»å†…å­˜ï¼Œå¯èƒ½æš‚æ—¶æŠŠç»“æœæ”¾åœ¨ Store Buffer ä¸­ã€‚</li>
<li>ä¸ä¿è¯é¡ºåºï¼šç¼–è¯‘å™¨å’ŒCPUå¯èƒ½å¯¹æŒ‡ä»¤é‡æ’åºã€‚</li>
<li>ä¸ä¿è¯å¯è§æ€§ï¼šå…¶ä»–æ ¸å¿ƒä¸ä¸€å®šç«‹å³å¯è§ã€‚</li>
</ol>
<p>è¯´äººè¯ï¼š</p>
<ol>
<li>åŸå­æ€§ï¼šåŸå­æ“ä½œæ˜¯ä¸²è¡Œçš„ï¼ˆç”±ç¡¬ä»¶æ’é˜Ÿï¼‰</li>
<li>ä¸ä¿è¯å¯è§æ€§ï¼š<ul>
<li>load æ“ä½œæ˜¯å¹¶è¡Œçš„ï¼Œå¹¶ä¸”ä¸ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ã€‚</li>
<li>â€œå¯è§æ€§â€æ˜¯é’ˆå¯¹ç¨‹åºå‘˜çš„ï¼Œå› ä¸ºå¯¹äº relaxed ï¼Œæ²¡æœ‰ä»»ä½•æŒ‡ä»¤å¯ä»¥ä¿è¯ load æ‹¿åˆ°æœ€æ–°å€¼ã€‚å®ƒå¯èƒ½ç›´æ¥ä»è‡ªå·±çš„ç¼“å­˜è¡Œä¸­æŠŠæ—§å€¼è¿”å›ç»™ä½ ã€‚</li>
<li>ç¡¬ä»¶æœ¬èº«æ˜¯çŸ¥é“æœ€æ–°å€¼çš„ï¼Œå®ƒä¼šæ ¹æ® MESI æ¥ä¿è¯è‡ªå·±å½“æ—¶æ‹¿åˆ°çš„æ˜¯æœ€æ–°å€¼ï¼ˆä½†æ˜¯æ— æ³•é€šè¿‡æŒ‡ä»¤å‘ŠçŸ¥ä½ ï¼‰ã€‚</li>
</ul>
</li>
<li>ä¸ä¿è¯é¡ºåºï¼šä¸æ˜¯åŒæ­¥ç‚¹ï¼Œæ— æ³•ä¿è¯å‰åæŒ‡ä»¤ä¸ç¨‹åºå‘˜çš„ç¼–å†™é¡ºåºä¸€è‡´ã€‚</li>
</ol>
<table>
<thead>
<tr>
<th align="center">å±‚çº§</th>
<th align="center">æœºåˆ¶</th>
<th align="center">ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">æŒ‡ä»¤çº§</td>
<td align="center">åŸå­æŒ‡ä»¤ï¼ˆå¦‚ LOCK XADDï¼‰</td>
<td align="center">ä¿è¯æ“ä½œä¸å¯æ‰“æ–­</td>
</tr>
<tr>
<td align="center">ç¼“å­˜çº§</td>
<td align="center">MESI åè®®</td>
<td align="center">æ§åˆ¶ç¼“å­˜è¡Œè®¿é—®ï¼Œé¿å…å†²çª</td>
</tr>
<tr>
<td align="center">ç¼–è¯‘å™¨çº§</td>
<td align="center">ç¼–è¯‘å™¨å±éšœ</td>
<td align="center">é˜²æ­¢æŒ‡ä»¤é‡æ’</td>
</tr>
<tr>
<td align="center">CPUçº§</td>
<td align="center">å†…å­˜å±éšœ</td>
<td align="center">ä¿è¯æ‰§è¡Œé¡ºåº</td>
</tr>
<tr>
<td align="center">é«˜çº§æœºåˆ¶</td>
<td align="center">äº‹åŠ¡æ€§å†…å­˜</td>
<td align="center">å®ç°å¤æ‚åŸå­é€»è¾‘ï¼ˆå¯é€‰ï¼‰</td>
</tr>
</tbody></table>
<h2 id="release-acquire-è¯­ä¹‰"><a href="#release-acquire-è¯­ä¹‰" class="headerlink" title="release-acquire è¯­ä¹‰"></a>release-acquire è¯­ä¹‰</h2><h2 id="æŒ‡ä»¤é‡æ’åº"><a href="#æŒ‡ä»¤é‡æ’åº" class="headerlink" title="æŒ‡ä»¤é‡æ’åº"></a>æŒ‡ä»¤é‡æ’åº</h2><ol>
<li>ç¼–è¯‘å™¨æŒ‡ä»¤é‡æ’ï¼šç¼–è¯‘å™¨å±éšœé˜²æ­¢æŒ‡ä»¤é‡æ’</li>
<li>CPU ä¹±åºæ‰§è¡Œï¼šå†…å­˜å±éšœä¿è¯æ‰§è¡Œé¡ºåºã€‚</li>
</ol>
<h2 id="åŸå­æŒ‡ä»¤"><a href="#åŸå­æŒ‡ä»¤" class="headerlink" title="åŸå­æŒ‡ä»¤"></a>åŸå­æŒ‡ä»¤</h2><p>åŸå­æŒ‡ä»¤ï¼ˆå¦‚ LOCK XADDï¼‰ï¼šä¿è¯æ“ä½œä¸å¯æ‰“æ–­</p>
<h2 id="Load-Store-Buffer"><a href="#Load-Store-Buffer" class="headerlink" title="Load &#x2F; Store Buffer"></a>Load &#x2F; Store Buffer</h2><h2 id="ç¼“å­˜è¡Œ"><a href="#ç¼“å­˜è¡Œ" class="headerlink" title="ç¼“å­˜è¡Œ"></a>ç¼“å­˜è¡Œ</h2><h2 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/26/cpp/%E4%BD%8D%E7%BD%AE%E6%97%A0%E5%85%B3%E4%BB%A3%E7%A0%81PIC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/26/cpp/%E4%BD%8D%E7%BD%AE%E6%97%A0%E5%85%B3%E4%BB%A3%E7%A0%81PIC/" class="post-title-link" itemprop="url">ä½ç½®æ— å…³ä»£ç </a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-26 13:54:18" itemprop="dateCreated datePublished" datetime="2025-08-26T13:54:18+00:00">2025-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰"><a href="#ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰" class="headerlink" title="ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰"></a>ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰</h2><ul>
<li>ä½ç½®æ— å…³ä»£ç ï¼ˆ<code>PIC</code>ï¼‰ï¼šç¨‹åºå¯ä»¥åœ¨å†…å­˜ä¸­çš„ä»»æ„ä½ç½®è¿è¡Œï¼Œä¸éœ€è¦ä¿®æ”¹ä»£ç ä¸­çš„ç»å¯¹åœ°å€ã€‚</li>
<li>èŠ‚çœç©ºé—´ï¼šç›¸æ¯”ä½¿ç”¨ 64 ä½ç»å¯¹åœ°å€ï¼ŒRIP ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª 32 ä½åç§»é‡ã€‚</li>
<li>æ›´å®‰å…¨ï¼šæ”¯æŒåœ°å€éšæœºåŒ–ï¼ˆASLRï¼‰ï¼Œæé«˜ç¨‹åºçš„å®‰å…¨æ€§ã€‚</li>
</ul>
<p>åœ¨ x86-64 æ¶æ„ä¸­ï¼Œä¼ ç»Ÿçš„ç»å¯¹åœ°å€å¯»å€æ–¹å¼ä¸å†é€‚ç”¨äºä½ç½®æ— å…³ä»£ç ã€‚äºæ˜¯å¼•å…¥äº† RIPï¼ˆæŒ‡ä»¤æŒ‡é’ˆï¼‰ç›¸å¯¹å¯»å€ï¼š</p>
<p>å‡è®¾ä½ æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ int x &#x3D; 42;ï¼Œåœ¨æ±‡ç¼–ä¸­è®¿é—®å®ƒå¯èƒ½ä¼šå˜æˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">asm</span><br><span class="line">mov eax, DWORD PTR [rip + offset_to_x]</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ offset_to_x æ˜¯ç¼–è¯‘å™¨è®¡ç®—å‡ºæ¥çš„ x ç›¸å¯¹äºå½“å‰æŒ‡ä»¤çš„åç§»é‡ã€‚</p>
<table>
<thead>
<tr>
<th align="center">å¯»å€æ–¹å¼</th>
<th align="center">æè¿°</th>
<th align="center">æ˜¯å¦ä½ç½®æ— å…³</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ç»å¯¹åœ°å€å¯»å€</td>
<td align="center">ä½¿ç”¨å›ºå®šåœ°å€ï¼Œå¦‚ [0x400123]</td>
<td align="center">âŒ å¦</td>
</tr>
<tr>
<td align="center">å¯„å­˜å™¨é—´æ¥å¯»å€</td>
<td align="center">å¦‚ [rax]ï¼Œåœ°å€ç”±å¯„å­˜å™¨å†³å®š</td>
<td align="center">âœ… æ˜¯</td>
</tr>
<tr>
<td align="center">RIP ç›¸å¯¹å¯»å€</td>
<td align="center">å¦‚ [rip + offset]ï¼Œç›¸å¯¹å½“å‰æŒ‡ä»¤ä½ç½®</td>
<td align="center">âœ… æ˜¯</td>
</tr>
</tbody></table>
<p>ä½†å¹¶ä¸æ˜¯æ‰€æœ‰ PIC éƒ½ç”¨ RIP ç›¸å¯¹å¯»å€ï¼ŒPIC çš„å®ç°æ–¹å¼å–å†³äºï¼š</p>
<ul>
<li>æ¶æ„ï¼šåœ¨ x86ï¼ˆ32 ä½ï¼‰ä¸­æ²¡æœ‰ RIP å¯„å­˜å™¨ï¼ŒPIC é€šå¸¸é€šè¿‡ call æŒ‡ä»¤è·å–å½“å‰åœ°å€ï¼Œå†åŠ åç§»é‡ã€‚</li>
<li>ç¼–è¯‘å™¨ç­–ç•¥ï¼šæœ‰äº›ç¼–è¯‘å™¨ä¼šä½¿ç”¨å…¨å±€åç§»è¡¨ï¼ˆGOTï¼‰æˆ–è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆPLTï¼‰æ¥å®ç°ä½ç½®æ— å…³æ€§ã€‚</li>
<li>è®¿é—®ç›®æ ‡ï¼šè®¿é—®å‡½æ•°åœ°å€æ—¶å¯èƒ½é€šè¿‡ PLTï¼›è®¿é—®å¤–éƒ¨å˜é‡æ—¶å¯èƒ½é€šè¿‡ GOTï¼›è®¿é—®é™æ€æ•°æ®æ—¶å¯èƒ½ç”¨ RIP ç›¸å¯¹å¯»å€ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th align="center">æ¶æ„</th>
<th align="center">æ˜¯å¦ä½¿ç”¨ RIP ç›¸å¯¹å¯»å€</th>
<th align="center">æ˜¯å¦æ”¯æŒä½ç½®æ— å…³ä»£ç </th>
</tr>
</thead>
<tbody><tr>
<td align="center">x86-64</td>
<td align="center">âœ… å¸¸ç”¨ï¼Œå°¤å…¶è®¿é—®æ•°æ®æ®µ</td>
<td align="center">âœ… å¼ºåŠ›æ”¯æŒï¼ˆé»˜è®¤å¯ç”¨ï¼‰</td>
</tr>
<tr>
<td align="center">x86 (32ä½)</td>
<td align="center">âŒ æ—  RIPï¼Œç”¨å…¶ä»–æ–¹å¼å®ç°</td>
<td align="center">âœ… ä½†éœ€è¦ç‰¹æ®ŠæŠ€å·§</td>
</tr>
</tbody></table>
<p>ä¸¾ä¸ª gdb è°ƒè¯•çš„ä¾‹å­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/i <span class="variable">$rip</span></span><br><span class="line">=&gt; 0x2ac084b5ec10 &lt;poll&gt;:       cmpl   <span class="variable">$0x0</span>,0x2d939d(%rip)        <span class="comment"># 0x2ac084e37fb4 &lt;__libc_multiple_threads&gt;</span></span><br><span class="line">(gdb) p (bool)<span class="variable">$__libc_multiple_threads</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>cmpl $0x0, 0x2d939d(%rip)</code> æ˜¯ä¸€æ¡æ¯”è¾ƒæŒ‡ä»¤ï¼ˆ<code>cmp</code>ï¼‰ï¼Œç”¨äºå°†æŸä¸ªå†…å­˜åœ°å€ä¸­çš„å€¼ä¸ç«‹å³æ•° <code>0</code> è¿›è¡Œæ¯”è¾ƒã€‚</li>
<li><code>(%rip)</code> è¡¨ç¤ºä½¿ç”¨ RIP ç›¸å¯¹å¯»å€ï¼Œè¿™æ˜¯ x86-64 æ¶æ„ä¸­å¸¸è§çš„ä¸€ç§å¯»å€æ–¹å¼ã€‚</li>
<li>å®é™…æ¯”è¾ƒçš„æ˜¯åœ°å€ <code>0x2ac084e37fb4</code> å¤„çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ <code>__libc_multiple_threads</code> è¿™ä¸ªå˜é‡ã€‚</li>
</ul>
<p><code>__libc_multiple_threads</code> æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>è¿™æ˜¯ GNU C åº“ï¼ˆglibcï¼‰ä¸­çš„ä¸€ä¸ªå†…éƒ¨å˜é‡ï¼Œç”¨æ¥æ ‡è®°å½“å‰è¿›ç¨‹æ˜¯å¦å¯ç”¨äº†å¤šçº¿ç¨‹ã€‚</li>
<li>å¦‚æœè¿™ä¸ªå€¼æ˜¯ 0ï¼Œè¯´æ˜å½“å‰è¿›ç¨‹æ˜¯å•çº¿ç¨‹ã€‚</li>
<li>å¦‚æœæ˜¯éé›¶ï¼Œè¯´æ˜è¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹ã€‚</li>
</ul>
<p>æ‰€ä»¥è¿™æ¡æŒ‡ä»¤çš„ä½œç”¨æ˜¯ï¼šåˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦æ˜¯å¤šçº¿ç¨‹ç¯å¢ƒï¼Œå¯èƒ½ç”¨äºå†³å®šæ˜¯å¦å¯ç”¨çº¿ç¨‹å®‰å…¨çš„è¡Œä¸ºã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨-RIP-ç›¸å¯¹å¯»å€ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨-RIP-ç›¸å¯¹å¯»å€ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨ RIP ç›¸å¯¹å¯»å€ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ RIP ç›¸å¯¹å¯»å€ï¼Ÿ</h3><ol>
<li>RIP æ˜¯å”¯ä¸€å§‹ç»ˆå·²çŸ¥çš„å¯„å­˜å™¨</li>
</ol>
<ul>
<li>åœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶ï¼ŒCPUæ€»æ˜¯çŸ¥é“å½“å‰æŒ‡ä»¤çš„åœ°å€ï¼ˆå³ RIPï¼‰ã€‚</li>
<li>æ‰€ä»¥å¯ä»¥åœ¨ç¼–è¯‘æ—¶è®¡ç®—å‡ºç›®æ ‡æ•°æ®ä¸å½“å‰æŒ‡ä»¤ä¹‹é—´çš„åç§»é‡ï¼Œè€Œä¸éœ€è¦çŸ¥é“æ•°æ®çš„ç»å¯¹åœ°å€ã€‚</li>
</ul>
<p>è¿™å°±å…è®¸ç¼–è¯‘å™¨ç”Ÿæˆä½ç½®æ— å…³ä»£ç ï¼Œå³ä½¿ç¨‹åºè¢«åŠ è½½åˆ°ä¸åŒçš„å†…å­˜åœ°å€ï¼Œåç§»é‡ä»ç„¶æœ‰æ•ˆã€‚</p>
<ol start="2">
<li>å…¶ä»–å¯„å­˜å™¨å€¼æ˜¯åŠ¨æ€çš„ï¼Œä¸å¯é¢„æµ‹</li>
</ol>
<ul>
<li>æ¯”å¦‚ RBXã€RAXã€RDI ç­‰å¯„å­˜å™¨ï¼Œå®ƒä»¬çš„å€¼åœ¨è¿è¡Œæ—¶å¯èƒ½è¢«ç¨‹åºä¿®æ”¹ã€‚</li>
<li>å¦‚æœç”¨è¿™äº›å¯„å­˜å™¨åšåŸºå€å¯»å€ï¼Œç¼–è¯‘å™¨å°±æ— æ³•æå‰çŸ¥é“å®ƒä»¬çš„å€¼ï¼Œä¹Ÿå°±æ— æ³•ç”Ÿæˆç¨³å®šçš„åç§»é‡ã€‚</li>
</ul>
<ol start="3">
<li>æ”¯æŒå…±äº«åº“å’Œåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰</li>
</ol>
<ul>
<li>RIP ç›¸å¯¹å¯»å€è®©ä»£ç æ®µä¸ä¾èµ–å›ºå®šåœ°å€ï¼Œå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚</li>
<li>ä¹Ÿæ”¯æŒæ“ä½œç³»ç»Ÿåœ¨è¿è¡Œæ—¶éšæœºåŠ è½½åœ°å€ï¼Œæé«˜å®‰å…¨æ€§ï¼ˆASLRï¼‰ã€‚</li>
</ul>
<ol start="4">
<li>èŠ‚çœæŒ‡ä»¤ç©ºé—´</li>
</ol>
<ul>
<li>ä½¿ç”¨ RIP ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª 32 ä½åç§»é‡ã€‚</li>
<li>å¦‚æœä½¿ç”¨ç»å¯¹åœ°å€ï¼Œéœ€è¦åµŒå…¥å®Œæ•´çš„ 64 ä½åœ°å€ï¼ŒæŒ‡ä»¤é•¿åº¦æ›´é•¿ï¼Œæ•ˆç‡æ›´ä½ã€‚</li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨-RIP-ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª-32-ä½åç§»é‡"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨-RIP-ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª-32-ä½åç§»é‡" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨ RIP ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª 32 ä½åç§»é‡"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ RIP ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª 32 ä½åç§»é‡</h3><p>åœ¨ x86-64 æ¶æ„ä¸­ï¼ŒRIP ç›¸å¯¹å¯»å€çš„åç§»é‡è¢«è®¾è®¡ä¸ºä¸€ä¸ªæœ‰ç¬¦å·çš„ 32 ä½æ•´æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª displacementï¼ˆä½ç§»ï¼‰å­—æ®µï¼Œå®ƒåœ¨æœºå™¨ç ä¸­åªå ç”¨ 4 ä¸ªå­—èŠ‚ã€‚</p>
<ul>
<li><p>RIP æ˜¯ 64 ä½çš„æŒ‡ä»¤æŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰æŒ‡ä»¤çš„åœ°å€ã€‚</p>
</li>
<li><p>RIP ç›¸å¯¹å¯»å€çš„ç›®æ ‡åœ°å€æ˜¯é€šè¿‡ï¼š</p>
<p><code>ç›®æ ‡åœ°å€ = ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼ˆRIPï¼‰ + 32 ä½åç§»é‡</code></p>
</li>
<li><p>è¿™ä¸ªåç§»é‡æ˜¯ä¸€ä¸ª æœ‰ç¬¦å·æ•´æ•°ï¼Œæ‰€ä»¥å®ƒçš„èŒƒå›´æ˜¯ï¼š</p>
<p>ä» âˆ’2Â³Â¹ åˆ° +2Â³Â¹âˆ’1ï¼Œå³ <strong>Â±2GB</strong> çš„å¯»å€èŒƒå›´ã€‚</p>
</li>
</ul>
<p>è¿™æ„å‘³ç€ï¼Œå½“å‰æŒ‡ä»¤é™„è¿‘ Â±2GB èŒƒå›´å†…çš„ä»»ä½•æ•°æ®éƒ½å¯ä»¥é€šè¿‡ RIP ç›¸å¯¹å¯»å€è®¿é—®ã€‚</p>
<table>
<thead>
<tr>
<th align="center">ä¼˜ç‚¹</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">âœ… èŠ‚çœç©ºé—´</td>
<td align="center">åªç”¨ 4 å­—èŠ‚è¡¨ç¤ºåç§»ï¼Œæ¯”ä½¿ç”¨å®Œæ•´ 64 ä½åœ°å€èŠ‚çœæŒ‡ä»¤é•¿åº¦</td>
</tr>
<tr>
<td align="center">âœ… æ”¯æŒä½ç½®æ— å…³ä»£ç </td>
<td align="center">ç¼–è¯‘å™¨åªéœ€è®¡ç®—åç§»ï¼Œä¸ä¾èµ–ç»å¯¹åœ°å€</td>
</tr>
<tr>
<td align="center">âœ… é«˜æ•ˆ</td>
<td align="center">CPU æ‰§è¡Œæ—¶åªéœ€åŠ æ³•è¿ç®—ï¼Œæ— éœ€æŸ¥è¡¨æˆ–é‡å®šä½</td>
</tr>
<tr>
<td align="center">âœ… å®‰å…¨</td>
<td align="center">æ”¯æŒåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰ï¼Œæé«˜å®‰å…¨æ€§</td>
</tr>
</tbody></table>
<h3 id="ä¸ºä»€ä¹ˆå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Ÿ</h3><p>å› ä¸ºä»£ç ä¸­ä¸å†ç¡¬ç¼–ç å…·ä½“åœ°å€ï¼Œå¤šä¸ªè¿›ç¨‹å¯ä»¥ï¼š</p>
<ul>
<li>ä½¿ç”¨åŒä¸€ä»½ç‰©ç†å†…å­˜ä¸­çš„ä»£ç æ®µã€‚</li>
<li>æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„æ•°æ®æ®µï¼Œä½†å…±äº«åŒä¸€ä»½åªè¯»ä»£ç ã€‚</li>
</ul>
<p>è¿™å¤§å¤§èŠ‚çœäº†å†…å­˜ï¼Œæé«˜äº†ç³»ç»Ÿæ•ˆç‡ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<table>
<thead>
<tr>
<th align="center">è¿›ç¨‹</th>
<th align="center">åŠ è½½åœ°å€</th>
<th align="center">ä½¿ç”¨çš„ä»£ç æ®µ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">A</td>
<td align="center">0x400000</td>
<td align="center">ä½¿ç”¨å…±äº«ä»£ç æ®µ</td>
</tr>
<tr>
<td align="center">B</td>
<td align="center">0x500000</td>
<td align="center">ä½¿ç”¨å…±äº«ä»£ç æ®µ</td>
</tr>
</tbody></table>
<p>ä¸¤è€…çš„ä»£ç æ®µå†…å®¹å®Œå…¨ä¸€æ ·ï¼Œå› ä¸ºé‡Œé¢çš„å¯»å€æ˜¯ç›¸å¯¹ RIP çš„ï¼Œä¸ä¾èµ–äºåŠ è½½åœ°å€ã€‚</p>
<p>ä¸ºä»€ä¹ˆç»å¯¹å¯»å€ä¸å¯ä»¥è¢«å¤šè¿›ç¨‹å…±äº«ï¼Ÿ</p>
<ul>
<li>æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯ç‹¬ç«‹çš„<ul>
<li>æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</li>
<li>å³ä½¿ä¸¤ä¸ªè¿›ç¨‹éƒ½åŠ è½½äº†åŒä¸€ä¸ªç¨‹åºï¼Œå®ƒä»¬çš„åœ°å€ç©ºé—´å¯èƒ½å®Œå…¨ä¸åŒã€‚</li>
<li>å¦‚æœä»£ç ä¸­ä½¿ç”¨ç»å¯¹åœ°å€ï¼ŒåŠ è½½åˆ°ä¸åŒåœ°å€ç©ºé—´åï¼Œè¿™äº›åœ°å€å°±ä¸å†æœ‰æ•ˆã€‚</li>
</ul>
</li>
</ul>
<p>æ‰€ä»¥ï¼Œç»å¯¹åœ°å€åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ˜¯æœ‰æ•ˆçš„ï¼Œåœ¨å¦ä¸€ä¸ªè¿›ç¨‹ä¸­å¯èƒ½å°±æŒ‡å‘é”™è¯¯çš„åœ°æ–¹æˆ–æ ¹æœ¬ä¸å­˜åœ¨ã€‚</p>
<ul>
<li><p>éœ€è¦é‡å®šä½ï¼Œæ— æ³•ç›´æ¥å…±äº«ç‰©ç†é¡µ</p>
<ul>
<li>å¦‚æœä½¿ç”¨ç»å¯¹åœ°å€ï¼Œæ“ä½œç³»ç»Ÿå¿…é¡»åœ¨æ¯ä¸ªè¿›ç¨‹åŠ è½½æ—¶å¯¹ä»£ç è¿›è¡Œâ€œé‡å®šä½â€ï¼Œä¿®æ”¹æŒ‡ä»¤ä¸­çš„åœ°å€ã€‚</li>
<li>ä¸€æ—¦ä¿®æ”¹ï¼Œä»£ç æ®µå°±å˜æˆäº†è¿›ç¨‹ç§æœ‰ï¼Œä¸èƒ½å…±äº«åŒä¸€ä»½ç‰©ç†å†…å­˜ã€‚</li>
<li>è€Œä½ç½®æ— å…³ä»£ç ï¼ˆå¦‚ä½¿ç”¨ RIP ç›¸å¯¹å¯»å€ï¼‰ä¸éœ€è¦ä¿®æ”¹ï¼Œå¯ä»¥ç›´æ¥æ˜ å°„åˆ°å¤šä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</li>
</ul>
</li>
<li><p>è¿åå…±äº«åº“çš„è®¾è®¡åŸåˆ™</p>
<ul>
<li>åŠ¨æ€é“¾æ¥åº“ï¼ˆå¦‚ <code>.so</code> æˆ– <code>.dll</code>ï¼‰çš„æ ¸å¿ƒä¼˜åŠ¿å°±æ˜¯å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚</li>
<li>å¦‚æœåº“ä¸­ä½¿ç”¨ç»å¯¹åœ°å€ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è¦æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼Œå¤±å»äº†å…±äº«çš„æ„ä¹‰ã€‚</li>
<li>æ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰ï¼Œè®©åº“åœ¨ä»»æ„åœ°å€éƒ½èƒ½è¿è¡Œã€‚</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">åŒºåŸŸ</th>
<th align="center">æ˜¯å¦å¯å…±äº«</th>
<th align="center">åŸå› è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ä»£ç æ®µ</td>
<td align="center">âœ… æ˜¯</td>
<td align="center">åªè¯» + ä½ç½®æ— å…³ï¼Œå¤šä¸ªè¿›ç¨‹å¯æ˜ å°„åŒä¸€ç‰©ç†é¡µ</td>
</tr>
<tr>
<td align="center">æ•°æ®æ®µ</td>
<td align="center">âŒ å¦</td>
<td align="center">æ¯ä¸ªè¿›ç¨‹çš„æ•°æ®ä¸åŒï¼Œéœ€ç‹¬ç«‹å‰¯æœ¬</td>
</tr>
<tr>
<td align="center">å †</td>
<td align="center">âŒ å¦</td>
<td align="center">åŠ¨æ€åˆ†é…ï¼Œåœ°å€ç©ºé—´ä¸åŒ</td>
</tr>
<tr>
<td align="center">æ ˆ</td>
<td align="center">âŒ å¦</td>
<td align="center">ç§æœ‰è°ƒç”¨æ ˆï¼Œä¸èƒ½æ··ç”¨</td>
</tr>
<tr>
<td align="center">å…±äº«å†…å­˜æ®µ</td>
<td align="center">âœ… æ˜¯</td>
<td align="center">æ˜¾å¼åˆ›å»ºï¼Œä¸“é—¨ç”¨äºå…±äº«</td>
</tr>
</tbody></table>
<p>å¦‚æœä½ æƒ³æ·±å…¥äº†è§£æŸä¸ªè¿›ç¨‹çš„å†…å­˜å¸ƒå±€ï¼Œå¯ä»¥åˆ†æ <code>/proc/[pid]/maps</code> æˆ–ç”¨å·¥å…·å¦‚ <code>pmap</code>ã€<code>vmmap</code>ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/22/cpp/%E6%B1%87%E7%BC%96%E4%B8%8Egdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/22/cpp/%E6%B1%87%E7%BC%96%E4%B8%8Egdb/" class="post-title-link" itemprop="url">æ±‡ç¼–ä¸ gdb</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-22 15:42:27" itemprop="dateCreated datePublished" datetime="2025-08-22T15:42:27+00:00">2025-08-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1. å‰è¨€"></a>1. å‰è¨€</h2><p>æˆ‘ä»¬åœ¨è°ƒè¯• release ç‰ˆæœ¬çš„ç¨‹åºæ—¶ï¼Œç”±äºç¼ºä¹ç¬¦å·ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å¯„å­˜å™¨æ¥æŸ¥çœ‹å‡½æ•°çš„å‚æ•°ã€è¿”å›å€¼ç­‰ã€‚</p>
<h2 id="2-å¯„å­˜å™¨"><a href="#2-å¯„å­˜å™¨" class="headerlink" title="2. å¯„å­˜å™¨"></a>2. å¯„å­˜å™¨</h2><h3 id="2-1-é€šç”¨å¯„å­˜å™¨-General-Purpose-Registers"><a href="#2-1-é€šç”¨å¯„å­˜å™¨-General-Purpose-Registers" class="headerlink" title="2.1. é€šç”¨å¯„å­˜å™¨ (General Purpose Registers)"></a>2.1. é€šç”¨å¯„å­˜å™¨ (General Purpose Registers)</h3><table>
<thead>
<tr>
<th>å¯„å­˜å™¨å</th>
<th>è‹±æ–‡åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>rax</td>
<td>Accumulator</td>
<td>ç´¯åŠ å™¨ï¼Œé€šå¸¸ç”¨äºç®—æœ¯è¿ç®—å’Œå‡½æ•°è¿”å›å€¼å­˜å‚¨ã€‚</td>
</tr>
<tr>
<td>rbx</td>
<td>Base</td>
<td>åŸºå€å¯„å­˜å™¨ï¼Œå¸¸ç”¨äºå­˜å‚¨æ•°æ®æˆ–æŒ‡é’ˆã€‚</td>
</tr>
<tr>
<td>rsi</td>
<td>Source Index</td>
<td>æºç´¢å¼•å¯„å­˜å™¨ï¼Œå¸¸ç”¨äºå­—ç¬¦ä¸²æ“ä½œä¸­çš„æºåœ°å€æŒ‡é’ˆï¼ˆå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰ã€‚</td>
</tr>
<tr>
<td>rdi</td>
<td>Destination Index</td>
<td>ç›®æ ‡ç´¢å¼•å¯„å­˜å™¨ï¼Œå¸¸ç”¨äºå­—ç¬¦ä¸²æ“ä½œä¸­çš„ç›®æ ‡åœ°å€æŒ‡é’ˆæˆ–ç»“æ„ä½“æŒ‡é’ˆï¼ˆå‡½æ•°ç¬¬äºŒä¸ªå‚æ•°ï¼‰ã€‚</td>
</tr>
<tr>
<td>rdx</td>
<td>Data</td>
<td>æ•°æ®å¯„å­˜å™¨ï¼Œå¸¸ç”¨äº I&#x2F;O æ“ä½œæˆ–ä¹˜é™¤æ³•è¿ç®—ä¸­çš„æ‰©å±•æ•°æ®å­˜å‚¨ï¼ˆå‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•°ï¼‰ã€‚</td>
</tr>
<tr>
<td>rcx</td>
<td>Counter</td>
<td>è®¡æ•°å™¨å¯„å­˜å™¨ï¼Œå¸¸ç”¨äºå¾ªç¯è®¡æ•°æˆ–å­—ç¬¦ä¸²æ“ä½œä¸­çš„è®¡æ•°ï¼ˆå‡½æ•°ç¬¬å››ä¸ªå‚æ•°ï¼‰ã€‚</td>
</tr>
<tr>
<td>rsp</td>
<td>Stack Pointer</td>
<td>æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ŒæŒ‡å‘å½“å‰æ ˆé¡¶ã€‚</td>
</tr>
<tr>
<td>rbp</td>
<td>Base Pointer</td>
<td>åŸºå€æŒ‡é’ˆå¯„å­˜å™¨ï¼ŒæŒ‡å‘å½“å‰æ ˆå¸§çš„åŸºå€ã€‚</td>
</tr>
<tr>
<td>r8~r15</td>
<td>General Purpose</td>
<td>é€šç”¨å¯„å­˜å™¨ï¼Œæ‰©å±•çš„ 64 ä½å¯„å­˜å™¨ä¹‹ä¸€ï¼Œç”¨äºå­˜å‚¨æ•°æ®æˆ–æŒ‡é’ˆï¼ˆ<code>r8</code><del><code>r9</code> å¸¸ç”¨äºä¿å­˜å‡½æ•°ç¬¬äº”</del>å…­ä¸ªå‚æ•°ï¼‰ã€‚</td>
</tr>
</tbody></table>
<h3 id="2-2-ç‰¹æ®Šç”¨é€”å¯„å­˜å™¨-Special-Purpose-Registers"><a href="#2-2-ç‰¹æ®Šç”¨é€”å¯„å­˜å™¨-Special-Purpose-Registers" class="headerlink" title="2.2. ç‰¹æ®Šç”¨é€”å¯„å­˜å™¨ (Special Purpose Registers)"></a>2.2. ç‰¹æ®Šç”¨é€”å¯„å­˜å™¨ (Special Purpose Registers)</h3><table>
<thead>
<tr>
<th>å¯„å­˜å™¨å</th>
<th>è‹±æ–‡åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>rip</td>
<td>Instruction Pointer</td>
<td>æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ï¼Œå­˜å‚¨å½“å‰æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ã€‚</td>
</tr>
<tr>
<td>rflags</td>
<td>Flags</td>
<td>æ ‡å¿—å¯„å­˜å™¨ï¼Œå­˜å‚¨çŠ¶æ€æ ‡å¿—ä½ï¼ˆå¦‚è¿›ä½ã€æº¢å‡ºã€é›¶æ ‡å¿—ç­‰ï¼‰ã€‚</td>
</tr>
</tbody></table>
<h3 id="2-3-æ®µå¯„å­˜å™¨-Segment-Registers"><a href="#2-3-æ®µå¯„å­˜å™¨-Segment-Registers" class="headerlink" title="2.3. æ®µå¯„å­˜å™¨ (Segment Registers)"></a>2.3. æ®µå¯„å­˜å™¨ (Segment Registers)</h3><table>
<thead>
<tr>
<th>å¯„å­˜å™¨å</th>
<th>è‹±æ–‡åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>cs</td>
<td>Code Segment</td>
<td>ä»£ç æ®µå¯„å­˜å™¨ï¼ŒæŒ‡å‘å½“å‰ä»£ç æ®µçš„åŸºå€ã€‚</td>
</tr>
<tr>
<td>ds</td>
<td>Data Segment</td>
<td>æ•°æ®æ®µå¯„å­˜å™¨ï¼ŒæŒ‡å‘å½“å‰æ•°æ®æ®µçš„åŸºå€ã€‚</td>
</tr>
<tr>
<td>es</td>
<td>Extra Segment</td>
<td>é¢å¤–æ®µå¯„å­˜å™¨ï¼ŒæŒ‡å‘é¢å¤–æ•°æ®æ®µçš„åŸºå€ã€‚</td>
</tr>
<tr>
<td>fs</td>
<td>FS Segment</td>
<td>ç‰¹æ®Šç”¨é€”æ®µå¯„å­˜å™¨ï¼Œå¸¸ç”¨äºçº¿ç¨‹æœ¬åœ°å­˜å‚¨ç­‰ã€‚</td>
</tr>
<tr>
<td>gs</td>
<td>GS Segment</td>
<td>ç‰¹æ®Šç”¨é€”æ®µå¯„å­˜å™¨ï¼Œå¸¸ç”¨äºçº¿ç¨‹æœ¬åœ°å­˜å‚¨ç­‰ã€‚</td>
</tr>
<tr>
<td>ss</td>
<td>Stack Segment</td>
<td>æ ˆæ®µå¯„å­˜å™¨ï¼ŒæŒ‡å‘å½“å‰æ ˆæ®µçš„åŸºå€ã€‚</td>
</tr>
</tbody></table>
<h3 id="2-4-æµ®ç‚¹ä¸å‘é‡å¯„å­˜å™¨-Floating-Point-and-Vector-Registers"><a href="#2-4-æµ®ç‚¹ä¸å‘é‡å¯„å­˜å™¨-Floating-Point-and-Vector-Registers" class="headerlink" title="2.4. æµ®ç‚¹ä¸å‘é‡å¯„å­˜å™¨ (Floating Point and Vector Registers)"></a>2.4. æµ®ç‚¹ä¸å‘é‡å¯„å­˜å™¨ (Floating Point and Vector Registers)</h3><table>
<thead>
<tr>
<th>å¯„å­˜å™¨å</th>
<th>è‹±æ–‡åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>xmm0-xmm15</td>
<td>SIMD Registers</td>
<td>ç”¨äº SSE æŒ‡ä»¤é›†çš„ 128 ä½å‘é‡è¿ç®—ã€‚</td>
</tr>
<tr>
<td>ymm0-ymm15</td>
<td>AVX Registers</td>
<td>ç”¨äº AVX æŒ‡ä»¤é›†çš„ 256 ä½å‘é‡è¿ç®—ã€‚</td>
</tr>
<tr>
<td>zmm0-zmm31</td>
<td>AVX-512 Registers</td>
<td>ç”¨äº AVX-512 æŒ‡ä»¤é›†çš„ 512 ä½å‘é‡è¿ç®—ã€‚</td>
</tr>
</tbody></table>
<h3 id="2-5-å‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•°ä¼ é€’"><a href="#2-5-å‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•°ä¼ é€’" class="headerlink" title="2.5. å‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•°ä¼ é€’"></a>2.5. å‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•°ä¼ é€’</h3><p>åœ¨ x86_64 æ¶æ„ä¸­ï¼Œå‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•°ä¼ é€’éµå¾ª System V AMD64 ABIï¼ˆLinux&#x2F;Unix ç³»ç»Ÿçš„æ ‡å‡†è°ƒç”¨çº¦å®šï¼‰ã€‚</p>
<p>å‰å…­ä¸ªæ•´æ•°æˆ–æŒ‡é’ˆç±»å‹çš„å‚æ•°ä¾æ¬¡å­˜å‚¨åœ¨ä»¥ä¸‹å¯„å­˜å™¨ä¸­ï¼š</p>
<ol>
<li><strong>rdi</strong> - ç¬¬ä¸€ä¸ªå‚æ•°</li>
<li><strong>rsi</strong> - ç¬¬äºŒä¸ªå‚æ•°</li>
<li><strong>rdx</strong> - ç¬¬ä¸‰ä¸ªå‚æ•°</li>
<li><strong>rcx</strong> - ç¬¬å››ä¸ªå‚æ•°</li>
<li><strong>r8</strong>  - ç¬¬äº”ä¸ªå‚æ•°</li>
<li><strong>r9</strong>  - ç¬¬å…­ä¸ªå‚æ•°</li>
</ol>
<p>å¯¹äºæµ®ç‚¹ç±»å‹çš„å‚æ•°ï¼ˆå¦‚ <code>float</code> æˆ– <code>double</code>ï¼‰ï¼Œå‰å…«ä¸ªå‚æ•°å­˜å‚¨åœ¨ä»¥ä¸‹ <strong>SSE å¯„å­˜å™¨</strong> ä¸­ï¼š</p>
<ol>
<li><strong>xmm0</strong> - ç¬¬ä¸€ä¸ªæµ®ç‚¹å‚æ•°</li>
<li><strong>xmm1</strong> - ç¬¬äºŒä¸ªæµ®ç‚¹å‚æ•°</li>
<li><strong>xmm2</strong> - ç¬¬ä¸‰ä¸ªæµ®ç‚¹å‚æ•°</li>
<li><strong>xmm3</strong> - ç¬¬å››ä¸ªæµ®ç‚¹å‚æ•°</li>
<li><strong>xmm4</strong> - ç¬¬äº”ä¸ªæµ®ç‚¹å‚æ•°</li>
<li><strong>xmm5</strong> - ç¬¬å…­ä¸ªæµ®ç‚¹å‚æ•°</li>
<li><strong>xmm6</strong> - ç¬¬ä¸ƒä¸ªæµ®ç‚¹å‚æ•°</li>
<li><strong>xmm7</strong> - ç¬¬å…«ä¸ªæµ®ç‚¹å‚æ•°</li>
</ol>
<p>æº¢å‡ºå‚æ•°ï¼ˆè¶…è¿‡å¯„å­˜å™¨æ•°é‡ï¼‰ä¼šä¾æ¬¡å­˜å‚¨åœ¨ <strong>æ ˆ</strong> ä¸­ï¼š</p>
<ul>
<li>è¶…è¿‡å¯„å­˜å™¨æ•°é‡ï¼ˆæ•´æ•°å‚æ•°è¶…è¿‡ 6 ä¸ªï¼Œæµ®ç‚¹å‚æ•°è¶…è¿‡ 8 ä¸ªï¼‰çš„å‚æ•°ä¼šä¾æ¬¡å‹å…¥æ ˆä¸­ã€‚</li>
<li>æ ˆéœ€è¦ä¿æŒ 16 å­—èŠ‚å¯¹é½ï¼Œå¯èƒ½ä¼šæ’å…¥å¡«å……å­—èŠ‚ã€‚</li>
<li>å¯ä»¥é€šè¿‡è®¿é—®æ ˆæŒ‡é’ˆï¼ˆrspï¼‰æˆ–åŸºå€æŒ‡é’ˆï¼ˆrbpï¼‰æ¥æ‰¾åˆ°æ ˆä¸Šçš„å‚æ•°ã€‚<ul>
<li>ä½¿ç”¨ rspï¼ˆæ ˆæŒ‡é’ˆï¼‰<ul>
<li>åœ¨å‡½æ•°å…¥å£æ—¶ï¼Œrsp æŒ‡å‘æ ˆé¡¶ï¼ˆå³è¿”å›åœ°å€çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼‰ã€‚</li>
<li>æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªå‚æ•°ä½äº [rsp + 8]ï¼ˆè·³è¿‡è¿”å›åœ°å€ï¼‰ã€‚</li>
<li>ç¬¬äºŒä¸ªå‚æ•°ä½äº [rsp + 16]ï¼Œä¾æ­¤ç±»æ¨ã€‚</li>
</ul>
</li>
<li>ä½¿ç”¨ rbpï¼ˆåŸºå€æŒ‡é’ˆï¼‰<ul>
<li>å¦‚æœå‡½æ•°ä½¿ç”¨äº†å¸§æŒ‡é’ˆï¼ˆrbpï¼‰ï¼Œrbp é€šå¸¸æŒ‡å‘è°ƒç”¨è€…çš„æ ˆå¸§åŸºå€ã€‚</li>
<li>æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªå‚æ•°ä½äº [rbp + 16]ï¼ˆè·³è¿‡è¿”å›åœ°å€å’Œä¿å­˜çš„ rbpï¼‰ã€‚</li>
<li>ç¬¬äºŒä¸ªå‚æ•°ä½äº [rbp + 24]ï¼Œä¾æ­¤ç±»æ¨ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="3-æ ˆ"><a href="#3-æ ˆ" class="headerlink" title="3. æ ˆ"></a>3. æ ˆ</h2><h3 id="3-1-ç†è§£æ ˆå¸ƒå±€"><a href="#3-1-ç†è§£æ ˆå¸ƒå±€" class="headerlink" title="3.1. ç†è§£æ ˆå¸ƒå±€"></a>3.1. ç†è§£æ ˆå¸ƒå±€</h3><p>åœ¨å‡½æ•°è°ƒç”¨æ—¶ï¼Œæ ˆçš„å¸ƒå±€é€šå¸¸å¦‚ä¸‹ï¼ˆä»é«˜åœ°å€åˆ°ä½åœ°å€ï¼‰ï¼š</p>
<ol>
<li>è¿”å›åœ°å€ï¼šè°ƒç”¨å‡½æ•°æ—¶ï¼Œcall æŒ‡ä»¤ä¼šå°†è¿”å›åœ°å€ï¼ˆä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼‰å‹å…¥æ ˆä¸­ã€‚</li>
<li>æº¢å‡ºå‚æ•°ï¼šå¦‚æœå‚æ•°è¶…è¿‡å¯„å­˜å™¨æ•°é‡ï¼Œå¤šä½™çš„å‚æ•°ä¼šä¾æ¬¡å‹å…¥æ ˆä¸­ã€‚</li>
<li>æ ˆå¯¹é½å¡«å……ï¼šä¸ºäº†æ»¡è¶³ 16 å­—èŠ‚å¯¹é½è¦æ±‚ï¼Œå¯èƒ½ä¼šæœ‰é¢å¤–çš„å¡«å……å­—èŠ‚ã€‚</li>
<li>å±€éƒ¨å˜é‡å’Œä¿å­˜çš„å¯„å­˜å™¨ï¼šå‡½æ•°å†…éƒ¨å¯èƒ½ä¼šåœ¨æ ˆä¸Šåˆ†é…ç©ºé—´ç”¨äºå±€éƒ¨å˜é‡æˆ–ä¿å­˜è°ƒç”¨è€…çš„å¯„å­˜å™¨ã€‚</li>
</ol>
<h3 id="3-2-å‡½æ•°è°ƒç”¨æ—¶çš„å‹æ ˆè¿‡ç¨‹"><a href="#3-2-å‡½æ•°è°ƒç”¨æ—¶çš„å‹æ ˆè¿‡ç¨‹" class="headerlink" title="3.2. å‡½æ•°è°ƒç”¨æ—¶çš„å‹æ ˆè¿‡ç¨‹"></a>3.2. å‡½æ•°è°ƒç”¨æ—¶çš„å‹æ ˆè¿‡ç¨‹</h3><p>åœ¨x86_64æ¶æ„ä¸­ï¼Œå‡½æ•°è°ƒç”¨æ—¶ä¼šæ¶‰åŠåˆ°æ ˆçš„æ“ä½œï¼ŒåŒ…æ‹¬å‹æ ˆå’Œå‡ºæ ˆã€‚è¿™äº›æ“ä½œä¸»è¦ç”¨äºä¿å­˜è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚è¿”å›åœ°å€ã€å¯„å­˜å™¨å€¼ï¼‰ä»¥åŠä¸ºè¢«è°ƒç”¨å‡½æ•°åˆ†é…æ ˆå¸§ã€‚</p>
<h4 id="3-2-1-è°ƒç”¨è€…ï¼ˆCallerï¼‰çš„æ“ä½œ"><a href="#3-2-1-è°ƒç”¨è€…ï¼ˆCallerï¼‰çš„æ“ä½œ" class="headerlink" title="3.2.1. è°ƒç”¨è€…ï¼ˆCallerï¼‰çš„æ“ä½œ"></a>3.2.1. è°ƒç”¨è€…ï¼ˆCallerï¼‰çš„æ“ä½œ</h4><ol>
<li><p><strong>å‹å…¥è¿”å›åœ°å€</strong><br>å½“è°ƒç”¨è€…ä½¿ç”¨ <code>call</code> æŒ‡ä»¤è°ƒç”¨å‡½æ•°æ—¶ï¼ŒCPUä¼šè‡ªåŠ¨å°†è¿”å›åœ°å€ï¼ˆä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼‰å‹å…¥æ ˆä¸­ã€‚æ­¤æ—¶ï¼Œ<code>rsp</code>ï¼ˆæ ˆæŒ‡é’ˆï¼‰ä¼šå‡å°‘8å­—èŠ‚ï¼ˆ64ä½ç³»ç»Ÿï¼‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">call function</span><br><span class="line"># ç­‰ä»·äºï¼š</span><br><span class="line">push rip  ; å°†è¿”å›åœ°å€å‹å…¥æ ˆ</span><br><span class="line">jmp function</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>å‹å…¥æº¢å‡ºå‚æ•°ï¼ˆå¦‚æœæœ‰ï¼‰</strong><br>å¦‚æœå‡½æ•°çš„å‚æ•°è¶…è¿‡äº†å¯„å­˜å™¨æ•°é‡ï¼ˆæ•´æ•°å‚æ•°è¶…è¿‡6ä¸ªï¼Œæµ®ç‚¹å‚æ•°è¶…è¿‡8ä¸ªï¼‰ï¼Œå¤šä½™çš„å‚æ•°ä¼šä»å³åˆ°å·¦ä¾æ¬¡å‹å…¥æ ˆä¸­ã€‚<code>rsp</code> ä¼šéšç€æ¯ä¸ªå‚æ•°çš„å‹å…¥å‡å°‘ã€‚</p>
</li>
<li><p><strong>å¯¹é½æ ˆ</strong><br>ä¸ºäº†æ»¡è¶³ <strong>16å­—èŠ‚å¯¹é½</strong> çš„è¦æ±‚ï¼Œè°ƒç”¨è€…å¯èƒ½ä¼šæ’å…¥é¢å¤–çš„å¡«å……å­—èŠ‚ï¼Œä½¿å¾— <code>rsp</code> åœ¨è°ƒç”¨å‡½æ•°å‰ä¿æŒ16å­—èŠ‚å¯¹é½ã€‚</p>
</li>
</ol>
<h4 id="3-2-2-è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰çš„æ“ä½œ"><a href="#3-2-2-è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰çš„æ“ä½œ" class="headerlink" title="3.2.2. è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰çš„æ“ä½œ"></a>3.2.2. <strong>è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰çš„æ“ä½œ</strong></h4><ol>
<li><p><strong>ä¿å­˜è°ƒç”¨è€…çš„æ ˆå¸§åŸºå€</strong><br>è¢«è°ƒç”¨è€…é€šå¸¸ä¼šä¿å­˜è°ƒç”¨è€…çš„æ ˆå¸§åŸºå€ï¼ˆ<code>rbp</code>ï¼‰ï¼Œä»¥ä¾¿åœ¨å‡½æ•°è¿”å›æ—¶æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§ã€‚  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push rbp       ; ä¿å­˜è°ƒç”¨è€…çš„ rbp</span><br><span class="line">mov rbp, rsp   ; è®¾ç½®å½“å‰å‡½æ•°çš„æ ˆå¸§åŸºå€</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åˆ†é…æ ˆç©ºé—´</strong><br>è¢«è°ƒç”¨è€…ä¼šæ ¹æ®å‡½æ•°å†…éƒ¨å±€éƒ¨å˜é‡çš„éœ€æ±‚ï¼Œåœ¨æ ˆä¸Šåˆ†é…ç©ºé—´ã€‚<code>rsp</code> ä¼šå‡å°‘ç›¸åº”çš„å­—èŠ‚æ•°ã€‚  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub rsp, &lt;size&gt;  ; ä¸ºå±€éƒ¨å˜é‡åˆ†é…æ ˆç©ºé—´</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-3-2-å‡½æ•°è¿”å›æ—¶çš„å‡ºæ ˆè¿‡ç¨‹"><a href="#3-3-2-å‡½æ•°è¿”å›æ—¶çš„å‡ºæ ˆè¿‡ç¨‹" class="headerlink" title="3.3. 2. å‡½æ•°è¿”å›æ—¶çš„å‡ºæ ˆè¿‡ç¨‹"></a>3.3. <strong>2. å‡½æ•°è¿”å›æ—¶çš„å‡ºæ ˆè¿‡ç¨‹</strong></h3><h4 id="3-3-1-è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰çš„æ“ä½œ"><a href="#3-3-1-è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰çš„æ“ä½œ" class="headerlink" title="3.3.1. è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰çš„æ“ä½œ"></a>3.3.1. <strong>è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰çš„æ“ä½œ</strong></h4><ol>
<li><p><strong>é‡Šæ”¾å±€éƒ¨å˜é‡çš„æ ˆç©ºé—´</strong><br>è¢«è°ƒç”¨è€…åœ¨è¿”å›å‰ä¼šé‡Šæ”¾ä¸ºå±€éƒ¨å˜é‡åˆ†é…çš„æ ˆç©ºé—´ã€‚  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add rsp, &lt;size&gt;  ; æ¢å¤ rsp</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§åŸºå€</strong><br>è¢«è°ƒç”¨è€…ä¼šæ¢å¤è°ƒç”¨è€…çš„ <code>rbp</code>ï¼Œä»¥ç¡®ä¿è°ƒç”¨è€…çš„æ ˆå¸§å®Œæ•´ã€‚  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pop rbp  ; æ¢å¤è°ƒç”¨è€…çš„ rbp</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¿”å›åˆ°è°ƒç”¨è€…</strong><br>è¢«è°ƒç”¨è€…ä½¿ç”¨ <code>ret</code> æŒ‡ä»¤ä»æ ˆä¸­å¼¹å‡ºè¿”å›åœ°å€ï¼Œå¹¶è·³è½¬åˆ°è¯¥åœ°å€ã€‚  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret  ; ç­‰ä»·äºï¼špop rip</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="3-3-2-è°ƒç”¨è€…ï¼ˆCallerï¼‰çš„æ“ä½œ"><a href="#3-3-2-è°ƒç”¨è€…ï¼ˆCallerï¼‰çš„æ“ä½œ" class="headerlink" title="3.3.2. è°ƒç”¨è€…ï¼ˆCallerï¼‰çš„æ“ä½œ"></a>3.3.2. <strong>è°ƒç”¨è€…ï¼ˆCallerï¼‰çš„æ“ä½œ</strong></h4><ol>
<li><strong>æ¸…ç†æ ˆä¸Šçš„å‚æ•°ï¼ˆå¦‚æœéœ€è¦ï¼‰</strong><br>å¦‚æœè°ƒç”¨çº¦å®šè¦æ±‚è°ƒç”¨è€…æ¸…ç†æ ˆä¸Šçš„å‚æ•°ï¼ˆå¦‚ <code>cdecl</code> è°ƒç”¨çº¦å®šï¼‰ï¼Œè°ƒç”¨è€…ä¼šè°ƒæ•´ <code>rsp</code>ã€‚  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add rsp, &lt;size&gt;  ; æ¸…ç†æ ˆä¸Šçš„å‚æ•°</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-4-3-æ ˆæŒ‡é’ˆï¼ˆrspï¼‰å’ŒåŸºå€æŒ‡é’ˆï¼ˆrbpï¼‰çš„å˜åŒ–"><a href="#3-4-3-æ ˆæŒ‡é’ˆï¼ˆrspï¼‰å’ŒåŸºå€æŒ‡é’ˆï¼ˆrbpï¼‰çš„å˜åŒ–" class="headerlink" title="3.4. 3. æ ˆæŒ‡é’ˆï¼ˆrspï¼‰å’ŒåŸºå€æŒ‡é’ˆï¼ˆrbpï¼‰çš„å˜åŒ–"></a>3.4. <strong>3. æ ˆæŒ‡é’ˆï¼ˆ<code>rsp</code>ï¼‰å’ŒåŸºå€æŒ‡é’ˆï¼ˆ<code>rbp</code>ï¼‰çš„å˜åŒ–</strong></h3><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„æ ˆå¸ƒå±€ç¤ºä¾‹ï¼š</p>
<p> <strong>Cä»£ç </strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">example</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="type">int</span> x = a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    example(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ±‡ç¼–ä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># main å‡½æ•°</span><br><span class="line">main:</span><br><span class="line">    sub rsp, 16         ; å¯¹é½æ ˆ</span><br><span class="line">    mov edi, 1          ; ç¬¬ä¸€ä¸ªå‚æ•° -&gt; rdi</span><br><span class="line">    mov esi, 2          ; ç¬¬äºŒä¸ªå‚æ•° -&gt; rsi</span><br><span class="line">    call example        ; è°ƒç”¨ example å‡½æ•°</span><br><span class="line">    add rsp, 16         ; æ¢å¤æ ˆ</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line"># example å‡½æ•°</span><br><span class="line">example:</span><br><span class="line">    push rbp            ; ä¿å­˜è°ƒç”¨è€…çš„ rbp</span><br><span class="line">    mov rbp, rsp        ; è®¾ç½®å½“å‰æ ˆå¸§åŸºå€</span><br><span class="line">    sub rsp, 16         ; ä¸ºå±€éƒ¨å˜é‡åˆ†é…æ ˆç©ºé—´</span><br><span class="line">    mov eax, edi        ; a -&gt; eax</span><br><span class="line">    add eax, esi        ; a + b</span><br><span class="line">    leave               ; æ¢å¤æ ˆå¸§ï¼ˆç­‰ä»·äºï¼šmov rsp, rbp; pop rbpï¼‰</span><br><span class="line">    ret                 ; è¿”å›è°ƒç”¨è€…</span><br></pre></td></tr></table></figure>

<p> <strong>æ ˆå¸ƒå±€å˜åŒ–</strong></p>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th><code>rsp</code> å˜åŒ–</th>
<th>æ ˆå†…å®¹ï¼ˆä»é«˜åœ°å€åˆ°ä½åœ°å€ï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>call example</code></td>
<td><code>rsp -= 8</code></td>
<td>è¿”å›åœ°å€</td>
</tr>
<tr>
<td><code>push rbp</code></td>
<td><code>rsp -= 8</code></td>
<td>ä¿å­˜è°ƒç”¨è€…çš„ <code>rbp</code></td>
</tr>
<tr>
<td><code>sub rsp, 16</code></td>
<td><code>rsp -= 16</code></td>
<td>ä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´</td>
</tr>
<tr>
<td><code>leave</code></td>
<td><code>rsp += 16</code></td>
<td>é‡Šæ”¾å±€éƒ¨å˜é‡ç©ºé—´</td>
</tr>
<tr>
<td><code>ret</code></td>
<td><code>rsp += 8</code></td>
<td>å¼¹å‡ºè¿”å›åœ°å€</td>
</tr>
</tbody></table>
<h3 id="3-5-æ€»ç»“"><a href="#3-5-æ€»ç»“" class="headerlink" title="3.5. æ€»ç»“"></a>3.5. <strong>æ€»ç»“</strong></h3><ol>
<li><strong>å‡½æ•°è°ƒç”¨çš„æ ˆæ“ä½œ</strong>ï¼š<ul>
<li>è°ƒç”¨è€…è´Ÿè´£å‹å…¥è¿”å›åœ°å€å’Œæº¢å‡ºå‚æ•°ã€‚</li>
<li>è¢«è°ƒç”¨è€…è´Ÿè´£ä¿å­˜ <code>rbp</code> å’Œåˆ†é…å±€éƒ¨å˜é‡ç©ºé—´ã€‚</li>
<li>å‡½æ•°è¿”å›æ—¶ï¼Œé‡Šæ”¾å±€éƒ¨å˜é‡ç©ºé—´å¹¶æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§ã€‚</li>
</ul>
</li>
<li><strong><code>rsp</code> å’Œ <code>rbp</code> çš„å˜åŒ–</strong>ï¼š<ul>
<li><code>rsp</code> æŒ‡å‘æ ˆé¡¶ï¼ŒåŠ¨æ€å˜åŒ–ã€‚</li>
<li><code>rbp</code> æŒ‡å‘æ ˆå¸§åŸºå€ï¼Œé€šå¸¸å›ºå®šä¸å˜ã€‚</li>
</ul>
</li>
</ol>
<h2 id="4-ä½¿ç”¨-gdb-æŸ¥çœ‹å¯„å­˜å™¨"><a href="#4-ä½¿ç”¨-gdb-æŸ¥çœ‹å¯„å­˜å™¨" class="headerlink" title="4. ä½¿ç”¨ gdb æŸ¥çœ‹å¯„å­˜å™¨"></a>4. ä½¿ç”¨ gdb æŸ¥çœ‹å¯„å­˜å™¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰å¯„å­˜å™¨</span></span><br><span class="line">info registers</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šå¯„å­˜å™¨</span></span><br><span class="line">info registers rdi</span><br><span class="line"><span class="comment"># æˆ–ç®€å†™</span></span><br><span class="line">i r rdi</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åå…­è¿›åˆ¶</span></span><br><span class="line">p/x <span class="variable">$rdx</span>    <span class="comment"># åå…­è¿›åˆ¶</span></span><br><span class="line">p/d <span class="variable">$rdx</span>    <span class="comment"># åè¿›åˆ¶</span></span><br><span class="line"><span class="comment"># æˆ–ç®€å†™</span></span><br><span class="line">p <span class="variable">$rdx</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<code>info registers</code> ä¼šæ‰“å°ä¸‰åˆ—ï¼š</p>
<ul>
<li>ç¬¬ä¸€åˆ—ï¼šå¯„å­˜å™¨åç§°</li>
<li>ç¬¬äºŒåˆ—ï¼šå¯„å­˜å™¨çš„å€¼ï¼ˆåå…­è¿›åˆ¶ï¼‰</li>
<li>ç¬¬ä¸‰åˆ—ï¼šå¯„å­˜å™¨çš„å€¼ï¼ˆåè¿›åˆ¶ï¼›ä¹Ÿå¯èƒ½æ˜¯åå…­è¿›åˆ¶ï¼Œç”¨ <code>0x</code> å¼€å¤´ï¼‰</li>
</ul>
<p><code>info registers rdi</code> ä¸ <code>p $rdi</code> æ•ˆæœç›¸åŒã€‚</p>
<p>ä»å¯„å­˜å™¨æŸ¥åˆ°çš„å†…å­˜åœ°å€ï¼Œå¯ä»¥ç”¨ <code>x</code> ï¼ˆexaminzeï¼‰å‘½ä»¤æ¥æŸ¥çœ‹å†…å­˜çš„å€¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡ä»¤</span></span><br><span class="line">x/i <span class="variable">$rip</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ ˆé¡¶</span></span><br><span class="line">x/16x <span class="variable">$rsp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å†…å­˜</span></span><br><span class="line">p <span class="variable">$rdi</span></span><br><span class="line">x/2gx <span class="variable">$rdi</span></span><br><span class="line"><span class="comment"># æˆ–å…ˆç”¨ $rdi æŸ¥å‡ºå†…å­˜åœ°å€ï¼Œç›´æ¥ç”¨åœ°å€è®¿é—®</span></span><br><span class="line">x/2gx 47926411878160</span><br></pre></td></tr></table></figure>

<p><code>x</code> å‘½ä»¤çš„è¯´æ˜ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x/FMT ADDRESS</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼š</p>
<ul>
<li><code>x</code>ï¼šè¡¨ç¤ºâ€œexamine memoryâ€ï¼ˆæŸ¥çœ‹å†…å­˜ï¼‰</li>
<li><code>2</code>ï¼šæ•°å­—ï¼Œè¡¨ç¤ºè¦æŸ¥çœ‹çš„å•å…ƒæ•°</li>
<li><code>g</code>ï¼šè¡¨ç¤ºæ¯ä¸ªå•å…ƒçš„ sizeï¼Œæœ‰ b(byte), h(halfword), w(word), g(giant, 8 bytes)</li>
<li><code>x</code>ï¼šè¡¨ç¤ºå€¼çš„æ ¼å¼ï¼Œæœ‰ o(octal), x(hex), d(decimal), u(unsigned decimal), t(binary), f(float), a(address), i(instruction), c(char), s(string)<br>and z(hex, zero padded on the left).</li>
</ul>
<p>åœ¨ gdb å‘½ä»¤è¡Œä¸­ä½¿ç”¨ <code>help</code> å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹å‘½ä»¤çš„è¯´æ˜ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">help</span> x</span><br><span class="line">Examine memory: x/FMT ADDRESS.</span><br><span class="line">ADDRESS is an expression <span class="keyword">for</span> the memory address to examine.</span><br><span class="line">FMT is a repeat count followed by a format letter and a size letter.</span><br><span class="line">Format letters are o(octal), x(hex), d(decimal), u(unsigned decimal),</span><br><span class="line">  t(binary), f(<span class="built_in">float</span>), a(address), i(instruction), c(char), s(string)</span><br><span class="line">  and z(hex, zero padded on the left).</span><br><span class="line">Size letters are b(byte), h(halfword), w(word), g(giant, 8 bytes).</span><br><span class="line">The specified number of objects of the specified size are printed</span><br><span class="line">according to the format.  If a negative number is specified, memory is</span><br><span class="line">examined backward from the address.</span><br><span class="line"></span><br><span class="line">Defaults <span class="keyword">for</span> format and size letters are those previously used.</span><br><span class="line">Default count is 1.  Default address is following last thing printed</span><br><span class="line">with this <span class="built_in">command</span> or <span class="string">&quot;print&quot;</span>.</span><br></pre></td></tr></table></figure>

<h2 id="5-ä½¿ç”¨-gdb-æŸ¥çœ‹æ ˆ"><a href="#5-ä½¿ç”¨-gdb-æŸ¥çœ‹æ ˆ" class="headerlink" title="5. ä½¿ç”¨ gdb æŸ¥çœ‹æ ˆ"></a>5. ä½¿ç”¨ gdb æŸ¥çœ‹æ ˆ</h2><ul>
<li>bt</li>
<li>frame</li>
<li>args</li>
<li>locals</li>
<li>x</li>
</ul>
<p>TDODO</p>
<h3 id="5-1-frame-ä¸å¯„å­˜å™¨çš„å€¼"><a href="#5-1-frame-ä¸å¯„å­˜å™¨çš„å€¼" class="headerlink" title="5.1. frame ä¸å¯„å­˜å™¨çš„å€¼"></a>5.1. <code>frame</code> ä¸å¯„å­˜å™¨çš„å€¼</h3><ul>
<li>GDB ä¸­çš„å¯„å­˜å™¨å€¼ï¼ˆå¦‚ <code>$rax</code>, <code>$rdi</code>, <code>$rsp</code> ç­‰ï¼‰æ˜¯å½“å‰ CPU æ‰§è¡Œä¸Šä¸‹æ–‡çš„å¿«ç…§ã€‚</li>
<li>å½“ä½ åˆ‡æ¢åˆ° <code>frame 0</code>ï¼ˆæœ€å†…å±‚æ ˆå¸§ï¼‰æ—¶ï¼Œå¯„å­˜å™¨å€¼æ˜¯æœ€çœŸå®çš„ï¼Œå› ä¸ºè¿™æ˜¯ç¨‹åºå½“å‰æ­£åœ¨æ‰§è¡Œçš„åœ°æ–¹ã€‚</li>
<li>å½“ä½ åˆ‡æ¢åˆ° å¤–å±‚æ ˆå¸§ï¼ˆframe 1, 2, â€¦ï¼‰æ—¶ï¼ŒGDB ä¼šå°è¯•è¿˜åŸå½“æ—¶çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œä½†è¿™ä¾èµ–äºï¼š<ul>
<li>ç¼–è¯‘å™¨æ˜¯å¦ä¿å­˜äº†å¯„å­˜å™¨å€¼ï¼ˆå¦‚ callee-savedï¼‰</li>
<li>æ˜¯å¦æœ‰è°ƒè¯•ç¬¦å·æˆ– unwind ä¿¡æ¯</li>
<li>GDB æ˜¯å¦èƒ½æ¨æ–­å‡ºå¯„å­˜å™¨çš„ä¿å­˜ä½ç½®</li>
</ul>
</li>
</ul>
<p>å¯„å­˜å™¨å€¼å¯èƒ½å‡ºç°çš„æƒ…å†µ</p>
<table>
<thead>
<tr>
<th align="center">æƒ…å†µ</th>
<th align="center">è¡¨ç°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">å¯„å­˜å™¨æ˜¯ caller-savedï¼ˆå¦‚ rdi, rsi, raxï¼‰</td>
<td align="center">å¯èƒ½æ˜¾ç¤º <not saved> æˆ–é”™è¯¯å€¼</td>
</tr>
<tr>
<td align="center">å¯„å­˜å™¨æ˜¯ callee-savedï¼ˆå¦‚ rbx, rbp, r12~r15ï¼‰</td>
<td align="center">é€šå¸¸èƒ½æ­£ç¡®è¿˜åŸ</td>
</tr>
<tr>
<td align="center">æ²¡æœ‰è°ƒè¯•ä¿¡æ¯æˆ–ä¼˜åŒ–ä¸¥é‡</td>
<td align="center">GDB æ— æ³•è¿˜åŸï¼Œæ˜¾ç¤ºå½“å‰å€¼æˆ– <not saved></td>
</tr>
</tbody></table>
<p>å»ºè®®</p>
<ul>
<li>å¦‚æœä½ è¦åˆ†æå¯„å­˜å™¨çŠ¶æ€ï¼Œæœ€å¥½åœ¨ frame 0 æˆ–æ–­ç‚¹å¤„è¿›è¡Œã€‚</li>
<li>å¦‚æœä½ åœ¨åˆ†æ core dump æˆ–æ ˆç ´åé—®é¢˜ï¼Œå¯„å­˜å™¨å€¼åªèƒ½ä½œä¸ºå‚è€ƒï¼Œä¸è¦å®Œå…¨ä¾èµ–å¤–å±‚ frame çš„å¯„å­˜å™¨å¿«ç…§ã€‚</li>
<li>ä½¿ç”¨ info args å’Œ info locals æ›´å¯é åœ°æŸ¥çœ‹å‚æ•°å’Œå±€éƒ¨å˜é‡ï¼ˆå¦‚æœæœ‰ç¬¦å·ä¿¡æ¯ï¼‰ã€‚</li>
</ul>
<h2 id="6-åœ¨ç‰¹å®šçº¿ç¨‹ä¸­è®¾ç½®æ–­ç‚¹"><a href="#6-åœ¨ç‰¹å®šçº¿ç¨‹ä¸­è®¾ç½®æ–­ç‚¹" class="headerlink" title="6. åœ¨ç‰¹å®šçº¿ç¨‹ä¸­è®¾ç½®æ–­ç‚¹"></a>6. åœ¨ç‰¹å®šçº¿ç¨‹ä¸­è®¾ç½®æ–­ç‚¹</h2><h3 id="6-1-æ–­ç‚¹åªä½œç”¨äºæŸçº¿ç¨‹"><a href="#6-1-æ–­ç‚¹åªä½œç”¨äºæŸçº¿ç¨‹" class="headerlink" title="6.1. æ–­ç‚¹åªä½œç”¨äºæŸçº¿ç¨‹"></a>6.1. æ–­ç‚¹åªä½œç”¨äºæŸçº¿ç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹ ID å’Œå½“å‰çº¿ç¨‹ IDï¼ˆgdb ä¸­ä¼šä½¿ç”¨ * æ ‡æ³¨å½“å‰çº¿ç¨‹ï¼‰</span></span><br><span class="line">(gdb) info threads</span><br><span class="line"><span class="comment"># åˆ‡æ¢å½“å‰ä¸Šä¸‹æ–‡åˆ°æŒ‡å®šçº¿ç¨‹</span></span><br><span class="line">(gdb) thread &lt;THREAD_ID&gt;</span><br><span class="line"><span class="comment"># é€šè¿‡æŸ¥çœ‹å½“å‰å †æ ˆæ˜¯ä¸æ˜¯è‡ªå·±è¦æ–­ç‚¹çš„çº¿ç¨‹</span></span><br><span class="line">(gdb) bt</span><br><span class="line">(gdb) <span class="built_in">break</span> LOCATION thread THREADNUM</span><br><span class="line"><span class="comment"># æ¡ä»¶æ–­ç‚¹</span></span><br><span class="line">(gdb) <span class="built_in">break</span> source.c:123 thread 5 <span class="keyword">if</span> fds[0].fd == 7</span><br><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰ debug ç¬¦å·ï¼Œå¯ä»¥åˆ©ç”¨å‡½æ•°è¿”å›å€¼å¯„å­˜å™¨æ–­ç‚¹</span></span><br><span class="line">(gdb) <span class="built_in">break</span> poll thread 2 <span class="keyword">if</span> <span class="variable">$rdx</span> &gt; 0</span><br><span class="line"><span class="comment"># å®Œæ•´æ ¼å¼</span></span><br><span class="line"><span class="built_in">break</span> [PROBE_MODIFIER] [LOCATION] [thread THREADNUM] [<span class="keyword">if</span> CONDITION]</span><br></pre></td></tr></table></figure>

<h3 id="6-2-é”å®šè°ƒåº¦å™¨ï¼Œåªè®©å½“å‰çº¿ç¨‹è¿è¡Œ"><a href="#6-2-é”å®šè°ƒåº¦å™¨ï¼Œåªè®©å½“å‰çº¿ç¨‹è¿è¡Œ" class="headerlink" title="6.2. é”å®šè°ƒåº¦å™¨ï¼Œåªè®©å½“å‰çº¿ç¨‹è¿è¡Œ"></a>6.2. é”å®šè°ƒåº¦å™¨ï¼Œåªè®©å½“å‰çº¿ç¨‹è¿è¡Œ</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒGDB ä¼šè®©æ‰€æœ‰çº¿ç¨‹ä¸€èµ·è¿è¡Œï¼ˆæ¯”å¦‚ä½ æ‰§è¡Œ continue æ—¶ï¼‰ã€‚å¦‚æœä½ åªæƒ³è®©å½“å‰çº¿ç¨‹è¿è¡Œï¼Œå…¶å®ƒçº¿ç¨‹ä¿æŒæš‚åœï¼Œå¯ä»¥ä½¿ç”¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">set</span> scheduler-locking on</span><br></pre></td></tr></table></figure>

<p>è¿™è¡¨ç¤ºï¼šåªæœ‰å½“å‰çº¿ç¨‹ä¼šæ‰§è¡Œï¼Œå…¶ä»–çº¿ç¨‹å…¨éƒ¨æš‚åœã€‚</p>
<p>å…¶ä¸­æ¨¡å¼è¿˜æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th align="center">æ¨¡å¼</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">off</td>
<td align="center">é»˜è®¤å€¼ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è¿è¡Œ</td>
</tr>
<tr>
<td align="center">on</td>
<td align="center">åªæœ‰å½“å‰çº¿ç¨‹è¿è¡Œï¼Œå…¶ä»–çº¿ç¨‹æš‚åœ</td>
</tr>
<tr>
<td align="center">step</td>
<td align="center">å•æ­¥è°ƒè¯•æ—¶åªè¿è¡Œå½“å‰çº¿ç¨‹ï¼Œcontinue æ—¶å…¶ä»–çº¿ç¨‹ä¹Ÿä¼šè¿è¡Œ</td>
</tr>
</tbody></table>
<p>ä½ å¯ä»¥éšæ—¶åˆ‡æ¢ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">set</span> scheduler-locking step</span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœä½ åœ¨è°ƒè¯•æ­»é”ã€ç«æ€æˆ–çº¿ç¨‹é—´é€šä¿¡é—®é¢˜ï¼Œé”å®šè°ƒåº¦å™¨æ˜¯éå¸¸æœ‰æ•ˆçš„æ–¹å¼ã€‚</li>
<li>å¦‚æœä½ åœ¨è°ƒè¯•æŸä¸ª poll() æˆ– epoll_wait() è°ƒç”¨ï¼Œåªæƒ³è§‚å¯ŸæŸä¸ªçº¿ç¨‹çš„è¡Œä¸ºï¼Œå¯ä»¥ç»“åˆ catch syscall å’Œ thread å‘½ä»¤ä¸€èµ·ä½¿ç”¨ã€‚</li>
</ul>
<h2 id="7-æŸ¥çœ‹æ±‡ç¼–ä»£ç "><a href="#7-æŸ¥çœ‹æ±‡ç¼–ä»£ç " class="headerlink" title="7. æŸ¥çœ‹æ±‡ç¼–ä»£ç "></a>7. æŸ¥çœ‹æ±‡ç¼–ä»£ç </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼Œå…¶ä¸­ &quot;=&gt;&quot; æ ‡è®°çš„æ˜¯å½“å‰æ‰§è¡Œä½ç½®</span></span><br><span class="line">(gdb) disassemble</span><br><span class="line"><span class="comment"># åæ±‡ç¼–æŒ‡å®šåœ°å€èŒƒå›´</span></span><br><span class="line"><span class="comment"># è¿™ä¼šæ˜¾ç¤ºä»å½“å‰æŒ‡ä»¤å¼€å§‹çš„ 32 å­—èŠ‚èŒƒå›´å†…çš„æ±‡ç¼–ä»£ç ã€‚</span></span><br><span class="line">(gdb) disassemble <span class="variable">$rip</span>, <span class="variable">$rip</span>+32</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰æŒ‡ä»¤ï¼ˆx86ï¼‰</span></span><br><span class="line">(gdb) x/i <span class="variable">$pc</span></span><br><span class="line"><span class="comment"># æˆ–åœ¨ x86-64 æ¶æ„ä¸‹ï¼š</span></span><br><span class="line">(gdb) x/i <span class="variable">$rip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bonus: é»˜è®¤ GDB ä½¿ç”¨ AT&amp;T é£æ ¼ï¼ˆå¦‚ %raxï¼‰ï¼Œä½ å¯ä»¥åˆ‡æ¢ä¸º Intel é£æ ¼</span></span><br><span class="line"><span class="comment"># è¿™æ ·è¾“å‡ºä¼šæ›´æ¥è¿‘ä½ åœ¨æ±‡ç¼–æ•™ææˆ– IDA Pro ä¸­çœ‹åˆ°çš„æ ¼å¼</span></span><br><span class="line">(gdb) <span class="built_in">set</span> disassembly-flavor intel</span><br></pre></td></tr></table></figure>

<h2 id="8-ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰"><a href="#8-ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰" class="headerlink" title="8. ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰"></a>8. ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰</h2><h3 id="8-1-ä»€ä¹ˆæ˜¯-PIC"><a href="#8-1-ä»€ä¹ˆæ˜¯-PIC" class="headerlink" title="8.1. ä»€ä¹ˆæ˜¯ PIC"></a>8.1. <strong>ä»€ä¹ˆæ˜¯ PIC</strong></h3><ul>
<li><strong>PIC</strong>ï¼ˆPosition Independent Codeï¼Œä½ç½®æ— å…³ä»£ç ï¼‰æ˜¯ä¸€ç§ç¼–è¯‘æ–¹å¼ï¼Œä½¿å¾—ç”Ÿæˆçš„ä»£ç å¯ä»¥åœ¨å†…å­˜ä¸­çš„ä»»æ„ä½ç½®è¿è¡Œï¼Œè€Œæ— éœ€ç¡¬ç¼–ç ç»å¯¹åœ°å€ã€‚</li>
<li>åœ¨åŠ¨æ€é“¾æ¥åº“ï¼ˆ<code>shared libraries</code>ï¼‰ä¸­ï¼Œé€šå¸¸éœ€è¦ä½¿ç”¨ PICï¼Œä»¥ä¾¿åº“å¯ä»¥è¢«åŠ è½½åˆ°ä»»æ„å†…å­˜åœ°å€ã€‚</li>
<li>èŠ‚çœç©ºé—´ï¼šç›¸æ¯”ä½¿ç”¨ 64 ä½ç»å¯¹åœ°å€ï¼ŒRIP ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª 32 ä½åç§»é‡ã€‚</li>
<li>æ›´å®‰å…¨ï¼šæ”¯æŒåœ°å€éšæœºåŒ–ï¼ˆASLRï¼‰ï¼Œæé«˜ç¨‹åºçš„å®‰å…¨æ€§ã€‚</li>
</ul>
<h3 id="8-2-PIC-çš„å®ç°"><a href="#8-2-PIC-çš„å®ç°" class="headerlink" title="8.2. PIC çš„å®ç°"></a>8.2. <strong>PIC çš„å®ç°</strong></h3><ol>
<li><p><strong>è®¿é—®å…¨å±€å˜é‡</strong><br>åœ¨ PIC æ¨¡å¼ä¸‹ï¼Œä»£ç é€šè¿‡ <strong>å…¨å±€åç§»è¡¨ï¼ˆGOT, Global Offset Tableï¼‰</strong> å’Œ <strong>è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆPLT, Procedure Linkage Tableï¼‰</strong> è®¿é—®å…¨å±€å˜é‡å’Œå‡½æ•°åœ°å€ã€‚</p>
</li>
<li><p><strong>å¯„å­˜å™¨ <code>rip</code> çš„ä½¿ç”¨</strong><br>x86_64 æ”¯æŒåŸºäº <code>rip</code>ï¼ˆæŒ‡ä»¤æŒ‡é’ˆï¼‰çš„å¯»å€æ–¹å¼ï¼ŒPIC ä¼šåˆ©ç”¨ <code>rip</code> ç›¸å¯¹å¯»å€æ¥è®¿é—®å…¨å±€å˜é‡æˆ–å‡½æ•°åœ°å€ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç»å¯¹åœ°å€ã€‚</p>
</li>
</ol>
<p>åœ¨ x86-64 æ¶æ„ä¸­ï¼Œä¼ ç»Ÿçš„ç»å¯¹åœ°å€å¯»å€æ–¹å¼ä¸å†é€‚ç”¨äºä½ç½®æ— å…³ä»£ç ã€‚äºæ˜¯å¼•å…¥äº† RIPï¼ˆæŒ‡ä»¤æŒ‡é’ˆï¼‰ç›¸å¯¹å¯»å€ï¼š</p>
<p>å‡è®¾ä½ æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ int x &#x3D; 42;ï¼Œåœ¨æ±‡ç¼–ä¸­è®¿é—®å®ƒå¯èƒ½ä¼šå˜æˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">asm</span><br><span class="line">mov eax, DWORD PTR [rip + offset_to_x]</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ offset_to_x æ˜¯ç¼–è¯‘å™¨è®¡ç®—å‡ºæ¥çš„ x ç›¸å¯¹äºå½“å‰æŒ‡ä»¤çš„åç§»é‡ã€‚</p>
<table>
<thead>
<tr>
<th align="center">å¯»å€æ–¹å¼</th>
<th align="center">æè¿°</th>
<th align="center">æ˜¯å¦ä½ç½®æ— å…³</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ç»å¯¹åœ°å€å¯»å€</td>
<td align="center">ä½¿ç”¨å›ºå®šåœ°å€ï¼Œå¦‚ [0x400123]</td>
<td align="center">âŒ å¦</td>
</tr>
<tr>
<td align="center">å¯„å­˜å™¨é—´æ¥å¯»å€</td>
<td align="center">å¦‚ [rax]ï¼Œåœ°å€ç”±å¯„å­˜å™¨å†³å®š</td>
<td align="center">âœ… æ˜¯</td>
</tr>
<tr>
<td align="center">RIP ç›¸å¯¹å¯»å€</td>
<td align="center">å¦‚ [rip + offset]ï¼Œç›¸å¯¹å½“å‰æŒ‡ä»¤ä½ç½®</td>
<td align="center">âœ… æ˜¯</td>
</tr>
</tbody></table>
<h3 id="8-3-PIC-çš„ä¼˜åŒ–"><a href="#8-3-PIC-çš„ä¼˜åŒ–" class="headerlink" title="8.3. PIC çš„ä¼˜åŒ–"></a>8.3. <strong>PIC çš„ä¼˜åŒ–</strong></h3><ul>
<li><strong>å‡å°‘é‡å®šä½</strong>ï¼šé€šè¿‡ <code>rip</code> ç›¸å¯¹å¯»å€ï¼Œé¿å…äº†åŠ è½½æ—¶çš„é‡å®šä½æ“ä½œï¼Œæé«˜äº†åŠ è½½é€Ÿåº¦ã€‚</li>
<li><strong>å…±äº«å†…å­˜</strong>ï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥å…±äº«åŒä¸€æ®µåŠ¨æ€åº“ä»£ç ï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªè¿›ç¨‹ç”Ÿæˆç‹¬ç«‹çš„å‰¯æœ¬ã€‚</li>
</ul>
<h3 id="8-4-ç¤ºä¾‹"><a href="#8-4-ç¤ºä¾‹" class="headerlink" title="8.4. ç¤ºä¾‹"></a>8.4. <strong>ç¤ºä¾‹</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov rax, [rip + global_var@GOTPCREL]  ; é€šè¿‡ GOT è¡¨è®¿é—®å…¨å±€å˜é‡</span><br><span class="line">call [rip + func@PLT]                ; é€šè¿‡ PLT è¡¨è°ƒç”¨å‡½æ•°</span><br></pre></td></tr></table></figure>

<p>ä¸¾ä¸ª gdb è°ƒè¯•çš„ä¾‹å­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/i <span class="variable">$rip</span></span><br><span class="line">=&gt; 0x2ac084b5ec10 &lt;poll&gt;:       cmpl   <span class="variable">$0x0</span>,0x2d939d(%rip)        <span class="comment"># 0x2ac084e37fb4 &lt;__libc_multiple_threads&gt;</span></span><br><span class="line">(gdb) p (bool)<span class="variable">$__libc_multiple_threads</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>cmpl $0x0, 0x2d939d(%rip)</code> æ˜¯ä¸€æ¡æ¯”è¾ƒæŒ‡ä»¤ï¼ˆ<code>cmp</code>ï¼‰ï¼Œç”¨äºå°†æŸä¸ªå†…å­˜åœ°å€ä¸­çš„å€¼ä¸ç«‹å³æ•° <code>0</code> è¿›è¡Œæ¯”è¾ƒã€‚</li>
<li><code>(%rip)</code> è¡¨ç¤ºä½¿ç”¨ RIP ç›¸å¯¹å¯»å€ï¼Œè¿™æ˜¯ x86-64 æ¶æ„ä¸­å¸¸è§çš„ä¸€ç§å¯»å€æ–¹å¼ã€‚</li>
<li>å®é™…æ¯”è¾ƒçš„æ˜¯åœ°å€ <code>0x2ac084e37fb4</code> å¤„çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ <code>__libc_multiple_threads</code> è¿™ä¸ªå˜é‡ã€‚</li>
</ul>
<p><code>__libc_multiple_threads</code> æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>è¿™æ˜¯ GNU C åº“ï¼ˆglibcï¼‰ä¸­çš„ä¸€ä¸ªå†…éƒ¨å˜é‡ï¼Œç”¨æ¥æ ‡è®°å½“å‰è¿›ç¨‹æ˜¯å¦å¯ç”¨äº†å¤šçº¿ç¨‹ã€‚</li>
<li>å¦‚æœè¿™ä¸ªå€¼æ˜¯ 0ï¼Œè¯´æ˜å½“å‰è¿›ç¨‹æ˜¯å•çº¿ç¨‹ã€‚</li>
<li>å¦‚æœæ˜¯éé›¶ï¼Œè¯´æ˜è¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹ã€‚</li>
</ul>
<p>æ‰€ä»¥è¿™æ¡æŒ‡ä»¤çš„ä½œç”¨æ˜¯ï¼šåˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦æ˜¯å¤šçº¿ç¨‹ç¯å¢ƒï¼Œå¯èƒ½ç”¨äºå†³å®šæ˜¯å¦å¯ç”¨çº¿ç¨‹å®‰å…¨çš„è¡Œä¸ºã€‚</p>
<h3 id="8-5-ä¸ºä»€ä¹ˆä½¿ç”¨-RIP-ç›¸å¯¹å¯»å€ï¼Ÿ"><a href="#8-5-ä¸ºä»€ä¹ˆä½¿ç”¨-RIP-ç›¸å¯¹å¯»å€ï¼Ÿ" class="headerlink" title="8.5. ä¸ºä»€ä¹ˆä½¿ç”¨ RIP ç›¸å¯¹å¯»å€ï¼Ÿ"></a>8.5. ä¸ºä»€ä¹ˆä½¿ç”¨ RIP ç›¸å¯¹å¯»å€ï¼Ÿ</h3><ol>
<li>RIP æ˜¯å”¯ä¸€å§‹ç»ˆå·²çŸ¥çš„å¯„å­˜å™¨</li>
</ol>
<ul>
<li>åœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶ï¼ŒCPU æ€»æ˜¯çŸ¥é“å½“å‰æŒ‡ä»¤çš„åœ°å€ï¼ˆå³ RIPï¼‰ã€‚</li>
<li>æ‰€ä»¥å¯ä»¥åœ¨ç¼–è¯‘æ—¶è®¡ç®—å‡ºç›®æ ‡æ•°æ®ä¸å½“å‰æŒ‡ä»¤ä¹‹é—´çš„åç§»é‡ï¼Œè€Œä¸éœ€è¦çŸ¥é“æ•°æ®çš„ç»å¯¹åœ°å€ã€‚</li>
</ul>
<p>è¿™å°±å…è®¸ç¼–è¯‘å™¨ç”Ÿæˆä½ç½®æ— å…³ä»£ç ï¼Œå³ä½¿ç¨‹åºè¢«åŠ è½½åˆ°ä¸åŒçš„å†…å­˜åœ°å€ï¼Œåç§»é‡ä»ç„¶æœ‰æ•ˆã€‚</p>
<ol start="2">
<li>å…¶ä»–å¯„å­˜å™¨å€¼æ˜¯åŠ¨æ€çš„ï¼Œä¸å¯é¢„æµ‹</li>
</ol>
<ul>
<li>æ¯”å¦‚ RBXã€RAXã€RDI ç­‰å¯„å­˜å™¨ï¼Œå®ƒä»¬çš„å€¼åœ¨è¿è¡Œæ—¶å¯èƒ½è¢«ç¨‹åºä¿®æ”¹ã€‚</li>
<li>å¦‚æœç”¨è¿™äº›å¯„å­˜å™¨åšåŸºå€å¯»å€ï¼Œç¼–è¯‘å™¨å°±æ— æ³•æå‰çŸ¥é“å®ƒä»¬çš„å€¼ï¼Œä¹Ÿå°±æ— æ³•ç”Ÿæˆç¨³å®šçš„åç§»é‡ã€‚</li>
</ul>
<ol start="3">
<li>æ”¯æŒå…±äº«åº“å’Œåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰</li>
</ol>
<ul>
<li>RIP ç›¸å¯¹å¯»å€è®©ä»£ç æ®µä¸ä¾èµ–å›ºå®šåœ°å€ï¼Œå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚</li>
<li>ä¹Ÿæ”¯æŒæ“ä½œç³»ç»Ÿåœ¨è¿è¡Œæ—¶éšæœºåŠ è½½åœ°å€ï¼Œæé«˜å®‰å…¨æ€§ï¼ˆASLRï¼‰ã€‚</li>
</ul>
<ol start="4">
<li>èŠ‚çœæŒ‡ä»¤ç©ºé—´</li>
</ol>
<ul>
<li>ä½¿ç”¨ RIP ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª 32 ä½åç§»é‡ã€‚</li>
<li>å¦‚æœä½¿ç”¨ç»å¯¹åœ°å€ï¼Œéœ€è¦åµŒå…¥å®Œæ•´çš„ 64 ä½åœ°å€ï¼ŒæŒ‡ä»¤é•¿åº¦æ›´é•¿ï¼Œæ•ˆç‡æ›´ä½ã€‚</li>
</ul>
<h3 id="8-6-ä¸ºä»€ä¹ˆä½¿ç”¨-RIP-ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª-32-ä½åç§»é‡"><a href="#8-6-ä¸ºä»€ä¹ˆä½¿ç”¨-RIP-ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª-32-ä½åç§»é‡" class="headerlink" title="8.6. ä¸ºä»€ä¹ˆä½¿ç”¨ RIP ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª 32 ä½åç§»é‡"></a>8.6. ä¸ºä»€ä¹ˆä½¿ç”¨ RIP ç›¸å¯¹å¯»å€åªéœ€è¦ä¸€ä¸ª 32 ä½åç§»é‡</h3><p>åœ¨ x86-64 æ¶æ„ä¸­ï¼ŒRIP ç›¸å¯¹å¯»å€çš„åç§»é‡è¢«è®¾è®¡ä¸ºä¸€ä¸ªæœ‰ç¬¦å·çš„ 32 ä½æ•´æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª displacementï¼ˆä½ç§»ï¼‰å­—æ®µï¼Œå®ƒåœ¨æœºå™¨ç ä¸­åªå ç”¨ 4 ä¸ªå­—èŠ‚ã€‚</p>
<ul>
<li><p>RIP æ˜¯ 64 ä½çš„æŒ‡ä»¤æŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰æŒ‡ä»¤çš„åœ°å€ã€‚</p>
</li>
<li><p>RIP ç›¸å¯¹å¯»å€çš„ç›®æ ‡åœ°å€æ˜¯é€šè¿‡ï¼š</p>
<p><code>ç›®æ ‡åœ°å€ = ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼ˆRIPï¼‰ + 32 ä½åç§»é‡</code></p>
</li>
<li><p>è¿™ä¸ªåç§»é‡æ˜¯ä¸€ä¸ª æœ‰ç¬¦å·æ•´æ•°ï¼Œæ‰€ä»¥å®ƒçš„èŒƒå›´æ˜¯ï¼š</p>
<p>ä» âˆ’2Â³Â¹ åˆ° +2Â³Â¹âˆ’1ï¼Œå³ <strong>Â±2GB</strong> çš„å¯»å€èŒƒå›´ã€‚</p>
</li>
</ul>
<p>è¿™æ„å‘³ç€ï¼Œå½“å‰æŒ‡ä»¤é™„è¿‘ Â±2GB èŒƒå›´å†…çš„ä»»ä½•æ•°æ®éƒ½å¯ä»¥é€šè¿‡ RIP ç›¸å¯¹å¯»å€è®¿é—®ã€‚</p>
<table>
<thead>
<tr>
<th align="center">ä¼˜ç‚¹</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">âœ… èŠ‚çœç©ºé—´</td>
<td align="center">åªç”¨ 4 å­—èŠ‚è¡¨ç¤ºåç§»ï¼Œæ¯”ä½¿ç”¨å®Œæ•´ 64 ä½åœ°å€èŠ‚çœæŒ‡ä»¤é•¿åº¦</td>
</tr>
<tr>
<td align="center">âœ… æ”¯æŒä½ç½®æ— å…³ä»£ç </td>
<td align="center">ç¼–è¯‘å™¨åªéœ€è®¡ç®—åç§»ï¼Œä¸ä¾èµ–ç»å¯¹åœ°å€</td>
</tr>
<tr>
<td align="center">âœ… é«˜æ•ˆ</td>
<td align="center">CPU æ‰§è¡Œæ—¶åªéœ€åŠ æ³•è¿ç®—ï¼Œæ— éœ€æŸ¥è¡¨æˆ–é‡å®šä½</td>
</tr>
<tr>
<td align="center">âœ… å®‰å…¨</td>
<td align="center">æ”¯æŒåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰ï¼Œæé«˜å®‰å…¨æ€§</td>
</tr>
</tbody></table>
<h3 id="8-7-ä¸ºä»€ä¹ˆå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Ÿ"><a href="#8-7-ä¸ºä»€ä¹ˆå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Ÿ" class="headerlink" title="8.7. ä¸ºä»€ä¹ˆå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Ÿ"></a>8.7. ä¸ºä»€ä¹ˆå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Ÿ</h3><p>å› ä¸ºä»£ç ä¸­ä¸å†ç¡¬ç¼–ç å…·ä½“åœ°å€ï¼Œå¤šä¸ªè¿›ç¨‹å¯ä»¥ï¼š</p>
<ul>
<li>ä½¿ç”¨åŒä¸€ä»½ç‰©ç†å†…å­˜ä¸­çš„ä»£ç æ®µã€‚</li>
<li>æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„æ•°æ®æ®µï¼Œä½†å…±äº«åŒä¸€ä»½åªè¯»ä»£ç ã€‚</li>
</ul>
<p>è¿™å¤§å¤§èŠ‚çœäº†å†…å­˜ï¼Œæé«˜äº†ç³»ç»Ÿæ•ˆç‡ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<table>
<thead>
<tr>
<th align="center">è¿›ç¨‹</th>
<th align="center">åŠ è½½åœ°å€</th>
<th align="center">ä½¿ç”¨çš„ä»£ç æ®µ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">A</td>
<td align="center">0x400000</td>
<td align="center">ä½¿ç”¨å…±äº«ä»£ç æ®µ</td>
</tr>
<tr>
<td align="center">B</td>
<td align="center">0x500000</td>
<td align="center">ä½¿ç”¨å…±äº«ä»£ç æ®µ</td>
</tr>
</tbody></table>
<p>ä¸¤è€…çš„ä»£ç æ®µå†…å®¹å®Œå…¨ä¸€æ ·ï¼Œå› ä¸ºé‡Œé¢çš„å¯»å€æ˜¯ç›¸å¯¹ RIP çš„ï¼Œä¸ä¾èµ–äºåŠ è½½åœ°å€ã€‚</p>
<p>ä¸ºä»€ä¹ˆç»å¯¹å¯»å€ä¸å¯ä»¥è¢«å¤šè¿›ç¨‹å…±äº«ï¼Ÿ</p>
<ul>
<li>æ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯ç‹¬ç«‹çš„<ul>
<li>æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</li>
<li>å³ä½¿ä¸¤ä¸ªè¿›ç¨‹éƒ½åŠ è½½äº†åŒä¸€ä¸ªç¨‹åºï¼Œå®ƒä»¬çš„åœ°å€ç©ºé—´å¯èƒ½å®Œå…¨ä¸åŒã€‚</li>
<li>å¦‚æœä»£ç ä¸­ä½¿ç”¨ç»å¯¹åœ°å€ï¼ŒåŠ è½½åˆ°ä¸åŒåœ°å€ç©ºé—´åï¼Œè¿™äº›åœ°å€å°±ä¸å†æœ‰æ•ˆã€‚</li>
</ul>
</li>
</ul>
<p>æ‰€ä»¥ï¼Œç»å¯¹åœ°å€åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ˜¯æœ‰æ•ˆçš„ï¼Œåœ¨å¦ä¸€ä¸ªè¿›ç¨‹ä¸­å¯èƒ½å°±æŒ‡å‘é”™è¯¯çš„åœ°æ–¹æˆ–æ ¹æœ¬ä¸å­˜åœ¨ã€‚</p>
<ul>
<li><p>éœ€è¦é‡å®šä½ï¼Œæ— æ³•ç›´æ¥å…±äº«ç‰©ç†é¡µ</p>
<ul>
<li>å¦‚æœä½¿ç”¨ç»å¯¹åœ°å€ï¼Œæ“ä½œç³»ç»Ÿå¿…é¡»åœ¨æ¯ä¸ªè¿›ç¨‹åŠ è½½æ—¶å¯¹ä»£ç è¿›è¡Œâ€œé‡å®šä½â€ï¼Œä¿®æ”¹æŒ‡ä»¤ä¸­çš„åœ°å€ã€‚</li>
<li>ä¸€æ—¦ä¿®æ”¹ï¼Œä»£ç æ®µå°±å˜æˆäº†è¿›ç¨‹ç§æœ‰ï¼Œä¸èƒ½å…±äº«åŒä¸€ä»½ç‰©ç†å†…å­˜ã€‚</li>
<li>è€Œä½ç½®æ— å…³ä»£ç ï¼ˆå¦‚ä½¿ç”¨ RIP ç›¸å¯¹å¯»å€ï¼‰ä¸éœ€è¦ä¿®æ”¹ï¼Œå¯ä»¥ç›´æ¥æ˜ å°„åˆ°å¤šä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</li>
</ul>
</li>
<li><p>è¿åå…±äº«åº“çš„è®¾è®¡åŸåˆ™</p>
<ul>
<li>åŠ¨æ€é“¾æ¥åº“ï¼ˆå¦‚ <code>.so</code> æˆ– <code>.dll</code>ï¼‰çš„æ ¸å¿ƒä¼˜åŠ¿å°±æ˜¯å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚</li>
<li>å¦‚æœåº“ä¸­ä½¿ç”¨ç»å¯¹åœ°å€ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è¦æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼Œå¤±å»äº†å…±äº«çš„æ„ä¹‰ã€‚</li>
<li>æ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨ä½ç½®æ— å…³ä»£ç ï¼ˆPICï¼‰ï¼Œè®©åº“åœ¨ä»»æ„åœ°å€éƒ½èƒ½è¿è¡Œã€‚</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">åŒºåŸŸ</th>
<th align="center">æ˜¯å¦å¯å…±äº«</th>
<th align="center">åŸå› è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ä»£ç æ®µ</td>
<td align="center">âœ… æ˜¯</td>
<td align="center">åªè¯» + ä½ç½®æ— å…³ï¼Œå¤šä¸ªè¿›ç¨‹å¯æ˜ å°„åŒä¸€ç‰©ç†é¡µ</td>
</tr>
<tr>
<td align="center">æ•°æ®æ®µ</td>
<td align="center">âŒ å¦</td>
<td align="center">æ¯ä¸ªè¿›ç¨‹çš„æ•°æ®ä¸åŒï¼Œéœ€ç‹¬ç«‹å‰¯æœ¬</td>
</tr>
<tr>
<td align="center">å †</td>
<td align="center">âŒ å¦</td>
<td align="center">åŠ¨æ€åˆ†é…ï¼Œåœ°å€ç©ºé—´ä¸åŒ</td>
</tr>
<tr>
<td align="center">æ ˆ</td>
<td align="center">âŒ å¦</td>
<td align="center">ç§æœ‰è°ƒç”¨æ ˆï¼Œä¸èƒ½æ··ç”¨</td>
</tr>
<tr>
<td align="center">å…±äº«å†…å­˜æ®µ</td>
<td align="center">âœ… æ˜¯</td>
<td align="center">æ˜¾å¼åˆ›å»ºï¼Œä¸“é—¨ç”¨äºå…±äº«</td>
</tr>
</tbody></table>
<p>å¦‚æœä½ æƒ³æ·±å…¥äº†è§£æŸä¸ªè¿›ç¨‹çš„å†…å­˜å¸ƒå±€ï¼Œå¯ä»¥åˆ†æ <code>/proc/[pid]/maps</code> æˆ–ç”¨å·¥å…·å¦‚ <code>pmap</code>ã€<code>vmmap</code>ã€‚</p>
<h2 id="9-å®é™…-debug-ä¾‹å­ï¼šåœ¨å¤šçº¿ç¨‹ä¸­æŸ¥çœ‹-poll-çš„äº‹ä»¶"><a href="#9-å®é™…-debug-ä¾‹å­ï¼šåœ¨å¤šçº¿ç¨‹ä¸­æŸ¥çœ‹-poll-çš„äº‹ä»¶" class="headerlink" title="9. å®é™… debug ä¾‹å­ï¼šåœ¨å¤šçº¿ç¨‹ä¸­æŸ¥çœ‹ poll çš„äº‹ä»¶"></a>9. å®é™… debug ä¾‹å­ï¼šåœ¨å¤šçº¿ç¨‹ä¸­æŸ¥çœ‹ poll çš„äº‹ä»¶</h2><p>å…ˆå¤ä¹ ä¸‹ <code>poll</code> å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•° fds çš„ç±»å‹</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">    <span class="type">int</span>   fd;         <span class="comment">/* file descriptor */</span></span><br><span class="line">    <span class="type">short</span> events;     <span class="comment">/* requested events */</span></span><br><span class="line">    <span class="type">short</span> revents;    <span class="comment">/* returned events */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>FIXMEï¼šè¿™ç§åœ¨æ±‡ç¼–ä»£ç  ret å‰æ–­ç‚¹ï¼Œå¹¶ä¾æ® <code>rax</code> ã€<code>rdi</code> è®¾ç½®æ¡ä»¶æ–­ç‚¹çš„æ–¹å¼ä¸å¯é ï¼Œå› ä¸ºå¯èƒ½è¿›å…¥äº† libc å±‚ã€‚</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ polll çš„æ±‡ç¼–ä»£ç </span></span><br><span class="line">(gdb) disass poll</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> poll:</span><br><span class="line">   0x00002ac084b5ec10 &lt;+0&gt;:     cmpl   <span class="variable">$0x0</span>,0x2d939d(%rip)        <span class="comment"># 0x2ac084e37fb4 &lt;__libc_multiple_threads&gt;</span></span><br><span class="line">   0x00002ac084b5ec17 &lt;+7&gt;:     jne    0x2ac084b5ec29 &lt;poll+25&gt;</span><br><span class="line">   0x00002ac084b5ec19 &lt;+0&gt;:     mov    <span class="variable">$0x7</span>,%eax</span><br><span class="line">   0x00002ac084b5ec1e &lt;+5&gt;:     syscall </span><br><span class="line">   0x00002ac084b5ec20 &lt;+7&gt;:     cmp    <span class="variable">$0xfffffffffffff001</span>,%rax</span><br><span class="line">   0x00002ac084b5ec26 &lt;+13&gt;:    jae    0x2ac084b5ec59 &lt;poll+73&gt;</span><br><span class="line">   0x00002ac084b5ec28 &lt;+15&gt;:    ret    </span><br><span class="line">   0x00002ac084b5ec29 &lt;+25&gt;:    sub    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">   0x00002ac084b5ec2d &lt;+29&gt;:    call   0x2ac084b77600 &lt;__libc_enable_asynccancel&gt;</span><br><span class="line">   0x00002ac084b5ec32 &lt;+34&gt;:    mov    %rax,(%rsp)</span><br><span class="line">   0x00002ac084b5ec36 &lt;+38&gt;:    mov    <span class="variable">$0x7</span>,%eax</span><br><span class="line">   0x00002ac084b5ec3b &lt;+43&gt;:    syscall </span><br><span class="line">   0x00002ac084b5ec3d &lt;+45&gt;:    mov    (%rsp),%rdi</span><br><span class="line">   0x00002ac084b5ec41 &lt;+49&gt;:    mov    %rax,%rdx</span><br><span class="line">   0x00002ac084b5ec44 &lt;+52&gt;:    call   0x2ac084b77660 &lt;__libc_disable_asynccancel&gt;</span><br><span class="line">   0x00002ac084b5ec49 &lt;+57&gt;:    mov    %rdx,%rax</span><br><span class="line">   0x00002ac084b5ec4c &lt;+60&gt;:    add    <span class="variable">$0x8</span>,%rsp</span><br><span class="line">   0x00002ac084b5ec50 &lt;+64&gt;:    cmp    <span class="variable">$0xfffffffffffff001</span>,%rax</span><br><span class="line">   0x00002ac084b5ec56 &lt;+70&gt;:    jae    0x2ac084b5ec59 &lt;poll+73&gt;</span><br><span class="line">=&gt; 0x00002ac084b5ec58 &lt;+72&gt;:    ret    </span><br><span class="line">   0x00002ac084b5ec59 &lt;+73&gt;:    mov    0x2d31f0(%rip),%rcx        <span class="comment"># 0x2ac084e31e50</span></span><br><span class="line">   0x00002ac084b5ec60 &lt;+80&gt;:    neg    %eax</span><br><span class="line">   0x00002ac084b5ec62 &lt;+82&gt;:    mov    %eax,%fs:(%rcx)</span><br><span class="line">   0x00002ac084b5ec65 &lt;+85&gt;:    or     <span class="variable">$0xffffffffffffffff</span>,%rax</span><br><span class="line">   0x00002ac084b5ec69 &lt;+89&gt;:    ret</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¾åˆ°æ‰€æœ‰çš„ ret æŒ‡ä»¤ï¼Œè®¾ç½®æ¡ä»¶æ–­ç‚¹</span></span><br><span class="line"><span class="comment"># æ³¨æ„ï¼šæœ€å¥½æ˜¯åœ¨ ret æŒ‡ä»¤ä¹‹å‰çš„æŒ‡ä»¤ä¸Šä¹ŸåŠ ä¸Šæ–­ç‚¹ï¼Œ</span></span><br><span class="line"><span class="comment"># å› ä¸º ret çš„æ—¶å€™ï¼Œå¯èƒ½å·²ç»æŠŠå½“å‰æ ˆï¼ˆé™¤ rsp / rbp å¤–ï¼‰éƒ½å¼¹å‡ºäº†ï¼Œå¯„å­˜å™¨ä¸­å°†çœ‹ä¸åˆ°å½“å‰æ ˆçš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># $rax æ˜¯è¿”å›å€¼å¯„å­˜å™¨ï¼Œä¹Ÿå°±æ˜¯è¿”å›å¤§äº 0 æ—¶ï¼Œè®©è¿›ç¨‹æš‚åœ</span></span><br><span class="line"><span class="comment"># è¿™é‡Œçš„ * è¡¨ç¤ºå–å†…å­˜çš„å€¼ï¼ˆå­˜æ”¾çš„æ˜¯æŒ‡ä»¤ï¼‰ï¼Œ* æ–­ä¸å¯å°‘ï¼Œä¸ç„¶ä¼šè¢«è®¤ä¸ºæ˜¯ Function name</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">(gdb) b *0x00002ac084b5ec26 thread 4 <span class="keyword">if</span> <span class="variable">$rax</span> &gt; 0</span><br><span class="line">(gdb) b *0x00002ac084b5ec28 thread 4 <span class="keyword">if</span> <span class="variable">$rax</span> &gt; 0</span><br><span class="line">(gdb) b *0x00002ac084b5ec56 thread 4 <span class="keyword">if</span> <span class="variable">$rax</span> &gt; 0</span><br><span class="line">(gdb) b *0x00002ac084b5ec58 thread 4 <span class="keyword">if</span> <span class="variable">$rax</span> &gt; 0</span><br><span class="line">(gdb) b *0x00002ac084b5ec65 thread 4 <span class="keyword">if</span> <span class="variable">$rax</span> &gt; 0</span><br><span class="line">(gdb) b *0x00002ac084b5ec69 thread 4 <span class="keyword">if</span> <span class="variable">$rax</span> &gt; 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­è¿è¡Œ</span></span><br><span class="line">(gdb) c</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“ IO äº‹ä»¶å‘ç”Ÿï¼Œç¨‹åºä¼šè¢«æš‚åœ</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/21/dmtcp/DMTCP%E4%B9%8B%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86jalib/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/21/dmtcp/DMTCP%E4%B9%8B%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86jalib/" class="post-title-link" itemprop="url">DMTCP ä¹‹å†…å­˜ç®¡ç† (jalib)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-21 09:59:55" itemprop="dateCreated datePublished" datetime="2025-08-21T09:59:55+00:00">2025-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/DMTCP/" itemprop="url" rel="index"><span itemprop="name">DMTCP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><p><a target="_blank" rel="noopener" href="https://github.com/dmtcp/dmtcp/tree/main/jalib">https://github.com/dmtcp/dmtcp/tree/main/jalib</a></p>
<h2 id="malloc-çš„ç‰¹æ€§å’Œå±€é™"><a href="#malloc-çš„ç‰¹æ€§å’Œå±€é™" class="headerlink" title="malloc çš„ç‰¹æ€§å’Œå±€é™"></a>malloc çš„ç‰¹æ€§å’Œå±€é™</h2><p><code>malloc</code>&#x2F;<code>free</code> æ˜¯æ“ä½œç³»ç»Ÿï¼ˆæˆ– C åº“ï¼‰æä¾›çš„é€šç”¨å †åˆ†é…å™¨ã€‚</p>
<ul>
<li>å®ƒé€šå¸¸ä¼šé‡‡ç”¨ â€œå†…å­˜æ±  + åˆ†å— + ç©ºé—²é“¾è¡¨â€ ç­‰æŠ€æœ¯ï¼Œä½†å®ƒä¸ºäº†é€šç”¨æ€§å’Œçº¿ç¨‹å®‰å…¨ï¼Œè®¾è®¡å¾—å¾ˆå¤æ‚ï¼Œå¼€é”€è¾ƒå¤§ã€‚</li>
<li>åœ¨é«˜å¹¶å‘ &#x2F; é¢‘ç¹å°å—åˆ†é…é‡Šæ”¾çš„åœºæ™¯ä¸‹ï¼Œ<code>malloc</code> çš„æ€§èƒ½å’Œç¢ç‰‡æ§åˆ¶æœªå¿…ç†æƒ³ã€‚</li>
</ul>
<p><code>malloc</code> å¾ˆéš¾è®©ä½ ï¼š</p>
<ul>
<li>æ§åˆ¶åˆ†é…å†…å­˜çš„ä½ç½®ï¼ˆå¦‚ DMTCP éœ€è¦ç‰¹æ®Šå†…å­˜åŒºåŸŸï¼‰</li>
<li>ç»Ÿè®¡ &#x2F; è¿½è¸ªæ‰€æœ‰åˆ†é…çš„å†…å­˜å—</li>
<li>å®ç°å®šåˆ¶çš„åˆ†é…ç­–ç•¥ï¼ˆå¦‚æ— é”ã€åˆ†å±‚å°å—æ± ã€é¢„æ‰©å±•ç­‰ï¼‰</li>
<li>è½»æ¾è°ƒè¯•å’Œéš”ç¦»å†…å­˜é—®é¢˜</li>
</ul>
<h3 id="å†…å­˜ç¢ç‰‡"><a href="#å†…å­˜ç¢ç‰‡" class="headerlink" title="å†…å­˜ç¢ç‰‡"></a>å†…å­˜ç¢ç‰‡</h3><p>malloc çš„ç¡®åœ¨å…¶å®ç°å†…éƒ¨ä¹Ÿç»´æŠ¤ç€è‡ªå·±çš„ â€œå†…å­˜æ± â€ï¼Œå¹¶ä¸”ä¼šå¯¹å°å—å†…å­˜ï¼ˆsmall bins&#x2F;tcache&#x2F;fast bins ç­‰ï¼‰åšä¼˜åŒ–å’Œåˆ†ç»„ç®¡ç†ã€‚æ¯”å¦‚åœ¨ glibc çš„ mallocï¼ˆptmallocï¼‰ä¸­ï¼Œå°±æœ‰é’ˆå¯¹å°å—å†…å­˜çš„å¿«é€Ÿåˆ†é…æœºåˆ¶ã€‚</p>
<ol>
<li><p>malloc æ˜¯ â€œé€šç”¨åˆ†é…å™¨â€<br>malloc éœ€è¦æ”¯æŒæ‰€æœ‰åº”ç”¨åœºæ™¯ï¼ŒåŒ…æ‹¬å¤§ &#x2F; å° &#x2F; å¥‡å¼‚å°ºå¯¸çš„åˆ†é…ã€è·¨å¤šçº¿ç¨‹ã€å…¼å®¹å„ç§ç³»ç»Ÿè°ƒç”¨å’Œ ABIã€‚<br>ä¸ºäº†å…¼å®¹æ€§å’Œå¥å£®æ€§ï¼Œmalloc å®ç°å¤æ‚ï¼ŒåŒ…å«å¾ˆå¤šé¢å¤–çš„å…ƒæ•°æ®å’Œæ£€æŸ¥ï¼Œå¯¼è‡´åˆ†é… &#x2F; é‡Šæ”¾å¼€é”€æ›´å¤§ã€‚</p>
</li>
<li><p>malloc çš„å°å—ç®¡ç†æ˜¯ â€œå…¨å±€çš„â€<br>malloc ç®¡ç†çš„å°å—æ˜¯å…¨è¿›ç¨‹å…±äº«çš„ï¼Œæ‰€æœ‰çº¿ç¨‹ &#x2F; æ¨¡å—éƒ½ä¼šç«äº‰åŒä¸€å¥—ç®¡ç†ç»“æ„ï¼ˆå¦‚ fastbinã€tcacheã€small binï¼‰ã€‚<br>åœ¨é«˜å¹¶å‘ã€é¢‘ç¹å°å—åˆ†é… &#x2F; é‡Šæ”¾çš„åœºæ™¯ä¸‹ï¼Œé”ç«äº‰å’ŒåŒæ­¥æˆæœ¬å˜é«˜ï¼Œå¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚</p>
</li>
<li><p>è‡ªå®šä¹‰åˆ†é…å™¨ï¼ˆå¦‚ jalibï¼‰â€œæ›´çª„ã€æ›´ä¸“ç”¨â€<br>jalib åªæœåŠ¡ DMTCP å†…éƒ¨çš„ç‰¹æ®Šå†…å­˜åˆ†é…éœ€æ±‚ï¼Œåªå…³æ³¨å›ºå®šå‡ ç§å…¸å‹çš„å°å—å°ºå¯¸ï¼ˆå¦‚ 64&#x2F;256&#x2F;1024â€¦ï¼‰ã€‚<br>å¯ä»¥ç”¨æ›´ç®€å•ã€æ›´é«˜æ•ˆçš„ â€œæ— é”é“¾è¡¨ + å†…å­˜å¯¹é½å—â€ æ¥ç®¡ç†æ± ï¼Œåˆ†é…å’Œé‡Šæ”¾å‡ ä¹éƒ½æ˜¯ O(1)çš„åŸå­æ“ä½œã€‚<br>ä¸éœ€è¦å…¼å®¹æ‰€æœ‰ malloc çš„åœºæ™¯ï¼ˆå¦‚ reallocã€è·¨æ¨¡å—é‡Šæ”¾ç­‰ï¼‰ï¼Œæ‰€ä»¥èƒ½æè‡´ä¼˜åŒ–ã€‚</p>
</li>
<li><p>æ§åˆ¶æƒå’Œå¯è§‚æµ‹æ€§<br>jalib å¯ä»¥å®Œå…¨æŒæ§æ± çš„ç”Ÿå‘½å‘¨æœŸã€åˆ†é…åŒºåŸŸã€åˆ†é…ç­–ç•¥ï¼ˆå¦‚é¢„æ‰©å±•ã€å®šåˆ¶å›æ”¶ï¼‰ï¼Œè¿˜å¯ä»¥è¿½è¸ªç»Ÿè®¡ã€è°ƒè¯•ã€‚<br>malloc çš„å†…éƒ¨çŠ¶æ€ä½ æ— æ³•ç›´æ¥æ§åˆ¶æˆ–æ„ŸçŸ¥ï¼Œä¹Ÿæ— æ³•æ–¹ä¾¿åœ°å’Œ DMTCP çš„ checkpointã€å›æ»šç­‰åŠŸèƒ½é›†æˆã€‚</p>
</li>
<li><p>å†…å­˜ç¢ç‰‡å’Œç¡®å®šæ€§<br>ä¸“ç”¨åˆ†é…å™¨èƒ½ä¿è¯åˆ†é…å— â€œå®šé•¿ã€å¯¹é½â€ï¼Œå‡ ä¹æ— ç¢ç‰‡ï¼Œåˆ†é…å’Œå›æ”¶éƒ½æ˜¯ç¡®å®šæ€§çš„ã€‚<br>malloc éœ€è¦å…¼å®¹å„ç§å°ºå¯¸ï¼Œç¢ç‰‡å’Œå†…å­˜æŠ–åŠ¨ä¸å¯é¿å…ã€‚</p>
</li>
</ol>
<h2 id="jalibï¼ˆè‡ªå®šä¹‰åˆ†é…å™¨ï¼‰çš„è®¾è®¡åŠ¨æœº"><a href="#jalibï¼ˆè‡ªå®šä¹‰åˆ†é…å™¨ï¼‰çš„è®¾è®¡åŠ¨æœº" class="headerlink" title="jalibï¼ˆè‡ªå®šä¹‰åˆ†é…å™¨ï¼‰çš„è®¾è®¡åŠ¨æœº"></a>jalibï¼ˆè‡ªå®šä¹‰åˆ†é…å™¨ï¼‰çš„è®¾è®¡åŠ¨æœº</h2><h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><ul>
<li>DMTCP é¢‘ç¹åœ°åˆ†é…å’Œé‡Šæ”¾å°å—å†…å­˜ï¼ˆå¦‚å…ƒæ•°æ®ã€ä¸´æ—¶ç¼“å­˜ç­‰ï¼‰ï¼Œå¦‚æœæ¯æ¬¡éƒ½ç”¨ mallocï¼Œæ€§èƒ½æŸè€—å¤§ã€‚</li>
<li>jalib é‡‡ç”¨åˆ†çº§å›ºå®šå—æ± ï¼Œæ¯æ¬¡åˆ†é… &#x2F; é‡Šæ”¾åªéœ€æ“ä½œé“¾è¡¨å’ŒåŸå­å˜é‡ï¼Œæ¯” malloc æ›´å¿«ã€æ›´å°‘ç¢ç‰‡ã€‚</li>
</ul>
<h3 id="çº¿ç¨‹å®‰å…¨çš„é«˜æ•ˆå®ç°"><a href="#çº¿ç¨‹å®‰å…¨çš„é«˜æ•ˆå®ç°" class="headerlink" title="çº¿ç¨‹å®‰å…¨çš„é«˜æ•ˆå®ç°"></a>çº¿ç¨‹å®‰å…¨çš„é«˜æ•ˆå®ç°</h3><ul>
<li>jalib ç”¨æ— é”ï¼ˆ128 ä½ CASï¼‰æˆ–è½»é‡çº§äº’æ–¥æ–¹æ¡ˆï¼Œé€‚åˆé«˜å¹¶å‘åˆ†é… &#x2F; é‡Šæ”¾ã€‚</li>
<li>malloc è™½ç„¶çº¿ç¨‹å®‰å…¨ï¼Œä½†å®ç°æ–¹å¼æ›´é‡ï¼Œé€‚ç”¨èŒƒå›´æ›´å¹¿ï¼Œæœªå¿…æœ€ä¼˜ã€‚</li>
</ul>
<h3 id="å¯æ§æ€§å’Œå¯è¿½è¸ªæ€§"><a href="#å¯æ§æ€§å’Œå¯è¿½è¸ªæ€§" class="headerlink" title="å¯æ§æ€§å’Œå¯è¿½è¸ªæ€§"></a>å¯æ§æ€§å’Œå¯è¿½è¸ªæ€§</h3><ul>
<li>jalib å¯ä»¥ç»Ÿè®¡åˆ†é…æ¬¡æ•°ã€è¿½è¸ªæ‰€æœ‰å†…å­˜æ± åŒºï¼Œæ–¹ä¾¿è°ƒè¯•ã€åˆ†æå’Œ checkpoint æ¢å¤ã€‚</li>
<li>å¯æ ¹æ®å®é™…éœ€æ±‚é¢„åˆ†é…æˆ–æ‰¹é‡æ‰©å±•ï¼Œé¿å…è¿è¡Œæ—¶å¤§è§„æ¨¡å†…å­˜æŠ–åŠ¨ã€‚</li>
</ul>
<h3 id="é€‚åº”-DMTCP-çš„ç‰¹æ®Šéœ€æ±‚"><a href="#é€‚åº”-DMTCP-çš„ç‰¹æ®Šéœ€æ±‚" class="headerlink" title="é€‚åº” DMTCP çš„ç‰¹æ®Šéœ€æ±‚"></a>é€‚åº” DMTCP çš„ç‰¹æ®Šéœ€æ±‚</h3><ul>
<li>DMTCP éœ€è¦åœ¨ checkpoint&#x2F;restore æ—¶ç®¡ç†æ‰€æœ‰å†…å­˜åŒºåŸŸï¼Œjalib å¯ä»¥å®šåˆ¶åˆ†é…åŒºåŸŸã€åˆ†é…æ–¹å¼ï¼Œmalloc æ— æ³•æ»¡è¶³ã€‚</li>
<li>å¯å®ç°ç‰¹å®šå¹³å°çš„ä¼˜åŒ–ï¼Œå¦‚ mmap å›ºå®šåœ°å€åˆ†é…ç­‰ã€‚</li>
</ul>
<h3 id="æ•…éšœéš”ç¦»å’Œè°ƒè¯•"><a href="#æ•…éšœéš”ç¦»å’Œè°ƒè¯•" class="headerlink" title="æ•…éšœéš”ç¦»å’Œè°ƒè¯•"></a>æ•…éšœéš”ç¦»å’Œè°ƒè¯•</h3><ul>
<li>jalib å¯ä»¥åœ¨æœ‰ bug æˆ–å†…å­˜æ³„æ¼æ—¶ï¼Œå¸®åŠ©å®šä½å…·ä½“çš„åˆ†é… &#x2F; é‡Šæ”¾æµç¨‹ã€‚</li>
<li>å¯ä»¥æ–¹ä¾¿åœ°è®°å½•æ‰€æœ‰ arena ä¿¡æ¯ï¼Œç”šè‡³å®ç°ç‰¹æ®Šçš„è°ƒè¯•æ¨¡å¼ã€‚</li>
</ul>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è™½ç„¶ malloc ä¹Ÿæ˜¯å†…å­˜æ± ç®¡ç†ï¼Œä½†å®ƒæ˜¯ä¸ºé€šç”¨ç”¨é€”è®¾è®¡çš„ï¼Œä¸èƒ½æ»¡è¶³ DMTCP è¿™ç±»é«˜æ€§èƒ½ã€é«˜å¯æ§æ€§ã€ç‰¹æ®Šå†…å­˜ç®¡ç†éœ€æ±‚åœºæ™¯ã€‚è‡ªå®šä¹‰ jalib åˆ†é…å™¨å¯ä»¥æ›´é«˜æ•ˆåœ°ç®¡ç†å°å—å†…å­˜ï¼Œä¼˜åŒ–å¤šçº¿ç¨‹æ€§èƒ½ï¼Œä¾¿äºè°ƒè¯•å’Œé€‚é…ç‰¹å®šéœ€æ±‚ã€‚</p>
<p>å¯ä»¥å½’çº³ä¸ºä¸‰ç‚¹ï¼š</p>
<ul>
<li>æ€§èƒ½æ›´é«˜ï¼Œç¢ç‰‡æ›´å°‘</li>
<li>æ›´å¥½åœ°é€‚åº” DMTCP çš„éœ€æ±‚</li>
<li>æ›´æ˜“äºè°ƒè¯•å’Œæ§åˆ¶</li>
</ul>
<h2 id="jalloc-è®¾è®¡æ€è·¯"><a href="#jalloc-è®¾è®¡æ€è·¯" class="headerlink" title="jalloc è®¾è®¡æ€è·¯"></a>jalloc è®¾è®¡æ€è·¯</h2><h3 id="å¤šå±‚çº§å›ºå®šå¤§å°å—åˆ†é…ï¼ˆå±‚çº§åˆ†é…å™¨ï¼‰"><a href="#å¤šå±‚çº§å›ºå®šå¤§å°å—åˆ†é…ï¼ˆå±‚çº§åˆ†é…å™¨ï¼‰" class="headerlink" title="å¤šå±‚çº§å›ºå®šå¤§å°å—åˆ†é…ï¼ˆå±‚çº§åˆ†é…å™¨ï¼‰"></a>å¤šå±‚çº§å›ºå®šå¤§å°å—åˆ†é…ï¼ˆå±‚çº§åˆ†é…å™¨ï¼‰</h3><ul>
<li>è®¾è®¡äº† 5 ä¸ªåˆ†é…å±‚çº§ï¼ˆlvl1~lvl5ï¼‰ï¼Œæ¯å±‚è´Ÿè´£ä¸åŒå¤§å°çš„å®šé•¿å†…å­˜å—ï¼ˆå¦‚ 64ã€256ã€1024ã€4096ã€16384 å­—èŠ‚ï¼‰ã€‚</li>
<li>å°äºç­‰äºè¿™ 5 ä¸ªç­‰çº§çš„åˆ†é…è¯·æ±‚ï¼Œä¼šè¢«åˆ†é…åˆ°å„è‡ªçš„å±‚çº§ã€‚</li>
<li>è¶…è¿‡æœ€å¤§å±‚çº§çš„è¯·æ±‚ï¼Œåˆ™ç›´æ¥è°ƒç”¨ <code>_alloc_raw</code>ï¼ˆé€šå¸¸æ˜¯ <code>mmap</code>ï¼‰ã€‚</li>
</ul>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å°å—å†…å­˜å¯ä»¥å¤ç”¨ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨å’Œç¢ç‰‡ã€‚</li>
<li>å¤§å—å†…å­˜ä»å¯ç›´æ¥ç”¨ç³»ç»Ÿæ¥å£ï¼Œå…¼é¡¾é€šç”¨æ€§ã€‚</li>
</ul>
<h3 id="å›ºå®šå—åˆ†é…å™¨-JFixedAllocStack"><a href="#å›ºå®šå—åˆ†é…å™¨-JFixedAllocStack" class="headerlink" title="å›ºå®šå—åˆ†é…å™¨ JFixedAllocStack"></a>å›ºå®šå—åˆ†é…å™¨ JFixedAllocStack</h3><p>æ¯ä¸ªå±‚çº§å¯¹åº”ä¸€ä¸ª <code>JFixedAllocStack&lt;N&gt;</code>ï¼Œå…¶æ ¸å¿ƒæ˜¯æ— é”æ ˆå¼ç®¡ç†ï¼š</p>
<ul>
<li>å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªç©ºé—²å—æ ˆï¼ˆLIFO é“¾è¡¨ï¼‰ã€‚</li>
<li>allocate æ—¶ä»æ ˆå–å‡ºä¸€ä¸ªç©ºé—²å—ï¼Œæ ˆç©ºæ—¶è°ƒç”¨ expand ç”³è¯·ä¸€æ‰¹æ–°å—ã€‚</li>
<li>deallocate æ—¶å°†å—å½’è¿˜åˆ°æ ˆé¡¶ã€‚</li>
</ul>
<p>æ ¸å¿ƒæŠ€æœ¯ç‚¹</p>
<ul>
<li><p>åŸå­åŒå­—æ¯”è¾ƒäº¤æ¢ï¼ˆ128 ä½ CASï¼‰</p>
<p>ä¸ºäº†çº¿ç¨‹å®‰å…¨ï¼Œæ ˆé¡¶æŒ‡é’ˆ _top éœ€è¦åŸå­æ›´æ–°ã€‚è¿™é‡Œç”¨åˆ°äº† 128 ä½ CASï¼ˆCompare-And-Swapï¼‰ï¼Œä¿è¯ node æŒ‡é’ˆå’Œè®¡æ•°å™¨åŒæ—¶æ›´æ–°ï¼Œé¿å… ABA é—®é¢˜ã€‚</p>
</li>
<li><p>CAS ä¸å¯ç”¨æ—¶çš„é™çº§æ–¹æ¡ˆ</p>
<p>å¯¹äºä¸æ”¯æŒ 128 ä½åŸå­æ“ä½œçš„å¹³å°ï¼Œé‡‡ç”¨ futex+memcpy çš„æ–¹å¼æ‰‹åŠ¨å®ç°äº’æ–¥å’ŒåŸå­æ€§ã€‚</p>
</li>
</ul>
<h3 id="çº¿ç¨‹å®‰å…¨è®¾è®¡"><a href="#çº¿ç¨‹å®‰å…¨è®¾è®¡" class="headerlink" title="çº¿ç¨‹å®‰å…¨è®¾è®¡"></a>çº¿ç¨‹å®‰å…¨è®¾è®¡</h3><p>åˆ†é…å’Œé‡Šæ”¾éƒ½ç”¨åŸå­æ“ä½œä¿æŠ¤ï¼Œæ— éœ€é”ï¼Œæ€§èƒ½é«˜ã€‚<br>å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°ç«äº‰æ¡ä»¶æˆ–å†…å­˜ç ´åã€‚</p>
<h3 id="Arena-è®°å½•å’Œè°ƒè¯•"><a href="#Arena-è®°å½•å’Œè°ƒè¯•" class="headerlink" title="Arena è®°å½•å’Œè°ƒè¯•"></a>Arena è®°å½•å’Œè°ƒè¯•</h3><p>åˆ†é…çš„å†…å­˜åŒºåŸŸï¼ˆarenaï¼‰å¯ä»¥è®°å½•åˆ°å…¨å±€æ•°ç»„ä¸­ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œç»Ÿè®¡ã€‚<br>é€šè¿‡ <code>JAlloc::getAllocArenas()</code> å¯è·å¾—åˆ†é…åŒºåŸŸåˆ—è¡¨ã€‚</p>
<h3 id="å…¨å±€-new-delete-é‡è½½ï¼ˆå¯é€‰ï¼‰"><a href="#å…¨å±€-new-delete-é‡è½½ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="å…¨å±€ new&#x2F;delete é‡è½½ï¼ˆå¯é€‰ï¼‰"></a>å…¨å±€ new&#x2F;delete é‡è½½ï¼ˆå¯é€‰ï¼‰</h3><p>å¦‚æœå®šä¹‰äº† <code>OVERRIDE_GLOBAL_ALLOCATOR</code>ï¼Œä¼šé‡è½½ <code>operator new</code> å’Œ <code>operator delete</code>ï¼Œè®©å…¨å±€ <code>new</code>&#x2F;<code>delete</code> ä¹Ÿç”¨è¿™ä¸ªåˆ†é…å™¨ã€‚</p>
<h3 id="çµæ´»åˆ‡æ¢"><a href="#çµæ´»åˆ‡æ¢" class="headerlink" title="çµæ´»åˆ‡æ¢"></a>çµæ´»åˆ‡æ¢</h3><p>å¯ä»¥é€šè¿‡å® <code>JALIB_ALLOCATOR</code> åˆ‡æ¢ï¼š</p>
<ul>
<li>å¯ç”¨æ—¶ç”¨è‡ªå®šä¹‰åˆ†é…å™¨</li>
<li>å¦åˆ™å›é€€ä¸ºæ ‡å‡† malloc&#x2F;free</li>
</ul>
<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ¬å†…å­˜åˆ†é…å™¨çš„è®¾è®¡æ ¸å¿ƒåœ¨äºï¼š</p>
<ul>
<li>é‡‡ç”¨å¤šçº§å›ºå®šå—å†…å­˜æ±  + æ— é”ç®—æ³•ï¼Œé«˜æ•ˆæœåŠ¡äºå°å—é«˜é¢‘åˆ†é… &#x2F; é‡Šæ”¾ï¼›</li>
<li>é€šè¿‡ 128 ä½åŸå­æ“ä½œæˆ– futex ç¡®ä¿å¹¶å‘å®‰å…¨ï¼Œé€‚ç”¨å¤šå¹³å°ï¼›</li>
<li>æä¾› arena ç®¡ç†å’Œç»Ÿè®¡ï¼Œæ–¹ä¾¿è°ƒè¯•ä¸ç»´æŠ¤ï¼›</li>
<li>å…¼å®¹ä¼ ç»Ÿåˆ†é…æ–¹å¼ï¼Œæ˜“äºé›†æˆå’Œåˆ‡æ¢ã€‚</li>
</ul>
<p>è¿™ç§è®¾è®¡éå¸¸é€‚åˆåƒ DMTCP è¿™æ ·å¯¹æ€§èƒ½å’Œå†…å­˜ç®¡ç†æœ‰ç‰¹æ®Šè¦æ±‚çš„ç³»ç»Ÿçº§è½¯ä»¶ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/20/EDA/EAD%E4%BB%BF%E7%9C%9F%E4%B9%8BMemory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/20/EDA/EAD%E4%BB%BF%E7%9C%9F%E4%B9%8BMemory/" class="post-title-link" itemprop="url">EDA ä»¿çœŸä¹‹ Memory</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-20 22:25:49" itemprop="dateCreated datePublished" datetime="2025-08-20T22:25:49+00:00">2025-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/EDA/" itemprop="url" rel="index"><span itemprop="name">EDA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><p>Memory &#x3D; å­˜å‚¨ + è®¿é—®é€»è¾‘</p>
<p>å­˜å‚¨</p>
<ul>
<li>åœ¨ä»¿çœŸé‡Œï¼Œmemory æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆArrayï¼‰æˆ–è€…å‘é‡ï¼ˆVectorï¼‰ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªå­˜å‚¨å•å…ƒï¼ˆbit&#x2F;byte&#x2F;wordï¼‰ã€‚</li>
<li>ä¾‹ï¼šä¸€ä¸ª 8 ä½ Ã— 1024 æ·±åº¦çš„ RAMï¼Œå¯ä»¥åœ¨ä»¿çœŸé‡Œç”¨ <code>uint8_t mem[1024];</code> è¡¨ç¤ºã€‚</li>
</ul>
<p>è®¿é—®é€»è¾‘</p>
<ul>
<li>è¯»ï¼ˆReadï¼‰ï¼šæ ¹æ®åœ°å€è¿”å›å¯¹åº”çš„æ•°æ®ã€‚</li>
<li>å†™ï¼ˆWriteï¼‰ï¼šæ ¹æ®åœ°å€å’Œå†™ä½¿èƒ½ä¿¡å·ï¼Œå°†æ•°æ®å†™å…¥å­˜å‚¨å•å…ƒã€‚</li>
<li>å¯èƒ½æ¶‰åŠ æ—¶åºï¼šåŒæ­¥ï¼ˆclock è¾¹æ²¿å†™å…¥ï¼‰æˆ–å¼‚æ­¥ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰ã€‚</li>
</ul>
<p>æ—¶åºå’Œå»¶è¿Ÿ</p>
<ul>
<li>åœ¨ç¡¬ä»¶é‡Œï¼Œmemory è®¿é—®ä¸æ˜¯ç¬é—´çš„ï¼šå­˜åœ¨ è¯»å»¶è¿Ÿã€å†™å»¶è¿Ÿã€‚</li>
<li>ä»¿çœŸæ—¶ï¼Œå¯ä»¥ç”¨ å»¶æ—¶äº‹ä»¶ æˆ– clock è¾¹æ²¿è§¦å‘ æ¥æ¨¡æ‹Ÿã€‚</li>
</ul>
<h2 id="ä»¿çœŸä»£ç "><a href="#ä»¿çœŸä»£ç " class="headerlink" title="ä»¿çœŸä»£ç "></a>ä»¿çœŸä»£ç </h2><p>åŠŸèƒ½è¯´æ˜</p>
<ul>
<li>å¤šç«¯å£è¯»å†™ï¼šæ”¯æŒåŒæ—¶å¤šä¸ªç«¯å£è®¿é—® memory</li>
<li>å†™å†²çªä»²è£ï¼šå†™ä¼˜å…ˆç­–ç•¥æˆ–å»¶è¿Ÿå†™ï¼Œå¯æ‰©å±•è¯»ä¼˜å…ˆ &#x2F; è½®è¯¢</li>
<li>è¯»å»¶è¿Ÿ pipelineï¼šå»¶è¿Ÿç”± read_delay æ§åˆ¶</li>
<li>Burst &#x2F; wrap-aroundï¼šè®¿é—®è¶…å‡ºæœ«å°¾è‡ªåŠ¨å›ç»•</li>
<li>ç®€å• Cache&#x2F;Tagï¼šæ¨¡æ‹Ÿå‘½ä¸­ &#x2F; æœªå‘½ä¸­</li>
<li>å¼‚æ­¥ç«¯å£ï¼šä¸åŒç«¯å£è°ƒç”¨ read&#x2F;write å¯åœ¨ä¸åŒ tickï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ—¶é’Ÿ</li>
<li>éšæœº bit flip &#x2F; SEUï¼š1% æ¦‚ç‡é”™è¯¯æ³¨å…¥</li>
<li>ç»Ÿè®¡ä¸åŠŸè€—ä¼°ç®—åŸºç¡€ï¼šè®°å½•è¯»å†™æ¬¡æ•°ã€å‘½ä¸­æ•°ã€å¹³å‡å»¶è¿Ÿ</li>
</ul>
<figure class="highlight cpp"><figcaption><span>EdaMemoryFull.cpp</span><a href="/blog/downloads/code/eda/memory/EdaMemoryFull.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;random&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Event</span> {</span><br><span class="line">    <span class="type">int</span> time;</span><br><span class="line">    std::function&lt;<span class="type">void</span>()&gt; action;</span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> Event&amp; other) <span class="type">const</span> { <span class="keyword">return</span> time &gt; other.time; }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EdaMemoryFull</span> {</span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; mem;</span><br><span class="line">    std::priority_queue&lt;Event&gt; event_queue;</span><br><span class="line">    <span class="type">int</span> sim_time = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> read_delay;</span><br><span class="line">    std::mt19937 gen;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> cache_size;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">CacheLine</span> { <span class="type">bool</span> valid=<span class="literal">false</span>; <span class="type">int</span> tag=<span class="number">-1</span>; };</span><br><span class="line">    std::vector&lt;CacheLine&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> max_bus_access_per_cycle = <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> current_cycle_access = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">    std::map&lt;<span class="type">int</span>,<span class="type">int</span>&gt; read_count, write_count, read_hits, write_hits;</span><br><span class="line">    std::map&lt;<span class="type">int</span>,<span class="type">int</span>&gt; read_delay_total;</span><br><span class="line">    <span class="type">int</span> dynamic_power = <span class="number">0</span>; <span class="comment">// åŠ¨æ€åŠŸè€—</span></span><br><span class="line">    <span class="type">int</span> static_power; <span class="comment">// é™æ€åŠŸè€—</span></span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; dynamic_power_per_cycle; <span class="comment">// æ¯å‘¨æœŸåŠ¨æ€åŠŸè€—</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ¨æ€åŠŸè€—å…¬å¼ï¼ˆå•ä½ï¼šåŠ¨æ€åŠŸè€—å•ä½ = æ¯bitåˆ‡æ¢ä¸€æ¬¡ç®—1ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// P_dyn = Î± * C * V^2 * f</span></span><br><span class="line">    <span class="comment">// å…¶ä¸­ï¼ŒÎ± å¼€å…³æ´»åŠ¨å› å­ï¼ˆswitching activityï¼‰</span></span><br><span class="line">    <span class="comment">//      C è´Ÿè½½ç”µå®¹</span></span><br><span class="line">    <span class="comment">//      V ç”µæºç”µå‹</span></span><br><span class="line">    <span class="comment">//      f æ—¶é’Ÿé¢‘ç‡</span></span><br><span class="line">    <span class="comment">// ç®€åŒ–ä¸ºæ¯æ¬¡ bit æ”¹å˜å¢åŠ ä¸€ä¸ªå•ä½åŠ¨æ€åŠŸè€—</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// é™æ€åŠŸè€—å…¬å¼ï¼ˆå•ä½ï¼šé™æ€åŠŸè€—å•ä½ = æ¯8bitå­˜å‚¨å•å…ƒç®—1ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// P_static = I_leak * V * N</span></span><br><span class="line">    <span class="comment">// ç®€åŒ–ä¸ºæ¯8bitå­˜å‚¨å•å…ƒå¢åŠ 1å•ä½é™æ€åŠŸè€—</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ€»åŠŸè€—</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// P_total = P_dyn + P_static</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">WritePriority</span> { WRITE_FIRST, READ_FIRST, ROUND_ROBIN } write_prio;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">EdaMemoryFull</span>(<span class="type">size_t</span> size, <span class="type">int</span> delay, <span class="type">int</span> c_size, WritePriority prio=WRITE_FIRST)</span><br><span class="line">        : <span class="built_in">mem</span>(size,<span class="number">0</span>), <span class="built_in">read_delay</span>(delay), <span class="built_in">gen</span>(std::random_device{}()), </span><br><span class="line">          <span class="built_in">cache_size</span>(c_size), <span class="built_in">cache</span>(c_size), <span class="built_in">static_power</span>(size/<span class="number">8</span>), <span class="built_in">write_prio</span>(prio)</span><br><span class="line">    {</span><br><span class="line">        std::uniform_int_distribution&lt;&gt; <span class="built_in">dis</span>(<span class="number">0</span>,<span class="number">255</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;v: mem) v = <span class="built_in">dis</span>(gen);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int</span> port,<span class="type">int</span> addr,<span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; data)</span></span>{</span><br><span class="line">        write_count[port]++;</span><br><span class="line">        <span class="keyword">if</span>(current_cycle_access&gt;=max_bus_access_per_cycle){</span><br><span class="line">            event_queue.<span class="built_in">push</span>({sim_time+<span class="number">1</span>,[<span class="keyword">this</span>,port,addr,data](){ <span class="built_in">write</span>(port,addr,data); }});</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        current_cycle_access++;</span><br><span class="line">        <span class="keyword">if</span>(write_prio==WRITE_FIRST){</span><br><span class="line">            <span class="built_in">apply_write</span>(addr,data);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            event_queue.<span class="built_in">push</span>({sim_time+<span class="number">1</span>,[<span class="keyword">this</span>,addr,data](){ <span class="built_in">apply_write</span>(addr,data); }});</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">update_cache</span>(port, addr,data,<span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">read</span><span class="params">(<span class="type">int</span> port,<span class="type">int</span> addr,<span class="type">size_t</span> length,std::function&lt;<span class="type">void</span>(std::vector&lt;<span class="type">uint8_t</span>&gt;)&gt; callback)</span></span>{</span><br><span class="line">        read_count[port]++;</span><br><span class="line">        <span class="keyword">if</span>(current_cycle_access&gt;=max_bus_access_per_cycle){</span><br><span class="line">            event_queue.<span class="built_in">push</span>({sim_time+<span class="number">1</span>,[<span class="keyword">this</span>,port,addr,length,callback](){ <span class="built_in">read</span>(port,addr,length,callback); }});</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        current_cycle_access++;</span><br><span class="line">        <span class="type">int</span> trigger_time = sim_time+read_delay;</span><br><span class="line">        <span class="type">bool</span> hit = <span class="built_in">check_cache</span>(port, addr,length);</span><br><span class="line">        <span class="keyword">if</span>(hit) read_hits[port]++;</span><br><span class="line">        event_queue.<span class="built_in">push</span>({trigger_time,[<span class="keyword">this</span>,addr,length,callback,port,trigger_time]() {</span><br><span class="line">            std::vector&lt;<span class="type">uint8_t</span>&gt; data;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">size_t</span> i=<span class="number">0</span>;i&lt;length;i++){</span><br><span class="line">                <span class="type">uint8_t</span> val = mem[(addr+i)%mem.<span class="built_in">size</span>()];</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">random_bit_flip</span>()) val ^= (<span class="number">1</span>&lt;&lt;(<span class="built_in">gen</span>()%<span class="number">8</span>));</span><br><span class="line">                dynamic_power += <span class="built_in">count_bit_changes</span>(val, mem[(addr+i)%mem.<span class="built_in">size</span>()]);</span><br><span class="line">                data.<span class="built_in">push_back</span>(val);</span><br><span class="line">            }</span><br><span class="line">            read_delay_total[port] += (trigger_time - sim_time);</span><br><span class="line">            <span class="built_in">callback</span>(data);</span><br><span class="line">        }});</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">tick</span><span class="params">()</span></span>{</span><br><span class="line">        sim_time++;</span><br><span class="line">        current_cycle_access = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> cycle_dyn_power = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(!event_queue.<span class="built_in">empty</span>() &amp;&amp; event_queue.<span class="built_in">top</span>().time &lt;= sim_time){</span><br><span class="line">            <span class="keyword">auto</span> e = event_queue.<span class="built_in">top</span>(); event_queue.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="type">int</span> before = dynamic_power;</span><br><span class="line">            e.<span class="built_in">action</span>();</span><br><span class="line">            cycle_dyn_power += (dynamic_power - before);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        dynamic_power_per_cycle.<span class="built_in">push_back</span>(cycle_dyn_power);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ASCII å¯è§†åŒ–æ¯å‘¨æœŸåŠ¨æ€åŠŸè€—</span></span><br><span class="line">        <span class="type">int</span> scale = <span class="number">50</span>;</span><br><span class="line">        <span class="type">int</span> bar_len = *std::<span class="built_in">max_element</span>(dynamic_power_per_cycle.<span class="built_in">begin</span>(), dynamic_power_per_cycle.<span class="built_in">end</span>())&gt;<span class="number">0</span> ?</span><br><span class="line">                      cycle_dyn_power*scale/(*std::<span class="built_in">max_element</span>(dynamic_power_per_cycle.<span class="built_in">begin</span>(), dynamic_power_per_cycle.<span class="built_in">end</span>())) : <span class="number">0</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Cycle &quot;</span> &lt;&lt; sim_time &lt;&lt; <span class="string">&quot; dyn power: &quot;</span> &lt;&lt; cycle_dyn_power</span><br><span class="line">                  &lt;&lt; <span class="string">&quot; total power: &quot;</span> &lt;&lt; dynamic_power + static_power &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;bar_len;i++) std::cout&lt;&lt;<span class="string">&quot;#&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print_stats</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;Simulation stats:\n&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; [port,cnt]: read_count)</span><br><span class="line">            std::cout&lt;&lt;<span class="string">&quot;Port &quot;</span>&lt;&lt;port&lt;&lt;<span class="string">&quot; read count: &quot;</span>&lt;&lt;cnt</span><br><span class="line">                     &lt;&lt;<span class="string">&quot;, hits: &quot;</span>&lt;&lt;read_hits.<span class="built_in">at</span>(port)</span><br><span class="line">                     &lt;&lt;<span class="string">&quot;, avg delay: &quot;</span>&lt;&lt;(cnt?read_delay_total.<span class="built_in">at</span>(port)/cnt:<span class="number">0</span>)&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; [port,cnt]: write_count)</span><br><span class="line">            std::cout&lt;&lt;<span class="string">&quot;Port &quot;</span>&lt;&lt;port&lt;&lt;<span class="string">&quot; write count: &quot;</span>&lt;&lt;cnt</span><br><span class="line">                     &lt;&lt;<span class="string">&quot;, hits: &quot;</span>&lt;&lt;write_hits.<span class="built_in">at</span>(port)&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;Dynamic power units: &quot;</span>&lt;&lt;dynamic_power&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;Static power units: &quot;</span>&lt;&lt;static_power&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;Total power units: &quot;</span>&lt;&lt;dynamic_power + static_power&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">export_power_csv</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span> <span class="type">const</span> </span>{</span><br><span class="line">        <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(filename)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(!ofs.<span class="built_in">is_open</span>()) {</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Failed to open file: &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        ofs &lt;&lt; <span class="string">&quot;Cycle,DynamicPower,StaticPower,TotalPower\n&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">size_t</span> i=<span class="number">0</span>;i&lt;dynamic_power_per_cycle.<span class="built_in">size</span>();i++){</span><br><span class="line">            <span class="type">int</span> dyn = dynamic_power_per_cycle[i];</span><br><span class="line">            <span class="type">int</span> total = dyn + static_power;</span><br><span class="line">            ofs &lt;&lt; (i+<span class="number">1</span>) &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; dyn &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; static_power &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; total &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        }</span><br><span class="line">        ofs.<span class="built_in">close</span>();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Power data exported to &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">random_bit_flip</span><span class="params">()</span></span>{</span><br><span class="line">        std::uniform_real_distribution&lt;&gt; <span class="built_in">dis</span>(<span class="number">0.0</span>,<span class="number">1.0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dis</span>(gen)&lt;<span class="number">0.01</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">count_bit_changes</span><span class="params">(<span class="type">uint8_t</span> a,<span class="type">uint8_t</span> b)</span></span>{</span><br><span class="line">        <span class="type">uint8_t</span> diff = a^b;</span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(diff){ count+=diff&amp;<span class="number">1</span>; diff&gt;&gt;=<span class="number">1</span>; }</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">check_cache</span><span class="params">(<span class="type">int</span> port, <span class="type">int</span> addr,<span class="type">size_t</span> length)</span></span>{</span><br><span class="line">        <span class="type">int</span> line = addr % cache_size;</span><br><span class="line">        <span class="type">int</span> tag = addr / cache_size;</span><br><span class="line">        <span class="keyword">return</span> cache[line].valid &amp;&amp; cache[line].tag==tag;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update_cache</span><span class="params">(<span class="type">int</span> port, <span class="type">int</span> addr,<span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; data,<span class="type">bool</span> write=<span class="literal">false</span>)</span></span>{</span><br><span class="line">        <span class="type">int</span> line = addr % cache_size;</span><br><span class="line">        <span class="type">int</span> tag = addr / cache_size;</span><br><span class="line">        cache[line].valid=<span class="literal">true</span>;</span><br><span class="line">        cache[line].tag=tag;</span><br><span class="line">        <span class="keyword">if</span>(write) write_hits[port]++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">apply_write</span><span class="params">(<span class="type">int</span> addr,<span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; data)</span></span>{</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">size_t</span> i=<span class="number">0</span>;i&lt;data.<span class="built_in">size</span>();i++) mem[(addr+i)%mem.<span class="built_in">size</span>()]=data[i];</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¤ºä¾‹ä¸»ç¨‹åº</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="function">EdaMemoryFull <span class="title">mem</span><span class="params">(<span class="number">1024</span>,<span class="number">2</span>,<span class="number">16</span>,EdaMemoryFull::WRITE_FIRST)</span></span>;</span><br><span class="line"></span><br><span class="line">    mem.<span class="built_in">write</span>(<span class="number">0</span>,<span class="number">10</span>,{<span class="number">42</span>,<span class="number">43</span>,<span class="number">44</span>});</span><br><span class="line">    mem.<span class="built_in">write</span>(<span class="number">1</span>,<span class="number">11</span>,{<span class="number">99</span>});</span><br><span class="line">    mem.<span class="built_in">read</span>(<span class="number">0</span>,<span class="number">10</span>,<span class="number">3</span>,[](std::vector&lt;<span class="type">uint8_t</span>&gt; data){</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;Port0 read burst: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> v:data) std::cout&lt;&lt;(<span class="type">int</span>)v&lt;&lt;<span class="string">&quot; &quot;</span>;</span><br><span class="line">        std::cout&lt;&lt;std::endl;</span><br><span class="line">    });</span><br><span class="line">    mem.<span class="built_in">read</span>(<span class="number">1</span>,<span class="number">11</span>,<span class="number">1</span>,[](std::vector&lt;<span class="type">uint8_t</span>&gt; data){</span><br><span class="line">        std::cout&lt;&lt;<span class="string">&quot;Port1 read: &quot;</span>&lt;&lt;(<span class="type">int</span>)data[<span class="number">0</span>]&lt;&lt;std::endl;</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) mem.<span class="built_in">tick</span>();</span><br><span class="line">    <span class="comment">// å¯¼å‡ºåŠŸè€—æ•°æ®</span></span><br><span class="line">    mem.<span class="built_in">export_power_csv</span>(<span class="string">&quot;memory_power.csv&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mem.<span class="built_in">print_stats</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºçš„ memory_power.csv æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Cycle,DynamicPower,StaticPower,TotalPower</span><br><span class="line">1,3,128,131</span><br><span class="line">2,0,128,128</span><br><span class="line">3,5,128,133</span><br><span class="line">4,2,128,130</span><br><span class="line">5,7,128,135</span><br><span class="line">6,1,128,129</span><br><span class="line">7,4,128,132</span><br><span class="line">8,0,128,128</span><br><span class="line">9,2,128,130</span><br><span class="line">10,3,128,131</span><br></pre></td></tr></table></figure>

<p>æ¯åˆ—å«ä¹‰ï¼š</p>
<ul>
<li>Cycleï¼šå‘¨æœŸå·</li>
<li>DynamicPowerï¼šæ¯å‘¨æœŸåŠ¨æ€åŠŸè€—å•ä½</li>
<li>StaticPowerï¼šé™æ€åŠŸè€—å•ä½ï¼ˆå›ºå®šï¼‰</li>
<li>TotalPowerï¼šæ€»åŠŸè€—å•ä½</li>
</ul>
<p>åŠŸè€—åˆ†æ</p>
<figure class="highlight python"><figcaption><span>report_power.py</span><a href="/blog/downloads/code/eda/memory/report_power.py">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å– CSV</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;memory_power.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¾åˆ°åŠ¨æ€åŠŸè€—å³°å€¼å‘¨æœŸ</span></span><br><span class="line">peak_cycle = df[<span class="string">&#x27;DynamicPower&#x27;</span>].idxmax() + <span class="number">1</span></span><br><span class="line">peak_value = df[<span class="string">&#x27;DynamicPower&#x27;</span>].<span class="built_in">max</span>()</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>,<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜åˆ¶æ¡å½¢èƒŒæ™¯ï¼ˆASCIIé£æ ¼æ•ˆæœï¼‰</span></span><br><span class="line"><span class="keyword">for</span> i, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(df[<span class="string">&#x27;DynamicPower&#x27;</span>]):</span><br><span class="line">    bar_len = <span class="built_in">int</span>(val / peak_value * <span class="number">50</span>)  <span class="comment"># 50å­—ç¬¦æœ€å¤§é•¿åº¦</span></span><br><span class="line">    plt.text(i+<span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;#&#x27;</span> * bar_len, fontsize=<span class="number">8</span>, color=<span class="string">&#x27;grey&#x27;</span>, va=<span class="string">&#x27;bottom&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜åˆ¶æ›²çº¿</span></span><br><span class="line">plt.plot(df[<span class="string">&#x27;Cycle&#x27;</span>], df[<span class="string">&#x27;DynamicPower&#x27;</span>], label=<span class="string">&#x27;Dynamic Power&#x27;</span>, marker=<span class="string">&#x27;o&#x27;</span>, color=<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line">plt.plot(df[<span class="string">&#x27;Cycle&#x27;</span>], df[<span class="string">&#x27;StaticPower&#x27;</span>], label=<span class="string">&#x27;Static Power&#x27;</span>, linestyle=<span class="string">&#x27;--&#x27;</span>, color=<span class="string">&#x27;orange&#x27;</span>)</span><br><span class="line">plt.plot(df[<span class="string">&#x27;Cycle&#x27;</span>], df[<span class="string">&#x27;TotalPower&#x27;</span>], label=<span class="string">&#x27;Total Power&#x27;</span>, linestyle=<span class="string">&#x27;-.&#x27;</span>, color=<span class="string">&#x27;green&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é«˜äº®å³°å€¼</span></span><br><span class="line">plt.scatter(peak_cycle, peak_value, color=<span class="string">&#x27;red&#x27;</span>, s=<span class="number">100</span>, label=<span class="string">&#x27;Peak Dynamic Power&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;Memory Power Simulation with Peak Highlight &amp; ASCII-style Bars&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Cycle&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Power Units&#x27;</span>)</span><br><span class="line">plt.grid(<span class="literal">True</span>, linestyle=<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<h3 id="burst-multi-port-æ€»çº¿å†²çª"><a href="#burst-multi-port-æ€»çº¿å†²çª" class="headerlink" title="burst&#x2F;multi-port æ€»çº¿å†²çª"></a>burst&#x2F;multi-port æ€»çº¿å†²çª</h3><p>åœ¨å¤šç«¯å£ç³»ç»Ÿä¸­ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨æ€»çº¿ç»“æ„çš„ç³»ç»Ÿä¸­ï¼Œæ€»çº¿å†²çªï¼ˆBus contentionï¼‰æ˜¯ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ã€‚æ€»çº¿å†²çªé€šå¸¸å‘ç”Ÿåœ¨å¤šä¸ªè®¾å¤‡å°è¯•åŒæ—¶è®¿é—®æ€»çº¿ä¸Šçš„åŒä¸€èµ„æºæ—¶ã€‚è¿™ç§æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´æ•°æ®æŸåã€ç³»ç»Ÿæ€§èƒ½ä¸‹é™æˆ–ç”šè‡³ç³»ç»Ÿå´©æºƒã€‚ä¸‹é¢æ˜¯ä¸€äº›è§£å†³å’Œç¼“è§£æ€»çº¿å†²çªçš„ç­–ç•¥ï¼š</p>
<ol>
<li>ä»²è£æœºåˆ¶<br>ä»²è£æ˜¯è§£å†³æ€»çº¿å†²çªçš„ä¸€ç§å¸¸ç”¨æ–¹æ³•ã€‚å®ƒé€šè¿‡ä¸€ä¸ªä»²è£å™¨ï¼ˆArbiterï¼‰æ¥å†³å®šå“ªä¸ªè®¾å¤‡å¯ä»¥è®¿é—®æ€»çº¿ã€‚å¸¸è§çš„ä»²è£ç­–ç•¥æœ‰ï¼š</li>
</ol>
<p>ä¼˜å…ˆçº§ä»²è£ï¼šæ ¹æ®é¢„å…ˆè®¾å®šçš„ä¼˜å…ˆçº§é¡ºåºå†³å®šå“ªä¸ªè®¾å¤‡å¯ä»¥è®¿é—®æ€»çº¿ã€‚</p>
<p>è½®è¯¢ä»²è£ï¼šè½®æµè®©æ¯ä¸ªè®¾å¤‡è®¿é—®æ€»çº¿ã€‚</p>
<p>åŸºäºè¯·æ±‚çš„ä»²è£ï¼ˆå¦‚è¯·æ±‚å…±äº«ï¼ˆRequest-for-Shared, RFSï¼‰å’Œè¯·æ±‚ç‹¬å ï¼ˆRequest-for-Exclusive, RFEï¼‰ï¼‰ï¼šè®¾å¤‡é¦–å…ˆè¯·æ±‚å¯¹èµ„æºçš„è®¿é—®ï¼Œç„¶åæ ¹æ®è¯·æ±‚çš„ç±»å‹ï¼ˆå…±äº«æˆ–ç‹¬å ï¼‰æ¥å†³å®šè®¿é—®æƒé™ã€‚</p>
<ol start="2">
<li><p>åˆ†æ—¶å¤ç”¨<br>é€šè¿‡æ—¶é—´åˆ†å‰²ï¼ˆTime Division Multiplexing, TDMï¼‰æˆ–é¢‘ç‡åˆ†å‰²ï¼ˆFrequency Division Multiplexing, FDMï¼‰ï¼Œå¯ä»¥å…è®¸å¤šä¸ªè®¾å¤‡åœ¨ä¸åŒçš„æ—¶é—´æˆ–é¢‘ç‡ä¸Šä½¿ç”¨æ€»çº¿ï¼Œä»è€Œå‡å°‘å†²çªã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨æ—¶åˆ†å¤šè·¯å¤ç”¨å°†æ€»çº¿çš„ä¸åŒæ—¶é—´æ®µåˆ†é…ç»™ä¸åŒçš„è®¾å¤‡ã€‚</p>
</li>
<li><p>ç¼–ç å’Œè§£ç æŠ€æœ¯<br>ä½¿ç”¨ç‰¹æ®Šçš„ç¼–ç å’Œè§£ç æŠ€æœ¯ï¼Œå¦‚éœçº³ç¼–ç ï¼ˆHornar codeï¼‰æˆ–æ ¼é›·ç ï¼ˆGray codeï¼‰ï¼Œå¯ä»¥å‡å°‘åœ¨æ€»çº¿ä¸Šä¼ è¾“æ•°æ®æ—¶çš„é”™è¯¯ï¼Œå¹¶å¸®åŠ©æ£€æµ‹å’Œçº æ­£æ•°æ®å†²çªã€‚</p>
</li>
<li><p>æ€»çº¿é”å®š<br>åœ¨è®¿é—®æ€»çº¿æœŸé—´ï¼Œé€šè¿‡æ€»çº¿é”å®šæœºåˆ¶ç¡®ä¿æ²¡æœ‰å…¶ä»–è®¾å¤‡å¯ä»¥è®¿é—®æ€»çº¿ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨æ€»çº¿ä¸Šè®¾ç½®ä¸€ä¸ªé”å®šä¿¡å·æ¥å®ç°ï¼Œè¯¥ä¿¡å·åœ¨è®¿é—®æœŸé—´ä¿æŒæ¿€æ´»çŠ¶æ€ã€‚</p>
</li>
<li><p>ç¼“å­˜å’Œç¼“å†²<br>ä¸ºæ¯ä¸ªè®¾å¤‡æä¾›å±€éƒ¨ç¼“å­˜æˆ–ç¼“å†²æœºåˆ¶ï¼Œå¯ä»¥å‡å°‘å¯¹æ€»çº¿çš„ç›´æ¥è®¿é—®æ¬¡æ•°ï¼Œä»è€Œé™ä½å†²çªçš„å¯èƒ½æ€§ã€‚å½“ä¸€ä¸ªè®¾å¤‡éœ€è¦ä¸æ€»çº¿ä¸Šçš„å¦ä¸€ä¸ªè®¾å¤‡é€šä¿¡æ—¶ï¼Œå®ƒå¯ä»¥å…ˆå°†æ•°æ®å†™å…¥è‡ªå·±çš„ç¼“å­˜ï¼Œç„¶åå†ç”±ç¼“å­˜åŒæ­¥åˆ°æ€»çº¿ä¸Šã€‚</p>
</li>
<li><p>ä½¿ç”¨æ›´å®½çš„æ€»çº¿<br>å¢åŠ æ€»çº¿çš„å®½åº¦å¯ä»¥å…è®¸åœ¨åŒä¸€æ—¶é—´å†…ä¼ è¾“æ›´å¤šçš„æ•°æ®ï¼Œä»è€Œå‡å°‘å¯¹æ€»çº¿çš„éœ€æ±‚ï¼Œé™ä½å†²çªçš„å¯èƒ½æ€§ã€‚</p>
</li>
</ol>
<p>å®æ–½æ­¥éª¤<br>è¯„ä¼°ç³»ç»Ÿéœ€æ±‚ï¼šç¡®å®šå“ªäº›ç±»å‹çš„è®¾å¤‡å°†ä½¿ç”¨æ€»çº¿ï¼Œä»¥åŠå®ƒä»¬å¯¹å¸¦å®½çš„éœ€æ±‚ã€‚</p>
<p>é€‰æ‹©ä»²è£ç­–ç•¥ï¼šæ ¹æ®è®¾å¤‡çš„ä¼˜å…ˆçº§å’Œå¸¦å®½éœ€æ±‚é€‰æ‹©åˆé€‚çš„ä»²è£ç­–ç•¥ã€‚</p>
<p>è®¾è®¡ç¡¬ä»¶ï¼šæ ¹æ®é€‰å®šçš„ç­–ç•¥è®¾è®¡ç¡¬ä»¶ï¼ŒåŒ…æ‹¬æ·»åŠ ä»²è£å™¨ã€ç¼“å­˜å’Œé€‚å½“çš„æ§åˆ¶é€»è¾‘ã€‚</p>
<p>æµ‹è¯•å’Œä¼˜åŒ–ï¼šå®æ–½åè¿›è¡Œç³»ç»Ÿæµ‹è¯•ï¼Œæ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´ç­–ç•¥æˆ–ç¡¬ä»¶è®¾è®¡ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°æ–¹æ³•ï¼Œå¯ä»¥æœ‰æ•ˆç®¡ç†å’Œå‡å°‘å¤šç«¯å£ç³»ç»Ÿä¸­çš„æ€»çº¿å†²çªé—®é¢˜ï¼Œæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚</p>
<h3 id="Cache-Tagï¼ˆç¼“å­˜æ ‡è®°ï¼‰"><a href="#Cache-Tagï¼ˆç¼“å­˜æ ‡è®°ï¼‰" class="headerlink" title="Cache Tagï¼ˆç¼“å­˜æ ‡è®°ï¼‰"></a>Cache Tagï¼ˆç¼“å­˜æ ‡è®°ï¼‰</h3><p>Cache Tagï¼ˆç¼“å­˜æ ‡è®°ï¼‰æ˜¯é«˜é€Ÿç¼“å­˜ï¼ˆCacheï¼‰ä¸­çš„å…³é”®ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºå­˜å‚¨æ•°æ®åœ¨ä¸»å­˜ä¸­çš„åœ°å€ä¿¡æ¯ï¼Œä»¥ä¾¿å¿«é€Ÿå®šä½æ•°æ®ä½ç½®ã€‚ â€Œ</p>
<p>æ ¸å¿ƒåŠŸèƒ½<br>Tagå­—æ®µå­˜å‚¨äº†ä¸»å­˜ä¸­æ•°æ®çš„åœ°å€ä¿¡æ¯ï¼Œå½“CPUè®¿é—®ä¸»å­˜æ—¶ï¼Œé¦–å…ˆé€šè¿‡Tagå­—æ®µåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨äºCacheä¸­ã€‚è‹¥å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä»Cacheè¯»å–ï¼›è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è®¿é—®ä¸»å­˜ã€‚ â€Œ</p>
<p>ç»“æ„ç»„æˆ</p>
<ul>
<li>â€ŒTagâ€Œï¼šè®°å½•æ•°æ®åœ¨ä¸»å­˜çš„åœ°å€ä¿¡æ¯ã€‚</li>
<li>â€ŒDataâ€Œï¼šå­˜å‚¨å®é™…æ•°æ®ã€‚</li>
<li>â€ŒValid Bitâ€Œï¼šæ ‡è®°æ•°æ®æ˜¯å¦æœ‰æ•ˆã€‚</li>
<li>â€ŒDirâ€Œï¼šç›®å½•ä¿¡æ¯ï¼Œç”¨äºåŒºåˆ†ä¸åŒæ•°æ®å—ã€‚ â€Œ</li>
</ul>
<p>åº”ç”¨åœºæ™¯</p>
<p>ç°ä»£å¤„ç†å™¨é€šå¸¸é‡‡ç”¨å¤šçº§Cacheç»“æ„ï¼ˆå¦‚L1ã€L2ã€L3ï¼‰ï¼Œå…¶ä¸­Tagä¸Dataå…±åŒæ„æˆCache Lineï¼Œç”¨äºå¿«é€Ÿè®¿é—®å’Œå­˜å‚¨æ•°æ®ã€‚ä¾‹å¦‚ï¼ŒARMv8-Aæ¶æ„çš„å¤„ç†å™¨åŒ…å«ç‹¬ç«‹çš„I-Cacheå’ŒD-Cacheï¼Œåˆ†åˆ«å­˜å‚¨æŒ‡ä»¤å’Œæ•°æ®ã€‚</p>
<p>Cache Tag ä»¿çœŸä»£ç </p>
<blockquote>
<p>FIXME: è¯¥ä»£ç ä¼š coredump ã€‚</p>
</blockquote>
<figure class="highlight cpp"><figcaption><span>cache_simulator.h</span><a href="/blog/downloads/code/eda/memory/cache/cache_simulator.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CACHE_SIMULATOR_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CACHE_SIMULATOR_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼“å­˜è¡Œç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CacheLine</span> {</span><br><span class="line">    <span class="type">bool</span> valid = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> dirty = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">uint32_t</span> tag = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint64_t</span> last_used = <span class="number">0</span>; <span class="comment">// ç”¨äºLRUæ›¿æ¢ç­–ç•¥</span></span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; data;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç«¯å£è®¿é—®è¯·æ±‚ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PortRequest</span> {</span><br><span class="line">    <span class="type">uint32_t</span> port_id;</span><br><span class="line">    <span class="type">bool</span> is_write;</span><br><span class="line">    <span class="type">uint32_t</span> addr;</span><br><span class="line">    <span class="type">uint8_t</span>* data_ptr;</span><br><span class="line">    <span class="type">size_t</span> data_size;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheSimulator</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CacheSimulator</span>(<span class="type">uint32_t</span> line_size, <span class="type">uint32_t</span> num_lines, <span class="type">uint32_t</span> num_ports);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤šç«¯å£è®¿é—®æ¥å£</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">process_request</span><span class="params">(<span class="type">const</span> PortRequest&amp; req)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¼“å­˜é…ç½®</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_write_policy</span><span class="params">(<span class="type">bool</span> write_back)</span></span>; </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_replacement_policy</span><span class="params">(<span class="type">int</span> policy)</span></span>; <span class="comment">// 0:LRU, 1:FIFO, 2:Random</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// å†…éƒ¨ç¼“å­˜æ“ä½œ</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">access_cache</span><span class="params">(<span class="type">uint32_t</span> port_id, <span class="type">uint32_t</span> addr, <span class="type">bool</span> is_write, <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handle_miss</span><span class="params">(<span class="type">uint32_t</span> port_id, <span class="type">uint32_t</span> addr)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">evict_line</span><span class="params">(<span class="type">uint32_t</span> set_idx, <span class="type">uint32_t</span> way_idx)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤šç«¯å£åŒæ­¥</span></span><br><span class="line">    std::atomic&lt;<span class="type">uint64_t</span>&gt; global_counter_{<span class="number">0</span>}; <span class="comment">// åŸå­è®¡æ•°å™¨</span></span><br><span class="line">    std::vector&lt;std::mutex&gt; port_locks_;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¼“å­˜ç»“æ„</span></span><br><span class="line">    <span class="type">uint32_t</span> line_size_;</span><br><span class="line">    <span class="type">uint32_t</span> num_sets_;</span><br><span class="line">    std::vector&lt;std::vector&lt;CacheLine&gt;&gt; cache_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­–ç•¥é…ç½®</span></span><br><span class="line">    <span class="type">bool</span> write_back_;</span><br><span class="line">    <span class="type">int</span> replacement_policy_;</span><br><span class="line">};</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>cache_simulator.cpp</span><a href="/blog/downloads/code/eda/memory/cache/cache_simulator.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cache_simulator.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;random&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line">CacheSimulator::<span class="built_in">CacheSimulator</span>(<span class="type">uint32_t</span> line_size, <span class="type">uint32_t</span> num_lines, <span class="type">uint32_t</span> num_ports) </span><br><span class="line">    : <span class="built_in">port_locks_</span>(num_ports), <span class="built_in">line_size_</span>(line_size) {</span><br><span class="line">    num_sets_ = num_lines; <span class="comment">// ç®€å•å®ç°ï¼Œå¯æ‰©å±•ä¸ºç»„ç›¸è”</span></span><br><span class="line">    cache_.<span class="built_in">resize</span>(num_sets_, std::<span class="built_in">vector</span>&lt;CacheLine&gt;(<span class="number">1</span>)); <span class="comment">// ç›´æ¥æ˜ å°„</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CacheSimulator::process_request</span><span class="params">(<span class="type">const</span> PortRequest&amp; req)</span> </span>{</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(port_locks_[req.port_id])</span></span>;</span><br><span class="line">    <span class="built_in">access_cache</span>(req.port_id, req.addr, req.is_write, req.data_ptr, req.data_size);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CacheSimulator::access_cache</span><span class="params">(<span class="type">uint32_t</span> port_id, <span class="type">uint32_t</span> addr, <span class="type">bool</span> is_write, </span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size)</span> </span>{</span><br><span class="line">    <span class="type">uint32_t</span> tag = addr / line_size_;</span><br><span class="line">    <span class="type">uint32_t</span> set_idx = tag % num_sets_;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾å‘½ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; line : cache_[set_idx]) {</span><br><span class="line">        <span class="keyword">if</span> (line.valid &amp;&amp; line.tag == tag) {</span><br><span class="line">            line.last_used = ++global_counter_;</span><br><span class="line">            <span class="keyword">if</span> (is_write) {</span><br><span class="line">                <span class="built_in">memcpy</span>(line.data.<span class="built_in">data</span>(), data, size);</span><br><span class="line">                line.dirty = <span class="literal">true</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="built_in">memcpy</span>(data, line.data.<span class="built_in">data</span>(), size);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœªå‘½ä¸­å¤„ç†</span></span><br><span class="line">    <span class="built_in">handle_miss</span>(port_id, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CacheSimulator::handle_miss</span><span class="params">(<span class="type">uint32_t</span> port_id, <span class="type">uint32_t</span> addr)</span> </span>{</span><br><span class="line">    <span class="type">uint32_t</span> tag = addr / line_size_;</span><br><span class="line">    <span class="type">uint32_t</span> set_idx = tag % num_sets_;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾å¯æ›¿æ¢è¡Œ</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; lines = cache_[set_idx];</span><br><span class="line">    <span class="keyword">auto</span> victim = std::<span class="built_in">min_element</span>(lines.<span class="built_in">begin</span>(), lines.<span class="built_in">end</span>(),</span><br><span class="line">        [](<span class="type">const</span> CacheLine&amp; a, <span class="type">const</span> CacheLine&amp; b) {</span><br><span class="line">            <span class="keyword">return</span> a.last_used &lt; b.last_used; <span class="comment">// LRUç­–ç•¥</span></span><br><span class="line">        });</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†™å›è„æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (write_back_ &amp;&amp; victim-&gt;dirty) {</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿå†™å›ä¸»å­˜æ“ä½œ</span></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ è½½æ–°æ•°æ®</span></span><br><span class="line">    victim-&gt;valid = <span class="literal">true</span>;</span><br><span class="line">    victim-&gt;tag = tag;</span><br><span class="line">    victim-&gt;dirty = <span class="literal">false</span>;</span><br><span class="line">    victim-&gt;last_used = ++global_counter_;</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿä»ä¸»å­˜åŠ è½½æ•°æ®</span></span><br><span class="line">    victim-&gt;data.<span class="built_in">resize</span>(line_size_);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>main.cpp</span><a href="/blog/downloads/code/eda/memory/cache/main.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cache_simulator.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">port_thread</span><span class="params">(CacheSimulator&amp; cache, <span class="type">uint32_t</span> port_id)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        PortRequest req;</span><br><span class="line">        req.port_id = port_id;</span><br><span class="line">        req.is_write = (i % <span class="number">3</span> == <span class="number">0</span>);</span><br><span class="line">        req.addr = <span class="built_in">rand</span>() % <span class="number">0xFFFF</span>;</span><br><span class="line">        <span class="type">uint8_t</span> data[<span class="number">64</span>] = {<span class="number">0</span>};</span><br><span class="line">        req.data_ptr = data;</span><br><span class="line">        req.data_size = <span class="built_in">sizeof</span>(data);</span><br><span class="line">        </span><br><span class="line">        cache.<span class="built_in">process_request</span>(req);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">CacheSimulator <span class="title">cache</span><span class="params">(<span class="number">64</span>, <span class="number">1024</span>, <span class="number">4</span>)</span></span>; <span class="comment">// 64Bè¡Œ, 1024è¡Œ, 4ç«¯å£</span></span><br><span class="line">    </span><br><span class="line">    std::vector&lt;std::thread&gt; threads;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) {</span><br><span class="line">        threads.<span class="built_in">emplace_back</span>(port_thread, std::<span class="built_in">ref</span>(cache), i);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : threads) {</span><br><span class="line">        t.<span class="built_in">join</span>();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Cache simulation completed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>Makefile</span><a href="/blog/downloads/code/eda/memory/cache/Makefile">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># ç¼–è¯‘å™¨é…ç½®</span><br><span class="line">CXX := g++</span><br><span class="line">CXXFLAGS := -std=c++<span class="number">17</span> -Wall -Wextra -O3 -pthread</span><br><span class="line">LDFLAGS := -pthread</span><br><span class="line"></span><br><span class="line"># é¡¹ç›®ç»“æ„</span><br><span class="line">SRC_DIR := .</span><br><span class="line">BUILD_DIR := build</span><br><span class="line">TARGET := $(BUILD_DIR)/cache_simulator</span><br><span class="line"></span><br><span class="line"># æºæ–‡ä»¶åˆ—è¡¨</span><br><span class="line">SRCS := $(wildcard $(SRC_DIR)<span class="comment">/*.cpp)</span></span><br><span class="line"><span class="comment">OBJS := $(patsubst $(SRC_DIR)/%.cpp,$(BUILD_DIR)/%.o,$(SRCS))</span></span><br><span class="line"><span class="comment">DEPS := $(OBJS:.o=.d)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># é»˜è®¤ç›®æ ‡</span></span><br><span class="line"><span class="comment">all: $(BUILD_DIR) $(TARGET)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># åˆ›å»ºæ„å»ºç›®å½•</span></span><br><span class="line"><span class="comment">$(BUILD_DIR):</span></span><br><span class="line"><span class="comment">	mkdir -p $(BUILD_DIR)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># ä¸»ç›®æ ‡é“¾æ¥</span></span><br><span class="line"><span class="comment">$(TARGET): $(OBJS)</span></span><br><span class="line"><span class="comment">	$(CXX) $(LDFLAGS) $^ -o $@</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># ç¼–è¯‘è§„åˆ™</span></span><br><span class="line"><span class="comment">$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp</span></span><br><span class="line"><span class="comment">	$(CXX) $(CXXFLAGS) -MMD -c $&lt; -o $@</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># åŒ…å«ä¾èµ–å…³ç³»</span></span><br><span class="line"><span class="comment">-include $(DEPS)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ¸…ç†</span></span><br><span class="line"><span class="comment">clean:</span></span><br><span class="line"><span class="comment">	rm -rf $(BUILD_DIR)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">.PHONY: all clean</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/19/concurrency/TBB%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/19/concurrency/TBB%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF/" class="post-title-link" itemprop="url">TBBå…¸å‹åœºæ™¯</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-19 22:48:38" itemprop="dateCreated datePublished" datetime="2025-08-19T22:48:38+00:00">2025-08-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-15 11:59:20" itemprop="dateModified" datetime="2025-09-15T11:59:20+00:00">2025-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-CPU-å¯†é›†-IO"><a href="#IO-CPU-å¯†é›†-IO" class="headerlink" title="IO + CPU å¯†é›† + IO"></a>IO + CPU å¯†é›† + IO</h2><p>tasks</p>
<figure class="highlight cpp"><figcaption><span>tasks.hpp</span><a href="/blog/downloads/code/tbb/pipeline/tasks.hpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¨¡æ‹Ÿ IO å’Œ CPU ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DataChunk</span> {</span><br><span class="line">    std::vector&lt;<span class="type">char</span>&gt; data;</span><br><span class="line">    <span class="built_in">DataChunk</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">DataChunk</span><span class="params">(<span class="type">size_t</span> size)</span> : data(size) {</span>}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CompressedChunk</span> {</span><br><span class="line">    std::vector&lt;<span class="type">char</span>&gt; data;</span><br><span class="line">    <span class="built_in">CompressedChunk</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">CompressedChunk</span><span class="params">(<span class="type">size_t</span> size)</span> : data(size) {</span>}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿæ•°æ®è¯»å–å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">read_from_network</span><span class="params">(DataChunk&amp; chunk)</span> </span>{</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">3</span>);  <span class="comment">// æ¨¡æ‹Ÿ IO å»¶è¿Ÿ</span></span><br><span class="line"></span><br><span class="line">    chunk.data.<span class="built_in">resize</span>(<span class="number">100</span>);  <span class="comment">// æ¨¡æ‹Ÿæ¯ä¸ªæ•°æ®å—æœ‰ 100 ä¸ªå­—èŠ‚</span></span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (count++ &gt;= <span class="number">10</span>) <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// æ¨¡æ‹Ÿè¯»å– 10 ä¸ªæ•°æ®å—åç»“æŸ</span></span><br><span class="line"></span><br><span class="line">    std::<span class="built_in">generate</span>(chunk.data.<span class="built_in">begin</span>(), chunk.data.<span class="built_in">end</span>(),</span><br><span class="line">                  []() { <span class="keyword">return</span> <span class="built_in">rand</span>() % <span class="number">256</span>; });</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿå‹ç¼©å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="title">compress_byte</span><span class="params">(<span class="type">char</span> byte)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10&#x27;000ll</span>; ++i)</span><br><span class="line">        ;               <span class="comment">// æ¨¡æ‹Ÿ CPU busy</span></span><br><span class="line">    <span class="keyword">return</span> byte % <span class="number">128</span>;  <span class="comment">// ç®€å•å‹ç¼©ç®—æ³•ç¤ºä¾‹</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿå†™å…¥å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">write_to_file</span><span class="params">(<span class="type">const</span> CompressedChunk&amp; chunk)</span> </span>{</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">3</span>);  <span class="comment">// æ¨¡æ‹Ÿ IO å»¶è¿Ÿ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Writing chunk of size &quot;</span> &lt;&lt; chunk.data.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>æ–¹æ¡ˆä¸€</p>
<figure class="highlight cpp"><figcaption><span>1_message_queue.cpp</span><a href="/blog/downloads/code/tbb/pipeline/1_message_queue.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–¹æ¡ˆ 1ï¼šå¼‚æ­¥é˜Ÿåˆ— + TBB æµæ°´çº¿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tasks.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨å±€é˜Ÿåˆ—</span></span><br><span class="line">std::queue&lt;std::vector&lt;<span class="type">char</span>&gt;&gt; readQueue;</span><br><span class="line">std::mutex mtx;</span><br><span class="line">std::condition_variable cv;</span><br><span class="line">std::atomic_bool stop = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">networkReader</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (!stop) {</span><br><span class="line">        DataChunk chunk;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">read_from_network</span>(chunk))  <span class="comment">// é˜»å¡ I/O</span></span><br><span class="line">        {</span><br><span class="line">            stop.<span class="built_in">store</span>(<span class="literal">true</span>, memory_order::releaxed);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">            readQueue.<span class="built_in">push</span>(std::<span class="built_in">move</span>(chunk.data));</span><br><span class="line">        }</span><br><span class="line">        cv.<span class="built_in">notify_one</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‹ç¼©ä»»åŠ¡</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">compressor</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (!stop) {</span><br><span class="line">        DataChunk chunk;</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">            cv.<span class="built_in">wait</span>(lock, [] { <span class="keyword">return</span> !readQueue.<span class="built_in">empty</span>(); });</span><br><span class="line">            chunk.data = std::<span class="built_in">move</span>(readQueue.<span class="built_in">front</span>());</span><br><span class="line">            readQueue.<span class="built_in">pop</span>();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CPU å¯†é›†è®¡ç®—ï¼Œä½¿ç”¨ TBB å¹¶è¡Œ</span></span><br><span class="line">        <span class="function">CompressedChunk <span class="title">compressed</span><span class="params">(chunk.data.size())</span></span>;</span><br><span class="line">        tbb::<span class="built_in">parallel_for</span>(<span class="built_in">size_t</span>(<span class="number">0</span>), chunk.data.<span class="built_in">size</span>(), [&amp;](<span class="type">size_t</span> i) {</span><br><span class="line">            compressed.data[i] = <span class="built_in">compress_byte</span>(chunk.data[i]);  <span class="comment">// å‡è®¾å•å­—èŠ‚å‹ç¼©</span></span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="built_in">write_to_file</span>(compressed);  <span class="comment">// å¯ä»¥å¼‚æ­¥</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">reader</span><span class="params">(networkReader)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">worker</span><span class="params">(compressor)</span></span>;</span><br><span class="line"></span><br><span class="line">    reader.<span class="built_in">join</span>();</span><br><span class="line">    worker.<span class="built_in">join</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>æ–¹æ¡ˆäºŒ</p>
<figure class="highlight cpp"><figcaption><span>2_flow_graph.cpp</span><a href="/blog/downloads/code/tbb/pipeline/2_flow_graph.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–¹æ¡ˆ 2ï¼šTBB Flow Graph</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/flow_graph.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tasks.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tbb;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tbb::flow;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    graph g;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. è¯»å–èŠ‚ç‚¹ï¼ˆä¸²è¡Œï¼‰</span></span><br><span class="line">    <span class="function">input_node&lt;DataChunk&gt; <span class="title">reader</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        g,</span></span></span><br><span class="line"><span class="params"><span class="function">        [](flow_control&amp; fc) -&gt; DataChunk {</span></span></span><br><span class="line"><span class="params"><span class="function">            DataChunk chunk(<span class="number">1024</span>);  <span class="comment">// 1KBæ•°æ®å—</span></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">if</span> (!read_from_network(chunk)) {</span></span></span><br><span class="line"><span class="params"><span class="function">                fc.stop();</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">return</span> DataChunk();</span></span></span><br><span class="line"><span class="params"><span class="function">            }</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">return</span> chunk;</span></span></span><br><span class="line"><span class="params"><span class="function">        })</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å¹¶è¡Œå¤„ç†èŠ‚ç‚¹ï¼ˆæ— é™åˆ¶å¹¶å‘ï¼‰</span></span><br><span class="line">    <span class="function">function_node&lt;DataChunk, CompressedChunk&gt; <span class="title">processor</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        g, unlimited,</span></span></span><br><span class="line"><span class="params"><span class="function">        [](<span class="type">const</span> DataChunk&amp; input) -&gt; CompressedChunk {</span></span></span><br><span class="line"><span class="params"><span class="function">            CompressedChunk output(input.data.size());</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            tbb::parallel_for(</span></span></span><br><span class="line"><span class="params"><span class="function">                tbb::blocked_range&lt;<span class="type">size_t</span>&gt;(<span class="number">0</span>, input.data.size()),</span></span></span><br><span class="line"><span class="params"><span class="function">                [&amp;](<span class="type">const</span> tbb::blocked_range&lt;<span class="type">size_t</span>&gt;&amp; r) {</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">for</span> (<span class="type">size_t</span> i = r.begin(); i != r.end(); ++i) {</span></span></span><br><span class="line"><span class="params"><span class="function">                        output.data[i] = compress_byte(input.data[i]);</span></span></span><br><span class="line"><span class="params"><span class="function">                    }</span></span></span><br><span class="line"><span class="params"><span class="function">                });</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">return</span> output;</span></span></span><br><span class="line"><span class="params"><span class="function">        })</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. å†™å…¥èŠ‚ç‚¹ï¼ˆä¸²è¡Œä¿è¯å†™å…¥é¡ºåºï¼‰</span></span><br><span class="line">    <span class="function">function_node&lt;CompressedChunk&gt; <span class="title">writer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        g, serial,</span></span></span><br><span class="line"><span class="params"><span class="function">        [](<span class="type">const</span> CompressedChunk&amp; output) {</span></span></span><br><span class="line"><span class="params"><span class="function">            write_to_file(output);</span></span></span><br><span class="line"><span class="params"><span class="function">        })</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„å»ºæ•°æ®æµç®¡é“</span></span><br><span class="line">    <span class="built_in">make_edge</span>(reader, processor);</span><br><span class="line">    <span class="built_in">make_edge</span>(processor, writer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨ç®¡é“</span></span><br><span class="line">    reader.<span class="built_in">activate</span>();</span><br><span class="line">    g.<span class="built_in">wait_for_all</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>æ–¹æ¡ˆä¸‰</p>
<figure class="highlight cpp"><figcaption><span>3_pipeline.cpp</span><a href="/blog/downloads/code/tbb/pipeline/3_pipeline.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–¹æ¡ˆ 3: TBB æµæ°´çº¿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tasks.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    tbb::<span class="built_in">parallel_pipeline</span>(</span><br><span class="line">        <span class="comment">/* max_number_of_live_token */</span> <span class="number">4</span>,</span><br><span class="line">        <span class="comment">// Stage 1: è¯»ç½‘ç»œæ•°æ®</span></span><br><span class="line">        tbb::<span class="built_in">make_filter</span>&lt;<span class="type">void</span>, DataChunk&gt;(</span><br><span class="line">            tbb::filter_mode::serial_in_order,</span><br><span class="line">            [](tbb::flow_control&amp; fc) -&gt; DataChunk {</span><br><span class="line">                DataChunk chunk;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">read_from_network</span>(chunk)) {  <span class="comment">// è¿”å› false æ—¶ç»“æŸ</span></span><br><span class="line">                    fc.<span class="built_in">stop</span>();</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> chunk;</span><br><span class="line">            }) &amp;</span><br><span class="line">            <span class="comment">// Stage 2: CPU å‹ç¼©</span></span><br><span class="line">            tbb::<span class="built_in">make_filter</span>&lt;DataChunk, CompressedChunk&gt;(</span><br><span class="line">                tbb::filter_mode::parallel,</span><br><span class="line">                [](DataChunk chunk) -&gt; CompressedChunk {</span><br><span class="line">                    CompressedChunk <span class="built_in">out</span>(chunk.data.<span class="built_in">size</span>());</span><br><span class="line">                    tbb::<span class="built_in">parallel_for</span>(<span class="built_in">size_t</span>(<span class="number">0</span>), chunk.data.<span class="built_in">size</span>(), [&amp;](<span class="type">size_t</span> i) {</span><br><span class="line">                        out.data[i] = <span class="built_in">compress_byte</span>(chunk.data[i]);</span><br><span class="line">                    });</span><br><span class="line">                    <span class="keyword">return</span> out;</span><br><span class="line">                }) &amp;</span><br><span class="line">            <span class="comment">// Stage 3: å†™æ–‡ä»¶</span></span><br><span class="line">            tbb::<span class="built_in">make_filter</span>&lt;CompressedChunk, <span class="type">void</span>&gt;(</span><br><span class="line">                tbb::filter_mode::serial_in_order,</span><br><span class="line">                [](CompressedChunk out) {</span><br><span class="line">                    <span class="built_in">write_to_file</span>(out);  <span class="comment">// å¯ä»¥å¼‚æ­¥</span></span><br><span class="line">                }));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/10/">10</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bi-an"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">bi-an</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">100</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bi-an" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;bi-an" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ah_zzg@126.com" title="E-Mail â†’ mailto:ah_zzg@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://cuda-doc.readthedocs.io/" title="https:&#x2F;&#x2F;cuda-doc.readthedocs.io" rel="noopener" target="_blank">CUDAä¸­æ–‡æ‰‹å†Œ</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://infiniband-doc.readthedocs.io/" title="https:&#x2F;&#x2F;infiniband-doc.readthedocs.io&#x2F;" rel="noopener" target="_blank">InfiniBandä¸­æ–‡æ‰‹å†Œ</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bi-an</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

</body>
</html>
