<!DOCTYPE html>
<html lang="en, zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bi-an.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:url" content="https://bi-an.github.io/blog/index.html">
<meta property="og:site_name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:locale">
<meta property="article:author" content="bi-an">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bi-an.github.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en, zh_CN'
  };
</script>

  <title>æ±Ÿå—äººç‰©çš„åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æ±Ÿå—äººç‰©çš„åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/blog/resources/" rel="section"><i class="fa fa-paperclip fa-fw"></i>Resource</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/08/01/thread/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/08/01/thread/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2/" class="post-title-link" itemprop="url">çº¿ç¨‹çŠ¶æ€è½¬æ¢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-08-01 12:18:07 / Modified: 11:30:13" itemprop="dateCreated datePublished" datetime="2025-08-01T12:18:07+00:00">2025-08-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="çº¿ç¨‹çŠ¶æ€"><a href="#çº¿ç¨‹çŠ¶æ€" class="headerlink" title="çº¿ç¨‹çŠ¶æ€"></a>çº¿ç¨‹çŠ¶æ€</h2><ul>
<li>Newï¼ˆæ–°å»ºï¼‰ï¼šçº¿ç¨‹å¯¹è±¡åˆšåˆ›å»ºï¼Œè¿˜æœªå¼€å§‹æ‰§è¡Œã€‚</li>
<li>Readyï¼ˆå°±ç»ªï¼‰ï¼šçº¿ç¨‹å‡†å¤‡å¥½è¿è¡Œï¼Œç­‰å¾…è°ƒåº¦å™¨åˆ†é… CPUã€‚</li>
<li>Runningï¼ˆè¿è¡Œï¼‰ï¼šçº¿ç¨‹æ­£åœ¨ä½¿ç”¨ CPU æ‰§è¡ŒæŒ‡ä»¤ã€‚</li>
<li>Blockedï¼ˆé˜»å¡ï¼‰ï¼šçº¿ç¨‹åœ¨ç­‰å¾…æŸä¸ªäº‹ä»¶ï¼ˆå¦‚ I&#x2F;Oã€é”ã€æ¡ä»¶å˜é‡ç­‰ï¼‰ï¼Œä¸èƒ½è¿è¡Œã€‚</li>
<li>Terminatedï¼ˆç»ˆæ­¢ï¼‰ï¼šçº¿ç¨‹æ‰§è¡Œå®Œæ¯•æˆ–è¢«å¼ºåˆ¶ç»“æŸã€‚</li>
<li>Sleepingï¼ˆä¼‘çœ ï¼‰ï¼šçº¿ç¨‹ä¸»åŠ¨æš‚åœä¸€æ®µæ—¶é—´ï¼ˆå¦‚ sleep()ï¼‰ï¼Œä¸èƒ½è¢«è°ƒåº¦ã€‚</li>
</ul>
<h2 id="çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾"><a href="#çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾" class="headerlink" title="çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾"></a>çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾</h2><table>
<thead>
<tr>
<th>å½“å‰çŠ¶æ€</th>
<th>è§¦å‘æ¡ä»¶</th>
<th>è½¬æ¢åçŠ¶æ€</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>New</td>
<td>è°ƒç”¨ start() æˆ– std::thread æ„é€ å‡½æ•°</td>
<td>Ready</td>
<td>çº¿ç¨‹è¢«åˆ›å»ºï¼Œç­‰å¾…è°ƒåº¦</td>
</tr>
<tr>
<td>Ready</td>
<td>è¢«è°ƒåº¦å™¨é€‰ä¸­</td>
<td>Running</td>
<td>è·å¾— CPUï¼Œå¼€å§‹æ‰§è¡Œ</td>
</tr>
<tr>
<td>Running</td>
<td>æ—¶é—´ç‰‡è€—å°½ &#x2F; yield()</td>
<td>Ready</td>
<td>ä¸»åŠ¨æˆ–è¢«åŠ¨è®©å‡º CPUï¼Œé‡æ–°æ’é˜Ÿ</td>
</tr>
<tr>
<td>Running</td>
<td>è°ƒç”¨ sleep() &#x2F; wait() &#x2F; ç­‰å¾…é”</td>
<td>Blocked &#x2F; Sleeping</td>
<td>çº¿ç¨‹ä¸èƒ½ç»§ç»­æ‰§è¡Œï¼Œç­‰å¾…äº‹ä»¶æˆ–æ—¶é—´</td>
</tr>
<tr>
<td>Blocked &#x2F; Sleeping</td>
<td>æ¡ä»¶æ»¡è¶³ &#x2F; æ—¶é—´åˆ°</td>
<td>Ready</td>
<td>çº¿ç¨‹é‡æ–°å…·å¤‡è¿è¡Œæ¡ä»¶ï¼Œç­‰å¾…è°ƒåº¦</td>
</tr>
<tr>
<td>Running</td>
<td>æ‰§è¡Œç»“æŸæˆ–å¼‚å¸¸</td>
<td>Terminated</td>
<td>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç»“æŸ</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">æ€§èƒ½åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 15:43:15" itemprop="dateCreated datePublished" datetime="2025-07-31T15:43:15+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æ€§èƒ½æŒ‡æ ‡"><a href="#æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡"></a>æ€§èƒ½æŒ‡æ ‡</h2><h3 id="CPUæ—¶é—´"><a href="#CPUæ—¶é—´" class="headerlink" title="CPUæ—¶é—´"></a>CPUæ—¶é—´</h3><p><strong>å‡½æ•°è°ƒç”¨çš„ CPU æ—¶é—´:</strong></p>
<ul>
<li><code>Inclusive time</code>: total cpu time, include all functions it calls.</li>
<li><code>Exclusive time</code>: only the time used by the function itself, exclusive all its children.</li>
</ul>
<p>Refer to <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15760447/what-is-the-meaning-of-incl-cpu-time-excl-cpu-time-incl-real-cpu-time-excl-re/74426370">here</a>.</p>
<ol>
<li><p>Wall time: total time the process used, containing IO time.</p>
</li>
<li><p>CPU usage (CPUåˆ©ç”¨ç‡) &#x3D; CPU time &#x2F; Wall time.</p>
</li>
<li><p>real&#x2F;user&#x2F;system time</p>
<ul>
<li><strong>Real</strong> is wall clock time - time from start to finish of the call. This is all elapsed time including time slices used by other processes and time the process spends blocked (for example if it is waiting for I&#x2F;O to complete).</li>
<li><strong>User</strong> is the amount of CPU time spent in user-mode code (outside the kernel) within the process. This is only actual CPU time used in executing the process. Other processes and time the process spends blocked do not count towards this figure.</li>
<li><strong>Sys</strong> is the amount of CPU time spent in the kernel within the process. This means executing CPU time spent in system calls within the kernel, as opposed to library code, which is still running in user-space. Like â€˜userâ€™, this is only CPU time used by the process. See below for a brief description of kernel mode (also known as â€˜supervisorâ€™ mode) and the system call mechanism.</li>
</ul>
<p> Refer to <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/556405/what-do-real-user-and-sys-mean-in-the-output-of-time1">here</a>.</p>
</li>
<li><p>CPU æ—¶é—´å¯èƒ½å¤§äºå¢™ä¸Šæ—¶é—´ï¼š</p>
<p>è¿™æ˜¯å› ä¸º CPU æ—¶é—´æ˜¯æ‰€æœ‰ CPU æ ¸çš„è¿è¡Œæ—¶é—´çš„ç´¯åŠ å’Œï¼Œå¢™ä¸Šæ—¶é—´åˆ™æ˜¯å®é™…çš„æ—¶é—´ã€‚æ­¤æ—¶ CPU åˆ©ç”¨ç‡å¤§äº 100%. ï¼ˆè¿™æ˜¯è‡ªå·±çš„ç†è§£ï¼‰</p>
</li>
<li><p>TODO: Is CPU time in <em>flame graph</em> sum of all the CPU time? Or is it the wall time when CPU works?</p>
</li>
</ol>
<h3 id="è®¡æ—¶å·¥å…·ï¼štimer"><a href="#è®¡æ—¶å·¥å…·ï¼štimer" class="headerlink" title="è®¡æ—¶å·¥å…·ï¼štimer"></a>è®¡æ—¶å·¥å…·ï¼š<code>timer</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/time -p <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>Or,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ time <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼ˆå‚è€ƒ<a target="_blank" rel="noopener" href="https://ostechnix.com/how-to-find-the-execution-time-of-a-command-or-process-in-linux/">é“¾æ¥</a>ï¼‰ï¼Œ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">type</span> -a time</span><br><span class="line">time is a shell keyword</span><br><span class="line">time is /usr/bin/time</span><br></pre></td></tr></table></figure>


<h2 id="åˆ†æå·¥å…·"><a href="#åˆ†æå·¥å…·" class="headerlink" title="åˆ†æå·¥å…·"></a>åˆ†æå·¥å…·</h2><ul>
<li>Performance Analyzer</li>
<li>Thread Analyzer</li>
<li>gprof</li>
<li>DDT&#x2F;gdb</li>
</ul>
<h3 id="Performance-Analyzer"><a href="#Performance-Analyzer" class="headerlink" title="Performance Analyzer"></a>Performance Analyzer</h3><p>Oracle Developer Studio æä¾›äº†å¤šç§å·¥å…·ï¼šPerformance Analyzerã€Thread Analyzerã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afagg.html#OSSPAgrkam">Performance Analyzer å®˜æ–¹æ–‡æ¡£</a></p>
</blockquote>
<p><strong>1. æ”¶é›†æ•°æ®</strong></p>
<p>ä½¿ç”¨ <code>collect</code> å‘½ä»¤æ”¶é›†æ•°æ®ï¼ˆ<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afadn.html#scrolltoc">å®˜æ–¹æ–‡æ¡£</a>ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collect collect-options program program-arguments</span><br></pre></td></tr></table></figure>

<p><strong>2. å¼€å§‹æ€§èƒ½åˆ†æ</strong></p>
<p>ä½¿ç”¨ <code>analyzer</code> å‘½ä»¤è¿›è¡Œæ€§èƒ½åˆ†æï¼ˆ<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E77782_01/html/E77798/afafs.html#scrolltoc">å®˜æ–¹æ–‡æ¡£</a>ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">analyzer [control-options] [experiment | experiment-list]</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">analyzer -c test.1.er test.4.er</span><br></pre></td></tr></table></figure>

<h3 id="Thread-Analyzer"><a href="#Thread-Analyzer" class="headerlink" title="Thread Analyzer"></a>Thread Analyzer</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/application-development/technologies/developerstudio-features.html#thread-analyzer-tab">Thread Analyzer å®˜æ–¹æ–‡æ¡£</a></p>
</blockquote>
<h3 id="gprof"><a href="#gprof" class="headerlink" title="gprof"></a>gprof</h3><p>gprof(GNU profiler)æ˜¯GNU binutilså·¥å…·é›†ä¸­çš„ä¸€ä¸ªå·¥å…·ï¼Œlinuxç³»ç»Ÿå½“ä¸­ä¼šè‡ªå¸¦è¿™ä¸ªå·¥å…·ã€‚å®ƒå¯ä»¥åˆ†æç¨‹åºçš„æ€§èƒ½ï¼Œèƒ½ç»™å‡ºå‡½æ•°è°ƒç”¨æ—¶é—´ã€è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨å…³ç³»ï¼Œæ‰¾å‡ºç¨‹åºçš„ç“¶é¢ˆæ‰€åœ¨ã€‚åœ¨ç¼–è¯‘å’Œé“¾æ¥é€‰é¡¹ä¸­éƒ½åŠ å…¥-pgä¹‹åï¼Œgccä¼šåœ¨æ¯ä¸ªå‡½æ•°ä¸­æ’å…¥ä»£ç ç‰‡æ®µï¼Œç”¨äºè®°å½•å‡½æ•°é—´çš„è°ƒç”¨å…³ç³»å’Œè°ƒç”¨æ¬¡æ•°ï¼Œå¹¶é‡‡é›†å‡½æ•°çš„è°ƒç”¨æ—¶é—´ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ftp.gnu.org/old-gnu/Manuals/gprof-2.9.1/html_mono/gprof.html">gprofå®˜æ–¹æ–‡æ¡£</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/luronggui/article/-details/118141262">ä½¿ç”¨æ–¹æ³•</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385842627">åšå®¢</a></li>
</ul>
<h3 id="DDT"><a href="#DDT" class="headerlink" title="DDT"></a>DDT</h3><p><a target="_blank" rel="noopener" href="https://www.linaroforge.com/linaroDdt">DDT</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E6%B7%B7%E5%90%88%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E6%B7%B7%E5%90%88%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">æ··åˆç¼–è¯‘</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 15:29:32" itemprop="dateCreated datePublished" datetime="2025-07-31T15:29:32+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>â€œHybrid Buildâ€ï¼ˆæ··åˆæ„å»ºï¼‰æ˜¯æŒ‡ä¸€ç§ å…¼é¡¾è°ƒè¯•èƒ½åŠ›ä¸è¿è¡Œæ€§èƒ½ çš„æ„å»ºæ–¹å¼ï¼Œå¸¸ç”¨äºéœ€è¦åœ¨ Release ç¯å¢ƒä¸­è¿›è¡Œé—®é¢˜åˆ†æï¼Œä½†åˆä¸èƒ½å®Œå…¨ä½¿ç”¨ Debug æ„å»ºçš„åœºæ™¯ã€‚</p>
<h3 id="ğŸ§©-Hybrid-Build-çš„æ ¸å¿ƒç‰¹å¾"><a href="#ğŸ§©-Hybrid-Build-çš„æ ¸å¿ƒç‰¹å¾" class="headerlink" title="ğŸ§© Hybrid Build çš„æ ¸å¿ƒç‰¹å¾"></a>ğŸ§© Hybrid Build çš„æ ¸å¿ƒç‰¹å¾</h3><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>ä¼˜åŒ–ç­‰çº§</td>
<td>ä½¿ç”¨ -O2 æˆ– -O3ï¼Œä¿æŒæ¥è¿‘ Release çš„æ€§èƒ½</td>
</tr>
<tr>
<td>è°ƒè¯•ä¿¡æ¯</td>
<td>ä¿ç•™ -gï¼Œç”Ÿæˆ DWARF è°ƒè¯•ç¬¦å·ï¼Œä¾¿äºåˆ†æ core dump æˆ–ä½¿ç”¨ gdb</td>
</tr>
<tr>
<td>ç¬¦å·è¡¨</td>
<td>å¯é€‰å¼€å¯ -fno-omit-frame-pointerï¼Œä¾¿äºæ ˆå›æº¯</td>
</tr>
<tr>
<td>æ—¥å¿—&#x2F;ä¿æŠ¤æœºåˆ¶</td>
<td>å¯åµŒå…¥è½»é‡çº§æ—¥å¿—ã€ASAN-liteã€canary ç­‰æœºåˆ¶ï¼Œå¢å¼ºå¯è§‚æµ‹æ€§</td>
</tr>
<tr>
<td>éƒ¨ç½²ç­–ç•¥</td>
<td>ä»…åœ¨å†…éƒ¨æˆ–ç‰¹å®šå®¢æˆ·ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œé¿å…æš´éœ²å®Œæ•´æºç ç»“æ„æˆ–è°ƒè¯•ç¬¦å·</td>
</tr>
</tbody></table>
<p>âœ… ç¼–è¯‘ç¤ºä¾‹ï¼ˆGCC&#x2F;Clangï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -O2 -g -fno-omit-frame-pointer -DNDEBUG -o your_program main.cpp</span><br></pre></td></tr></table></figure>

<ul>
<li>-O2ï¼šä¼˜åŒ–ä»£ç ï¼Œæ¥è¿‘ Release æ€§èƒ½</li>
<li>-gï¼šä¿ç•™è°ƒè¯•ä¿¡æ¯</li>
<li>-fno-omit-frame-pointerï¼šä¿ç•™å¸§æŒ‡é’ˆï¼Œä¾¿äºæ ˆè¿½è¸ª</li>
<li>-DNDEBUGï¼šå…³é—­æ–­è¨€ï¼ˆassertï¼‰</li>
</ul>
<h3 id="ğŸ¯-ä½¿ç”¨åœºæ™¯"><a href="#ğŸ¯-ä½¿ç”¨åœºæ™¯" class="headerlink" title="ğŸ¯ ä½¿ç”¨åœºæ™¯"></a>ğŸ¯ ä½¿ç”¨åœºæ™¯</h3><table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ˜¯å¦æ¨èä½¿ç”¨ Hybrid Build</th>
<th>åŸå› è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>å®¢æˆ·ç°åœºå¤ç°å´©æºƒ</td>
<td>âœ…</td>
<td>å¯é€šè¿‡ core dump + ç¬¦å·è¡¨å¿«é€Ÿå®šä½é—®é¢˜</td>
</tr>
<tr>
<td>å†…éƒ¨æ€§èƒ½æµ‹è¯•</td>
<td>âœ…</td>
<td>ä¿æŒä¼˜åŒ–æ•ˆæœï¼ŒåŒæ—¶å¯è°ƒè¯•</td>
</tr>
<tr>
<td>æ­£å¼å‘å¸ƒç»™å®¢æˆ·ï¼ˆå¤§è§„æ¨¡éƒ¨ç½²ï¼‰</td>
<td>âŒ</td>
<td>ä¸å»ºè®®ï¼Œå¯èƒ½æš´éœ²ç¬¦å·ä¿¡æ¯ï¼Œä½“ç§¯è¾ƒå¤§</td>
</tr>
<tr>
<td>ä¸ ASAN&#x2F;TSAN è”åˆä½¿ç”¨</td>
<td>âš ï¸ï¼ˆéœ€å…³é—­ä¼˜åŒ–ï¼‰</td>
<td>ASAN&#x2F;TSAN æ›´é€‚åˆ Debug æ„å»ºï¼ŒHybrid ä¼šå½±å“æ£€æµ‹ç²¾åº¦</td>
</tr>
</tbody></table>
<h3 id="ğŸ› ï¸-å®è·µå»ºè®®"><a href="#ğŸ› ï¸-å®è·µå»ºè®®" class="headerlink" title="ğŸ› ï¸ å®è·µå»ºè®®"></a>ğŸ› ï¸ å®è·µå»ºè®®</h3><ul>
<li>ç¬¦å·åˆ†ç¦»ï¼šä½¿ç”¨ <code>objcopy --only-keep-debug</code> åˆ†ç¦»è°ƒè¯•ç¬¦å·ï¼Œé¿å…æš´éœ²ç»™å®¢æˆ·ã€‚</li>
<li>ç¬¦å·æœåŠ¡å™¨ï¼šå†…éƒ¨ç»´æŠ¤ç¬¦å·æœåŠ¡å™¨ï¼Œæ”¯æŒé€šè¿‡ core æ–‡ä»¶è‡ªåŠ¨ç¬¦å·åŒ–ã€‚</li>
<li>ç»“åˆæ—¥å¿—æ¡†æ¶ï¼šHybrid Build å¯ä¸è½»é‡çº§æ—¥å¿—æ¡†æ¶ç»“åˆï¼Œå¢å¼ºé—®é¢˜å®šä½èƒ½åŠ›ã€‚</li>
</ul>
<h2 id="ç¬¦å·åˆ†ç¦»ï¼ˆSplit-Debug-Infoï¼‰"><a href="#ç¬¦å·åˆ†ç¦»ï¼ˆSplit-Debug-Infoï¼‰" class="headerlink" title="ç¬¦å·åˆ†ç¦»ï¼ˆSplit Debug Infoï¼‰"></a>ç¬¦å·åˆ†ç¦»ï¼ˆSplit Debug Infoï¼‰</h2><p><strong>âœ… ä¸ºä»€ä¹ˆè¦åˆ†ç¦»ï¼Ÿ</strong></p>
<ul>
<li>Release ç‰ˆæœ¬ï¼šä½“ç§¯å°ï¼Œæ€§èƒ½é«˜ï¼Œä½†ç¼ºå°‘è°ƒè¯•ä¿¡æ¯</li>
<li>è°ƒè¯•ç¬¦å·æ–‡ä»¶ï¼šä¿ç•™å®Œæ•´ç¬¦å·ä¿¡æ¯ï¼Œç”¨äºå†…éƒ¨åˆ†æ core dump</li>
</ul>
<p><strong>ğŸ› ï¸ åˆ†ç¦»æµç¨‹ï¼ˆä»¥ GCC&#x2F;Clang ä¸ºä¾‹ï¼‰</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘æ—¶ä¿ç•™è°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">g++ -O2 -g -o your_program main.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç¦»è°ƒè¯•ç¬¦å·</span></span><br><span class="line">objcopy --only-keep-debug your_program your_program.debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»é™¤ä¸»ç¨‹åºä¸­çš„è°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">strip --strip-debug --strip-unneeded your_program</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è°ƒè¯•ç¬¦å·å…³è”ä¿¡æ¯</span></span><br><span class="line">objcopy --add-gnu-debuglink=your_program.debug your_program</span><br></pre></td></tr></table></figure>

<p><strong>âœ… æœ€ç»ˆäº§ç‰©ï¼š</strong></p>
<ul>
<li>your_programï¼šå¯äº¤ä»˜ç»™å®¢æˆ·çš„ Release å¯æ‰§è¡Œæ–‡ä»¶</li>
<li>your_program.debugï¼šå†…éƒ¨ä½¿ç”¨çš„è°ƒè¯•ç¬¦å·æ–‡ä»¶</li>
</ul>
<h2 id="core-dump-åˆ†æ"><a href="#core-dump-åˆ†æ" class="headerlink" title="core dump åˆ†æ"></a>core dump åˆ†æ</h2><p><strong>1. å®¢æˆ·ä¾§è®¾ç½® core dump</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br></pre></td></tr></table></figure>

<p><strong>2. å®¢æˆ·è¿è¡Œç¨‹åºå¹¶ç”Ÿæˆ core æ–‡ä»¶</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./your_program crash_input.txt</span><br><span class="line"><span class="comment"># ç¨‹åºå´©æºƒåç”Ÿæˆ core æ–‡ä»¶ï¼Œå¦‚ core.12345</span></span><br></pre></td></tr></table></figure>

<p><strong>3. å®¢æˆ·æä¾› core æ–‡ä»¶ + å¯æ‰§è¡Œæ–‡ä»¶</strong></p>
<ul>
<li>core.12345</li>
<li>your_programï¼ˆRelease ç‰ˆæœ¬ï¼‰</li>
</ul>
<p><strong>4. ä½ åœ¨å†…éƒ¨åˆ†æ core æ–‡ä»¶</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb your_program core.12345</span><br><span class="line"><span class="comment"># åŠ è½½è°ƒè¯•ç¬¦å·</span></span><br><span class="line">(gdb) symbol-file your_program.debug</span><br><span class="line">(gdb) bt  <span class="comment"># æŸ¥çœ‹è°ƒç”¨æ ˆ</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/31/cpp/%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/31/cpp/%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">å†…å­˜åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-31 14:53:40" itemprop="dateCreated datePublished" datetime="2025-07-31T14:53:40+00:00">2025-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><p>valgrind æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å†…å­˜è°ƒè¯•å’Œæ€§èƒ½åˆ†æå·¥å…·ï¼Œå®ƒçš„ä¸åŒå­å·¥å…·ç”¨äºä¸åŒçš„åˆ†æç›®çš„ã€‚<code>--memcheck</code> å’Œ <code>--massif</code> æ˜¯å…¶ä¸­ä¸¤ä¸ªå¸¸ç”¨çš„å·¥å…·ã€‚</p>
<p>ASANï¼ˆAddressSanitizerï¼‰ å’Œ TSANï¼ˆThreadSanitizerï¼‰ éƒ½æ˜¯ç”±ç°ä»£ç¼–è¯‘å™¨ï¼ˆå¦‚ Clang å’Œ GCCï¼‰æä¾›çš„ è¿è¡Œæ—¶æ£€æµ‹å·¥å…·ï¼Œç”¨äºå¸®åŠ©å¼€å‘è€…åœ¨å¼€å‘é˜¶æ®µå‘ç°å†…å­˜é”™è¯¯å’Œçº¿ç¨‹é—®é¢˜ã€‚</p>
<ul>
<li>Clangï¼šå…¨é¢æ”¯æŒ ASAN å’Œ TSAN</li>
<li>GCCï¼šä¹Ÿæ”¯æŒï¼Œä½† TSAN çš„æ”¯æŒç•¥é€Šäº Clang</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://jvns.ca/blog/2018/04/28/debugging-a-segfault-on-linux/">åšå®¢ï¼šHow to get a core dump for a segfault on Linux</a></p>
<h3 id="Memcheckï¼šå†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·"><a href="#Memcheckï¼šå†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·" class="headerlink" title="Memcheckï¼šå†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·"></a>Memcheckï¼šå†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·</h3><p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://valgrind.org/docs/manual/mc-manual.html">4. Memcheck: a memory error detector</a></p>
<ul>
<li>ç”¨é€”ï¼šæ£€æµ‹å†…å­˜ç›¸å…³çš„é”™è¯¯ï¼Œå¦‚å†…å­˜æ³„æ¼ã€è¶Šç•Œè®¿é—®ã€æœªåˆå§‹åŒ–å†…å­˜è¯»å–ç­‰ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šè°ƒè¯•ç¨‹åºä¸­çš„å†…å­˜é”™è¯¯ï¼Œç¡®ä¿ç¨‹åºçš„å†…å­˜ä½¿ç”¨æ˜¯å®‰å…¨çš„ã€‚</li>
<li>è¾“å‡ºå†…å®¹ï¼š<ul>
<li>å“ªäº›å†…å­˜æ²¡æœ‰é‡Šæ”¾ï¼ˆå†…å­˜æ³„æ¼ï¼‰</li>
<li>å“ªäº›å†…å­˜è¢«éæ³•è®¿é—®ï¼ˆè¶Šç•Œã€æœªåˆå§‹åŒ–ç­‰ï¼‰</li>
<li>å“ªäº›å†…å­˜è®¿é—®æ˜¯æœªå®šä¹‰è¡Œä¸º</li>
</ul>
</li>
<li>å¸¸ç”¨å‘½ä»¤ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valgrind --tool=memcheck ./your_program</span><br></pre></td></tr></table></figure>

<h3 id="Massifï¼šå †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·"><a href="#Massifï¼šå †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·" class="headerlink" title="Massifï¼šå †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·"></a>Massifï¼šå †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·</h3><p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://valgrind.org/docs/manual/ms-manual.html">9. Massif: a heap profiler</a></p>
<ul>
<li>ç”¨é€”ï¼šåˆ†æç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œå¸®åŠ©ä¼˜åŒ–å†…å­˜å ç”¨ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šæ€§èƒ½åˆ†æï¼Œæ‰¾å‡ºå†…å­˜å ç”¨é«˜çš„ä»£ç è·¯å¾„æˆ–æ•°æ®ç»“æ„ã€‚</li>
<li>è¾“å‡ºå†…å®¹ï¼š<ul>
<li>å †å†…å­˜ä½¿ç”¨éšæ—¶é—´çš„å˜åŒ–ï¼ˆå¿«ç…§ï¼‰ï¼šéœ€ç”¨ <code>ms_print</code> æˆ– <a target="_blank" rel="noopener" href="https://courses.cs.washington.edu/courses/cse326/05wi/valgrind-doc/ms_main.html">PostScript Viewer</a> æŸ¥çœ‹</li>
<li>å“ªäº›å‡½æ•°æˆ–è°ƒç”¨è·¯å¾„åˆ†é…äº†æœ€å¤šçš„å†…å­˜</li>
<li>å¸¸ç”¨å‘½ä»¤ï¼š</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">valgrind --tool=massif ./your_program</span><br><span class="line">ms_print massif.out.&lt;pid&gt;</span><br></pre></td></tr></table></figure>

<p><strong>ğŸ†š Memcheck vs Massif å¯¹æ¯”æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th><code>--memcheck</code></th>
<th><code>--massif</code></th>
</tr>
</thead>
<tbody><tr>
<td>å·¥å…·ç±»å‹</td>
<td>å†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·</td>
<td>å †å†…å­˜ä½¿ç”¨åˆ†æå·¥å…·</td>
</tr>
<tr>
<td>ä¸»è¦ç”¨é€”</td>
<td>æ£€æŸ¥å†…å­˜æ³„æ¼ã€è¶Šç•Œè®¿é—®ã€æœªåˆå§‹åŒ–è¯»å–ç­‰</td>
<td>åˆ†æå †å†…å­˜ä½¿ç”¨è¶‹åŠ¿å’Œå³°å€¼</td>
</tr>
<tr>
<td>æ£€æµ‹å†…å­˜æ³„æ¼</td>
<td>âœ…</td>
<td>âŒï¼ˆä¸ç›´æ¥æ£€æµ‹ï¼‰</td>
</tr>
<tr>
<td>åˆ†æå†…å­˜å¢é•¿è¶‹åŠ¿</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>è¾“å‡ºæ ¼å¼</td>
<td>é”™è¯¯æŠ¥å‘Šï¼ˆæ–‡æœ¬ï¼‰</td>
<td>å†…å­˜å¿«ç…§ï¼ˆéœ€ç”¨ <code>ms_print</code> æŸ¥çœ‹ï¼‰</td>
</tr>
<tr>
<td>æ€§èƒ½å¼€é”€</td>
<td>é«˜ï¼ˆè¿è¡Œé€Ÿåº¦å˜æ…¢ï¼‰</td>
<td>ä¸­ç­‰</td>
</tr>
</tbody></table>
<h3 id="ThreadSanitizerï¼ˆTSANï¼‰"><a href="#ThreadSanitizerï¼ˆTSANï¼‰" class="headerlink" title="ThreadSanitizerï¼ˆTSANï¼‰"></a>ThreadSanitizerï¼ˆTSANï¼‰</h3><ul>
<li>ç”¨é€”ï¼šæ£€æµ‹å¤šçº¿ç¨‹ç¨‹åºä¸­çš„ æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰ å’Œå…¶ä»–çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šå¹¶å‘ç¨‹åºè°ƒè¯•ï¼Œå°¤å…¶æ˜¯å½“å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«å˜é‡æ—¶ã€‚</li>
<li>æ£€æµ‹å†…å®¹ï¼š<ul>
<li>æ•°æ®ç«äº‰ï¼ˆä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€å˜é‡ï¼Œä¸”è‡³å°‘ä¸€ä¸ªæ˜¯å†™æ“ä½œï¼‰</li>
<li>é”ä½¿ç”¨é”™è¯¯ï¼ˆæ­»é”ã€åŒé‡è§£é”ç­‰ï¼‰</li>
</ul>
</li>
<li>å¯ç”¨æ–¹å¼ï¼ˆClang&#x2F;GCCï¼‰ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fsanitize=thread -g your_program.c -o your_program</span><br></pre></td></tr></table></figure>

<h3 id="AddressSanitizerï¼ˆASANï¼‰"><a href="#AddressSanitizerï¼ˆASANï¼‰" class="headerlink" title="AddressSanitizerï¼ˆASANï¼‰"></a>AddressSanitizerï¼ˆASANï¼‰</h3><p><a target="_blank" rel="noopener" href="https://github.com/google/sanitizers/wiki/AddressSanitizer">AddressSanitizer æ–‡æ¡£</a></p>
<ul>
<li>ç”¨é€”ï¼šæ£€æµ‹å†…å­˜è®¿é—®é”™è¯¯ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šå•çº¿ç¨‹æˆ–å¤šçº¿ç¨‹ç¨‹åºä¸­è°ƒè¯•å†…å­˜é—®é¢˜ã€‚</li>
<li>æ£€æµ‹å†…å®¹ï¼š<ul>
<li>è¶Šç•Œè®¿é—®ï¼ˆstack&#x2F;heap&#x2F;globalï¼‰</li>
<li>use-after-freeï¼ˆé‡Šæ”¾åä½¿ç”¨ï¼‰</li>
<li>å†…å­˜æ³„æ¼ï¼ˆå¯é€‰ï¼‰</li>
<li>use-after-scopeï¼ˆä½œç”¨åŸŸç»“æŸåä½¿ç”¨å±€éƒ¨å˜é‡ï¼‰</li>
</ul>
</li>
<li>å¯ç”¨æ–¹å¼ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -fsanitize=address -g your_program.c -o your_program</span><br></pre></td></tr></table></figure>

<p><strong>ğŸ†š TSAN vs ASAN å¯¹æ¯”æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>TSANï¼ˆThreadSanitizerï¼‰</th>
<th>ASANï¼ˆAddressSanitizerï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>æ£€æµ‹ç›®æ ‡</td>
<td>å¤šçº¿ç¨‹æ•°æ®ç«äº‰</td>
<td>å†…å­˜è®¿é—®é”™è¯¯</td>
</tr>
<tr>
<td>æ˜¯å¦æ”¯æŒå¤šçº¿ç¨‹</td>
<td>âœ…ï¼ˆä¸“ä¸ºå¤šçº¿ç¨‹è®¾è®¡ï¼‰</td>
<td>âœ…ï¼ˆæ”¯æŒï¼Œä½†ä¸æ£€æµ‹æ•°æ®ç«äº‰ï¼‰</td>
</tr>
<tr>
<td>æ€§èƒ½å¼€é”€</td>
<td>è¾ƒé«˜ï¼ˆ10x~40xï¼‰</td>
<td>ä¸­ç­‰ï¼ˆ2x~3xï¼‰</td>
</tr>
<tr>
<td>å†…å­˜å¼€é”€</td>
<td>ä¸­ç­‰</td>
<td>è¾ƒé«˜ï¼ˆå¢åŠ çº¦2å€å†…å­˜ä½¿ç”¨ï¼‰</td>
</tr>
<tr>
<td>æ˜¯å¦æ£€æµ‹å†…å­˜æ³„æ¼</td>
<td>âŒï¼ˆä¸æ£€æµ‹ï¼‰</td>
<td>âœ…ï¼ˆå¯é€‰å¼€å¯ï¼‰</td>
</tr>
<tr>
<td>æ˜¯å¦æ£€æµ‹æ•°æ®ç«äº‰</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
</tbody></table>
<p><strong>ğŸ†š Memcheck vs Massif vs TSAN vs ASAN å¯¹æ¯”æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>å·¥å…·åç§°</th>
<th>ç±»å‹</th>
<th>ä¸»è¦ç”¨é€”</th>
<th>æ£€æµ‹å†…å®¹</th>
<th>æ˜¯å¦æ”¯æŒå¤šçº¿ç¨‹</th>
<th>æ€§èƒ½å¼€é”€</th>
<th>å†…å­˜å¼€é”€</th>
<th>æ˜¯å¦æ£€æµ‹å†…å­˜æ³„æ¼</th>
<th>æ˜¯å¦æ£€æµ‹æ•°æ®ç«äº‰</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Memcheck</strong></td>
<td>Valgrind å·¥å…·</td>
<td>å†…å­˜é”™è¯¯æ£€æµ‹</td>
<td>å†…å­˜æ³„æ¼ã€è¶Šç•Œè®¿é—®ã€æœªåˆå§‹åŒ–è¯»å–ã€éæ³•é‡Šæ”¾ç­‰</td>
<td>âœ…ï¼ˆæœ‰é™æ”¯æŒï¼‰</td>
<td>é«˜ï¼ˆ10x+ï¼‰</td>
<td>é«˜</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><strong>Massif</strong></td>
<td>Valgrind å·¥å…·</td>
<td>å †å†…å­˜ä½¿ç”¨åˆ†æ</td>
<td>å †å†…å­˜åˆ†é…è¶‹åŠ¿ã€å†…å­˜å³°å€¼ã€è°ƒç”¨è·¯å¾„åˆ†æ</td>
<td>âœ…</td>
<td>ä¸­ç­‰</td>
<td>ä¸­ç­‰</td>
<td>âŒ</td>
<td>âŒ</td>
</tr>
<tr>
<td><strong>ASAN</strong></td>
<td>ç¼–è¯‘å™¨å·¥å…·</td>
<td>å†…å­˜è®¿é—®é”™è¯¯æ£€æµ‹</td>
<td>è¶Šç•Œè®¿é—®ã€use-after-freeã€use-after-scopeã€å†…å­˜æ³„æ¼ï¼ˆå¯é€‰ï¼‰</td>
<td>âœ…</td>
<td>ä¸­ç­‰ï¼ˆ2x~3xï¼‰</td>
<td>é«˜ï¼ˆçº¦2å€ï¼‰</td>
<td>âœ…ï¼ˆå¯é€‰ï¼‰</td>
<td>âŒ</td>
</tr>
<tr>
<td><strong>TSAN</strong></td>
<td>ç¼–è¯‘å™¨å·¥å…·</td>
<td>å¤šçº¿ç¨‹æ•°æ®ç«äº‰æ£€æµ‹</td>
<td>æ•°æ®ç«äº‰ã€æ­»é”ã€é”™è¯¯çš„é”ä½¿ç”¨ç­‰</td>
<td>âœ…ï¼ˆå¼ºæ”¯æŒï¼‰</td>
<td>é«˜ï¼ˆ5x~40xï¼‰</td>
<td>ä¸­ç­‰</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
</tbody></table>
<h2 id="UBSan-Unifined-Behavior-Sanitizer"><a href="#UBSan-Unifined-Behavior-Sanitizer" class="headerlink" title="UBSan (Unifined Behavior Sanitizer)"></a>UBSan (Unifined Behavior Sanitizer)</h2><table>
<thead>
<tr>
<th>Sanitizer</th>
<th>æ£€æµ‹å†…å®¹</th>
<th>Google è´¡çŒ®</th>
</tr>
</thead>
<tbody><tr>
<td>ASAN</td>
<td>å†…å­˜è®¿é—®é”™è¯¯</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td>UBSan</td>
<td>æœªå®šä¹‰è¡Œä¸º</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td>TSAN</td>
<td>æ•°æ®ç«äº‰</td>
<td>âœ… æ˜¯</td>
</tr>
<tr>
<td>MSAN</td>
<td>æœªåˆå§‹åŒ–å†…å­˜ä½¿ç”¨</td>
<td>âœ… æ˜¯</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/25/cpp/gcc%E5%B1%9E%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/25/cpp/gcc%E5%B1%9E%E6%80%A7/" class="post-title-link" itemprop="url">gccå±æ€§</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-25 11:53:54" itemprop="dateCreated datePublished" datetime="2025-07-25T11:53:54+00:00">2025-07-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="attribute-visibility-default"><a href="#attribute-visibility-default" class="headerlink" title="__attribute__((__visibility__(&quot;default&quot;)))"></a><code>__attribute__((__visibility__(&quot;default&quot;)))</code></h2><p><code>__attribute__((__visibility__(&quot;default&quot;)))</code> æ˜¯ GCC ç¼–è¯‘å™¨çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºæ§åˆ¶ç¬¦å·çš„å¯è§æ€§ã€‚å®ƒæŒ‡å®šäº†ä¸€ä¸ªç¬¦å·ï¼ˆå¦‚å‡½æ•°æˆ–å˜é‡ï¼‰åœ¨å…±äº«åº“ä¸­çš„å¯è§æ€§ã€‚</p>
<h3 id="å«ä¹‰ï¼š"><a href="#å«ä¹‰ï¼š" class="headerlink" title="å«ä¹‰ï¼š"></a>å«ä¹‰ï¼š</h3><ul>
<li><strong><code>default</code> å¯è§æ€§</strong>ï¼š<ul>
<li>ç¬¦å·å¯ä»¥è¢«å…¶ä»–å…±äº«åº“æˆ–å¯æ‰§è¡Œæ–‡ä»¶è®¿é—®ã€‚</li>
<li>ç¬¦å·ä¼šè¢«å¯¼å‡ºåˆ°å…±äº«åº“çš„ç¬¦å·è¡¨ä¸­ã€‚</li>
</ul>
</li>
</ul>
<h3 id="ç”¨é€”ï¼š"><a href="#ç”¨é€”ï¼š" class="headerlink" title="ç”¨é€”ï¼š"></a>ç”¨é€”ï¼š</h3><ul>
<li><p>ç”¨äºæ˜¾å¼å¯¼å‡ºç¬¦å·ï¼Œä½¿å…¶åœ¨åŠ¨æ€é“¾æ¥æ—¶å¯è¢«å…¶ä»–æ¨¡å—ä½¿ç”¨ã€‚</p>
</li>
<li><p>åœ¨å…±äº«åº“ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ç¬¦å·æ˜¯ <code>default</code> å¯è§çš„ï¼Œä½†ä½¿ç”¨ <code>-fvisibility=hidden</code> ç¼–è¯‘é€‰é¡¹æ—¶ï¼Œæ‰€æœ‰ç¬¦å·ä¼šè¢«éšè—ï¼Œåªæœ‰æ˜¾å¼æ ‡è®°ä¸º <code>default</code> çš„ç¬¦å·æ‰ä¼šå¯¼å‡ºã€‚</p>
</li>
<li><p>ç¼–è¯‘å™¨ä¼˜åŒ–çš„å½±å“ï¼šå³ä½¿æ²¡æœ‰ <code>-fvisibility=hidden</code>ï¼ŒæŸäº›ç¼–è¯‘å™¨ä¼˜åŒ–ï¼ˆå¦‚ <code>-flto</code>ï¼‰å¯èƒ½ä¼šå½±å“ç¬¦å·çš„å¯¼å‡ºã€‚<br>æ˜¾å¼ä½¿ç”¨ <code>__attribute__((__visibility__(&quot;default&quot;)))</code> å¯ä»¥é¿å…è¿™äº›é—®é¢˜ã€‚</p>
</li>
</ul>
<h3 id="ç¤ºä¾‹ï¼š"><a href="#ç¤ºä¾‹ï¼š" class="headerlink" title="ç¤ºä¾‹ï¼š"></a>ç¤ºä¾‹ï¼š</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((__visibility__(<span class="string">&quot;default&quot;</span>)))</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">myFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Function implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤ç¡®è®¤ <code>myFunc</code> æ˜¯å¦åœ¨è¢«é“¾æ¥æ—¶å¯è§ï¼š</p>
<h3 id="æ–¹æ³•-1-ä½¿ç”¨-nm-å·¥å…·æ£€æŸ¥ç¬¦å·"><a href="#æ–¹æ³•-1-ä½¿ç”¨-nm-å·¥å…·æ£€æŸ¥ç¬¦å·" class="headerlink" title="æ–¹æ³• 1: ä½¿ç”¨ nm å·¥å…·æ£€æŸ¥ç¬¦å·"></a>æ–¹æ³• 1: ä½¿ç”¨ <code>nm</code> å·¥å…·æ£€æŸ¥ç¬¦å·</h3><p><code>nm</code> æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥åˆ—å‡ºç›®æ ‡æ–‡ä»¶æˆ–å…±äº«åº“ä¸­çš„ç¬¦å·è¡¨ã€‚</p>
<ol>
<li><p>æ£€æŸ¥ <code>libchip.so</code> ä¸­æ˜¯å¦å¯¼å‡ºäº† <code>myFunc</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nm -D libchip.so | grep myFunc</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœ <code>myFunc</code> å‡ºç°åœ¨è¾“å‡ºä¸­ï¼Œè¯´æ˜å®ƒè¢«å¯¼å‡ºå¹¶ä¸”å¯è§ã€‚</li>
<li>å¦‚æœæ²¡æœ‰å‡ºç°ï¼Œå¯èƒ½æ˜¯ç¬¦å·è¢«éšè—ï¼ˆä¾‹å¦‚ä½¿ç”¨äº† <code>-fvisibility=hidden</code>ï¼‰ã€‚</li>
</ul>
</li>
<li><p>å¦‚æœ <code>myFunc</code> æ²¡æœ‰å¯¼å‡ºï¼š</p>
<ul>
<li>ç¡®è®¤æ˜¯å¦åœ¨ä»£ç ä¸­ä½¿ç”¨äº† <code>__attribute__((__visibility__(&quot;default&quot;)))</code>ã€‚</li>
<li>ç¡®è®¤ç¼–è¯‘æ—¶æ˜¯å¦å¯ç”¨äº† <code>-fvisibility=hidden</code>ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h3 id="æ–¹æ³•-2-ä½¿ç”¨-readelf-æ£€æŸ¥åŠ¨æ€ç¬¦å·"><a href="#æ–¹æ³•-2-ä½¿ç”¨-readelf-æ£€æŸ¥åŠ¨æ€ç¬¦å·" class="headerlink" title="æ–¹æ³• 2: ä½¿ç”¨ readelf æ£€æŸ¥åŠ¨æ€ç¬¦å·"></a>æ–¹æ³• 2: ä½¿ç”¨ <code>readelf</code> æ£€æŸ¥åŠ¨æ€ç¬¦å·</h3><p><code>readelf</code> å¯ä»¥æ˜¾ç¤ºå…±äº«åº“çš„åŠ¨æ€ç¬¦å·è¡¨ã€‚</p>
<ol>
<li>æ£€æŸ¥ <code>libchip.so</code> çš„åŠ¨æ€ç¬¦å·è¡¨ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -Ws libchip.so | grep myFunc</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœ <code>myFunc</code> å‡ºç°åœ¨è¾“å‡ºä¸­ï¼Œè¯´æ˜å®ƒæ˜¯åŠ¨æ€å¯è§çš„ã€‚</li>
<li>å¦‚æœæ²¡æœ‰å‡ºç°ï¼Œè¯´æ˜ç¬¦å·è¢«éšè—ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h3 id="æ–¹æ³•-3-æ£€æŸ¥é“¾æ¥ä¾èµ–å…³ç³»"><a href="#æ–¹æ³•-3-æ£€æŸ¥é“¾æ¥ä¾èµ–å…³ç³»" class="headerlink" title="æ–¹æ³• 3: æ£€æŸ¥é“¾æ¥ä¾èµ–å…³ç³»"></a>æ–¹æ³• 3: æ£€æŸ¥é“¾æ¥ä¾èµ–å…³ç³»</h3><ol>
<li><p>æ£€æŸ¥ <code>libdbg.so</code> æ˜¯å¦å£°æ˜äº†å¯¹ <code>libchip.so</code> çš„ä¾èµ–ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -d libdbg.so | grep NEEDED</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœ <code>libchip.so</code> å‡ºç°åœ¨ <code>NEEDED</code> åˆ—è¡¨ä¸­ï¼Œè¯´æ˜ <code>libdbg.so</code>ä¾èµ– <code>libchip.so</code>ã€‚</li>
</ul>
</li>
<li><p>å¦‚æœ <code>libchip.so</code> åœ¨ä¾èµ–åˆ—è¡¨ä¸­ï¼Œä½†é“¾æ¥æ—¶ä»ç„¶æŠ¥é”™ï¼š</p>
<ul>
<li>ç¡®è®¤ <code>myFunc</code> æ˜¯å¦åœ¨ <code>libchip.so</code> ä¸­å¯¼å‡ºï¼ˆä½¿ç”¨ <code>nm</code> æˆ– <code>readelf</code> æ£€æŸ¥ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h3 id="æ–¹æ³•-4-æ£€æŸ¥é“¾æ¥å™¨é”™è¯¯"><a href="#æ–¹æ³•-4-æ£€æŸ¥é“¾æ¥å™¨é”™è¯¯" class="headerlink" title="æ–¹æ³• 4: æ£€æŸ¥é“¾æ¥å™¨é”™è¯¯"></a>æ–¹æ³• 4: æ£€æŸ¥é“¾æ¥å™¨é”™è¯¯</h3><p>å¦‚æœé“¾æ¥å™¨æŠ¥é”™ <code>undefined reference to myFunc</code>ï¼š</p>
<ul>
<li>ç¡®è®¤é“¾æ¥å‘½ä»¤æ˜¯å¦æ˜¾å¼åŒ…å« <code>libchip.so</code>ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -o executable main.o -L/path/to/libs -ldbg -lchip</span><br></pre></td></tr></table></figure></li>
<li>å¦‚æœæ²¡æœ‰æ˜¾å¼é“¾æ¥ <code>libchip.so</code>ï¼ŒåŠ¨æ€é“¾æ¥å™¨å¯èƒ½æ— æ³•è§£æ <code>myFunc</code>ã€‚</li>
</ul>
<hr>
<h3 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3><ul>
<li>ä½¿ç”¨ <code>nm</code> æˆ– <code>readelf</code> æ£€æŸ¥ <code>libchip.so</code> æ˜¯å¦å¯¼å‡ºäº† <code>myFunc</code>ã€‚</li>
<li>å¦‚æœç¬¦å·æœªå¯¼å‡ºï¼Œç¡®ä¿ä»£ç ä¸­ä½¿ç”¨äº† <code>__attribute__((__visibility__(&quot;default&quot;)))</code> å¹¶æ£€æŸ¥ç¼–è¯‘é€‰é¡¹ã€‚</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/07/23/cpp/shell%E8%AF%AF%E5%AF%BC%E6%80%A7%E9%94%99%E8%AF%AFNo-such-file-or-directory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/07/23/cpp/shell%E8%AF%AF%E5%AF%BC%E6%80%A7%E9%94%99%E8%AF%AFNo-such-file-or-directory/" class="post-title-link" itemprop="url">shell è¯¯å¯¼æ€§é”™è¯¯ No such file or directory</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-23 19:26:26" itemprop="dateCreated datePublished" datetime="2025-07-23T19:26:26+00:00">2025-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ğŸ“-ç°è±¡æè¿°"><a href="#ğŸ“-ç°è±¡æè¿°" class="headerlink" title="ğŸ“ ç°è±¡æè¿°"></a>ğŸ“ ç°è±¡æè¿°</h2><p>å½“ä½ è¿è¡Œä¸€ä¸ª ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ¯”å¦‚ä¸€ä¸ª 32-bit çš„ç¨‹åºï¼‰ï¼Œè€Œå®ƒä¾èµ–çš„ loader æˆ–å…±äº«åº“æ‰¾ä¸åˆ° æ—¶ï¼ŒShell ä¼šæç¤ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash: ./a.out: No such file or directory</span><br></pre></td></tr></table></figure>

<p>ä½†å…¶å®ï¼Œè¿™ä¸ªâ€œæ–‡ä»¶â€ç¡®å®å­˜åœ¨ï¼Œé—®é¢˜å‡ºåœ¨å®ƒ ä¾èµ–çš„ loader æ–‡ä»¶æˆ–åº“æ–‡ä»¶æ‰¾ä¸åˆ°ï¼Œè¿›è€Œå¯¼è‡´ execve() ç³»ç»Ÿè°ƒç”¨å¤±è´¥ã€‚</p>
<p>æˆ‘ä»¬ä» å†…æ ¸æ‰§è¡Œè·¯å¾„ è§’åº¦æ¥è§£æè¿™èƒŒåçš„åŸç†ã€‚</p>
<h2 id="ğŸ§ Linux-å†…éƒ¨é€»è¾‘è§£æ"><a href="#ğŸ§ Linux-å†…éƒ¨é€»è¾‘è§£æ" class="headerlink" title="ğŸ§ Linux å†…éƒ¨é€»è¾‘è§£æ"></a>ğŸ§ Linux å†…éƒ¨é€»è¾‘è§£æ</h2><ol>
<li>Shell è¿è¡Œç¨‹åºçš„è¿‡ç¨‹</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./my_app</span><br></pre></td></tr></table></figure>

<p>Shell å®é™…åšçš„æ˜¯è°ƒç”¨ execve() ç³»ç»Ÿè°ƒç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execve(<span class="string">&quot;./my_app&quot;</span>, argv, envp);</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ Linux åŠ è½½å¹¶è¿è¡Œä¸€ä¸ªç¨‹åºçš„å”¯ä¸€å…¥å£ã€‚</p>
<ol start="2">
<li>execve() åšäº†ä»€ä¹ˆï¼Ÿ</li>
</ol>
<p>å†…æ ¸æ‰§è¡Œ execve() æ—¶ï¼Œå®ƒä¼šï¼š</p>
<p>ğŸ”¹ Step 1: æ‰“å¼€å¹¶è¯»å– ELF å¤´ï¼ˆæ–‡ä»¶çš„å‰å‡ ä¸ªå­—èŠ‚ï¼‰<br>ä»è€Œåˆ¤æ–­è¿™æ˜¯ä¸€ä¸ª ELF å¯æ‰§è¡Œæ–‡ä»¶ã€è„šæœ¬ï¼Œè¿˜æ˜¯å…¶ä»–æ ¼å¼ã€‚</p>
<p>ğŸ”¹ Step 2: æ£€æŸ¥ ELF çš„æ¶æ„ä½æ•°ã€ABIã€åŠ¨æ€é“¾æ¥éœ€æ±‚<br>å¯¹äºåŠ¨æ€é“¾æ¥ç¨‹åºï¼Œå®ƒä¼šåœ¨ ELF å¤´ä¸­è¯»å–å¦‚ä¸‹å­—æ®µï¼š</p>
<ul>
<li>e_ident[EI_CLASS]: 32-bit æˆ– 64-bit</li>
<li>e_interpreter: è¿™æ˜¯æœ€å…³é”®çš„ï¼</li>
</ul>
<ol start="3">
<li>e_interpreter æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ol>
<p>è¿™æ˜¯ ELF æ–‡ä»¶é‡Œå®šä¹‰çš„ â€œç¨‹åºè§£é‡Šå™¨è·¯å¾„â€ï¼ˆinterpreter pathï¼‰ã€‚å³è¿™ä¸ªç¨‹åºè¿è¡Œæ—¶ï¼Œç³»ç»Ÿéœ€è¦å…ˆåŠ è½½è°æ¥å¸®å®ƒåŠ è½½å‰©ä¸‹çš„åŠ¨æ€åº“ã€‚</p>
<p>å¯ä»¥é€šè¿‡ <code>readelf -l my_app</code> æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -l ./my_app | grep interpreter</span><br><span class="line"></span><br><span class="line">[Requesting program interpreter: /lib/ld-linux.so.2]</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚ï¼š<code>/lib/ld-linux.so.2</code> æ˜¯ 32-bit ç¨‹åºä½¿ç”¨çš„ loaderã€‚</p>
<ol start="4">
<li>å¦‚æœè¿™ä¸ª loader ä¸å­˜åœ¨ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
</ol>
<ul>
<li>execve() å°è¯•æ‰“å¼€ ELF æŒ‡å®šçš„è§£é‡Šå™¨ï¼ˆ&#x2F;lib&#x2F;ld-linux.so.2ï¼‰</li>
<li>å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œopen() å¤±è´¥</li>
<li>æ•´ä¸ª execve() è°ƒç”¨å¤±è´¥</li>
<li>é”™è¯¯ä»£ç æ˜¯ ENOENTï¼ˆ2ï¼‰ï¼Œä»£è¡¨ï¼š</li>
</ul>
<blockquote>
<p>â€œNo such file or directoryâ€</p>
</blockquote>
<p>ä½†è¿™å¹¶ä¸æ˜¯è¯´ ä½ è¿è¡Œçš„é‚£ä¸ªæ–‡ä»¶ .&#x2F;my_app ä¸å­˜åœ¨ï¼Œè€Œæ˜¯ å®ƒä¾èµ–çš„è§£é‡Šå™¨ä¸åœ¨ç³»ç»Ÿä¸­ï¼Œå¯¼è‡´æ•´ä¸ªæ‰§è¡Œå¤±è´¥ã€‚</p>
<h2 id="ğŸ¤¯-ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯¯å¯¼ï¼Ÿ"><a href="#ğŸ¤¯-ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯¯å¯¼ï¼Ÿ" class="headerlink" title="ğŸ¤¯ ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯¯å¯¼ï¼Ÿ"></a>ğŸ¤¯ ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯¯å¯¼ï¼Ÿ</h2><p>å› ä¸º shellï¼ˆbash&#x2F;zshï¼‰è°ƒç”¨ execve() å¤±è´¥åï¼Œåªçœ‹åˆ°äº† errno &#x3D; ENOENTï¼Œå®ƒé»˜è®¤è§£é‡Šä¸ºï¼š</p>
<blockquote>
<p>â€œä½ æŒ‡å®šçš„é‚£ä¸ªæ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨â€</p>
</blockquote>
<p>è€Œä¸æ˜¯æ›´æ·±å±‚æ¬¡çš„ï¼š</p>
<blockquote>
<p>â€œæ–‡ä»¶å­˜åœ¨ï¼Œä½†å®ƒéœ€è¦çš„ loader ä¸å­˜åœ¨â€</p>
</blockquote>
<p>è¿™æ˜¯ shell çš„ å†å²é—ç•™è¡Œä¸ºï¼Œæ²¡æœ‰ç»†åˆ† errno èƒŒåè¯­ä¹‰ã€‚</p>
<h2 id="ğŸ§ª-ä¸¾ä¸ªå®é™…ä¾‹å­"><a href="#ğŸ§ª-ä¸¾ä¸ªå®é™…ä¾‹å­" class="headerlink" title="ğŸ§ª ä¸¾ä¸ªå®é™…ä¾‹å­"></a>ğŸ§ª ä¸¾ä¸ªå®é™…ä¾‹å­</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ file ./a.out</span><br><span class="line">./a.out: ELF 32-bit LSB executable, Intel 80386, ...</span><br><span class="line"></span><br><span class="line">$ readelf -l ./a.out | grep interpreter</span><br><span class="line">[Requesting program interpreter: /lib/ld-linux.so.2]</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> /lib/ld-linux.so.2</span><br><span class="line"><span class="built_in">ls</span>: cannot access <span class="string">&#x27;/lib/ld-linux.so.2&#x27;</span>: No such file or directory</span><br><span class="line"></span><br><span class="line">$ ./a.out</span><br><span class="line">bash: ./a.out: No such file or directory  âŒ</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šæ˜¯ ç¼ºå°‘è§£é‡Šå™¨ <code>/lib/ld-linux.so.2</code>ï¼Œè€Œä¸æ˜¯ a.out æœ¬èº«ã€‚</p>
<h2 id="âœ…-æ€»ç»“"><a href="#âœ…-æ€»ç»“" class="headerlink" title="âœ… æ€»ç»“"></a>âœ… æ€»ç»“</h2><table>
<thead>
<tr>
<th>å±‚çº§</th>
<th>è¡Œä¸º</th>
</tr>
</thead>
<tbody><tr>
<td>ç”¨æˆ·</td>
<td>è¾“å…¥ <code>./prog</code></td>
</tr>
<tr>
<td>Shell</td>
<td>è°ƒç”¨ <code>execve(&quot;./prog&quot;, ...)</code></td>
</tr>
<tr>
<td>å†…æ ¸</td>
<td>è§£æ ELFï¼Œå‘ç° <code>interpreter</code> æ˜¯ <code>/lib/ld-linux.so.2</code></td>
</tr>
<tr>
<td>å†…æ ¸</td>
<td>æ‰¾ä¸åˆ°è§£é‡Šå™¨ï¼Œè¿”å› <code>ENOENT</code></td>
</tr>
<tr>
<td>Shell</td>
<td>æŠ¥ <code>No such file or directory</code> âŒï¼ˆè¯¯å¯¼æ€§ï¼‰</td>
</tr>
</tbody></table>
<h2 id="ğŸ› ï¸-Bonusï¼šç¼–è¯‘-32-bit-ç¨‹åº"><a href="#ğŸ› ï¸-Bonusï¼šç¼–è¯‘-32-bit-ç¨‹åº" class="headerlink" title="ğŸ› ï¸ Bonusï¼šç¼–è¯‘ 32-bit ç¨‹åº"></a>ğŸ› ï¸ Bonusï¼šç¼–è¯‘ 32-bit ç¨‹åº</h2><ol>
<li>ç¼–å†™ä¸€ä¸ªç®€å•çš„ C ç¨‹åº</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello from 32-bit program!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–è¯‘æˆ 32 bit ç¨‹åº</li>
</ol>
<p>éœ€è¦å…ˆå®‰è£… 32-bit ç¼–è¯‘æ”¯æŒï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install gcc-multilib</span><br></pre></td></tr></table></figure>

<p>ç„¶åç¼–è¯‘ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 hello.c -o hello32</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>éªŒè¯æ˜¯å¦æ˜¯ 32-bit ELF å¯æ‰§è¡Œæ–‡ä»¶</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file hello32</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºåº”ç±»ä¼¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello32: ELF 32-bit LSB executable, Intel 80386, ...</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/04/16/dlfcn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/04/16/dlfcn/" class="post-title-link" itemprop="url">dlfcn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-16 00:20:34" itemprop="dateCreated datePublished" datetime="2025-04-16T00:20:34+00:00">2025-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight cpp"><figcaption><span>Makefile</span><a href="/blog/downloads/code/dlfcn/Makefile">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CXX = g++</span><br><span class="line">CXXFLAGS = -fPIC -Wall -Wextra</span><br><span class="line">LDFLAGS = -shared</span><br><span class="line"></span><br><span class="line">all: main libhello.so</span><br><span class="line"></span><br><span class="line">main: main.cpp</span><br><span class="line">	$(CXX) main.cpp -o main -ldl</span><br><span class="line"></span><br><span class="line">libhello.so: hello.cpp</span><br><span class="line">	$(CXX) $(CXXFLAGS) $(LDFLAGS) hello.cpp -o libhello.so</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -f main libhello.</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>main.cpp</span><a href="/blog/downloads/code/dlfcn/main.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*HelloFunc)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// æ‰“å¼€å…±äº«åº“</span></span><br><span class="line">    <span class="type">void</span>* handle = <span class="built_in">dlopen</span>(<span class="string">&quot;./libhello.so&quot;</span>, RTLD_LAZY);</span><br><span class="line">    <span class="keyword">if</span> (!handle) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;dlopen failed: &quot;</span> &lt;&lt; <span class="built_in">dlerror</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤ä¹‹å‰çš„é”™è¯¯</span></span><br><span class="line">    <span class="built_in">dlerror</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    HelloFunc hello = (HelloFunc)<span class="built_in">dlsym</span>(handle, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* dlsym_error = <span class="built_in">dlerror</span>();</span><br><span class="line">    <span class="keyword">if</span> (dlsym_error) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;dlsym failed: &quot;</span> &lt;&lt; dlsym_error &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">dlclose</span>(handle);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å°å‡½æ•°åœ°å€</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Address of hello function: &quot;</span> &lt;&lt; <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(hello) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨å‡½æ•°</span></span><br><span class="line">    <span class="built_in">hello</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­å…±äº«åº“</span></span><br><span class="line">    <span class="built_in">dlclose</span>(handle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/03/19/cpp/%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/03/19/cpp/%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F/" class="post-title-link" itemprop="url">åŸå­å˜é‡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-03-19 16:31:02" itemprop="dateCreated datePublished" datetime="2025-03-19T16:31:02+00:00">2025-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>å½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŸå­å˜é‡æ—¶ï¼Œä»¥ä¸‹æ“ä½œä¼šå‘ç”Ÿï¼š</p>
<p>åŸå­æ€§ï¼šåŸå­å˜é‡çš„ä¿®æ”¹æ˜¯åŸå­çš„ï¼Œå³æ¯æ¬¡ä¿®æ”¹éƒ½æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ“ä½œã€‚è¿™æ„å‘³ç€åœ¨ä»»ä½•æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸåœ°ä¿®æ”¹åŸå­å˜é‡ï¼Œè€Œä¸ä¼šå‡ºç°ç«äº‰æ¡ä»¶ã€‚</p>
<p>åŒæ­¥æœºåˆ¶ï¼šåŸå­å˜é‡ä½¿ç”¨ç¡¬ä»¶çº§åˆ«çš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é”ã€æ¯”è¾ƒå¹¶äº¤æ¢æ“ä½œç­‰ï¼‰æ¥ç¡®ä¿ä¿®æ”¹çš„åŸå­æ€§ã€‚è¿™äº›æœºåˆ¶ç¡®ä¿çº¿ç¨‹åœ¨ä¿®æ”¹åŸå­å˜é‡æ—¶ä¸ä¼šå¹²æ‰°å…¶ä»–çº¿ç¨‹çš„æ“ä½œã€‚</p>
<p>å†…å­˜å¯è§æ€§ï¼šåŸå­å˜é‡çš„ä¿®æ”¹ä¼šç¡®ä¿å†…å­˜å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹å¯¹åŸå­å˜é‡çš„ä¿®æ”¹ä¼šç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚è¿™æ„å‘³ç€å…¶ä»–çº¿ç¨‹å¯ä»¥çœ‹åˆ°æœ€æ–°çš„ä¿®æ”¹ç»“æœï¼Œè€Œä¸ä¼šè¯»å–åˆ°è¿‡æ—¶çš„æ•°æ®ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸå­å˜é‡ <code>std::atomic&lt;int&gt; counter</code>ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ <code>counter++</code> æ“ä½œï¼š</p>
<figure class="highlight cpp"><figcaption><span>atomic1.cpp</span><a href="/blog/downloads/code/atomic/atomic1.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">counter</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        counter++;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final counter value: &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p>
<p>ä¸¤ä¸ªçº¿ç¨‹ t1 å’Œ t2 åŒæ—¶æ‰§è¡Œ increment å‡½æ•°ï¼Œå°è¯•ä¿®æ”¹åŸå­å˜é‡ counterã€‚<br>åŸå­æ€§ ç¡®ä¿æ¯æ¬¡ <code>counter++</code> æ“ä½œéƒ½æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œé¿å…ç«äº‰æ¡ä»¶ã€‚<br>åŒæ­¥æœºåˆ¶ ç¡®ä¿ä¸¤ä¸ªçº¿ç¨‹ä¸ä¼šåŒæ—¶ä¿®æ”¹ counterï¼Œè€Œæ˜¯ä¸€ä¸ªçº¿ç¨‹æˆåŠŸä¿®æ”¹åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ‰èƒ½ç»§ç»­ä¿®æ”¹ã€‚<br>å†…å­˜å¯è§æ€§ ç¡®ä¿ counter çš„æœ€æ–°å€¼å¯¹ä¸¤ä¸ªçº¿ç¨‹éƒ½æ˜¯å¯è§çš„ã€‚</p>
<h2 id="å®ç°æœºåˆ¶"><a href="#å®ç°æœºåˆ¶" class="headerlink" title="å®ç°æœºåˆ¶"></a>å®ç°æœºåˆ¶</h2><p>è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨ä¸€ä¸‹ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŸå­å˜é‡æ—¶çš„åº•å±‚æœºåˆ¶ã€‚</p>
<ol>
<li><p>åŸå­æ“ä½œçš„ç¡¬ä»¶æ”¯æŒ<br>åŸå­æ“ä½œé€šå¸¸ç”±ç¡¬ä»¶æŒ‡ä»¤æ”¯æŒï¼Œè¿™äº›æŒ‡ä»¤ç¡®ä¿æ“ä½œçš„åŸå­æ€§ã€‚ä¾‹å¦‚ï¼Œx86æ¶æ„æä¾›äº† <code>LOCK</code> å‰ç¼€ï¼Œç”¨äºç¡®ä¿æŒ‡ä»¤åœ¨å¤šå¤„ç†å™¨ç¯å¢ƒä¸­çš„åŸå­æ€§ã€‚å¸¸è§çš„åŸå­æŒ‡ä»¤åŒ…æ‹¬ <code>LOCK XADD</code>ï¼ˆåŸå­åŠ æ³•ï¼‰å’Œ <code>LOCK CMPXCHG</code>ï¼ˆåŸå­æ¯”è¾ƒå¹¶äº¤æ¢ï¼‰ã€‚</p>
</li>
<li><p>ç¼“å­˜ä¸€è‡´æ€§åè®®<br>å¤šæ ¸å¤„ç†å™¨ä½¿ç”¨ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚<code>MESI</code>åè®®ï¼‰æ¥ç¡®ä¿å„ä¸ªå¤„ç†å™¨ç¼“å­˜ä¸­çš„æ•°æ®ä¸€è‡´æ€§ã€‚å½“ä¸€ä¸ªå¤„ç†å™¨ä¿®æ”¹åŸå­å˜é‡æ—¶ï¼Œç¼“å­˜ä¸€è‡´æ€§åè®®ä¼šç¡®ä¿å…¶ä»–å¤„ç†å™¨çš„ç¼“å­˜ä¸­å¯¹åº”çš„æ•°æ®æ— æ•ˆæˆ–æ›´æ–°ã€‚</p>
</li>
<li><p>å†…å­˜å±éšœ<br>å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰æ˜¯ä¸€ç§æŒ‡ä»¤ï¼Œç”¨äºé˜²æ­¢ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹å†…å­˜æ“ä½œè¿›è¡Œé‡æ’åºã€‚åŸå­æ“ä½œé€šå¸¸ä¼šä½¿ç”¨å†…å­˜å±éšœæ¥ç¡®ä¿æ“ä½œçš„é¡ºåºæ€§å’Œå¯è§æ€§ã€‚ä¾‹å¦‚ï¼Œ<code>std::atomic</code> åœ¨å®ç°æ—¶ä¼šä½¿ç”¨å†…å­˜å±éšœæ¥ç¡®ä¿æ“ä½œçš„æ­£ç¡®æ€§ã€‚</p>
</li>
<li><p>æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCASï¼‰<br>æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCompare-And-Swap, CASï¼‰æ˜¯ä¸€ç§å¸¸ç”¨çš„åŸå­æ“ä½œï¼Œå®ƒé€šè¿‡æ¯”è¾ƒå˜é‡çš„å½“å‰å€¼å’Œé¢„æœŸå€¼ï¼Œå¦‚æœç›¸ç­‰åˆ™æ›´æ–°å˜é‡çš„å€¼ã€‚CASæ“ä½œæ˜¯æ— é”ç¼–ç¨‹çš„åŸºç¡€ï¼Œç”¨äºå®ç°è®¸å¤šå¹¶å‘æ•°æ®ç»“æ„ã€‚</p>
</li>
<li><p>ä¼ªä»£ç ç¤ºä¾‹<br>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä¼ªä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºäº†CASæ“ä½œçš„å·¥ä½œåŸç†ï¼š</p>
</li>
</ol>
<figure class="highlight cpp"><figcaption><span>cas_mock.cpp</span><a href="/blog/downloads/code/atomic/cas_mock.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">compare_and_swap</span><span class="params">(<span class="type">int</span>* ptr, <span class="type">int</span> old_value, <span class="type">int</span> new_value)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (*ptr == old_value) {</span><br><span class="line">        *ptr = new_value;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼ŒCASæ“ä½œå¯ä»¥ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸä¿®æ”¹å˜é‡çš„å€¼ï¼Œè€Œå…¶ä»–çº¿ç¨‹ä¼šå¤±è´¥å¹¶é‡è¯•ã€‚</p>
<ol start="6">
<li>å®é™…åº”ç”¨<br>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒåŸå­å˜é‡çš„æ“ä½œå¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</li>
</ol>
<figure class="highlight cpp"><figcaption><span>atomic2.cpp</span><a href="/blog/downloads/code/atomic/atomic2.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">counter</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        <span class="type">int</span> expected = counter.<span class="built_in">load</span>();</span><br><span class="line">        <span class="keyword">while</span> (!counter.<span class="built_in">compare_exchange_weak</span>(expected, expected + <span class="number">1</span>)) {</span><br><span class="line">            <span class="comment">// é‡è¯•ï¼Œç›´åˆ°æˆåŠŸ</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final counter value: &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œcompare_exchange_weak ä½¿ç”¨CASæ“ä½œæ¥ç¡®ä¿ counter çš„åŸå­æ€§ä¿®æ”¹ã€‚æ¯æ¬¡ä¿®æ”¹å¤±è´¥æ—¶ï¼Œçº¿ç¨‹ä¼šé‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚</p>
<h3 id="ç¼“å­˜ä¸€è‡´æ€§åè®®"><a href="#ç¼“å­˜ä¸€è‡´æ€§åè®®" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§åè®®"></a>ç¼“å­˜ä¸€è‡´æ€§åè®®</h3><p>ç¼“å­˜ä¸€è‡´æ€§åè®®æ˜¯ç¡®ä¿å¤šæ ¸å¤„ç†å™¨ä¸­å„ä¸ªç¼“å­˜ä¹‹é—´æ•°æ®ä¸€è‡´æ€§çš„æœºåˆ¶ã€‚æœ€å¸¸è§çš„ç¼“å­˜ä¸€è‡´æ€§åè®®æ˜¯MESIåè®®ã€‚è®©æˆ‘ä»¬è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚</p>
<p><strong>MESIåè®®</strong></p>
<p>MESIåè®®æ˜¯ç”±å››ç§çŠ¶æ€ç»„æˆçš„ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œæ¯ä¸ªç¼“å­˜è¡Œï¼ˆCache Lineï¼‰å¯ä»¥å¤„äºä»¥ä¸‹å››ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p>
<ul>
<li>Modifiedï¼ˆä¿®æ”¹ï¼‰ï¼šç¼“å­˜è¡Œä¸­çš„æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œä¸ä¸»å†…å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä¸”è¯¥æ•°æ®ä»…å­˜åœ¨äºå½“å‰ç¼“å­˜ä¸­ã€‚</li>
<li>Exclusiveï¼ˆç‹¬å ï¼‰ï¼šç¼“å­˜è¡Œä¸­çš„æ•°æ®ä¸ä¸»å†…å­˜ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œä¸”è¯¥æ•°æ®ä»…å­˜åœ¨äºå½“å‰ç¼“å­˜ä¸­ã€‚</li>
<li>Sharedï¼ˆå…±äº«ï¼‰ï¼šç¼“å­˜è¡Œä¸­çš„æ•°æ®ä¸ä¸»å†…å­˜ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œä¸”è¯¥æ•°æ®å¯èƒ½å­˜åœ¨äºå¤šä¸ªç¼“å­˜ä¸­ã€‚</li>
<li>Invalidï¼ˆæ— æ•ˆï¼‰ï¼šç¼“å­˜è¡Œä¸­çš„æ•°æ®æ— æ•ˆã€‚</li>
</ul>
<p><strong>çŠ¶æ€è½¬æ¢</strong></p>
<p>ç¼“å­˜è¡Œçš„çŠ¶æ€ä¼šæ ¹æ®ä¸åŒçš„æ“ä½œè¿›è¡Œè½¬æ¢ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„çŠ¶æ€è½¬æ¢ï¼š</p>
<p>ä»ä¸»å†…å­˜è¯»å–æ•°æ®ï¼šå¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äºInvalidçŠ¶æ€ï¼Œå½“ä¸€ä¸ªå¤„ç†å™¨è¯»å–è¯¥æ•°æ®æ—¶ï¼Œç¼“å­˜è¡Œä¼šå˜ä¸ºSharedæˆ–ExclusiveçŠ¶æ€ã€‚<br>ä¿®æ”¹æ•°æ®ï¼šå¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äºSharedæˆ–ExclusiveçŠ¶æ€ï¼Œå½“ä¸€ä¸ªå¤„ç†å™¨ä¿®æ”¹è¯¥æ•°æ®æ—¶ï¼Œç¼“å­˜è¡Œä¼šå˜ä¸ºModifiedçŠ¶æ€ï¼Œå¹¶é€šçŸ¥å…¶ä»–ç¼“å­˜å°†è¯¥ç¼“å­˜è¡Œç½®ä¸ºInvalidçŠ¶æ€ã€‚<br>å†™å›æ•°æ®ï¼šå¦‚æœä¸€ä¸ªç¼“å­˜è¡Œå¤„äºModifiedçŠ¶æ€ï¼Œå½“è¯¥ç¼“å­˜è¡Œè¢«æ›¿æ¢æ—¶ï¼Œæ•°æ®ä¼šè¢«å†™å›ä¸»å†…å­˜ï¼Œç¼“å­˜è¡Œå˜ä¸ºInvalidçŠ¶æ€ã€‚</p>
<p><strong>å·¥ä½œåŸç†</strong></p>
<p>å‡è®¾æœ‰ä¸‰ä¸ªå¤„ç†å™¨Aã€Bå’ŒCï¼Œå®ƒä»¬å„è‡ªæœ‰è‡ªå·±çš„ç¼“å­˜ã€‚ä¸»å†…å­˜ä¸­æœ‰ä¸€ä¸ªå˜é‡xï¼Œåˆå§‹å€¼ä¸º0ã€‚</p>
<p>è¯»å–æ•°æ®ï¼š</p>
<p>å¤„ç†å™¨Aä»ä¸»å†…å­˜è¯»å–xï¼Œç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºExclusiveã€‚<br>å¤„ç†å™¨Bä»ä¸»å†…å­˜è¯»å–xï¼Œå¤„ç†å™¨Aæ£€æµ‹åˆ°å†²çªï¼Œå°†ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºSharedï¼Œå¤„ç†å™¨Bçš„ç¼“å­˜è¡ŒçŠ¶æ€ä¹Ÿå˜ä¸ºSharedã€‚<br>ä¿®æ”¹æ•°æ®ï¼š</p>
<p>å¤„ç†å™¨Aä¿®æ”¹xï¼Œç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºModifiedï¼Œå¹¶é€šçŸ¥å¤„ç†å™¨Bå°†å…¶ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºInvalidã€‚<br>å¤„ç†å™¨Bå°è¯•è¯»å–xæ—¶ï¼Œæ£€æµ‹åˆ°ç¼“å­˜è¡Œæ— æ•ˆï¼Œä»ä¸»å†…å­˜é‡æ–°è¯»å–æ•°æ®ã€‚</p>
<p>å†™å›æ•°æ®ï¼š</p>
<p>å¤„ç†å™¨Aå°†ä¿®æ”¹åçš„æ•°æ®å†™å›ä¸»å†…å­˜ï¼Œç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºInvalidã€‚</p>
<p><strong>ä¼˜åŒ–å’Œé—®é¢˜</strong></p>
<p>ç¼“å­˜ä¸€è‡´æ€§åè®®é€šè¿‡æ€»çº¿å—…æ¢ï¼ˆBus Snoopingï¼‰å’ŒçŠ¶æ€æœºæœºåˆ¶æ¥å®ç°æ•°æ®çš„ä¸€è‡´æ€§ï¼Œä½†ä¹Ÿä¼šå¼•å…¥ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¦‚æ€»çº¿å¸¦å®½å‹åŠ›å’Œå¤„ç†å™¨ç­‰å¾…æ—¶é—´ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œç°ä»£å¤„ç†å™¨å¼•å…¥äº†å­˜å‚¨ç¼“å†²åŒºï¼ˆStore Bufferï¼‰å’Œå†™å›ç­–ç•¥ï¼ˆWrite Backï¼‰ç­‰ä¼˜åŒ–æŠ€æœ¯ã€‚</p>
<h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><p>æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCompare-And-Swap, CASï¼‰æ“ä½œåœ¨å¹¶å‘ç¼–ç¨‹ä¸­æœ‰è®¸å¤šå¥½å¤„ï¼š</p>
<ol>
<li><p>æ— é”ç¼–ç¨‹<br>CASæ“ä½œæ˜¯æ— é”ç¼–ç¨‹çš„åŸºç¡€ï¼Œå®ƒå…è®¸å¤šä¸ªçº¿ç¨‹åœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹å®‰å…¨åœ°ä¿®æ”¹å…±äº«æ•°æ®ã€‚æ— é”ç¼–ç¨‹å¯ä»¥å‡å°‘é”çš„å¼€é”€ï¼Œé¿å…æ­»é”ï¼Œæé«˜ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚</p>
</li>
<li><p>åŸå­æ€§<br>CASæ“ä½œæ˜¯åŸå­çš„ï¼Œå³å®ƒç¡®ä¿æ¯”è¾ƒå’Œäº¤æ¢æ“ä½œåœ¨ç¡¬ä»¶çº§åˆ«ä¸Šæ˜¯ä¸å¯åˆ†å‰²çš„ã€‚è¿™æ„å‘³ç€åœ¨ä»»ä½•æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸåœ°ä¿®æ”¹å˜é‡çš„å€¼ï¼Œé¿å…ç«äº‰æ¡ä»¶ã€‚</p>
</li>
<li><p>é«˜æ•ˆæ€§<br>CASæ“ä½œé€šå¸¸ç”±ç¡¬ä»¶æŒ‡ä»¤æ”¯æŒï¼ˆå¦‚x86æ¶æ„ä¸­çš„ LOCK CMPXCHG æŒ‡ä»¤ï¼‰ï¼Œè¿™äº›æŒ‡ä»¤éå¸¸é«˜æ•ˆï¼Œèƒ½å¤Ÿå¿«é€Ÿå®Œæˆæ¯”è¾ƒå’Œäº¤æ¢æ“ä½œã€‚ç›¸æ¯”äºä½¿ç”¨é”ï¼ŒCASæ“ä½œçš„å¼€é”€æ›´ä½ã€‚</p>
</li>
<li><p>å¯æ‰©å±•æ€§<br>CASæ“ä½œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶å°è¯•ä¿®æ”¹å˜é‡ï¼Œè€Œä¸ä¼šé˜»å¡å…¶ä»–çº¿ç¨‹ã€‚è¿™ç§ç‰¹æ€§ä½¿å¾—CASæ“ä½œåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸­å…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ï¼Œèƒ½å¤Ÿå¤„ç†å¤§é‡çº¿ç¨‹çš„å¹¶å‘è®¿é—®ã€‚</p>
</li>
<li><p>å®ç°å¤æ‚çš„å¹¶å‘æ•°æ®ç»“æ„<br>CASæ“ä½œå¯ä»¥ç”¨äºå®ç°å¤æ‚çš„å¹¶å‘æ•°æ®ç»“æ„ï¼Œå¦‚æ— é”é˜Ÿåˆ—ã€æ— é”æ ˆç­‰ã€‚è¿™äº›æ•°æ®ç»“æ„èƒ½å¤Ÿåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸­æä¾›é«˜æ•ˆçš„æ“ä½œï¼Œè€Œä¸ä¼šå¼•å…¥é”çš„å¼€é”€ã€‚</p>
</li>
</ol>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨CASæ“ä½œå®ç°æ— é”è®¡æ•°å™¨çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><figcaption><span>cas_counter.cpp</span><a href="/blog/downloads/code/atomic/cas_counter.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">counter</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        <span class="type">int</span> expected = counter.<span class="built_in">load</span>();</span><br><span class="line">        <span class="keyword">while</span> (!counter.<span class="built_in">compare_exchange_weak</span>(expected, expected + <span class="number">1</span>)) {</span><br><span class="line">            <span class="comment">// é‡è¯•ï¼Œç›´åˆ°æˆåŠŸ</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final counter value: &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œcompare_exchange_weak ä½¿ç”¨CASæ“ä½œæ¥ç¡®ä¿ counter çš„åŸå­æ€§ä¿®æ”¹ã€‚æ¯æ¬¡ä¿®æ”¹å¤±è´¥æ—¶ï¼Œçº¿ç¨‹ä¼šé‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚</p>
<h4 id="compare-exchange-weak-å’Œ-fetch-add"><a href="#compare-exchange-weak-å’Œ-fetch-add" class="headerlink" title="compare_exchange_weak å’Œ fetch_add"></a>compare_exchange_weak å’Œ fetch_add</h4><p>compare_exchange_weak å’Œ fetch_add æ˜¯ä¸¤ç§ä¸åŒçš„åŸå­æ“ä½œï¼Œå®ƒä»¬åœ¨åŠŸèƒ½å’Œä½¿ç”¨åœºæ™¯ä¸Šæœ‰æ˜æ˜¾çš„åŒºåˆ«ã€‚è®©æˆ‘ä»¬è¯¦ç»†è§£é‡Šä¸€ä¸‹å®ƒä»¬çš„åŒºåˆ«ä»¥åŠå¦‚ä½•é€‰æ‹©ã€‚</p>
<h5 id="compare-exchange-weak"><a href="#compare-exchange-weak" class="headerlink" title="compare_exchange_weak"></a>compare_exchange_weak</h5><p>åŠŸèƒ½ï¼š</p>
<p>compare_exchange_weak æ˜¯ä¸€ç§CASï¼ˆCompare-And-Swapï¼‰æ“ä½œï¼Œç”¨äºæ¯”è¾ƒåŸå­å˜é‡çš„å½“å‰å€¼ä¸é¢„æœŸå€¼ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™å°†æ–°å€¼å­˜å‚¨åˆ°å˜é‡ä¸­ï¼Œå¹¶è¿”å› trueï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¿”å› false å¹¶æ›´æ–°é¢„æœŸå€¼ã€‚<br>è¯¥æ“ä½œå…è®¸å¶å°”çš„å¤±è´¥ï¼ˆå³ä½¿å½“å‰å€¼ä¸é¢„æœŸå€¼ç›¸ç­‰ï¼Œä¹Ÿå¯èƒ½è¿”å› falseï¼‰ï¼Œè¿™åœ¨ä¸€äº›å¾ªç¯ç®—æ³•ä¸­æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<p>é€‚ç”¨äºéœ€è¦åœ¨å¾ªç¯ä¸­åå¤å°è¯•æ›´æ–°å˜é‡çš„åœºæ™¯ï¼Œä¾‹å¦‚å®ç°æ— é”æ•°æ®ç»“æ„ï¼ˆå¦‚æ— é”é˜Ÿåˆ—ã€æ ˆç­‰ï¼‰ã€‚<br>åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸­ï¼Œcompare_exchange_weak é€šå¸¸æ¯” compare_exchange_strong æ€§èƒ½æ›´é«˜ï¼Œå› ä¸ºå®ƒå…è®¸å¶å°”çš„å¤±è´¥ï¼Œä»è€Œå‡å°‘äº†æ€»çº¿é”å®šçš„å¼€é”€.</p>
<h5 id="fetch-add"><a href="#fetch-add" class="headerlink" title="fetch_add"></a>fetch_add</h5><p>åŠŸèƒ½ï¼š</p>
<p>fetch_add æ˜¯ä¸€ç§åŸå­åŠ æ³•æ“ä½œï¼Œå®ƒå°†ç»™å®šçš„å€¼åŠ åˆ°åŸå­å˜é‡çš„å½“å‰å€¼ä¸­ï¼Œå¹¶è¿”å›å˜é‡çš„æ—§å€¼ã€‚<br>è¯¥æ“ä½œæ˜¯åŸå­çš„ï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä¸ä¼šå‡ºç°ç«äº‰æ¡ä»¶ã€‚</p>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<p>é€‚ç”¨äºç®€å•çš„è®¡æ•°å™¨æˆ–ç´¯åŠ å™¨åœºæ™¯ï¼Œä¾‹å¦‚ç»Ÿè®¡è®¿é—®æ¬¡æ•°ã€ç´¯åŠ æ€»å’Œç­‰ã€‚<br>åœ¨éœ€è¦å¯¹å˜é‡è¿›è¡Œç®€å•çš„åŠ æ³•æ“ä½œæ—¶ï¼Œfetch_add æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„é€‰æ‹©2.</p>
<h5 id="å¦‚ä½•é€‰æ‹©"><a href="#å¦‚ä½•é€‰æ‹©" class="headerlink" title="å¦‚ä½•é€‰æ‹©"></a>å¦‚ä½•é€‰æ‹©</h5><p>é€‰æ‹© compare_exchange_weak è¿˜æ˜¯ fetch_add å–å†³äºå…·ä½“çš„ä½¿ç”¨åœºæ™¯å’Œéœ€æ±‚ï¼š</p>
<p>å¦‚æœéœ€è¦å®ç°å¤æ‚çš„æ— é”æ•°æ®ç»“æ„ï¼ˆå¦‚æ— é”é˜Ÿåˆ—ã€æ ˆç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦åå¤å°è¯•æ›´æ–°å˜é‡ï¼Œé€‰æ‹© compare_exchange_weakã€‚<br>å¦‚æœéœ€è¦å¯¹å˜é‡è¿›è¡Œç®€å•çš„åŠ æ³•æ“ä½œï¼ˆå¦‚è®¡æ•°å™¨ã€ç´¯åŠ å™¨ï¼‰ï¼Œé€‰æ‹© fetch_addã€‚<br>ç¤ºä¾‹ä»£ç <br>ä»¥ä¸‹æ˜¯ä½¿ç”¨ compare_exchange_weak å’Œ fetch_add çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<p>compare_exchange_weak ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><figcaption><span>compare_exchange_weak_eg.cpp</span><a href="/blog/downloads/code/atomic/compare_exchange_weak_eg.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">counter</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        <span class="type">int</span> expected = counter.<span class="built_in">load</span>();</span><br><span class="line">        <span class="keyword">while</span> (!counter.<span class="built_in">compare_exchange_weak</span>(expected, expected + <span class="number">1</span>)) {</span><br><span class="line">            <span class="comment">// é‡è¯•ï¼Œç›´åˆ°æˆåŠŸ</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final counter value: &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>fetch_add ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><figcaption><span>fetch_add_eg.cpp</span><a href="/blog/downloads/code/atomic/fetch_add_eg.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">counter</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        counter.<span class="built_in">fetch_add</span>(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final counter value: &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>


<p>å¦‚æœæˆ‘ä»¬åªéœ€è¦ç®€å•åœ°é€’å¢è®¡æ•°å™¨ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–æ¡ä»¶é™åˆ¶ï¼Œfetch_add ç¡®å®æ˜¯ä¸€ä¸ªæ›´ç›´æ¥å’Œé«˜æ•ˆçš„é€‰æ‹©ã€‚fetch_add èƒ½å¤Ÿç¡®ä¿æ¯æ¬¡é€’å¢æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œé¿å…äº†ç«äº‰æ¡ä»¶ã€‚</p>
<p>ç„¶è€Œï¼Œåœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œcompare_exchange_weak å¯èƒ½æ›´ä¸ºåˆé€‚ã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬éœ€è¦åŸºäºç‰¹å®šæ¡ä»¶è¿›è¡Œæ›´æ–°æ—¶ï¼Œcompare_exchange_weak å¯ä»¥ç¡®ä¿åªæœ‰åœ¨æ»¡è¶³æ¡ä»¶æ—¶æ‰è¿›è¡Œæ›´æ–°æ“ä½œã€‚</p>
<p>ç¤ºä¾‹ï¼šåŸºäºæ¡ä»¶çš„æ›´æ–°<br>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œéœ€è¦åœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶è¿›è¡Œé€’å¢æ“ä½œï¼š</p>
<figure class="highlight cpp"><figcaption><span>cas_case.cpp</span><a href="/blog/downloads/code/atomic/cas_case.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">counter</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">conditional_increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        <span class="type">int</span> expected = counter.<span class="built_in">load</span>();</span><br><span class="line">        <span class="keyword">while</span> (expected &lt; <span class="number">500</span> &amp;&amp; !counter.<span class="built_in">compare_exchange_weak</span>(expected, expected + <span class="number">1</span>)) {</span><br><span class="line">            <span class="comment">// é‡è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–æ¡ä»¶ä¸æ»¡è¶³</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(conditional_increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(conditional_increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final counter value: &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰å½“ counter çš„å€¼å°äº500æ—¶ï¼Œæ‰ä¼šè¿›è¡Œé€’å¢æ“ä½œã€‚compare_exchange_weak ç¡®ä¿æ¡ä»¶æ›´æ–°çš„åŸå­æ€§å’Œå®‰å…¨æ€§ã€‚</p>
<p>ä½¿ç”¨ fetch_add çš„åœºæ™¯<br>å¦‚æœæˆ‘ä»¬ä¸éœ€è¦åŸºäºæ¡ä»¶è¿›è¡Œæ›´æ–°ï¼Œåªæ˜¯ç®€å•åœ°é€’å¢è®¡æ•°å™¨ï¼Œé‚£ä¹ˆ fetch_add æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼š</p>
<figure class="highlight cpp"><figcaption><span>fetch_add_case.cpp</span><a href="/blog/downloads/code/atomic/fetch_add_case.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">counter</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        counter.<span class="built_in">fetch_add</span>(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final counter value: &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œfetch_add ç¡®ä¿æ¯æ¬¡é€’å¢æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œé¿å…äº†ç«äº‰æ¡ä»¶ã€‚</p>
<p>æ€»ç»“æ¥è¯´ï¼Œå¦‚æœä½ çš„æ“ä½œåªæ˜¯ç®€å•çš„é€’å¢ï¼Œfetch_add æ˜¯æ›´é«˜æ•ˆçš„é€‰æ‹©ï¼›å¦‚æœéœ€è¦åŸºäºæ¡ä»¶è¿›è¡Œæ›´æ–°ï¼Œcompare_exchange_weak åˆ™æ›´ä¸ºåˆé€‚ã€‚</p>
<h4 id="ABA"><a href="#ABA" class="headerlink" title="ABA"></a>ABA</h4><p>ABAé—®é¢˜åœ¨å¹¶å‘ç¼–ç¨‹ä¸­æ˜¯ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨CASï¼ˆCompare-And-Swapï¼‰æ“ä½œæ—¶ã€‚ABAé—®é¢˜çš„æœ¬è´¨æ˜¯ä¸€ä¸ªå˜é‡çš„å€¼åœ¨ä¸¤æ¬¡æ¯”è¾ƒä¹‹é—´å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æœ€ç»ˆå€¼åˆå›åˆ°äº†åŸå§‹å€¼ï¼Œå¯¼è‡´CASæ“ä½œæ— æ³•æ£€æµ‹åˆ°è¿™ç§å˜åŒ–ã€‚ä¸ºäº†é¿å…ABAé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ç‰ˆæœ¬å·æˆ–æ ‡è®°çš„åŸå­å¼•ç”¨ï¼Œä¾‹å¦‚ AtomicStampedReferenceã€‚</p>
<p>ç¤ºä¾‹ï¼šä½¿ç”¨ AtomicStampedReference é¿å…ABAé—®é¢˜<br>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ AtomicStampedReference é¿å…ABAé—®é¢˜çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><figcaption><span>atomic_stamped_reference.cpp</span><a href="/blog/downloads/code/atomic/atomic_stamped_reference.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">counter</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">stamp</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">conditional_increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        <span class="type">int</span> expected = counter.<span class="built_in">load</span>();</span><br><span class="line">        <span class="type">int</span> expected_stamp = stamp.<span class="built_in">load</span>();</span><br><span class="line">        <span class="keyword">while</span> (expected &lt; <span class="number">500</span> &amp;&amp; !counter.<span class="built_in">compare_exchange_weak</span>(expected, expected + <span class="number">1</span>) &amp;&amp; !stamp.<span class="built_in">compare_exchange_weak</span>(expected_stamp, expected_stamp + <span class="number">1</span>)) {</span><br><span class="line">            <span class="comment">// é‡è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–æ¡ä»¶ä¸æ»¡è¶³</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(conditional_increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(conditional_increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final counter value: &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final stamp value: &quot;</span> &lt;&lt; stamp &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªé¢å¤–çš„ stamp å˜é‡æ¥è®°å½•æ¯æ¬¡æ›´æ–°çš„ç‰ˆæœ¬å·ã€‚æ¯æ¬¡æ›´æ–° counter æ—¶ï¼ŒåŒæ—¶æ›´æ–° stampã€‚è¿™æ ·ï¼Œå³ä½¿ counter çš„å€¼å›åˆ°äº†åŸå§‹å€¼ï¼Œstamp çš„å€¼ä¹Ÿä¼šä¸åŒï¼Œä»è€Œé¿å…äº†ABAé—®é¢˜ã€‚</p>
<p>è§£é‡Š<br>ç‰ˆæœ¬å·ï¼šæ¯æ¬¡æ›´æ–° counter æ—¶ï¼ŒåŒæ—¶æ›´æ–° stampï¼Œç¡®ä¿æ¯æ¬¡æ›´æ–°éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç‰ˆæœ¬å·ã€‚<br>CASæ“ä½œï¼šä½¿ç”¨ compare_exchange_weak ç¡®ä¿ counter å’Œ stamp çš„æ›´æ–°æ˜¯åŸå­çš„ã€‚<br>é‡è¯•æœºåˆ¶ï¼šå¦‚æœCASæ“ä½œå¤±è´¥ï¼Œçº¿ç¨‹ä¼šé‡è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–æ¡ä»¶ä¸æ»¡è¶³ã€‚<br>è¿™ç§æ–¹æ³•é€šè¿‡å¼•å…¥ç‰ˆæœ¬å·æˆ–æ ‡è®°ï¼Œç¡®ä¿å³ä½¿å˜é‡çš„å€¼å›åˆ°äº†åŸå§‹å€¼ï¼Œç‰ˆæœ¬å·ä¹Ÿä¼šä¸åŒï¼Œä»è€Œé¿å…äº†ABAé—®é¢˜ã€‚</p>
<p>ABAé—®é¢˜ä¸ä»…å­˜åœ¨äºCASæ“ä½œä¸­ï¼Œè¿˜å¯èƒ½åœ¨å…¶ä»–å¹¶å‘ç¼–ç¨‹åœºæ™¯ä¸­å‡ºç°ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½å‡ºç°ABAé—®é¢˜çš„æƒ…æ™¯ï¼š</p>
<ol>
<li><p>åŒé‡æ£€æŸ¥é”å®šï¼ˆDouble-Checked Lockingï¼‰<br>åœ¨åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼ä¸­ï¼ŒABAé—®é¢˜å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯çš„åˆ¤æ–­ã€‚ä¾‹å¦‚ï¼Œåœ¨åˆå§‹åŒ–å•ä¾‹å¯¹è±¡æ—¶ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ£€æŸ¥å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œå¹¶ä¸”ä¸€ä¸ªçº¿ç¨‹åœ¨æ£€æŸ¥åç«‹å³åˆ›å»ºå¯¹è±¡ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨æ£€æŸ¥åå‘ç°å¯¹è±¡å·²ç»è¢«åˆ›å»ºå¹¶ä¸”å†æ¬¡æ£€æŸ¥æ—¶å‘ç°å¯¹è±¡ä¸ºç©ºï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯çš„åˆå§‹åŒ–ã€‚</p>
</li>
<li><p>æ— é”é˜Ÿåˆ—å’Œæ ˆ<br>åœ¨æ— é”é˜Ÿåˆ—å’Œæ ˆçš„å®ç°ä¸­ï¼ŒABAé—®é¢˜å¯èƒ½ä¼šå¯¼è‡´èŠ‚ç‚¹çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå‡ºç°é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¼šæ’å…¥å’Œåˆ é™¤ç›¸åŒçš„èŠ‚ç‚¹ï¼Œå¯¼è‡´ç¬¬ä¸€ä¸ªçº¿ç¨‹æ— æ³•æ­£ç¡®åˆ¤æ–­èŠ‚ç‚¹çš„çŠ¶æ€ã€‚</p>
</li>
<li><p>ç‰ˆæœ¬æ§åˆ¶<br>åœ¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­ï¼ŒABAé—®é¢˜å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯çš„ç‰ˆæœ¬åˆ¤æ–­ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨æ£€æŸ¥ç‰ˆæœ¬å·æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¼šæ›´æ–°ç‰ˆæœ¬å·å¹¶ä¸”å†æ¬¡æ›´æ–°å›åŸå§‹ç‰ˆæœ¬å·ï¼Œå¯¼è‡´ç¬¬ä¸€ä¸ªçº¿ç¨‹æ— æ³•æ­£ç¡®åˆ¤æ–­ç‰ˆæœ¬æ˜¯å¦è¢«ä¿®æ”¹ã€‚</p>
</li>
</ol>
<p>è§£å†³æ–¹æ¡ˆ<br>ä¸ºäº†é¿å…ABAé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š</p>
<p>ç‰ˆæœ¬å·æˆ–æ ‡è®°ï¼šä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ ‡è®°æ¥è®°å½•æ¯æ¬¡æ›´æ–°çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ AtomicStampedReference æ¥ç¡®ä¿æ¯æ¬¡æ›´æ–°éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç‰ˆæœ¬å·ã€‚<br>æ—¶é—´æˆ³ï¼šä½¿ç”¨æ—¶é—´æˆ³æ¥è®°å½•æ¯æ¬¡æ›´æ–°çš„æ—¶é—´ï¼Œç¡®ä¿æ¯æ¬¡æ›´æ–°éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´æ ‡è®°ã€‚<br>é€»è¾‘æ—¶é’Ÿï¼šä½¿ç”¨é€»è¾‘æ—¶é’Ÿæ¥è®°å½•æ¯æ¬¡æ›´æ–°çš„é¡ºåºï¼Œç¡®ä¿æ¯æ¬¡æ›´æ–°éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„é¡ºåºæ ‡è®°ã€‚<br>ç¤ºä¾‹ï¼šä½¿ç”¨ AtomicStampedReference é¿å…ABAé—®é¢˜<br>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ AtomicStampedReference é¿å…ABAé—®é¢˜çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><figcaption><span>atomic_stamped_reference.java</span><a href="/blog/downloads/code/atomic/atomic_stamped_reference.java">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicStampedReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ABAExample</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicStampedReference&lt;Integer&gt; atomicStampedRef = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> atomicStampedRef.getStamp();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> atomicStampedRef.getReference();</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 1 initial value: &quot;</span> + value + <span class="string">&quot;, stamp: &quot;</span> + stamp);</span><br><span class="line">            atomicStampedRef.compareAndSet(value, value + <span class="number">1</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 1 updated value: &quot;</span> + atomicStampedRef.getReference() + <span class="string">&quot;, stamp: &quot;</span> + atomicStampedRef.getStamp());</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> atomicStampedRef.getStamp();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> atomicStampedRef.getReference();</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 2 initial value: &quot;</span> + value + <span class="string">&quot;, stamp: &quot;</span> + stamp);</span><br><span class="line">            atomicStampedRef.compareAndSet(value, value + <span class="number">1</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 2 updated value: &quot;</span> + atomicStampedRef.getReference() + <span class="string">&quot;, stamp: &quot;</span> + atomicStampedRef.getStamp());</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒAtomicStampedReference ä½¿ç”¨ç‰ˆæœ¬å·æ¥é¿å…ABAé—®é¢˜ï¼Œç¡®ä¿æ¯æ¬¡æ›´æ–°éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç‰ˆæœ¬å·ã€‚</p>
<p>C++ æ ‡å‡†åº“ä¸­æ²¡æœ‰ç›´æ¥ç­‰åŒäº Java çš„ AtomicStampedReference çš„ç±»ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ç»„åˆ std::atomic å’Œè‡ªå®šä¹‰ç»“æ„ä½“æ¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ C++ ä¸­å®ç°å¸¦æœ‰ç‰ˆæœ¬å·çš„åŸå­å¼•ç”¨ï¼Œä»¥é¿å… ABA é—®é¢˜ï¼š</p>
<p>ç¤ºä¾‹ï¼šå®ç°å¸¦æœ‰ç‰ˆæœ¬å·çš„åŸå­å¼•ç”¨</p>
<figure class="highlight cpp"><figcaption><span>cas_with_version.cpp</span><a href="/blog/downloads/code/atomic/cas_with_version.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">StampedValue</span> {</span><br><span class="line">    <span class="type">int</span> value;</span><br><span class="line">    <span class="type">int</span> stamp;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">std::atomic&lt;StampedValue&gt; atomicStampedValue{StampedValue{<span class="number">0</span>, <span class="number">0</span>}};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) {</span><br><span class="line">        StampedValue expected = atomicStampedValue.<span class="built_in">load</span>();</span><br><span class="line">        StampedValue newValue;</span><br><span class="line">        <span class="keyword">do</span> {</span><br><span class="line">            newValue = {expected.value + <span class="number">1</span>, expected.stamp + <span class="number">1</span>};</span><br><span class="line">        } <span class="keyword">while</span> (!atomicStampedValue.<span class="built_in">compare_exchange_weak</span>(expected, newValue));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(increment)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    StampedValue finalValue = atomicStampedValue.<span class="built_in">load</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Final value: &quot;</span> &lt;&lt; finalValue.value &lt;&lt; <span class="string">&quot;, Final stamp: &quot;</span> &lt;&lt; finalValue.stamp &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>è§£é‡Š<br>StampedValue ç»“æ„ä½“ï¼šåŒ…å«ä¸€ä¸ªå€¼å’Œä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆæˆ–æ—¶é—´æˆ³ï¼‰ã€‚<br>std::atomicï¼šä½¿ç”¨ std::atomic åŒ…è£… StampedValue ç»“æ„ä½“ï¼Œä»¥ç¡®ä¿åŸå­æ€§æ“ä½œã€‚<br>compare_exchange_weakï¼šåœ¨æ›´æ–°å€¼å’Œç‰ˆæœ¬å·æ—¶ä½¿ç”¨ CAS æ“ä½œï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§å’Œé¿å… ABA é—®é¢˜ã€‚<br>ä½¿ç”¨åœºæ™¯<br>è¿™ç§æ–¹æ³•é€‚ç”¨äºéœ€è¦é¿å… ABA é—®é¢˜çš„åœºæ™¯ï¼Œä¾‹å¦‚æ— é”é˜Ÿåˆ—ã€æ— é”æ ˆç­‰å¤æ‚å¹¶å‘æ•°æ®ç»“æ„ã€‚</p>
<h4 id="compare-exchange-weak-å’Œ-compare-exchange-strong"><a href="#compare-exchange-weak-å’Œ-compare-exchange-strong" class="headerlink" title="compare_exchange_weak å’Œ compare_exchange_strong"></a>compare_exchange_weak å’Œ compare_exchange_strong</h4><p>åŒºåˆ«<br>å¯é æ€§ï¼š</p>
<p>compare_exchange_weakï¼šå…è®¸å¶å°”å¤±è´¥ï¼Œå³ä½¿å½“å‰å€¼ä¸æœŸæœ›å€¼ç›¸ç­‰ï¼Œä¹Ÿå¯èƒ½è¿”å› falseã€‚è¿™ç§è®¾è®¡æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ï¼Œé€‚ç”¨äºå¾ªç¯ä¸­çš„è‡ªæ—‹é”ç­‰åœºæ™¯ã€‚<br>compare_exchange_strongï¼šä¿è¯æ“ä½œæˆåŠŸï¼Œå¦‚æœå½“å‰å€¼ä¸æœŸæœ›å€¼ç›¸ç­‰ï¼Œåˆ™ä¸€å®šè¿”å› trueã€‚é€‚ç”¨äºéœ€è¦ç¡®ä¿æ“ä½œæˆåŠŸçš„åœºæ™¯ã€‚<br>æ€§èƒ½ï¼š</p>
<p>compare_exchange_weakï¼šé€šå¸¸æ¯” compare_exchange_strong æ€§èƒ½æ›´é«˜ï¼Œå› ä¸ºå®ƒå…è®¸å¶å°”å¤±è´¥ã€‚<br>compare_exchange_strongï¼šåœ¨æŸäº›å¹³å°ä¸Šæ€§èƒ½å¯èƒ½è¾ƒä½ï¼Œå› ä¸ºå®ƒéœ€è¦ç¡®ä¿æ“ä½œæˆåŠŸã€‚<br>é€‚ç”¨åœºæ™¯<br>compare_exchange_weakï¼š</p>
<ul>
<li>é€‚ç”¨äºå¾ªç¯ä¸­çš„è‡ªæ—‹é”ã€‚</li>
<li>é€‚ç”¨äºé«˜æ€§èƒ½è¦æ±‚çš„åœºæ™¯ã€‚</li>
</ul>
<p>compare_exchange_strongï¼š</p>
<ul>
<li>é€‚ç”¨äºéœ€è¦ç¡®ä¿æ“ä½œæˆåŠŸçš„åœºæ™¯ã€‚</li>
<li>é€‚ç”¨äºçº¿ç¨‹åŒæ­¥ã€‚</li>
</ul>
<p>compare_exchange_weak å…è®¸è™šå‡å¤±è´¥çš„åº•å±‚å®ç°åŸºäº CASï¼ˆCompare-And-Swapï¼‰ æ“ä½œå’Œç¡¬ä»¶æŒ‡ä»¤çš„ç‰¹æ€§ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£é‡Šï¼š</p>
<p>CASæ“ä½œ<br>CAS æ“ä½œæœ‰ä¸‰ä¸ªå‚æ•°ï¼šå†…å­˜åœ°å€ã€é¢„æœŸå€¼å’Œæ–°å€¼ã€‚å…¶åŸºæœ¬åŸç†æ˜¯ï¼š</p>
<p>æ¯”è¾ƒå†…å­˜åœ°å€ä¸­çš„å€¼æ˜¯å¦ä¸é¢„æœŸå€¼ç›¸ç­‰ã€‚<br>å¦‚æœç›¸ç­‰ï¼Œåˆ™å°†å†…å­˜åœ°å€ä¸­çš„å€¼æ›´æ–°ä¸ºæ–°å€¼ã€‚<br>å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œï¼Œå¹¶è¿”å›å½“å‰å†…å­˜åœ°å€ä¸­çš„å€¼ã€‚<br>è™šå‡å¤±è´¥çš„åŸå› <br>compare_exchange_weak å…è®¸è™šå‡å¤±è´¥ï¼Œå³ä½¿å½“å‰å€¼ä¸é¢„æœŸå€¼ç›¸ç­‰ï¼Œä¹Ÿå¯èƒ½è¿”å› falseã€‚è¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿåœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p>
<p>ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼š</p>
<p>åœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œç¼“å­˜ä¸€è‡´æ€§åè®®å¯èƒ½å¯¼è‡´ CAS æ“ä½œå¤±è´¥ï¼Œå³ä½¿å†…å­˜ä¸­çš„å€¼æ²¡æœ‰æ”¹å˜ã€‚ä¾‹å¦‚ï¼Œåœ¨ ARM æ¶æ„ä¸­ï¼Œä½¿ç”¨ LDXR&#x2F;STXR æŒ‡ä»¤æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯¹åŒä¸€ç¼“å­˜è¡Œçš„è®¿é—®å¯èƒ½å¯¼è‡´ CAS æ“ä½œå¤±è´¥1ã€‚<br>ç¡¬ä»¶æŒ‡ä»¤çš„å®ç°ï¼š</p>
<p>åœ¨æŸäº›å¹³å°ä¸Šï¼ŒCAS æ“ä½œå¯èƒ½è¢«å®ç°ä¸ºå•æ¬¡ LL&#x2F;SCï¼ˆLoad-Linked&#x2F;Store-Conditionalï¼‰å°è¯•ã€‚è¿™ç§å®ç°å…è®¸ CAS æ“ä½œå¶å°”å¤±è´¥ï¼Œä»¥æé«˜æ€§èƒ½</p>
<p>ä¸ºä»€ä¹ˆcompare_exchange_strongä¸è¢«ç”¨äºå®ç°è‡ªæ—‹é”ï¼Ÿ<br>Copilot said:<br>Copilot<br>compare_exchange_strong é€šå¸¸ä¸ç”¨äºå®ç°è‡ªæ—‹é”ï¼Œä¸»è¦åŸå› åœ¨äºå…¶æ€§èƒ½å’Œè®¾è®¡ç›®çš„ï¼š</p>
<p>æ€§èƒ½<br>compare_exchange_strong ä¿è¯æ“ä½œæˆåŠŸï¼Œå¦‚æœå½“å‰å€¼ä¸é¢„æœŸå€¼ç›¸ç­‰ï¼Œåˆ™ä¸€å®šè¿”å› true1ã€‚è¿™ç§ä¿è¯éœ€è¦æ›´å¤šçš„ç¡¬ä»¶èµ„æºå’Œæ—¶é—´æ¥å®Œæˆæ“ä½œï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™1ã€‚<br>compare_exchange_weak å…è®¸å¶å°”å¤±è´¥ï¼Œå³ä½¿å½“å‰å€¼ä¸é¢„æœŸå€¼ç›¸ç­‰ï¼Œä¹Ÿå¯èƒ½è¿”å› false1ã€‚è¿™ç§è®¾è®¡å‡å°‘äº†ç¡¬ä»¶èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜äº†æ€§èƒ½1ã€‚<br>è®¾è®¡ç›®çš„<br>è‡ªæ—‹é” çš„è®¾è®¡ç›®çš„æ˜¯åœ¨çŸ­æ—¶é—´å†…é¢‘ç¹å°è¯•è·å–é”ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´ç­‰å¾…ã€‚å› æ­¤ï¼Œè‡ªæ—‹é”æ›´é€‚åˆä½¿ç”¨ compare_exchange_weakï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨å¤±è´¥æ—¶å¿«é€Ÿé‡è¯•1ã€‚<br>compare_exchange_strong æ›´é€‚åˆéœ€è¦ç¡®ä¿æ“ä½œæˆåŠŸçš„åœºæ™¯ï¼Œå¦‚çº¿ç¨‹åŒæ­¥1ã€‚åœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œæ“ä½œçš„æˆåŠŸç‡æ¯”æ€§èƒ½æ›´é‡è¦ã€‚<br>ä»£ç ç¤ºä¾‹<br>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ compare_exchange_weak å®ç°è‡ªæ—‹é”çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight cpp"><figcaption><span>cas_spin_lock.cpp</span><a href="/blog/downloads/code/atomic/cas_spin_lock.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SpinLock</span> {</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::atomic&lt;<span class="type">bool</span>&gt; flag = {<span class="literal">false</span>};</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="type">bool</span> expected = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (!flag.<span class="built_in">compare_exchange_weak</span>(expected, <span class="literal">true</span>, std::memory_order_acquire)) {</span><br><span class="line">            expected = <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span> </span>{</span><br><span class="line">        flag.<span class="built_in">store</span>(<span class="literal">false</span>, std::memory_order_release);</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcompare_exchange_weak è¢«ç”¨æ¥å®ç°è‡ªæ—‹é”ï¼Œå› ä¸ºå®ƒåœ¨å¤±è´¥æ—¶å¯ä»¥å¿«é€Ÿé‡è¯•ï¼Œä»è€Œæé«˜æ€§èƒ½</p>
<h3 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h3><p>å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸ºå†…å­˜æ …æ ï¼ˆMemory Fenceï¼‰æˆ–å†…å­˜å›´æ ï¼ˆMemory Fenceï¼‰ï¼Œæ˜¯ä¸€ç§ç¡¬ä»¶æˆ–è½¯ä»¶çš„åŒæ­¥æœºåˆ¶ï¼Œç”¨äºåœ¨å¹¶å‘ç³»ç»Ÿä¸­ä¿æŒå†…å­˜æ“ä½œçš„é¡ºåºæ€§ã€‚è¿™æ˜¯å¤šæ ¸å’Œå¤šçº¿ç¨‹ç¯å¢ƒä¸­è‡³å…³é‡è¦çš„ï¼Œå› ä¸ºç°ä»£å¤„ç†å™¨ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºä»¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p><strong>å†…å­˜å±éšœçš„ä½œç”¨</strong></p>
<ul>
<li><p>é˜²æ­¢æŒ‡ä»¤é‡æ’åºï¼š</p>
<p>  ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä»¥ä¼˜åŒ–æ€§èƒ½ã€‚å†…å­˜å±éšœç¡®ä¿ç‰¹å®šçš„å†…å­˜æ“ä½œåœ¨å±éšœä¹‹å‰å®Œæˆï¼Œè€Œä¸ä¼šè¢«é‡æ’åºåˆ°å±éšœä¹‹åã€‚</p>
</li>
<li><p>ä¿è¯å†…å­˜å¯è§æ€§ï¼š</p>
<p>  åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹å†…å­˜çš„ä¿®æ”¹å¿…é¡»å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚å†…å­˜å±éšœç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚</p>
</li>
</ul>
<p><strong>ç±»å‹</strong></p>
<ul>
<li><p>åŠ è½½å±éšœï¼ˆLoad Barrierï¼‰ï¼š</p>
<p>  ç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰åŠ è½½æ“ä½œå®Œæˆåï¼Œæ‰å¼€å§‹æ‰§è¡Œå±éšœä¹‹åçš„åŠ è½½æ“ä½œã€‚</p>
</li>
<li><p>å­˜å‚¨å±éšœï¼ˆStore Barrierï¼‰ï¼š</p>
<p>  ç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰å­˜å‚¨æ“ä½œå®Œæˆåï¼Œæ‰å¼€å§‹æ‰§è¡Œå±éšœä¹‹åçš„å­˜å‚¨æ“ä½œã€‚</p>
</li>
<li><p>å…¨å±éšœï¼ˆFull Barrierï¼‰ï¼š</p>
<p>  ç»“åˆäº†åŠ è½½å±éšœå’Œå­˜å‚¨å±éšœçš„åŠŸèƒ½ï¼Œç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰åŠ è½½å’Œå­˜å‚¨æ“ä½œå®Œæˆåï¼Œæ‰å¼€å§‹æ‰§è¡Œå±éšœä¹‹åçš„åŠ è½½å’Œå­˜å‚¨æ“ä½œã€‚</p>
</li>
</ul>
<p><strong>ä»£ç ç¤ºä¾‹</strong></p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨å†…å­˜å±éšœï¼š</p>
<figure class="highlight cpp"><figcaption><span>memory_barrier.cpp</span><a href="/blog/downloads/code/atomic/memory_barrier.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; a{<span class="number">0</span>};</span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; b{<span class="number">0</span>};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>{</span><br><span class="line">    a.<span class="built_in">store</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">    std::<span class="built_in">atomic_thread_fence</span>(std::memory_order_seq_cst);  <span class="comment">// å…¨å±éšœ</span></span><br><span class="line">    b.<span class="built_in">store</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (b.<span class="built_in">load</span>(std::memory_order_relaxed) == <span class="number">0</span>);</span><br><span class="line">    std::<span class="built_in">atomic_thread_fence</span>(std::memory_order_seq_cst);  <span class="comment">// å…¨å±éšœ</span></span><br><span class="line">    <span class="built_in">assert</span>(a.<span class="built_in">load</span>(std::memory_order_relaxed) == <span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œstd::atomic_thread_fence ç”¨äºæ’å…¥å†…å­˜å±éšœï¼Œç¡®ä¿åœ¨å±éšœä¹‹å‰çš„å­˜å‚¨æ“ä½œå®Œæˆåï¼Œæ‰å¼€å§‹æ‰§è¡Œå±éšœä¹‹åçš„å­˜å‚¨æ“ä½œ</p>
<h3 id="å†…å­˜åº"><a href="#å†…å­˜åº" class="headerlink" title="å†…å­˜åº"></a>å†…å­˜åº</h3><p>å†…å­˜åºï¼ˆMemory Orderï¼‰æè¿°äº†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå†…å­˜æ“ä½œçš„é¡ºåºå’Œå¯è§æ€§ã€‚å®ƒå†³å®šäº†ä¸€ä¸ªçº¿ç¨‹å¯¹å†…å­˜çš„ä¿®æ”¹ä½•æ—¶ä»¥åŠå¦‚ä½•å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚C++11 å¼•å…¥äº†å…­ç§å†…å­˜åºï¼Œä»¥ä¾¿ç¨‹åºå‘˜åœ¨å¹¶å‘ç¼–ç¨‹ä¸­æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„åŒæ­¥æœºåˆ¶ã€‚</p>
<p>å…­ç§å†…å­˜åº</p>
<ul>
<li><p>memory_order_relaxedï¼š</p>
<p>  åªä¿è¯å½“å‰æ“ä½œçš„åŸå­æ€§ï¼Œä¸è€ƒè™‘çº¿ç¨‹é—´çš„åŒæ­¥ã€‚é€‚ç”¨äºä¸éœ€è¦åŒæ­¥çš„åœºæ™¯ï¼Œå¦‚è®¡æ•°å™¨çš„å¢åŠ ã€‚</p>
</li>
<li><p>memory_order_consumeï¼š</p>
<p>  ç¡®ä¿å½“å‰æ“ä½œä¾èµ–çš„æ‰€æœ‰å†™æ“ä½œåœ¨æ­¤æ“ä½œä¹‹å‰å®Œæˆã€‚ä¸»è¦ç”¨äºä¾èµ–å…³ç³»è¾ƒå¼ºçš„åœºæ™¯ã€‚</p>
</li>
<li><p>memory_order_acquireï¼š</p>
<p>  ç¡®ä¿åœ¨æ­¤æ“ä½œä¹‹åçš„æ‰€æœ‰è¯»å†™æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°æ­¤æ“ä½œä¹‹å‰ã€‚å¸¸ç”¨äºè·å–é”çš„æ“ä½œã€‚</p>
</li>
<li><p>memory_order_releaseï¼š</p>
<p>  ç¡®ä¿åœ¨æ­¤æ“ä½œä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°æ­¤æ“ä½œä¹‹åã€‚å¸¸ç”¨äºé‡Šæ”¾é”çš„æ“ä½œã€‚</p>
</li>
<li><p>memory_order_acq_relï¼š</p>
<p>  ç»“åˆäº† acquire å’Œ release çš„è¯­ä¹‰ï¼Œç¡®ä¿åœ¨æ­¤æ“ä½œä¹‹å‰çš„å†™æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°æ­¤æ“ä½œä¹‹åï¼ŒåŒæ—¶åœ¨æ­¤æ“ä½œä¹‹åçš„è¯»æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°æ­¤æ“ä½œä¹‹å‰ã€‚é€‚ç”¨äºè¯»-ä¿®æ”¹-å†™æ“ä½œã€‚</p>
</li>
<li><p>memory_order_seq_cstï¼š</p>
<p>  é¡ºåºä¸€è‡´æ€§ï¼Œç¡®ä¿æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„å†…å­˜æ“ä½œé¡ºåºä¸€è‡´ã€‚è¿™æ˜¯æœ€ä¸¥æ ¼çš„å†…å­˜åºï¼Œé€‚ç”¨äºéœ€è¦å¼ºä¸€è‡´æ€§çš„åœºæ™¯ã€‚</p>
</li>
</ul>
<p><strong>ä»£ç ç¤ºä¾‹</strong></p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä¸åŒçš„å†…å­˜åºï¼š</p>
<figure class="highlight cpp"><figcaption><span>memory_order.cpp</span><a href="/blog/downloads/code/atomic/memory_order.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::atomic&lt;<span class="type">int</span>&gt; data{<span class="number">0</span>};</span><br><span class="line">std::atomic&lt;<span class="type">bool</span>&gt; ready{<span class="literal">false</span>};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">producer</span><span class="params">()</span> </span>{</span><br><span class="line">    data.<span class="built_in">store</span>(<span class="number">42</span>, std::memory_order_relaxed);</span><br><span class="line">    ready.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_release);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">consumer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (!ready.<span class="built_in">load</span>(std::memory_order_acquire));</span><br><span class="line">    <span class="built_in">assert</span>(data.<span class="built_in">load</span>(std::memory_order_relaxed) == <span class="number">42</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(producer)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(consumer)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œproducer çº¿ç¨‹ä½¿ç”¨ memory_order_release æ¥å‘å¸ƒæ•°æ®ï¼Œè€Œ consumer çº¿ç¨‹ä½¿ç”¨ memory_order_acquire æ¥ç¡®ä¿è¯»å–åˆ°çš„æ•°æ®æ˜¯æœ€æ–°çš„</p>
<p>TODO</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/02/24/TCL%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/02/24/TCL%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">TCLå…¥é—¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-02-24 16:03:38" itemprop="dateCreated datePublished" datetime="2025-02-24T16:03:38+00:00">2025-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TCL-Main"><a href="#TCL-Main" class="headerlink" title="TCL_Main"></a>TCL_Main</h2><p><code>Tcl_Main</code>çš„ç®€åŒ–æµç¨‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Tcl_Main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[], Tcl_AppInitProc *appInitProc)</span> </span>&#123;</span><br><span class="line">    Tcl_Interp *interp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ Tcl è§£é‡Šå™¨</span></span><br><span class="line">    interp = <span class="built_in">Tcl_CreateInterp</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨åº”ç”¨ç¨‹åºåˆå§‹åŒ–å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> ((*appInitProc)(interp) != TCL_OK) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Application initialization failed: %s\n&quot;</span>, <span class="built_in">Tcl_GetStringResult</span>(interp));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿›å…¥ Tcl äº‹ä»¶å¾ªç¯</span></span><br><span class="line">    <span class="built_in">Tcl_MainLoop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="èŠ±æ‹¬å·çš„ç”¨æ³•"><a href="#èŠ±æ‹¬å·çš„ç”¨æ³•" class="headerlink" title="èŠ±æ‹¬å·çš„ç”¨æ³•"></a>èŠ±æ‹¬å·çš„ç”¨æ³•</h2><p>åœ¨Tclä¸­ï¼ŒèŠ±æ‹¬å· <code>&#123;&#125;</code> æœ‰å¤šç§ç”¨æ³•ï¼Œä¸»è¦ç”¨äºåˆ†ç»„ã€å»¶è¿Ÿè§£æã€åˆ›å»ºåˆ—è¡¨å’Œå­—å…¸ç­‰ã€‚ä»¥ä¸‹æ˜¯èŠ±æ‹¬å·çš„ä¸»è¦ç”¨æ³•åŠç¤ºä¾‹ï¼š</p>
<ol>
<li><p>åˆ†ç»„ä»£ç å—<br>èŠ±æ‹¬å·ç”¨äºå°†ä¸€æ®µä»£ç åˆ†ç»„ï¼Œä½¿å…¶ä½œä¸ºä¸€ä¸ªæ•´ä½“ä¼ é€’æˆ–æ‰§è¡Œã€‚</p>
 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> &#123;[<span class="keyword">catch</span> &#123;myProc&#125; msg]&#125; &#123;</span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;An error occurred: $msg&quot;</span></span><br><span class="line">&#125; else &#123;</span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;myProc executed successfully&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å»¶è¿Ÿè§£æ<br>èŠ±æ‹¬å·å†…çš„å†…å®¹ä¸ä¼šç«‹å³è§£æï¼Œç›´åˆ°éœ€è¦æ—¶æ‰ä¼šè¢«è§£æã€‚è¿™åœ¨å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å­—ç¬¦ä¸²æ—¶éå¸¸æœ‰ç”¨ã€‚</p>
 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> script &#123;<span class="keyword">puts</span> <span class="string">&quot;Hello, World!&quot;</span>&#125;</span><br><span class="line"><span class="keyword">eval</span> <span class="variable">$script</span>  <span class="comment">;# è¾“å‡º &quot;Hello, World!&quot;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> &#123;[<span class="keyword">catch</span> &#123;myProc&#125; msg]&#125; &#123;</span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;An error occurred: $msg&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºåˆ—è¡¨<br>èŠ±æ‹¬å·ç”¨äºåˆ›å»ºåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„å…ƒç´ å¯ä»¥åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦ã€‚</p>
 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> myList &#123;one two three&#125;</span><br><span class="line"><span class="keyword">puts</span> [<span class="keyword">lindex</span> <span class="variable">$myList</span> <span class="number">1</span>]  <span class="comment">;# è¾“å‡º &quot;two&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºå­—å…¸<br>èŠ±æ‹¬å·ç”¨äºåˆ›å»ºå­—å…¸ï¼Œå­—å…¸ä¸­çš„é”®å€¼å¯¹å¯ä»¥åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦ã€‚</p>
 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> myDict &#123;key1 value1 key2 value2&#125;</span><br><span class="line"><span class="keyword">puts</span> [<span class="keyword">dict</span> get <span class="variable">$myDict</span> key1]  <span class="comment">;# è¾“å‡º &quot;value1&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤šè¡Œå­—ç¬¦ä¸²<br>èŠ±æ‹¬å·ç”¨äºåˆ›å»ºå¤šè¡Œå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²ä¸­çš„æ¢è¡Œç¬¦å’Œç©ºæ ¼ä¼šè¢«ä¿ç•™ã€‚</p>
 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> multiLineString &#123;</span><br><span class="line">    This is a multi-line</span><br><span class="line">    <span class="keyword">string</span> in Tcl.</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">puts</span> <span class="variable">$multiLineString</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿æŠ¤ç‰¹æ®Šå­—ç¬¦<br>èŠ±æ‹¬å·ç”¨äºä¿æŠ¤ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿å…¶ä¸è¢«è§£é‡Šä¸ºå‘½ä»¤æˆ–å˜é‡ã€‚</p>
 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> specialChars &#123;This is a &#123;special&#125; <span class="keyword">string</span> with [brackets] and <span class="variable">$dollar</span> signs.&#125;</span><br><span class="line"><span class="keyword">puts</span> <span class="variable">$specialChars</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨æ§åˆ¶ç»“æ„ä¸­ä½¿ç”¨<br>èŠ±æ‹¬å·ç”¨äºæ§åˆ¶ç»“æ„ï¼ˆå¦‚ ifã€whileã€for ç­‰ï¼‰ä¸­çš„æ¡ä»¶å’Œä»£ç å—ã€‚</p>
 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> x <span class="number">10</span></span><br><span class="line"><span class="keyword">if</span> &#123;<span class="variable">$x</span> &gt; <span class="number">5</span>&#125; &#123;</span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;x is greater than 5&quot;</span></span><br><span class="line">&#125; else &#123;</span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;x is 5 or less&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®šä¹‰è¿‡ç¨‹<br>èŠ±æ‹¬å·ç”¨äºå®šä¹‰è¿‡ç¨‹çš„å‚æ•°å’Œä¸»ä½“ã€‚</p>
 <figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">proc</span><span class="title"> greet</span> &#123;name&#125; &#123;</span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;Hello, $name!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">greet <span class="string">&quot;Tcl User&quot;</span>  <span class="comment">;# è¾“å‡º &quot;Hello, Tcl User!&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="global-å’Œ-varaible"><a href="#global-å’Œ-varaible" class="headerlink" title="global å’Œ varaible"></a>global å’Œ varaible</h2><p><code>global</code> å’Œ <code>variable</code> ç”¨äºå£°æ˜è¯¥å˜é‡æ¥è‡ªå…¨å±€è¿˜æ˜¯å½“å‰å‘½åç©ºé—´ã€‚</p>
<p>æ³¨æ„ï¼šä¸¤è€…éƒ½æ˜¯å£°æ˜ï¼Œä¸æ˜¯å®šä¹‰ã€‚</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> i <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="keyword">eval</span> test &#123;</span><br><span class="line">    <span class="comment">;# variable i</span></span><br><span class="line">    <span class="comment">;# iæ²¡æœ‰è¢«äº‹å…ˆå£°æ˜ä¸ºåå­—ç©ºé—´çš„å˜é‡ï¼Œåˆ™ä¼šå¼•ç”¨å…¨å±€å˜é‡i</span></span><br><span class="line">    <span class="keyword">for</span> &#123; <span class="keyword">set</span> i <span class="number">1</span>&#125; &#123; <span class="variable">$i</span> &lt;=<span class="number">5</span>&#125; &#123; <span class="keyword">incr</span> i&#125; &#123;</span><br><span class="line">        <span class="keyword">puts</span> -nonewline <span class="string">&quot;i=$i; &quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="comment">;# ç”±äºæ²¡æœ‰å…¨å±€çš„jï¼Œæ‰€ä»¥jè¢«é»˜è®¤è§†ä½œå‘½åç©ºé—´å†…éƒ¨å˜é‡ï¼Œå¼•ç”¨æ—¶å¿…é¡»åŠ ä¸Šå‘½åç©ºé—´ä¸ºå‰ç¼€</span></span><br><span class="line">    <span class="keyword">for</span> &#123;<span class="keyword">set</span> j <span class="number">1</span>&#125; &#123; <span class="variable">$j</span>&lt;=<span class="number">5</span>&#125; &#123;<span class="keyword">incr</span> j&#125; &#123;</span><br><span class="line">        <span class="keyword">puts</span> -nonewline <span class="string">&quot;j=$j; &quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">puts</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">puts</span> <span class="variable">$i</span></span><br><span class="line"><span class="keyword">puts</span> <span class="variable">$test::j</span></span><br></pre></td></tr></table></figure>

<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;#æ³¨æ„içš„å®šä¹‰å¤„è¢«æ³¨é‡Šäº†</span></span><br><span class="line"><span class="comment">#set i 20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="keyword">eval</span> test &#123;</span><br><span class="line">    <span class="comment">;# è¿™é‡Œçš„ global å£°æ˜æ— æ•ˆï¼Œå› ä¸ºæ²¡æœ‰åœ¨å…¨å±€å®šä¹‰i</span></span><br><span class="line">    <span class="keyword">global</span> i</span><br><span class="line">    <span class="comment">;# æ­¤å¤„çš„iä»ç„¶æ˜¯å‘½ä»¤ç©ºé—´å†…éƒ¨çš„</span></span><br><span class="line">    <span class="keyword">for</span> &#123; <span class="keyword">set</span> i <span class="number">1</span>&#125; &#123; <span class="variable">$i</span> &lt;=<span class="number">5</span>&#125; &#123; <span class="keyword">incr</span> i&#125; &#123;</span><br><span class="line">        <span class="keyword">puts</span> -nonewline <span class="string">&quot;i=$i; &quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">;# é”™è¯¯ï¼</span></span><br><span class="line"><span class="keyword">puts</span> <span class="variable">$i</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;# æ­£ç¡®</span></span><br><span class="line"><span class="keyword">puts</span> <span class="variable">$test::i</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/01/17/IC/2.%E5%9F%BA%E4%BA%8EVerilog%E7%9A%84%E6%95%B0%E5%AD%97IC%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2025/01/17/IC/2.%E5%9F%BA%E4%BA%8EVerilog%E7%9A%84%E6%95%B0%E5%AD%97IC%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">ç¬¬2ç«  åŸºäºVerilogçš„æ•°å­—ICè®¾è®¡æ–¹æ³•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-01-17 15:37:49" itemprop="dateCreated datePublished" datetime="2025-01-17T15:37:49+00:00">2025-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-01 11:30:13" itemprop="dateModified" datetime="2025-08-01T11:30:13+00:00">2025-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-å‚è€ƒ"><a href="#1-å‚è€ƒ" class="headerlink" title="1. å‚è€ƒ"></a>1. å‚è€ƒ</h2><p>ç™½æ æ—¸. æ•°å­—ICè®¾è®¡å…¥é—¨ï¼ˆå¾®è¯¾è§†é¢‘ç‰ˆï¼‰[M]. åŒ—äº¬: æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾ï¼Œ2023-09-01:ç¬¬2ç« .</p>
<h2 id="2-æ•°å­—å™¨ä»¶ä¸Verilogè¯­æ³•"><a href="#2-æ•°å­—å™¨ä»¶ä¸Verilogè¯­æ³•" class="headerlink" title="2. æ•°å­—å™¨ä»¶ä¸Verilogè¯­æ³•"></a>2. æ•°å­—å™¨ä»¶ä¸Verilogè¯­æ³•</h2><p>è™½ç„¶ Foundry æä¾›çš„å¯ç”¨å…ƒå™¨ä»¶ç§ç±»è¾ƒå¤šï¼Œä½†æ•°å­—è®¾è®¡å¸ˆå¹¶ä¸ç‰¹åˆ«åœ¨æ„è¿™äº›å…ƒå™¨ä»¶ï¼Œåœ¨å…¶å¤´è„‘ä¸­ï¼Œåªå­˜åœ¨ 10 ç§ç®€å•å…ƒå™¨ä»¶ï¼š</p>
<ul>
<li>ä¸é—¨ã€æˆ–é—¨ã€éé—¨ã€å¼‚æˆ–é—¨ã€</li>
<li>åŠ æ³•å™¨ã€ä¹˜æ³•å™¨ã€ç§»ä½å™¨ã€</li>
<li>é€‰æ‹©å™¨ã€æ¯”è¾ƒå™¨ã€</li>
<li>è§¦å‘å™¨</li>
</ul>
<p>æ³¨æ„ï¼Œè™½ç„¶åŠ æ³•å™¨ã€ä¹˜æ³•å™¨ã€æ¯”è¾ƒå™¨ç­‰å…ƒå™¨ä»¶å¯ä»¥ç”±é€»è¾‘é—¨ç”Ÿæˆï¼Œä½†æ˜¯ä»Verilogå¸¸ç”¨çš„è¡¨è¾¾å¼æ¥çœ‹ï¼Œä¸€èˆ¬ç›´æ¥ç”¨â€œ+â€è¿™ä¸ªç¬¦å·è¡¨ç¤ºåŠ æ³•ï¼Œè€Œå¾ˆå°‘ç”¨é—¨ç”µè·¯å»ç›´æ¥æ­å»ºã€‚å› ä¸ºç°ä»£èŠ¯ç‰‡è§„æ¨¡åºå¤§ï¼ŒåŠŸèƒ½å¤æ‚ï¼Œå·¥ç¨‹å¸ˆåº”è¯¥å°†ä¸»è¦ç²¾åŠ›æŠ•å…¥åˆ°é‡ç‚¹éš¾é¢˜çš„å®ç°ä¸­ï¼Œè€Œå¯¹äºå¦‚ä½•å®ç°åŠ æ³•å™¨ç­‰æœ€åº•å±‚çš„é—®é¢˜ï¼Œåº”è¯¥äº¤ç»™ç»¼åˆæ­¥éª¤è‡ªåŠ¨å®Œæˆã€‚</p>
<p>åŸºæœ¬å…ƒå™¨ä»¶ä¸­ä¸åŒ…æ‹¬é™¤æ³•ï¼Œå› ä¸ºé™¤æ³•çš„å®ç°ä¸åŒäºä¹˜æ³•ï¼Œå®ƒå—åˆ°è¢«é™¤æ•°ã€é™¤æ•°ã€å•†çš„æ•°å€¼èŒƒå›´é™åˆ¶ï¼Œæœ‰æ—¶éœ€è¦ç”¨åˆ°è¿­ä»£ç­‰å¤æ‚æ–¹æ³•å®ç°ï¼Œè¿˜æœ‰åˆ†æ¯ä¸º 0 ç­‰å¼‚å¸¸æƒ…å†µéœ€è¦æŠ¥å‘Šï¼Œæ‰€ä»¥ä¸å±äºVerilogä¸­å¸¸ç”¨çš„ç›´æ¥è¿ç®—æ–¹å¼ã€‚</p>
<p>åŠ¡å¿…æ³¨æ„ï¼Œæ•°å­—å‰ç«¯å†™çš„Verilogä»…ä»…æ˜¯ä»£ç ï¼Œè€Œéç¨‹åºï¼Œå…¶ä»£ç æ˜¯ä»£æ›¿ç”µè·¯å›¾çš„ä¸€ç§æ–‡æœ¬è¯­è¨€æè¿°ã€‚ä¸æˆ–éåŠ ä¹˜ç­‰æŒ‡çš„æ˜¯å…ƒå™¨ä»¶ã€‚å†™Verilogæ—¶è¦æœ‰ç”µè·¯æ¦‚è²Œå’Œæ—¶åºã€‚</p>
<p>10ç§æ•°å­—å™¨ä»¶çš„ç¬¦å·è¡¨ç¤ºåŠVerilogè¡¨ç¤ºæ–¹æ³•è§è¡¨æ ¼ï¼š</p>
<figure style="text-align:center;">
<figcaption>10ç§æ•°å­—é€»è¾‘å™¨ä»¶å’ŒVerilogè¡¨ç¤º</figcaption>
<img src='https://i.postimg.cc/B65vgDMk/20250117214703.jpg' border='0' alt='20250117214703' width="90%"/>
</figure>

<p>çœŸæ­£çš„å…ƒå™¨ä»¶åº“ä¸­æœ‰å¾ˆå¤šå¤æ‚çš„å…ƒå™¨ä»¶ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<figure style="text-align:center;">
<img src="https://i.postimg.cc/6QSLdsyT/20250117214659.jpg" alt="20250117214659" width="50%"/>
<figcaption>å¤æ‚å…ƒå™¨ä»¶ç¤ºä¾‹</figcaption>
</figure>

<p>ä½†æ˜¯è¿™äº›å…ƒå™¨ä»¶éƒ½å¯ä»¥çœ‹ä½œä»¥ä¸Š10ç§åŸºç¡€å…ƒå™¨ä»¶çš„ç»„åˆï¼Œä¸ä¼šè¶…å‡ºåŸæœ‰çš„åŠŸèƒ½èŒƒå›´ã€‚æ‰€ä»¥è®¾è®¡æ—¶ï¼Œå¤´è„‘ä¸­åªéœ€è¦æœ‰ä»¥ä¸Š10ç§å…ƒå™¨ä»¶ã€‚</p>
<p>æ•°å­—ICè®¾è®¡åˆç§°ä¸ºæ•°å­—é€»è¾‘è®¾è®¡ï¼Œå› ä¸ºå…¶æœ¬èº«å°±æ˜¯é€»è¾‘çš„ï¼Œåªæœ‰<code>0</code>å’Œ<code>1</code>ä¸¤ç§é€»è¾‘ã€‚</p>
<ul>
<li>ç»„åˆé€»è¾‘ï¼šç”µå¹³è¾“å…¥å’Œç”µå¹³è¾“å‡ºã€‚å…ƒå™¨ä»¶ç»“æ„ç®€å•ï¼Œä½†é—®é¢˜æ˜¯å¦‚æœè¾“å…¥å«æœ‰æ¯›åˆºï¼Œè¾“å‡ºå°±æœ‰æ¯›åˆºã€‚</li>
</ul>
<img src='https://i.postimg.cc/C1s5wkTY/20250117215056.jpg' border='0' alt='20250117215056' width="50%"/>

<figure style="text-align:center;">
<img src='https://i.postimg.cc/NMH8DNHD/20250117214654.jpg' border='0' alt='20250117214654' width="50%"/>
<figcaption>ç»„åˆé€»è¾‘ç”µè·¯çš„æ¯›åˆº</figcaption>
</figure>

<ul>
<li>æ—¶åºé€»è¾‘ï¼šä»¥æ—¶é’Ÿä¸ºé©±åŠ¨æºã€‚ä¸€ä¸ªè§¦å‘å™¨ï¼Œåœ¨æ—¶é’Ÿçš„é©±åŠ¨ï¼ˆè¾¹æ²¿è§¦å‘ï¼‰ä¸‹ï¼Œå°† D è¾“å…¥ç«¯çš„ä¿¡å·é€åˆ° Q ç«¯è¾“å‡ºã€‚</li>
</ul>
<img src='https://i.postimg.cc/BbfTVx50/20250117214649.jpg' border='0' alt='20250117214649' width="100%"/>

<p>è§¦å‘å™¨ä¹Ÿå¯ä»¥å«å¯„å­˜å™¨(register, reg)ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰æ—¶é’Ÿé©±åŠ¨ï¼Œé‚£ä¹ˆQç«¯ä¼šä¿æŒåŸæœ‰çŠ¶æ€ä¸å˜ï¼Œä¹Ÿå°±å¯„å­˜äº†ä¸Šä¸€æ¬¡è§¦å‘æ—¶çš„Dç«¯ä¿¡æ¯ã€‚è€Œç»„åˆé€»è¾‘ï¼Œè¾“å‡ºç«¯æ˜¯æ— æ³•å¯„å­˜ä¿¡æ¯çš„ã€‚</p>
<p>æ—¶åºé€»è¾‘æ˜¯æ•°å­—ç”µè·¯çš„åŸºç¡€ã€‚10 ç§å…ƒå™¨ä»¶ä¸­ï¼Œåªæœ‰è§¦å‘å™¨å±äºæ—¶åºé€»è¾‘å™¨ä»¶ï¼Œæ‰€ä»¥è§¦å‘å™¨æ˜¯æ•´ä¸ªæ•°å­—ç”µè·¯çš„åŸºç¡€ã€‚ä» RTL çš„åç§°å¯ä»¥çŸ¥æ™“ï¼ŒRTL æ„ä¸ºå¯„å­˜å™¨ä¼ è¾“å±‚ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯ï¼šä»ä¸€ä¸ªè§¦å‘å™¨çš„è¾“å‡ºåˆ°å¦ä¸€ä¸ªè§¦å‘å™¨çš„è¾“å…¥ï¼Œé€šè¿‡è§¦å‘å™¨çš„å±‚å±‚ä¼ é€’ï¼Œæœ€ç»ˆå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æ•°å­—ç”µè·¯ã€‚</p>
<p>æ•°å­—ç”µè·¯çš„æ—¶åºåˆ†æï¼Œä¸»è¦æ˜¯åˆ†æä¸¤ä¸ªè§¦å‘å™¨ä¹‹é—´çš„è·¯å¾„å»¶è¿Ÿã€‚</p>
<p>è¿›è¡Œå‰ä»¿æ—¶ï¼Œçœ‹åˆ°çš„ä»¿çœŸæ³¢å½¢ä¼šå’Œæœ¬å›¾ä¸€æ ·ï¼Œæ˜¯ç†æƒ³çš„ï¼Œè€Œä½¿ç”¨ç‰ˆå›¾ç½‘è¡¨è¿›è¡Œåä»¿æ—¶ï¼Œä»¿çœŸæ³¢å½¢æ˜¯å¸¦å»¶è¿Ÿçš„ã€‚</p>
<p>ä¸Šå›¾ä¸­è§¦å‘å™¨çš„ç¬¦å·è¡¨ç¤ºï¼Œå®ƒå…±æœ‰4ä¸ªå¼•è„šï¼Œé™¤è¾“å…¥çš„Dç«¯å’Œè¾“å‡ºçš„<code>Q</code>ç«¯å¤–ï¼Œä¸‰è§’å½¢ä½ç½®è¡¨ç¤ºæ—¶é’Ÿï¼Œä¸‹æ–¹çš„<code>rst_n</code>è¡¨ç¤ºå¤ä½ï¼Œå…¶ä¸Šçš„åœ†åœˆè¡¨ç¤º<code>0</code>ç”µå¹³æœ‰æ•ˆï¼Œå³<code>rst_n</code>ç­‰äº<code>0</code>æ—¶ï¼Œå¯„å­˜å™¨å¤„äºå¤ä½çŠ¶æ€ã€‚æ­¤æ—¶ï¼Œ<code>Q</code>ç«¯ä¿æŒ<code>0</code>ï¼Œå³ä½¿æ—¶é’Ÿå’Œ<code>D</code>ç«¯æœ‰åŠ¨ä½œï¼Œ<code>Q</code>ç«¯ä¹Ÿä¸ä¼šå˜åŒ–ï¼Œåªæœ‰å½“<code>rst_n</code>ç­‰äº<code>1</code>æ—¶ï¼Œæ‰è§£é™¤å¤ä½çŠ¶æ€ï¼Œå¯„å­˜å™¨æ–¹èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<h2 id="3-å¯ç»¼åˆçš„Verilogè®¾è®¡è¯­æ³•"><a href="#3-å¯ç»¼åˆçš„Verilogè®¾è®¡è¯­æ³•" class="headerlink" title="3. å¯ç»¼åˆçš„Verilogè®¾è®¡è¯­æ³•"></a>3. å¯ç»¼åˆçš„Verilogè®¾è®¡è¯­æ³•</h2><p>èƒ½å˜æˆç”µè·¯çš„Verilogè¡¨è¾¾å«åšå¯ç»¼åˆï¼Œåœ¨è®¾è®¡ç”µè·¯æ—¶ï¼Œåªèƒ½ä½¿ç”¨å¯ç»¼åˆçš„è¯­æ³•è¡¨è¿°ã€‚è€Œåœ¨ä»¿çœŸæ—¶ï¼Œç”±äºåªåœ¨è®¡ç®—æœºä¸Šè¿è¡Œï¼Œä¸ç•™ç‰‡ï¼Œå¯ä½¿ç”¨ä¸èƒ½ç»¼åˆçš„é«˜çº§è¯­æ³•ï¼Œä»¥å¢åŠ è¯­è¨€è¡¨è¾¾çš„çµæ´»åº¦å’Œå¤æ‚åº¦ã€‚</p>
<p>å¯ç»¼åˆçš„ç”µè·¯è¡¨è¿°åªæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li><code>assign</code></li>
<li><code>always</code></li>
</ul>
<p>ä¸é—¨ï¼š</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> z = a &amp; b;</span><br></pre></td></tr></table></figure>

<p>è§¦å‘å™¨ï¼š</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (!rst_n)</span><br><span class="line">        Q &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        Q &lt;= D;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>ç¬¦å·è¯´æ˜ï¼š</p>
<ul>
<li><code>&lt;=</code>: éé˜»å¡èµ‹å€¼ï¼Œå‡¡æ˜¯æ—¶åºé€»è¾‘ï¼Œéƒ½ç”¨éé˜»å¡èµ‹å€¼ï¼›</li>
<li><code>=</code>: é˜»å¡èµ‹å€¼ï¼Œå‡¡æ˜¯ç»„åˆé€»è¾‘ï¼Œéƒ½ç”¨é˜»å¡èµ‹å€¼ï¼›</li>
<li><code>@(...)</code>: æ‹¬å·ä¸­çš„åˆ—è¡¨å«æ•æ„Ÿåˆ—è¡¨ï¼Œæ„æ€æ˜¯ï¼Œ<code>always</code>å—è¾“å‡ºçš„<code>Q</code>å¯¹åˆ—è¡¨ä¸­ä¿¡å·ä¿æŒæ•æ„Ÿï¼Œå¦‚æœæ•æ„Ÿä¿¡å·åŠ¨ï¼Œåˆ™Qä¹Ÿä¼šåŠ¨ã€‚</li>
<li><code>posedge clk</code>: æ„æ€æ˜¯æ—¶é’Ÿçš„ä¸Šå‡æ²¿ï¼›</li>
<li><code>negedge rst_n</code>: æ„æ€æ˜¯æ—¶é’Ÿçš„ä¸‹é™æ²¿ã€‚</li>
<li><code>begin</code> &#x2F; <code>end</code>: ç›¸å½“äº C è¯­è¨€ä¸­çš„ <code>&#123;&#125;</code> ï¼Œå¦‚æœè¯­å¥åªæœ‰ä¸€æ¡ï¼Œå¯ä»¥ä¸å†™ <code>begin</code> &#x2F; <code>end</code> ã€‚</li>
</ul>
<p><code>always</code>ä¸ä»…å¯ä»¥è¡¨ç¤ºæ—¶åºé€»è¾‘ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºç»„åˆé€»è¾‘ã€‚å¦‚ä¸‹æ˜¯ä¸é—¨çš„å¦ä¸€ç§è¡¨ç¤ºï¼š</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(*)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    z = a &amp; b;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<code>@(*)</code>ä¸­çš„<code>*</code>æ˜¯çœç•¥è¡¨è¿°çš„æ•æ„Ÿåˆ—è¡¨ï¼Œç»¼åˆå™¨ä¼šè‡ªåŠ¨åœ¨<code>always</code>å—ä¸­å¯»æ‰¾ä¸è¾“å‡º<code>z</code>ç›¸å…³çš„è¾“å…¥ä¿¡å·ï¼Œè‡ªåŠ¨å¡«å…¥æ•æ„Ÿåˆ—è¡¨ä¸­ã€‚æœ¬ä¾‹ä¸­ï¼Œä¼šè‡ªåŠ¨å°†<code>a</code>å’Œ<code>b</code>ä½œä¸ºè¾“å…¥å¡«å…¥ã€‚è¿™ç§è®©å·¥å…·è‡ªåŠ¨å¡«å…¥çš„æ–¹å¼æ˜¯å¯é ä¸”æ¨èçš„ã€‚</p>
<p>Verilogçš„è¯­æ³•è§„å¾‹ï¼š</p>
<ol>
<li>æ—¶åºé€»è¾‘ï¼Œå¿…é¡»ä½¿ç”¨<code>always</code>å—ï¼Œå¹¶åŒæ—¶ä½¿ç”¨<code>&lt;=</code>éé˜»å¡èµ‹å€¼ã€‚åœ¨å…¶æ•æ„Ÿåˆ—è¡¨ä¸­ï¼Œå¿…é¡»å‡ºç°æ—¶é’Ÿä¿¡å·çš„è¾¹æ²¿å’Œå¤ä½ä¿¡å·çš„è¾¹æ²¿ã€‚</li>
<li>ç»„åˆé€»è¾‘ï¼Œå¯ä»¥ä½¿ç”¨<code>assign</code>ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>always</code>å—ï¼Œä½†æ˜¯å®ƒä»¬çš„èµ‹å€¼æ˜¯<code>=</code>é˜»å¡èµ‹å€¼ã€‚è‹¥ä½¿ç”¨<code>always</code>å—ï¼Œåˆ™æ•æ„Ÿåˆ—è¡¨ä¸­ä½¿ç”¨<code>*</code>ã€‚è‹¥é‡åˆ°æ•æ„Ÿåˆ—è¡¨ä¸­å¸¦æœ‰<code>*</code>ï¼Œåˆ™å¯ä»¥ç›´æ¥åˆ¤å®šä¸ºç»„åˆé€»è¾‘ã€‚</li>
</ol>
<p>å†æ¬¡å¼ºè°ƒï¼ŒVerilogçš„è¯­æ³•è¡¨è¾¾ï¼Œæè¿°çš„éƒ½æ˜¯ç”µè·¯ï¼Œå› æ­¤ä¾‹å­ä¸­çš„ <code>z</code>ã€<code>a</code>ã€<code>b</code>ã€<code>clk</code>ã€<code>rst_n</code>ã€<code>Q</code>ã€<code>D</code> éƒ½ç§°ä¸ºä¿¡å·ï¼Œåœ¨ç”µè·¯ä¸­éƒ½æ˜¯å®å®åœ¨åœ¨çš„é‡‘å±è¿çº¿ï¼Œåˆ‡å‹¿ç§°ä¸ºå˜é‡ã€‚</p>
<h2 id="4-å¯¹å¯„å­˜å™¨çš„æ·±åº¦è§£è¯»"><a href="#4-å¯¹å¯„å­˜å™¨çš„æ·±åº¦è§£è¯»" class="headerlink" title="4. å¯¹å¯„å­˜å™¨çš„æ·±åº¦è§£è¯»"></a>4. å¯¹å¯„å­˜å™¨çš„æ·±åº¦è§£è¯»</h2><p>ä¸€èˆ¬ä¼šä½¿ç”¨æ—¶é’Ÿä¸Šå‡æ²¿æ¥é©±åŠ¨å¯„å­˜å™¨ã€‚å¯¹äºåŒæ ·çš„åŠŸèƒ½éœ€æ±‚ï¼ŒåŒæ²¿è§¦å‘éœ€è¦çš„æ—¶é’Ÿæ…¢ï¼Œä½†è¦æ±‚æ—¶é’Ÿæ˜¯<code>50%</code>å ç©ºæ¯”ï¼Œè€Œå•æ²¿è§¦å‘ï¼Œå¯¹æ—¶é’Ÿçš„è¦æ±‚å¿«ä¸€å€ï¼Œä½†å¯¹æ—¶é’Ÿå½¢çŠ¶çš„è¦æ±‚é™ä½å¾ˆå¤šã€‚</p>
<p>å¤ä½ä¿¡å·<code>rst_n</code>ï¼Œä»¥<code>0</code>ç”µå¹³ä½œä¸ºå¤ä½ç”µå¹³ï¼Œ1ç”µå¹³è§£å¤ä½ï¼Œæ˜¯é€šç”¨æ ‡å‡†ï¼Œå¾ˆå°‘æœ‰åè¿‡æ¥ä½¿ç”¨çš„ã€‚åŸå› æ˜¯ï¼Œæ•°å­—ç”µè·¯çš„å¤ä½ä¿¡å·æ˜¯æ¨¡æ‹Ÿç”µè·¯ç»™çš„ï¼Œé€šå¸¸ï¼Œæ¨¡æ‹Ÿç”µè·¯å°†å…¶å‘½åä¸º<code>POR(Power On Reset)</code>ï¼Œå³ä¸Šç”µå¤ä½ä¿¡å·ã€‚èŠ¯ç‰‡åˆšé€šç”µæ—¶ï¼Œç”µå‹å°ï¼Œé€æ¸ä¸Šå‡åˆ°è¦æ±‚çš„ç”µå‹ï¼Œä¾‹å¦‚<code>1.8V</code>ï¼Œ<code>POR</code>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”µå‹ä¸Šå‡çš„æ ‡å¿—ï¼Œæ¨¡æ‹Ÿç”µè·¯æ”¾ä¸€ä¸ªæ¯”è¾ƒå™¨ï¼Œå°†è¾“å…¥ç”µå‹ä¸<code>0.9V</code>æ¯”è¾ƒï¼Œç”µå‹å°äº<code>0.9V</code>ï¼Œ<code>POR</code>ä¸º<code>0</code>ï¼Œç”µå‹å¤§äº<code>0.9V</code>ï¼Œ<code>POR</code>ä¸º<code>1</code>ã€‚å› è€Œå¤ä½ä¿¡å·ä¸Šç”µæ—¶æ€»æ˜¯å…ˆ<code>0</code>å<code>1</code>ï¼Œæ•°å­—å¯„å­˜å™¨éœ€è¦åœ¨å¤ä½ä¿¡å·ä¸º<code>0</code>çš„é˜¶æ®µä¿æŒå¤ä½æ€ï¼Œä¸èƒ½è¿è¡Œï¼Œå› ä¸ºæ­¤æ—¶èŠ¯ç‰‡ç”µå‹ä¸è¶³ï¼Œä¸èƒ½ä¿è¯æ­£å¸¸è¿è¡Œï¼Œè€Œå¤ä½ä¿¡å·å˜æˆ<code>1</code>ï¼Œè¯´æ˜ä¸Šç”µå®Œæ¯•ï¼Œç”µå‹å……è¶³ï¼Œå¯„å­˜å™¨è§£é™¤å¤ä½è¿›è¡Œæ­£å¸¸è¿è¡Œæ˜¯å®‰å…¨çš„ã€‚</p>
<p>éœ€è¦ç‰¹åˆ«æ¾„æ¸…çš„æ˜¯è¯­å¥<code>negedge rst_n</code>ï¼Œä½†æ˜¯ç»è¿‡ä»¿çœŸå’Œä¸æ¨¡æ‹Ÿå·¥ç¨‹å¸ˆç¡®è®¤ï¼Œå¤ä½ä¿¡å·å¯¹å¯„å­˜å™¨çš„ä½œç”¨ä¸æ˜¯é€šè¿‡ä¿¡å·æ²¿æ¥é©±åŠ¨çš„ï¼Œè€Œæ˜¯é€šè¿‡ç”µå¹³æ¥é©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯ <code>0</code> ä¿¡å·å…·æœ‰ç»å¯¹æ§åˆ¶æƒï¼Œåªè¦ <code>rst_n</code> ä¸º <code>0</code> ï¼Œé‚£ä¹ˆç«‹å³å¤ä½ã€‚</p>
<h2 id="5-éé˜»å¡èµ‹å€¼å’Œé˜»å¡èµ‹å€¼çš„åŒºåˆ«"><a href="#5-éé˜»å¡èµ‹å€¼å’Œé˜»å¡èµ‹å€¼çš„åŒºåˆ«" class="headerlink" title="5. éé˜»å¡èµ‹å€¼å’Œé˜»å¡èµ‹å€¼çš„åŒºåˆ«"></a>5. éé˜»å¡èµ‹å€¼å’Œé˜»å¡èµ‹å€¼çš„åŒºåˆ«</h2><p>éé˜»å¡èµ‹å€¼çš„æ„æ€æ˜¯è¯¥å¥è¡¨è¾¾ä¸ä¼šé˜»å¡åç»­è¡¨è¾¾çš„æ‰§è¡Œã€‚å¦‚ä¸‹ä¾‹ä¸­ï¼Œ<code>X &lt;ï¼ 0</code>çš„æ‰§è¡Œï¼Œä¸ä¼šé˜»ç¢åˆ°<code>Y &lt;ï¼ 0</code>çš„æ‰§è¡Œï¼Œå®ƒä»¬æ˜¯åŒæ—¶å‘ç”Ÿçš„ï¼š</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (!rst_n)</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        X &lt;= <span class="number">0</span>;</span><br><span class="line">        Y &lt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        X &lt;= A;</span><br><span class="line">        Y &lt;= B;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è€Œé˜»å¡èµ‹å€¼ï¼Œæ„æ€æ˜¯å¦‚æœå‰ä¸€å¥ä¸æ‰§è¡Œï¼Œåä¸€å¥å°±æ— æ³•æ‰§è¡Œï¼Œå‰ä¸€å¥ä¼šé˜»å¡åä¸€å¥ã€‚å¯¹äºå¯ç»¼åˆçš„Verilogæ¥è®²ï¼Œå…¶å®å¹¶ä¸ä¼šé˜»å¡ã€‚åœ¨ä¸‹ä¾‹ä¸­ï¼Œ <code>always</code> å—çš„ç›®çš„æ˜¯åˆ›é€  <code>z</code> å’Œ <code>k</code> ä¸¤ä¸ªä¿¡å·ã€‚ <code>k ï¼ 3 * z</code> å’Œ <code>z ï¼ a &amp; b</code> æ˜¯ä¸¤ä¸ªä¸åŒçš„ç”µè·¯ï¼Œ <code>k ï¼ 3 * z</code> ç”µè·¯ä¸ä¼šè¢« <code>z ï¼ a &amp; b</code> é˜»å¡ã€‚</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(*)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    z = a &amp; b;  <span class="comment">// ä¸é—¨</span></span><br><span class="line">    k = <span class="number">3</span> * z;  <span class="comment">// ä¹˜æ³•å™¨</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>æœ¬ä¾‹å¯¹åº”çš„åŸç†å›¾å¦‚å›¾æ‰€ç¤ºï¼š</p>
<img src='https://i.postimg.cc/MTs1Dhsh/20250117224729.jpg' border='0' alt='20250117224729' width="50%"/>

<p>å¯è§ï¼Œå¯¹äºç”µè·¯æè¿°æ¥è®²ï¼Œè¯­æ³•åªæ˜¯è¡¨ç¤ºä¸€ç§è¿æ¥å…³ç³»ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œå…ˆåé¡ºåºçš„è¯´æ³•ï¼Œä½†å¦‚æœæœ¬ä¾‹ä½¿ç”¨éé˜»å¡èµ‹å€¼ï¼Œè¯­æ³•æ£€æŸ¥ä¼šæŠ¥é”™ï¼Œå› æ­¤ï¼Œè¿™æ˜¯ä¸€ç§æƒ¯ç”¨æ–¹æ³•ã€‚é˜»å¡èµ‹å€¼åœ¨Verilogä¸­çœŸæ­£ä½“ç°é˜»å¡ï¼Œæ˜¯åœ¨ä»¿çœŸä½¿ç”¨çš„ä¸å¯ç»¼åˆè¯­æ³•ä¸­ï¼Œåˆ°ç¬¬3ç« å†åšè§£é‡Šã€‚</p>
<h2 id="6-ç»„åˆé€»è¾‘çš„è¡¨è¾¾å¼"><a href="#6-ç»„åˆé€»è¾‘çš„è¡¨è¾¾å¼" class="headerlink" title="6. ç»„åˆé€»è¾‘çš„è¡¨è¾¾å¼"></a>6. ç»„åˆé€»è¾‘çš„è¡¨è¾¾å¼</h2><p>å¯¹äºä¸€ä¸ªç»„åˆé€»è¾‘ç”µè·¯ï¼Œåº”è¯¥åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ç”¨assignï¼Œåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ç”¨alwayså‘¢ï¼Ÿ</p>
<p>æ¯”è¾ƒç®€å•çš„é€»è¾‘é€‚åˆä½¿ç”¨assignæ–¹å¼ï¼Œè¾ƒä¸ºå¤æ‚çš„é€»è¾‘åº”ä½¿ç”¨alwayså—ã€‚ä¸‹ä¾‹ç»™å‡ºäº†ä¸€ä¸ªé€‚åˆç”¨alwayså—çš„è¾ƒå¤æ‚ä¾‹å­ï¼š</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(*)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (s1)</span><br><span class="line">        a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s2)</span><br><span class="line">        a = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s3)</span><br><span class="line">        a = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        a = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>åŒæ ·çš„åŠŸèƒ½è‹¥æ”¹ç”¨assignï¼Œåˆ™ä¸ºä¸‹ä¾‹æ‰€ç¤ºã€‚å¾ˆæ˜æ˜¾ï¼Œç”¨alwayså—è¡¨è¾¾æ„æ€æ›´åŠ æ¸…æ™°ã€‚</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> a = s1 ? <span class="number">1</span> : (s2 ? <span class="number">2</span> : (s3 ? <span class="number">3</span> : <span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p>å‰é¢è§£é‡Šäº†æ•æ„Ÿåˆ—è¡¨ä¸­çš„ <code>*</code> åœ¨ç»„åˆé€»è¾‘ <code>always</code> å—ä¸­çš„ä½œç”¨ã€‚å¦‚æœè¯»è€…ä½¿ç”¨è¿‡ä¸€äº›è€IPï¼Œåˆ™å¯èƒ½è¿˜ä¼šçœ‹åˆ°ä¸‹ä¾‹æ‰€ç¤ºçš„è¡¨è¾¾ï¼Œè¿™ç§è¡¨è¾¾å·²éšç€ç»¼åˆå™¨çš„è¿›æ­¥æ¸æ¸è¢«æ·˜æ±°äº†ï¼Œä¸å»ºè®®åˆå­¦è€…ä½¿ç”¨ã€‚</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(s1 <span class="keyword">or</span> s2 <span class="keyword">or</span> s3)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (s1)</span><br><span class="line">        a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s2)</span><br><span class="line">        a = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s3)</span><br><span class="line">        a = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        a = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="7-ç»„åˆé€»è¾‘ä¸­çš„é€‰æ‹©å™¨"><a href="#7-ç»„åˆé€»è¾‘ä¸­çš„é€‰æ‹©å™¨" class="headerlink" title="7. ç»„åˆé€»è¾‘ä¸­çš„é€‰æ‹©å™¨"></a>7. ç»„åˆé€»è¾‘ä¸­çš„é€‰æ‹©å™¨</h2><h3 id="7-1-äºŒé€‰ä¸€-MUX-å¦‚ä½•è¡¨è¾¾ï¼Ÿ"><a href="#7-1-äºŒé€‰ä¸€-MUX-å¦‚ä½•è¡¨è¾¾ï¼Ÿ" class="headerlink" title="7.1. äºŒé€‰ä¸€ MUX å¦‚ä½•è¡¨è¾¾ï¼Ÿ"></a>7.1. äºŒé€‰ä¸€ MUX å¦‚ä½•è¡¨è¾¾ï¼Ÿ</h3><img src='https://i.postimg.cc/L6vnwrjX/20250117225844.jpg' border='0' alt='20250117225844' width="50%"/>

<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ 1 ç§è¡¨è¾¾ï¼Œ assign å®Œæ•´è¡¨è¾¾</span></span><br><span class="line"><span class="keyword">assign</span> z = (s == <span class="number">1</span>) ? b : a;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ 2 ç§è¡¨è¾¾ï¼Œ assign ç®€åŒ–è¡¨è¾¾</span></span><br><span class="line"><span class="keyword">assign</span> z = s ? b : a;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ 3 ç§è¡¨è¾¾ï¼Œ always å—è¡¨è¾¾</span></span><br><span class="line"><span class="keyword">always</span> @(*)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (s)</span><br><span class="line">        z = b;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        z = a;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-å¤šé€‰ä¸€MUXï¼Œåˆè¯¥å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Ÿ"><a href="#7-2-å¤šé€‰ä¸€MUXï¼Œåˆè¯¥å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Ÿ" class="headerlink" title="7.2. å¤šé€‰ä¸€MUXï¼Œåˆè¯¥å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Ÿ"></a>7.2. å¤šé€‰ä¸€MUXï¼Œåˆè¯¥å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Ÿ</h3><p>å› ä¸ºä½¿ç”¨ <code>assign</code> è¡¨ç¤ºæ˜¾ç„¶ä¼šè¿‡äºå¤æ‚ï¼Œæ‰€ä»¥éœ€è¦ç”¨ <code>always</code> å—è¡¨ç¤ºã€‚è¡¨ç¤ºæ–¹æ³•æœ‰ä¸¤ç§ï¼Œæ³¨æ„ä¸¤ç§è¡¨è¾¾ç»¼åˆå‡ºæ¥çš„ç”µè·¯æ˜¯ä¸åŒçš„ã€‚</p>
<p>å…¶ä¸€å¦‚ä¸‹ä¾‹æ‰€ç¤ºã€‚</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(*)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="number">0</span>)</span><br><span class="line">        z = a;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">1</span>)</span><br><span class="line">        z = b;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">2</span>)</span><br><span class="line">        z = c;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">3</span>)</span><br><span class="line">        z = d;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">4</span>)</span><br><span class="line">        z = e;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">5</span>)</span><br><span class="line">        z = f;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        z = a; <span class="comment">// é»˜è®¤å€¼</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>ç»¼åˆå‡ºæ¥çš„ç”µè·¯å¦‚å›¾æ‰€ç¤ºï¼š</p>
<img src='https://i.postimg.cc/x84BbfW8/20250117230859.jpg' border='0' alt='20250117230859' width="100%"/>

<p>å¯è§ï¼Œä½¿ç”¨ <code>if</code> è¡¨è¿°çš„é€‰æ‹©å…³ç³»ï¼Œç»¼åˆçš„ç”µè·¯æ˜¯ä¸€å±‚ä¸€å±‚é€æ¸å±•å¼€çš„ï¼Œå†™åœ¨ <code>if</code> æœ€å‰é¢çš„è¯­å¥ï¼ŒæŒæ¡ç€æœ€ç»ˆçš„é€‰æ‹©æƒï¼Œå› è€Œä¼˜å…ˆçº§æœ€é«˜ï¼Œå†å¾€åä¼˜å…ˆçº§é€å±‚ä¸‹é™ï¼Œè€Œä½¿ç”¨ <code>case</code> è¡¨è¿°çš„MUXï¼Œæ¯ä¸ªé€‰æ‹©éƒ½æ˜¯å¹¶åˆ—çš„ï¼Œä¼˜å…ˆçº§ç›¸åŒï¼Œè§ä¸‹æ–‡ã€‚</p>
<p>å…¶äºŒå¦‚ä¸‹ä¾‹æ‰€ç¤ºã€‚</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(*)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">case</span> (s)</span><br><span class="line">        <span class="number">0</span>: z = a;</span><br><span class="line">        <span class="number">1</span>: z = b;</span><br><span class="line">        <span class="number">2</span>: z = c;</span><br><span class="line">        <span class="number">3</span>: z = d;</span><br><span class="line">        <span class="number">4</span>: z = e;</span><br><span class="line">        <span class="number">5</span>: z = f;</span><br><span class="line">        <span class="keyword">default</span>: z = a; <span class="comment">// é»˜è®¤å€¼</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>æ‰€ç»¼åˆçš„ç”µè·¯å¦‚å›¾æ‰€ç¤ºï¼š</p>
<img src='https://i.postimg.cc/PrfqW20k/20250117230221.jpg' border='0' alt='20250117230221' width="30%"/>

<p>ä½¿ç”¨ <code>if</code> è¡¨è¿°ï¼Œæœ‰å¯èƒ½å‡ºç°éšè—é€»è¾‘ï¼Œå³è®¾è®¡è€…æ²¡æœ‰è€ƒè™‘åˆ°ï¼Œä½†å®é™…ä¼šè¢«ç»¼åˆå‡ºæ¥çš„é€»è¾‘é—¨ã€‚éšè—é€»è¾‘æ˜¯è®¾è®¡çš„éšæ‚£ï¼Œè®¾è®¡è€…åœ¨å†™ä»£ç æ—¶åº”è¯¥æ¸…æ¥šå…¶é€»è¾‘å«ä¹‰ï¼Œå°½é‡é¿å…å‡ºç°éšè—é€»è¾‘ã€‚ä¸ºäº†é¿å…è®¾è®¡ä¸­å‡ºç°éšè—é€»è¾‘ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­å¾€å¾€ä¼šæå€¡ä½¿ç”¨ <code>case</code> è¯­å¥æ¥è¡¨è¾¾ã€‚</p>
<p>ä¸‹ä¾‹ä¸­åæ˜ å‡º <code>if</code> çš„ä¼˜å…ˆçº§ç‰¹å¾ï¼Œæ¡ä»¶ <code>s &lt; 5</code> åŒ…å« <code>s ï¼ï¼ 4</code> çš„æƒ…å†µï¼Œå› ä¸º <code>s &lt; 5</code> ä¼˜å…ˆï¼Œå› è€Œå½“ <code>sï¼ï¼4</code> æ—¶ï¼Œ <code>z</code> çš„èµ‹å€¼æ˜¯ <code>a</code> è€Œä¸æ˜¯ <code>b</code> ã€‚å¦‚æœè®¾è®¡æ„å›¾æ˜¯è¦åœ¨ <code>s ï¼ï¼ 4</code> æ—¶ä½¿ <code>z ï¼ b</code> ï¼Œåˆ™åº”å½“å°†å…¶å†™åœ¨ <code>s &lt; 5</code> ä¹‹å‰ã€‚</p>
<!--  -->

<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(*)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (s &lt; <span class="number">5</span>)</span><br><span class="line">        z = a;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">4</span>)</span><br><span class="line">        z = b;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        z = c;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>caseæœ‰ä¸€ç§å˜ä½“æ˜¯ <code>casez</code> ï¼Œå®ƒå¯ä»¥æ‹“å±•caseçš„ä½¿ç”¨èŒƒå›´ï¼š</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">always</span> @(*)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">casez</span>(s)</span><br><span class="line">        <span class="number">16&#x27;b00011</span>???????????: z = a;</span><br><span class="line">        <span class="number">16&#x27;b10111111</span>????<span class="number">0000</span>: z = b;</span><br><span class="line">        <span class="number">16&#x27;b1111</span>?<span class="number">001000</span>?????: z = c;</span><br><span class="line">        <span class="keyword">default</span>: z = d;</span><br><span class="line">    <span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œé—®å·çš„æ„æ€æ˜¯0æˆ–1éƒ½èƒ½åŒ¹é…ï¼Œç±»ä¼¼è®¡ç®—æœºè¯­è¨€ä¸­çš„é€šé…ç¬¦ã€‚</p>
<p>è™½ç„¶å¾ˆå¤šé¡¹ç›®æå€¡ä½¿ç”¨ <code>case</code> æˆ– <code>casez</code> æ¥è¡¨è¿°é€‰æ‹©å™¨ï¼Œä½†ç©¶ç«Ÿæ˜¯ä½¿ç”¨ <code>if</code> è¿˜æ˜¯ <code>case</code> ï¼Œä»ç„¶å–å†³äºè¡¨è¾¾çš„éœ€è¦ã€‚æ€»ä½“è€Œè¨€ï¼Œ <code>case</code> ä¾¿äºåˆ¤æ–­æ˜¯å¦ç›¸ç­‰çš„æƒ…å†µï¼Œè€Œ <code>if</code> é€‚åˆåˆ¤æ–­å¤§äºæˆ–å°äºå…³ç³»ï¼Œä¸åŒæƒ…å†µç”¨ä¸åŒçš„è¡¨è¾¾ï¼Œå¯ä»¥ä½¿Verilogé€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œä¹Ÿæ›´ä¾¿äºç»´æŠ¤ã€‚</p>
<p>æ³¨æ„ç»„åˆé€»è¾‘ä¸­çš„ <code>if</code> å’Œ <code>else if</code> ï¼Œæœ€åå¿…é¡»è·Ÿä¸€å¥ <code>else</code> ï¼Œä½¿æ•´ä½“é€»è¾‘å®Œæ•´ã€‚è‹¥æ²¡æœ‰elseï¼Œåˆ™è¯¥ç”µè·¯ä¼šç»¼åˆå‡ºä¸€ä¸ªé”å­˜å™¨(<code>Latch</code>)ã€‚é”å­˜å™¨ä¸å±äº10ç§åŸºæœ¬å…ƒå™¨ä»¶ä¹‹ä¸€ã€‚åœ¨è®¾è®¡ä¸­ï¼Œå‡¡æœ‰å¯„å­˜éœ€æ±‚ï¼Œåº”å°½é‡ä½¿ç”¨è§¦å‘å™¨ï¼Œé¿å…ä½¿ç”¨é”å­˜å™¨ï¼Œç‰¹åˆ«è¦é¿å…ä¸å†™ <code>else</code> å¼•èµ·çš„éšè—é€»è¾‘ã€‚</p>
<h2 id="8-Verilogä¸­çš„forå¾ªç¯"><a href="#8-Verilogä¸­çš„forå¾ªç¯" class="headerlink" title="8. Verilogä¸­çš„forå¾ªç¯"></a>8. Verilogä¸­çš„forå¾ªç¯</h2><p>å…³é”®å­—ï¼š</p>
<ul>
<li><code>for</code></li>
<li><code>generate</code> &#x2F; <code>endgenerate</code> &#x2F; <code>genvar</code></li>
<li><code>integer</code>: æ˜¯ç¼–è¯‘æ—¶çš„å˜é‡ï¼Œä¸æ˜¯ä¿¡å·ï¼Œä¸ä¼šè¢«ç»¼åˆæˆç”µè·¯æˆ–é‡‘å±è¿çº¿ã€‚å¦‚æœå˜é‡ <code>ii</code> å£°æ˜ä¸º <code>wire</code> æˆ– <code>reg</code> ï¼Œç„¶åç”¨ <code>a[ii]</code> è¡¨ç¤ºä¸€ä¸ªä¿¡å·ï¼Œåˆ™è¯­æ³•ä¸èƒ½ç»¼åˆä¸ºç”µè·¯ã€‚ä½†æ˜¯ <code>ii</code> å£°æ˜ä¸º <code>integer</code> ï¼Œé‚£ä¹ˆ <code>a[ii]</code> å°†è¢«ç»¼åˆæˆä¿¡å·ã€‚</li>
</ul>
<h2 id="9-Verilogä¸­çš„æ•°å€¼è¡¨ç¤ºæ–¹æ³•"><a href="#9-Verilogä¸­çš„æ•°å€¼è¡¨ç¤ºæ–¹æ³•" class="headerlink" title="9. Verilogä¸­çš„æ•°å€¼è¡¨ç¤ºæ–¹æ³•"></a>9. Verilogä¸­çš„æ•°å€¼è¡¨ç¤ºæ–¹æ³•</h2><p> æ•°å€¼ä¸€èˆ¬ä¸ç›´æ¥å†™ï¼Œå¦‚æœç›´æ¥å†™ï¼Œåˆ™å·¥å…·ä¼šç†è§£ä¸ºåè¿›åˆ¶32æ¯”ç‰¹æ•°ï¼Œä½†å®é™…ä¸­çš„ä¿¡å·ä½å®½å¤šç§å¤šæ ·ï¼Œé€‰ç”¨å“ªç§è¿›åˆ¶è¡¨ç¤ºæ•°å€¼ä¹Ÿæœ‰å¤šç§é€‰æ‹©ï¼Œå› æ­¤éœ€è¦å°†è¿™ä¸¤æ–¹é¢äºˆä»¥è§„å®šã€‚</p>
<table>
<thead>
<tr>
<th>è¿›åˆ¶åˆ¶</th>
<th>ç¬¦å·å·</th>
<th>ä¸¾ä¾‹</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td>äºŒè¿›åˆ¶</td>
<td>b</td>
<td>4â€™b0110</td>
<td>4 æ¯”ç‰¹æ•°ï¼Œç”¨äºŒè¿›åˆ¶è¡¨ç¤ºä¸º 0110</td>
</tr>
<tr>
<td>åè¿›åˆ¶</td>
<td>d</td>
<td>8â€™d3</td>
<td>8 æ¯”ç‰¹æ•°ï¼Œç”¨åè¿›åˆ¶è¡¨ç¤ºä¸º 3</td>
</tr>
<tr>
<td>åå…­è¿›åˆ¶</td>
<td>h</td>
<td>15â€™h1abc</td>
<td>15 æ¯”ç‰¹æ•°ï¼Œç”¨åå…­è¿›åˆ¶è¡¨ç¤ºä¸º 1abc</td>
</tr>
</tbody></table>
<p> ç‰¹æ®Šçš„æ•°å€¼è¡¨ç¤ºæ–¹æ³•ï¼š </p>
<p> <code>&#123;5&#123;1&#39;b0&#125;&#125;</code> è¡¨ç¤º5ä¸ªæ¯”ç‰¹0ï¼Œå†å¦‚ <code>&#123;4&#123;1&#39;b1&#125;&#125;</code> è¡¨ç¤º4ä¸ªæ¯”ç‰¹1ã€‚è¿™ç§è¡¨ç¤ºä¸€èˆ¬ä¸ç”¨ï¼Œä½†æ˜¯å®ƒæœ‰ä¼˜ç‚¹ï¼Œä¸Šä¾‹ä¸­çš„æ¯”ç‰¹æ•°é‡5å’Œ4å¯ä»¥ç”¨å‚æ•°æ›¿ä»£ï¼Œè‹¥Verilogä¸­æœ‰ä¸€ä¸ªå‚æ•° <code>kkk</code> ï¼Œåˆ™å¯ä»¥å†™ä¸º <code>&#123;(kkk)&#123;1&#39;b0&#125;&#125;</code> ï¼Œç”šè‡³å¯ä»¥å†™æˆç”¨è®¡ç®—å¼è¡¨ç¤ºçš„ä½å®½ï¼Œå¦‚ <code>&#123;(kkkï¼‹2)&#123;1&#39;b0&#125;&#125;</code> ã€‚æ³¨æ„ï¼Œkkkæ˜¯å‚æ•°ï¼Œä¸æ˜¯ä¿¡å·ï¼Œå®ƒä¸æ˜¯ç”µè·¯ï¼Œè€Œæ˜¯ä¸€ç§ç¼–è¯‘æ—¶ä½¿ç”¨çš„å˜é‡ã€‚</p>
<p> è¿™ç§è¡¨ç¤ºæ–¹æ³•è¿˜å¯ä»¥å†™ä¸º <code>&#123;å¸¸æ•°&#123;é€»è¾‘è¡¨è¾¾å¼&#125;&#125;</code> çš„å½¢å¼ï¼Œå¦‚</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assign</span> int_clr = &#123;<span class="number">2</span>&#123;(apb_addr = = <span class="number">4&#x27;d7</span>) &amp; wr_en&#125;&#125; &amp; apb_wdat[<span class="number">1</span> : <span class="number">0</span>];</span><br></pre></td></tr></table></figure>

<p>æ­¤ä¾‹çš„ç›®çš„æ˜¯ä½¿ç”¨APBæ€»çº¿é…ç½®ä¸¤ä¸ªåªå†™ä¿¡å·ï¼ˆwrite-onlyä¿¡å·ï¼‰â€‹ï¼Œè¿™ä¸¤ä¸ªä¿¡å·åˆç§°ä¸º <code>int_clr</code> ï¼Œç­‰å¼çš„å³è¾¹ï¼Œä»…å½“åœ°å€ <code>apb_addr</code> ç­‰äº7ï¼Œå¹¶ä¸”åœ¨APBæ€»çº¿ä¸Šå‘ç”Ÿå†™æ“ä½œæ—¶ï¼ŒAPBå†™å…¥çš„ä¸¤æ¯”ç‰¹æ•°æ® <code>apb_wdat[1:0]</code> æ‰ä¼šè¢«é…ç½®åˆ°int_clrä¸­ï¼Œå¦åˆ™int_clrå°±æ˜¯0ã€‚é—®é¢˜åœ¨äºï¼Œ <code>(apb_addrï¼ï¼4&#39;d7)&amp;wr_en</code> æ˜¯ä¸€æ¯”ç‰¹ï¼Œä¸èƒ½è·Ÿ <code>apb_wdat[1:0]</code> æŒ‰ä½æ±‚ä¸ï¼Œå› è€Œéœ€è¦å°†ä¸€æ¯”ç‰¹å¤åˆ¶ä¸ºä¸¤æ¯”ç‰¹ï¼Œå³ <code>&#123;2&#123;(apb_addrï¼ï¼4&#39;d7)&amp;wr_en&#125;&#125;</code> ã€‚</p>
<p>å¯¹äºå…¶ä»–è¾…åŠ©å˜é‡ï¼Œå¯ä»¥ç›´æ¥å†™æ•°å­—ï¼Œä¾‹å¦‚åœ¨forå¾ªç¯ä¸­è®²è¿°çš„ <code>genvar ii</code> ï¼Œiiåªæ˜¯ä¸ªå˜é‡ï¼Œæ²¡æœ‰å¯¹åº”çš„ç”µè·¯ï¼Œé‚£ä¹ˆforå¾ªç¯èµ‹å€¼å°±ä¸éœ€è¦å¸¦ä½å®½ å’Œè¿›åˆ¶äº†ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·å†™</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(ii = <span class="number">0</span>;ii&lt;<span class="number">100</span>;ii = ii + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„Verilogä¸­ï¼Œå¦‚æœå•å†™aã€bã€cã€dã€eã€fã€xã€zï¼Œè¡¨ç¤ºçš„æ˜¯ä¿¡å·åï¼Œä¸èƒ½ä½œä¸ºæ•°å€¼ï¼Œå¦‚æœæƒ³è¡¨ç¤ºåå…­è¿›åˆ¶çš„æ•°å€¼ï¼Œåˆ™å¯å†™ä¸º4â€™haç­‰ï¼Œ1â€™bxè¡¨ç¤ºæœªçŸ¥æ€ï¼Œ1â€™bzè¡¨ç¤ºé«˜é˜»æ€ã€‚</p>
<h2 id="10-ä¿¡å·çš„çŠ¶æ€ç±»å‹"><a href="#10-ä¿¡å·çš„çŠ¶æ€ç±»å‹" class="headerlink" title="10. ä¿¡å·çš„çŠ¶æ€ç±»å‹"></a>10. ä¿¡å·çš„çŠ¶æ€ç±»å‹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 x z</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ</p>
<ul>
<li><p>0å’Œ1æ˜¯æ•°å­—ç”µè·¯æœ¬èº«çš„çŠ¶æ€ï¼Œå®ƒçš„æœ¬æºæ˜¯é›¶ç”µå¹³å’ŒVDDç”µå¹³ã€‚</p>
<p>  VDDï¼Œ Voltage Drain, å…¶ä¸­ Drain è¡¨ç¤ºæ¼æï¼Œæ˜¯ä¸€ä¸ªç”µæºå¼•è„šï¼Œç”¨æ¥æä¾›æ­£ç”µå‹ç»™ç”µè·¯ä¸­çš„å…ƒä»¶ã€‚ç”±äºæ™¶ä½“ç®¡çš„è®¾è®¡é€šå¸¸åŒ…å«ä¸¤ä¸ªæ¼æï¼ˆæºæå’Œæ¼æï¼‰ï¼Œæ‰€ä»¥åœ¨ä¸€äº›å‘½åè§„åˆ™ä¸­ï¼Œä¸ºäº†åŒºåˆ†æ­£ç”µæºå’Œè´Ÿç”µæºï¼Œä½¿ç”¨äº†ä¸¤ä¸ª Dï¼Œå¹¶ä¸”VDD ä»£è¡¨æ­£ç”µæºç”µå‹ï¼ŒVSSï¼ˆVoltage Sourceï¼‰ä»£è¡¨åœ°çº¿æˆ–è´Ÿç”µæºã€‚ æ•´ä¸ªèŠ¯ç‰‡çš„ç”µæºå¸¸ç§°ä¸ºVCCï¼ŒèŠ¯ç‰‡çš„åœ°å¸¸æ ‡æ³¨ä¸ºVSSã€‚</p>
<p>  ä¸åŒå·¥è‰ºå’Œå…ƒå™¨ä»¶åº“éœ€è¦çš„VDDä¸åŒï¼Œä¾‹å¦‚0.9Vã€1.8Vã€3.3Vç­‰ï¼Œè€ŒåŒä¸€ä¸ªå…ƒå™¨ä»¶åº“ä¸­çš„æ‰€æœ‰å…ƒå™¨ä»¶ï¼Œå…¶éœ€è¦çš„ä¾›ç”µç”µå‹VDDä¸€èˆ¬ç›¸åŒçš„ï¼Œåªæœ‰I&#x2F;Oå™¨ä»¶ç­‰å°‘æ•°å…ƒå™¨ä»¶ï¼Œå…¶è¾“å…¥ç«¯å’Œæ§åˆ¶ç«¯æ˜¯æ¯”è¾ƒä½çš„ç”µå‹ï¼Œè€Œè¾“å‡ºç«¯å£å´æ˜¯è¾ƒé«˜çš„ç”µå‹ã€‚</p>
<p>  æ•°å­—0å’Œ1å¯¹åº”çš„ç”µå¹³ä¸ä¼šç‰¹åˆ«ä¸¥æ ¼ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªæµ®åŠ¨èŒƒå›´ï¼Œé€šå¸¸ä¿¡å·ç”µå¹³ä½äºVDDçš„30%ï¼Œå°±è¢«è®¤ä¸ºæ˜¯0ï¼Œé«˜äºVDDçš„70%ï¼Œå°±è¢«è®¤ä¸ºæ˜¯1ã€‚</p>
</li>
<li><p>zæ€æ˜¯é«˜é˜»æ€ã€‚</p>
<p>  å¦‚æœä¸€é¢—èŠ¯ç‰‡ä¸é€šç”µï¼Œåˆ™å®ƒæ‰€æœ‰çš„å¼•è„šå°±éƒ½æ˜¯é«˜é˜»æ€ã€‚å¯è§ï¼Œé«˜é˜»æ€çš„å®é™…æ„ä¹‰å°±æ˜¯ä¸ä¼šå¹²æ‰°åˆ°å…¶ä»–ä¿¡å·ä¼ è¾“çš„çŠ¶æ€ï¼Œä¾‹å¦‚æŸä¿¡å·Aæ˜¯é«˜é˜»æ€ï¼ŒæŸä¿¡å·Bä¸æ˜¯é«˜é˜»æ€ï¼Œé‚£ä¹ˆä¿¡å·Aå åŠ åˆ°ä¿¡å·Bä¸Šï¼ˆå¯ä»¥æƒ³è±¡ä¸ºä¸¤æ ¹ä¿¡å·çº¿è¢«æ‹§åœ¨ä¸€èµ·ï¼‰â€‹ï¼Œç»“æœä»ç„¶æ˜¯Bï¼Œè€ŒAæ²¡æœ‰ä»»ä½•æ•ˆæœã€‚</p>
<p>  ä¸€èˆ¬æ¥è®²ï¼Œä¸€ä¸ªæœ‰ç€åŒå‘ä¼ è¾“åŠŸèƒ½çš„å¼•è„šï¼Œå¦‚æœè®¾ç½®ä¸ºè¾“å…¥æ¨¡å¼ï¼Œå°±å¯ä»¥è®¤ä¸ºè¿™ä¸ªå¼•è„šå¤„äºé«˜é˜»æ€ï¼Œæ„æ€æ˜¯å®ƒå¯¹ç”µè·¯æ¿ä¸Šä¸å®ƒç›¸è¿çš„å…ƒå™¨ä»¶æ²¡æœ‰ä»»ä½•å½±å“ï¼Œè¿™äº›ç›¸è¿å…ƒå™¨ä»¶å¦‚æœè¦å¯¹æœ¬èŠ¯ç‰‡è¾“å‡º0æˆ–1ï¼Œå°±å¯ä»¥ç›´æ¥é¡ºç€è¯¥é«˜é˜»æ€å¼•è„šè¾“å…¥ï¼Œè€Œä¸ä¼šè¢«å¹²æ‰°æˆ–é˜»æŒ¡ã€‚</p>
<p>  åœ¨FPGAçš„Verilogè¡¨è¿°ä¸­ï¼Œå¯ä»¥å¾ˆå½¢è±¡åœ°å°†FPGAçš„å¼•è„šæè¿°ä¸ºå¦‚ä¸‹è¯­å¥ï¼Œå…¶ä¸­bæ˜¯FPGAçš„å¼•è„šï¼Œæ‰€ä»¥å£°æ˜ä¸ºinoutç±»å‹ï¼Œoeæ˜¯è¯¥å¼•è„šçš„æ–¹å‘é€‰æ‹©ï¼Œè‹¥oeä¸º1ï¼Œåˆ™bä¸ºè¾“å‡ºæ¨¡å¼ï¼Œå°†ä¿¡å·aè¾“å‡ºåˆ°FPGAå¤–é¢ï¼Œè€Œå½“oeä¸º0æ—¶ï¼Œæ˜¯é«˜é˜»æ€ï¼Œå³è¾“å…¥æ¨¡å¼ï¼Œå¤–é¢çš„ä¿¡å·ä»bå¼•è„šå¯ä»¥è¿›æ¥åä¸ä¿¡å·cå½¢æˆäº†ç»„åˆé€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inout</span> b;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span> b = oe ? a : <span class="number">1&#x27;bz</span></span><br><span class="line"><span class="keyword">assign</span> d = b ^ c;</span><br></pre></td></tr></table></figure>

<p>  æ³¨æ„ä¸Šä¾‹ä¸­å¼•ç”¨FPGAçš„è¯­æ³•åªæ˜¯ä¸ºäº†è¯´æ˜zæ€çš„å«ä¹‰ã€‚ICè®¾è®¡ä¸­å¯¹å¼•è„šçš„è®¾è®¡ä¸åƒFPGAè¿™ä¹ˆç®€å•ï¼Œéœ€è¦ä¾‹åŒ–ä¸€ä¸ªå¼•è„šæ¨¡å—ï¼Œåœ¨ä»£ç ä¸­ä¸ä¼šå‡ºç°1â€™bzæ•°å€¼ã€‚</p>
<p>  <strong>åšä¸»æ³¨1ï¼š</strong></p>
<p>  åœ¨é›†æˆç”µè·¯ï¼ˆICï¼‰ä¸­ï¼Œé«˜é˜»æ€ï¼ˆHigh Impedance Stateï¼Œç®€ç§° Hi-Zï¼‰æ˜¯æŒ‡ä¸€ä¸ªç”µè·¯è¾“å‡ºå¼•è„šå¤„äºæ²¡æœ‰è¾“å‡ºé©±åŠ¨ä¿¡å·çš„çŠ¶æ€ï¼Œå³è¯¥å¼•è„šæ—¢ä¸æä¾›é«˜ç”µå¹³ï¼ˆVDDï¼‰ä¹Ÿä¸æä¾›ä½ç”µå¹³ï¼ˆGNDï¼‰ï¼Œè€Œæ˜¯å¤„äºä¸€ç§â€œæ‚¬ç©ºâ€çŠ¶æ€ï¼Œå‡ ä¹ä¸æ¶ˆè€—ç”µæµï¼Œåƒæ˜¯æ–­å¼€äº†ã€‚é«˜é˜»æ€é€šå¸¸ç”¨äºå¤šè·¯å¤ç”¨ï¼ˆbusï¼‰æˆ–ä¸‰æ€æ€»çº¿ï¼ˆtri-state busï¼‰ç­‰åº”ç”¨ä¸­ï¼Œå…è®¸å¤šä¸ªè®¾å¤‡å…±äº«åŒä¸€æ¡æ€»çº¿è€Œä¸ä¼šç›¸äº’å¹²æ‰°ã€‚</p>
<p>  é«˜é˜»æ€çš„å®ç°<br>  é«˜é˜»æ€é€šå¸¸é€šè¿‡ <strong>ä¸‰æ€é—¨ï¼ˆTri-state Gateï¼‰</strong> æ¥å®ç°ã€‚ä¸‰æ€é—¨æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„é€»è¾‘é—¨ï¼Œå®ƒå…·æœ‰ä¸‰ä¸ªè¾“å‡ºçŠ¶æ€ï¼š</p>
<p>  é«˜ç”µå¹³ï¼ˆé€»è¾‘ 1ï¼‰<br>  ä½ç”µå¹³ï¼ˆé€»è¾‘ 0ï¼‰<br>  é«˜é˜»æ€ï¼ˆHi-Zï¼‰<br>  å…·ä½“æ¥è¯´ï¼Œé«˜é˜»æ€æ˜¯é€šè¿‡åœ¨è¾“å‡ºç«¯å¢åŠ ä¸€ä¸ªé«˜é˜»æŠ—çš„ç”µè·¯æ¥å®ç°çš„ï¼Œè¿™ä¸ªé«˜é˜»æŠ—å€¼é€šå¸¸éå¸¸å¤§ï¼Œä»¥è‡³äºè¯¥å¼•è„šå¯¹å¤–éƒ¨ç”µè·¯å‡ ä¹æ²¡æœ‰å½±å“ã€‚ä¸‰æ€é—¨çš„å·¥ä½œåŸç†å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p>
<p>  å¼€å…³å‹è®¾è®¡ï¼š</p>
<p>  P-Channel MOSFETï¼ˆPMOSï¼‰ å’Œ N-Channel MOSFETï¼ˆNMOSï¼‰ ç»„æˆçš„ç”µè·¯å¯ä»¥æ ¹æ®æ§åˆ¶ä¿¡å·å†³å®šæ˜¯å¦æ¥é€šè¾“å‡ºã€‚å¦‚æœä¸‰æ€é—¨å¤„äºâ€œé«˜é˜»æ€â€æ—¶ï¼ŒMOSFET ä»¬å¹¶ä¸ä¼šå¯¼é€šï¼Œä»è€Œä½¿è¾“å‡ºå¼•è„šå¤„äºé«˜é˜»æŠ—çŠ¶æ€ã€‚<br>  æ§åˆ¶ä¿¡å·ï¼š</p>
<p>  ä¸‰æ€é—¨çš„è¾“å‡ºé€šå¸¸ç”±ä¸€ä¸ªæ§åˆ¶ä¿¡å·æ¥æ§åˆ¶ã€‚å½“æ§åˆ¶ä¿¡å·ä¸ºâ€œä½¿èƒ½â€çŠ¶æ€æ—¶ï¼Œè¾“å‡ºå¼•è„šä¼šé©±åŠ¨é«˜æˆ–ä½ç”µå¹³ï¼›è€Œå½“æ§åˆ¶ä¿¡å·ä¸ºâ€œç¦ç”¨â€çŠ¶æ€æ—¶ï¼Œè¾“å‡ºå¼•è„šè¿›å…¥é«˜é˜»æ€ï¼ŒåŸºæœ¬ä¸å¤–éƒ¨ç”µè·¯æ–­å¼€è¿æ¥ã€‚<br>  åŒå‘æ€»çº¿ï¼š</p>
<p>  åœ¨å¤šè·¯å¤ç”¨çš„åœºæ™¯ä¸­ï¼Œå¤šä¸ªè®¾å¤‡å¯èƒ½éœ€è¦å…±äº«åŒä¸€æ¡æ•°æ®æ€»çº¿ã€‚ä¸ºäº†é¿å…å¤šä¸ªè®¾å¤‡åŒæ—¶é©±åŠ¨æ€»çº¿äº§ç”Ÿå†²çªï¼Œè®¾å¤‡åœ¨ä¸è¾“å‡ºæ•°æ®æ—¶ä¼šè¿›å…¥é«˜é˜»æ€ï¼Œä¸å½±å“å…¶ä»–è®¾å¤‡çš„ä¿¡å·ä¼ è¾“ã€‚<br>  é«˜é˜»æ€çš„ä½œç”¨<br>  å¤šè·¯å¤ç”¨ï¼šé«˜é˜»æ€å…è®¸å¤šä¸ªç”µè·¯å…±äº«åŒä¸€æ€»çº¿ã€‚åªæœ‰ä¸€ä¸ªç”µè·¯åœ¨æŸä¸ªæ—¶é—´ç‚¹è¾“å‡ºæ•°æ®ï¼Œå…¶ä»–ç”µè·¯è¿›å…¥é«˜é˜»æ€ï¼Œé˜²æ­¢å†²çªã€‚</p>
<p>  æ€»çº¿å†²çªä¿æŠ¤ï¼šé€šè¿‡å°†ä¸å‚ä¸é€šä¿¡çš„è®¾å¤‡ç½®äºé«˜é˜»æ€ï¼Œé¿å…äº†å¤šä¸ªè®¾å¤‡åœ¨åŒä¸€æ—¶é—´å°è¯•é©±åŠ¨æ€»çº¿çš„å†²çªã€‚</p>
<p>  èŠ‚çœç”µåŠ›ï¼šé€šè¿‡åœ¨ä¸éœ€è¦è¾“å‡ºä¿¡å·æ—¶å°†è¾“å‡ºç½®äºé«˜é˜»æ€ï¼Œå¯ä»¥é™ä½åŠŸè€—ï¼Œå› ä¸ºåœ¨é«˜é˜»æ€ä¸‹è¾“å‡ºå¼•è„šå‡ ä¹ä¸æ¶ˆè€—ç”µæµã€‚</p>
<p>  ä¸¾ä¾‹è¯´æ˜<br>  ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯åœ¨ Tri-state Busï¼ˆä¸‰æ€æ€»çº¿ï¼‰ä¸­ï¼Œå¤šä¸ªè®¾å¤‡é€šè¿‡æ§åˆ¶ä¿¡å·æ¥å†³å®šæ˜¯å¦é©±åŠ¨æ€»çº¿ã€‚å¦‚æœè®¾å¤‡ä¸éœ€è¦å‘é€æ•°æ®ï¼Œå®ƒä¼šå°†è¾“å‡ºç½®äºé«˜é˜»æ€ï¼Œå…è®¸å…¶ä»–è®¾å¤‡ä½¿ç”¨æ€»çº¿ã€‚</p>
<p>  æ€»ç»“æ¥è¯´ï¼Œé«˜é˜»æ€çš„å®ç°ä¾èµ–äºä¸‰æ€é—¨ï¼ˆTri-state Gateï¼‰ï¼Œå®ƒé€šè¿‡æ§åˆ¶MOSFETå¼€å…³æ¥ä½¿è¾“å‡ºå¤„äºéé©±åŠ¨çŠ¶æ€ï¼Œä»è€Œè®©å…¶ä»–ç”µè·¯å¯ä»¥å…±äº«åŒä¸€ä¸ªå¼•è„šæˆ–æ€»çº¿ã€‚</p>
<p>  <strong>åšä¸»æ³¨2ï¼š</strong></p>
<p>  åœ¨æ•°å­—ç”µè·¯ä¸­ï¼Œinout å¼•è„šæ˜¯æŒ‡ä¸€ä¸ªæ—¢å¯ä»¥ä½œä¸ºè¾“å…¥ç«¯å£ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè¾“å‡ºç«¯å£çš„å¼•è„šã€‚å®ƒé€šå¸¸ç”¨äºå¤šè·¯å¤ç”¨ï¼ˆbusï¼‰æˆ–åŒå‘æ•°æ®ä¼ è¾“çš„åœºåˆï¼Œå…è®¸ä¸€ä¸ªå¼•è„šåœ¨ä¸åŒæ—¶é—´æ ¹æ®éœ€è¦åœ¨è¾“å…¥å’Œè¾“å‡ºä¹‹é—´åˆ‡æ¢ã€‚ä¸ºäº†åœ¨åŒä¸€å¼•è„šä¸ŠåŒæ—¶æ”¯æŒè¾“å…¥å’Œè¾“å‡ºï¼Œé€šå¸¸ä½¿ç”¨ ä¸‰æ€é€»è¾‘ï¼ˆTri-state logicï¼‰æ¥æ§åˆ¶æ•°æ®çš„æµå‘ã€‚</p>
<p>  inout å¼•è„šçš„å®ç°æ–¹å¼<br>  inout å¼•è„šçš„å®ç°ä¾èµ–äºå‡ ä¸ªå…³é”®çš„è®¾è®¡åŸåˆ™å’Œç»„ä»¶</p>
<p>  ä¸‰æ€ç¼“å†²å™¨ï¼ˆTri-state Bufferï¼‰ï¼š</p>
<p>  åœ¨ inout å¼•è„šä¸Šï¼Œé€šå¸¸ä½¿ç”¨ ä¸‰æ€ç¼“å†²å™¨ï¼ˆTri-state bufferï¼‰æ¥æ§åˆ¶è¯¥å¼•è„šæ˜¯å¤„äºè¾“å…¥ã€è¾“å‡ºè¿˜æ˜¯é«˜é˜»æ€ã€‚ä¸‰æ€ç¼“å†²å™¨çš„ä½œç”¨æ˜¯é€šè¿‡æ§åˆ¶ä¿¡å·æ¥å†³å®šè¯¥å¼•è„šçš„çŠ¶æ€ã€‚<br>  å½“å¼•è„šä½œä¸º è¾“å‡º æ—¶ï¼Œç¼“å†²å™¨å°†æ•°æ®ä¼ é€’åˆ°å¼•è„šã€‚<br>  å½“å¼•è„šä½œä¸º è¾“å…¥ æ—¶ï¼Œç¼“å†²å™¨å°†å¼•è„šä¸Šçš„ç”µå‹ä¿¡å·ä¼ é€åˆ°å†…éƒ¨ç”µè·¯ã€‚<br>  å½“å¼•è„šå¤„äº é«˜é˜»æ€ï¼ˆHi-Zï¼‰æ—¶ï¼Œç¼“å†²å™¨æ–­å¼€ä¸å¼•è„šçš„è¿æ¥ï¼Œä½¿å¾—è¯¥å¼•è„šå¯¹å¤–éƒ¨ç”µè·¯â€œé€æ˜â€ï¼Œå³ä¸å½±å“ç”µè·¯ã€‚<br>  æ§åˆ¶ä¿¡å·ï¼š</p>
<p>  inout å¼•è„šçš„åˆ‡æ¢é€šå¸¸ç”±æ§åˆ¶ä¿¡å·ï¼ˆä¾‹å¦‚ï¼Œæ–¹å‘æ§åˆ¶ä¿¡å·ï¼‰æ¥å†³å®šï¼ŒæŒ‡ç¤ºè¯¥å¼•è„šæ˜¯ä½œä¸ºè¾“å…¥ä½¿ç”¨è¿˜æ˜¯ä½œä¸ºè¾“å‡ºä½¿ç”¨ã€‚<br>  æ§åˆ¶ä¿¡å·ä¸€èˆ¬æ˜¯ç”±é€»è¾‘ç”µè·¯ç”Ÿæˆï¼Œå½“ç”µè·¯éœ€è¦è¾“å‡ºæ•°æ®æ—¶ï¼Œæ§åˆ¶ä¿¡å·ä¼šä½¿å¼•è„šæˆä¸ºè¾“å‡ºï¼›è€Œå½“ç”µè·¯éœ€è¦æ¥æ”¶æ•°æ®æ—¶ï¼Œæ§åˆ¶ä¿¡å·ä¼šä½¿å¼•è„šæˆä¸ºè¾“å…¥ã€‚<br>  åŒå‘æ€»çº¿è®¾è®¡ï¼š</p>
<p>  inout å¼•è„šå¸¸ç”¨äºæ€»çº¿è®¾è®¡ï¼Œå…¶ä¸­å¤šä¸ªè®¾å¤‡å…±äº«åŒä¸€æ¡æ€»çº¿ã€‚æ¯ä¸ªè®¾å¤‡å¯ä»¥åœ¨éœ€è¦æ—¶å‘æ€»çº¿å‘é€æ•°æ®ï¼Œè€Œåœ¨ä¸éœ€è¦æ—¶é€šè¿‡å°†è¾“å‡ºè®¾ä¸ºé«˜é˜»æ€æ¥é¿å…ä¸å…¶ä»–è®¾å¤‡çš„å†²çªã€‚<br>  ä¾‹å¦‚ï¼Œæ•°æ®æ€»çº¿ï¼ˆData Busï¼‰å¯èƒ½ç”±å¤šä¸ªè®¾å¤‡å…±äº«ã€‚å½“ä¸€ä¸ªè®¾å¤‡ä¸åœ¨å‘é€æ•°æ®æ—¶ï¼Œå®ƒä¼šå°†å…¶ inout å¼•è„šè®¾ä¸ºé«˜é˜»æ€ï¼Œç¡®ä¿åªæœ‰å‘é€è®¾å¤‡å½±å“æ€»çº¿ä¿¡å·ã€‚</p>
<p>  å·¥ä½œåŸç†</p>
<p>  è¾“å‡ºæ¨¡å¼ï¼š</p>
<p>  å½“inout å¼•è„šä½œä¸ºè¾“å‡ºæ—¶ï¼Œç›¸å…³çš„ä¸‰æ€ç¼“å†²å™¨è¿æ¥åˆ°è¯¥å¼•è„šï¼Œå¹¶é©±åŠ¨ç”µå¹³ï¼ˆé«˜æˆ–ä½ï¼‰ã€‚æ­¤æ—¶ï¼Œæ§åˆ¶ä¿¡å·å°†å¼•è„šè®¾ç½®ä¸ºè¾“å‡ºæ¨¡å¼ï¼Œå¹¶ä¸”å…¶ä»–è¿æ¥åˆ°è¯¥å¼•è„šçš„ç”µè·¯ä¼šå¤„äºæ–­å¼€çŠ¶æ€ã€‚</p>
<p>  è¾“å…¥æ¨¡å¼ï¼š</p>
<p>  å½“ inout å¼•è„šä½œä¸ºè¾“å…¥æ—¶ï¼Œç¼“å†²å™¨è¿›å…¥é«˜é˜»æ€ï¼ˆHi-Zï¼‰ï¼Œå³å¼•è„šçš„çŠ¶æ€ä¸å†ç”±è¾“å‡ºé€»è¾‘é©±åŠ¨ï¼Œè½¬è€Œæ¥æ”¶å¤–éƒ¨ä¿¡å·ã€‚æ­¤æ—¶ï¼Œåªæœ‰è¿æ¥åˆ°å¼•è„šçš„å…¶ä»–è®¾å¤‡ä¼šé©±åŠ¨è¯¥å¼•è„šçš„ç”µå¹³ã€‚<br>  é«˜é˜»æ€ï¼š</p>
<p>  å½“å¼•è„šä¸éœ€è¦è¾“å‡ºæ•°æ®æ—¶ï¼Œä¸‰æ€ç¼“å†²å™¨å°†è¿›å…¥ é«˜é˜»æ€ï¼Œä½¿è¯¥å¼•è„šå¯¹å…¶ä»–ç”µè·¯æ²¡æœ‰å½±å“ã€‚è¿™æ ·ï¼Œå¤šä¸ªè®¾å¤‡å°±å¯ä»¥å…±äº«åŒä¸€ä¸ªå¼•è„šæˆ–æ€»çº¿è€Œä¸ä¼šå‘ç”Ÿç”µå¹³å†²çªã€‚<br>  åº”ç”¨ç¤ºä¾‹<br>  åŒå‘æ•°æ®æ€»çº¿ï¼š</p>
<p>  å‡è®¾æœ‰å¤šä¸ªè®¾å¤‡å…±äº«ä¸€æ¡æ•°æ®æ€»çº¿ã€‚æ¯ä¸ªè®¾å¤‡çš„ inout å¼•è„šå¯ä»¥ä½œä¸ºæ•°æ®çš„è¾“å…¥ç«¯æˆ–è¾“å‡ºç«¯ã€‚åœ¨æŸä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªè®¾å¤‡å‘æ€»çº¿å‘é€æ•°æ®ï¼Œå…¶ä»–è®¾å¤‡åˆ™å°†å…¶å¼•è„šè®¾ä¸ºé«˜é˜»æ€ï¼Œé¿å…å¹²æ‰°ã€‚<br>  åŒå‘ä¿¡å·ä¼ è¾“ï¼š</p>
<p>  åœ¨é€šä¿¡åè®®ä¸­ï¼Œinout å¼•è„šå¯ç”¨äºåŒå‘ä¿¡å·ä¼ è¾“ã€‚ä¾‹å¦‚ï¼ŒIÂ²Cæ€»çº¿å°±ä½¿ç”¨ inout å¼•è„šï¼Œå…¶ä¸­ä¸€ä¸ªè®¾å¤‡åœ¨æŸä¸ªæ—¶åˆ»å‘é€ä¿¡å·ï¼Œè€Œå¦ä¸€ä¸ªè®¾å¤‡åˆ™æ¥æ”¶ä¿¡å·ã€‚<br>  èŠ¯ç‰‡é—´é€šä¿¡ï¼š</p>
<p>  åœ¨å¤šèŠ¯ç‰‡ç³»ç»Ÿä¸­ï¼Œinout å¼•è„šå¯ç”¨äºèŠ¯ç‰‡ä¹‹é—´çš„æ•°æ®äº¤æ¢ï¼Œå…è®¸ä¸åŒèŠ¯ç‰‡åœ¨ä¸åŒæ—¶åˆ»æ§åˆ¶åŒä¸€å¼•è„šçš„è¾“å…¥å’Œè¾“å‡ºè¡Œä¸ºã€‚<br>  æ€»ç»“<br>  inout å¼•è„šé€šè¿‡ä¸‰æ€ç¼“å†²å™¨å’Œæ§åˆ¶ä¿¡å·çš„ç»„åˆï¼Œå®ç°äº†åŒä¸€å¼•è„šå¯ä»¥åœ¨è¾“å…¥å’Œè¾“å‡ºä¹‹é—´åˆ‡æ¢çš„åŠŸèƒ½ã€‚é€šè¿‡å°†è¾“å‡ºç½®äºé«˜é˜»æ€ï¼Œå¯ä»¥ä½¿å¾—è¯¥å¼•è„šä¸ä¼šå¹²æ‰°å…¶ä»–ç”µè·¯æˆ–è®¾å¤‡ï¼Œä½¿å…¶é€‚ç”¨äºæ€»çº¿ç³»ç»Ÿæˆ–åŒå‘é€šä¿¡çš„è®¾è®¡ä¸­ã€‚</p>
</li>
<li><p>xæ€çš„å«ä¹‰æ˜¯æœªçŸ¥æ€ã€‚</p>
<p>  æœ‰4ç§æƒ…å†µä¼šäº§ç”ŸæœªçŸ¥æ€ï¼š</p>
<ul>
<li>å…¶ä¸€æ˜¯èŠ¯ç‰‡å·²ä¸Šç”µä½†å¤ä½ä¿¡å·æœªè¿›è¡Œå¤ä½çš„æƒ…å†µï¼›</li>
<li>å…¶äºŒæ˜¯åŒå‘å¼•è„šä¿¡å·å†²çªï¼Œå› ä¸ºæ²¡æ§åˆ¶å¥½ï¼Œå¯¼è‡´æœ‰ä¸€è·¯ä¿¡å·é€šè¿‡å¼•è„šè¾“å…¥ï¼Œå¦ä¸€è·¯ä¿¡å·é€šè¿‡ç›¸åŒçš„å¼•è„šè¾“å‡ºï¼›</li>
<li>å…¶ä¸‰æ˜¯èŠ¯ç‰‡ä¸­ä¸€ä¸ªå…ƒå™¨ä»¶çš„æŸä¸ªè¾“å…¥ç«¯ä¸ºxæ€ï¼Œäºæ˜¯è¾“å‡ºå°±è·Ÿç€å˜æˆäº†xæ€ï¼Œè¿™å°±æ˜¯æ‰€è°“xæ€çš„ä¼ æ’­ï¼›</li>
<li>ç¬¬å››æ˜¯è§¦å‘å™¨çš„æ—¶åºä¸æ»¡è¶³ï¼Œäº§ç”Ÿäº†äºšç¨³æ€ï¼Œä»è€Œè¡¨ç¤ºä¸ºxæ€ã€‚</li>
</ul>
<p>  ä¸Šè¿°4ç§æƒ…å†µåœ¨ä»¿çœŸä¸­éƒ½èƒ½çœ‹åˆ°ï¼Œä½†å®é™…ä¸­ï¼Œç¬¬1ç§æƒ…å†µåŸºæœ¬ä¸ä¼šå‡ºç°ï¼Œé™¤éæ¨¡æ‹Ÿç”µè·¯è®¾è®¡æœ‰è¯¯ï¼Œå…¶ä»–3ç§åœ¨æ•°å­—è®¾è®¡æœ‰ç¼ºé™·æ—¶ä¼šå‡ºç°ï¼Œå®é™…åœ¨æµ‹é‡å…¶ç”µå‹æ—¶ä¼šå‡ºç°ä¸ç¨³å®šæˆ–éé¢„æœŸçš„é—®é¢˜ã€‚åœ¨å¯ç»¼åˆçš„Verilogä¸­ï¼Œä¸ä¼šå‡ºç°1â€™bxæ•°å€¼ï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸ªè®¾è®¡ä¼šæ•…æ„å°†ä¸€ä¸ªé”™è¯¯å¼•å…¥RTLä¸­ï¼Œæ‰€æœ‰çš„é”™è¯¯éƒ½æ˜¯æ„å¤–å‘ç”Ÿçš„ã€‚è¯¥ç¬¦å·åœ¨ä»¿çœŸè„šæœ¬å’Œä»¿çœŸæ³¢å½¢ä¸­å¯èƒ½å‡ºç°ã€‚</p>
</li>
</ul>
<h2 id="ç”µå¹³ä¿¡å·ä¸è„‰å†²ä¿¡å·"><a href="#ç”µå¹³ä¿¡å·ä¸è„‰å†²ä¿¡å·" class="headerlink" title="ç”µå¹³ä¿¡å·ä¸è„‰å†²ä¿¡å·"></a>ç”µå¹³ä¿¡å·ä¸è„‰å†²ä¿¡å·</h2><p>ç”µå¹³ä¿¡å·ä¹Ÿå«Latchä¿¡å·ï¼Œå³ä¸€ä¸ªä¿¡å·æŒç»­å¤šä¸ªæ—¶é’Ÿå‘¨æœŸéƒ½ä¸€ç›´ä¿æŒä¸º1çš„ä¿¡å·ã€‚</p>
<p>è„‰å†²ä¿¡å·å°±æ˜¯åªæŒç»­ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸçš„ä¿¡å·ã€‚</p>
<p>å·¥ç¨‹å¸ˆåœ¨äº¤æµæ—¶ï¼Œå¯¹äºç”µå¹³ä¿¡å·aå¸¸ç”¨çš„è¯´æ³•æ˜¯â€œå°†aç»™Latchä½â€â€‹ï¼Œå¯¹äºè„‰å†²ä¿¡å·bå¸¸ç”¨çš„è¯´æ³•æ˜¯â€œæ‰“ä¸€ä¸ªè„‰å†²bâ€â€‹ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bi-an"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">bi-an</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">74</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bi-an" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;bi-an" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ah_zzg@126.com" title="E-Mail â†’ mailto:ah_zzg@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://bi-an.github.io/" title="http:&#x2F;&#x2F;bi-an.github.io">bi-an's Page</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bi-an</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

</body>
</html>
