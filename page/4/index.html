<!DOCTYPE html>
<html lang="en, zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bi-an.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="江南人物的博客">
<meta property="og:url" content="https://bi-an.github.io/blog/page/4/index.html">
<meta property="og:site_name" content="江南人物的博客">
<meta property="og:locale">
<meta property="article:author" content="bi-an">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bi-an.github.io/blog/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en, zh_CN'
  };
</script>

  <title>江南人物的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">江南人物的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/blog/resources/" rel="section"><i class="fa fa-paperclip fa-fw"></i>Resource</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/03/22/concurrency/Multi-Thread-and-Signals/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/03/22/concurrency/Multi-Thread-and-Signals/" class="post-title-link" itemprop="url">Multi Thread and Signals</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-22 15:20:14" itemprop="dateCreated datePublished" datetime="2024-03-22T15:20:14+00:00">2024-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>From ChatGPT:</p>
<p>In general, when a program enters a signal handler in a multi-threaded environment, the behavior regarding other threads depends on how the signal handler is set up and the specific signal that is being handled.</p>
<ol>
<li>Default Behavior: By default, when a signal is delivered to a process, it interrupt the thread that is currently running and executes the signal handler in the context of that thread. Other threads in the process continue running unless they are also interrupted by signals.</li>
<li>Thread-Specific Signal Handling: Some signals, such as SIGINT (interrupt signal), SIGTERM (termination signal), or SIGABRT (abort signal), are typically delivered to the entire process, which means they can interrupt any thread. However, other signals, like SIGSEGV (segmentation fault) or SIGILL (illegal signal), are usually delivered to the specific thread that caused the signal.</li>
<li>Signal Masking: In a multi-threaded program, you can use signal masking (sigprocmask in POSIX systems) to block certain signals in specific threads. This can affect whether a signal handler interrupts a particular thread or not.</li>
<li>Asynchronous-Signal-Safe Functions: Signal handlers should only execute functions are considered “asynchronous-signal-safe” according to POSIX standards. These functions are designed to be safe to call from within a signal handler. Using non-safe functions in a signal handler can lead to undefined behavior.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/02/24/concurrency/TBB%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/02/24/concurrency/TBB%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">TBB入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-24 14:59:52" itemprop="dateCreated datePublished" datetime="2024-02-24T14:59:52+00:00">2024-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-控制线程数"><a href="#1-控制线程数" class="headerlink" title="1. 控制线程数"></a>1. 控制线程数</h2><ul>
<li>Method 1: Use the environment variable <code>TBB_NUM_THREADS</code> for the gloabl setting.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> TBB_NUM_THREADS=4</span><br></pre></td></tr></table></figure>

<p>TODO: It doesn’t seem to work!</p>
<ul>
<li>Method 2: Use <code>tbb::task_arena</code> or <code>tbb::task_scheduler_init</code> (Deprecated).</li>
</ul>
<p>TBB will use this setting locally within the scope of the <code>tbb::task_arena</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/pipeline.h&gt;</span></span></span><br><span class="line"><span class="comment">// Deprecated:</span></span><br><span class="line"><span class="comment">// #include &lt;tbb/task_scheduler_init.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/task_arena.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Define your pipeline body</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPipeline</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(tbb::flow_control&amp; fc)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Your pipeline logic here</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Inform the pipeline that there is no more data</span></span><br><span class="line">        fc.<span class="built_in">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Deprecated: tbb::task_scheduler_init init(1);</span></span><br><span class="line">    <span class="function">tbb::task_arena <span class="title">arena</span><span class="params">(<span class="number">4</span>)</span></span>; <span class="comment">// 4 threads</span></span><br><span class="line">    <span class="comment">// Do some tasks:</span></span><br><span class="line">    tbb::<span class="built_in">parallel_pipeline</span>(<span class="comment">/* max_number_of_live_tokens */</span> <span class="number">4</span>, MyPipeline); <span class="comment">// <span class="doctag">FIXME:</span> 似乎需要放入 arena 的 execute 函数中</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-parallel-for"><a href="#2-parallel-for" class="headerlink" title="2. parallel_for"></a>2. <code>parallel_for</code></h2><p>API: <a target="_blank" rel="noopener" href="https://oneapi-spec.uxlfoundation.org/specifications/oneapi/latest/elements/onetbb/source/algorithms/functions/parallel_for_func">parallel_for</a></p>
<ol>
<li>用 <code>my_parallel_for</code> 模拟 <code>parallel_for</code> 的实现：</li>
</ol>
<figure class="highlight cpp"><figcaption><span>my_parallel_for.cpp</span><a href="/blog/downloads/code/TBB/my_parallel_for.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟 parallel_for 的内部实现</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">my_parallel_for</span><span class="params">(<span class="type">const</span> tbb::blocked_range&lt;<span class="type">size_t</span>&gt;&amp; range, <span class="type">const</span> std::function&lt;<span class="type">void</span>(<span class="type">const</span> tbb::blocked_range&lt;<span class="type">size_t</span>&gt;&amp;)&gt;&amp; body)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (range.<span class="built_in">is_divisible</span>()) {</span><br><span class="line">        <span class="comment">// 分割范围</span></span><br><span class="line">        <span class="function">tbb::blocked_range&lt;<span class="type">size_t</span>&gt; <span class="title">left</span><span class="params">(range.begin(), range.begin() + (range.end() - range.begin()) / <span class="number">2</span>)</span></span>;</span><br><span class="line">        <span class="function">tbb::blocked_range&lt;<span class="type">size_t</span>&gt; <span class="title">right</span><span class="params">(left.end(), range.end())</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 递归调用</span></span><br><span class="line">        tbb::<span class="built_in">parallel_invoke</span>(</span><br><span class="line">            [&amp;] { <span class="built_in">my_parallel_for</span>(left, body); },</span><br><span class="line">            [&amp;] { <span class="built_in">my_parallel_for</span>(right, body); }</span><br><span class="line">        );</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 处理当前范围</span></span><br><span class="line">        <span class="built_in">body</span>(range);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">data</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) {</span><br><span class="line">        data[i] = i;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用自定义的 parallel_for 进行并行处理</span></span><br><span class="line">    <span class="built_in">my_parallel_for</span>(tbb::<span class="built_in">blocked_range</span>&lt;<span class="type">size_t</span>&gt;(<span class="number">0</span>, data.<span class="built_in">size</span>()), [&amp;](<span class="type">const</span> tbb::blocked_range&lt;<span class="type">size_t</span>&gt;&amp; r) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = r.<span class="built_in">begin</span>(); i != r.<span class="built_in">end</span>(); ++i) {</span><br><span class="line">            data[i] *= <span class="number">2</span>; <span class="comment">// 示例操作：将每个元素乘以2</span></span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出结果</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; val : data) {</span><br><span class="line">        std::cout &lt;&lt; val &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    }</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>发出任务的线程也会成为工作线程之一，并参与任务的执行，测试代码如下：</li>
</ol>
<figure class="highlight cpp"><figcaption><span>test_parallel_for.cpp</span><a href="/blog/downloads/code/TBB/test_parallel_for.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tbb;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> std::atomic&lt;<span class="type">int</span>&gt; <span class="title">total_blocks</span><span class="params">(<span class="number">0</span>)</span></span>;  <span class="comment">// Atomic counter to track the number of tasks processed</span></span><br><span class="line"><span class="function"><span class="type">static</span> std::atomic&lt;<span class="type">int</span>&gt; <span class="title">total_blocks2</span><span class="params">(<span class="number">0</span>)</span></span>;  <span class="comment">// Atomic counter to track the number of tasks processed</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Function to process each data element</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process_data</span><span class="params">(<span class="type">int</span> i, std::mutex&amp; mtx)</span> </span>{</span><br><span class="line">    <span class="comment">// std::this_thread::sleep_for(std::chrono::milliseconds(1));  // Simulate some processing time</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i)</span><br><span class="line">        ;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Usage: &quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &lt;number_of_elements&gt;&quot;</span></span><br><span class="line">                  &lt;&lt; <span class="string">&quot;&lt;grain_size&gt;&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> num_elements = std::<span class="built_in">stoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">int</span> grain_size = std::<span class="built_in">stoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    std::mutex mtx;</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">data</span><span class="params">(num_elements)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_elements; ++i) {</span><br><span class="line">        data[i] = i;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// {</span></span><br><span class="line">    <span class="comment">//     std::lock_guard&lt;std::mutex&gt; lock(mtx);</span></span><br><span class="line">    <span class="comment">//     std::cout &lt;&lt; &quot;Main thread ID: &quot; &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">// }</span></span><br><span class="line"></span><br><span class="line">    tbb::concurrent_unordered_map&lt;std::thread::id, tbb::concurrent_vector&lt;<span class="type">int</span>&gt;&gt; thread_task_counts;  <span class="comment">// To store task counts for each thread</span></span><br><span class="line">    tbb::concurrent_unordered_map&lt;std::thread::id, tbb::concurrent_vector&lt;<span class="type">int</span>&gt;&gt; thread_task_counts2;  <span class="comment">// To store task counts for each thread</span></span><br><span class="line"></span><br><span class="line">    tbb::<span class="built_in">parallel_for</span>(<span class="number">0</span>, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;((data.<span class="built_in">size</span>() + grain_size - <span class="number">1</span>) / grain_size), [&amp;](<span class="type">int</span> i) {</span><br><span class="line">        total_blocks++;</span><br><span class="line">        <span class="type">int</span> cnt = <span class="number">0</span>;  <span class="comment">// Thread-local variable to avoid data</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = i * grain_size; j &lt; std::<span class="built_in">min</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(data.<span class="built_in">size</span>()), (i + <span class="number">1</span>) * grain_size); ++j) {</span><br><span class="line">            <span class="built_in">process_data</span>(i, mtx);</span><br><span class="line">            ++cnt;</span><br><span class="line">        }</span><br><span class="line">        thread_task_counts[std::this_thread::<span class="built_in">get_id</span>()].<span class="built_in">push_back</span>(cnt);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    tbb::<span class="built_in">parallel_for</span>(<span class="built_in">blocked_range</span>&lt;<span class="type">int</span>&gt;(<span class="number">0u</span>, data.<span class="built_in">size</span>(), grain_size), [&amp;](<span class="type">const</span> blocked_range&lt;<span class="type">int</span>&gt;&amp; r) {</span><br><span class="line">        total_blocks2++;</span><br><span class="line">        <span class="type">int</span> cnt = <span class="number">0</span>;  <span class="comment">// Thread-local variable to avoid data</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = r.<span class="built_in">begin</span>(); i &lt; r.<span class="built_in">end</span>(); ++i) {</span><br><span class="line">            <span class="built_in">process_data</span>(i, mtx);</span><br><span class="line">            ++cnt;</span><br><span class="line">        }</span><br><span class="line">        thread_task_counts2[std::this_thread::<span class="built_in">get_id</span>()].<span class="built_in">push_back</span>(cnt);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Total blocks processed: &quot;</span> &lt;&lt; total_blocks.<span class="built_in">load</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; pair : thread_task_counts) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread &quot;</span> &lt;&lt; pair.first &lt;&lt; <span class="string">&quot; processed: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; task_count : pair.second)</span><br><span class="line">            std::cout &lt;&lt; task_count &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Total blocks2 processed: &quot;</span> &lt;&lt; total_blocks2.<span class="built_in">load</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; pair : thread_task_counts2) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread &quot;</span> &lt;&lt; pair.first &lt;&lt; <span class="string">&quot; processed: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; task_count : pair.second)</span><br><span class="line">            std::cout &lt;&lt; task_count &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./test_parallel_for </span><br><span class="line">Main thread ID: 140220582070080</span><br><span class="line">Processing data: 2 on thread 140220582070080</span><br><span class="line">Processing data: 6 on thread 140220557755968</span><br><span class="line">Processing data: 4 on thread 140220574795328</span><br><span class="line">Processing data: 8 on thread 140220566275648</span><br><span class="line">Processing data: 10 on thread 140220562015808</span><br></pre></td></tr></table></figure>

<p>可见，<code>data 2</code> 是由主线程处理的。也就是说，<code>parallel_for</code> 虽然被称为 a blocking parallel construt，但线程等待所有任务完成期间是非阻塞的，它还可以充当工作线程执行任务池中的任务。</p>
<p>代码模拟 <code>parallel_for</code> 的 <code>wait</code> ：</p>
<figure class="highlight cpp"><figcaption><span>my_task_scheduler.cpp</span><a href="/blog/downloads/code/TBB/my_task_scheduler.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskScheduler</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TaskScheduler</span>(<span class="type">size_t</span> numThreads);</span><br><span class="line">    ~<span class="built_in">TaskScheduler</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">enqueue</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">wait</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;std::thread&gt; workers;</span><br><span class="line">    std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; tasks;</span><br><span class="line">    std::mutex queueMutex;</span><br><span class="line">    std::condition_variable condition;</span><br><span class="line">    std::condition_variable finished;</span><br><span class="line">    <span class="type">bool</span> stop;</span><br><span class="line">    <span class="type">size_t</span> activeTasks;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">workerThread</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">executeTask</span><span class="params">()</span></span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">TaskScheduler::<span class="built_in">TaskScheduler</span>(<span class="type">size_t</span> numThreads) : <span class="built_in">stop</span>(<span class="literal">false</span>), <span class="built_in">activeTasks</span>(<span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; numThreads; ++i) {</span><br><span class="line">        workers.<span class="built_in">emplace_back</span>(&amp;TaskScheduler::workerThread, <span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TaskScheduler::~<span class="built_in">TaskScheduler</span>() {</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">        stop = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    condition.<span class="built_in">notify_all</span>();</span><br><span class="line">    <span class="keyword">for</span> (std::thread &amp;worker : workers) {</span><br><span class="line">        worker.<span class="built_in">join</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskScheduler::enqueue</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task)</span> </span>{</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">        tasks.<span class="built_in">push</span>(std::<span class="built_in">move</span>(task));</span><br><span class="line">    }</span><br><span class="line">    condition.<span class="built_in">notify_one</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskScheduler::wait</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (!tasks.<span class="built_in">empty</span>() || activeTasks &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// 如果还有任务，执行一个任务，避免当前线程被阻塞</span></span><br><span class="line">        <span class="keyword">if</span> (!tasks.<span class="built_in">empty</span>()) {</span><br><span class="line">            <span class="built_in">executeTask</span>();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            finished.<span class="built_in">wait</span>(lock);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskScheduler::workerThread</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        std::function&lt;<span class="type">void</span>()&gt; task;</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">            condition.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>] { <span class="keyword">return</span> stop || !tasks.<span class="built_in">empty</span>(); });</span><br><span class="line">            <span class="keyword">if</span> (stop &amp;&amp; tasks.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line">            task = std::<span class="built_in">move</span>(tasks.<span class="built_in">front</span>());</span><br><span class="line">            tasks.<span class="built_in">pop</span>();</span><br><span class="line">            ++activeTasks;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">task</span>();</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">            --activeTasks;</span><br><span class="line">            <span class="keyword">if</span> (tasks.<span class="built_in">empty</span>() &amp;&amp; activeTasks == <span class="number">0</span>) {</span><br><span class="line">                finished.<span class="built_in">notify_all</span>();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskScheduler::executeTask</span><span class="params">()</span> </span>{</span><br><span class="line">    std::function&lt;<span class="type">void</span>()&gt; task;</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (tasks.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line">        task = std::<span class="built_in">move</span>(tasks.<span class="built_in">front</span>());</span><br><span class="line">        tasks.<span class="built_in">pop</span>();</span><br><span class="line">        ++activeTasks;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">task</span>();</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">        --activeTasks;</span><br><span class="line">        <span class="keyword">if</span> (tasks.<span class="built_in">empty</span>() &amp;&amp; activeTasks == <span class="number">0</span>) {</span><br><span class="line">            finished.<span class="built_in">notify_all</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">parallel_for</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end, std::function&lt;<span class="type">void</span>(<span class="type">int</span>)&gt; func)</span> </span>{</span><br><span class="line">    <span class="function"><span class="type">static</span> TaskScheduler <span class="title">scheduler</span><span class="params">(std::thread::hardware_concurrency())</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt; end; ++i) {</span><br><span class="line">        scheduler.<span class="built_in">enqueue</span>([i, &amp;func] { <span class="built_in">func</span>(i); });</span><br><span class="line">    }</span><br><span class="line">    scheduler.<span class="built_in">wait</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N1 = <span class="number">100</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N2 = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first parallel loop.</span></span><br><span class="line">    <span class="built_in">parallel_for</span>(<span class="number">0</span>, N1, [&amp;](<span class="type">int</span> i) {</span><br><span class="line">        <span class="comment">// The second parallel loop.</span></span><br><span class="line">        <span class="built_in">parallel_for</span>(<span class="number">0</span>, N2, [&amp;](<span class="type">int</span> j) {</span><br><span class="line">            <span class="comment">// Some work</span></span><br><span class="line">        });</span><br><span class="line">        <span class="comment">// 线程发出 parallel_for 之后，需要等待内部所有 parallel loop 的任务完成</span></span><br><span class="line">        <span class="comment">// 在此期间允许继续拿取外部的 parallel loop 的任务执行</span></span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="3-TBB线程池"><a href="#3-TBB线程池" class="headerlink" title="3. TBB线程池"></a>3. TBB线程池</h2><p>TBB似乎总是使用同一个全局线程池。测试代码如下：</p>
<figure class="highlight cpp"><figcaption><span>tbb_thread_pool.cpp</span><a href="/blog/downloads/code/TBB/tbb_thread_pool.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">std::mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">task_group_function</span><span class="params">()</span> </span>{</span><br><span class="line">    tbb::task_group tg;</span><br><span class="line">    <span class="type">int</span> max_concurrency = tbb::this_task_arena::<span class="built_in">max_concurrency</span>();</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Task group max concurrency: &quot;</span> &lt;&lt; max_concurrency &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) {</span><br><span class="line">        tg.<span class="built_in">run</span>([i] {</span><br><span class="line">            {</span><br><span class="line">                std::lock_guard&lt;std::mutex&gt; <span class="built_in">lock</span>(mtx);</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;Task group thread &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; is running.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    tg.<span class="built_in">wait</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">task_arena_function</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">tbb::task_arena <span class="title">arena</span><span class="params">(<span class="number">4</span>)</span></span>;</span><br><span class="line">    <span class="type">int</span> max_concurrency = arena.<span class="built_in">max_concurrency</span>();</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Task arena max concurrency: &quot;</span> &lt;&lt; max_concurrency &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">    arena.<span class="built_in">execute</span>([max_concurrency] {</span><br><span class="line">        tbb::<span class="built_in">parallel_for</span>(<span class="number">0</span>, <span class="number">16</span>, [](<span class="type">int</span> i) {</span><br><span class="line">            {</span><br><span class="line">                std::lock_guard&lt;std::mutex&gt; <span class="built_in">lock</span>(mtx);</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;Task arena thread &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; is running.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">        });</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 获取默认task_arena的最大并发线程数</span></span><br><span class="line">    <span class="type">int</span> arena_max_concurrency = tbb::this_task_arena::<span class="built_in">max_concurrency</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Default task_arena max concurrency: &quot;</span> &lt;&lt; arena_max_concurrency &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建两个线程</span></span><br><span class="line">    <span class="function">std::thread <span class="title">tg_thread</span><span class="params">(task_group_function)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">ta_thread</span><span class="params">(task_arena_function)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待两个线程完成</span></span><br><span class="line">    tg_thread.<span class="built_in">join</span>();</span><br><span class="line">    ta_thread.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>


<p>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; cmake .. &amp;&amp; make</span><br><span class="line">$ ./tbb_thread_pool &gt; result.txt</span><br><span class="line">$ <span class="built_in">cat</span> result.txt | grep running | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br><span class="line">Task arena thread 140667163379264 is running.</span><br><span class="line">Task arena thread 140667167639104 is running.</span><br><span class="line">Task arena thread 140667184678464 is running.</span><br><span class="line">Task arena thread 140667201848896 is running.</span><br><span class="line">Task group thread 140667167639104 is running.</span><br><span class="line">Task group thread 140667171898944 is running.</span><br><span class="line">Task group thread 140667176158784 is running.</span><br><span class="line">Task group thread 140667180418624 is running.</span><br><span class="line">Task group thread 140667188938304 is running.</span><br><span class="line">Task group thread 140667210303040 is running.</span><br></pre></td></tr></table></figure>

<p>从这两行日志可以看出，arena 和 group 重用了同一个线程 ID ，说明它们同属于同一个全局线程池。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Task arena thread 140667167639104 is running.</span><br><span class="line">Task group thread 140667167639104 is running.</span><br></pre></td></tr></table></figure>

<p>进一步，我们发现全局线程池中的线程总数是自适应的，比如本例就是 <code>10</code> 个，既不是 <code>task_group</code> 的 <code>8</code> 个，<br>也不是 <code>task_arena</code> 的 <code>4</code> 个：</p>
<p>TODO</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> result.txt | grep running | <span class="built_in">sort</span> | <span class="built_in">uniq</span> | <span class="built_in">wc</span> -l</span><br><span class="line">10</span><br></pre></td></tr></table></figure>

<h2 id="4-任务调度器（Task-Scheduler）"><a href="#4-任务调度器（Task-Scheduler）" class="headerlink" title="4. 任务调度器（Task Scheduler）"></a>4. 任务调度器（Task Scheduler）</h2><p><a target="_blank" rel="noopener" href="https://uxlfoundation.github.io/oneTBB/main/tbb_userguide/The_Task_Scheduler.html">The Task Scheduler</a></p>
<h3 id="4-1-基于任务编程（Task-Based-Programming）"><a href="#4-1-基于任务编程（Task-Based-Programming）" class="headerlink" title="4.1. 基于任务编程（Task-Based Programming）"></a>4.1. 基于任务编程（Task-Based Programming）</h3><p>当追求性能时，推荐以逻辑任务（logical tasks）而不是线程（threads）来编程，有以下原因：</p>
<ul>
<li>将并行性与可用资源匹配</li>
<li>更快的任务启动和关闭</li>
<li>更有效的评估顺序</li>
<li>改进负载均衡</li>
<li>更高层的思考</li>
</ul>
<p>TODO</p>
<h3 id="4-2-任务调度器（Task-Scheduler）如何工作"><a href="#4-2-任务调度器（Task-Scheduler）如何工作" class="headerlink" title="4.2. 任务调度器（Task Scheduler）如何工作"></a>4.2. 任务调度器（Task Scheduler）如何工作</h3><p><a target="_blank" rel="noopener" href="https://uxlfoundation.github.io/oneTBB/main/tbb_userguide/How_Task_Scheduler_Works.html">How Task Scheduler Works</a></p>
<h4 id="4-2-1-深度优先（depth-first）"><a href="#4-2-1-深度优先（depth-first）" class="headerlink" title="4.2.1. 深度优先（depth-first）"></a>4.2.1. 深度优先（depth-first）</h4><p>每个线程都有自己的双端队列，头部称为 top （也称顶部），尾部称为 bottom （也称底部）。<br>队列的底部是队列的最深处（最末处），底部任务是最新的，顶部任务是最旧的。</p>
<p>深度优先有以下好处：</p>
<ul>
<li><code>热点缓存命中</code>：最新的任务的缓存是最热的，所以优先执行新任务。</li>
<li><code>最小化空间</code>：广度优先会同时创建指数级数量的共存节点，而深度优先虽然也会创建相同数量的节点，但是只有线性数目的节点会同时共存，因为它创建了其他就绪任务的栈。</li>
</ul>
<p>生产：当线程产生一个任务时，将其放置到线程自身所有的 deque 的尾部。</p>
<p>消费：当线程执行任务时，根据以下规则顺序选取一个任务：</p>
<ul>
<li>规则1：获取上一个任务返回的任务，如果有；</li>
<li>规则2：从线程自己所有的 deque 尾部选取一个任务（即深度优先），如果有；</li>
<li>规则3：随机选择一个其他线程的 deque ，从其头部窃取一个任务（即广度优先）。如果被选 deque 为空，则重复本条规则直至成功。</li>
</ul>
<p>规则1 被称为“任务调度绕行（Task Scheduler Bypass）”。</p>
<p>规则2 是深度优先，这使得当前线程得以不断执行最新的任务直至其完成所有工作。</p>
<p>规则3 是临时的广度优先，它将潜在的并行转化为实际的并行。</p>
<h4 id="4-2-2-任务调度绕行（Task-Scheduler-Bypass）技术"><a href="#4-2-2-任务调度绕行（Task-Scheduler-Bypass）技术" class="headerlink" title="4.2.2. 任务调度绕行（Task Scheduler Bypass）技术"></a>4.2.2. 任务调度绕行（Task Scheduler Bypass）技术</h4><p>一个任务从产生到被执行涉及以下步骤：</p>
<blockquote>
<ul>
<li>将新任务加入线程的 deque 。</li>
<li>执行当前任务直至完成。</li>
<li>从线程 deque 获取一个任务执行，除非该任务被其他线程窃取走了。</li>
</ul>
</blockquote>
<p>其中，步骤1 和 步骤3 会引入不必要的 deque 操作，甚至更糟的是，允许窃取会损害局部性而不会增加显著的并行性。<br>任务调度器绕行技术可以直接指向下一个要被执行的任务，而不是生产该任务，从而避免了上述问题。<br>因为根据“规则1”，上一个任务产生的新任务会称为第一个备选任务。<br>此外，该技术几乎保证了该新任务被当前线程执行，而不是其他线程。</p>
<p>注意：当前唯一能使用该优化技术的是使用 <code>tbb::task_group</code> 。</p>
<h3 id="4-3-指导任务调度器的执行（Guiding-Task-Scheduler-Execution）"><a href="#4-3-指导任务调度器的执行（Guiding-Task-Scheduler-Execution）" class="headerlink" title="4.3. 指导任务调度器的执行（Guiding Task Scheduler Execution）"></a>4.3. 指导任务调度器的执行（Guiding Task Scheduler Execution）</h3><p><a target="_blank" rel="noopener" href="https://uxlfoundation.github.io/oneTBB/main/tbb_userguide/Guiding_Task_Scheduler_Execution.html">Guiding Task Scheduler Execution</a></p>
<p>默认情况下，任务计划程序会尝试使用所有可用的计算资源。在某些情况下，您可能希望将任务计划程序配置为仅使用其中的一些资源。</p>
<p>注意：指导任务调度程序的执行可能会导致可组合性问题。</p>
<p>TBB 提供 <code>task_arena</code> 接口，通过以下方式指导任务在 arena （竞技场）内被执行:</p>
<ul>
<li>设置首选计算单元；</li>
<li>限制部分计算单元。</li>
</ul>
<h3 id="4-4-工作隔离（Work-Isolation）"><a href="#4-4-工作隔离（Work-Isolation）" class="headerlink" title="4.4. 工作隔离（Work Isolation）"></a>4.4. 工作隔离（Work Isolation）</h3><p><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/docs/onetbb/developer-guide-api-reference/2021-12/work-isolation.html">Work Isolation</a></p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg1.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg1.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The first parallel loop.</span></span><br><span class="line">oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N1, []( <span class="type">int</span> i ) {</span><br><span class="line">    <span class="comment">// The second parallel loop.</span></span><br><span class="line">    oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N2, []( <span class="type">int</span> j ) { <span class="comment">/* Some work */</span> } );</span><br><span class="line">} );</span><br></pre></td></tr></table></figure>

<p>如果当前线程被 <code>parallel_for</code> “阻塞”（不是真正的阻塞，只能称为 a blocking parallel construct），那么该线程被允许拿取第一个循环的任务来执行。这会导致即使是同一个线程内，也可出现乱序执行的情况。在大多数情况下，这没有什么危害。</p>
<p>但是少数情况可能出现错误，例如一个 thread-local 变量可能会在嵌套并行构造之外意外被更改：</p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg2.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg2.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">oneapi::tbb::enumerable_thread_specific&lt;<span class="type">int</span>&gt; ets;</span><br><span class="line">oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N1, [&amp;ets]( <span class="type">int</span> i ) {</span><br><span class="line">    <span class="comment">// Set a thread specific value</span></span><br><span class="line">    ets.<span class="built_in">local</span>() = i;</span><br><span class="line">    oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N2, []( <span class="type">int</span> j ) { <span class="comment">/* Some work */</span> } );</span><br><span class="line">    <span class="comment">// While executing the above parallel_for, the thread might have run iterations</span></span><br><span class="line">    <span class="comment">// of the outer parallel_for, and so might have changed the thread specific value.</span></span><br><span class="line">    <span class="built_in">assert</span>( ets.<span class="built_in">local</span>()==i ); <span class="comment">// The assertion may fail!</span></span><br><span class="line">} );</span><br></pre></td></tr></table></figure>

<p>在其它场景下，这种行为可能会导致死锁或其他问题。在这些情况下，需要更有力地保证线程内的执行次序。为此，TBB 提供了一些隔离并行构造的执行的方法，以使其任务不会干扰其他同时运行的任务。</p>
<p>其中一种方法是在单独的 <code>task_arena</code> 中执行内层循环：</p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg3.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg3.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">oneapi::tbb::enumerable_thread_specific&lt;<span class="type">int</span>&gt; ets;</span><br><span class="line">oneapi::tbb::task_arena nested;</span><br><span class="line">oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N1, [&amp;]( <span class="type">int</span> i ) {</span><br><span class="line">    <span class="comment">// Set a thread specific value</span></span><br><span class="line">    ets.<span class="built_in">local</span>() = i;</span><br><span class="line">    nested.<span class="built_in">execute</span>( []{</span><br><span class="line">        <span class="comment">// Run the inner parallel_for in a separate arena to prevent the thread</span></span><br><span class="line">        <span class="comment">// from taking tasks of the outer parallel_for.</span></span><br><span class="line">        oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N2, []( <span class="type">int</span> j ) { <span class="comment">/* Some work */</span> } );</span><br><span class="line">    } );</span><br><span class="line">    <span class="built_in">assert</span>( ets.<span class="built_in">local</span>()==i ); <span class="comment">// Valid assertion</span></span><br><span class="line">} );</span><br></pre></td></tr></table></figure>

<p>然而，使用单独的 arena 进行工作隔离并不总是方便的，并且可能会产生明显的开销。为了解决这些缺点，TBB 提供 <code>this_task_arena::isolate</code> 函数，通过限制调用线程仅处理在函数对象范围内（也称为隔离区域）安排的任务，来隔离地运行一个用户提供的函数对象。</p>
<p>当一个线程进入一个任务等待调用或（等待）在一个隔离区域内的阻塞并行结构时，该线程只能执行在该隔离区域内生成的任务及其由其他线程生成的子任务（换句话说，即使子任务是由其他线程生成的，只要属于当前隔离区域，当前线程也可以执行这些任务）。线程被禁止执行任何外层任务或属于其他隔离区域的任务。</p>
<p>下面的示例展示了 <code>this_task_arena::isolate</code> 的使用，以保证在嵌套的并行结构调用时， thread-local 变量不会被意外修改：</p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg4.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg4.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;oneapi/tbb/task_arena.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;oneapi/tbb/parallel_for.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;oneapi/tbb/enumerable_thread_specific.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N1 = <span class="number">1000</span>, N2 = <span class="number">1000</span>;</span><br><span class="line">    oneapi::tbb::enumerable_thread_specific&lt;<span class="type">int</span>&gt; ets;</span><br><span class="line">    oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N1, [&amp;ets]( <span class="type">int</span> i ) {</span><br><span class="line">        <span class="comment">// Set a thread specific value</span></span><br><span class="line">        ets.<span class="built_in">local</span>() = i;</span><br><span class="line">        <span class="comment">// Run the second parallel loop in an isolated region to prevent the current thread</span></span><br><span class="line">        <span class="comment">// from taking tasks related to the outer parallel loop.</span></span><br><span class="line">        oneapi::tbb::this_task_arena::<span class="built_in">isolate</span>( []{</span><br><span class="line">            oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N2, []( <span class="type">int</span> j ) { <span class="comment">/* Some work */</span> } );</span><br><span class="line">        } );</span><br><span class="line">        <span class="built_in">assert</span>( ets.<span class="built_in">local</span>()==i ); <span class="comment">// Valid assertion</span></span><br><span class="line">    } );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>补充：</strong>让我们通过一个简单的例子来说明隔离区域内其他线程如何生成子任务，并且这些子任务可以由当前线程执行。</p>
<p>假设我们有一个隔离区域，其中有两个线程：线程A和线程B。我们在这个隔离区域内生成了一些任务，并且这些任务可能会生成子任务。</p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg5.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg5.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">taskA</span><span class="params">()</span> </span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Task A executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">    tbb::<span class="built_in">parallel_invoke</span>(</span><br><span class="line">         {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Subtask A1 executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">        },</span><br><span class="line">         {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Subtask A2 executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">    );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">taskB</span><span class="params">()</span> </span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Task B executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">    tbb::<span class="built_in">parallel_invoke</span>(</span><br><span class="line">         {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Subtask B1 executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">        },</span><br><span class="line">         {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Subtask B2 executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">    );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    tbb::task_arena arena;</span><br><span class="line">    arena.<span class="built_in">execute</span>([&amp;] {</span><br><span class="line">        tbb::this_task_arena::<span class="built_in">isolate</span>([&amp;] {</span><br><span class="line">            tbb::<span class="built_in">parallel_invoke</span>(taskA, taskB);</span><br><span class="line">        });</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>在这个例子中：</p>
<p>taskA 和 taskB 是在隔离区域内生成的任务。<br>taskA 生成了两个子任务 Subtask A1 和 Subtask A2。<br>taskB 生成了两个子任务 Subtask B1 和 Subtask B2。<br>假设线程A执行了 taskA，线程B执行了 taskB。在隔离区域内，线程A和线程B可以执行彼此生成的子任务。例如，线程A可以执行 Subtask B1 或 Subtask B2，而线程B可以执行 Subtask A1 或 Subtask A2，只要这些子任务属于同一个隔离区域。</p>
<h2 id="5-推荐阅读"><a href="#5-推荐阅读" class="headerlink" title="5. 推荐阅读"></a>5. 推荐阅读</h2><h3 id="5-1-书籍"><a href="#5-1-书籍" class="headerlink" title="5.1. 书籍"></a>5.1. 书籍</h3><ol>
<li>Intel Building Blocks 编程指南. James Reinders.</li>
<li>Patterns for Parallel Pragramming. Timothy Mattson 等.</li>
<li>设计模式：Design Patterns of Reusable Object-Oriented Software (Addison Wesley). Gamma, Helm, Johnson 和 Vlissides.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/02/02/cpp/gcc%E4%B8%8Eglibc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/02/02/cpp/gcc%E4%B8%8Eglibc/" class="post-title-link" itemprop="url">gcc 与 glibc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-02 13:24:45" itemprop="dateCreated datePublished" datetime="2024-02-02T13:24:45+00:00">2024-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="gcc"><a href="#gcc" class="headerlink" title="gcc"></a>gcc</h2><p>gcc是一个编译套件，包含c、c++、Fortran语言的编译器。</p>
<h2 id="glibc"><a href="#glibc" class="headerlink" title="glibc"></a>glibc</h2><p>glibc是一个library，为C程序提供基础公共功能，包括系统调用、数学函数和其他核心组件。<br>Linux平台和vscode似乎都依赖glibc，如果擅自将<code>LD_LIBRARY_PATH</code>更改为其他版本的glibc路径，则bash会直接crash。</p>
<h3 id="glibc包含以下bin和lib："><a href="#glibc包含以下bin和lib：" class="headerlink" title="glibc包含以下bin和lib："></a>glibc包含以下bin和lib：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> glibc-v2.34/Linux/RHEL7.0-2017-x86_64/bin &amp;&amp; <span class="built_in">ls</span></span><br><span class="line">catchsegv  getconf  iconv  locale     makedb  pcprofiledump  sotruss  tzselect  zdump</span><br><span class="line">gencat     getent   ldd    localedef  mtrace  pldd           sprof    xtrace</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入其他版本的glibc/lib目录执行ls命令会报错，大概原因可能是因为当前路径的glibc的lib和系统的lib冲突。</span></span><br><span class="line">$ <span class="built_in">cd</span> ../lib &amp;&amp; <span class="built_in">ls</span></span><br><span class="line"><span class="built_in">ls</span>: relocation error: ./libc.so.6: symbol __tunable_get_val, version GLIBC_PRIVATE not defined <span class="keyword">in</span> file ld-linux-x86-64.so.2 with <span class="built_in">link</span> time reference</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> .. &amp;&amp; <span class="built_in">ls</span> lib</span><br><span class="line">Mcrt1.o               libanl.so.1             libm.so             libnss_hesiod.so.2</span><br><span class="line">Scrt1.o               libc.a                  libm.so.6           libpcprofile.so</span><br><span class="line">audit                 libc.so                 libmcheck.a         libpthread.a</span><br><span class="line">crt1.o                libc.so.6               libmemusage.so      libpthread.so.0</span><br><span class="line">crti.o                libc_malloc_debug.so    libmvec.a           libresolv.a</span><br><span class="line">crtn.o                libc_malloc_debug.so.0  libmvec.so          libresolv.so</span><br><span class="line">gconv                 libc_nonshared.a        libmvec.so.1        libresolv.so.2</span><br><span class="line">gcrt1.o               libcrypt.a              libnsl.so.1         librt.a</span><br><span class="line">ld-linux-x86-64.so.2  libcrypt.so             libnss_compat.so    librt.so.1</span><br><span class="line">libBrokenLocale.a     libcrypt.so.1           libnss_compat.so.2  libthread_db.so</span><br><span class="line">libBrokenLocale.so    libdl.a                 libnss_db.so        libthread_db.so.1</span><br><span class="line">libBrokenLocale.so.1  libdl.so.2              libnss_db.so.2      libutil.a</span><br><span class="line">libSegFault.so        libg.a                  libnss_dns.so.2     libutil.so.1</span><br><span class="line">libanl.a              libm-2.34.a             libnss_files.so.2</span><br><span class="line">libanl.so             libm.a                  libnss_hesiod.so</span><br></pre></td></tr></table></figure>

<h3 id="查看glibc的版本："><a href="#查看glibc的版本：" class="headerlink" title="查看glibc的版本："></a>查看glibc的版本：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从上可知，ldd是glibc的核心组件之一</span></span><br><span class="line">$ ldd --version</span><br></pre></td></tr></table></figure>

<h3 id="寻找libc-so的路径："><a href="#寻找libc-so的路径：" class="headerlink" title="寻找libc.so的路径："></a>寻找libc.so的路径：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ locate libc.so</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libc.so</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">$ locate libstdc++.so</span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/11/libstdc++.so</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libstdc++.so.6</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30</span><br><span class="line">/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30-gdb.py</span><br></pre></td></tr></table></figure>

<h3 id="安装glibc："><a href="#安装glibc：" class="headerlink" title="安装glibc："></a>安装glibc：</h3><p>Ubuntu平台</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install lib6</span><br></pre></td></tr></table></figure>

<p>RedHat平台</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install glibc</span><br></pre></td></tr></table></figure>

<h3 id="检查GNC-C-Library-libstdc-的版本："><a href="#检查GNC-C-Library-libstdc-的版本：" class="headerlink" title="检查GNC C++ Library (libstdc++)的版本："></a>检查GNC C++ Library (libstdc++)的版本：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ strings /usr/lib/libstdc++.so.* | grep LIBCXX</span><br><span class="line">[sjcvl-zhigaoz ] /lan/cva_rel/vxe_main/24.02.650.d000/tools.lnx86/lib/64bit % strings /usr/lib/libstdc++.so.* | grep LIBCXX</span><br><span class="line">GLIBCXX_3.4</span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line">...</span><br><span class="line">GLIBCXX_3.4.19</span><br><span class="line">GLIBCXX_DEBUG_MESSAGE_LENGTH</span><br><span class="line"></span><br><span class="line">$ strings /usr/lib/libc.so.* | grep GLIBC</span><br><span class="line">GLIBC_2.0</span><br><span class="line">GLIBC_2.1</span><br><span class="line">GLIBC_2.1.1</span><br><span class="line">...</span><br><span class="line">GLIBC_2.17</span><br><span class="line">GLIBC_PRIVATE</span><br></pre></td></tr></table></figure>

<p>如果你有一个使用了libstdc++的特定的binary或application，可以用下面的命令来检查其版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ldd &lt;your_binary_or_application&gt; | grep libstdc++</span><br></pre></td></tr></table></figure>

<p>使用vscode的“Remote SSH”工具试图连接到Linux时，可能会报错如下：</p>
<blockquote>
<p>Warning: Missing GLIBCXX &gt;&#x3D; 3.4.25! from &#x2F;usr&#x2F;lib64&#x2F;libstdc++.so.6.0.19<br>Warning: Missing GLIBC &gt;&#x3D; 2.28! from &#x2F;usr&#x2F;lib64&#x2F;libc-2.17.so<br>Error: Missing required dependencies. Please refer to our FAQ <a target="_blank" rel="noopener" href="https://aka.ms/vscode-remote/faq/old-linux">https://aka.ms/vscode-remote/faq/old-linux</a> for additional information.</p>
</blockquote>
<p>这是因为Linux系统上的glibc版本中不包含GLIBCXX_3.4.25及以上的版本。此时需要降级vscode（建议做法）或升级glibc（似乎很难）。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/30/misc/%E8%AE%A1%E6%97%B6%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/30/misc/%E8%AE%A1%E6%97%B6%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">计时工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-30 11:07:39" itemprop="dateCreated datePublished" datetime="2024-01-30T11:07:39+00:00">2024-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="times"><a href="#times" class="headerlink" title="times"></a>times</h2><ol>
<li>bash built-in</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">times</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>function</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/times.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">clock_t</span> <span class="title">times</span><span class="params">(<span class="keyword">struct</span> tms *buf)</span></span>;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/29/linux/Introduction-to-memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/29/linux/Introduction-to-memory/" class="post-title-link" itemprop="url">Introduction to memory</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-29 14:25:24" itemprop="dateCreated datePublished" datetime="2024-01-29T14:25:24+00:00">2024-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="malloc-free"><a href="#malloc-free" class="headerlink" title="malloc&#x2F;free"></a>malloc&#x2F;free</h2><p>See <a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Backtraces.html">this example</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span> ** <span class="title">backtrace_symbols</span> <span class="params">(<span class="type">void</span> *<span class="type">const</span> *buffer, <span class="type">int</span> size)</span> </span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The return value of backtrace_symbols is a pointer obtained via the malloc function, and it is the responsibility of the caller to free that pointer. Note that only the return value need be freed, not the individual strings.</p>
</blockquote>
<p>Question: Why does it say “only the return value need be freed, not the individual strings”?</p>
<p>Let us observe the defintion of the <code>malloc</code>&#x2F;<code>free</code> functions first:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">malloc</span><span class="params">( <span class="type">size_t</span> size )</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">( <span class="type">void</span> *ptr )</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>free</code> takes a <code>void*</code> pointer to deallocate the memory, it doesn’t care what type it is, even if it is a multi-level pointer. It means that <code>malloc</code> has stored the memory size in some place and <code>free</code> will find it beforing deallocate the memory.</p>
<p>Let us return the question. The memory pointer returned by <code>backtrace_symbols</code> is the <code>char**</code> type, it must be a whole block contigunous memory using <code>malloc</code> and might be enforced to be transformed as <code>char**</code> pointer when returing. So when we <code>free</code> the memory block, the Linux kernel find its actual memory size and deallocate it.</p>
<p>Example:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span>** strings = (<span class="type">char</span>**)<span class="built_in">malloc</span>(<span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">char</span>*) + <span class="number">3</span> * <span class="number">50</span>); <span class="comment">// assuming a maximum 50 characters per sentence</span></span><br><span class="line">    <span class="type">char</span>* block = (<span class="type">char</span>*)(strings + <span class="number">3</span>);</span><br><span class="line">    <span class="type">char</span>* s1 = <span class="built_in">strcpy</span>(block, <span class="string">&quot;The first sentence&quot;</span>); block += <span class="built_in">strlen</span>(s1) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span>* s2 = <span class="built_in">strcpy</span>(block, <span class="string">&quot;The second sentence&quot;</span>); block += <span class="built_in">strlen</span>(s2) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span>* s3 = <span class="built_in">strcpy</span>(block, <span class="string">&quot;The third sentence&quot;</span>);</span><br><span class="line">    strings[<span class="number">0</span>] = s1;</span><br><span class="line">    strings[<span class="number">1</span>] = s2;</span><br><span class="line">    strings[<span class="number">2</span>] = s3;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, strings[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(strings); <span class="comment">// deallocate all memory at once</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>More elegant but less economical code:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span>** strings = (<span class="type">char</span>**)<span class="built_in">malloc</span>(<span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">char</span>*) + <span class="number">3</span> * <span class="number">50</span>);</span><br><span class="line">    <span class="type">char</span>* block = (<span class="type">char</span>*)(strings + <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        strings[i] = block + i * <span class="number">50</span>; <span class="comment">// Assuming a maximum of 50 characters per sentence</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(strings[<span class="number">0</span>], <span class="string">&quot;The first sentence&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(strings[<span class="number">1</span>], <span class="string">&quot;The second sentence&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(strings[<span class="number">2</span>], <span class="string">&quot;The third sentence&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, strings[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(strings); <span class="comment">// deallocate all memory at once</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Memory_002dmapped-I_002fO.html">The GNU C Library (glibc) manual: 13.8 Memory-mapped I&#x2F;O</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Memory-Protection.html">The GNU C Library (glibc) manual: 3.4 Memory Protection</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/29/UML/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/29/UML/" class="post-title-link" itemprop="url">UML</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-29 11:10:46" itemprop="dateCreated datePublished" datetime="2024-01-29T11:10:46+00:00">2024-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1176331">认识UML类关系——依赖、关联、聚合、组合、泛化</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/26/linux/Shell-Commands/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/26/linux/Shell-Commands/" class="post-title-link" itemprop="url">Shell Commands</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-26 15:57:35" itemprop="dateCreated datePublished" datetime="2024-01-26T15:57:35+00:00">2024-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="shuf"><a href="#shuf" class="headerlink" title="shuf"></a>shuf</h2><h2 id="cut"><a href="#cut" class="headerlink" title="cut"></a>cut</h2><h2 id="tr"><a href="#tr" class="headerlink" title="tr"></a>tr</h2><h2 id="lp"><a href="#lp" class="headerlink" title="lp"></a>lp</h2><h2 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h2><p>Options:</p>
<pre><code>-t, --field-separator=SEP
    use SEP instead of non-blank to blank transition

-k, --key=POS1[,POS2]
    start a key at POS1 (origin 1), end it at POS2 (default end of line)

-h, --human-numeric-sort
    compare human readable numbers (e.g., 2K 1G)

-n, --numeric-sort
    compare according to string numerical value
</code></pre>
<h2 id="nproc"><a href="#nproc" class="headerlink" title="nproc"></a>nproc</h2><p>print the number of processing units avaiable.</p>
<h2 id="od-xxd-hexdump"><a href="#od-xxd-hexdump" class="headerlink" title="od &#x2F; xxd &#x2F; hexdump"></a>od &#x2F; xxd &#x2F; hexdump</h2><p>read the binary file.</p>
<p>Notes: byte order</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;ABCD&quot;</span> | xxd</span><br><span class="line">00000000: 4142 4344                                ABCD</span><br><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;ABCD&quot;</span> | hexdump</span><br><span class="line">0000000 4241 4443                              </span><br><span class="line">0000004</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/282215/how-to-view-a-binary-file">Reference</a></p>
<h2 id="comm-diff-tkdiff-cmp"><a href="#comm-diff-tkdiff-cmp" class="headerlink" title="comm &#x2F; diff &#x2F; tkdiff &#x2F; cmp"></a>comm &#x2F; diff &#x2F; tkdiff &#x2F; cmp</h2><p>Can be used to compare binary or non-binary files.</p>
<h3 id="comm"><a href="#comm" class="headerlink" title="comm"></a>comm</h3><p>compare two sorted files line by line.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> file1.txt </span><br><span class="line">apple</span><br><span class="line">banana</span><br><span class="line">cherry</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> file2.txt </span><br><span class="line">banana</span><br><span class="line">cherry</span><br><span class="line"><span class="built_in">date</span></span><br><span class="line">erase</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">comm</span> file1.txt file2.txt </span><br><span class="line">apple</span><br><span class="line">                banana</span><br><span class="line">                cherry</span><br><span class="line">        <span class="built_in">date</span></span><br><span class="line">        erase</span><br></pre></td></tr></table></figure>

<p>The file must be sorted before using the <code>comm</code> command. Otherwise it will complain that:</p>
<pre><code>comm: file 1 is not in sorted order
</code></pre>
<p>and cannot work correctly. For example,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> file1.txt </span><br><span class="line">apple</span><br><span class="line">cherry</span><br><span class="line">banana</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> file2.txt </span><br><span class="line">banana</span><br><span class="line">cherry</span><br><span class="line"><span class="built_in">date</span></span><br><span class="line">erase</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">comm</span> file1.txt file2.txt </span><br><span class="line">apple</span><br><span class="line">        banana</span><br><span class="line">                cherry</span><br><span class="line"><span class="built_in">comm</span>: file 1 is not <span class="keyword">in</span> sorted order</span><br><span class="line">banana</span><br><span class="line">        <span class="built_in">date</span></span><br><span class="line">        erase</span><br><span class="line"><span class="built_in">comm</span>: input is not <span class="keyword">in</span> sorted order</span><br></pre></td></tr></table></figure>

<h3 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h3><p>Syntax:</p>
<pre><code>diff -u file1 file2
</code></pre>
<p>Options:</p>
<pre><code>-e, --ed
    output an ed script

-u, -U NUM, --unified[=NUM]
    output NUM (default 3) lines of unified context
    (that is, print NUM lines before and after the difference line)
</code></pre>
<h3 id="tkdiff"><a href="#tkdiff" class="headerlink" title="tkdiff"></a>tkdiff</h3><p>Use a GUI to display the differences.</p>
<h3 id="cmp"><a href="#cmp" class="headerlink" title="cmp"></a>cmp</h3><p>Prints less information comparing to <code>diff</code>.</p>
<p>Syntax:</p>
<pre><code>cmp file1 file2
</code></pre>
<h2 id="ed-vim-sed-awk"><a href="#ed-vim-sed-awk" class="headerlink" title="ed&#x2F;vim&#x2F;sed&#x2F;awk"></a>ed&#x2F;vim&#x2F;sed&#x2F;awk</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/26/cpp/C++%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%97%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/26/cpp/C++%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%97%E8%A1%A8/" class="post-title-link" itemprop="url">C++ 初始化列表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-26 10:31:32" itemprop="dateCreated datePublished" datetime="2024-01-26T10:31:32+00:00">2024-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="列表初始化"><a href="#列表初始化" class="headerlink" title="列表初始化"></a>列表初始化</h2><p>struct&#x2F;union&#x2F;array默认支持列表初始化。</p>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/language/struct_initialization">Struct and union initialization</a><br><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/language/array_initialization">Array initialization</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="comment">// #include &lt;initializer_list&gt;</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x, y, z; <span class="comment">// 注意：数据成员必须是public的。</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; z &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec_;</span><br><span class="line">    <span class="type">int</span> x_;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;vec_=&#123; &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x : vec_) &#123;</span><br><span class="line">            cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&#125;, x_=&quot;</span> &lt;&lt; x_ &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec_;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;vec_=&#123; &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x : vec_) &#123;</span><br><span class="line">            cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&#125;&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// C++会构造一个列表初始化的默认构造函数，</span></span><br><span class="line">    <span class="comment">// 以下(1)和(2)都是调用这个默认构造函数。</span></span><br><span class="line">    A a1&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;; <span class="comment">// (1) 列表初始化</span></span><br><span class="line">    <span class="function">A <span class="title">a2</span><span class="params">(&#123;<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;)</span></span>; <span class="comment">// (2) 同(1)</span></span><br><span class="line">    a1.<span class="built_in">print</span>();</span><br><span class="line">    a2.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    B b1&#123;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;, <span class="number">4</span>&#125;; <span class="comment">// 内部的&quot;&#123;1,2,3&#125;&quot;用于构造vec_，&quot;4&quot;用于初始化x_</span></span><br><span class="line">    b1.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// C C1&#123;1,2,3&#125;; // (1) 这里会报错&quot;error: too many initializers for ‘C’&quot;，</span></span><br><span class="line">    <span class="comment">//              //     因为C只有一个数据成员vec_，这里却传入了3个参数</span></span><br><span class="line">    C c2&#123;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;&#125;; <span class="comment">// (2) 其中，内部的&quot;&#123;1,2,3&#125;&quot;用于构造vec_，外层的&quot;&#123;&#125;&quot;用于对c2本身进行构造</span></span><br><span class="line">    c2.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="std-initializer-list"><a href="#std-initializer-list" class="headerlink" title="std::initializer_list"></a>std::initializer_list</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initializer_list&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="type">int</span> x, y, z;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">A</span>(initializer_list&lt;<span class="type">int</span>&gt; il) &#123;</span><br><span class="line">        initializer_list&lt;<span class="type">int</span>&gt;::iterator it = il.<span class="built_in">begin</span>();</span><br><span class="line">        x = *it++;</span><br><span class="line">        y = *it++;</span><br><span class="line">        z = *it++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; z &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">B</span> &#123;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">B</span>(initializer_list&lt;<span class="type">int</span>&gt; il) &#123;</span><br><span class="line">        vec = il; <span class="comment">// 用initializer_list初始化vector</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&#123; &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x : vec) &#123;</span><br><span class="line">            cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&#125;&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">    a.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    B b&#123;<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    b.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/25/linux/Brackets-in-Bash/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/25/linux/Brackets-in-Bash/" class="post-title-link" itemprop="url">Brackets in Bash</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-25 13:22:53" itemprop="dateCreated datePublished" datetime="2024-01-25T13:22:53+00:00">2024-01-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="中括号"><a href="#中括号" class="headerlink" title="中括号"></a>中括号</h2><ol>
<li><p><code>[ ]</code>和<code>test</code>是bash的内部命令，<code>[[ ]]</code>是shell的条件判断关键字。</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">type</span> [</span><br><span class="line">[ is a shell <span class="built_in">builtin</span></span><br><span class="line">$ <span class="built_in">type</span> <span class="built_in">test</span></span><br><span class="line"><span class="built_in">test</span> is a shell <span class="built_in">builtin</span></span><br><span class="line">$ <span class="built_in">type</span> [[</span><br><span class="line">[[ is a shell keyword</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[ ]</code>和<code>test</code>是等价的，用于评估条件表达式。可以使用<code>man [</code>或<code>help [</code>查阅帮助文档。</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">help</span> [</span><br><span class="line">[: [ arg... ]</span><br><span class="line">    Evaluate conditional expression.</span><br><span class="line">    </span><br><span class="line">    This is a synonym <span class="keyword">for</span> the <span class="string">&quot;test&quot;</span> <span class="built_in">builtin</span>, but the last argument must</span><br><span class="line">    be a literal `]<span class="string">&#x27;, to match the opening `[&#x27;</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[[ ]]</code>关键字可以屏蔽shell特殊符号，比如<code>&amp;&amp;</code>、<code>||</code>、<code>&gt;</code>和<code>&lt;</code>可以被认为是条件判断符而不是重定向符。</p>
</li>
<li><p><code>[ ]</code>中使用<code>-a</code>和<code>-o</code>表示逻辑与和逻辑或，<code>[[ ]]</code>中则使用<code>&amp;&amp;</code>和<code>||</code>。</p>
</li>
</ol>
<h2 id="小括号"><a href="#小括号" class="headerlink" title="小括号"></a>小括号</h2><ol>
<li><code>$()</code>用于命令替换。</li>
<li>双小括号<code>(( ))</code>：在比较过程中使用高级数学表达式。</li>
</ol>
<h2 id="大括号"><a href="#大括号" class="headerlink" title="大括号"></a>大括号</h2><p>请阅读：<a target="_blank" rel="noopener" href="https://www.linux.com/topic/desktop/all-about-curly-braces-bash/">All about {Curly Braces} in Bash</a></p>
<ol>
<li><p><code>$&#123;&#125;</code>用于引用变量。</p>
<p> 与<code>$var</code>相比，<code>$&#123;var&#125;</code>是一种消除歧义的措施，比如：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ var=abc</span><br><span class="line">$ vartest=ABC</span><br><span class="line"><span class="comment"># $var引用变量&#x27;var&#x27;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$var</span></span><br><span class="line">abc</span><br><span class="line"><span class="comment"># 引用变量&#x27;vartest&#x27;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$vartest</span></span><br><span class="line">ABC</span><br><span class="line"><span class="comment"># 引用变量&#x27;var&#x27;并在其后加上&#x27;test&#x27;字符</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var&#125;</span><span class="built_in">test</span></span><br><span class="line">abctest</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&#123;&#125;</code>表示分组。</p>
</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zeweiwu/p/5485711.html">Shell中test、单中括号、双中括号的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/linux/bash-single-vs-double-brackets">Differences Between Single and Double Brackets in Bash</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3e1eaaa3fee8">Shell中的括号、双括号、方括号和双方括号</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/25/linux/Regular-Expression/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/25/linux/Regular-Expression/" class="post-title-link" itemprop="url">Regular Expression</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-25 13:13:41" itemprop="dateCreated datePublished" datetime="2024-01-25T13:13:41+00:00">2024-01-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-17 07:56:27" itemprop="dateModified" datetime="2025-08-17T07:56:27+00:00">2025-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="regexp"><a href="#regexp" class="headerlink" title="regexp"></a>regexp</h2><h2 id="ERegExp"><a href="#ERegExp" class="headerlink" title="ERegExp"></a>ERegExp</h2><h2 id="Wildcard-Glob"><a href="#Wildcard-Glob" class="headerlink" title="Wildcard&#x2F;Glob"></a>Wildcard&#x2F;Glob</h2><p><code>man 7 glob</code></p>
<blockquote>
<p>glob - globbing pathnames. glob is a shell built-in.</p>
<p>主要用于匹配带有通配符的文件路径。其匹配字符串的能力比正则表达式弱。</p>
<p>它最初是贝尔实验室 Unix 系统上的一个名叫 glob 的命令（glob 是 global 的缩写），用于展开命令行中的通配符。后来系统提供了该功能的 C 语言库函数glob()，知名的 shell 解释器就使用了该接口，shell 脚本和命令行中使用的 glob 模式匹配功能便源自于此。——见<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904077801816077">博客</a>。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://tldp.org/LDP/GNU-Linux-Tools-Summary/html/x11655.htm">Wildcards</a></p>
<p><code>&#123;&#125;</code>严格来讲不属于glob的范畴，其在shell表示一个分组，见：<a target="_blank" rel="noopener" href="https://www.linux.com/topic/desktop/all-about-curly-braces-bash/">All about {Curly Braces} in Bash</a>。</p>
<h2 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h2><h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><p><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/nl/aix/7.2?topic=awk-command">awk Command</a></p>
<h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">&#x27; *|:&#x27;</span> <span class="string">&#x27;/LISTEN/&#123;print $2&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>其中，<code>-F</code>表示分隔符；<br><code> *|:</code>是一个正则表达式，表示以”一个或多个空格”或”:”作为分隔符；<br>再其后的<code>//</code>中是另一个正则表达式，用于匹配文本；<br><code>&#123;&#125;</code>中是action。</p>
<h3 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h3><p><a target="_blank" rel="noopener" href="https://tecadmin.net/awk-conditional-statements/">if-else in awk</a><br><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/660178/how-to-use-and-and-or-together-in-an-awk-program">use AND and OR in an awk program</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;if ($1 &gt; 49151 &amp;&amp; $1 &lt; 65536) &#123;print $1&#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>等价于</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;$1 &gt; 49151 &amp;&amp; $1 &lt; 65536&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="BEGIN-END"><a href="#BEGIN-END" class="headerlink" title="BEGIN&#x2F;END"></a>BEGIN&#x2F;END</h3><p>In AWK, <code>BEGIN</code> and <code>END</code> are special patterns that allow you to execute code before processing the input (<code>BEGIN</code>) or after processing all the input (<code>END</code>).</p>
<ul>
<li>The <code>BEGIN</code> block is executed once at the beginning of the AWK program and it is typically used for initializing variables or performing setup tasks.</li>
<li>The <code>END</code> block is executed once after processing all input, and it is commonly used for final caclucations, summaries, or printing results.</li>
</ul>
<h3 id="Special-symbols"><a href="#Special-symbols" class="headerlink" title="Special symbols"></a>Special symbols</h3><ul>
<li><code>$</code> 用于引用field，例如<code>$1</code>代表第一个field（典型来说是第一列）。</li>
<li><code>NF</code> 表示number of filed，假设一共有7列，那么<code>$NF</code>与<code>$7</code>等价。</li>
</ul>
<h2 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h2><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><ol>
<li>找出一个未使用的port</li>
</ol>
<div class="tabs" id="code"><ul class="nav-tabs"><li class="tab active"><a href="#code-1">Makefile</a></li><li class="tab"><a href="#code-2">Bash</a></li><li class="tab"><a href="#code-3">Python</a></li></ul><div class="tab-content"><div class="tab-pane active" id="code-1"><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &quot;$$&quot;是为了转义&quot;$&quot;</span></span><br><span class="line">max_port=<span class="variable">$(<span class="built_in">shell</span> netstat -antulpen 2&gt; /dev/null \</span></span><br><span class="line"><span class="variable">    | awk -F&#x27; *&#x27; &#x27;/^(tcp|udp)</span>/&#123;print $$4&#125;&#x27; | cut -d: -f 2 \</span><br><span class="line">    | egrep <span class="string">&quot;\w&quot;</span> | sort | tail -1)</span><br><span class="line"><span class="comment">#$(warning $&#123;max_port&#125;)</span></span><br><span class="line">port=<span class="variable">$(<span class="built_in">shell</span> expr <span class="variable">$(max_port)</span> + 1)</span></span><br><span class="line"><span class="comment">#$(warning $&#123;port&#125;)</span></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="code-2"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从1025开始找出已经存在的端口，如果相邻端口的gap大于1，则返回“当前端口号+1”</span></span><br><span class="line">netstat -ant | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span> \</span><br><span class="line">    | awk -F: <span class="string">&#x27;&#123;if ($NF ~ /^[0-9]+$/ &amp;&amp; $NF &gt; 1024) &#123;print $NF&#125;&#125;&#x27;</span> \</span><br><span class="line">    | awk <span class="string">&#x27;BEGIN &#123;prev = 1024&#125; </span></span><br><span class="line"><span class="string">        &#123;if ($1 - prev &gt; 1) &#123; port = prev + 1; exit&#125; else &#123; prev = $1&#125;&#125; </span></span><br><span class="line"><span class="string">        END &#123; if (port==&quot;&quot;) &#123;print prev + 1&#125; else &#123;print port&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="code-3"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这不是正则表达式</span></span><br><span class="line"><span class="comment">#以0端口为参数创建一个socket，则系统会自动选择一个未使用的端口号</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#one-line mode:</span></span><br><span class="line"><span class="comment">#python -c &#x27;import socket; s=socket.socket(); s.bind((&quot;&quot;, 0)); print(s.getsockname()[1]); s.close()&#x27;</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">addr = s.getsockname()</span><br><span class="line"><span class="built_in">print</span>(addr[<span class="number">1</span>])</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure></div></div></div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/blog/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/9/">9</a><a class="extend next" rel="next" href="/blog/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bi-an"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">bi-an</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">84</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bi-an" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;bi-an" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ah_zzg@126.com" title="E-Mail → mailto:ah_zzg@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://bi-an.github.io/cuda-doc" title="http:&#x2F;&#x2F;bi-an.github.io&#x2F;cuda-doc">CUDA笔记</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://infiniband-doc.readthedocs.io/" title="https:&#x2F;&#x2F;infiniband-doc.readthedocs.io&#x2F;" rel="noopener" target="_blank">InfiniBand笔记</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bi-an</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

</body>
</html>
