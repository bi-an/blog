<!DOCTYPE html>
<html lang="en, zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bi-an.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:url" content="https://bi-an.github.io/blog/page/3/index.html">
<meta property="og:site_name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
<meta property="og:locale">
<meta property="article:author" content="bi-an">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bi-an.github.io/blog/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en, zh_CN'
  };
</script>

  <title>æ±Ÿå—äººç‰©çš„åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æ±Ÿå—äººç‰©çš„åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/blog/resources/" rel="section"><i class="fa fa-paperclip fa-fw"></i>Resource</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/05/08/english/Hair/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/05/08/english/Hair/" class="post-title-link" itemprop="url">Hair</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-08 22:10:46" itemprop="dateCreated datePublished" datetime="2024-05-08T22:10:46+00:00">2024-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/English/" itemprop="url" rel="index"><span itemprop="name">English</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h2><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=EzFtsYC4pPg&t=344s">Free English Class! Topic: Hair! ğŸ§”ğŸ½ğŸ’‡âœ‚ï¸ (Lesson Only)</a></p>
<h2 id="Words-Phrases"><a href="#Words-Phrases" class="headerlink" title="Words&#x2F;Phrases"></a>Words&#x2F;Phrases</h2><p>eyelashes<br>makeup<br>hairstyle&#x2F;hairdo<br>get my hair done<br>hair gel<br>buzz cut<br>helmet<br>When you have a lot of hair, the helmet makes your hair flat.<br>hair colouring</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/03/22/concurrency/Multi-Thread-and-Signals/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/03/22/concurrency/Multi-Thread-and-Signals/" class="post-title-link" itemprop="url">Multi Thread and Signals</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-22 15:20:14" itemprop="dateCreated datePublished" datetime="2024-03-22T15:20:14+00:00">2024-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>From ChatGPT:</p>
<p>In general, when a program enters a signal handler in a multi-threaded environment, the behavior regarding other threads depends on how the signal handler is set up and the specific signal that is being handled.</p>
<ol>
<li>Default Behavior: By default, when a signal is delivered to a process, it interrupt the thread that is currently running and executes the signal handler in the context of that thread. Other threads in the process continue running unless they are also interrupted by signals.</li>
<li>Thread-Specific Signal Handling: Some signals, such as SIGINT (interrupt signal), SIGTERM (termination signal), or SIGABRT (abort signal), are typically delivered to the entire process, which means they can interrupt any thread. However, other signals, like SIGSEGV (segmentation fault) or SIGILL (illegal signal), are usually delivered to the specific thread that caused the signal.</li>
<li>Signal Masking: In a multi-threaded program, you can use signal masking (sigprocmask in POSIX systems) to block certain signals in specific threads. This can affect whether a signal handler interrupts a particular thread or not.</li>
<li>Asynchronous-Signal-Safe Functions: Signal handlers should only execute functions are considered â€œasynchronous-signal-safeâ€ according to POSIX standards. These functions are designed to be safe to call from within a signal handler. Using non-safe functions in a signal handler can lead to undefined behavior.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/02/24/concurrency/TBB%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/02/24/concurrency/TBB%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">TBBå…¥é—¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-24 14:59:52" itemprop="dateCreated datePublished" datetime="2024-02-24T14:59:52+00:00">2024-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-æ§åˆ¶çº¿ç¨‹æ•°"><a href="#1-æ§åˆ¶çº¿ç¨‹æ•°" class="headerlink" title="1. æ§åˆ¶çº¿ç¨‹æ•°"></a>1. æ§åˆ¶çº¿ç¨‹æ•°</h2><ul>
<li>Method 1: Use the environment variable <code>TBB_NUM_THREADS</code> for the gloabl setting.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> TBB_NUM_THREADS=4</span><br></pre></td></tr></table></figure>

<p>TODO: It doesnâ€™t seem to work!</p>
<ul>
<li>Method 2: Use <code>tbb::task_arena</code> or <code>tbb::task_scheduler_init</code> (Deprecated).</li>
</ul>
<p>TBB will use this setting locally within the scope of the <code>tbb::task_arena</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/pipeline.h&gt;</span></span></span><br><span class="line"><span class="comment">// Deprecated:</span></span><br><span class="line"><span class="comment">// #include &lt;tbb/task_scheduler_init.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/task_arena.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Define your pipeline body</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPipeline</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(tbb::flow_control&amp; fc)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Your pipeline logic here</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Inform the pipeline that there is no more data</span></span><br><span class="line">        fc.<span class="built_in">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Deprecated: tbb::task_scheduler_init init(1);</span></span><br><span class="line">    <span class="function">tbb::task_arena <span class="title">arena</span><span class="params">(<span class="number">4</span>)</span></span>; <span class="comment">// 4 threads</span></span><br><span class="line">    <span class="comment">// Do some tasks:</span></span><br><span class="line">    tbb::<span class="built_in">parallel_pipeline</span>(<span class="comment">/* max_number_of_live_tokens */</span> <span class="number">4</span>, MyPipeline); <span class="comment">// <span class="doctag">FIXME:</span> ä¼¼ä¹éœ€è¦æ”¾å…¥ arena çš„ execute å‡½æ•°ä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-parallel-for"><a href="#2-parallel-for" class="headerlink" title="2. parallel_for"></a>2. <code>parallel_for</code></h2><p>API: <a target="_blank" rel="noopener" href="https://oneapi-spec.uxlfoundation.org/specifications/oneapi/latest/elements/onetbb/source/algorithms/functions/parallel_for_func">parallel_for</a></p>
<ol>
<li>ç”¨ <code>my_parallel_for</code> æ¨¡æ‹Ÿ <code>parallel_for</code> çš„å®ç°ï¼š</li>
</ol>
<figure class="highlight cpp"><figcaption><span>my_parallel_for.cpp</span><a href="/blog/downloads/code/TBB/my_parallel_for.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿ parallel_for çš„å†…éƒ¨å®ç°</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">my_parallel_for</span><span class="params">(<span class="type">const</span> tbb::blocked_range&lt;<span class="type">size_t</span>&gt;&amp; range, <span class="type">const</span> std::function&lt;<span class="type">void</span>(<span class="type">const</span> tbb::blocked_range&lt;<span class="type">size_t</span>&gt;&amp;)&gt;&amp; body)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (range.<span class="built_in">is_divisible</span>()) {</span><br><span class="line">        <span class="comment">// åˆ†å‰²èŒƒå›´</span></span><br><span class="line">        <span class="function">tbb::blocked_range&lt;<span class="type">size_t</span>&gt; <span class="title">left</span><span class="params">(range.begin(), range.begin() + (range.end() - range.begin()) / <span class="number">2</span>)</span></span>;</span><br><span class="line">        <span class="function">tbb::blocked_range&lt;<span class="type">size_t</span>&gt; <span class="title">right</span><span class="params">(left.end(), range.end())</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€’å½’è°ƒç”¨</span></span><br><span class="line">        tbb::<span class="built_in">parallel_invoke</span>(</span><br><span class="line">            [&amp;] { <span class="built_in">my_parallel_for</span>(left, body); },</span><br><span class="line">            [&amp;] { <span class="built_in">my_parallel_for</span>(right, body); }</span><br><span class="line">        );</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// å¤„ç†å½“å‰èŒƒå›´</span></span><br><span class="line">        <span class="built_in">body</span>(range);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">data</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) {</span><br><span class="line">        data[i] = i;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çš„ parallel_for è¿›è¡Œå¹¶è¡Œå¤„ç†</span></span><br><span class="line">    <span class="built_in">my_parallel_for</span>(tbb::<span class="built_in">blocked_range</span>&lt;<span class="type">size_t</span>&gt;(<span class="number">0</span>, data.<span class="built_in">size</span>()), [&amp;](<span class="type">const</span> tbb::blocked_range&lt;<span class="type">size_t</span>&gt;&amp; r) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = r.<span class="built_in">begin</span>(); i != r.<span class="built_in">end</span>(); ++i) {</span><br><span class="line">            data[i] *= <span class="number">2</span>; <span class="comment">// ç¤ºä¾‹æ“ä½œï¼šå°†æ¯ä¸ªå…ƒç´ ä¹˜ä»¥2</span></span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºç»“æœ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; val : data) {</span><br><span class="line">        std::cout &lt;&lt; val &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    }</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å‘å‡ºä»»åŠ¡çš„çº¿ç¨‹ä¹Ÿä¼šæˆä¸ºå·¥ä½œçº¿ç¨‹ä¹‹ä¸€ï¼Œå¹¶å‚ä¸ä»»åŠ¡çš„æ‰§è¡Œï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<figure class="highlight cpp"><figcaption><span>test_parallel_for.cpp</span><a href="/blog/downloads/code/TBB/test_parallel_for.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tbb;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> std::atomic&lt;<span class="type">int</span>&gt; <span class="title">total_blocks</span><span class="params">(<span class="number">0</span>)</span></span>;  <span class="comment">// Atomic counter to track the number of tasks processed</span></span><br><span class="line"><span class="function"><span class="type">static</span> std::atomic&lt;<span class="type">int</span>&gt; <span class="title">total_blocks2</span><span class="params">(<span class="number">0</span>)</span></span>;  <span class="comment">// Atomic counter to track the number of tasks processed</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Function to process each data element</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process_data</span><span class="params">(<span class="type">int</span> i, std::mutex&amp; mtx)</span> </span>{</span><br><span class="line">    <span class="comment">// std::this_thread::sleep_for(std::chrono::milliseconds(1));  // Simulate some processing time</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i)</span><br><span class="line">        ;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Usage: &quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &lt;number_of_elements&gt;&quot;</span></span><br><span class="line">                  &lt;&lt; <span class="string">&quot;&lt;grain_size&gt;&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> num_elements = std::<span class="built_in">stoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">int</span> grain_size = std::<span class="built_in">stoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    std::mutex mtx;</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">data</span><span class="params">(num_elements)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_elements; ++i) {</span><br><span class="line">        data[i] = i;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// {</span></span><br><span class="line">    <span class="comment">//     std::lock_guard&lt;std::mutex&gt; lock(mtx);</span></span><br><span class="line">    <span class="comment">//     std::cout &lt;&lt; &quot;Main thread ID: &quot; &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">// }</span></span><br><span class="line"></span><br><span class="line">    tbb::concurrent_unordered_map&lt;std::thread::id, tbb::concurrent_vector&lt;<span class="type">int</span>&gt;&gt; thread_task_counts;  <span class="comment">// To store task counts for each thread</span></span><br><span class="line">    tbb::concurrent_unordered_map&lt;std::thread::id, tbb::concurrent_vector&lt;<span class="type">int</span>&gt;&gt; thread_task_counts2;  <span class="comment">// To store task counts for each thread</span></span><br><span class="line"></span><br><span class="line">    tbb::<span class="built_in">parallel_for</span>(<span class="number">0</span>, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;((data.<span class="built_in">size</span>() + grain_size - <span class="number">1</span>) / grain_size), [&amp;](<span class="type">int</span> i) {</span><br><span class="line">        total_blocks++;</span><br><span class="line">        <span class="type">int</span> cnt = <span class="number">0</span>;  <span class="comment">// Thread-local variable to avoid data</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = i * grain_size; j &lt; std::<span class="built_in">min</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(data.<span class="built_in">size</span>()), (i + <span class="number">1</span>) * grain_size); ++j) {</span><br><span class="line">            <span class="built_in">process_data</span>(i, mtx);</span><br><span class="line">            ++cnt;</span><br><span class="line">        }</span><br><span class="line">        thread_task_counts[std::this_thread::<span class="built_in">get_id</span>()].<span class="built_in">push_back</span>(cnt);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    tbb::<span class="built_in">parallel_for</span>(<span class="built_in">blocked_range</span>&lt;<span class="type">int</span>&gt;(<span class="number">0u</span>, data.<span class="built_in">size</span>(), grain_size), [&amp;](<span class="type">const</span> blocked_range&lt;<span class="type">int</span>&gt;&amp; r) {</span><br><span class="line">        total_blocks2++;</span><br><span class="line">        <span class="type">int</span> cnt = <span class="number">0</span>;  <span class="comment">// Thread-local variable to avoid data</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = r.<span class="built_in">begin</span>(); i &lt; r.<span class="built_in">end</span>(); ++i) {</span><br><span class="line">            <span class="built_in">process_data</span>(i, mtx);</span><br><span class="line">            ++cnt;</span><br><span class="line">        }</span><br><span class="line">        thread_task_counts2[std::this_thread::<span class="built_in">get_id</span>()].<span class="built_in">push_back</span>(cnt);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Total blocks processed: &quot;</span> &lt;&lt; total_blocks.<span class="built_in">load</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; pair : thread_task_counts) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread &quot;</span> &lt;&lt; pair.first &lt;&lt; <span class="string">&quot; processed: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; task_count : pair.second)</span><br><span class="line">            std::cout &lt;&lt; task_count &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Total blocks2 processed: &quot;</span> &lt;&lt; total_blocks2.<span class="built_in">load</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; pair : thread_task_counts2) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Thread &quot;</span> &lt;&lt; pair.first &lt;&lt; <span class="string">&quot; processed: &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; task_count : pair.second)</span><br><span class="line">            std::cout &lt;&lt; task_count &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./test_parallel_for </span><br><span class="line">Main thread ID: 140220582070080</span><br><span class="line">Processing data: 2 on thread 140220582070080</span><br><span class="line">Processing data: 6 on thread 140220557755968</span><br><span class="line">Processing data: 4 on thread 140220574795328</span><br><span class="line">Processing data: 8 on thread 140220566275648</span><br><span class="line">Processing data: 10 on thread 140220562015808</span><br></pre></td></tr></table></figure>

<p>å¯è§ï¼Œ<code>data 2</code> æ˜¯ç”±ä¸»çº¿ç¨‹å¤„ç†çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>parallel_for</code> è™½ç„¶è¢«ç§°ä¸º a blocking parallel construtï¼Œä½†çº¿ç¨‹ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®ŒæˆæœŸé—´æ˜¯éé˜»å¡çš„ï¼Œå®ƒè¿˜å¯ä»¥å……å½“å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ± ä¸­çš„ä»»åŠ¡ã€‚</p>
<p>ä»£ç æ¨¡æ‹Ÿ <code>parallel_for</code> çš„ <code>wait</code> ï¼š</p>
<figure class="highlight cpp"><figcaption><span>my_task_scheduler.cpp</span><a href="/blog/downloads/code/TBB/my_task_scheduler.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskScheduler</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TaskScheduler</span>(<span class="type">size_t</span> numThreads);</span><br><span class="line">    ~<span class="built_in">TaskScheduler</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">enqueue</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">wait</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;std::thread&gt; workers;</span><br><span class="line">    std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; tasks;</span><br><span class="line">    std::mutex queueMutex;</span><br><span class="line">    std::condition_variable condition;</span><br><span class="line">    std::condition_variable finished;</span><br><span class="line">    <span class="type">bool</span> stop;</span><br><span class="line">    <span class="type">size_t</span> activeTasks;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">workerThread</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">executeTask</span><span class="params">()</span></span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">TaskScheduler::<span class="built_in">TaskScheduler</span>(<span class="type">size_t</span> numThreads) : <span class="built_in">stop</span>(<span class="literal">false</span>), <span class="built_in">activeTasks</span>(<span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; numThreads; ++i) {</span><br><span class="line">        workers.<span class="built_in">emplace_back</span>(&amp;TaskScheduler::workerThread, <span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TaskScheduler::~<span class="built_in">TaskScheduler</span>() {</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">        stop = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    condition.<span class="built_in">notify_all</span>();</span><br><span class="line">    <span class="keyword">for</span> (std::thread &amp;worker : workers) {</span><br><span class="line">        worker.<span class="built_in">join</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskScheduler::enqueue</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task)</span> </span>{</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">        tasks.<span class="built_in">push</span>(std::<span class="built_in">move</span>(task));</span><br><span class="line">    }</span><br><span class="line">    condition.<span class="built_in">notify_one</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskScheduler::wait</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (!tasks.<span class="built_in">empty</span>() || activeTasks &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// å¦‚æœè¿˜æœ‰ä»»åŠ¡ï¼Œæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œé¿å…å½“å‰çº¿ç¨‹è¢«é˜»å¡</span></span><br><span class="line">        <span class="keyword">if</span> (!tasks.<span class="built_in">empty</span>()) {</span><br><span class="line">            <span class="built_in">executeTask</span>();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            finished.<span class="built_in">wait</span>(lock);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskScheduler::workerThread</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        std::function&lt;<span class="type">void</span>()&gt; task;</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">            condition.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>] { <span class="keyword">return</span> stop || !tasks.<span class="built_in">empty</span>(); });</span><br><span class="line">            <span class="keyword">if</span> (stop &amp;&amp; tasks.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line">            task = std::<span class="built_in">move</span>(tasks.<span class="built_in">front</span>());</span><br><span class="line">            tasks.<span class="built_in">pop</span>();</span><br><span class="line">            ++activeTasks;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">task</span>();</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">            --activeTasks;</span><br><span class="line">            <span class="keyword">if</span> (tasks.<span class="built_in">empty</span>() &amp;&amp; activeTasks == <span class="number">0</span>) {</span><br><span class="line">                finished.<span class="built_in">notify_all</span>();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskScheduler::executeTask</span><span class="params">()</span> </span>{</span><br><span class="line">    std::function&lt;<span class="type">void</span>()&gt; task;</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (tasks.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line">        task = std::<span class="built_in">move</span>(tasks.<span class="built_in">front</span>());</span><br><span class="line">        tasks.<span class="built_in">pop</span>();</span><br><span class="line">        ++activeTasks;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">task</span>();</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queueMutex)</span></span>;</span><br><span class="line">        --activeTasks;</span><br><span class="line">        <span class="keyword">if</span> (tasks.<span class="built_in">empty</span>() &amp;&amp; activeTasks == <span class="number">0</span>) {</span><br><span class="line">            finished.<span class="built_in">notify_all</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">parallel_for</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end, std::function&lt;<span class="type">void</span>(<span class="type">int</span>)&gt; func)</span> </span>{</span><br><span class="line">    <span class="function"><span class="type">static</span> TaskScheduler <span class="title">scheduler</span><span class="params">(std::thread::hardware_concurrency())</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt; end; ++i) {</span><br><span class="line">        scheduler.<span class="built_in">enqueue</span>([i, &amp;func] { <span class="built_in">func</span>(i); });</span><br><span class="line">    }</span><br><span class="line">    scheduler.<span class="built_in">wait</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N1 = <span class="number">100</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N2 = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first parallel loop.</span></span><br><span class="line">    <span class="built_in">parallel_for</span>(<span class="number">0</span>, N1, [&amp;](<span class="type">int</span> i) {</span><br><span class="line">        <span class="comment">// The second parallel loop.</span></span><br><span class="line">        <span class="built_in">parallel_for</span>(<span class="number">0</span>, N2, [&amp;](<span class="type">int</span> j) {</span><br><span class="line">            <span class="comment">// Some work</span></span><br><span class="line">        });</span><br><span class="line">        <span class="comment">// çº¿ç¨‹å‘å‡º parallel_for ä¹‹åï¼Œéœ€è¦ç­‰å¾…å†…éƒ¨æ‰€æœ‰ parallel loop çš„ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">        <span class="comment">// åœ¨æ­¤æœŸé—´å…è®¸ç»§ç»­æ‹¿å–å¤–éƒ¨çš„ parallel loop çš„ä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="3-TBBçº¿ç¨‹æ± "><a href="#3-TBBçº¿ç¨‹æ± " class="headerlink" title="3. TBBçº¿ç¨‹æ± "></a>3. TBBçº¿ç¨‹æ± </h2><p>TBBä¼¼ä¹æ€»æ˜¯ä½¿ç”¨åŒä¸€ä¸ªå…¨å±€çº¿ç¨‹æ± ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><figcaption><span>tbb_thread_pool.cpp</span><a href="/blog/downloads/code/TBB/tbb_thread_pool.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">std::mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">task_group_function</span><span class="params">()</span> </span>{</span><br><span class="line">    tbb::task_group tg;</span><br><span class="line">    <span class="type">int</span> max_concurrency = tbb::this_task_arena::<span class="built_in">max_concurrency</span>();</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Task group max concurrency: &quot;</span> &lt;&lt; max_concurrency &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) {</span><br><span class="line">        tg.<span class="built_in">run</span>([i] {</span><br><span class="line">            {</span><br><span class="line">                std::lock_guard&lt;std::mutex&gt; <span class="built_in">lock</span>(mtx);</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;Task group thread &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; is running.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    tg.<span class="built_in">wait</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">task_arena_function</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">tbb::task_arena <span class="title">arena</span><span class="params">(<span class="number">4</span>)</span></span>;</span><br><span class="line">    <span class="type">int</span> max_concurrency = arena.<span class="built_in">max_concurrency</span>();</span><br><span class="line">    {</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Task arena max concurrency: &quot;</span> &lt;&lt; max_concurrency &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">    arena.<span class="built_in">execute</span>([max_concurrency] {</span><br><span class="line">        tbb::<span class="built_in">parallel_for</span>(<span class="number">0</span>, <span class="number">16</span>, [](<span class="type">int</span> i) {</span><br><span class="line">            {</span><br><span class="line">                std::lock_guard&lt;std::mutex&gt; <span class="built_in">lock</span>(mtx);</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;Task arena thread &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; is running.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">        });</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// è·å–é»˜è®¤task_arenaçš„æœ€å¤§å¹¶å‘çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="type">int</span> arena_max_concurrency = tbb::this_task_arena::<span class="built_in">max_concurrency</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Default task_arena max concurrency: &quot;</span> &lt;&lt; arena_max_concurrency &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="function">std::thread <span class="title">tg_thread</span><span class="params">(task_group_function)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">ta_thread</span><span class="params">(task_arena_function)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¸¤ä¸ªçº¿ç¨‹å®Œæˆ</span></span><br><span class="line">    tg_thread.<span class="built_in">join</span>();</span><br><span class="line">    ta_thread.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>


<p>æµ‹è¯•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; cmake .. &amp;&amp; make</span><br><span class="line">$ ./tbb_thread_pool &gt; result.txt</span><br><span class="line">$ <span class="built_in">cat</span> result.txt | grep running | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br><span class="line">Task arena thread 140667163379264 is running.</span><br><span class="line">Task arena thread 140667167639104 is running.</span><br><span class="line">Task arena thread 140667184678464 is running.</span><br><span class="line">Task arena thread 140667201848896 is running.</span><br><span class="line">Task group thread 140667167639104 is running.</span><br><span class="line">Task group thread 140667171898944 is running.</span><br><span class="line">Task group thread 140667176158784 is running.</span><br><span class="line">Task group thread 140667180418624 is running.</span><br><span class="line">Task group thread 140667188938304 is running.</span><br><span class="line">Task group thread 140667210303040 is running.</span><br></pre></td></tr></table></figure>

<p>ä»è¿™ä¸¤è¡Œæ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œarena å’Œ group é‡ç”¨äº†åŒä¸€ä¸ªçº¿ç¨‹ ID ï¼Œè¯´æ˜å®ƒä»¬åŒå±äºåŒä¸€ä¸ªå…¨å±€çº¿ç¨‹æ± ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Task arena thread 140667167639104 is running.</span><br><span class="line">Task group thread 140667167639104 is running.</span><br></pre></td></tr></table></figure>

<p>è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬å‘ç°å…¨å±€çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ€»æ•°æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚æœ¬ä¾‹å°±æ˜¯ <code>10</code> ä¸ªï¼Œæ—¢ä¸æ˜¯ <code>task_group</code> çš„ <code>8</code> ä¸ªï¼Œ<br>ä¹Ÿä¸æ˜¯ <code>task_arena</code> çš„ <code>4</code> ä¸ªï¼š</p>
<p>TODO</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> result.txt | grep running | <span class="built_in">sort</span> | <span class="built_in">uniq</span> | <span class="built_in">wc</span> -l</span><br><span class="line">10</span><br></pre></td></tr></table></figure>

<h2 id="4-ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask-Schedulerï¼‰"><a href="#4-ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask-Schedulerï¼‰" class="headerlink" title="4. ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask Schedulerï¼‰"></a>4. ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask Schedulerï¼‰</h2><p><a target="_blank" rel="noopener" href="https://uxlfoundation.github.io/oneTBB/main/tbb_userguide/The_Task_Scheduler.html">The Task Scheduler</a></p>
<h3 id="4-1-åŸºäºä»»åŠ¡ç¼–ç¨‹ï¼ˆTask-Based-Programmingï¼‰"><a href="#4-1-åŸºäºä»»åŠ¡ç¼–ç¨‹ï¼ˆTask-Based-Programmingï¼‰" class="headerlink" title="4.1. åŸºäºä»»åŠ¡ç¼–ç¨‹ï¼ˆTask-Based Programmingï¼‰"></a>4.1. åŸºäºä»»åŠ¡ç¼–ç¨‹ï¼ˆTask-Based Programmingï¼‰</h3><p>å½“è¿½æ±‚æ€§èƒ½æ—¶ï¼Œæ¨èä»¥é€»è¾‘ä»»åŠ¡ï¼ˆlogical tasksï¼‰è€Œä¸æ˜¯çº¿ç¨‹ï¼ˆthreadsï¼‰æ¥ç¼–ç¨‹ï¼Œæœ‰ä»¥ä¸‹åŸå› ï¼š</p>
<ul>
<li>å°†å¹¶è¡Œæ€§ä¸å¯ç”¨èµ„æºåŒ¹é…</li>
<li>æ›´å¿«çš„ä»»åŠ¡å¯åŠ¨å’Œå…³é—­</li>
<li>æ›´æœ‰æ•ˆçš„è¯„ä¼°é¡ºåº</li>
<li>æ”¹è¿›è´Ÿè½½å‡è¡¡</li>
<li>æ›´é«˜å±‚çš„æ€è€ƒ</li>
</ul>
<p>TODO</p>
<h3 id="4-2-ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask-Schedulerï¼‰å¦‚ä½•å·¥ä½œ"><a href="#4-2-ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask-Schedulerï¼‰å¦‚ä½•å·¥ä½œ" class="headerlink" title="4.2. ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask Schedulerï¼‰å¦‚ä½•å·¥ä½œ"></a>4.2. ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask Schedulerï¼‰å¦‚ä½•å·¥ä½œ</h3><p><a target="_blank" rel="noopener" href="https://uxlfoundation.github.io/oneTBB/main/tbb_userguide/How_Task_Scheduler_Works.html">How Task Scheduler Works</a></p>
<h4 id="4-2-1-æ·±åº¦ä¼˜å…ˆï¼ˆdepth-firstï¼‰"><a href="#4-2-1-æ·±åº¦ä¼˜å…ˆï¼ˆdepth-firstï¼‰" class="headerlink" title="4.2.1. æ·±åº¦ä¼˜å…ˆï¼ˆdepth-firstï¼‰"></a>4.2.1. æ·±åº¦ä¼˜å…ˆï¼ˆdepth-firstï¼‰</h4><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„åŒç«¯é˜Ÿåˆ—ï¼Œå¤´éƒ¨ç§°ä¸º top ï¼ˆä¹Ÿç§°é¡¶éƒ¨ï¼‰ï¼Œå°¾éƒ¨ç§°ä¸º bottom ï¼ˆä¹Ÿç§°åº•éƒ¨ï¼‰ã€‚<br>é˜Ÿåˆ—çš„åº•éƒ¨æ˜¯é˜Ÿåˆ—çš„æœ€æ·±å¤„ï¼ˆæœ€æœ«å¤„ï¼‰ï¼Œåº•éƒ¨ä»»åŠ¡æ˜¯æœ€æ–°çš„ï¼Œé¡¶éƒ¨ä»»åŠ¡æ˜¯æœ€æ—§çš„ã€‚</p>
<p>æ·±åº¦ä¼˜å…ˆæœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p>
<ul>
<li><code>çƒ­ç‚¹ç¼“å­˜å‘½ä¸­</code>ï¼šæœ€æ–°çš„ä»»åŠ¡çš„ç¼“å­˜æ˜¯æœ€çƒ­çš„ï¼Œæ‰€ä»¥ä¼˜å…ˆæ‰§è¡Œæ–°ä»»åŠ¡ã€‚</li>
<li><code>æœ€å°åŒ–ç©ºé—´</code>ï¼šå¹¿åº¦ä¼˜å…ˆä¼šåŒæ—¶åˆ›å»ºæŒ‡æ•°çº§æ•°é‡çš„å…±å­˜èŠ‚ç‚¹ï¼Œè€Œæ·±åº¦ä¼˜å…ˆè™½ç„¶ä¹Ÿä¼šåˆ›å»ºç›¸åŒæ•°é‡çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯åªæœ‰çº¿æ€§æ•°ç›®çš„èŠ‚ç‚¹ä¼šåŒæ—¶å…±å­˜ï¼Œå› ä¸ºå®ƒåˆ›å»ºäº†å…¶ä»–å°±ç»ªä»»åŠ¡çš„æ ˆã€‚</li>
</ul>
<p>ç”Ÿäº§ï¼šå½“çº¿ç¨‹äº§ç”Ÿä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œå°†å…¶æ”¾ç½®åˆ°çº¿ç¨‹è‡ªèº«æ‰€æœ‰çš„ deque çš„å°¾éƒ¨ã€‚</p>
<p>æ¶ˆè´¹ï¼šå½“çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œæ ¹æ®ä»¥ä¸‹è§„åˆ™é¡ºåºé€‰å–ä¸€ä¸ªä»»åŠ¡ï¼š</p>
<ul>
<li>è§„åˆ™1ï¼šè·å–ä¸Šä¸€ä¸ªä»»åŠ¡è¿”å›çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ï¼›</li>
<li>è§„åˆ™2ï¼šä»çº¿ç¨‹è‡ªå·±æ‰€æœ‰çš„ deque å°¾éƒ¨é€‰å–ä¸€ä¸ªä»»åŠ¡ï¼ˆå³æ·±åº¦ä¼˜å…ˆï¼‰ï¼Œå¦‚æœæœ‰ï¼›</li>
<li>è§„åˆ™3ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªå…¶ä»–çº¿ç¨‹çš„ deque ï¼Œä»å…¶å¤´éƒ¨çªƒå–ä¸€ä¸ªä»»åŠ¡ï¼ˆå³å¹¿åº¦ä¼˜å…ˆï¼‰ã€‚å¦‚æœè¢«é€‰ deque ä¸ºç©ºï¼Œåˆ™é‡å¤æœ¬æ¡è§„åˆ™ç›´è‡³æˆåŠŸã€‚</li>
</ul>
<p>è§„åˆ™1 è¢«ç§°ä¸ºâ€œä»»åŠ¡è°ƒåº¦ç»•è¡Œï¼ˆTask Scheduler Bypassï¼‰â€ã€‚</p>
<p>è§„åˆ™2 æ˜¯æ·±åº¦ä¼˜å…ˆï¼Œè¿™ä½¿å¾—å½“å‰çº¿ç¨‹å¾—ä»¥ä¸æ–­æ‰§è¡Œæœ€æ–°çš„ä»»åŠ¡ç›´è‡³å…¶å®Œæˆæ‰€æœ‰å·¥ä½œã€‚</p>
<p>è§„åˆ™3 æ˜¯ä¸´æ—¶çš„å¹¿åº¦ä¼˜å…ˆï¼Œå®ƒå°†æ½œåœ¨çš„å¹¶è¡Œè½¬åŒ–ä¸ºå®é™…çš„å¹¶è¡Œã€‚</p>
<h4 id="4-2-2-ä»»åŠ¡è°ƒåº¦ç»•è¡Œï¼ˆTask-Scheduler-Bypassï¼‰æŠ€æœ¯"><a href="#4-2-2-ä»»åŠ¡è°ƒåº¦ç»•è¡Œï¼ˆTask-Scheduler-Bypassï¼‰æŠ€æœ¯" class="headerlink" title="4.2.2. ä»»åŠ¡è°ƒåº¦ç»•è¡Œï¼ˆTask Scheduler Bypassï¼‰æŠ€æœ¯"></a>4.2.2. ä»»åŠ¡è°ƒåº¦ç»•è¡Œï¼ˆTask Scheduler Bypassï¼‰æŠ€æœ¯</h4><p>ä¸€ä¸ªä»»åŠ¡ä»äº§ç”Ÿåˆ°è¢«æ‰§è¡Œæ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š</p>
<blockquote>
<ul>
<li>å°†æ–°ä»»åŠ¡åŠ å…¥çº¿ç¨‹çš„ deque ã€‚</li>
<li>æ‰§è¡Œå½“å‰ä»»åŠ¡ç›´è‡³å®Œæˆã€‚</li>
<li>ä»çº¿ç¨‹ deque è·å–ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œé™¤éè¯¥ä»»åŠ¡è¢«å…¶ä»–çº¿ç¨‹çªƒå–èµ°äº†ã€‚</li>
</ul>
</blockquote>
<p>å…¶ä¸­ï¼Œæ­¥éª¤1 å’Œ æ­¥éª¤3 ä¼šå¼•å…¥ä¸å¿…è¦çš„ deque æ“ä½œï¼Œç”šè‡³æ›´ç³Ÿçš„æ˜¯ï¼Œå…è®¸çªƒå–ä¼šæŸå®³å±€éƒ¨æ€§è€Œä¸ä¼šå¢åŠ æ˜¾è‘—çš„å¹¶è¡Œæ€§ã€‚<br>ä»»åŠ¡è°ƒåº¦å™¨ç»•è¡ŒæŠ€æœ¯å¯ä»¥ç›´æ¥æŒ‡å‘ä¸‹ä¸€ä¸ªè¦è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç”Ÿäº§è¯¥ä»»åŠ¡ï¼Œä»è€Œé¿å…äº†ä¸Šè¿°é—®é¢˜ã€‚<br>å› ä¸ºæ ¹æ®â€œè§„åˆ™1â€ï¼Œä¸Šä¸€ä¸ªä»»åŠ¡äº§ç”Ÿçš„æ–°ä»»åŠ¡ä¼šç§°ä¸ºç¬¬ä¸€ä¸ªå¤‡é€‰ä»»åŠ¡ã€‚<br>æ­¤å¤–ï¼Œè¯¥æŠ€æœ¯å‡ ä¹ä¿è¯äº†è¯¥æ–°ä»»åŠ¡è¢«å½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»–çº¿ç¨‹ã€‚</p>
<p>æ³¨æ„ï¼šå½“å‰å”¯ä¸€èƒ½ä½¿ç”¨è¯¥ä¼˜åŒ–æŠ€æœ¯çš„æ˜¯ä½¿ç”¨ <code>tbb::task_group</code> ã€‚</p>
<h3 id="4-3-æŒ‡å¯¼ä»»åŠ¡è°ƒåº¦å™¨çš„æ‰§è¡Œï¼ˆGuiding-Task-Scheduler-Executionï¼‰"><a href="#4-3-æŒ‡å¯¼ä»»åŠ¡è°ƒåº¦å™¨çš„æ‰§è¡Œï¼ˆGuiding-Task-Scheduler-Executionï¼‰" class="headerlink" title="4.3. æŒ‡å¯¼ä»»åŠ¡è°ƒåº¦å™¨çš„æ‰§è¡Œï¼ˆGuiding Task Scheduler Executionï¼‰"></a>4.3. æŒ‡å¯¼ä»»åŠ¡è°ƒåº¦å™¨çš„æ‰§è¡Œï¼ˆGuiding Task Scheduler Executionï¼‰</h3><p><a target="_blank" rel="noopener" href="https://uxlfoundation.github.io/oneTBB/main/tbb_userguide/Guiding_Task_Scheduler_Execution.html">Guiding Task Scheduler Execution</a></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»åŠ¡è®¡åˆ’ç¨‹åºä¼šå°è¯•ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„è®¡ç®—èµ„æºã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°†ä»»åŠ¡è®¡åˆ’ç¨‹åºé…ç½®ä¸ºä»…ä½¿ç”¨å…¶ä¸­çš„ä¸€äº›èµ„æºã€‚</p>
<p>æ³¨æ„ï¼šæŒ‡å¯¼ä»»åŠ¡è°ƒåº¦ç¨‹åºçš„æ‰§è¡Œå¯èƒ½ä¼šå¯¼è‡´å¯ç»„åˆæ€§é—®é¢˜ã€‚</p>
<p>TBB æä¾› <code>task_arena</code> æ¥å£ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼æŒ‡å¯¼ä»»åŠ¡åœ¨ arena ï¼ˆç«æŠ€åœºï¼‰å†…è¢«æ‰§è¡Œ:</p>
<ul>
<li>è®¾ç½®é¦–é€‰è®¡ç®—å•å…ƒï¼›</li>
<li>é™åˆ¶éƒ¨åˆ†è®¡ç®—å•å…ƒã€‚</li>
</ul>
<h3 id="4-4-å·¥ä½œéš”ç¦»ï¼ˆWork-Isolationï¼‰"><a href="#4-4-å·¥ä½œéš”ç¦»ï¼ˆWork-Isolationï¼‰" class="headerlink" title="4.4. å·¥ä½œéš”ç¦»ï¼ˆWork Isolationï¼‰"></a>4.4. å·¥ä½œéš”ç¦»ï¼ˆWork Isolationï¼‰</h3><p><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/docs/onetbb/developer-guide-api-reference/2021-12/work-isolation.html">Work Isolation</a></p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg1.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg1.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The first parallel loop.</span></span><br><span class="line">oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N1, []( <span class="type">int</span> i ) {</span><br><span class="line">    <span class="comment">// The second parallel loop.</span></span><br><span class="line">    oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N2, []( <span class="type">int</span> j ) { <span class="comment">/* Some work */</span> } );</span><br><span class="line">} );</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå½“å‰çº¿ç¨‹è¢« <code>parallel_for</code> â€œé˜»å¡â€ï¼ˆä¸æ˜¯çœŸæ­£çš„é˜»å¡ï¼Œåªèƒ½ç§°ä¸º a blocking parallel constructï¼‰ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹è¢«å…è®¸æ‹¿å–ç¬¬ä¸€ä¸ªå¾ªç¯çš„ä»»åŠ¡æ¥æ‰§è¡Œã€‚è¿™ä¼šå¯¼è‡´å³ä½¿æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼Œä¹Ÿå¯å‡ºç°ä¹±åºæ‰§è¡Œçš„æƒ…å†µã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™æ²¡æœ‰ä»€ä¹ˆå±å®³ã€‚</p>
<p>ä½†æ˜¯å°‘æ•°æƒ…å†µå¯èƒ½å‡ºç°é”™è¯¯ï¼Œä¾‹å¦‚ä¸€ä¸ª thread-local å˜é‡å¯èƒ½ä¼šåœ¨åµŒå¥—å¹¶è¡Œæ„é€ ä¹‹å¤–æ„å¤–è¢«æ›´æ”¹ï¼š</p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg2.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg2.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">oneapi::tbb::enumerable_thread_specific&lt;<span class="type">int</span>&gt; ets;</span><br><span class="line">oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N1, [&amp;ets]( <span class="type">int</span> i ) {</span><br><span class="line">    <span class="comment">// Set a thread specific value</span></span><br><span class="line">    ets.<span class="built_in">local</span>() = i;</span><br><span class="line">    oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N2, []( <span class="type">int</span> j ) { <span class="comment">/* Some work */</span> } );</span><br><span class="line">    <span class="comment">// While executing the above parallel_for, the thread might have run iterations</span></span><br><span class="line">    <span class="comment">// of the outer parallel_for, and so might have changed the thread specific value.</span></span><br><span class="line">    <span class="built_in">assert</span>( ets.<span class="built_in">local</span>()==i ); <span class="comment">// The assertion may fail!</span></span><br><span class="line">} );</span><br></pre></td></tr></table></figure>

<p>åœ¨å…¶å®ƒåœºæ™¯ä¸‹ï¼Œè¿™ç§è¡Œä¸ºå¯èƒ½ä¼šå¯¼è‡´æ­»é”æˆ–å…¶ä»–é—®é¢˜ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œéœ€è¦æ›´æœ‰åŠ›åœ°ä¿è¯çº¿ç¨‹å†…çš„æ‰§è¡Œæ¬¡åºã€‚ä¸ºæ­¤ï¼ŒTBB æä¾›äº†ä¸€äº›éš”ç¦»å¹¶è¡Œæ„é€ çš„æ‰§è¡Œçš„æ–¹æ³•ï¼Œä»¥ä½¿å…¶ä»»åŠ¡ä¸ä¼šå¹²æ‰°å…¶ä»–åŒæ—¶è¿è¡Œçš„ä»»åŠ¡ã€‚</p>
<p>å…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯åœ¨å•ç‹¬çš„ <code>task_arena</code> ä¸­æ‰§è¡Œå†…å±‚å¾ªç¯ï¼š</p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg3.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg3.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">oneapi::tbb::enumerable_thread_specific&lt;<span class="type">int</span>&gt; ets;</span><br><span class="line">oneapi::tbb::task_arena nested;</span><br><span class="line">oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N1, [&amp;]( <span class="type">int</span> i ) {</span><br><span class="line">    <span class="comment">// Set a thread specific value</span></span><br><span class="line">    ets.<span class="built_in">local</span>() = i;</span><br><span class="line">    nested.<span class="built_in">execute</span>( []{</span><br><span class="line">        <span class="comment">// Run the inner parallel_for in a separate arena to prevent the thread</span></span><br><span class="line">        <span class="comment">// from taking tasks of the outer parallel_for.</span></span><br><span class="line">        oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N2, []( <span class="type">int</span> j ) { <span class="comment">/* Some work */</span> } );</span><br><span class="line">    } );</span><br><span class="line">    <span class="built_in">assert</span>( ets.<span class="built_in">local</span>()==i ); <span class="comment">// Valid assertion</span></span><br><span class="line">} );</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œï¼Œä½¿ç”¨å•ç‹¬çš„ arena è¿›è¡Œå·¥ä½œéš”ç¦»å¹¶ä¸æ€»æ˜¯æ–¹ä¾¿çš„ï¼Œå¹¶ä¸”å¯èƒ½ä¼šäº§ç”Ÿæ˜æ˜¾çš„å¼€é”€ã€‚ä¸ºäº†è§£å†³è¿™äº›ç¼ºç‚¹ï¼ŒTBB æä¾› <code>this_task_arena::isolate</code> å‡½æ•°ï¼Œé€šè¿‡é™åˆ¶è°ƒç”¨çº¿ç¨‹ä»…å¤„ç†åœ¨å‡½æ•°å¯¹è±¡èŒƒå›´å†…ï¼ˆä¹Ÿç§°ä¸ºéš”ç¦»åŒºåŸŸï¼‰å®‰æ’çš„ä»»åŠ¡ï¼Œæ¥éš”ç¦»åœ°è¿è¡Œä¸€ä¸ªç”¨æˆ·æä¾›çš„å‡½æ•°å¯¹è±¡ã€‚</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸€ä¸ªä»»åŠ¡ç­‰å¾…è°ƒç”¨æˆ–ï¼ˆç­‰å¾…ï¼‰åœ¨ä¸€ä¸ªéš”ç¦»åŒºåŸŸå†…çš„é˜»å¡å¹¶è¡Œç»“æ„æ—¶ï¼Œè¯¥çº¿ç¨‹åªèƒ½æ‰§è¡Œåœ¨è¯¥éš”ç¦»åŒºåŸŸå†…ç”Ÿæˆçš„ä»»åŠ¡åŠå…¶ç”±å…¶ä»–çº¿ç¨‹ç”Ÿæˆçš„å­ä»»åŠ¡ï¼ˆæ¢å¥è¯è¯´ï¼Œå³ä½¿å­ä»»åŠ¡æ˜¯ç”±å…¶ä»–çº¿ç¨‹ç”Ÿæˆçš„ï¼Œåªè¦å±äºå½“å‰éš”ç¦»åŒºåŸŸï¼Œå½“å‰çº¿ç¨‹ä¹Ÿå¯ä»¥æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼‰ã€‚çº¿ç¨‹è¢«ç¦æ­¢æ‰§è¡Œä»»ä½•å¤–å±‚ä»»åŠ¡æˆ–å±äºå…¶ä»–éš”ç¦»åŒºåŸŸçš„ä»»åŠ¡ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº† <code>this_task_arena::isolate</code> çš„ä½¿ç”¨ï¼Œä»¥ä¿è¯åœ¨åµŒå¥—çš„å¹¶è¡Œç»“æ„è°ƒç”¨æ—¶ï¼Œ thread-local å˜é‡ä¸ä¼šè¢«æ„å¤–ä¿®æ”¹ï¼š</p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg4.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg4.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;oneapi/tbb/task_arena.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;oneapi/tbb/parallel_for.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;oneapi/tbb/enumerable_thread_specific.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N1 = <span class="number">1000</span>, N2 = <span class="number">1000</span>;</span><br><span class="line">    oneapi::tbb::enumerable_thread_specific&lt;<span class="type">int</span>&gt; ets;</span><br><span class="line">    oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N1, [&amp;ets]( <span class="type">int</span> i ) {</span><br><span class="line">        <span class="comment">// Set a thread specific value</span></span><br><span class="line">        ets.<span class="built_in">local</span>() = i;</span><br><span class="line">        <span class="comment">// Run the second parallel loop in an isolated region to prevent the current thread</span></span><br><span class="line">        <span class="comment">// from taking tasks related to the outer parallel loop.</span></span><br><span class="line">        oneapi::tbb::this_task_arena::<span class="built_in">isolate</span>( []{</span><br><span class="line">            oneapi::tbb::<span class="built_in">parallel_for</span>( <span class="number">0</span>, N2, []( <span class="type">int</span> j ) { <span class="comment">/* Some work */</span> } );</span><br><span class="line">        } );</span><br><span class="line">        <span class="built_in">assert</span>( ets.<span class="built_in">local</span>()==i ); <span class="comment">// Valid assertion</span></span><br><span class="line">    } );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><strong>è¡¥å……ï¼š</strong>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜éš”ç¦»åŒºåŸŸå†…å…¶ä»–çº¿ç¨‹å¦‚ä½•ç”Ÿæˆå­ä»»åŠ¡ï¼Œå¹¶ä¸”è¿™äº›å­ä»»åŠ¡å¯ä»¥ç”±å½“å‰çº¿ç¨‹æ‰§è¡Œã€‚</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªéš”ç¦»åŒºåŸŸï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼šçº¿ç¨‹Aå’Œçº¿ç¨‹Bã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªéš”ç¦»åŒºåŸŸå†…ç”Ÿæˆäº†ä¸€äº›ä»»åŠ¡ï¼Œå¹¶ä¸”è¿™äº›ä»»åŠ¡å¯èƒ½ä¼šç”Ÿæˆå­ä»»åŠ¡ã€‚</p>
<figure class="highlight cpp"><figcaption><span>work_isolation_eg5.cpp</span><a href="/blog/downloads/code/TBB/work_isolation_eg5.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tbb/tbb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">taskA</span><span class="params">()</span> </span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Task A executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">    tbb::<span class="built_in">parallel_invoke</span>(</span><br><span class="line">         {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Subtask A1 executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">        },</span><br><span class="line">         {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Subtask A2 executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">    );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">taskB</span><span class="params">()</span> </span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Task B executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">    tbb::<span class="built_in">parallel_invoke</span>(</span><br><span class="line">         {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Subtask B1 executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">        },</span><br><span class="line">         {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Subtask B2 executed by thread &quot;</span> &lt;&lt; tbb::this_task_arena::<span class="built_in">current_thread_index</span>() &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">    );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    tbb::task_arena arena;</span><br><span class="line">    arena.<span class="built_in">execute</span>([&amp;] {</span><br><span class="line">        tbb::this_task_arena::<span class="built_in">isolate</span>([&amp;] {</span><br><span class="line">            tbb::<span class="built_in">parallel_invoke</span>(taskA, taskB);</span><br><span class="line">        });</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p>
<p>taskA å’Œ taskB æ˜¯åœ¨éš”ç¦»åŒºåŸŸå†…ç”Ÿæˆçš„ä»»åŠ¡ã€‚<br>taskA ç”Ÿæˆäº†ä¸¤ä¸ªå­ä»»åŠ¡ Subtask A1 å’Œ Subtask A2ã€‚<br>taskB ç”Ÿæˆäº†ä¸¤ä¸ªå­ä»»åŠ¡ Subtask B1 å’Œ Subtask B2ã€‚<br>å‡è®¾çº¿ç¨‹Aæ‰§è¡Œäº† taskAï¼Œçº¿ç¨‹Bæ‰§è¡Œäº† taskBã€‚åœ¨éš”ç¦»åŒºåŸŸå†…ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Bå¯ä»¥æ‰§è¡Œå½¼æ­¤ç”Ÿæˆçš„å­ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹Aå¯ä»¥æ‰§è¡Œ Subtask B1 æˆ– Subtask B2ï¼Œè€Œçº¿ç¨‹Bå¯ä»¥æ‰§è¡Œ Subtask A1 æˆ– Subtask A2ï¼Œåªè¦è¿™äº›å­ä»»åŠ¡å±äºåŒä¸€ä¸ªéš”ç¦»åŒºåŸŸã€‚</p>
<h2 id="5-æ¨èé˜…è¯»"><a href="#5-æ¨èé˜…è¯»" class="headerlink" title="5. æ¨èé˜…è¯»"></a>5. æ¨èé˜…è¯»</h2><h3 id="5-1-ä¹¦ç±"><a href="#5-1-ä¹¦ç±" class="headerlink" title="5.1. ä¹¦ç±"></a>5.1. ä¹¦ç±</h3><ol>
<li>Intel Building Blocks ç¼–ç¨‹æŒ‡å—. James Reinders.</li>
<li>Patterns for Parallel Pragramming. Timothy Mattson ç­‰.</li>
<li>è®¾è®¡æ¨¡å¼ï¼šDesign Patterns of Reusable Object-Oriented Software (Addison Wesley). Gamma, Helm, Johnson å’Œ Vlissides.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/02/02/cpp/gcc%E4%B8%8Eglibc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/02/02/cpp/gcc%E4%B8%8Eglibc/" class="post-title-link" itemprop="url">gcc ä¸ glibc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-02 13:24:45" itemprop="dateCreated datePublished" datetime="2024-02-02T13:24:45+00:00">2024-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="gcc"><a href="#gcc" class="headerlink" title="gcc"></a>gcc</h2><p>gccæ˜¯ä¸€ä¸ªç¼–è¯‘å¥—ä»¶ï¼ŒåŒ…å«cã€c++ã€Fortranè¯­è¨€çš„ç¼–è¯‘å™¨ã€‚</p>
<h2 id="glibc"><a href="#glibc" class="headerlink" title="glibc"></a>glibc</h2><p>glibcæ˜¯ä¸€ä¸ªlibraryï¼Œä¸ºCç¨‹åºæä¾›åŸºç¡€å…¬å…±åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ã€æ•°å­¦å‡½æ•°å’Œå…¶ä»–æ ¸å¿ƒç»„ä»¶ã€‚<br>Linuxå¹³å°å’Œvscodeä¼¼ä¹éƒ½ä¾èµ–glibcï¼Œå¦‚æœæ“…è‡ªå°†<code>LD_LIBRARY_PATH</code>æ›´æ”¹ä¸ºå…¶ä»–ç‰ˆæœ¬çš„glibcè·¯å¾„ï¼Œåˆ™bashä¼šç›´æ¥crashã€‚</p>
<h3 id="glibcåŒ…å«ä»¥ä¸‹binå’Œlibï¼š"><a href="#glibcåŒ…å«ä»¥ä¸‹binå’Œlibï¼š" class="headerlink" title="glibcåŒ…å«ä»¥ä¸‹binå’Œlibï¼š"></a>glibcåŒ…å«ä»¥ä¸‹binå’Œlibï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> glibc-v2.34/Linux/RHEL7.0-2017-x86_64/bin &amp;&amp; <span class="built_in">ls</span></span><br><span class="line">catchsegv  getconf  iconv  locale     makedb  pcprofiledump  sotruss  tzselect  zdump</span><br><span class="line">gencat     getent   ldd    localedef  mtrace  pldd           sprof    xtrace</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥å…¶ä»–ç‰ˆæœ¬çš„glibc/libç›®å½•æ‰§è¡Œlså‘½ä»¤ä¼šæŠ¥é”™ï¼Œå¤§æ¦‚åŸå› å¯èƒ½æ˜¯å› ä¸ºå½“å‰è·¯å¾„çš„glibcçš„libå’Œç³»ç»Ÿçš„libå†²çªã€‚</span></span><br><span class="line">$ <span class="built_in">cd</span> ../lib &amp;&amp; <span class="built_in">ls</span></span><br><span class="line"><span class="built_in">ls</span>: relocation error: ./libc.so.6: symbol __tunable_get_val, version GLIBC_PRIVATE not defined <span class="keyword">in</span> file ld-linux-x86-64.so.2 with <span class="built_in">link</span> time reference</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> .. &amp;&amp; <span class="built_in">ls</span> lib</span><br><span class="line">Mcrt1.o               libanl.so.1             libm.so             libnss_hesiod.so.2</span><br><span class="line">Scrt1.o               libc.a                  libm.so.6           libpcprofile.so</span><br><span class="line">audit                 libc.so                 libmcheck.a         libpthread.a</span><br><span class="line">crt1.o                libc.so.6               libmemusage.so      libpthread.so.0</span><br><span class="line">crti.o                libc_malloc_debug.so    libmvec.a           libresolv.a</span><br><span class="line">crtn.o                libc_malloc_debug.so.0  libmvec.so          libresolv.so</span><br><span class="line">gconv                 libc_nonshared.a        libmvec.so.1        libresolv.so.2</span><br><span class="line">gcrt1.o               libcrypt.a              libnsl.so.1         librt.a</span><br><span class="line">ld-linux-x86-64.so.2  libcrypt.so             libnss_compat.so    librt.so.1</span><br><span class="line">libBrokenLocale.a     libcrypt.so.1           libnss_compat.so.2  libthread_db.so</span><br><span class="line">libBrokenLocale.so    libdl.a                 libnss_db.so        libthread_db.so.1</span><br><span class="line">libBrokenLocale.so.1  libdl.so.2              libnss_db.so.2      libutil.a</span><br><span class="line">libSegFault.so        libg.a                  libnss_dns.so.2     libutil.so.1</span><br><span class="line">libanl.a              libm-2.34.a             libnss_files.so.2</span><br><span class="line">libanl.so             libm.a                  libnss_hesiod.so</span><br></pre></td></tr></table></figure>

<h3 id="æŸ¥çœ‹glibcçš„ç‰ˆæœ¬ï¼š"><a href="#æŸ¥çœ‹glibcçš„ç‰ˆæœ¬ï¼š" class="headerlink" title="æŸ¥çœ‹glibcçš„ç‰ˆæœ¬ï¼š"></a>æŸ¥çœ‹glibcçš„ç‰ˆæœ¬ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»ä¸Šå¯çŸ¥ï¼Œlddæ˜¯glibcçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€</span></span><br><span class="line">$ ldd --version</span><br></pre></td></tr></table></figure>

<h3 id="å¯»æ‰¾libc-soçš„è·¯å¾„ï¼š"><a href="#å¯»æ‰¾libc-soçš„è·¯å¾„ï¼š" class="headerlink" title="å¯»æ‰¾libc.soçš„è·¯å¾„ï¼š"></a>å¯»æ‰¾libc.soçš„è·¯å¾„ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ locate libc.so</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libc.so</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">$ locate libstdc++.so</span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/11/libstdc++.so</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libstdc++.so.6</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30</span><br><span class="line">/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30-gdb.py</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…glibcï¼š"><a href="#å®‰è£…glibcï¼š" class="headerlink" title="å®‰è£…glibcï¼š"></a>å®‰è£…glibcï¼š</h3><p>Ubuntuå¹³å°</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install lib6</span><br></pre></td></tr></table></figure>

<p>RedHatå¹³å°</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install glibc</span><br></pre></td></tr></table></figure>

<h3 id="æ£€æŸ¥GNC-C-Library-libstdc-çš„ç‰ˆæœ¬ï¼š"><a href="#æ£€æŸ¥GNC-C-Library-libstdc-çš„ç‰ˆæœ¬ï¼š" class="headerlink" title="æ£€æŸ¥GNC C++ Library (libstdc++)çš„ç‰ˆæœ¬ï¼š"></a>æ£€æŸ¥GNC C++ Library (libstdc++)çš„ç‰ˆæœ¬ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ strings /usr/lib/libstdc++.so.* | grep LIBCXX</span><br><span class="line">[sjcvl-zhigaoz ] /lan/cva_rel/vxe_main/24.02.650.d000/tools.lnx86/lib/64bit % strings /usr/lib/libstdc++.so.* | grep LIBCXX</span><br><span class="line">GLIBCXX_3.4</span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line">...</span><br><span class="line">GLIBCXX_3.4.19</span><br><span class="line">GLIBCXX_DEBUG_MESSAGE_LENGTH</span><br><span class="line"></span><br><span class="line">$ strings /usr/lib/libc.so.* | grep GLIBC</span><br><span class="line">GLIBC_2.0</span><br><span class="line">GLIBC_2.1</span><br><span class="line">GLIBC_2.1.1</span><br><span class="line">...</span><br><span class="line">GLIBC_2.17</span><br><span class="line">GLIBC_PRIVATE</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ æœ‰ä¸€ä¸ªä½¿ç”¨äº†libstdc++çš„ç‰¹å®šçš„binaryæˆ–applicationï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æ£€æŸ¥å…¶ç‰ˆæœ¬ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ldd &lt;your_binary_or_application&gt; | grep libstdc++</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨vscodeçš„â€œRemote SSHâ€å·¥å…·è¯•å›¾è¿æ¥åˆ°Linuxæ—¶ï¼Œå¯èƒ½ä¼šæŠ¥é”™å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Warning: Missing GLIBCXX &gt;&#x3D; 3.4.25! from &#x2F;usr&#x2F;lib64&#x2F;libstdc++.so.6.0.19<br>Warning: Missing GLIBC &gt;&#x3D; 2.28! from &#x2F;usr&#x2F;lib64&#x2F;libc-2.17.so<br>Error: Missing required dependencies. Please refer to our FAQ <a target="_blank" rel="noopener" href="https://aka.ms/vscode-remote/faq/old-linux">https://aka.ms/vscode-remote/faq/old-linux</a> for additional information.</p>
</blockquote>
<p>è¿™æ˜¯å› ä¸ºLinuxç³»ç»Ÿä¸Šçš„glibcç‰ˆæœ¬ä¸­ä¸åŒ…å«GLIBCXX_3.4.25åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚æ­¤æ—¶éœ€è¦é™çº§vscodeï¼ˆå»ºè®®åšæ³•ï¼‰æˆ–å‡çº§glibcï¼ˆä¼¼ä¹å¾ˆéš¾ï¼‰ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/30/misc/%E8%AE%A1%E6%97%B6%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/30/misc/%E8%AE%A1%E6%97%B6%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">è®¡æ—¶å·¥å…·</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-30 11:07:39" itemprop="dateCreated datePublished" datetime="2024-01-30T11:07:39+00:00">2024-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="times"><a href="#times" class="headerlink" title="times"></a>times</h2><ol>
<li>bash built-in</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">times</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>function</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/times.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">clock_t</span> <span class="title">times</span><span class="params">(<span class="keyword">struct</span> tms *buf)</span></span>;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/29/linux/Introduction-to-memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/29/linux/Introduction-to-memory/" class="post-title-link" itemprop="url">Introduction to memory</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-29 14:25:24" itemprop="dateCreated datePublished" datetime="2024-01-29T14:25:24+00:00">2024-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="malloc-free"><a href="#malloc-free" class="headerlink" title="malloc&#x2F;free"></a>malloc&#x2F;free</h2><p>See <a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Backtraces.html">this example</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span> ** <span class="title">backtrace_symbols</span> <span class="params">(<span class="type">void</span> *<span class="type">const</span> *buffer, <span class="type">int</span> size)</span> </span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The return value of backtrace_symbols is a pointer obtained via the malloc function, and it is the responsibility of the caller to free that pointer. Note that only the return value need be freed, not the individual strings.</p>
</blockquote>
<p>Question: Why does it say â€œonly the return value need be freed, not the individual stringsâ€?</p>
<p>Let us observe the defintion of the <code>malloc</code>&#x2F;<code>free</code> functions first:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">malloc</span><span class="params">( <span class="type">size_t</span> size )</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">( <span class="type">void</span> *ptr )</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>free</code> takes a <code>void*</code> pointer to deallocate the memory, it doesnâ€™t care what type it is, even if it is a multi-level pointer. It means that <code>malloc</code> has stored the memory size in some place and <code>free</code> will find it beforing deallocate the memory.</p>
<p>Let us return the question. The memory pointer returned by <code>backtrace_symbols</code> is the <code>char**</code> type, it must be a whole block contigunous memory using <code>malloc</code> and might be enforced to be transformed as <code>char**</code> pointer when returing. So when we <code>free</code> the memory block, the Linux kernel find its actual memory size and deallocate it.</p>
<p>Example:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span>** strings = (<span class="type">char</span>**)<span class="built_in">malloc</span>(<span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">char</span>*) + <span class="number">3</span> * <span class="number">50</span>); <span class="comment">// assuming a maximum 50 characters per sentence</span></span><br><span class="line">    <span class="type">char</span>* block = (<span class="type">char</span>*)(strings + <span class="number">3</span>);</span><br><span class="line">    <span class="type">char</span>* s1 = <span class="built_in">strcpy</span>(block, <span class="string">&quot;The first sentence&quot;</span>); block += <span class="built_in">strlen</span>(s1) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span>* s2 = <span class="built_in">strcpy</span>(block, <span class="string">&quot;The second sentence&quot;</span>); block += <span class="built_in">strlen</span>(s2) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span>* s3 = <span class="built_in">strcpy</span>(block, <span class="string">&quot;The third sentence&quot;</span>);</span><br><span class="line">    strings[<span class="number">0</span>] = s1;</span><br><span class="line">    strings[<span class="number">1</span>] = s2;</span><br><span class="line">    strings[<span class="number">2</span>] = s3;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, strings[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(strings); <span class="comment">// deallocate all memory at once</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>More elegant but less economical code:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span>** strings = (<span class="type">char</span>**)<span class="built_in">malloc</span>(<span class="number">3</span> * <span class="built_in">sizeof</span>(<span class="type">char</span>*) + <span class="number">3</span> * <span class="number">50</span>);</span><br><span class="line">    <span class="type">char</span>* block = (<span class="type">char</span>*)(strings + <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        strings[i] = block + i * <span class="number">50</span>; <span class="comment">// Assuming a maximum of 50 characters per sentence</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(strings[<span class="number">0</span>], <span class="string">&quot;The first sentence&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(strings[<span class="number">1</span>], <span class="string">&quot;The second sentence&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(strings[<span class="number">2</span>], <span class="string">&quot;The third sentence&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, strings[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(strings); <span class="comment">// deallocate all memory at once</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Memory_002dmapped-I_002fO.html">The GNU C Library (glibc) manual: 13.8 Memory-mapped I&#x2F;O</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Memory-Protection.html">The GNU C Library (glibc) manual: 3.4 Memory Protection</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/29/UML/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/29/UML/" class="post-title-link" itemprop="url">UML</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-29 11:10:46" itemprop="dateCreated datePublished" datetime="2024-01-29T11:10:46+00:00">2024-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1176331">è®¤è¯†UMLç±»å…³ç³»â€”â€”ä¾èµ–ã€å…³è”ã€èšåˆã€ç»„åˆã€æ³›åŒ–</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/26/linux/Shell-Commands/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/26/linux/Shell-Commands/" class="post-title-link" itemprop="url">Shell Commands</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-26 15:57:35" itemprop="dateCreated datePublished" datetime="2024-01-26T15:57:35+00:00">2024-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="shuf"><a href="#shuf" class="headerlink" title="shuf"></a>shuf</h2><h2 id="cut"><a href="#cut" class="headerlink" title="cut"></a>cut</h2><h2 id="tr"><a href="#tr" class="headerlink" title="tr"></a>tr</h2><h2 id="lp"><a href="#lp" class="headerlink" title="lp"></a>lp</h2><h2 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h2><p>Options:</p>
<pre><code>-t, --field-separator=SEP
    use SEP instead of non-blank to blank transition

-k, --key=POS1[,POS2]
    start a key at POS1 (origin 1), end it at POS2 (default end of line)

-h, --human-numeric-sort
    compare human readable numbers (e.g., 2K 1G)

-n, --numeric-sort
    compare according to string numerical value
</code></pre>
<h2 id="nproc"><a href="#nproc" class="headerlink" title="nproc"></a>nproc</h2><p>print the number of processing units avaiable.</p>
<h2 id="od-xxd-hexdump"><a href="#od-xxd-hexdump" class="headerlink" title="od &#x2F; xxd &#x2F; hexdump"></a>od &#x2F; xxd &#x2F; hexdump</h2><p>read the binary file.</p>
<p>Notes: byte order</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;ABCD&quot;</span> | xxd</span><br><span class="line">00000000: 4142 4344                                ABCD</span><br><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;ABCD&quot;</span> | hexdump</span><br><span class="line">0000000 4241 4443                              </span><br><span class="line">0000004</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/282215/how-to-view-a-binary-file">Reference</a></p>
<h2 id="comm-diff-tkdiff-cmp"><a href="#comm-diff-tkdiff-cmp" class="headerlink" title="comm &#x2F; diff &#x2F; tkdiff &#x2F; cmp"></a>comm &#x2F; diff &#x2F; tkdiff &#x2F; cmp</h2><p>Can be used to compare binary or non-binary files.</p>
<h3 id="comm"><a href="#comm" class="headerlink" title="comm"></a>comm</h3><p>compare two sorted files line by line.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> file1.txt </span><br><span class="line">apple</span><br><span class="line">banana</span><br><span class="line">cherry</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> file2.txt </span><br><span class="line">banana</span><br><span class="line">cherry</span><br><span class="line"><span class="built_in">date</span></span><br><span class="line">erase</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">comm</span> file1.txt file2.txt </span><br><span class="line">apple</span><br><span class="line">                banana</span><br><span class="line">                cherry</span><br><span class="line">        <span class="built_in">date</span></span><br><span class="line">        erase</span><br></pre></td></tr></table></figure>

<p>The file must be sorted before using the <code>comm</code> command. Otherwise it will complain that:</p>
<pre><code>comm: file 1 is not in sorted order
</code></pre>
<p>and cannot work correctly. For example,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> file1.txt </span><br><span class="line">apple</span><br><span class="line">cherry</span><br><span class="line">banana</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> file2.txt </span><br><span class="line">banana</span><br><span class="line">cherry</span><br><span class="line"><span class="built_in">date</span></span><br><span class="line">erase</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">comm</span> file1.txt file2.txt </span><br><span class="line">apple</span><br><span class="line">        banana</span><br><span class="line">                cherry</span><br><span class="line"><span class="built_in">comm</span>: file 1 is not <span class="keyword">in</span> sorted order</span><br><span class="line">banana</span><br><span class="line">        <span class="built_in">date</span></span><br><span class="line">        erase</span><br><span class="line"><span class="built_in">comm</span>: input is not <span class="keyword">in</span> sorted order</span><br></pre></td></tr></table></figure>

<h3 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h3><p>Syntax:</p>
<pre><code>diff -u file1 file2
</code></pre>
<p>Options:</p>
<pre><code>-e, --ed
    output an ed script

-u, -U NUM, --unified[=NUM]
    output NUM (default 3) lines of unified context
    (that is, print NUM lines before and after the difference line)
</code></pre>
<h3 id="tkdiff"><a href="#tkdiff" class="headerlink" title="tkdiff"></a>tkdiff</h3><p>Use a GUI to display the differences.</p>
<h3 id="cmp"><a href="#cmp" class="headerlink" title="cmp"></a>cmp</h3><p>Prints less information comparing to <code>diff</code>.</p>
<p>Syntax:</p>
<pre><code>cmp file1 file2
</code></pre>
<h2 id="ed-vim-sed-awk"><a href="#ed-vim-sed-awk" class="headerlink" title="ed&#x2F;vim&#x2F;sed&#x2F;awk"></a>ed&#x2F;vim&#x2F;sed&#x2F;awk</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/26/cpp/C++%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%97%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/26/cpp/C++%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%97%E8%A1%A8/" class="post-title-link" itemprop="url">C++ åˆå§‹åŒ–åˆ—è¡¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-26 10:31:32" itemprop="dateCreated datePublished" datetime="2024-01-26T10:31:32+00:00">2024-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/c-cpp/" itemprop="url" rel="index"><span itemprop="name">c/cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="åˆ—è¡¨åˆå§‹åŒ–"><a href="#åˆ—è¡¨åˆå§‹åŒ–" class="headerlink" title="åˆ—è¡¨åˆå§‹åŒ–"></a>åˆ—è¡¨åˆå§‹åŒ–</h2><p>struct&#x2F;union&#x2F;arrayé»˜è®¤æ”¯æŒåˆ—è¡¨åˆå§‹åŒ–ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/language/struct_initialization">Struct and union initialization</a><br><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/language/array_initialization">Array initialization</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="comment">// #include &lt;initializer_list&gt;</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x, y, z; <span class="comment">// æ³¨æ„ï¼šæ•°æ®æˆå‘˜å¿…é¡»æ˜¯publicçš„ã€‚</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; z &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec_;</span><br><span class="line">    <span class="type">int</span> x_;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;vec_=&#123; &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x : vec_) &#123;</span><br><span class="line">            cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&#125;, x_=&quot;</span> &lt;&lt; x_ &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec_;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;vec_=&#123; &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x : vec_) &#123;</span><br><span class="line">            cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&#125;&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// C++ä¼šæ„é€ ä¸€ä¸ªåˆ—è¡¨åˆå§‹åŒ–çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä»¥ä¸‹(1)å’Œ(2)éƒ½æ˜¯è°ƒç”¨è¿™ä¸ªé»˜è®¤æ„é€ å‡½æ•°ã€‚</span></span><br><span class="line">    A a1&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;; <span class="comment">// (1) åˆ—è¡¨åˆå§‹åŒ–</span></span><br><span class="line">    <span class="function">A <span class="title">a2</span><span class="params">(&#123;<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;)</span></span>; <span class="comment">// (2) åŒ(1)</span></span><br><span class="line">    a1.<span class="built_in">print</span>();</span><br><span class="line">    a2.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    B b1&#123;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;, <span class="number">4</span>&#125;; <span class="comment">// å†…éƒ¨çš„&quot;&#123;1,2,3&#125;&quot;ç”¨äºæ„é€ vec_ï¼Œ&quot;4&quot;ç”¨äºåˆå§‹åŒ–x_</span></span><br><span class="line">    b1.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// C C1&#123;1,2,3&#125;; // (1) è¿™é‡Œä¼šæŠ¥é”™&quot;error: too many initializers for â€˜Câ€™&quot;ï¼Œ</span></span><br><span class="line">    <span class="comment">//              //     å› ä¸ºCåªæœ‰ä¸€ä¸ªæ•°æ®æˆå‘˜vec_ï¼Œè¿™é‡Œå´ä¼ å…¥äº†3ä¸ªå‚æ•°</span></span><br><span class="line">    C c2&#123;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;&#125;; <span class="comment">// (2) å…¶ä¸­ï¼Œå†…éƒ¨çš„&quot;&#123;1,2,3&#125;&quot;ç”¨äºæ„é€ vec_ï¼Œå¤–å±‚çš„&quot;&#123;&#125;&quot;ç”¨äºå¯¹c2æœ¬èº«è¿›è¡Œæ„é€ </span></span><br><span class="line">    c2.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="std-initializer-list"><a href="#std-initializer-list" class="headerlink" title="std::initializer_list"></a>std::initializer_list</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initializer_list&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="type">int</span> x, y, z;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">A</span>(initializer_list&lt;<span class="type">int</span>&gt; il) &#123;</span><br><span class="line">        initializer_list&lt;<span class="type">int</span>&gt;::iterator it = il.<span class="built_in">begin</span>();</span><br><span class="line">        x = *it++;</span><br><span class="line">        y = *it++;</span><br><span class="line">        z = *it++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; z &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">B</span> &#123;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">B</span>(initializer_list&lt;<span class="type">int</span>&gt; il) &#123;</span><br><span class="line">        vec = il; <span class="comment">// ç”¨initializer_liståˆå§‹åŒ–vector</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&#123; &quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x : vec) &#123;</span><br><span class="line">            cout &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&#125;&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">    a.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    B b&#123;<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    b.<span class="built_in">print</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2024/01/25/linux/Brackets-in-Bash/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ±Ÿå—äººç‰©çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/25/linux/Brackets-in-Bash/" class="post-title-link" itemprop="url">Brackets in Bash</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-25 13:22:53" itemprop="dateCreated datePublished" datetime="2024-01-25T13:22:53+00:00">2024-01-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-04 00:30:50" itemprop="dateModified" datetime="2025-08-04T00:30:50+00:00">2025-08-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä¸­æ‹¬å·"><a href="#ä¸­æ‹¬å·" class="headerlink" title="ä¸­æ‹¬å·"></a>ä¸­æ‹¬å·</h2><ol>
<li><p><code>[ ]</code>å’Œ<code>test</code>æ˜¯bashçš„å†…éƒ¨å‘½ä»¤ï¼Œ<code>[[ ]]</code>æ˜¯shellçš„æ¡ä»¶åˆ¤æ–­å…³é”®å­—ã€‚</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">type</span> [</span><br><span class="line">[ is a shell <span class="built_in">builtin</span></span><br><span class="line">$ <span class="built_in">type</span> <span class="built_in">test</span></span><br><span class="line"><span class="built_in">test</span> is a shell <span class="built_in">builtin</span></span><br><span class="line">$ <span class="built_in">type</span> [[</span><br><span class="line">[[ is a shell keyword</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[ ]</code>å’Œ<code>test</code>æ˜¯ç­‰ä»·çš„ï¼Œç”¨äºè¯„ä¼°æ¡ä»¶è¡¨è¾¾å¼ã€‚å¯ä»¥ä½¿ç”¨<code>man [</code>æˆ–<code>help [</code>æŸ¥é˜…å¸®åŠ©æ–‡æ¡£ã€‚</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">help</span> [</span><br><span class="line">[: [ arg... ]</span><br><span class="line">    Evaluate conditional expression.</span><br><span class="line">    </span><br><span class="line">    This is a synonym <span class="keyword">for</span> the <span class="string">&quot;test&quot;</span> <span class="built_in">builtin</span>, but the last argument must</span><br><span class="line">    be a literal `]<span class="string">&#x27;, to match the opening `[&#x27;</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[[ ]]</code>å…³é”®å­—å¯ä»¥å±è”½shellç‰¹æ®Šç¬¦å·ï¼Œæ¯”å¦‚<code>&amp;&amp;</code>ã€<code>||</code>ã€<code>&gt;</code>å’Œ<code>&lt;</code>å¯ä»¥è¢«è®¤ä¸ºæ˜¯æ¡ä»¶åˆ¤æ–­ç¬¦è€Œä¸æ˜¯é‡å®šå‘ç¬¦ã€‚</p>
</li>
<li><p><code>[ ]</code>ä¸­ä½¿ç”¨<code>-a</code>å’Œ<code>-o</code>è¡¨ç¤ºé€»è¾‘ä¸å’Œé€»è¾‘æˆ–ï¼Œ<code>[[ ]]</code>ä¸­åˆ™ä½¿ç”¨<code>&amp;&amp;</code>å’Œ<code>||</code>ã€‚</p>
</li>
</ol>
<h2 id="å°æ‹¬å·"><a href="#å°æ‹¬å·" class="headerlink" title="å°æ‹¬å·"></a>å°æ‹¬å·</h2><ol>
<li><code>$()</code>ç”¨äºå‘½ä»¤æ›¿æ¢ã€‚</li>
<li>åŒå°æ‹¬å·<code>(( ))</code>ï¼šåœ¨æ¯”è¾ƒè¿‡ç¨‹ä¸­ä½¿ç”¨é«˜çº§æ•°å­¦è¡¨è¾¾å¼ã€‚</li>
</ol>
<h2 id="å¤§æ‹¬å·"><a href="#å¤§æ‹¬å·" class="headerlink" title="å¤§æ‹¬å·"></a>å¤§æ‹¬å·</h2><p>è¯·é˜…è¯»ï¼š<a target="_blank" rel="noopener" href="https://www.linux.com/topic/desktop/all-about-curly-braces-bash/">All about {Curly Braces} in Bash</a></p>
<ol>
<li><p><code>$&#123;&#125;</code>ç”¨äºå¼•ç”¨å˜é‡ã€‚</p>
<p> ä¸<code>$var</code>ç›¸æ¯”ï¼Œ<code>$&#123;var&#125;</code>æ˜¯ä¸€ç§æ¶ˆé™¤æ­§ä¹‰çš„æªæ–½ï¼Œæ¯”å¦‚ï¼š</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ var=abc</span><br><span class="line">$ vartest=ABC</span><br><span class="line"><span class="comment"># $varå¼•ç”¨å˜é‡&#x27;var&#x27;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$var</span></span><br><span class="line">abc</span><br><span class="line"><span class="comment"># å¼•ç”¨å˜é‡&#x27;vartest&#x27;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$vartest</span></span><br><span class="line">ABC</span><br><span class="line"><span class="comment"># å¼•ç”¨å˜é‡&#x27;var&#x27;å¹¶åœ¨å…¶ååŠ ä¸Š&#x27;test&#x27;å­—ç¬¦</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var&#125;</span><span class="built_in">test</span></span><br><span class="line">abctest</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&#123;&#125;</code>è¡¨ç¤ºåˆ†ç»„ã€‚</p>
</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zeweiwu/p/5485711.html">Shellä¸­testã€å•ä¸­æ‹¬å·ã€åŒä¸­æ‹¬å·çš„åŒºåˆ«</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/linux/bash-single-vs-double-brackets">Differences Between Single and Double Brackets in Bash</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3e1eaaa3fee8">Shellä¸­çš„æ‹¬å·ã€åŒæ‹¬å·ã€æ–¹æ‹¬å·å’ŒåŒæ–¹æ‹¬å·</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><a class="page-number" href="/blog/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/blog/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><a class="extend next" rel="next" href="/blog/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bi-an"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">bi-an</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bi-an" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;bi-an" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ah_zzg@126.com" title="E-Mail â†’ mailto:ah_zzg@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://bi-an.github.io/" title="http:&#x2F;&#x2F;bi-an.github.io">bi-an's Page</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bi-an</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

</body>
</html>
