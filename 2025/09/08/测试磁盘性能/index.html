<!DOCTYPE html>
<html lang="en, zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"bi-an.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="查看磁盘类型123$ lsblk -d -o name,rota,type,size,modelNAME ROTA TYPE  SIZE MODELsda     1 disk  1.8T PERC H740P Mini  ROTA&#x3D;1：这是旋转磁盘。 测试方法顺序写吞吐测试（逼近最大写入速度） 1fio --name&#x3D;seqwrite --rw&#x3D;write --bs&#x3D;1M --size&#x3D;5G -">
<meta property="og:type" content="article">
<meta property="og:title" content="测试磁盘性能">
<meta property="og:url" content="https://bi-an.github.io/blog/2025/09/08/%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD/index.html">
<meta property="og:site_name" content="江南人物的博客">
<meta property="og:description" content="查看磁盘类型123$ lsblk -d -o name,rota,type,size,modelNAME ROTA TYPE  SIZE MODELsda     1 disk  1.8T PERC H740P Mini  ROTA&#x3D;1：这是旋转磁盘。 测试方法顺序写吞吐测试（逼近最大写入速度） 1fio --name&#x3D;seqwrite --rw&#x3D;write --bs&#x3D;1M --size&#x3D;5G -">
<meta property="og:locale">
<meta property="article:published_time" content="2025-09-08T11:27:57.000Z">
<meta property="article:modified_time" content="2025-09-18T13:18:02.025Z">
<meta property="article:author" content="bi-an">
<meta property="article:tag" content="IO">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://bi-an.github.io/blog/2025/09/08/%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en, zh_CN'
  };
</script>

  <title>测试磁盘性能 | 江南人物的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">江南人物的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/blog/resources/" rel="section"><i class="fa fa-paperclip fa-fw"></i>Resource</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en, zh_CN">
    <link itemprop="mainEntityOfPage" href="https://bi-an.github.io/blog/2025/09/08/%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="bi-an">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江南人物的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          测试磁盘性能
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-09-08 11:27:57" itemprop="dateCreated datePublished" datetime="2025-09-08T11:27:57+00:00">2025-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-09-18 13:18:02" itemprop="dateModified" datetime="2025-09-18T13:18:02+00:00">2025-09-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="查看磁盘类型"><a href="#查看磁盘类型" class="headerlink" title="查看磁盘类型"></a>查看磁盘类型</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lsblk -d -o name,rota,<span class="built_in">type</span>,size,model</span><br><span class="line">NAME ROTA TYPE  SIZE MODEL</span><br><span class="line">sda     1 disk  1.8T PERC H740P Mini</span><br></pre></td></tr></table></figure>

<p><code>ROTA=1</code>：这是旋转磁盘。</p>
<h2 id="测试方法"><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h2><p>顺序写吞吐测试（逼近最大写入速度）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=seqwrite --rw=write --bs=1M --size=5G --numjobs=4 --iodepth=32 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>

<p>随机读 IOPS 测试（逼近最大并发处理能力）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=randread --rw=randread --bs=4k --size=5G --numjobs=4 --iodepth=64 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>

<p>混合读写测试（模拟数据库负载）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=mixrw --rw=randrw --rwmixread=70 --bs=4k --size=5G --numjobs=4 --iodepth=32 --direct=1 --runtime=60 --group_reporting</span><br></pre></td></tr></table></figure>


<h2 id="磁盘的测试结果"><a href="#磁盘的测试结果" class="headerlink" title="磁盘的测试结果"></a>磁盘的测试结果</h2><p>由于是旋转磁盘，iodepth 总是 1（设成其他值不会生效）</p>
<p><strong>单线程读写文件：</strong></p>
<details>
  <summary>点击展开代码</summary>
  <pre>
    <figure class="highlight bash"><figcaption><span>fio_bs_test.sh</span><a href="/blog/downloads/code/fio_bs_test.sh">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试参数</span></span><br><span class="line">DEVICE=<span class="string">&quot;./testfile&quot;</span>   <span class="comment"># 修改为你要测试的文件或设备路径</span></span><br><span class="line">RUNTIME=30                       <span class="comment"># 每个测试运行时间（秒）</span></span><br><span class="line"><span class="comment"># BLOCK_SIZES=(&quot;4k&quot; &quot;16k&quot; &quot;64k&quot; &quot;256k&quot; &quot;1M&quot; &quot;4M&quot; &quot;16M&quot; &quot;32M&quot; &quot;64M&quot; &quot;128M&quot;)  # 测试块大小列表</span></span><br><span class="line">BLOCK_SIZES=(<span class="string">&quot;128M&quot;</span> <span class="string">&quot;64M&quot;</span> <span class="string">&quot;32M&quot;</span> <span class="string">&quot;16M&quot;</span> <span class="string">&quot;4M&quot;</span> <span class="string">&quot;1M&quot;</span> <span class="string">&quot;256k&quot;</span> <span class="string">&quot;64k&quot;</span> <span class="string">&quot;16k&quot;</span> <span class="string">&quot;4k&quot;</span>)  <span class="comment"># 测试块大小列表</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;fio_bs_output.log&quot;</span>        <span class="comment"># 原始输出日志文件</span></span><br><span class="line">PERFORMANCE_LOG=<span class="string">&quot;fio_bs_performance.log&quot;</span>  <span class="comment"># 性能结果日志文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出表头</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s | %-10s | %-8s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;RW&quot;</span> <span class="string">&quot;BlockSize&quot;</span> <span class="string">&quot;IOPS&quot;</span> <span class="string">&quot;BW(MiB/s)&quot;</span> <span class="string">&quot;AvgLat(ms)&quot;</span> | <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------------------------------------------------------------&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>  <span class="comment"># 清空日志文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环测试不同块大小</span></span><br><span class="line"><span class="keyword">for</span> RW <span class="keyword">in</span> <span class="built_in">read</span> write; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> BS <span class="keyword">in</span> <span class="string">&quot;<span class="variable">${BLOCK_SIZES[@]}</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    OUTPUT=$(fio --name=bs_test \</span><br><span class="line">                 --filename=<span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span> \</span><br><span class="line">                 --rw=<span class="variable">$RW</span> \</span><br><span class="line">                 --bs=<span class="variable">$BS</span> \</span><br><span class="line">                 --size=1G \</span><br><span class="line">                 --time_based \</span><br><span class="line">                 --runtime=<span class="variable">$RUNTIME</span> \</span><br><span class="line">                 --numjobs=1 \</span><br><span class="line">                 --direct=1 \</span><br><span class="line">                 --ioengine=psync \</span><br><span class="line">                 --group_reporting)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;----------------------------------------------&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取关键指标</span></span><br><span class="line">    <span class="built_in">read</span> IOPS BW BWUNIT LAT LAT_UNIT &lt;&lt;&lt; $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> | awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        /IOPS=/ {match($0, /IOPS= *([0-9.]+)/, iops)}</span></span><br><span class="line"><span class="string">        /BW=/ {</span></span><br><span class="line"><span class="string">            match($0, /BW= *([0-9.]+)([KMG]iB)\/s/, bwinfo)</span></span><br><span class="line"><span class="string">            bwval=bwinfo[1]; bwunit=bwinfo[2]</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">        /clat \(/ {match($0, /avg= *([0-9.]+),/, lat); match($0, /\(([^)]+)\)/, lat_unit)}</span></span><br><span class="line"><span class="string">        END {print iops[1], bwval, bwunit, lat[1], lat_unit[1]}</span></span><br><span class="line"><span class="string">    &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 延迟单位换算</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;usec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$LAT</span>/1000}&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;msec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=<span class="variable">$LAT</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        LAT_MS=<span class="string">&quot;Unknown&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 带宽单位换算为 MiB/s</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$BWUNIT</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;KiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>/1024}&quot;</span>) ;;</span><br><span class="line">        <span class="string">&quot;MiB&quot;</span>) BW_MIB=<span class="variable">$BW</span> ;;</span><br><span class="line">        <span class="string">&quot;GiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>*1024}&quot;</span>) ;;</span><br><span class="line">        *) BW_MIB=<span class="string">&quot;Unknown&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果行</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;%-8s | %-10s | %-8s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;<span class="variable">$RW</span>&quot;</span> <span class="string">&quot;<span class="variable">$BS</span>&quot;</span> <span class="string">&quot;<span class="variable">$IOPS</span>&quot;</span> <span class="string">&quot;<span class="variable">$BW_MIB</span>&quot;</span> <span class="string">&quot;<span class="variable">$LAT_MS</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 fio 创建的测试文件</span></span><br><span class="line"><span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试完成，结果已保存到 <span class="variable">$LOG_FILE</span> 和 <span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br></pre></td></tr></table></figure>
  </pre>
</details>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RW       | BlockSize  | IOPS     | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">read     | 4k         | 194      | 0.76       | 5.14</span><br><span class="line">read     | 16k        | 239      | 3.74       | 4.17</span><br><span class="line">read     | 64k        | 347      | 21.7       | 2.88</span><br><span class="line">read     | 256k       | 271      | 67.9       | 3.68</span><br><span class="line">read     | 1M         | 94       | 94.9       | 10.53</span><br><span class="line">read     | 4M         | 14       | 57.2       | 69.74</span><br><span class="line">read     | 16M        | 6        | 97.6       | 163.96</span><br><span class="line">read     | 32M        | 3        | 111        | 288.99</span><br><span class="line">read     | 64M        | 1        | 112        | 573.70</span><br><span class="line">read     | 128M       | 0        | 112        | 1147.00</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RW       | BlockSize  | IOPS     | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">write    | 4k         | 1884     | 7.36       | 0.53</span><br><span class="line">write    | 16k        | 1452     | 22.7       | 0.69</span><br><span class="line">write    | 64k        | 793      | 49.6       | 1.26</span><br><span class="line">write    | 256k       | 307      | 76.8       | 3.24</span><br><span class="line">write    | 1M         | 100      | 100        | 9.96</span><br><span class="line">write    | 4M         | 18       | 73.7       | 53.99</span><br><span class="line">write    | 16M        | 5        | 93.8       | 169.43</span><br><span class="line">write    | 32M        | 3        | 101        | 313.24</span><br><span class="line">write    | 64M        | 1        | 107        | 594.46</span><br><span class="line">write    | 128M       | 0        | 102        | 1249.35</span><br></pre></td></tr></table></figure>


<p>当 BlockSize&#x3D;32M 以后，写入性能基本达到顶峰（110 MiB&#x2F;s），和旋转磁盘的参数基本一致。</p>
<p><strong>多线程读写同一个文件，BS&#x3D;64KiB：</strong></p>
<details>
  <summary>点击展开代码</summary>
  <pre>
    <figure class="highlight bash"><figcaption><span>fio_mt_test.sh</span><a href="/blog/downloads/code/fio_mt_test.sh">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">DEVICE=<span class="string">&quot;./mt_testfile&quot;</span>   <span class="comment"># 测试文件路径</span></span><br><span class="line">RUNTIME=30            <span class="comment"># 每个测试运行时间（秒）</span></span><br><span class="line">THREADS=(1 2 4 8 16 32 64 72 120)  <span class="comment"># 测试线程数列表</span></span><br><span class="line">BLOCK_SIZE=<span class="string">&quot;64k&quot;</span>      <span class="comment"># 块大小，可根据需要修改</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;fio_thread_output.log&quot;</span></span><br><span class="line">PERFORMANCE_LOG=<span class="string">&quot;fio_thread_performance.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出表头</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s | %-8s | %-10s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;RW&quot;</span> <span class="string">&quot;Threads&quot;</span> <span class="string">&quot;IOPS&quot;</span> <span class="string">&quot;BW(MiB/s)&quot;</span> <span class="string">&quot;AvgLat(ms)&quot;</span> | <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---------------------------------------------------------------&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>  <span class="comment"># 清空日志文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> RW <span class="keyword">in</span> <span class="built_in">read</span> write; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> THREAD <span class="keyword">in</span> <span class="string">&quot;<span class="variable">${THREADS[@]}</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    OUTPUT=$(fio --name=thread_test \</span><br><span class="line">                 --filename=<span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span> \</span><br><span class="line">                 --rw=<span class="variable">$RW</span> \</span><br><span class="line">                 --bs=<span class="variable">$BLOCK_SIZE</span> \</span><br><span class="line">                 --size=5G \</span><br><span class="line">                 --time_based \</span><br><span class="line">                 --runtime=<span class="variable">$RUNTIME</span> \</span><br><span class="line">                 --numjobs=<span class="variable">$THREAD</span> \</span><br><span class="line">                 --direct=1 \</span><br><span class="line">                 --ioengine=psync \</span><br><span class="line">                 --group_reporting)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;---------------------------------------------------------------&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取关键指标</span></span><br><span class="line">    <span class="built_in">read</span> IOPS BW BWUNIT LAT LAT_UNIT &lt;&lt;&lt; $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OUTPUT</span>&quot;</span> | awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        /IOPS=/ {match($0, /IOPS= *([0-9.]+)/, iops)}</span></span><br><span class="line"><span class="string">        /BW=/ {</span></span><br><span class="line"><span class="string">            match($0, /BW= *([0-9.]+)([KMG]iB)\/s/, bwinfo)</span></span><br><span class="line"><span class="string">            bwval=bwinfo[1]; bwunit=bwinfo[2]</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">        /clat \(/ {match($0, /avg= *([0-9.]+),/, lat); match($0, /\(([^)]+)\)/, lat_unit)}</span></span><br><span class="line"><span class="string">        END {print iops[1], bwval, bwunit, lat[1], lat_unit[1]}</span></span><br><span class="line"><span class="string">    &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 延迟单位换算</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;usec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$LAT</span>/1000}&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$LAT_UNIT</span>&quot;</span> = <span class="string">&quot;msec&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        LAT_MS=<span class="variable">$LAT</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        LAT_MS=<span class="string">&quot;Unknown&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 带宽单位换算为 MiB/s</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$BWUNIT</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;KiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>/1024}&quot;</span>) ;;</span><br><span class="line">        <span class="string">&quot;MiB&quot;</span>) BW_MIB=<span class="variable">$BW</span> ;;</span><br><span class="line">        <span class="string">&quot;GiB&quot;</span>) BW_MIB=$(awk <span class="string">&quot;BEGIN {printf \&quot;%.2f\&quot;, <span class="variable">$BW</span>*1024}&quot;</span>) ;;</span><br><span class="line">        *) BW_MIB=<span class="string">&quot;Unknown&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果行</span></span><br><span class="line">  <span class="built_in">printf</span> <span class="string">&quot;%-8s | %-8s | %-10s | %-10s | %-10s\n&quot;</span> <span class="string">&quot;<span class="variable">$RW</span>&quot;</span> <span class="string">&quot;<span class="variable">$THREAD</span>&quot;</span> <span class="string">&quot;<span class="variable">$IOPS</span>&quot;</span> <span class="string">&quot;<span class="variable">$BW_MIB</span>&quot;</span> <span class="string">&quot;<span class="variable">$LAT_MS</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试完成，结果已保存到 <span class="variable">$LOG_FILE</span> 和 <span class="variable">$PERFORMANCE_LOG</span>&quot;</span></span><br></pre></td></tr></table></figure>
  </pre>
</details>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RW       | Threads  | IOPS       | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">read     | 1        | 826        | 51.6       | 1.21</span><br><span class="line">read     | 2        | 1300       | 81.3       | 1.54</span><br><span class="line">read     | 4        | 1681       | 105        | 2.38</span><br><span class="line">read     | 8        | 1778       | 111        | 4.49</span><br><span class="line">read     | 16       | 1789       | 112        | 8.93</span><br><span class="line">read     | 32       | 1790       | 112        | 17.86</span><br><span class="line">read     | 64       | 1789       | 112        | 35.73</span><br><span class="line">read     | 72       | 1790       | 112        | 40.18</span><br><span class="line">read     | 120      | 1789       | 112        | 66.98</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RW       | Threads  | IOPS       | BW(MiB/s)  | AvgLat(ms)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">write    | 1        | 847        | 52.9       | 1.18</span><br><span class="line">write    | 2        | 1367       | 85.5       | 1.46</span><br><span class="line">write    | 4        | 1757       | 110        | 2.27</span><br><span class="line">write    | 8        | 1786       | 112        | 4.47</span><br><span class="line">write    | 16       | 1788       | 112        | 8.92</span><br><span class="line">write    | 32       | 1788       | 112        | 17.79</span><br><span class="line">write    | 64       | 1788       | 112        | 35.09</span><br><span class="line">write    | 72       | 1788       | 112        | 39.54</span><br><span class="line">write    | 120      | 1784       | 112        | 64.50</span><br></pre></td></tr></table></figure>

<p>当线程数增加，IO 性能随之提高，可能原因是 64KiB 小块数据大量提交到 I&#x2F;O 队列，操作系统能更好地完成读写路径优化。<br>但达到8线程的时候，就基本到达性能顶峰了。</p>
<p>注意：fio 多线程写入同一个文件是没有加锁的，如果超过 page cache (一般是 4 KB)，那么可能乱序写入。</p>
<h2 id="概念（以-fio-为例）"><a href="#概念（以-fio-为例）" class="headerlink" title="概念（以 fio 为例）"></a>概念（以 fio 为例）</h2><h3 id="ioengine"><a href="#ioengine" class="headerlink" title="ioengine"></a>ioengine</h3><p>ioengine（I&#x2F;O 引擎）是 fio 提供以执行读写任务的底层接口。不同的引擎代表不同的 I&#x2F;O 模型，比如同步、异步、内存映射、零拷贝等。</p>
<table>
<thead>
<tr>
<th align="center">引擎名称</th>
<th align="center">类型</th>
<th align="center">特点与用途</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync</td>
<td align="center">同步</td>
<td align="center">默认方式，每次 I&#x2F;O 都等待完成，适合简单测试</td>
</tr>
<tr>
<td align="center">psync</td>
<td align="center">同步</td>
<td align="center">使用 pread&#x2F;pwrite，可指定偏移，略快</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">异步</td>
<td align="center">Linux 异步 I&#x2F;O，适合高性能 SSD&#x2F;NVMe</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">异步</td>
<td align="center">新一代 Linux 异步接口，低延迟、高并发</td>
</tr>
<tr>
<td align="center">mmap</td>
<td align="center">内存映射</td>
<td align="center">将文件映射到内存，适合大文件顺序访问</td>
</tr>
<tr>
<td align="center">splice</td>
<td align="center">零拷贝</td>
<td align="center">用于高效数据传输，减少 CPU 和内存开销</td>
</tr>
<tr>
<td align="center">windowsaio</td>
<td align="center">异步</td>
<td align="center">Windows 原生异步 I&#x2F;O，适合多线程写入</td>
</tr>
<tr>
<td align="center">net</td>
<td align="center">网络</td>
<td align="center">用于网络 I&#x2F;O 测试，如 socket 传输</td>
</tr>
<tr>
<td align="center">sg</td>
<td align="center">SCSI</td>
<td align="center">用于直接访问 SCSI 设备</td>
</tr>
</tbody></table>
<p>每种 ioengine 都依赖操作系统提供的底层 I&#x2F;O 接口。例如：</p>
<table>
<thead>
<tr>
<th align="center">ioengine 类型</th>
<th align="center">操作系统要求</th>
<th align="center">是否异步</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync &#x2F; psync</td>
<td align="center">所有系统</td>
<td align="center">❌</td>
<td align="center">使用标准阻塞 I&#x2F;O，几乎总是可用</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">Linux，需安装 libaio 库</td>
<td align="center">✅</td>
<td align="center">依赖 Linux 的异步 I&#x2F;O 接口</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">Linux ≥ 5.1，推荐 ≥ 5.4</td>
<td align="center">✅</td>
<td align="center">依赖新内核特性和 liburing 库</td>
</tr>
<tr>
<td align="center">windowsaio</td>
<td align="center">Windows</td>
<td align="center">✅</td>
<td align="center">使用 Windows 原生异步 I&#x2F;O</td>
</tr>
<tr>
<td align="center">mmap</td>
<td align="center">所有主流系统</td>
<td align="center">❌</td>
<td align="center">使用内存映射，适合顺序读写</td>
</tr>
<tr>
<td align="center">posixaio</td>
<td align="center">POSIX 兼容系统</td>
<td align="center">✅</td>
<td align="center">使用 aio_read &#x2F; aio_write 接口</td>
</tr>
</tbody></table>
<p>你可以指定任意 ioengine （默认值是 sync &#x2F; psync），但它是否能运行，必须得到操作系统的支持。这包括内核版本、系统接口、库文件等。如果系统不支持，fio 会报错或自动回退。</p>
<p>查看支持列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --enghelp</span><br></pre></td></tr></table></figure>

<p>这会列出当前系统上可用的 ioengine，但注意：列出来 ≠ 能用，还要看运行时是否报错。</p>
<p>实际测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio --name=<span class="built_in">test</span> --ioengine=io_uring --rw=write --size=1G --bs=1M</span><br></pre></td></tr></table></figure>

<p>如果不支持，会报错，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio: pid=132756, err=38/file:engines/io_uring.c:1351, func=io_queue_init, error=Function not implemented</span><br></pre></td></tr></table></figure>

<h3 id="iodepth"><a href="#iodepth" class="headerlink" title="iodepth"></a>iodepth</h3><p><code>--iodepth</code> 是传递给内核的参数。</p>
<p>如果你不显式设置 <code>--iodepth</code>，那么 fio 会根据所选的 I&#x2F;O 引擎（<code>--ioengine</code>） 来决定默认值</p>
<table>
<thead>
<tr>
<th align="center">I&#x2F;O 引擎</th>
<th align="center">默认 iodepth</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sync &#x2F; psync &#x2F; vsync</td>
<td align="center">1（同步 I&#x2F;O，只能一个一个处理）</td>
</tr>
<tr>
<td align="center">libaio &#x2F; io_uring</td>
<td align="center">1，但可以设置更高以启用异步并发</td>
</tr>
<tr>
<td align="center">mmap &#x2F; pread &#x2F; pwrite</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">windowsaio（Windows）</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">sg（SCSI generic）</td>
<td align="center">1</td>
</tr>
</tbody></table>
<p>fio 并不会主动维护队列，队列是内核的特性。</p>
<table>
<thead>
<tr>
<th align="center">I&#x2F;O 引擎</th>
<th align="center">队列位置</th>
<th align="center">是否异步</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">psync &#x2F; sync</td>
<td align="center">无队列（直接调用）</td>
<td align="center">否</td>
<td align="center">每次写入调用 write()，无排队机制</td>
</tr>
<tr>
<td align="center">libaio</td>
<td align="center">内核空间</td>
<td align="center">✅ 是</td>
<td align="center">使用 Linux AIO，队列在内核中，由 io_submit() 提交</td>
</tr>
<tr>
<td align="center">io_uring</td>
<td align="center">用户 + 内核共享</td>
<td align="center">✅ 是</td>
<td align="center">使用环形缓冲区，用户空间提交，内核空间处理</td>
</tr>
<tr>
<td align="center">mmap &#x2F; null</td>
<td align="center">用户空间</td>
<td align="center">❌ 否</td>
<td align="center">模拟或跳过实际 I&#x2F;O，不涉及内核队列</td>
</tr>
</tbody></table>
<ul>
<li>对于支持异步 I&#x2F;O 的引擎（如 libaio 或 io_uring），你可以设置更高的 iodepth（如 32、64、128）来模拟高并发负载；</li>
<li>对 SSD 或 NVMe 设备，高 iodepth 能显著提升 IOPS 和吞吐量；</li>
<li>对机械硬盘，提升有限，但仍可用于测试调度策略和队列行为。</li>
</ul>
<p>但如果你的 ioengine 是 sync 或 psync，这些是同步阻塞 I&#x2F;O，根本不支持高并发，所以 iodepth 实际上不会生效。</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–name&#x3D;seqwrite</td>
<td align="center">定义测试任务的名称为 seqwrite，用于标识输出结果</td>
</tr>
<tr>
<td align="center">–rw&#x3D;write</td>
<td align="center">设置为顺序写入模式（sequential write），数据按顺序写入磁盘</td>
</tr>
<tr>
<td align="center">–bs&#x3D;1M</td>
<td align="center">每次 I&#x2F;O 操作的块大小为 1MB，适合测试吞吐量</td>
</tr>
<tr>
<td align="center">–size&#x3D;5G</td>
<td align="center">每个线程写入的总数据量为 5GB（不是总共，是每个 job）</td>
</tr>
<tr>
<td align="center">–numjobs&#x3D;4</td>
<td align="center">启动 4 个并发线程（job），模拟多线程写入场景</td>
</tr>
<tr>
<td align="center">–iodepth&#x3D;32</td>
<td align="center">每个线程的 I&#x2F;O 队列深度为 32，表示最多可同时挂起 32 个 I&#x2F;O 请求 <br> 本例中每个线程会发起 5G&#x2F;1M&#x3D;5120 个 I&#x2F;O 请求</td>
</tr>
<tr>
<td align="center">–direct&#x3D;1</td>
<td align="center">绕过系统缓存，直接对磁盘进行读写，更真实地反映设备性能</td>
</tr>
<tr>
<td align="center">–runtime&#x3D;60</td>
<td align="center">测试持续时间为 60 秒，优先于 –size，<br>1. 即使数据写完也继续写更多数据直到时间结束 &lt; br&gt;2. 如果没有写完，则时间到就结束</td>
</tr>
<tr>
<td align="center">–group_reporting</td>
<td align="center">汇总所有线程的测试结果，输出整体性能指标而不是每个线程单独显示</td>
</tr>
</tbody></table>
<p>可能的代码实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libaio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_PATH <span class="string">&quot;testfile.bin&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IODEPTH 4  <span class="comment">// 控制并发请求数量</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd = open(FILE_PATH, O_CREAT | O_WRONLY | O_DIRECT, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// io_setup 是 libaio 的函数</span></span><br><span class="line">    <span class="type">io_context_t</span> ctx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (io_setup(IODEPTH, &amp;ctx) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;io_setup&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iocb</span> *<span class="title">iocbs</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iocb</span> <span class="title">iocb_array</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    <span class="type">char</span> *buffers[IODEPTH];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; IODEPTH; i++) &#123;</span><br><span class="line">        <span class="comment">// 分配对齐内存</span></span><br><span class="line">        posix_memalign((<span class="type">void</span>**)&amp;buffers[i], BLOCK_SIZE, BLOCK_SIZE);</span><br><span class="line">        <span class="built_in">memset</span>(buffers[i], <span class="string">&#x27;A&#x27;</span> + i, BLOCK_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化 iocb</span></span><br><span class="line">        io_prep_pwrite(&amp;iocb_array[i], fd, buffers[i], BLOCK_SIZE, i * BLOCK_SIZE);</span><br><span class="line">        iocbs[i] = &amp;iocb_array[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提交所有请求</span></span><br><span class="line">    <span class="type">int</span> ret = io_submit(ctx, IODEPTH, iocbs);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;io_submit&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待所有请求完成</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_event</span> <span class="title">events</span>[<span class="title">IODEPTH</span>];</span></span><br><span class="line">    io_getevents(ctx, IODEPTH, IODEPTH, events, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; IODEPTH; i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(buffers[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    io_destroy(ctx);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;All %d I/O requests completed.\n&quot;</span>, IODEPTH);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="延迟"><a href="#延迟" class="headerlink" title="延迟"></a>延迟</h3><table>
<thead>
<tr>
<th>指标</th>
<th>含义</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>slat</td>
<td>Submission Latency</td>
<td>从 fio 发起 I&#x2F;O 请求到内核接收该请求的时间。通常很短，单位是微秒（usec）。</td>
</tr>
<tr>
<td>clat</td>
<td>Completion Latency</td>
<td>从内核接收请求到 I&#x2F;O 操作完成的时间。这个是最能反映存储设备性能的部分。</td>
</tr>
<tr>
<td>lat</td>
<td>Total Latency</td>
<td>总延迟，即 slat + clat，表示从 fio 发起请求到 I&#x2F;O 完成的整个过程。</td>
</tr>
</tbody></table>
<h3 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ fio --name=seqwrite --rw=write --bs=1M --size=5G --numjobs=2 --direct=1 --runtime=60 --group_reporting</span><br><span class="line">seqwrite: (g=0): rw=write, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=psync, iodepth=1</span><br><span class="line">...</span><br><span class="line">fio-3.41</span><br><span class="line">Starting 2 processes</span><br><span class="line">seqwrite: Laying out IO file (1 file / 5120MiB)</span><br><span class="line">seqwrite: Laying out IO file (1 file / 5120MiB)</span><br><span class="line">Jobs: 2 (f=2): [W(2)][100.0%][w=112MiB/s][w=112 IOPS][eta 00m:00s]</span><br><span class="line">seqwrite: (groupid=0, <span class="built_in">jobs</span>=2): err= 0: pid=70688: Sun Sep  7 22:37:47 2025</span><br><span class="line">  write: IOPS=111, BW=111MiB/s (117MB/s)(6685MiB/60016msec); 0 zone resets</span><br><span class="line">    clat (usec): min=9606, max=74763, avg=17922.82, stdev=1446.89</span><br><span class="line">     lat (usec): min=9628, max=74791, avg=17951.49, stdev=1446.80</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[15008],  5.00th=[16319], 10.00th=[16909], 20.00th=[17433],</span><br><span class="line">     | 30.00th=[17695], 40.00th=[17695], 50.00th=[17957], 60.00th=[17957],</span><br><span class="line">     | 70.00th=[18220], 80.00th=[18482], 90.00th=[19006], 95.00th=[19268],</span><br><span class="line">     | 99.00th=[21365], 99.50th=[22414], 99.90th=[32375], 99.95th=[40109],</span><br><span class="line">     | 99.99th=[74974]</span><br><span class="line">   bw (KiB/s): min=96062, max=116736, per=100.00%, avg=114150.20, stdev=1061.35, samples=238</span><br><span class="line">   iops        : min=   92, max=  114, avg=110.77, stdev= 1.18, samples=238</span><br><span class="line">  lat (msec)   : 10=0.03%, 20=97.43%, 50=2.53%, 100=0.01%</span><br><span class="line">  cpu          : usr=0.22%, sys=0.75%, ctx=6717, majf=0, minf=67</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,6685,0,0 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all <span class="built_in">jobs</span>):</span><br><span class="line">  WRITE: bw=111MiB/s (117MB/s), 111MiB/s-111MiB/s (117MB/s-117MB/s), io=6685MiB (7010MB), run=60016-60016mse</span><br></pre></td></tr></table></figure>

<p>🧾 测试配置解析<br>bash<br>fio –name&#x3D;seqwrite –rw&#x3D;write –bs&#x3D;1M –size&#x3D;10G –numjobs&#x3D;1 –direct&#x3D;1 –runtime&#x3D;60 –group_reporting<br>参数	含义<br>rw&#x3D;write	顺序写入<br>bs&#x3D;1M	每次写入块大小为 1MiB<br>numjobs&#x3D;1	单线程写入<br>direct&#x3D;1	使用 Direct I&#x2F;O，绕过页缓存<br>ioengine&#x3D;psync	使用同步 I&#x2F;O（每次 pwrite()）<br>iodepth&#x3D;1	每次只挂起一个 I&#x2F;O 请求（同步模式下默认如此）<br>📊 性能结果概览<br>指标	数值	说明<br>IOPS	96	每秒执行 96 次写入操作<br>带宽	96.2 MiB&#x2F;s（101 MB&#x2F;s）	每秒写入约 96 MiB 数据<br>总写入量	5772 MiB	在 60 秒内完成的写入总量<br>延迟（avg clat）	10.36 ms	每次写入的平均完成时间<br>CPU 使用率	usr&#x3D;0.46%, sys&#x3D;1.23%	CPU 负载极低，瓶颈不在 CPU<br>⏱ 延迟分布分析<br>50% 的写入延迟低于 9.9 ms</p>
<p>95% 的写入低于 12.5 ms</p>
<p>99.95% 的写入延迟达到了 22.9 ms</p>
<p>最慢的写入高达 28.2 ms</p>
<p>尾部延迟略高，说明偶尔会有磁盘响应变慢的情况，可能是设备内部缓存刷新或寻址造成。</p>
<p>📈 带宽波动情况<br>平均带宽：约 96 MiB&#x2F;s</p>
<p>最小带宽：60 MiB&#x2F;s</p>
<p>最大带宽：104 MiB&#x2F;s</p>
<p>标准差：6.2 MiB&#x2F;s → 表明带宽相对稳定，但仍有轻微波动</p>
<p>🧠 深层解读<br>✅ 为什么 IOPS ≈ 带宽（MiB&#x2F;s）？<br>因为你设置了 bs&#x3D;1M，每次写入 1MiB 数据，所以：</p>
<p>Code<br>IOPS × Block Size &#x3D; Bandwidth<br>96 IOPS × 1 MiB &#x3D; 96 MiB&#x2F;s<br>✅ 为什么 Direct I&#x2F;O？<br>绕过页缓存，测试的是磁盘的真实物理性能，避免被内存加速 “欺骗”。</p>
<p>✅ 为什么使用 psync？<br>psync 是同步写入，每次调用 pwrite()，适合模拟数据库或日志系统的写入行为。但它无法并发挂起多个请求，限制了吞吐。</p>
<p>📌 性能瓶颈分析<br>磁盘类型：如果是 HDD，这个结果（96 MiB&#x2F;s）非常合理；如果是 SSD，则偏低，可能受限于同步 I&#x2F;O 或单线程。</p>
<p>IO 引擎限制：psync 是阻塞式，无法发挥磁盘的并发能力。</p>
<p>线程数限制：只有一个线程，磁盘可能未被充分利用。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/IO/" rel="tag"># IO</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2025/09/03/cuda/CUDA%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95/" rel="prev" title="CUDA矩阵乘法">
      <i class="fa fa-chevron-left"></i> CUDA矩阵乘法
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2025/09/13/concurrency/SPSC-lock-free-queue/" rel="next" title="单生产者 - 单消费者 无锁队列">
      单生产者 - 单消费者 无锁队列 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%A3%81%E7%9B%98%E7%B1%BB%E5%9E%8B"><span class="nav-text">查看磁盘类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="nav-text">测试方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E7%9A%84%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-text">磁盘的测试结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5%EF%BC%88%E4%BB%A5-fio-%E4%B8%BA%E4%BE%8B%EF%BC%89"><span class="nav-text">概念（以 fio 为例）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ioengine"><span class="nav-text">ioengine</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iodepth"><span class="nav-text">iodepth</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%B6%E8%BF%9F"><span class="nav-text">延迟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="nav-text">结果分析</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bi-an"
      src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">bi-an</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">105</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/bi-an" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;bi-an" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ah_zzg@126.com" title="E-Mail → mailto:ah_zzg@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://cuda-doc.readthedocs.io/" title="https:&#x2F;&#x2F;cuda-doc.readthedocs.io" rel="noopener" target="_blank">CUDA中文手册</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://infiniband-doc.readthedocs.io/" title="https:&#x2F;&#x2F;infiniband-doc.readthedocs.io&#x2F;" rel="noopener" target="_blank">InfiniBand中文手册</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bi-an</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  

</body>
</html>
