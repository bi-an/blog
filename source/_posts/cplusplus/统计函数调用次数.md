---
title: 统计函数调用次数
date: 2024-09-24 21:43:55
tags: cpp
---

## 宏实现

```cpp
#include <iostream>
#include <unordered_map>

// 创建一个全局哈希表，用于记录每个函数的调用次数
std::unordered_map<std::string, int> functionCallCount;

// 宏定义用于统计函数调用次数
#define COUNT_START(func) \
    functionCallCount[#func]++; \
    std::cout << #func << " has been called " << functionCallCount[#func] << " times." << std::endl;

// 示例函数
void f() {
    std::cout << "Function f is executing." << std::endl;
}

int main() {
    COUNT_START(f); // 调用f并统计
    f(); // 实际调用

    COUNT_START(f); // 再次调用f并统计
    f(); // 实际调用

    return 0;
}
```

## std::function 实现

```cpp
#include <iostream>
#include <functional>
#include <unordered_map>

// 创建一个全局哈希表，用于记录每个函数的调用次数
std::unordered_map<std::string, int> functionCallCount;

// 包装器函数，统计调用次数
template <typename Func, typename... Args>
auto callWithCount(const std::string& funcName, Func func, Args&&... args) {
    // 每次调用，函数名对应的计数器递增
    functionCallCount[funcName]++;
    
    // 输出函数的调用次数
    std::cout << funcName << " has been called " 
              << functionCallCount[funcName] << " times." << std::endl;
    
    // 调用实际的函数并返回结果
    return func(std::forward<Args>(args)...);
}

// 示例函数1
int add(int a, int b) {
    return a + b;
}

// 示例函数2
void printMessage(const std::string& message) {
    std::cout << message << std::endl;
}

int main() {
    // 调用add函数并统计
    int result = callWithCount("add", add, 5, 3);
    std::cout << "Result of add: " << result << std::endl;
    
    // 调用printMessage函数并统计
    callWithCount("printMessage", printMessage, "Hello, World!");

    // 再次调用同样的函数
    result = callWithCount("add", add, 10, 20);
    std::cout << "Result of add: " << result << std::endl;

    callWithCount("printMessage", printMessage, "This is a test message.");
    
    return 0;
}
```
