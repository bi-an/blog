---
title: 虚拟内存
categories: Linux
tags: memory
date: 2023-11-07 15:36:21
---

## 1. 术语

resident set size (RSS)


## 2. 文件系统

/proc/self/statm

## 3. 相关命令


### 3.1. top

#### 3.1.1. Fields

| TIME+<sup>[1]</sup>                                            | TIME                                      |
|----------------------------------------------------------------|-------------------------------------------|
| `5432:01` means "5432 minutes and 1 second"                    | `90,32` means "90 hours and 32 minutes"   |
| `25:15.20` means "25 minutes, 15 seconds and 20% of 1 second"  | `25:15` means "25 minutes and 15 seconds" |

### 3.2. ps

#### 3.2.1. 输出说明

`TIME`: the cumulated CPU time in [DD-]hh:mm:ss format (time=TIME)

| Field  | value & means                                                  |
|--------|----------------------------------------------------------------|
| `TIME` | `1-18:09:38` means "1 day, 18 hours, 9 minutes and 38 seconds" |

## 4. 相关系统调用

### 4.1. madvise

`madvise` 是一个系统调用，用于向内核提供关于内存使用的建议。

#### 4.1.1. 选项：

##### 4.1.1.1. `MADV_DONTFORK`

在执行 `fork` 之后，防止子进程使用指定范围内的页面。

具体来说，`MADV_DONTFORK` 的作用是避免在 `fork` 后，父进程在写入页面时由于写时复制（Copy-On-Write, COW）机制导致页面的物理位置发生变化。
这对于需要直接访问页面的硬件（如DMA设备）特别有用，因为页面重定位可能会导致硬件访问问题。

写时复制：当一个进程执行 fork() 系统调用时，父进程和子进程会共享相同的物理内存页面，而不是立即复制所有页面。这种共享是只读的，直到其中一个进程尝试写入某个页面。

当写入操作发生时，COW 机制会触发以下步骤：

- 页面复制：操作系统会创建该页面的一个副本。
- 地址更新：新页面的物理地址会分配给写入进程，而原页面仍然保留给另一个进程。

由于这个过程，写入操作会导致页面的物理地址发生变化，因为写入进程现在指向的是新分配的物理页面，而不是原来的共享页面。

拓展：

> RDMA 中，如果我们运行在一个页面大小不是 4KB 的机器上时，Mallanox 要求必须设置 `RDMA_HUGEPAGES_SAFE` 环境变量，
> 该环境变量被 `ibv_fork_init` 检测。
> 
> 如果进程调用 `fork()` （函数 `system()` 内会调用 `fork()` ），那么必须使用 `ibv_for_init` 。
> 
> 在 RHEL8.6 之前，`ibv_fork_init` 和 `RDMA_HUGEPAGES_SAFE` 环境变量是必须的。
> 因为 Mellanox 驱动需要调用 `madvise` 来在 InfiniBand 卡 DMA 的内存页上设置 `MADV_DONTFORK` 。
> 
> 新版本的内核（RHEL8.6及以上）当注册为 DMA 时，会在虚拟内存（VM）页上自动设置 `DONT_FORK` ，这样 PCIe 设备就可以访问它们。


## 5. 参考

[1]: [what-does-time-cpu-time-hundredth-in-top-mean](https://superuser.com/questions/1148884/what-does-time-cpu-time-hundredth-in-top-mean/)
[what-does-virtual-memory-size-in-top-mean](https://serverfault.com/questions/138427/what-does-virtual-memory-size-in-top-mean)
